<!DOCTYPE html>
<html>
	

<head>
	<title>How to Set Up and Serve Private Content Using S3 and Amazon CloudFront | Mark S. Rasmussen</title>
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
	<meta charset="UTF-8" />
	<meta property="og:locale" content="en_US" />
	<meta property="og:type" content="website" />
	<meta name="google-site-verification" content="alt7-wfK3ZujMQ4D0jYNd0yC5LGetGdqBlBmZsqQlVw" />
	<link rel="alternative" href="http://feeds.feedburner.com/Improvedk" title="Mark S. Rasmussen" type="application/atom+xml">
	<script src="/js/combined.js"></script>
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-2479580-1', 'improve.dk');
		ga('send', 	'pageview');
	</script>
	<link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
	<body>
		<div id="headerline"></div>
	
		<header>
			<div class="wrapper">
				<div id="title">
					<a href="/">Mark S. Rasmussen</a> <span>improve.dk</span>
				</div>
				
				<nav>
					<ul class="normal">
						<li class="navicon"><img src="/img/navicon.png" /></li>
						<li><a href="/about-me/">About Me</a></li>
					</ul>
				</nav>
				
				<ul id="sharing">
					<li><a href="mailto:mark@improve.dk"><img src="/img/at.png" /></a></li>
					<li><a href="http://feeds.feedburner.com/Improvedk" id="rssfeed"><img src="/img/rss.png" /></a></li>
					<li><a href="https://twitter.com/improvedk"><img src="/img/twitter.png" /></a></li>
					<li><a href="https://github.com/improvedk"><img src="/img/github.png" /></a></li>
					<li><a href="https://www.linkedin.com/in/markrasmussen/"><img src="/img/linkedin.png" /></a></li>
				</ul>

				<div class="clear"></div>
				
				<div id="naviconcontent">
					<ul class="mobile">
						<li>
							Pages
							<ul class="pages"></ul>
						</li>
						<li>
							Categories
							<ul class="categories"></ul>
						</li>
						<li>
							Archive
							<ul class="archive"></ul>
						</li>
					</ul>
				</div>
			</div>
		</header>

		<div id="mainwrapper">
			<div id="contentwrapper">
				<div id="content">
				
					<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Oct</span>
			<span class="day">26</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/how-to-set-up-and-serve-private-content-using-s3/" title="How to Set Up and Serve Private Content Using S3 and Amazon CloudFront" rel="bookmark">How to Set Up and Serve Private Content Using S3 and Amazon CloudFront</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				, 
			
				<a href="/category/Amazon Web Services/">Amazon Web Services</a>
				
			
		</div>
		
			<div class="comments">
				<a href="#comments" title="Comment on How to Set Up and Serve Private Content Using S3 and Amazon CloudFront">Comments</a>
			</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" class="single">

		
		
			<div class="body">
			
				<p>Imagine the scenario – you’ve got customers all over the world all requesting binary files from you. To speed up your delivery, you want to utilize a CDN. Furthermore, all of the files needs to be protected on a specific user session level. Basically, you need to grant access to the specific file when a given user logs in – it’s not enough just to have a “hidden” URL or a URL with an infinitely sharable policy in the query string.</p>
<a id="more"></a>

<p>To do this, we’ll need to set up a private S3 bucket, a private CloudFront distribution, a bucket policy on said bucket so CloudFront is able to access the data, and finally we need to generate signed policies for the users on the fly, so they may retrieve the files using CloudFront.</p>
<p>To keep this post simple (relatively speaking), I’ll assume you’ve got a completely empty AWS account with access to S3 and CloudFront. Don’t worry if you’ve got existing content, you’ll just need to modify the scripts slightly to access the right objects (as I’m assuming an empty account, I’ll just access the <em>first</em> element here and there, instead of the specific one).</p>
<h3 id="Why_you_don’t_want_to_rely_on_third_party_GUIs">Why you don’t want to rely on third party GUIs</h3>
<p>Admittedly, I used <a href="http://www.bucketexplorer.com/" target="_blank">Bucket Explorer</a> to begin with, to help me set up access identities and private distributions. However, as soon as I had a need that Bucket Explorer couldn’t help me with, or I had hiccups, I was totally lost. If you rely on third party GUIs to do the setup for you, you have very limited understanding of what’s actually being set up beneath the covers, and as such, you’ll be in a pickle when (no, not if!) something goes awry. Once you’ve done the setup by hand, you may later start using tools, but only if you understand what they’re doing.</p>
<p>Note that this is not a bash on Bucket Explorer, just my opinion never to use tooling before you understand what they do, just as I wouldn’t recommend you use TortoiseGit before you know the command line by heart.</p>
<h2 id="The_AWS_console_only_takes_you_so_far">The AWS console only takes you so far</h2>
<p>While the AWS console is great in itself, it’s really only meant for the simplest of tasks. Very quickly you’ll find yourself limited by what you can do. For what we’re about to do, all you’d be able to do through the console GUI is to create a bucket, the rest would have to be done through code. To keep things consistent, I’m sticking to code for all tasks.</p>
<p>Before we start, <a href="http://aws.amazon.com/sdkfornet/" target="_blank">download the Amazon AWS .NET SDK</a> and create a template console application like this:</p>
<figure class="highlight csharp"><pre><span class="keyword">using</span> System;
<span class="keyword">using</span> Amazon;
<span class="keyword">using</span> Amazon.CloudFront.Model;
<span class="keyword">using</span> Amazon.S3;
<span class="keyword">using</span> Amazon.S3.Model;

<span class="class"><span class="keyword">namespace</span> <span class="title">AWSTest</span> 
{</span> 
    <span class="class"><span class="keyword">class</span> <span class="title">Program</span> 
    {</span> 
        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> accessKeyID = <span class="string">"AKI..."</span>; 
        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> secretAccessKey = <span class="string">"w49..."</span>;

        <span class="keyword">static</span> <span class="keyword">void</span> Main() 
        { 

        } 
    } 
}
</pre></figure>

<p>Make sure to insert your own access key ID and secret access key values. All code samples posted from now on should go into the Main() method body.</p>
<h2 id="Creating_the_private_bucket">Creating the private bucket</h2>
<p>Run the following code to set up a bucket, which will be private by default. Make sure you define a unique bucket name, I’m using the name <em>improve.dk</em> for this sample. Note that if your bucket is not in the EU region, you’ll need to substitute my ServiceURL with the one for your region. You can find all the service URLs here: <a href="http://docs.amazonwebservices.com/general/latest/gr/index.html?rande.html" target="_blank">http://docs.amazonwebservices.com/general/latest/gr/index.html?rande.html</a></p>
<figure class="highlight csharp"><pre><span class="keyword">var</span> config = <span class="keyword">new</span> AmazonS3Config()
	.WithServiceURL(<span class="string">"s3-eu-west-1.amazonaws.com"</span>);

<span class="keyword">using</span> (<span class="keyword">var</span> s3Client = AWSClientFactory.CreateAmazonS3Client(accessKeyID, secretAccessKey, config))
{
	<span class="keyword">var</span> request = <span class="keyword">new</span> PutBucketRequest()
		.WithBucketName(<span class="string">"improve.dk"</span>)
		.WithBucketRegion(S3Region.EU);

	<span class="keyword">var</span> response = s3Client.PutBucket(request);
}
</pre></figure>

<p>If all goes well, you should see your bucket in the AWS console immediately hereafter:</p>
<div class="imgwrapper" style=""><div><a href="/how-to-set-up-and-serve-private-content-using-s3/image_16.png" class="fancy"><img src="/how-to-set-up-and-serve-private-content-using-s3/image_16.png" style="max-height: 250px"/></a></div></div>

<h2 id="Creating_a_CloudFront_Origin_Access_Identity">Creating a CloudFront Origin Access Identity</h2>
<p>Now that we’ve got our bucket, we need to create the private CloudFront distribution. However, we also need to concoct a way for the private distribution to gain access to our private bucket. We can do so by utilizing a special type of CloudFront identities called Origin Access Identities, which I’ll be referring to as OAI’s.</p>
<p>Creating an OAI allows us to tell CloudFront to access the S3 bucket using that OAI. On the bucket side, we can then create a policy granting access to that specific OAI, and thus enabling our private distribution access to our private bucket.</p>
<p>Run the following code:</p>
<figure class="highlight csharp"><pre>using (var cfClient = AWSClientFactory<span class="preprocessor">.CreateAmazonCloudFrontClient</span>(accessKeyID, secretAccessKey))
{
	var oaiConfig = new CloudFrontOriginAccessIdentityConfig()
		<span class="preprocessor">.WithComment</span>(<span class="string">"OAI used for private distribution access to improve.dk bucket."</span>)<span class="comment">;</span>

	var request = new CreateOriginAccessIdentityRequest()<span class="comment">;</span>
	request<span class="preprocessor">.OriginAccessIdentityConfig</span> = oaiConfig<span class="comment">;</span>

	var response = cfClient<span class="preprocessor">.CreateOriginAccessIdentity</span>(request)<span class="comment">;</span>
	Console<span class="preprocessor">.WriteLine</span>(response<span class="preprocessor">.OriginAccessIdentity</span><span class="preprocessor">.Id</span>)<span class="comment">;</span>
	Console<span class="preprocessor">.WriteLine</span>(response<span class="preprocessor">.OriginAccessIdentity</span><span class="preprocessor">.S</span>3CanonicalUserId)<span class="comment">;</span>
}
</pre></figure>

<p>This creates a new OAI with a comment. Furthermore it prints out two bits of information that we’ll need shortly – the OAI ID and the OAI S3 canonical user ID. These are two different ways of identifying the OAI, and we’ll need both, so make sure to jot them down.</p>
<h2 id="Creating_the_private_CloudFront_distribution">Creating the private CloudFront distribution</h2>
<p>Now that we have our bucket and OAI, we can set up a private CloudFront distribution and point it at the S3 bucket.</p>
<p>Run the following code:</p>
<figure class="highlight csharp"><pre><span class="keyword">using</span> (<span class="keyword">var</span> cfClient = AWSClientFactory.CreateAmazonCloudFrontClient(accessKeyID, secretAccessKey))
{
	<span class="keyword">var</span> oaiIdentity = cfClient.ListOriginAccessIdentities().OriginAccessIdentities[<span class="number">0</span>];

	<span class="keyword">var</span> distributionConfig = <span class="keyword">new</span> CloudFrontDistributionConfig();
	distributionConfig.S3Origin = <span class="keyword">new</span> S3Origin(<span class="string">"improve.dk.s3.amazonaws.com"</span>, oaiIdentity);
	distributionConfig.Comment = <span class="string">"Private distribution for accessing the improve.dk bucket."</span>;
	distributionConfig.Enabled = <span class="keyword">true</span>;
	distributionConfig.TrustedSigners = <span class="keyword">new</span> UrlTrustedSigners().WithEnableSelf(<span class="keyword">true</span>);

	<span class="keyword">var</span> request = <span class="keyword">new</span> CreateDistributionRequest();
	request.DistributionConfig = distributionConfig;

	<span class="keyword">var</span> response = cfClient.CreateDistribution(request);
}
</pre></figure>

<p>This starts out by fetching the OAI we created just before. It then creates a new distribution configuration, specifying the improve.dk S3 bucket as the source, using the OAI for authentication. The TrustedSigners parameter determines who will be able to sign (and thereby grant access) to the distribution later on. For this demo, we’ll just grant access to our own AWS account. You may grant access to up to 5 other AWS accounts, should you so wish.</p>
<p>Once run, you should immediately see your distribution being in the InProgress state in the AWS console. This picture is taken approximately 10 minutes later, when the distribution enters the Deployed state:</p>
<div class="imgwrapper" style=""><div><a href="/how-to-set-up-and-serve-private-content-using-s3/image_14.png" class="fancy"><img src="/how-to-set-up-and-serve-private-content-using-s3/image_14.png" style="max-height: 250px"/></a></div></div>

<h2 id="Setting_up_a_bucket_policy_to_grant_our_OAI_access_to_the_S3_bucket">Setting up a bucket policy to grant our OAI access to the S3 bucket</h2>
<p>When we upload objects to our bucket, we <em>could</em> grant access to the OAI on each specific object. That will require an extra request for each upload though, as we can’t assign ACL’s at the same time as we create objects. It would also be a major hassle if we ever were to change our OAI/distribution. To make it easier, we can create a bucket wide policy that grants access to all the objects in the bucket, for one specific OAI.</p>
<p>Open up the <a href="http://awspolicygen.s3.amazonaws.com/policygen.html" target="_blank">AWS Policy Generator tool</a> in a new window. Make sure to select the S3 Bucket Policy type. In the Principal field, enter the S3 canonical user ID of the OAI we created earlier. For actions, only select the GetObject action – this allows the distribution to retrieve an object and nothing more. For the ARN, use this, though with your own bucket name:</p>
<figure class="highlight"><pre><span class="tag">arn</span><span class="pseudo">:aws</span><span class="pseudo">:s3</span>:<span class="pseudo">::improve</span><span class="class">.dk</span><span class="comment">/*</span>
</pre></figure>

<p>That ARN will ensure the policy covers all objects in the bucket, no matter their name. Now click the Add Statement button, followed by the Generate Policy button. What you’ll end up with is a JSON based policy like this:</p>
<figure class="highlight json"><pre>{
  "<span class="attribute">Id</span>": <span class="value"><span class="string">"Policy1319566876317"</span></span>,
  "<span class="attribute">Statement</span>": <span class="value">[
    {
      "<span class="attribute">Sid</span>": <span class="value"><span class="string">"Stmt1319566860498"</span></span>,
      "<span class="attribute">Action</span>": <span class="value">[
        <span class="string">"s3:GetObject"</span>
      ]</span>,
      "<span class="attribute">Effect</span>": <span class="value"><span class="string">"Allow"</span></span>,
      "<span class="attribute">Resource</span>": <span class="value"><span class="string">"arn:aws:s3:::improve.dk/*"</span></span>,
      "<span class="attribute">Principal</span>": <span class="value">{
        "<span class="attribute">AWS</span>": <span class="value">[
          <span class="string">"7d76be60a0acc160399f6d6750bdc9d4d78d16a58a30987844d4df010f2ded483a9e73b8b0877089fab75f5d0b591dee"</span>
        ]
      </span>}
    </span>}
  ]
</span>}
</pre></figure>

<p>However, this won’t work yet! You need to change the “AWS” principal value into “CanonicalUser”, like so:</p>
<figure class="highlight json"><pre>{
  "<span class="attribute">Id</span>": <span class="value"><span class="string">"Policy1319566876317"</span></span>,
  "<span class="attribute">Statement</span>": <span class="value">[
    {
      "<span class="attribute">Sid</span>": <span class="value"><span class="string">"Stmt1319566860498"</span></span>,
      "<span class="attribute">Action</span>": <span class="value">[
        <span class="string">"s3:GetObject"</span>
      ]</span>,
      "<span class="attribute">Effect</span>": <span class="value"><span class="string">"Allow"</span></span>,
      "<span class="attribute">Resource</span>": <span class="value"><span class="string">"arn:aws:s3:::improve.dk/*"</span></span>,
      "<span class="attribute">Principal</span>": <span class="value">{
        "<span class="attribute">CanonicalUser</span>": <span class="value">[
          <span class="string">"7d76be60a0acc160399f6d6750bdc9d4d78d16a58a30987844d4df010f2ded483a9e73b8b0877089fab75f5d0b591dee"</span>
        ]
      </span>}
    </span>}
  ]
</span>}
</pre></figure>

<p>Now that we have the policy ready, we need to add it to our bucket. Run the following code:</p>
<figure class="highlight csharp"><pre>var config = new AmazonS3Config()
	.WithServiceURL(<span class="string">"s3-eu-west-1.amazonaws.com"</span>);

using (var s3Client = AWSClientFactory.CreateAmazonS3Client(accessKeyID, secretAccessKey, config))
{
	var request = new PutBucketPolicyRequest();
	request.BucketName = <span class="string">"improve.dk"</span>;
	request.Policy = <span class="string">"{ "</span>Id<span class="string">": "</span>Policy1319566876317<span class="string">", "</span>Statement<span class="string">": [ { "</span>Sid<span class="string">": "</span>Stmt1319566860498<span class="string">", "</span> +
		<span class="string">""</span>Action<span class="string">": [ "</span>s3:GetObject<span class="string">" ], "</span>Effect<span class="string">": "</span>Allow<span class="string">", "</span>Resource<span class="string">": "</span>arn:aws:s3:::improve.dk/*<span class="string">", "</span> +
		<span class="string">""</span>Principal<span class="string">": { "</span>CanonicalUse<span class="string">r": [ "</span><span class="number">7</span>d76be60a0acc160399f6d6750bdc9d4d78d16a58a30987844d4df010f2ded483a9e73b8b0877089fab75f5d0b591dee<span class="string">" ] } } ] }"</span>;

	var response = s3Client.PutBucketPolicy(request);
}
</pre></figure>

<p>Make sure you escape your policy properly. There’s no need to concatenate it over multiple lines, I just did so only to avoid too much website distortion when displayed here.</p>
<h2 id="Uploading_a_test_object">Uploading a test object</h2>
<p>To test everything out, we need to have a test object in our bucket. It can be anything, though an image is probably the easiest to test with. I used this little dapper AWS logo:</p>
<div class="imgwrapper" style=""><div><a href="/how-to-set-up-and-serve-private-content-using-s3/logo_aws_thumb.gif" class="fancy"><img src="/how-to-set-up-and-serve-private-content-using-s3/logo_aws_thumb.gif" style="max-height: 250px"/></a></div></div>

<p>Run the following code to upload the object:</p>
<figure class="highlight csharp"><pre><span class="keyword">var</span> config = <span class="keyword">new</span> AmazonS3Config()
	.WithServiceURL(<span class="string">"s3-eu-west-1.amazonaws.com"</span>);

<span class="keyword">using</span> (<span class="keyword">var</span> s3Client = AWSClientFactory.CreateAmazonS3Client(accessKeyID, secretAccessKey, config))
{
	<span class="keyword">var</span> request = <span class="keyword">new</span> PutObjectRequest()
		.WithFilePath(<span class="string">@"C:logo_aws.gif"</span>)
		.WithBucketName(<span class="string">"improve.dk"</span>);

	<span class="keyword">var</span> response = s3Client.PutObject(request);
}
</pre></figure>

<p>Make sure to substitute with your own bucket name as well as the correct path for whatever test file you’re using. Immediately after running this you should see the file in your bucket:</p>
<div class="imgwrapper" style=""><div><a href="/how-to-set-up-and-serve-private-content-using-s3/image_12.png" class="fancy"><img src="/how-to-set-up-and-serve-private-content-using-s3/image_12.png" style="max-height: 250px"/></a></div></div>

<p>If you enter the properties of the object, you’ll see a link like this:</p>
<p><a href="https://s3-eu-west-1.amazonaws.com/improve.dk/logo_aws.gif" target="_blank">https://s3-eu-west-1.amazonaws.com/improve.dk/logo_aws.gif</a></p>
<p>If you try to access the URL directly, you should get an error like this:</p>
<div class="imgwrapper" style=""><div><a href="/how-to-set-up-and-serve-private-content-using-s3/image_18.png" class="fancy"><img src="/how-to-set-up-and-serve-private-content-using-s3/image_18.png" style="max-height: 250px"/></a></div></div>

<p>This is expected, given that our bucket is private and we’re currently accessing the object directly from the bucket. If you go back to your distribution, you’ll see a domain name like d2ya0f2cfwcopc.cloudfront.net. Try substituting the S3 domain name with the one of your distribution, like so:</p>
<p><a href="https://s3-eu-west-1.amazonaws.com/improve.dk/logo_aws.gif" target="_blank">https://s3-eu-west-1.amazonaws.com/improve.dk/logo_aws.gif</a> =&gt; <a href="https://d2ya0f2cfwcopc.cloudfront.net/logo_aws.gif" target="_blank">https://d2ya0f2cfwcopc.cloudfront.net/logo_aws.gif</a></p>
<p>Accessing the distribution URL doesn’t help however:</p>
<div class="imgwrapper" style=""><div><a href="/how-to-set-up-and-serve-private-content-using-s3/image_20.png" class="fancy"><img src="/how-to-set-up-and-serve-private-content-using-s3/image_20.png" style="max-height: 250px"/></a></div></div>

<p>Once again we’re not allowed access. This time not due to S3 policies, but due to the distribution being private and thus requiring signed URLs.</p>
<h2 id="Creating_a_time_limited_signed_URL_for_a_given_object">Creating a time limited signed URL for a given object</h2>
<p>Now that we have the URL of our distribution object, we need to sign it with a policy granting access to it for a given time period. To do the signing, I’ve create a class based on <a href="http://stackoverflow.com/questions/2284206/how-to-encrypt-amazon-cloudfront-signature-for-private-content-access-using-cann/2545017#2545017" target="_blank">Gael Fraiteurs post on Stack Overflow</a>. His class deals with canned policies, whereas this one deals with custom policies as they’re a bit more dynamic, configurable and thereby powerful.</p>
<p>Add the following class to your project:</p>
<figure class="highlight csharp"><pre><span class="keyword">using</span> System;
<span class="keyword">using</span> System.Security.Cryptography;
<span class="keyword">using</span> System.Text;

namespace AWSTest
{
	<span class="keyword">public</span> <span class="keyword">class</span> CloudFrontSecurityProvider
	{
		<span class="keyword">private</span> <span class="keyword">readonly</span> RSACryptoServiceProvider privateKey;
		<span class="keyword">private</span> <span class="keyword">readonly</span> <span class="keyword">string</span> privateKeyId;
		<span class="keyword">private</span> <span class="keyword">readonly</span> SHA1Managed sha1 = <span class="keyword">new</span> SHA1Managed();

		<span class="keyword">public</span> <span class="title">CloudFrontSecurityProvider</span>(<span class="keyword">string</span> privateKeyId, <span class="keyword">string</span> privateKey)
		{
			<span class="keyword">this</span>.privateKey = <span class="keyword">new</span> RSACryptoServiceProvider();
			RSACryptoServiceProvider.UseMachineKeyStore = <span class="keyword">false</span>;

			<span class="keyword">this</span>.privateKey.FromXmlString(privateKey);
			<span class="keyword">this</span>.privateKeyId = privateKeyId;
		}

		<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getUnixTime</span>(DateTime time)
		{
			<span class="keyword">var</span> referenceTime = <span class="keyword">new</span> DateTime(<span class="number">1970</span>, <span class="number">1</span>, <span class="number">1</span>);
			<span class="keyword">return</span> (<span class="keyword">int</span>)(time - referenceTime).TotalSeconds;
		}

		<span class="keyword">public</span> <span class="keyword">string</span> <span class="title">GetCustomUrl</span>(<span class="keyword">string</span> url, DateTime expiration)
		{
			<span class="keyword">string</span> expirationEpoch = getUnixTime(expiration).ToString();

			<span class="keyword">string</span> policy =
				<span class="string">@"{""Statement"":[{""Resource"":""&lt;url&gt;"",""Condition"":{""DateLessThan"":{""AWS:EpochTime"":&lt;expiration&gt;}}}]}"</span>.
					Replace(<span class="string">"&lt;url&gt;"</span>, url).
					Replace(<span class="string">"&lt;expiration&gt;"</span>, expirationEpoch);

			<span class="keyword">string</span> signature = getUrlSafeString(sign(policy));

			<span class="keyword">return</span> url + <span class="keyword">string</span>.Format(<span class="string">"?Policy={0}&Signature={1}&Key-Pair-Id={2}"</span>, getUrlSafeString(Encoding.ASCII.GetBytes(policy)), signature, privateKeyId);
		}

		<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">getUrlSafeString</span>(<span class="keyword">byte</span>[] data)
		{
			<span class="keyword">return</span> Convert.ToBase64String(data).Replace(<span class="string">'+'</span>, <span class="string">'-'</span>).Replace(<span class="string">'='</span>, <span class="string">'_'</span>).Replace(<span class="string">'/'</span>, <span class="string">'~'</span>);
		}

		<span class="keyword">private</span> <span class="keyword">byte</span>[] <span class="title">sign</span>(<span class="keyword">string</span> data)
		{
			<span class="keyword">byte</span>[] plainbytes = Encoding.UTF8.GetBytes(data);

			<span class="keyword">byte</span>[] hash = sha1.ComputeHash(plainbytes);

			<span class="keyword">return</span> privateKey.SignHash(hash, <span class="string">"SHA1"</span>);
		}
	}
}
</pre></figure>

<h3 id="Creating_CloudFront_key_pairs">Creating CloudFront key pairs</h3>
<p>Before we can use it though, we need a CloudFront key pair. Go to the Access Credentials section of the Security Credentials section of the AWS console, click on the Key Pairs pane, and then click “Create a New Key Pair”. If successful, a key pair should have been created, and the private part of the key should have been downloaded as a .pem file automatically:</p>
<div class="imgwrapper" style=""><div><a href="/how-to-set-up-and-serve-private-content-using-s3/image_24.png" class="fancy"><img src="/how-to-set-up-and-serve-private-content-using-s3/image_24.png" style="max-height: 250px"/></a></div></div>

<p>Make sure to save the .pem file as it cannot be recreated. If you loose it, you’ll have to create a new key pair. Note that these credentials have nothing to do with your access key ID &amp; secret key – those are a completely separate set of keys. Before we can use the .pem secret key, we need to transform it into an XML format that RSACryptoServiceProvider can parse. Go to <a href="http://www.jensign.com/opensslkey/" target="_blank">http://www.jensign.com/opensslkey/</a> and download the opensslkey.exe application – save it in the same directory as your .pem file. If you don’t like running the .exe, the source code is available for you to compile and run yourself.</p>
<p>Run opensslkey.exe and give it the name of your .pem file like so:</p>
<div class="imgwrapper" style=""><div><a href="/how-to-set-up-and-serve-private-content-using-s3/image_26.png" class="fancy"><img src="/how-to-set-up-and-serve-private-content-using-s3/image_26.png" style="max-height: 250px"/></a></div></div>

<h3 id="Creating_the_actual_signed_URL">Creating the actual signed URL</h3>
<p>One way or the other, copy that <RSAKeyValue> bit of XML. Now run the following code, substituting my CloudFront key pair and object URL with your own:</p>
<figure class="highlight csharp"><pre>[STAThread]
static void Main()
{
	string keyPairID = "APKAILAOYMDETYTM7NYQ";
	string secretKey = @"
		<span class="tag">&lt;<span class="title">RSAKeyValue</span>&gt;</span>
			<span class="tag">&lt;<span class="title">Modulus</span>&gt;</span>kp2udNofRGbbiMtFLWMFMGB1U67JWq2EYqLR0qbfFnOd2kMnY7UUMLLf/uPdf9RsEZxA3wnbIS6fH2vesHYkk=<span class="tag">&lt;/<span class="title">Modulus</span>&gt;</span>
			<span class="tag">&lt;<span class="title">Exponent</span>&gt;</span>AQAB<span class="tag">&lt;/<span class="title">Exponent</span>&gt;</span>
			<span class="tag">&lt;<span class="title">P</span>&gt;</span>6GhWFDM89x69lp3b93RACdm9yQBjbrP9+ySIiaiy8htXxxKYF5fEn0TRQEzo3FLFG/cf17ozrFAtHV6rqMaRFQ==<span class="tag">&lt;/<span class="title">P</span>&gt;</span>
			<span class="tag">&lt;<span class="title">Q</span>&gt;</span>oX/Yg4huItINr9SfLmOdZ0y/ysPykmvcESwuXjJiLNB+V5My5AWDSgucE8ZuqT5wvMQJ93DZPpLX0+P6esbRZQ==<span class="tag">&lt;/<span class="title">Q</span>&gt;</span>
			<span class="tag">&lt;<span class="title">DP</span>&gt;</span>BepB5pm3P4LkyGSUKKQozRdhoTAFV9f06uNvJjHI/Ch9/28Vt+QA+RzDRqOueY0Rvzh28wKmNgiEXW7/Z3hGUQ==<span class="tag">&lt;/<span class="title">DP</span>&gt;</span>
			<span class="tag">&lt;<span class="title">DQ</span>&gt;</span>F8y5YZjnciY2ciUJWFLBzYlX8k+yHbXbdoRmSOdv5F7NX6aHp2bQlEblt1xUzogvIQJa3aY5vajyOX2tWg6WqQ==<span class="tag">&lt;/<span class="title">DQ</span>&gt;</span>
			<span class="tag">&lt;<span class="title">InverseQ</span>&gt;</span>cMc+6NMLU1A6LbOeNikuVRbGu43HoG+hECnEzhk6VtQQO3HiUCUdCuZ1lBZegm5YecURbSZ+pWnGok5tqo//gA==<span class="tag">&lt;/<span class="title">InverseQ</span>&gt;</span>
			<span class="tag">&lt;<span class="title">D</span>&gt;</span>HBgW69E4GJVVD9tTgCTvQ5vYH5bognWpXnUwm5raOKUitBsxABDFISmOfYjwwx2cE4lTR18r4Fgqt0jxOXVBzWE=<span class="tag">&lt;/<span class="title">D</span>&gt;</span>
		<span class="tag">&lt;/<span class="title">RSAKeyValue</span>&gt;</span>";

	var provider = new CloudFrontSecurityProvider(keyPairID, secretKey);
	var signedUrl = provider.GetCustomUrl("https://d2ya0f2cfwcopc.cloudfront.net/logo_aws.gif", DateTime.Now.AddMinutes(5));

	Clipboard.SetText(signedUrl);
	Console.WriteLine(signedUrl);
	Console.Read();
}
</pre></figure>

<p>Note how we instantiate the CloudFrontSecurityProvider, passing in the CloudFront key pair ID and secret key. We then give it the complete URL of the file we want, including a time limit for when it should no longer be available – 5 minutes in this case. For the sake of simplicity, I’m automatically copying the URL to the clipboard so I can easily paste it into my browser and test it. In my case, my complete URL looks like this:</p>
<figure class="highlight"><pre><span class="label">https:</span>//d2ya0f2cfwcopc<span class="preprocessor">.cloudfront</span><span class="preprocessor">.net</span>/logo_aws<span class="preprocessor">.gif</span>?Policy=eyJTdGF0ZW1lbnQiOlt7IlJlc291cmNlIjoiaHR0cHM6Ly9kMnlhMGYyY2Z3Y29wYy5jbG91ZGZyb250Lm5ldC9sb2dvX2F3cy5naWYiLCJDb25kaXRpb24iOnsiRGF0ZUxlc3NUaGFuIjp7IkFXUzpFcG9jaFRpbWUiOjEzMTk1NzkzNzd9fX1dfQ__&Signature=CBnOaq5mO~RHhHo9fmK~hIxYSG4RC4IuZHJtH8Yk00p97Ihhy-yYYdggqbkdY68L1Vf7POVCjbf7gpdC5hJ9AHl5bTeWZyHLQXzXstHlOF~BgAyxNUPWQvSZPcwY6qpkKzMwrq2OU4tut7749TAgYfXt3BiGPmQF-<span class="number">8</span>GFIEXB8iI_&Key-Pair-Id=APKAILAOYMDETYTM7NYQ
</pre></figure>

<p>By the time you read this, hopefully, the link should no longer be working. If you upload another file (IMAG0655.jpg in my case) and just substitute the filename, using the same policy, you’ll get the following error:</p>
<div class="imgwrapper" style=""><div><a href="/how-to-set-up-and-serve-private-content-using-s3/image_28.png" class="fancy"><img src="/how-to-set-up-and-serve-private-content-using-s3/image_28.png" style="max-height: 250px"/></a></div></div>

<h3 id="Using_wildcards_when_signing_URLs">Using wildcards when signing URLs</h3>
<p>So what if you want to grant access to many files at once, do we have to create a policy for each single one? Thankfully, no, we don’t! Say you want to grant access to all files in the folder “Test” (and remember, there is no such thing as folders in S3 – just objects named e.g. /Test/FileName.jpg). What we’d do is to create a policy like this:</p>
<figure class="highlight csharp"><pre>var signedUrl = provider<span class="preprocessor">.GetCustomUrl</span>(<span class="string">"https://d2ya0f2cfwcopc.cloudfront.net/Test/*"</span>, DateTime<span class="preprocessor">.Now</span><span class="preprocessor">.AddMinutes</span>(<span class="number">5</span>))<span class="comment">;</span>
</pre></figure>

<p>That’s right, we can create custom policies for wildcard URLs too! Once you’ve got this URL, just substitute the asterisk for whatever file you want to request:</p>
<figure class="highlight"><pre><span class="label">https:</span>//d2ya0f2cfwcopc<span class="preprocessor">.cloudfront</span><span class="preprocessor">.net</span>/Test/A<span class="preprocessor">.jpg</span>?Policy=eyJTdGF0ZW1lbnQiOlt7I...  https://d2ya0f2cfwcopc<span class="preprocessor">.cloudfront</span><span class="preprocessor">.net</span>/Test/B<span class="preprocessor">.jpg</span>?Policy=eyJTdGF0ZW1lbnQiOlt7I...  https://d2ya0f2cfwcopc<span class="preprocessor">.cloudfront</span><span class="preprocessor">.net</span>/Test/C<span class="preprocessor">.jpg</span>?Policy=eyJTdGF0ZW1lbnQiOlt7I...
</pre></figure>

<p>All using the same policy, just with a different file paths.</p>
<h3 id="Limiting_the_users_IP_address">Limiting the users IP address</h3>
<p>At this point we’ve created a URL with a custom signed policy that grants access to a given resource (or wildcard) within a limited time period. However, within this period, the user may distribute the URL to anyone else, who will then also be able to access the resource. To hinder this, we can add the source IP address as an additional condition to the policy!</p>
<p>Add an overload to the GetCustomUrl function in the CloudFrontSecurityProvider class like so:</p>
<figure class="highlight csharp"><pre><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">GetCustomUrl</span>(<span class="keyword">string</span> url, DateTime expiration, <span class="keyword">string</span> allowedCidr)
{
	<span class="keyword">string</span> expirationEpoch = GetUnixTime(expiration).ToString();

	<span class="keyword">string</span> policy =
		<span class="string">@"{""Statement"":[{""Resource"":""&lt;url&gt;"",""Condition"":{""IpAddress"":{""AWS:SourceIp"":""&lt;cidr&gt;""}, ""DateLessThan"":{""AWS:EpochTime"":&lt;expiration&gt;}}}]}"</span>
			.Replace(<span class="string">"&lt;url&gt;"</span>, url)
			.Replace(<span class="string">"&lt;expiration&gt;"</span>, expirationEpoch)
			.Replace(<span class="string">"&lt;cidr&gt;"</span>, allowedCidr);

	<span class="keyword">string</span> signature = getUrlSafeString(sign(policy));

	<span class="keyword">return</span> url + <span class="keyword">string</span>.Format(<span class="string">"?Policy={0}&Signature={1}&Key-Pair-Id={2}"</span>, getUrlSafeString(Encoding.ASCII.GetBytes(policy)), signature, privateKeyId);
}
</pre></figure>

<p>To use it, we just pass in an IP address in the <a href="http://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing" target="_blank">CIDR</a> format:</p>
<figure class="highlight csharp"><pre>var signedUrl = provider<span class="preprocessor">.GetCustomUrl</span>(<span class="string">"https://d2ya0f2cfwcopc.cloudfront.net/D.jpg"</span>, DateTime<span class="preprocessor">.Now</span><span class="preprocessor">.AddMinutes</span>(<span class="number">5</span>), <span class="string">"212.242.193.110/32"</span>)<span class="comment">;</span>
</pre></figure>

<p>The above example would provide access to the D.jpg object for 5 minutes, but only for the 212.242.193.110 IP address specifically. We could grant access to a whole subnet by passing in the IP/CIDR 212.242.193.0/24, etc.</p>
<p>You can only use the date and source IP address for conditions, contrary to other AWS policies that allow a plethora of conditions. For a full description, see page 80+ in this document: <a href="http://awsdocs.s3.amazonaws.com/CF/latest/cf_dg.pdf" target="_blank">http://awsdocs.s3.amazonaws.com/CF/latest/cf_dg.pdf</a></p>
<h2 id="Conclusion">Conclusion</h2>
<p>This seems way more complex than it… Who am I kidding? This IS complex to set up! However, at this point, you can upload any number of objects to your bucket, and you never have to consider object-level ACLs as it’s all handled by the bucket policy. You can also create any number of custom policies for your URLs using your private distribution, limiting both the time period in which the link is valid, as well as the source IP address. Once all of this is setup, it’s rather easy to use.</p>
<p>Utilizing private S3 buckets and private CloudFront distributions, we can now secure our content completely while having very fine grained control over who gets access. All this while we still utilize the CloudFront CDN to deliver the content from the destination nearest to the end user.</p>
<p>PS – before you remind me the remove them – all keys, user identities etc. have all been inactivated/removed.</p>


				<div style="clear: both"></div>

				
					<div id="postsharing">
						<a href="https://twitter.com/home?status=How%20to%20Set%20Up%20and%20Serve%20Private%20Content%20Using%20S3%20and%20Amazon%20CloudFront%20http%3A%2F%2Fimprove.dk%2Fhow-to-set-up-and-serve-private-content-using-s3%2F%20via%20%40improvedk" target="_blank"><img src="/img/twitter_64x64.png" /></a>
						<a href="https://www.facebook.com/sharer.php?u=http%3A%2F%2Fimprove.dk%2Fhow-to-set-up-and-serve-private-content-using-s3%2F" target="_blank"><img src="/img/facebook_64x64.png" /></a>
						<a href="http://reddit.com/submit?url=http%3A%2F%2Fimprove.dk%2Fhow-to-set-up-and-serve-private-content-using-s3%2F&title=How%20to%20Set%20Up%20and%20Serve%20Private%20Content%20Using%20S3%20and%20Amazon%20CloudFront" target="_blank"><img src="/img/reddit_64x64.png" /></a>
						<a href="https://github.com/improvedk/improve.dk/blob/master/source/_posts/how-to-set-up-and-serve-private-content-using-s3/how-to-set-up-and-serve-private-content-using-s3.md" target="_blank" title="View source"><img src="/img/octocat_64x64.png" /></a>
					</div>

					<div id="bio">
						<img src="/img/avatar.jpg" class="avatar photo" height="96" width="96">
						<div class="wrapper">
							<div class="name">Mark S. Rasmussen</div>
							<div class="description">
								I'm the CTO at <a href="http://www.ipaper-cms.com/">iPaper</a> where I cuddle with databases, mold code and maintain the overall technical &amp; team responsibility. I'm an avid speaker at user groups &amp; conferences. I love life, motorcycles, photography and all things technical. Say hi on <a href="http://twitter.com/improvedk">Twitter</a>, write me an <a href="mailto:mark@improve.dk">email</a> or look me up on <a href="http://dk.linkedin.com/in/markrasmussen/">LinkedIn</a>.
							</div>
						</div>
						<div class="clear"></div>
					</div>
				

			</div>

		

		
			<a name="comments"></a>
<div id="disqus_thread"></div>
<script type="text/javascript">
	var disqus_shortname = 'improvedk';
	var disqus_identifier = 'how-to-set-up-and-serve-private-content-using-s3';
	var disqus_url = 'http://improve.dk/how-to-set-up-and-serve-private-content-using-s3/';

	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
		

	</div>
</article>

				</div>
			</div>

			<div id="asides">
				<div class="categories aside">
					<span class="sectiontitle">CATEGORIES</span>
					<ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/category/.NET/">.NET</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/AS/Flex/Flash/">AS/Flex/Flash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Amazon Web Services/">Amazon Web Services</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Computer Science/">Computer Science</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Conferences and Presenting/">Conferences and Presenting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/IIS/">IIS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Life/">Life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Miscellaneous/">Miscellaneous</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Performance/">Performance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Poker/">Poker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server/">SQL Server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Community/">SQL Server - Community</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Data Types/">SQL Server - Data Types</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Internals/">SQL Server - Internals</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Optimization/">SQL Server - Optimization</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Tricks/">SQL Server - Tricks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Testing/">Testing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Tools of the Trade/">Tools of the Trade</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Umbraco/">Umbraco</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Visual Studio/">Visual Studio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Web/">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windbg/">Windbg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windows/">Windows</a></li></ul>

					
				</div>

				<div class="archive aside">
					<span class="sectiontitle">ARCHIVE</span>
					<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archive/2014">2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2013">2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2012">2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2011">2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2010">2010</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2009">2009</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2008">2008</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2007">2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2006">2006</a></li></ul>
				</div>
			</div>

			<div class="clear"></div>
		</div>
		
		<footer>
			<div class="wrapper">Copyright &copy; 2014 Mark S. Rasmussen</div>
		</footer>

		<script type="text/javascript">
			$(function () {
				// Show mobile menu
				$("li.navicon").click(function () {
					if ($("header ul.mobile a").length == 0) {
						// Pages
						$mobilePages = $("div#naviconcontent ul.pages");
						$("header nav ul.normal > li").not(".navicon").each(function (i, el) {
							$mobilePages.append($(el).clone());
						});

						// Categories
						$mobileCategories = $("div#naviconcontent ul.categories");
						$("div#asides div.categories > ul > li").each(function (i, el) {
							$mobileCategories.append($(el).clone());
						});

						// Archive
						$mobileArchive = $("div#naviconcontent ul.archive");
						$("div#asides div.archive > ul > li").each(function (i, el) {
							$mobileArchive.append($(el).clone());
						});
					};

					$("header ul.mobile").toggle();
				});

				// Fancybox setup
				$("a.fancy").fancybox({
					hideOnContentClick: true,
					overlayShow: true
				});
			});
		</script>
	</body>
</html>