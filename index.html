<!DOCTYPE html>
<html>
	

<head>
	<title>Mark S. Rasmussen</title>
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
	<meta charset="UTF-8" />
	<meta property="og:locale" content="en_US" />
	<meta property="og:type" content="website" />
	<meta name="google-site-verification" content="alt7-wfK3ZujMQ4D0jYNd0yC5LGetGdqBlBmZsqQlVw" />
	<link rel="alternative" href="http://feeds.feedburner.com/Improvedk" title="Mark S. Rasmussen" type="application/atom+xml">
	<script src="/js/combined.js"></script>
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-2479580-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>
	<link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
	<body>
		<div id="headerline"></div>
	
		<header>
			<div class="wrapper">
				<div id="title">
					<a href="/">Mark S. Rasmussen</a> <span>improve.dk</span>
				</div>
				
				<nav>
					<ul class="normal">
						<li class="navicon"><img src="/img/navicon.png" /></li>
						<li><a href="/about-me/">About Me</a></li>
					</ul>
				</nav>
				
				<ul id="sharing">
					<li><a href="mailto:mark@improve.dk"><img src="/img/at.png" /></a></li>
					<li><a href="http://feeds.feedburner.com/Improvedk"><img src="/img/rss.png" /></a></li>
					<li><a href="https://twitter.com/improvedk"><img src="/img/twitter.png" /></a></li>
					<li><a href="https://github.com/improvedk"><img src="/img/github.png" /></a></li>
					<li><a href="https://www.linkedin.com/in/markrasmussen/"><img src="/img/linkedin.png" /></a></li>
				</ul>

				<div class="clear"></div>
				
				<div id="naviconcontent">
					<ul class="mobile">
						<li>
							Pages
							<ul class="pages"></ul>
						</li>
						<li>
							Categories
							<ul class="categories"></ul>
						</li>
						<li>
							Archive
							<ul class="archive"></ul>
						</li>
					</ul>
				</div>
			</div>
		</header>

		<div id="mainwrapper">
			<div id="contentwrapper">
				<div id="content">
				
					
	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Feb</span>
			<span class="day">04</span>
		</div>
		<div class="lower">2014</div>
	</div>

	<div class="title">
		<h1><a href="/presenting-sql-saturday-275/" title="Presenting at SQL Saturday 275" rel="bookmark">Presenting at SQL Saturday 275</a></h1>
		<div class="categories">
			
				<a href="http://improve.dk/category/SQL Server - Community/">SQL Server - Community</a>
				, 
			
				<a href="http://improve.dk/category/Conferences and Presenting/">Conferences and Presenting</a>
				, 
			
				<a href="http://improve.dk/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I’m happy to announce that I’ll be presenting at <a href="http://sqlsaturday.com/275/" target="_blank">SQLSaturday #275</a> in Copenhagen on March 29th!</p>
<a id="more"></a>

<p>I’ll be presenting my <strong>Recovering Data from Fatally Corrupt Databases</strong> session:</p>
<blockquote>
<p>Imagine the worst case scenario: Your database won’t come online. Lots of checksum errors logged. DBCC CheckDB won’t even run on the database. And worst of all - you have no backups! Now what do you do with this 20GB binary blob of an MDF file? In this demo-rich session I will briefly introduce the internals of MDF files while primarly concentrating on how to manually extract data from corrupt databases. I will be using the OrcaMDF RawDatabase framework to do most of the parsing, which will also be explained during the session.</p>
</blockquote>
<p>If you want to be able to <a href="/sql-server-corruption-recovery-when-all-else-fails/">save the day</a> when all other options are exhausted, you shouldn’t miss this session.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Nov</span>
			<span class="day">06</span>
		</div>
		<div class="lower">2013</div>
	</div>

	<div class="title">
		<h1><a href="/sql-server-corruption-recovery-when-all-else-fails/" title="SQL Server Corruption Recovery - When All Else Fails" rel="bookmark">SQL Server Corruption Recovery - When All Else Fails</a></h1>
		<div class="categories">
			
				<a href="http://improve.dk/category/.NET/">.NET</a>
				, 
			
				<a href="http://improve.dk/category/SQL Server - Internals/">SQL Server - Internals</a>
				, 
			
				<a href="http://improve.dk/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a>
				, 
			
				<a href="http://improve.dk/category/SQL Server/">SQL Server</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>In this post I want to walk through a number of SQL Server corruption recovery techniques for when you’re out of luck, have no backups, and the usual methods don’t work. I’ll be using the <a href="http://msftdbprodsamples.codeplex.com/releases/view/93587" target="_blank">AdventureWorksLT2008R2 sample database</a> as my victim.</p>
<a id="more"></a>

<h2 id="A_Clean_Start">A Clean Start</h2>
<p>To start out, I’ve attached the downloaded database and it’s available on my SQL Server 2008 R2 instance, under the name of <strong>AWLT2008R2</strong>.</p>
<div class="imgwrapper" style=""><div><a href="/sql-server-corruption-recovery-when-all-else-fails/A9.png" class="fancy"><img src="/sql-server-corruption-recovery-when-all-else-fails/A9.png" style="max-height: 250px"/></a></div></div>

<p>To ensure we’ve got a clean start, I’ll run DBCC CHECKDB with the DATA_PURITY flag set, just to make sure the database is OK.</p>
<figure class="highlight sql"><pre>DBCC CHECKDB (AWLT2008R2) WITH ALL_ERRORMSGS, DATA_PURITY
</pre></figure>


<figure class="highlight"><pre>DBCC results <span class="keyword">for</span> <span class="string">'AWLT2008R2'</span>.
Service Broker Msg <span class="number">9675</span>, State <span class="number">1</span>: Message Types analyzed: <span class="number">14.</span>
Service Broker Msg <span class="number">9676</span>, State <span class="number">1</span>: Service Contracts analyzed: <span class="number">6.</span>
Service Broker Msg <span class="number">9667</span>, State <span class="number">1</span>: Services analyzed: <span class="number">3.</span>
Service Broker Msg <span class="number">9668</span>, State <span class="number">1</span>: Service Queues analyzed: <span class="number">3.</span>
Service Broker Msg <span class="number">9669</span>, State <span class="number">1</span>: Conversation Endpoints analyzed: <span class="number">0.</span>
Service Broker Msg <span class="number">9674</span>, State <span class="number">1</span>: Conversation Groups analyzed: <span class="number">0.</span>
Service Broker Msg <span class="number">9670</span>, State <span class="number">1</span>: Remote Service Bindings analyzed: <span class="number">0.</span>
Service Broker Msg <span class="number">9605</span>, State <span class="number">1</span>: Conversation Priorities analyzed: <span class="number">0.</span>
DBCC results <span class="keyword">for</span> <span class="string">'sys.sysrscols'</span>.
There are <span class="number">805</span> rows <span class="keyword">in</span> <span class="number">9</span> pages <span class="keyword">for</span> object <span class="string">"sys.sysrscols"</span>.
DBCC results <span class="keyword">for</span> <span class="string">'sys.sysrowsets'</span>.
There are <span class="number">125</span> rows <span class="keyword">in</span> <span class="number">1</span> pages <span class="keyword">for</span> object <span class="string">"sys.sysrowsets"</span>.
DBCC results <span class="keyword">for</span> <span class="string">'SalesLT.ProductDescription'</span>.
There are <span class="number">762</span> rows <span class="keyword">in</span> <span class="number">18</span> pages <span class="keyword">for</span> object <span class="string">"SalesLT.ProductDescription"</span>.
<span class="keyword">...</span>
CHECKDB found <span class="number">0</span> allocation errors and <span class="number">0</span> consistency errors <span class="keyword">in</span> database <span class="string">'AWLT2008R2'</span>.
DBCC execution completed. If DBCC printed error messages, contact your system administrator.
</pre></figure>

<h2 id="Enter_Corruption">Enter Corruption</h2>
<p>As I don’t want to kill my disk drives just to introduce corruption, I’ll be using <a href="/corrupting-databases-purpose-using-orcamdf-corruptor/">OrcaMDF’s Corruptor class</a> instead. First up we need to shut down SQL Server:</p>
<figure class="highlight sql"><pre>SHUTDOWN WITH NOWAIT
</pre></figure>


<figure class="highlight"><pre><span class="built_in">Server</span> shut down by NOWAIT <span class="built_in">request</span> from login MSR\Mark S. Rasmussen.
SQL <span class="built_in">Server</span> <span class="keyword">is</span> terminating this process.
</pre></figure>

<p>Once the instance has been shut down, I’ve located my MDF file, stored at <strong>D:\MSSQL Databases\AdventureWorksLT2008R2.mdf</strong>. Knowing the path to the MDF file, I’ll now intentially corrupt 5% of the pages in the database (at a database size of 5,312KB this will end up corrupting 33 random pages, out of a total of 664 pages).</p>
<figure class="highlight csharp"><pre>Corruptor.CorruptFile(@"D:<span class="command">\MSSQL</span> Databases<span class="command">\AdventureWorksLT</span>2008R2.mdf", 0.05);
</pre></figure>

<p>At this point I have no idea about which pages were actually corrupted, I just know that 33 random pages just got overwritten by all zeros.</p>
<h2 id="Uh_Oh">Uh Oh</h2>
<p>After restarting the SQL Server instance and looking at the tree of databases, it’s obvious we’re in trouble…</p>
<div class="imgwrapper" style=""><div><a href="/sql-server-corruption-recovery-when-all-else-fails/A11.png" class="fancy"><img src="/sql-server-corruption-recovery-when-all-else-fails/A11.png" style="max-height: 250px"/></a></div></div>

<p>Running DBCC CHECKDB doesn’t help much:</p>
<figure class="highlight sql"><pre>DBCC CHECKDB (AWLT2008R2) WITH ALL_ERRORMSGS, DATA_PURITY
</pre></figure>


<figure class="highlight"><pre>Msg <span class="number">926</span>, Level <span class="number">14</span>, State <span class="number">1</span>, Line <span class="number">1</span>
Database <span class="string">'AWLT2008R2'</span> cannot be opened. It has been marked SUSPECT <span class="keyword">by</span> recovery.
See <span class="operator">the</span> SQL Server errorlog <span class="keyword">for</span> more information.
</pre></figure>

<p>What does the errorlog say?</p>
<ul>
<li>Starting up database ‘AWLT2008R2’.</li>
<li>1 transactions rolled forward in database ‘AWLT2008R2’ (13). This is an informational message only. No user action is required.</li>
<li>Error: 824, Severity: 24, State: 2.</li>
<li><strong>SQL Server detected a logical consistency-based I/O error</strong>: incorrect pageid (expected 1:2; actual 0:0). It occurred during a read of page (1:2) in database ID 13 at offset 0x00000000004000 in file ‘D:\MSSQL Databases\AdventureWorksLT2008R2.mdf’.  Additional messages in the SQL Server error log or system event log may provide more detail. <strong>This is a severe error condition that threatens database integrity and must be corrected immediately. Complete a full database consistency check (DBCC CHECKDB).</strong> This error can be caused by many factors; for more information, see SQL Server Books Online.</li>
<li>Error: 3414, Severity: 21, State: 1.</li>
<li><strong>An error occurred during recovery, preventing the database ‘AWLT2008R2’ (database ID 13) from restarting. Diagnose the recovery errors and fix them, or restore from a known good backup. If errors are not corrected or expected, contact Technical Support.</strong></li>
<li>CHECKDB for database ‘AWLT2008R2’ finished without errors on 2013-11-05 20:02:07.810 (local time). This is an informational message only; no user action is required.</li>
<li>Recovery is complete. This is an informational message only. No user action is required.</li>
</ul>
<p>This is officially not good. Our database failed to recover and can’t be put online at the moment, due to I/O consistency errors. We’ve also got our first hint:</p>
<figure class="highlight"><pre><span class="tag">incorrect</span> <span class="tag">pageid</span> (<span class="tag">expected</span> 1<span class="pseudo">:2</span>; <span class="tag">actual</span> 0<span class="pseudo">:0)</span>
</pre></figure>

<p>What this tells us is that the header of page 2 has been overwritten by zeros since SQL Server expected to find the value 1:2, but found 0:0 instead. Page 2 is the first GAM page in the database and is an essential part of the metadata.</p>
<p>SQL Server also wisely told us to either fix the errors or <strong>restore from a known good backup</strong>. And this is why you should always have a recovery strategy. If you ever end up in a situation like this, without a backup, you’ll have to continue reading.</p>
<h2 id="DBCC_CHECKDB">DBCC CHECKDB</h2>
<p>SQL Server recommended that we run a <strong>full database consistency check</strong> using DBCC CHECKDB. Unfortunately, given the state of our database, DBCC CHECKDB is unable to run:</p>
<figure class="highlight sql"><pre>DBCC CHECKDB (AWLT2008R2) WITH ALL_ERRORMSGS, DATA_PURITY
</pre></figure>


<figure class="highlight"><pre>Msg <span class="number">926</span>, Level <span class="number">14</span>, State <span class="number">1</span>, Line <span class="number">1</span>
Database <span class="string">'AWLT2008R2'</span> cannot be opened. It has been marked SUSPECT <span class="keyword">by</span> recovery.
See <span class="operator">the</span> SQL Server errorlog <span class="keyword">for</span> more information.
</pre></figure>

<p>In some cases you may be able to force the database online, by putting it into <strong>EMERGENCY</strong> mode. If we could get the database into EMERGENCY mode, we might just be able to run DBCC CHECKDB.</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">ALTER</span> <span class="keyword">DATABASE</span> AWLT2008R2 <span class="keyword">SET</span> EMERGENCY</span>
</pre></figure>


<figure class="highlight"><pre>Msg <span class="number">824</span>, Level <span class="number">24</span>, State <span class="number">2</span>, Line <span class="number">1</span>
SQL Server detected <span class="operator">a</span> logical consistency-based I/O error: incorrect pageid
(expected <span class="number">1</span>:<span class="number">16</span>; actual <span class="number">0</span>:<span class="number">0</span>). It occurred during <span class="operator">a</span> <span class="built_in">read</span> <span class="operator">of</span> page (<span class="number">1</span>:<span class="number">16</span>) <span class="operator">in</span> database
ID <span class="number">13</span> <span class="keyword">at</span> <span class="built_in">offset</span> <span class="number">0x00000000020000</span> <span class="operator">in</span> <span class="built_in">file</span> <span class="string">'D:\MSSQL Databases\AdventureWorksLT2008R2.mdf'</span>.
Additional messages <span class="operator">in</span> <span class="operator">the</span> SQL Server error <span class="built_in">log</span> <span class="operator">or</span> <span class="keyword">system</span> event <span class="built_in">log</span> may provide more
detail. This is <span class="operator">a</span> severe error condition that threatens database integrity <span class="operator">and</span> must
be corrected immediately. Complete <span class="operator">a</span> full database consistency check (DBCC CHECKDB).
This error can be caused <span class="keyword">by</span> many factors; <span class="keyword">for</span> more information, see SQL Server
Books Online.
</pre></figure>

<p>Even worse, it seems that page 16 has also been hit by corruption. Page 16 is the root page of the sysallocunits base table, holding all of the allocation unit storage metadata. Without page 16 there is no way for SQL Server to access any of its metadata. In short, there’s no way we’re getting this database online!</p>
<h2 id="Enter_OrcaMDF">Enter OrcaMDF</h2>
<p>The OrcaMDF Database class won’t be able to open the database, seeing as it does not handle corruption very well. Even so, I want to try anyway, you never know. First off you’ll have to shut down SQL Server to release the locks on the corrupt MDF file.</p>
<figure class="highlight sql"><pre>SHUTDOWN WITH NOWAIT
</pre></figure>

<p>If you then try opening the database using the OrcaMDF Database class, you’ll get a result like this:</p>
<figure class="highlight csharp"><pre><span class="keyword">var</span> db = <span class="keyword">new</span> Database(<span class="string">@"D:\MSSQL Databases\AdventureWorksLT2008R2.mdf"</span>);
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/sql-server-corruption-recovery-when-all-else-fails/Capture.png" class="fancy"><img src="/sql-server-corruption-recovery-when-all-else-fails/Capture.png" style="max-height: 250px"/></a></div></div>

<p>Interestingly the Database class didn’t puke on the boot page (ID 9) itself, so we know that that one’s OK, at least. But as soon as it hit page 16, things started to fall apart - and we already knew page 16 was corrupt.</p>
<h3 id="RawDatabase">RawDatabase</h3>
<p>While the OrcaMDF <strong>Database</strong> class can’t read the database file either, <strong>RawDatabase</strong> can. RawDatabase doesn’t care about metadata, it doesn’t read anything but what you tell it to, and as a result of that, it’s much more resilient to corruption.</p>
<p>Given that we know the corruption has resulted in pages being zeroed out, we could easily gather a list of corrupted pages by just searching for pages whose logical page ID doesn’t match the one in the header:</p>
<figure class="highlight csharp"><pre>var db = new RawDatabase(@<span class="string">"D:\MSSQL Databases\AdventureWorksLT2008R2.mdf"</span>)
db<span class="preprocessor">.Pages</span>
  <span class="preprocessor">.Where</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.PageID</span> != <span class="built_in">x</span><span class="preprocessor">.PageID</span>)
  <span class="preprocessor">.Select</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.PageID</span>)
  <span class="preprocessor">.ToList</span>()
  <span class="preprocessor">.ForEach</span>(Console<span class="preprocessor">.WriteLine</span>)<span class="comment">;</span>
</pre></figure>


<figure class="highlight"><pre><span class="number">2</span>
<span class="number">4</span>
<span class="number">5</span>
<span class="number">16</span>
<span class="number">55</span>
<span class="keyword">...</span>
<span class="number">639</span>
<span class="number">649</span>
<span class="number">651</span>
<span class="number">662</span>
<span class="number">663</span>
</pre></figure>

<p>This is only possible since we know the corruption caused pages to be zeroed out, so you’ll rarely be this lucky. However, sometimes you may be able to detect the exact result of the corruption, thus enabling you to pinpoint the corrupted pages, just like we did here. However, this doesn’t really help us much - all we have now is a list of some page ID’s that are useless to us.</p>
<h3 id="Getting_a_List_of_Objects">Getting a List of Objects</h3>
<p>For this next part we’ll need a working database, any database, on an instance running the same version that our corrupted database this. This could be the master database - literally any working database. First you’ll want to connect to the database using the <a href="http://technet.microsoft.com/en-us/library/ms178068(v=sql.105" target="_blank">Dedicated Administrator Connection</a>.aspx). Connecting through the DAC allows us to query the base tables of the database.</p>
<p>The base table beneath sys.tables is called <strong>sys.sysschobjs</strong>, and if we can get to that, we can get a list of all the objects in the database, which might be a good start. Having connected to the working database, we can get the sys.sysschobjs details like so:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sys.sysschobjs <span class="keyword">WHERE</span> name = <span class="string">'sysschobjs'</span></span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/sql-server-corruption-recovery-when-all-else-fails/Capture1.png" class="fancy"><img src="/sql-server-corruption-recovery-when-all-else-fails/Capture1.png" style="max-height: 250px"/></a></div></div>

<p>The only thing I’m looking for here is the object id, provided by the <strong>id</strong> column. In contrast to all user tables, the system tables have their actual object id stored in the page header, which allows us to easily query for pages by their id. Knowing sys.sysschobjs has ID <strong>34</strong>, let’s see if we can get a list of all the pages belonging to it (note that the .Dump() method is native to <a href="http://www.linqpad.net/" target="_blank">LinqPad</a> - all it does is to output the resulting objects as a table):</p>
<figure class="highlight csharp"><pre>var db = new RawDatabase(@<span class="string">"D:\MSSQL Databases\AdventureWorksLT2008R2.mdf"</span>)<span class="comment">;</span>
db<span class="preprocessor">.Pages</span>
  <span class="preprocessor">.Where</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.ObjectID</span> == <span class="number">34</span>)
  <span class="preprocessor">.Dump</span>()<span class="comment">;</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/sql-server-corruption-recovery-when-all-else-fails/Capture2.png" class="fancy"><img src="/sql-server-corruption-recovery-when-all-else-fails/Capture2.png" style="max-height: 250px"/></a></div></div>

<p>Now that we have a list of pages belonging to the sys.sysschobjs table, we need to retrieve the actual rows from there. Using <strong>sp_help</strong> on the working database, we can see the underlying schema of sys.sysschobjs:</p>
<figure class="highlight sql"><pre>sp_help 'sys.sysschobjs'
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/sql-server-corruption-recovery-when-all-else-fails/Capture3.png" class="fancy"><img src="/sql-server-corruption-recovery-when-all-else-fails/Capture3.png" style="max-height: 250px"/></a></div></div>

<p>Once we have the schema of sys.sysschobjs, we can make RawDatabase parse the actual rows for us, after which we can filter it down to just the user tables, seeing as we don’t care about procedures, views, indexes and so forth:</p>
<figure class="highlight csharp"><pre>var db = new RawDatabase(@<span class="string">"D:\MSSQL Databases\AdventureWorksLT2008R2.mdf"</span>)<span class="comment">;</span>
var pages = db<span class="preprocessor">.Pages</span><span class="preprocessor">.Where</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.ObjectID</span> == <span class="number">34</span> && <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.Type</span> == PageType<span class="preprocessor">.Data</span>)<span class="comment">;</span>
var records = pages<span class="preprocessor">.SelectMany</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Records</span>)<span class="preprocessor">.Select</span>(<span class="built_in">x</span> =&gt; (RawPrimaryRecord)<span class="built_in">x</span>)<span class="comment">;</span>
var rows = RawColumnParser<span class="preprocessor">.Parse</span>(records, new IRawType[] {
	RawType<span class="preprocessor">.Int</span>(<span class="string">"id"</span>),
	RawType<span class="preprocessor">.NVarchar</span>(<span class="string">"name"</span>),
	RawType<span class="preprocessor">.Int</span>(<span class="string">"nsid"</span>),
	RawType<span class="preprocessor">.TinyInt</span>(<span class="string">"nsclass"</span>),
	RawType<span class="preprocessor">.Int</span>(<span class="string">"status"</span>),
	RawType<span class="preprocessor">.Char</span>(<span class="string">"type"</span>, <span class="number">2</span>),
	RawType<span class="preprocessor">.Int</span>(<span class="string">"pid"</span>),
	RawType<span class="preprocessor">.TinyInt</span>(<span class="string">"pclass"</span>),
	RawType<span class="preprocessor">.Int</span>(<span class="string">"intprop"</span>),
	RawType<span class="preprocessor">.DateTime</span>(<span class="string">"created"</span>),
	RawType<span class="preprocessor">.DateTime</span>(<span class="string">"modified"</span>)
})<span class="comment">;</span>

rows<span class="preprocessor">.Where</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span>[<span class="string">"type"</span>]<span class="preprocessor">.ToString</span>()<span class="preprocessor">.Trim</span>() == <span class="string">"U"</span>)
	<span class="preprocessor">.Select</span>(<span class="built_in">x</span> =&gt; new {
		ObjectID = (int)<span class="built_in">x</span>[<span class="string">"id"</span>],
		Name = <span class="built_in">x</span>[<span class="string">"name"</span>]
	})<span class="preprocessor">.Dump</span>()<span class="comment">;</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/sql-server-corruption-recovery-when-all-else-fails/Capture4.png" class="fancy"><img src="/sql-server-corruption-recovery-when-all-else-fails/Capture4.png" style="max-height: 250px"/></a></div></div>

<p>We just went from a completely useless suspect database, with no knowledge of the schema, to now having a list of each user table name &amp; object id. Sure, if one of the pages belonging to sys.syschobjs was corrupt, we’d be missing some of the tables without knowing it. Even so, this is a good start, and there are ways of detecting the missing pages (we could look for broken page header references, for example).</p>
<h3 id="Getting_Schemas">Getting Schemas</h3>
<p>As we saw for sys.sysschobjs, if we are to parse any of the user table data, we need to know the schema of the tables. The schema happens to be stored in the <strong>sys.syscolpars</strong> base table, and if we lookup in sys.sysschobjs for ‘sys.syscolpars’, we’ll get an object ID of <strong>41</strong>. As we did before, we can get a list of all pages belonging to sys.syscolpars:</p>
<figure class="highlight csharp"><pre>var db = new RawDatabase(@<span class="string">"D:\MSSQL Databases\AdventureWorksLT2008R2.mdf"</span>)<span class="comment">;</span>
db<span class="preprocessor">.Pages</span>
  <span class="preprocessor">.Where</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.ObjectID</span> == <span class="number">41</span>)
  <span class="preprocessor">.Dump</span>()<span class="comment">;</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/sql-server-corruption-recovery-when-all-else-fails/Capture5.png" class="fancy"><img src="/sql-server-corruption-recovery-when-all-else-fails/Capture5.png" style="max-height: 250px"/></a></div></div>

<p>By looking up the schema of sys.syscolpars using sp_help, in the working database, we can parse the actual rows much the same way:</p>
<figure class="highlight csharp"><pre>// Parse sys<span class="preprocessor">.syscolpars</span>
var db = new RawDatabase(@<span class="string">"D:\MSSQL Databases\AdventureWorksLT2008R2.mdf"</span>)<span class="comment">;</span>
var pages = db<span class="preprocessor">.Pages</span><span class="preprocessor">.Where</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.ObjectID</span> == <span class="number">41</span> && <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.Type</span> == PageType<span class="preprocessor">.Data</span>)<span class="comment">;</span>
var records = pages<span class="preprocessor">.SelectMany</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Records</span>)<span class="preprocessor">.Select</span>(<span class="built_in">x</span> =&gt; (RawPrimaryRecord)<span class="built_in">x</span>)<span class="comment">;</span>
var rows = RawColumnParser<span class="preprocessor">.Parse</span>(records, new IRawType[] {
	RawType<span class="preprocessor">.Int</span>(<span class="string">"id"</span>),
	RawType<span class="preprocessor">.SmallInt</span>(<span class="string">"number"</span>),
	RawType<span class="preprocessor">.Int</span>(<span class="string">"colid"</span>),
	RawType<span class="preprocessor">.NVarchar</span>(<span class="string">"name"</span>),
	RawType<span class="preprocessor">.TinyInt</span>(<span class="string">"xtype"</span>),
	RawType<span class="preprocessor">.Int</span>(<span class="string">"utype"</span>),
	RawType<span class="preprocessor">.SmallInt</span>(<span class="string">"length"</span>),
	RawType<span class="preprocessor">.TinyInt</span>(<span class="string">"prec"</span>),
	RawType<span class="preprocessor">.TinyInt</span>(<span class="string">"scale"</span>),
	RawType<span class="preprocessor">.Int</span>(<span class="string">"collationid"</span>),
	RawType<span class="preprocessor">.Int</span>(<span class="string">"status"</span>),
	RawType<span class="preprocessor">.SmallInt</span>(<span class="string">"maxinrow"</span>),
	RawType<span class="preprocessor">.Int</span>(<span class="string">"xmlns"</span>),
	RawType<span class="preprocessor">.Int</span>(<span class="string">"dflt"</span>),
	RawType<span class="preprocessor">.Int</span>(<span class="string">"chk"</span>),
	RawType<span class="preprocessor">.VarBinary</span>(<span class="string">"idtval"</span>)
})<span class="comment">;</span>

rows<span class="preprocessor">.Select</span>(<span class="built_in">x</span> =&gt; new {
	ObjectID = (int)<span class="built_in">x</span>[<span class="string">"id"</span>],
	ColumnID = (int)<span class="built_in">x</span>[<span class="string">"colid"</span>],
	Number = (short)<span class="built_in">x</span>[<span class="string">"number"</span>],
	TypeID = (byte)<span class="built_in">x</span>[<span class="string">"xtype"</span>],
	Length = (short)<span class="built_in">x</span>[<span class="string">"length"</span>],
	Name = <span class="built_in">x</span>[<span class="string">"name"</span>]
})<span class="preprocessor">.Dump</span>()<span class="comment">;</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/sql-server-corruption-recovery-when-all-else-fails/Capture6.png" class="fancy"><img src="/sql-server-corruption-recovery-when-all-else-fails/Capture6.png" style="max-height: 250px"/></a></div></div>

<h3 id="Recovering_the_Customer_Table_Schema">Recovering the Customer Table Schema</h3>
<p>While there are 12 tables, none are probably more important than the <strong>Customer</strong> table. Based on parsing the sys.sysschobjs base table, we know that the customer table has an object ID of <strong>117575457</strong>. Let’s try and filter down to just that object ID, using the code above:</p>
<figure class="highlight csharp"><pre>rows.Where(x =&gt; (<span class="keyword">int</span>)x[<span class="string">"id"</span>] == <span class="number">117575457</span>).Select(x =&gt; <span class="keyword">new</span> {
	ObjectID = (<span class="keyword">int</span>)x[<span class="string">"id"</span>],
	ColumnID = (<span class="keyword">int</span>)x[<span class="string">"colid"</span>],
	Number = (<span class="keyword">short</span>)x[<span class="string">"number"</span>],
	TypeID = (<span class="keyword">byte</span>)x[<span class="string">"xtype"</span>],
	Length = (<span class="keyword">short</span>)x[<span class="string">"length"</span>],
	Name = x[<span class="string">"name"</span>]
}).OrderBy(x =&gt; x.Number).Dump();
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/sql-server-corruption-recovery-when-all-else-fails/Capture7.png" class="fancy"><img src="/sql-server-corruption-recovery-when-all-else-fails/Capture7.png" style="max-height: 250px"/></a></div></div>

<p>Running the following query in any working database, we can correlate the TypeID values with the SQL Server type names:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span>
	*
<span class="keyword">FROM</span>
	sys.types
<span class="keyword">WHERE</span>
	system_type_id <span class="keyword">IN</span> (<span class="number">56</span>, <span class="number">104</span>, <span class="number">231</span>, <span class="number">167</span>, <span class="number">36</span>, <span class="number">61</span>) <span class="keyword">AND</span>
	system_type_id = user_type_id</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/sql-server-corruption-recovery-when-all-else-fails/Capture8.png" class="fancy"><img src="/sql-server-corruption-recovery-when-all-else-fails/Capture8.png" style="max-height: 250px"/></a></div></div>

<p>Using the output from syscolpars and the type names, we can now deduce the schema of the Customer table (note that the syscolpars lengths are physical, meaning a length of 16 for an nvarchar column means a logical length of 8):</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Customer (
	CustomerID <span class="keyword">int</span>,
	NameStyle <span class="keyword">bit</span>,
	Title nvarchar(<span class="number">8</span>),
	FirstName nvarchar(<span class="number">50</span>),
	MiddleName nvarchar(<span class="number">50</span>),
	LastName nvarchar(<span class="number">50</span>),
	Suffix nvarchar(<span class="number">10</span>),
	CompanyName nvarchar(<span class="number">128</span>),
	SalesPerson nvarchar(<span class="number">256</span>),
	EmailAddress nvarchar(<span class="number">50</span>),
	Phone nvarchar(<span class="number">25</span>),
	PasswordHash <span class="keyword">varchar</span>(<span class="number">128</span>),
	PasswordSalt <span class="keyword">varchar</span>(<span class="number">10</span>),
	rowguid uniqueidentifier,
	ModifiedDate datetime
)</span>
</pre></figure>

<p>All we need now is to find the pages belonging to the Customer table. That’s slightly easier said than done however. While each object has an object ID, as can be verified using sys.sysschobjs, that object ID is not what’s stored in the page headers, except for system objects. Thus we can’t just query for all pages whose Header.ObjectID == 117575457, as the value 117575457 won’t be stored in the header.</p>
<h3 id="Recovering_the_Customer_Allocation_Unit">Recovering the Customer Allocation Unit</h3>
<p>To find the pages belonging to the Customer table, we’ll first need to find the allocation unit to which it belongs. Unfortunately we already know that page 16 is corrupt - the first page of the <strong>sys.sysallocunits</strong> table, containing all of the metadata. However, we might just be lucky enough for that first page to contain the allocation units for all of the internal tables, which we do not care about. Let’s see if there are any other pages belonging to sys.sysallocunits:</p>
<figure class="highlight csharp"><pre>var db = new RawDatabase(@<span class="string">"D:\MSSQL Databases\AdventureWorksLT2008R2.mdf"</span>)<span class="comment">;</span>
db<span class="preprocessor">.Pages</span>
  <span class="preprocessor">.Where</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.ObjectID</span> == <span class="number">7</span>)
  <span class="preprocessor">.Dump</span>()<span class="comment">;</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/sql-server-corruption-recovery-when-all-else-fails/Capture9.png" class="fancy"><img src="/sql-server-corruption-recovery-when-all-else-fails/Capture9.png" style="max-height: 250px"/></a></div></div>

<p>There are 5 other pages available. Let’s try and parse them out so we have as much of the allocation unit data available, as possible. Once again we’ll get the schema from the working database, using sp_help, after which we can parse the remaining rows using RawDatabase. By looking up ‘sysallocunits’ in sysschobjs, we know it has an object ID of 7:</p>
<figure class="highlight csharp"><pre>var db = new RawDatabase(@<span class="string">"D:\MSSQL Databases\AdventureWorksLT2008R2.mdf"</span>)<span class="comment">;</span>
var pages = db<span class="preprocessor">.Pages</span><span class="preprocessor">.Where</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.ObjectID</span> == <span class="number">7</span> && <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.Type</span> == PageType<span class="preprocessor">.Data</span>)<span class="comment">;</span>
var records = pages<span class="preprocessor">.SelectMany</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Records</span>)<span class="preprocessor">.Select</span>(<span class="built_in">x</span> =&gt; (RawPrimaryRecord)<span class="built_in">x</span>)<span class="comment">;</span>
var rows = RawColumnParser<span class="preprocessor">.Parse</span>(records, new IRawType[] {
	RawType<span class="preprocessor">.BigInt</span>(<span class="string">"auid"</span>),
	RawType<span class="preprocessor">.TinyInt</span>(<span class="string">"type"</span>),
	RawType<span class="preprocessor">.BigInt</span>(<span class="string">"ownerid"</span>),
	RawType<span class="preprocessor">.Int</span>(<span class="string">"status"</span>),
	RawType<span class="preprocessor">.SmallInt</span>(<span class="string">"fgid"</span>),
	RawType<span class="preprocessor">.Binary</span>(<span class="string">"pgfirst"</span>, <span class="number">6</span>),
	RawType<span class="preprocessor">.Binary</span>(<span class="string">"pgroot"</span>, <span class="number">6</span>),
	RawType<span class="preprocessor">.Binary</span>(<span class="string">"pgfirstiam"</span>, <span class="number">6</span>),
	RawType<span class="preprocessor">.BigInt</span>(<span class="string">"pcused"</span>),
	RawType<span class="preprocessor">.BigInt</span>(<span class="string">"pcdata"</span>),
	RawType<span class="preprocessor">.BigInt</span>(<span class="string">"pcreserved"</span>),
	RawType<span class="preprocessor">.Int</span>(<span class="string">"dbfragid"</span>)
})<span class="comment">;</span>

rows<span class="preprocessor">.Select</span>(<span class="built_in">x</span> =&gt; new {
	AllocationUnitID = (long)<span class="built_in">x</span>[<span class="string">"auid"</span>],
	Type = (byte)<span class="built_in">x</span>[<span class="string">"type"</span>],
	ContainerID = (long)<span class="built_in">x</span>[<span class="string">"ownerid"</span>]
})<span class="preprocessor">.Dump</span>()<span class="comment">;</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/sql-server-corruption-recovery-when-all-else-fails/Capture10.png" class="fancy"><img src="/sql-server-corruption-recovery-when-all-else-fails/Capture10.png" style="max-height: 250px"/></a></div></div>

<p>By itself, we can’t use this data, but we’ll need it in just a moment. First we need to get a hold of the Customer table partitions as well. We do so by looking up the schema of <strong>sys.sysrowsets</strong> using sp_help, after which we can parse it. Looking up ‘sysrowsets’ in sysschobjs, we know that sys.sysrowsets has an object ID of 5:</p>
<figure class="highlight csharp"><pre>var db = new RawDatabase(@<span class="string">"D:\MSSQL Databases\AdventureWorksLT2008R2.mdf"</span>)<span class="comment">;</span>
var pages = db<span class="preprocessor">.Pages</span><span class="preprocessor">.Where</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.ObjectID</span> == <span class="number">5</span> && <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.Type</span> == PageType<span class="preprocessor">.Data</span>)<span class="comment">;</span>
var records = pages<span class="preprocessor">.SelectMany</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Records</span>)<span class="preprocessor">.Select</span>(<span class="built_in">x</span> =&gt; (RawPrimaryRecord)<span class="built_in">x</span>)<span class="comment">;</span>
var rows = RawColumnParser<span class="preprocessor">.Parse</span>(records, new IRawType[] {
	RawType<span class="preprocessor">.BigInt</span>(<span class="string">"rowsetid"</span>),
	RawType<span class="preprocessor">.TinyInt</span>(<span class="string">"ownertype"</span>),
	RawType<span class="preprocessor">.Int</span>(<span class="string">"idmajor"</span>),
	RawType<span class="preprocessor">.Int</span>(<span class="string">"idminor"</span>),
	RawType<span class="preprocessor">.Int</span>(<span class="string">"numpart"</span>),
	RawType<span class="preprocessor">.Int</span>(<span class="string">"status"</span>),
	RawType<span class="preprocessor">.SmallInt</span>(<span class="string">"fgidfs"</span>),
	RawType<span class="preprocessor">.BigInt</span>(<span class="string">"rcrows"</span>),
	RawType<span class="preprocessor">.TinyInt</span>(<span class="string">"cmprlevel"</span>),
	RawType<span class="preprocessor">.TinyInt</span>(<span class="string">"fillfact"</span>),
	RawType<span class="preprocessor">.SmallInt</span>(<span class="string">"maxnullbit"</span>),
	RawType<span class="preprocessor">.Int</span>(<span class="string">"maxleaf"</span>),
	RawType<span class="preprocessor">.SmallInt</span>(<span class="string">"maxint"</span>),
	RawType<span class="preprocessor">.SmallInt</span>(<span class="string">"minleaf"</span>),
	RawType<span class="preprocessor">.SmallInt</span>(<span class="string">"minint"</span>),
	RawType<span class="preprocessor">.VarBinary</span>(<span class="string">"rsguid"</span>),
	RawType<span class="preprocessor">.VarBinary</span>(<span class="string">"lockres"</span>),
	RawType<span class="preprocessor">.Int</span>(<span class="string">"dbfragid"</span>)
})<span class="comment">;</span>

rows<span class="preprocessor">.Where</span>(<span class="built_in">x</span> =&gt; (int)<span class="built_in">x</span>[<span class="string">"idmajor"</span>] == <span class="number">117575457</span>)<span class="preprocessor">.Select</span>(<span class="built_in">x</span> =&gt; new {
	RowsetID = (long)<span class="built_in">x</span>[<span class="string">"rowsetid"</span>],
	ObjectID = (int)<span class="built_in">x</span>[<span class="string">"idmajor"</span>],
	IndexID = (int)<span class="built_in">x</span>[<span class="string">"idminor"</span>]
})<span class="preprocessor">.Dump</span>()<span class="comment">;</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/sql-server-corruption-recovery-when-all-else-fails/Capture11.png" class="fancy"><img src="/sql-server-corruption-recovery-when-all-else-fails/Capture11.png" style="max-height: 250px"/></a></div></div>

<p>By filtering down to just the Customer table’s object ID, we’ve now got the three partitions that belongs to the table - one for each allocation unit type - ROW_OVERFLOW_DATA (3), LOB_DATA (2) and IN_ROW_DATA (1). We don’t care about LOB and SLOB for now, all we need is the IN_ROW_DATA partition - giving us a RowsetID value of <strong>72057594039697408</strong>.</p>
<p>Now that we have the RowsetID, let’s lookup the allocation unit using the data we got from sys.sysallocunits earlier on:</p>
<figure class="highlight csharp"><pre>var db = new RawDatabase(@<span class="string">"D:\MSSQL Databases\AdventureWorksLT2008R2.mdf"</span>)<span class="comment">;</span>
var pages = db<span class="preprocessor">.Pages</span><span class="preprocessor">.Where</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.ObjectID</span> == <span class="number">7</span> && <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.Type</span> == PageType<span class="preprocessor">.Data</span>)<span class="comment">;</span>
var records = pages<span class="preprocessor">.SelectMany</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Records</span>)<span class="preprocessor">.Select</span>(<span class="built_in">x</span> =&gt; (RawPrimaryRecord)<span class="built_in">x</span>)<span class="comment">;</span>
var rows = RawColumnParser<span class="preprocessor">.Parse</span>(records, new IRawType[] {
	RawType<span class="preprocessor">.BigInt</span>(<span class="string">"auid"</span>),
	RawType<span class="preprocessor">.TinyInt</span>(<span class="string">"type"</span>),
	RawType<span class="preprocessor">.BigInt</span>(<span class="string">"ownerid"</span>),
	RawType<span class="preprocessor">.Int</span>(<span class="string">"status"</span>),
	RawType<span class="preprocessor">.SmallInt</span>(<span class="string">"fgid"</span>),
	RawType<span class="preprocessor">.Binary</span>(<span class="string">"pgfirst"</span>, <span class="number">6</span>),
	RawType<span class="preprocessor">.Binary</span>(<span class="string">"pgroot"</span>, <span class="number">6</span>),
	RawType<span class="preprocessor">.Binary</span>(<span class="string">"pgfirstiam"</span>, <span class="number">6</span>),
	RawType<span class="preprocessor">.BigInt</span>(<span class="string">"pcused"</span>),
	RawType<span class="preprocessor">.BigInt</span>(<span class="string">"pcdata"</span>),
	RawType<span class="preprocessor">.BigInt</span>(<span class="string">"pcreserved"</span>),
	RawType<span class="preprocessor">.Int</span>(<span class="string">"dbfragid"</span>)
})<span class="comment">;</span>

rows<span class="preprocessor">.Where</span>(<span class="built_in">x</span> =&gt; (long)<span class="built_in">x</span>[<span class="string">"ownerid"</span>] == <span class="number">72057594039697408</span>)<span class="preprocessor">.Select</span>(<span class="built_in">x</span> =&gt; new {
	AllocationUnitID = (long)<span class="built_in">x</span>[<span class="string">"auid"</span>],
	Type = (byte)<span class="built_in">x</span>[<span class="string">"type"</span>],
	ContainerID = (long)<span class="built_in">x</span>[<span class="string">"ownerid"</span>]
})<span class="preprocessor">.Dump</span>()<span class="comment">;</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/sql-server-corruption-recovery-when-all-else-fails/Capture12.png" class="fancy"><img src="/sql-server-corruption-recovery-when-all-else-fails/Capture12.png" style="max-height: 250px"/></a></div></div>

<h3 id="Recovering_the_Customers">Recovering the Customers</h3>
<p>Now that we have the allocation unit ID, we can convert that into the object ID value, as stored in the page headers (big thanks goes out to <a href="http://www.sqlskills.com/blogs/paul/" target="_blank">Paul Randal</a> who was kind enough to blog about the <a href="http://www.sqlskills.com/blogs/paul/inside-the-storage-engine-how-are-allocation-unit-ids-calculated/" target="_blank">relationship between the allocation unit ID and the page header m_objId and m_indexId fields</a>):</p>
<figure class="highlight csharp"><pre><span class="keyword">var</span> allocationUnitID = <span class="number">72057594041270272</span>;
<span class="keyword">var</span> indexID = allocationUnitID &gt;&gt; <span class="number">48</span>;
<span class="keyword">var</span> objectID = (allocationUnitID - (indexID &lt;&lt; <span class="number">48</span>)) &gt;&gt; <span class="number">16</span>;

Console.WriteLine(<span class="string">"IndexID: "</span> + indexID);
Console.WriteLine(<span class="string">"ObjectID: "</span> + objectID);
</pre></figure>


<figure class="highlight"><pre><span class="attribute">IndexID</span>: <span class="string">256</span>
<span class="attribute">ObjectID</span>: <span class="string">51</span>
</pre></figure>

<p>Now that we have not only the object ID, but also the index ID, we can easily get a list of all the pages belonging to the Customer table:</p>
<figure class="highlight csharp"><pre>var db = new RawDatabase(@<span class="string">"D:\MSSQL Databases\AdventureWorksLT2008R2.mdf"</span>)<span class="comment">;</span>
db<span class="preprocessor">.Pages</span>
  <span class="preprocessor">.Where</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.ObjectID</span> == <span class="number">51</span> && <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.IndexID</span> == <span class="number">256</span>)
  <span class="preprocessor">.Dump</span>()<span class="comment">;</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/sql-server-corruption-recovery-when-all-else-fails/Capture13.png" class="fancy"><img src="/sql-server-corruption-recovery-when-all-else-fails/Capture13.png" style="max-height: 250px"/></a></div></div>

<p>And since we already know the schema for the Customer table, it’s a simple matter of making RawDatabase parse the actual rows:</p>
<figure class="highlight csharp"><pre>var db = new RawDatabase(@<span class="string">"D:\MSSQL Databases\AdventureWorksLT2008R2.mdf"</span>)<span class="comment">;</span>
var pages = db<span class="preprocessor">.Pages</span><span class="preprocessor">.Where</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.ObjectID</span> == <span class="number">51</span> && <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.IndexID</span> == <span class="number">256</span> && <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.Type</span> == PageType<span class="preprocessor">.Data</span>)<span class="comment">;</span>
var records = pages<span class="preprocessor">.SelectMany</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Records</span>)<span class="preprocessor">.Select</span>(<span class="built_in">x</span> =&gt; (RawPrimaryRecord)<span class="built_in">x</span>)<span class="comment">;</span>
var rows = RawColumnParser<span class="preprocessor">.Parse</span>(records, new IRawType[] {
	RawType<span class="preprocessor">.Int</span>(<span class="string">"CustomerID"</span>),
	RawType<span class="preprocessor">.Bit</span>(<span class="string">"NameStyle"</span>),
	RawType<span class="preprocessor">.NVarchar</span>(<span class="string">"Title"</span>),
	RawType<span class="preprocessor">.NVarchar</span>(<span class="string">"FirstName"</span>),
	RawType<span class="preprocessor">.NVarchar</span>(<span class="string">"MiddleName"</span>),
	RawType<span class="preprocessor">.NVarchar</span>(<span class="string">"LastName"</span>),
	RawType<span class="preprocessor">.NVarchar</span>(<span class="string">"Suffix"</span>),
	RawType<span class="preprocessor">.NVarchar</span>(<span class="string">"CompanyName"</span>),
	RawType<span class="preprocessor">.NVarchar</span>(<span class="string">"SalesPerson"</span>),
	RawType<span class="preprocessor">.NVarchar</span>(<span class="string">"EmailAddress"</span>),
	RawType<span class="preprocessor">.NVarchar</span>(<span class="string">"Phone"</span>),
	RawType<span class="preprocessor">.Varchar</span>(<span class="string">"PasswordHash"</span>),
	RawType<span class="preprocessor">.Varchar</span>(<span class="string">"PasswordSalt"</span>),
	RawType<span class="preprocessor">.UniqueIdentifier</span>(<span class="string">"rowguid"</span>),
	RawType<span class="preprocessor">.DateTime</span>(<span class="string">"ModifiedDate"</span>)
})<span class="comment">;</span>

rows<span class="preprocessor">.Select</span>(<span class="built_in">x</span> =&gt; new {
	CustomerID = (int)<span class="built_in">x</span>[<span class="string">"CustomerID"</span>],
	FirstName = (string)<span class="built_in">x</span>[<span class="string">"FirstName"</span>],
	MiddleName = (string)<span class="built_in">x</span>[<span class="string">"MiddleName"</span>],
	LastName = (string)<span class="built_in">x</span>[<span class="string">"LastName"</span>],
	CompanyName = (string)<span class="built_in">x</span>[<span class="string">"CompanyName"</span>],
	EmailAddress = (string)<span class="built_in">x</span>[<span class="string">"EmailAddress"</span>]
})<span class="preprocessor">.Dump</span>()<span class="comment">;</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/sql-server-corruption-recovery-when-all-else-fails/Capture15.png" class="fancy"><img src="/sql-server-corruption-recovery-when-all-else-fails/Capture15.png" style="max-height: 250px"/></a></div></div>

<p>And there we have it. 795 customers were just recovered from an otherwise unrecoverable state. Now it’s just a matter of repeating this process for the other tables as well.</p>
<h2 id="Summary">Summary</h2>
<p>As I’ve just shown, even though all hope seems lost, there are still options. If you know what you’re doing, a tool like OrcaMDF, or another homebrewn solution, might come in as an invaluable out, during a disaster. This is not, and should never be, a replacement for a good recovery strategy. That being said, not a week goes by without someone posting on a forum somewhere about a corrupt database without any backups.</p>
<p>In this case we went from fatal corruption to recovering 795 customers from the Customer table. Looking at the database, before it was corrupted, there was originally 847 customers in the table. Thus 52 customers were lost due to the corruption. If the pages really are hit by corruption, nothing will get that data back, unless you have a backup. However, if you’re unlucky and end up with metadata corruption, and/or a database that won’t come online, this may be a viable solution.</p>
<p>Should you come across a situation where OrcaMDF might come in handy, I’d love to hear about it - nothing better to hear than success stories! If you don’t feel like going through this process yourself, feel free to contact me; I may be able to help.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Nov</span>
			<span class="day">05</span>
		</div>
		<div class="lower">2013</div>
	</div>

	<div class="title">
		<h1><a href="/corrupting-databases-purpose-using-orcamdf-corruptor/" title="Corrupting Databases on Purpose Using the OrcaMDF Corruptor" rel="bookmark">Corrupting Databases on Purpose Using the OrcaMDF Corruptor</a></h1>
		<div class="categories">
			
				<a href="http://improve.dk/category/.NET/">.NET</a>
				, 
			
				<a href="http://improve.dk/category/SQL Server - Internals/">SQL Server - Internals</a>
				, 
			
				<a href="http://improve.dk/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a>
				, 
			
				<a href="http://improve.dk/category/SQL Server/">SQL Server</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Sometimes you must first do evil, to do good. Such is the case when you want to hone your skills in corruption recovery of SQL Server databases.</p>
<a id="more"></a>

<p>To give me more material to test the new <a href="/orcamdf-rawdatabase-a-swiss-army-knife-for-mdf-files/">RawDatabase</a> functionality, I’ve now added a <a href="https://github.com/improvedk/OrcaMDF/blob/master/src/OrcaMDF.Framework/Corruptor.cs" target="_blank">Corruptor class</a> to OrcaMDF. Corruptor does more or less what the name says - it corrupts database files on purpose.</p>
<p>The corruption itself is quite simple. Corruptor will choose a number of random pages and simply overwrite the page completely with all zeros. Depending on what pages are hit, this can be quite fatal.</p>
<p>I shouldn’t have to say this, but just in case… Please do not use this on anything valuable. <strong>It will fatally corrupt your data.</strong></p>
<h2 id="Examples">Examples</h2>
<p>There are two overloads for the Corruptor.CorruptFile method, both of them return an IEnumerable of integers - a list of the page IDs that have been overwritten by zeros.</p>
<p>The following code will corrupt 5% of the pages in the AdventureWorks2008R2LT.mdf file, after which it will output each page ID that has been corrupted. You can specify the percentage of pages to corrupt by changing the second parameter.</p>
<figure class="highlight csharp"><pre>var corruptedPageIDs = Corruptor<span class="preprocessor">.CorruptFile</span>(@<span class="string">"C:\AdventureWorks2008R2LT.mdf"</span>, <span class="number">0.05</span>)<span class="comment">;</span>
Console<span class="preprocessor">.WriteLine</span>(string<span class="preprocessor">.Join</span>(<span class="string">", "</span>, corruptedPageIDs))<span class="comment">;</span>
</pre></figure>


<figure class="highlight"><pre>606, 516, 603, 521, 613, 621, 118, 47, 173, 579,
323, 217, 358, 515, 615, 271, 176, 596, 417, 379,
269, 409, 558, 103, 8, 636, 200, 361, 60, 486,
366, 99, 87
</pre></figure>

<p>To make the corruption hit even harder, you can also use the second overload of the CorruptFile method, allowing you to specify the exact number of pages to corrupt, within a certain range of page IDs. The following code will corrupt exactly 10 pages within the first 50 pages (zero-based), thus hitting mostly metadata.</p>
<figure class="highlight csharp"><pre>var corruptedPageIDs = Corruptor<span class="preprocessor">.CorruptFile</span>(@<span class="string">"C:\AdventureWorks2008R2LT.mdf"</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">49</span>)<span class="comment">;</span>
Console<span class="preprocessor">.WriteLine</span>(string<span class="preprocessor">.Join</span>(<span class="string">", "</span>, corruptedPageIDs))<span class="comment">;</span>
</pre></figure>


<figure class="highlight"><pre>16, 4, 0, 32, 15, 14, 30, 2, 49, 9
</pre></figure>

<p>In the above case I was extraordinarily unlucky seeing as page 0 is the file header page, page 2 is the first GAM page, page 9 is the boot page and finally page 16 is the page that contains the allocation unit metadata. With corruption like this, you can be certain that DBCC CHECKDB will be giving up, leaving you with no other alternative than to restore from a backup.</p>
<p>Or… You could try to recover as much data as possible using <a href="/orcamdf-rawdatabase-a-swiss-army-knife-for-mdf-files/">OrcaMDF RawDatabase</a>, but I’ll get back to that later :)</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Nov</span>
			<span class="day">04</span>
		</div>
		<div class="lower">2013</div>
	</div>

	<div class="title">
		<h1><a href="/orcamdf-rawdatabase-a-swiss-army-knife-for-mdf-files/" title="OrcaMDF RawDatabase - A Swiss Army Knife for MDF Files" rel="bookmark">OrcaMDF RawDatabase - A Swiss Army Knife for MDF Files</a></h1>
		<div class="categories">
			
				<a href="http://improve.dk/category/.NET/">.NET</a>
				, 
			
				<a href="http://improve.dk/category/SQL Server - Internals/">SQL Server - Internals</a>
				, 
			
				<a href="http://improve.dk/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a>
				, 
			
				<a href="http://improve.dk/category/SQL Server/">SQL Server</a>
				, 
			
				<a href="http://improve.dk/category/Tools of the Trade/">Tools of the Trade</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>When I initially started working on <a href="/introducing-orcamdf/">OrcaMDF</a> I had just one goal, to gain a deeper knowledge of MDF file internals than I could through most books available.</p>
<a id="more"></a>

<p>As time progressed, so did OrcaMDF. While I had no initial plans of doing so, OrcaMDF has ended up being capable of parsing base tables, metadata and even <a href="/orcamdf-now-exposes-metadata-through-system-dmvs/">dynamically recreating common DMVs</a>. On top of this, I made a <a href="/orcamdf-studio-release-feature-recap/">simple GUI</a>, just to make OrcaMDF easier to use.</p>
<p>While that’s great, it comes at the price of extreme complexity. To be able to automatically parse table metadata like schemas, partitions, allocation units and more, not to mention abstracting away details like heaps and indexes, it takes a lot of code and it requires intimate knowledge of the database itself. Seeing as metadata changes between versions, OrcaMDF currently only supports SQL Server 2008 R2. While the data structures themselves are rather stable, there are minor differences in the way metadata is stored, the data exposed by DMVs and so forth. And on top of this, requiring all of the metadata to be perfect, for OrcaMDF to work, results in OrcaMDF being just as vulnerable to corruption as SQL Server is itself. Got a corrupt boot page? Neither SQL Server nor OrcaMDF will be able to parse the database.</p>
<h2 id="Say_Hello_to_RawDatabase">Say Hello to RawDatabase</h2>
<p>I tried to imagine the future of OrcaMDF and how to make it the most useful. I could march on make it support more and more of the same features that SQL Server does, eventually being able to parse 100% of an MDF file. But what would the value be? Sure, it would be a great learning opportunity, but the thing is, if you’ve got a working database, SQL Server does a pretty good job too. So what’s the alternative?</p>
<p><em>RawDatabase</em>, in contrast to the <em>Database</em> class, doesn’t try to parse anything besides what you tell it to. There’s no automatic parsing of schemas. It doesn’t know about base tables. It doesn’t know about DMVs. It does however know about the SQL Server data structures and it gives you an interface for working with the MDF file directly. Letting RawDatabase parse nothing but the data structures means it’s significantly less vulnerable to corruption or bad data.</p>
<h2 id="Examples">Examples</h2>
<p>It’s still early in the development, but let me show some examples of what can be done using RawDatabase. While I’m running the code in <a href="http://www.linqpad.net/" target="_blank">LINQPad</a>, as that makes it easy to show the results, the result are just standard .NET objects. All examples are run against the AdventureWorks 2008R2 LT (Light Weight) database.</p>
<h3 id="Getting_a_Single_Page">Getting a Single Page</h3>
<p>In the most basic example, we’ll parse just a single page.</p>
<figure class="highlight csharp"><pre><span class="comment">// Get page 197 in file 1</span>
<span class="keyword">var</span> db = <span class="keyword">new</span> RawDatabase(<span class="string">@"C:\AWLT2008R2.mdf"</span>);
db.GetPage(<span class="number">1</span>, <span class="number">197</span>).Dump();
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/orcamdf-rawdatabase-a-swiss-army-knife-for-mdf-files/A.png" class="fancy"><img src="/orcamdf-rawdatabase-a-swiss-army-knife-for-mdf-files/A.png" style="max-height: 250px"/></a></div></div>

<h3 id="Parsing_the_Page_Header">Parsing the Page Header</h3>
<p>Now that we’ve got a page, how about we dump the header values?</p>
<figure class="highlight csharp"><pre>// Get the header of page <span class="number">197</span> <span class="keyword">in</span> file <span class="number">1</span>
var db = new RawDatabase(@<span class="string">"C:\AWLT2008R2.mdf"</span>)<span class="comment">;</span>
db<span class="preprocessor">.GetPage</span>(<span class="number">1</span>, <span class="number">197</span>)<span class="preprocessor">.Header</span><span class="preprocessor">.Dump</span>()<span class="comment">;</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/orcamdf-rawdatabase-a-swiss-army-knife-for-mdf-files/A1.png" class="fancy"><img src="/orcamdf-rawdatabase-a-swiss-army-knife-for-mdf-files/A1.png" style="max-height: 250px"/></a></div></div>

<h3 id="Parsing_the_Slot_Array">Parsing the Slot Array</h3>
<p>Just as the header is available, you can also get the raw slot array entries.</p>
<figure class="highlight csharp"><pre>// Get the slot <span class="keyword">array</span> entries <span class="keyword">of</span> page <span class="number">197</span> <span class="keyword">in</span> <span class="keyword">file</span> <span class="number">1</span>
var db = <span class="keyword">new</span> RawDatabase(@<span class="string">"C:\AWLT2008R2.mdf"</span>);
db.GetPage(<span class="number">1</span>, <span class="number">197</span>).SlotArray.Dump();
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/orcamdf-rawdatabase-a-swiss-army-knife-for-mdf-files/A2.png" class="fancy"><img src="/orcamdf-rawdatabase-a-swiss-army-knife-for-mdf-files/A2.png" style="max-height: 250px"/></a></div></div>

<h3 id="Parsing_Records">Parsing Records</h3>
<p>While getting the raw slot array entries can be useful, you’ll usually want to look at the records themselves. Fortunately, that’s easy to do too.</p>
<figure class="highlight csharp"><pre>// Get <span class="keyword">all</span> records <span class="keyword">on</span> page <span class="number">197</span> <span class="keyword">in</span> <span class="keyword">file</span> <span class="number">1</span>
var db = <span class="keyword">new</span> RawDatabase(@<span class="string">"C:\AWLT2008R2.mdf"</span>);
db.GetPage(<span class="number">1</span>, <span class="number">197</span>).Records.Dump();
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/orcamdf-rawdatabase-a-swiss-army-knife-for-mdf-files/A3.png" class="fancy"><img src="/orcamdf-rawdatabase-a-swiss-army-knife-for-mdf-files/A3.png" style="max-height: 250px"/></a></div></div>

<h3 id="Retrieving_Data_from_Records">Retrieving Data from Records</h3>
<p>Once you’ve got the records, you could now access the FixedLengthData or the VariableLengthOffsetValues properties to get the raw fixed length and variable length column values. However, what you’ll typically want is to get the actually parsed values. To spare you the work, OrcaMDF can parse it for you, if you just provide it the schema.</p>
<figure class="highlight csharp"><pre>// Read the record contents of the first record on page <span class="number">197</span> of file <span class="number">1</span>
var db = new RawDatabase(@<span class="string">"C:\AWLT2008R2.mdf"</span>)<span class="comment">;</span>
RawPrimaryRecord firstRecord = (RawPrimaryRecord)db<span class="preprocessor">.GetPage</span>(<span class="number">1</span>, <span class="number">197</span>)<span class="preprocessor">.Records</span><span class="preprocessor">.First</span>()<span class="comment">;</span>

var values = RawColumnParser<span class="preprocessor">.Parse</span>(firstRecord, new IRawType[] {
	RawType<span class="preprocessor">.Int</span>(<span class="string">"AddressID"</span>),
	RawType<span class="preprocessor">.NVarchar</span>(<span class="string">"AddressLine1"</span>),
	RawType<span class="preprocessor">.NVarchar</span>(<span class="string">"AddressLine2"</span>),
	RawType<span class="preprocessor">.NVarchar</span>(<span class="string">"City"</span>),
	RawType<span class="preprocessor">.NVarchar</span>(<span class="string">"StateProvince"</span>),
	RawType<span class="preprocessor">.NVarchar</span>(<span class="string">"CountryRegion"</span>),
	RawType<span class="preprocessor">.NVarchar</span>(<span class="string">"PostalCode"</span>),
	RawType<span class="preprocessor">.UniqueIdentifier</span>(<span class="string">"rowguid"</span>),
	RawType<span class="preprocessor">.DateTime</span>(<span class="string">"ModifiedDate"</span>)
})<span class="comment">;</span>
	
values<span class="preprocessor">.Dump</span>()<span class="comment">;</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/orcamdf-rawdatabase-a-swiss-army-knife-for-mdf-files/A4.png" class="fancy"><img src="/orcamdf-rawdatabase-a-swiss-army-knife-for-mdf-files/A4.png" style="max-height: 250px"/></a></div></div>

<p>RawColumnParser.Parse will, given a schema, automatically convert the raw bytes into a Dictionary&lt;string, object&gt;, the key being the column name from the schema and the value being the actual type of the column, e.g. int, short, Guid, string, etc. By letting you, the user, specify the schema, OrcaMDF can get rid of a slew of dependencies on metadata, thus ignoring any possible corruption in metadata. Given the availability of the Next &amp; PreviousPageID properties of the header, it would be simple to iterate through all linked pages, parsing all records of each page - basically performing a scan on a given allocation unit.</p>
<h3 id="Filtering_Pages">Filtering Pages</h3>
<p>Besides retrieving a specific page, RawDatabase also has a Pages property that enumerates over all pages in a database. Using this you could, for example, get a list of all IAM pages in the database.</p>
<figure class="highlight csharp"><pre>// Get a list of all IAM pages <span class="keyword">in</span> the database
var db = new RawDatabase(@<span class="string">"C:\AWLT2008R2.mdf"</span>)<span class="comment">;</span>
db<span class="preprocessor">.Pages</span>
	<span class="preprocessor">.Where</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.Type</span> == PageType<span class="preprocessor">.IAM</span>)
	<span class="preprocessor">.Dump</span>()<span class="comment">;</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/orcamdf-rawdatabase-a-swiss-army-knife-for-mdf-files/A5.png" class="fancy"><img src="/orcamdf-rawdatabase-a-swiss-army-knife-for-mdf-files/A5.png" style="max-height: 250px"/></a></div></div>

<p>And since this is powered by LINQ, it’s easy to project just the properties you want. For example, you could get all index pages and their slot counts like this:</p>
<figure class="highlight csharp"><pre>// Get all index pages <span class="keyword">and</span> their slot counts
var db = new RawDatabase(@<span class="string">"C:\AWLT2008R2.mdf"</span>)<span class="comment">;</span>
db<span class="preprocessor">.Pages</span>
	<span class="preprocessor">.Where</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.Type</span> == PageType<span class="preprocessor">.Index</span>)
	<span class="preprocessor">.Select</span>(<span class="built_in">x</span> =&gt; new {
		<span class="built_in">x</span><span class="preprocessor">.PageID</span>,
		<span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.SlotCnt</span>
	})<span class="preprocessor">.Dump</span>()<span class="comment">;</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/orcamdf-rawdatabase-a-swiss-army-knife-for-mdf-files/A6.png" class="fancy"><img src="/orcamdf-rawdatabase-a-swiss-army-knife-for-mdf-files/A6.png" style="max-height: 250px"/></a></div></div>

<p>Or let’s say you wanted to get all data pages with at least one record and more than 7000 bytes of free space - with the page id, free count, record count and average record size as the output:</p>
<figure class="highlight csharp"><pre>var db = new RawDatabase(@<span class="string">"C:\AWLT2008R2.mdf"</span>)<span class="comment">;</span>
db<span class="preprocessor">.Pages</span>
	<span class="preprocessor">.Where</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.FreeCnt</span> &gt; <span class="number">7000</span>)
	<span class="preprocessor">.Where</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.SlotCnt</span> &gt;= <span class="number">1</span>)
	<span class="preprocessor">.Where</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.Type</span> == PageType<span class="preprocessor">.Data</span>)
	<span class="preprocessor">.Select</span>(<span class="built_in">x</span> =&gt; new {
	    <span class="built_in">x</span><span class="preprocessor">.PageID</span>,
		<span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.FreeCnt</span>,
		RecordCount = <span class="built_in">x</span><span class="preprocessor">.Records</span><span class="preprocessor">.Count</span>(),
		RecordSize = (<span class="number">8096</span> - <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.FreeCnt</span>) / <span class="built_in">x</span><span class="preprocessor">.Records</span><span class="preprocessor">.Count</span>()
	})<span class="preprocessor">.Dump</span>()<span class="comment">;</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/orcamdf-rawdatabase-a-swiss-army-knife-for-mdf-files/A7.png" class="fancy"><img src="/orcamdf-rawdatabase-a-swiss-army-knife-for-mdf-files/A7.png" style="max-height: 250px"/></a></div></div>

<p>And as a final example, imagine you’ve got just an MDF file but you seem to have forgotten what objects are stored inside of it. Fret not, we’ll just get the data from the sysschobjs base table! Sysschobjs is the base table that stores all object data, and fortunately it has a static object ID of <em>34</em>. Using this, we can filter down to all of the data pages for object 34, get all the records and then parse just the two first columns of the schema (you may specify a partial schema, as long as you only omit columns at the end), ending up in us dumping just the names (we could of course have gotten the full schema, if we wanted to).</p>
<figure class="highlight csharp"><pre>var db = new RawDatabase(@<span class="string">"C:\AWLT2008R2.mdf"</span>)<span class="comment">;</span>

var records = db<span class="preprocessor">.Pages</span>
	<span class="preprocessor">.Where</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.ObjectID</span> == <span class="number">34</span> && <span class="built_in">x</span><span class="preprocessor">.Header</span><span class="preprocessor">.Type</span> == PageType<span class="preprocessor">.Data</span>)
	<span class="preprocessor">.SelectMany</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Records</span>)<span class="comment">;</span>
	
var rows = records<span class="preprocessor">.Select</span>(<span class="built_in">x</span> =&gt; RawColumnParser<span class="preprocessor">.Parse</span>((RawPrimaryRecord)<span class="built_in">x</span>, new IRawType[] {
	RawType<span class="preprocessor">.Int</span>(<span class="string">"id"</span>),
	RawType<span class="preprocessor">.NVarchar</span>(<span class="string">"name"</span>)
}))<span class="comment">;</span>

rows<span class="preprocessor">.Select</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span>[<span class="string">"name"</span>])<span class="preprocessor">.Dump</span>()<span class="comment">;</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/orcamdf-rawdatabase-a-swiss-army-knife-for-mdf-files/A8.png" class="fancy"><img src="/orcamdf-rawdatabase-a-swiss-army-knife-for-mdf-files/A8.png" style="max-height: 250px"/></a></div></div>

<h2 id="Compatibility">Compatibility</h2>
<p>Seeing as RawDatabase doesn’t rely on metadata, it’s much easier to support multiple SQL Server versions. Thus, I’m happy to say that RawDatabase fully supports SQL Server 2005, 2008, 2008R2 and 2012. It probably supports 2014 too, I just haven’t tested that. Speaking of testing, all unit tests are automatically run against AdventureWorksLT for both 2005, 2008, 2008R2 and 2012 during testing. Right now there are tests demonstrating that OrcaMDF RawDatabase is able to parse the first record of each and every table in the AdventureWorks LT databases.</p>
<h2 id="Corruption">Corruption</h2>
<p>One of the really interesting use cases for RawDatabase is in the case of corrupted databases. You could filter pages on the object id you’re searching for and then brute-force parse each of them, retrieving whatever data is readable. If metadata is corrupted, you could ignore it, provide the schema manually and the just follow the linked lists of pages, or parse the IAM pages to read heaps. During the next couple of weeks I’ll be blogging more on OrcaMDF RawDatabase to show various use case examples, including ones on corruption.</p>
<h2 id="Source_&amp;_Feedback">Source &amp; Feedback</h2>
<p>I’m really excited about the new RawDatabase addition to OrcaMDF and I hope I’m not the only one who can see the potential. If you try it out, have any ideas, suggestions or other kinds of feedback, I’d love to hear it.</p>
<p>If you want to try it out, head on over to the <a href="https://github.com/improvedk/OrcaMDF" target="_blank">OrcaMDF project on GitHub</a>. Once it’s just a bit more polished, I’ll make it available on NuGet as well. Just like the rest of OrcaMDF, the code is licensed under GPL v3.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Oct</span>
			<span class="day">28</span>
		</div>
		<div class="lower">2013</div>
	</div>

	<div class="title">
		<h1><a href="/powerpad-powerpoint-presenters-view-for-tablets-phones/" title="PowerPad - Powerpoint Presenters View for Tablets &amp; Phones" rel="bookmark">PowerPad - Powerpoint Presenters View for Tablets &amp; Phones</a></h1>
		<div class="categories">
			
				<a href="http://improve.dk/category/.NET/">.NET</a>
				, 
			
				<a href="http://improve.dk/category/Conferences and Presenting/">Conferences and Presenting</a>
				, 
			
				<a href="http://improve.dk/category/Tools of the Trade/">Tools of the Trade</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I love presenting, especially so when it’s possible for me to do so alongside Powerpoints presenters view. Unfortunately I’m an even bigger fan of <a href="http://technet.microsoft.com/en-us/sysinternals/bb897434.aspx" target="_blank">ZoomIt</a> and I use it extensively when presenting. Why is that an issue? To use ZoomIt effectively, not just in demos but when showing slides as well, I need to duplicate my screen rather than extending it. Duplicating the screen means presenters view is not an option :(</p>
<a id="more"></a>

<h2 id="Introducing_PowerPad">Introducing PowerPad</h2>
<p>Seeing <a href="/keeping-track-of-time-while-presenting/">as I’ve already got my iPad next to me when presenting</a> it seems obvious to use that for the presenters view. However, even though I’ve scoured the app store for solutions, I have yet to find something that doesn’t require me to install invasive clients on my computer or suffice with a fixed &amp; lagging UI on the iPad. Even worse, most require me to pay up front, meaning I can’t perform a meaningful trial.</p>
<p>And so I decided to <a href="https://github.com/improvedk/PowerPad" target="_blank">do something about it</a>. PowerPad is a simple console application that runs on your computer, detects when you run a presentation and automatically provides a “presenters view” served over HTTP. The overall goal for PowerPad is to provide a Powerpoint presenters view for tablets &amp; phones.</p>
<div class="imgwrapper" style=""><div><a href="/powerpad-powerpoint-presenters-view-for-tablets-phones/presentation_started.png" class="fancy"><img src="/powerpad-powerpoint-presenters-view-for-tablets-phones/presentation_started.png" style="max-height: 250px"/></a></div></div>

<p>As soon as you’re running PowerPad, and a presentation, you’ll now be able to access the host IP through any device with a browser. I personally use my iPad:</p>
<div class="imgwrapper" style=""><div><a href="/powerpad-powerpoint-presenters-view-for-tablets-phones/screen_notes.png" class="fancy"><img src="/powerpad-powerpoint-presenters-view-for-tablets-phones/screen_notes.png" style="max-height: 250px"/></a></div></div>

<p>And in a pinch I might even use my phone:</p>
<div class="imgwrapper" style=""><div><a href="/powerpad-powerpoint-presenters-view-for-tablets-phones/screen_mobile.png" class="fancy"><img src="/powerpad-powerpoint-presenters-view-for-tablets-phones/screen_mobile.png" style="max-height: 250px"/></a></div></div>

<h2 id="Getting_Started">Getting Started</h2>
<p>PowerPad is open source and completely free to use, licensed under the MIT license. It currently supports Powerpoint 2013 and only requires you to have the .NET 2.0 Framework installed. As long as your devices are on the same network, you can hook up any number of secondary monitors to your presentation - even your attendees, should you want to.</p>
<p>For more screenshots as well as the code &amp; downloads, please check out the <a href="https://github.com/improvedk/PowerPad" target="_blank">PowerPad page on Github</a>.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Oct</span>
			<span class="day">23</span>
		</div>
		<div class="lower">2013</div>
	</div>

	<div class="title">
		<h1><a href="/announcing-tribalsql/" title="Announcing Tribal SQL" rel="bookmark">Announcing Tribal SQL</a></h1>
		<div class="categories">
			
				<a href="http://improve.dk/category/SQL Server - Community/">SQL Server - Community</a>
				, 
			
				<a href="http://improve.dk/category/SQL Server - Internals/">SQL Server - Internals</a>
				, 
			
				<a href="http://improve.dk/category/SQL Server/">SQL Server</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I’m slightly late to announce this, but better late than never!</p>
<a id="more"></a>

<p>Just a few weeks ago, the book <a href="http://www.amazon.com/Tribal-SQL-Tony-Davis/dp/1906434808/" target="_blank">Tribal SQL</a> went for sale! I authored a chapter on “Storage Internals 101” and alongside 14 other first-time authors, this is our first book to have published!</p>
<div class="imgwrapper" style=""><div><a href="/announcing-tribalsql/tribalSQLcover.png" class="fancy"><img src="/announcing-tribalsql/tribalSQLcover.png" style="max-height: 250px"/></a></div></div>

<blockquote>Tribal SQL: New voices in SQL Server<br><br>15 first-time authors answer the question: What makes you passionate about working with SQL Server?<br><br><a href="http://midnightdba.itbookworm.com/" target="_blank">MidnightDBA</a> and <a href="http://www.red-gate.com/" target="_blank">Red Gate</a> partnered to produce a book filled with community, Tribal, knowledge on SQL Server. The resulting book is a series of chapters on lessons learned, perhaps the hard way, which you won’t find in traditional training or technical guidance material.<br><br>As a truly community-driven book, the authors are all generously donating 100% of their royalties to the charity <a href="http://www.computers4africa.org.uk/" target="_blank">Computers 4 Africa</a>.<br><br>A DBA’s core responsibilities are constant. A DBA must have the hard skills necessary to maintain and enforce security mechanisms on the data, prepare effectively for disaster recovery, ensure the performance and availability of all the databases in their care.<br><br>Side by side with these, our authors have also recognized the importance of communication skills to the business and their careers. We have chapters on the importance to a DBA of communicating clearly with their co-workers and business leaders, presenting data as useful information that the business can use to make decisions, and sound project management skills.<br><br>The resulting book, <a href="http://www.amazon.com/Tribal-SQL-Tony-Davis/dp/1906434808" target="_blank">Tribal SQL</a>, is a reflection of how a DBA’s core and long-standing responsibilities and what it means to be a DBA in today’s businesses.</blockquote>

<p>If you want to get a <a href="https://www.simple-talk.com/sql/database-administration/sql-server-storage-internals-101/" target="_blank">sneak peek of my chapter</a>, it has been posted on <a href="https://www.simple-talk.com/sql/database-administration/sql-server-storage-internals-101/" target="_blank">Simple-Talk</a> as an extract of the complete book.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Oct</span>
			<span class="day">08</span>
		</div>
		<div class="lower">2013</div>
	</div>

	<div class="title">
		<h1><a href="/optimizing-performance-programmatically-setting-readonlysessionstate/" title="Optimizing Performance by Programmaticaly Setting ReadOnlySessionState" rel="bookmark">Optimizing Performance by Programmaticaly Setting ReadOnlySessionState</a></h1>
		<div class="categories">
			
				<a href="http://improve.dk/category/.NET/">.NET</a>
				, 
			
				<a href="http://improve.dk/category/IIS/">IIS</a>
				, 
			
				<a href="http://improve.dk/category/Performance/">Performance</a>
				, 
			
				<a href="http://improve.dk/category/Web/">Web</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>One of the main culprits when it comes to ASP.NET concurrency is caused by the fact that default sesion state has been implemented using a pessimistic locking pattern. Basically, any standard handler, whether that be an ASPX page, a generic handler or an ASMX web service, goes through the following steps:</p>
<a id="more"></a>

<ul>
<li>Retrieve &amp; exclusively lock session</li>
<li>Execute request handler</li>
<li>Save &amp; unlock updated session (whether updates have been made or not)</li>
</ul>
<p>What this means is that, for a given session, <em>only one request can execute concurrently</em>. Any other requests, from that same session, will block, waiting for the session to be released. For the remainder of this post I’ll concentrate on generic HttpHandlers, but this problem &amp; solution is common to for ASPX and ASMX pages as well.</p>
<h2 id="Disabling_Session_State">Disabling Session State</h2>
<p>If your handler doesn’t require session state, all you have to do is to <em>not</em> implement the IRequiresSessionState interface, given that HttpHandlers by default do not have access to session state:</p>
<figure class="highlight csharp"><pre><span class="keyword">public</span> <span class="keyword">class</span> MyHandler : IHttpHandler
{
	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ProcessRequest</span>(HttpContext context)
	{
		<span class="comment">// Perform some task</span>
	}
	
	<span class="keyword">public</span> <span class="keyword">bool</span> IsReusable { <span class="keyword">get</span> { <span class="keyword">return</span> <span class="keyword">false</span>; } }
}
</pre></figure>

<p>By not enabling session state, no session will be locked and you can execute as many concurrent requsts as your server can handle.</p>
<h2 id="Enabling_Session_State">Enabling Session State</h2>
<p>If you <em>do</em> need session state, simply implement the IRequiresSessionState interface, like so:</p>
<figure class="highlight csharp"><pre><span class="keyword">public</span> <span class="keyword">class</span> MyHandler : IHttpHandler, IRequiresSessionState
{
	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ProcessRequest</span>(HttpContext context)
	{
		<span class="comment">// Perform some task</span>
	}
	
	<span class="keyword">public</span> <span class="keyword">bool</span> IsReusable { <span class="keyword">get</span> { <span class="keyword">return</span> <span class="keyword">false</span>; } }
}
</pre></figure>

<p>The IRequiresSessionState interface carries no functionality at all, it’s simply a marker interface that tells the ASP.NET request pipeline to acquire session state for the given request. By implementing this interface you now have read+write access to the current session.</p>
<h2 id="Read-Only_Session_State">Read-Only Session State</h2>
<p>If all you need is to read session state, while not having to be able to write it, you should implement the IReadOnlySessionState interface instead, like so:</p>
<figure class="highlight csharp"><pre><span class="keyword">public</span> <span class="keyword">class</span> MyHandler : IHttpHandler, IReadOnlySessionState
{
	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ProcessRequest</span>(HttpContext context)
	{
		<span class="comment">// Perform some task</span>
	}
	
	<span class="keyword">public</span> <span class="keyword">bool</span> IsReusable { <span class="keyword">get</span> { <span class="keyword">return</span> <span class="keyword">false</span>; } }
}
</pre></figure>

<p>Implementing this interface changes the steps performed by the page slightly:</p>
<ul>
<li>Retrieve session, without locking</li>
<li>Execute request handler</li>
<li><del>Save &amp; unlock updated session (whether updates have been made or not)</del></li>
</ul>
<p>While session is still read as usual, it’s just not persisted back after the request is done. This means you can actually update the session, without causing any exceptions. However, as the session is never persisted, your changes won’t be saved after the request is done. For read-only use this also saves the superfluous save operation which can be costly if you’re using out-of-process session state like State or SQL Server.</p>
<h2 id="Switching_Between_Read+Write_and_Read-Only_Session_State_Programmatically">Switching Between Read+Write and Read-Only Session State Programmatically</h2>
<p>While this is great, we sometimes need something in between. Consider the following scenario:<7p></p>
<ul>
<li>You’ve got a single handler that’s heavily requested.</li>
<li>On the first request you need to perform some expensive lookup to load some data that will be used in all further requests, but is session specific, and will thus be stored in session state.</li>
<li>If you implement IRequiresSessionState, you can easily detect the first request (Session[“MyData”] == null), load the data, store it in session and then reuse it in all subsequent requests. However, this ensures only one request may execute at a time, due to the session being exclusively locked while the handler executes.</li>
<li>If you instead implement IReadOnlySessionState, you can execute as many handlers concurrently as you please, but you’ll have to do that expensive data loading on each request, seeing as you can’t store it in session.</li>
</ul>
<p>Imagine if you could dynamically decide whether to implement the full read+write enabled IRequiresSessionState or just the read enabled IReadOnlySession state. That way you could implement IRequiresSessionState for the first request and just implement IReadOnlySessionState for all of the subsequent requests, once a session has been established.</p>
<p>And guess what, from .NET 4.0 onwards, that’s possible!</p>
<h2 id="Enter_HttpContext-SetSessionStateBehavior">Enter HttpContext.SetSessionStateBehavior</h2>
<p>Looking at the <a href="http://msdn.microsoft.com/En-US/library/bb470252.aspx" target="_blank">ASP.NET request pipeline</a>, session state is loaded in the “Acquire state” event. At any point, before this event, we can set the session behavior programmatically by calling HttpContext.SetSessionStateBehavior. Setting the session programmatically through HttpContext.SetSessionStateBehavior will override any interfaces implemented by the handler itself.</p>
<p>Here’s a full example of an HttpModule that runs on each request. In the PostMapRequestHandler event (which fires just before the AcquireState event), we inspect the HttpHandler assigned to the request. If it implements the IPreferReadOnlySessionState interface (a custom marker interface), the SessionStateBehavior is set to ReadOnly, provided there already is an active session (which the presence of an ASP.NET_SessionId cookie indicates). If there is no session cookie present, or if the handler doesn’t implement IPreferReadOnlySessionState, then it’s left up to the handler default - that is, the implemented interface, to decide.</p>
<figure class="highlight csharp"><pre><span class="keyword">public</span> <span class="keyword">class</span> RequestHandler : IHttpModule
{
	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Init</span>(HttpApplication context)
	{
		context.PostMapRequestHandler += context_PostMapRequestHandler;
	}
	
	<span class="keyword">void</span> context_PostMapRequestHandler(<span class="keyword">object</span> sender, EventArgs e)
	{
		<span class="keyword">var</span> context = HttpContext.Current;
		
		<span class="keyword">if</span> (context.Handler <span class="keyword">is</span> IPreferReadOnlySessionState)
		{
			<span class="keyword">if</span> (context.Request.Headers[<span class="string">"Cookie"</span>] != <span class="keyword">null</span> && context.Request.Headers[<span class="string">"Cookie"</span>].Contains(<span class="string">"ASP.NET_SessionId="</span>))
				context.SetSessionStateBehavior(SessionStateBehavior.ReadOnly);
		}
	}
}
</pre></figure>

<p>Now all we need to do is to also implement the IPreferReadOnlySessionState interface in the handlers that can do with read-only sesion state, provided a session is already present:</p>
<figure class="highlight csharp"><pre><span class="keyword">public</span> <span class="keyword">interface</span> IPreferReadOnlySessionState
{ }
</pre></figure>


<figure class="highlight csharp"><pre><span class="keyword">public</span> <span class="keyword">class</span> MyHandler : IHttpHandler, IRequiresSessionState, IPreferReadOnlySessionState
{
	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ProcessRequest</span>(HttpContext context)
	{
		<span class="comment">// Perform some task</span>
	}
	
	<span class="keyword">public</span> <span class="keyword">bool</span> IsReusable { <span class="keyword">get</span> { <span class="keyword">return</span> <span class="keyword">false</span>; } }
}
</pre></figure>

<p>And just like that, the first request has read+write access to the session state, while all subsequent requests only have read access, greatly increasing the concurrency of the handler.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Sep</span>
			<span class="day">23</span>
		</div>
		<div class="lower">2013</div>
	</div>

	<div class="title">
		<h1><a href="/verifying-mailgun-webhooks/" title="Verifying Mailgun Webhooks" rel="bookmark">Verifying Mailgun Webhooks</a></h1>
		<div class="categories">
			
				<a href="http://improve.dk/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p><a href="http://www.mailgun.com/" target="_blank">Mailgun</a> has a very neat feature that enables you to basically convert incoming emails to a POST request to a URL of your choice, also known as a webhook. Using this, you can easily have your application respond to email events. However, as this URL/service needs to be publically available, verifying Mailgun webhooks is very important, ensuring requests actually come from Mailgun, and not someone impersonating Mailgun.</p>
<a id="more"></a>

<p>The code required for verifying Mailgun forwards is very simple and doesn’t require much explanation:</p>
<figure class="highlight csharp"><pre><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
<span class="comment"><span class="xmlDocTag">///</span> Verifies that the signature matches the timestamp & token.</span>
<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>True if the signature is valid, otherwise false.<span class="xmlDocTag">&lt;/returns&gt;</span></span>
<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">VerifySignature</span>(<span class="keyword">string</span> key, <span class="keyword">int</span> timestamp, <span class="keyword">string</span> token, <span class="keyword">string</span> signature)
{
	<span class="keyword">var</span> encoding = Encoding.ASCII;
	<span class="keyword">var</span> hmacSha256 = <span class="keyword">new</span> HMACSHA256(encoding.GetBytes(key));
	<span class="keyword">var</span> cleartext = encoding.GetBytes(timestamp + token);
	<span class="keyword">var</span> hash = hmacSha256.ComputeHash(cleartext);
	<span class="keyword">var</span> computedSignature = BitConverter.ToString(hash).Replace(<span class="string">"-"</span>, <span class="string">""</span>).ToLower();

	<span class="keyword">return</span> computedSignature == signature;
}
</pre></figure>

<p>Use sample:</p>
<figure class="highlight csharp"><pre><span class="comment">// All these values are provided by the Mailgun request</span>
<span class="keyword">var</span> key = <span class="string">"key-x3ifab7xngqxep7923iuab251q5vhox0"</span>;
<span class="keyword">var</span> timestamp = <span class="number">1568491354</span>;
<span class="keyword">var</span> token = <span class="string">"asdoij2893dm98m2x0a9sdkf09k423cdm"</span>;
<span class="keyword">var</span> signature = <span class="string">"AF038C73E912A830FFC830239ABFF"</span>;

<span class="comment">// Verify if request is valid</span>
<span class="keyword">bool</span> isValid = VerifySignature(key, timestamp, token, signature);
</pre></figure>

<p>As the <a href="http://documentation.mailgun.com/user_manual.html#securing-webhooks" target="_blank">manual says</a> you simply need to calculate a SHA256 HMAC of the concatenated timestamp and token values, after which you can verify that it matches the Mailgun provided signature. The key is the private API key, retrievable from the Mailgun control panel.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jun</span>
			<span class="day">04</span>
		</div>
		<div class="lower">2013</div>
	</div>

	<div class="title">
		<h1><a href="/analyzing-bsod-minidump-files-using-windbg/" title="Analyzing BSOD Minidump Files Using Windbg" rel="bookmark">Analyzing BSOD Minidump Files Using Windbg</a></h1>
		<div class="categories">
			
				<a href="http://improve.dk/category/Windbg/">Windbg</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Unfortunately, once in a while, computers fail. If you’re running Windows you’ve probably witnessed the dreaded <a href="http://en.wikipedia.org/wiki/Blue_Screen_of_Death" target="_blank">Blue Screen of Death</a>, commonly referred to as a BSOD. Once the BSOD occurs, some machines will immediately restart, before you’ve got a chance to actually see what happened. Other times users will just report that the BSOD happened, without noting anything down about what the message actually said. In this post I’ll show you how analyzing BSOD minidump files using <a href="http://en.wikipedia.org/wiki/WinDbg" target="_blank">Windbg</a> will enable you to find the cause of the BSOD after the fact.</p>
<a id="more"></a>


<h2 id="Enabling_Dump_Files">Enabling Dump Files</h2>
<p>By default, never Windows installs will automatically create minidump files once a BSOD occurs. Once restarted, you should be able to see a .dmp file here:</p>
<figure class="highlight"><pre>C:<span class="command">\Windows</span><span class="command">\Minidump</span>
</pre></figure>

<p>If you don’t see any .dmp files there, or if the directory doesn’t exist, you may have to tell Windows to create minidump files when the BSOD occurs. To do so, press the <strong>Win+Break</strong> keys to open up the System control panel. Now click <strong>Advanced system settings</strong> in the left menu. Once there, go to the <strong>Advanced</strong> tab and click the <strong>Settings…</strong> button under the <strong>Startup and Recovery</strong> section. Now make sure the <strong>Write debugging information</strong> setting is set to <strong>anything but “none”</strong>:</p>
<div class="imgwrapper" style=""><div><a href="/analyzing-bsod-minidump-files-using-windbg/Capture.png" class="fancy"><img src="/analyzing-bsod-minidump-files-using-windbg/Capture.png" style="max-height: 250px"/></a></div></div>


<h2 id="Analyzing_BSOD_Minidump_Files_Using_Windbg">Analyzing BSOD Minidump Files Using Windbg</h2>
<p>Once a dump file has been created, you can analyze it using Windbg. Start by opening Windbg and pressing the <strong>Ctrl+D</strong> keys. Now select the .dmp file you want to analyze and click <strong>Open</strong>. This should yield something like this:</p>
<figure class="highlight"><pre>Microsoft (R) Windows Debugger Version 6.12.0002.633 AMD64
Copyright (c) Microsoft Corporation. All rights reserved.


Loading Dump File [C:\Windows\Minidump\040813-15974-01.dmp]
Mini Kernel Dump File: Only registers and stack trace are available

Symbol search path is: symsrv<span class="emphasis">*symsrv.dll*</span>c:\symbols*http://msdl.microsoft.com/download/symbols
Executable search path is: 
Windows 7 Kernel Version 7601 (Service Pack 1) MP (12 procs) Free x64
Product: WinNt, suite: TerminalServer SingleUserTS
Built by: 7601.18044.amd64fre.win7sp1_gdr.130104-1431
Machine Name:
Kernel base = 0xfffff800<span class="code">`0300c000 PsLoadedModuleList = 0xfffff800`</span>03250670
Debug session time: Mon Apr  8 22:17:47.016 2013 (UTC + 2:00)
System Uptime: 0 days 1:36:19.860
Loading Kernel Symbols
...............................................................
................................................................
........................
Loading User Symbols
Loading unloaded module list
...............
<span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*
<span class="bullet">*                                                                             </span>*
<span class="bullet">*                        </span>Bugcheck Analysis                                    *
<span class="bullet">*                                                                             </span>*
<span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*

Use !analyze -v to get detailed debugging information.

BugCheck FE, {4, fffffa803c3c89e0, fffffa803102e230, fffffa803e765010}

Probably caused by : FiioE17.sys ( FiioE17+1d21 )

Followup: MachineOwner
</pre></figure>

<p>Already this tells us a couple of things - your OS details, when exactly the problem occurred as well as what module probably caused the issue (FiioE17.sys in this case). Also, it tells you how to proceed:</p>
<blockquote>
<p>Use !analyze -v to get detailed debugging information.</p>
</blockquote>
<p>As suggested, let’s try and run the !analyze -v command:</p>
<figure class="highlight"><pre>11: kd&gt; !analyze -v
<span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*
<span class="bullet">*                                                                             </span>*
<span class="bullet">*                        </span>Bugcheck Analysis                                    *
<span class="bullet">*                                                                             </span>*
<span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*

BUGCODE<span class="emphasis">_USB_</span>DRIVER (fe)
USB Driver bugcheck, first parameter is USB bugcheck code.
Arguments:
Arg1: 0000000000000004, IRP<span class="emphasis">_URB_</span>DOUBLE_SUBMIT The caller has submitted an irp
<span class="code">	that is already pending in the USB bus driver.</span>
Arg2: fffffa803c3c89e0, Address of IRP
Arg3: fffffa803102e230, Address of URB
Arg4: fffffa803e765010

<span class="header">Debugging Details:
------------------</span>

CUSTOMER<span class="emphasis">_CRASH_</span>COUNT:  1

DEFAULT<span class="emphasis">_BUCKET_</span>ID:  VISTA<span class="emphasis">_DRIVER_</span>FAULT

BUGCHECK_STR:  0xFE

PROCESS_NAME:  audiodg.exe

CURRENT_IRQL:  2

LAST<span class="emphasis">_CONTROL_</span>TRANSFER:  from fffff88008326f4b to fffff80003081c40

STACK_TEXT:  
fffff880<span class="code">`0e482fd8 fffff880`</span>08326f4b : 00000000<span class="code">`000000fe 00000000`</span>00000004 fffffa80<span class="code">`3c3c89e0 fffffa80`</span>3102e230 : nt!KeBugCheckEx
fffff880<span class="code">`0e482fe0 fffff880`</span>0833244a : fffffa80<span class="code">`3ae97002 fffffa80`</span>3b8caad0 00000000<span class="code">`00000000 fffffa80`</span>3ae97050 : USBPORT!USBPORT<span class="emphasis">_Core_</span>DetectActiveUrb+0x127
fffff880<span class="code">`0e483030 fffff880`</span>0833ae74 : fffffa80<span class="code">`3c3c89e0 fffffa80`</span>3af7000a fffffa80<span class="code">`3c3c89e0 fffffa80`</span>3102e230 : USBPORT!USBPORT_ProcessURB+0xad6
fffff880<span class="code">`0e4830e0 fffff880`</span>08314af4 : 00000000<span class="code">`00000000 fffffa80`</span>3af7b050 fffffa80<span class="code">`3e5d1720 fffffa80`</span>3c3c89e0 : USBPORT!USBPORT_PdoInternalDeviceControlIrp+0x138
fffff880<span class="code">`0e483120 fffff880`</span>00fa97a7 : fffffa80<span class="code">`3c3c89e0 fffffa80`</span>31192040 fffffa80<span class="code">`3c3c89e0 fffffa80`</span>3c3c89e0 : USBPORT!USBPORT_Dispatch+0x1dc
fffff880<span class="code">`0e483160 fffff880`</span>00fb1789 : fffff880<span class="code">`00fcfb50 fffffa80`</span>3d944ed1 fffffa80<span class="code">`3c3c8d38 fffffa80`</span>3c3c8d38 : ACPI!ACPIDispatchForwardIrp+0x37
fffff880<span class="code">`0e483190 fffff880`</span>00fa9a3f : fffff880<span class="code">`00fcfb50 fffffa80`</span>316a7a90 fffffa80<span class="code">`3c3c89e0 fffffa80`</span>3ab6c050 : ACPI!ACPIIrpDispatchDeviceControl+0x75
fffff880<span class="code">`0e4831c0 fffff880`</span>088ca566 : 00000000<span class="code">`00000000 00000000`</span>00000004 fffffa80<span class="code">`3ab6c050 fffffa80`</span>3c2bd440 : ACPI!ACPIDispatchIrp+0x12b
fffff880<span class="code">`0e483240 fffff880`</span>088fad8f : 00000000<span class="code">`00000000 00000000`</span>00000000 fffffa80<span class="code">`3c2bd440 00000000`</span>00000000 : usbhub!UsbhFdoUrbPdoFilter+0xde
fffff880<span class="code">`0e483270 fffff880`</span>088c8fb7 : fffffa80<span class="code">`3c3c89e0 fffffa80`</span>3a976ce0 fffffa80<span class="code">`3c3c89e0 fffffa80`</span>3c3c89e0 : usbhub!UsbhPdoInternalDeviceControl+0x373
fffff880<span class="code">`0e4832c0 fffff880`</span>00fa97a7 : fffffa80<span class="code">`3c3c89e0 fffff800`</span>031b630d fffffa80<span class="code">`3b7be100 00000000`</span>00000801 : usbhub!UsbhGenDispatch+0x57
fffff880<span class="code">`0e4832f0 fffff880`</span>00fb1789 : fffff880<span class="code">`00fcfb50 00000000`</span>00000001 fffffa80<span class="code">`3c393b58 fffffa80`</span>3c3c8d38 : ACPI!ACPIDispatchForwardIrp+0x37
fffff880<span class="code">`0e483320 fffff880`</span>00fa9a3f : fffff880<span class="code">`00fcfb50 fffffa80`</span>316a8a90 fffffa80<span class="code">`3c3c89e0 fffffa80`</span>3c393b58 : ACPI!ACPIIrpDispatchDeviceControl+0x75
fffff880<span class="code">`0e483350 fffff880`</span>08c9bec4 : 00000000<span class="code">`00000000 fffffa80`</span>3c326938 fffffa80<span class="code">`3c393b58 00000000`</span>00000000 : ACPI!ACPIDispatchIrp+0x12b
fffff880<span class="code">`0e4833d0 fffff880`</span>08c98812 : fffffa80<span class="code">`3c393b58 fffffa80`</span>3c3c89e0 fffffa80<span class="code">`00000324 fffffa80`</span>3c3c89e0 : usbccgp!UsbcForwardIrp+0x30
fffff880<span class="code">`0e483400 fffff880`</span>08c98aba : fffffa80<span class="code">`3c326838 00000000`</span>00220003 fffffa80<span class="code">`3c3c89e0 fffffa80`</span>3c393b58 : usbccgp!DispatchPdoUrb+0xfa
fffff880<span class="code">`0e483440 fffff880`</span>08c9672e : 00000000<span class="code">`0000000f fffffa80`</span>3c393b50 fffffa80<span class="code">`3c393b58 fffffa80`</span>3c3c89e0 : usbccgp!DispatchPdoInternalDeviceControl+0x17a
fffff880<span class="code">`0e483470 fffff880`</span>08cb3d21 : fffffa80<span class="code">`3c393a00 fffffa80`</span>3c3c8901 fffffa80<span class="code">`3c3c8900 00000000`</span>00000000 : usbccgp!USBC_Dispatch+0x2de
fffff880<span class="code">`0e4834f0 fffffa80`</span>3c393a00 : fffffa80<span class="code">`3c3c8901 fffffa80`</span>3c3c8900 00000000<span class="code">`00000000 fffffa80`</span>3c373010 : FiioE17+0x1d21
fffff880<span class="code">`0e4834f8 fffffa80`</span>3c3c8901 : fffffa80<span class="code">`3c3c8900 00000000`</span>00000000 fffffa80<span class="code">`3c373010 00000000`</span>00000000 : 0xfffffa80`3c393a00
fffff880<span class="code">`0e483500 fffffa80`</span>3c3c8900 : 00000000<span class="code">`00000000 fffffa80`</span>3c373010 00000000<span class="code">`00000000 fffffa80`</span>3c3b7f30 : 0xfffffa80`3c3c8901
fffff880<span class="code">`0e483508 00000000`</span>00000000 : fffffa80<span class="code">`3c373010 00000000`</span>00000000 fffffa80<span class="code">`3c3b7f30 fffff880`</span>08cb47fd : 0xfffffa80`3c3c8900


STACK_COMMAND:  kb

FOLLOWUP_IP: 
FiioE17+1d21
fffff880`08cb3d21 ??              ???

SYMBOL<span class="emphasis">_STACK_</span>INDEX:  12

SYMBOL_NAME:  FiioE17+1d21

FOLLOWUP_NAME:  MachineOwner

MODULE_NAME: FiioE17

IMAGE_NAME:  FiioE17.sys

DEBUG<span class="emphasis">_FLR_</span>IMAGE_TIMESTAMP:  50b30686

FAILURE<span class="emphasis">_BUCKET_</span>ID:  X64<span class="emphasis">_0xFE_</span>FiioE17+1d21

BUCKET<span class="emphasis">_ID:  X64_</span>0xFE_FiioE17+1d21

Followup: MachineOwner
</pre></figure>

<p>This tells us a number of interesting things:</p>
<ul>
<li>The BSOD error was: <strong>BUGCODE_USB_DRIVER</strong></li>
<li>This is the error caused by the driver: IRP_URB_DOUBLE_SUBMIT <strong>The caller has submitted an irp that is already pending in the USB bus driver</strong>.</li>
<li>The process that invoked the error: <strong>audiodg.exe</strong></li>
<li>The stack trace of the active thread on which the error occurred. Note that Windbg can’t find the right symbols as this is a proprietary driver with no public symbols. Even so, to the developer of said driver, the above details will help immensely.</li>
<li>The driver name: <strong>FiioE17.sys</strong></li>
</ul>
<p>With the above options, you’ve got a lot of details that can be sent to the developer, hopefully enabling him/her/them to fix the issue. For now, I’ll have to unplug my <a href="http://www.amazon.com/FiiO-Headphone-Amplifier-Docking-Interface/dp/B0070UFMOW" target="_blank">Fiio E17 USB DAC</a> :(</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">May</span>
			<span class="day">28</span>
		</div>
		<div class="lower">2013</div>
	</div>

	<div class="title">
		<h1><a href="/speaking-at-sql-pass-summit-2013/" title="Speaking at SQL PASS Summit 2013" rel="bookmark">Speaking at SQL PASS Summit 2013</a></h1>
		<div class="categories">
			
				<a href="http://improve.dk/category/SQL Server - Community/">SQL Server - Community</a>
				, 
			
				<a href="http://improve.dk/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I’m delighted to announce that <a href="http://www.sqlpass.org/summit/2013/Sessions/SpeakerDetails.aspx?spid=245" target="_blank">I’ll be speaking</a> at this years <a href="http://www.sqlpass.org/summit/2013/" target="_blank">SQL PASS Summit in Charlotte, North Carolina</a>. Having submitted several times before, unsuccessfully, I’m really happy to have made the cut this year. Looking at the <a href="http://www.sqlpass.org/summit/2013/Sessions.aspx" target="_blank">lineup of speakers</a>, I take great pride in being given the opportunity.</p>
<a id="more"></a>

<h2 id="My_Sessions">My Sessions</h2>
<p>That’s right, not just one session, but two! And as if that wasn’t enough, the two selected sessions are my absolute favorite ones to perform! I’ve presented both several times before and thanks to great feedback from the audiences I’ve slowly fine tuned the format and content.</p>
<h2 id="Top_Tricks_and_Best_Practices_for_-NET_SQL_Server_Developers">Top Tricks and Best Practices for .NET SQL Server Developers</h2>
<p>This is a session chock-full of easy-to-use tips, tricks and gotchas that can be implemented immediately. If you’re either a .NET developer yourself, or if you have .NET developers on your team, using SQL Server, this session is sure to be an eye opener with valuable lessons.</p>
<blockquote>
<p>Being the acting DBA while doing development and managing a team of .NET developers, I’ve learned a trick or two through the years. For this session, I’ve gathered my list of top tricks any .NET developer should know and use when dealing with SQL Server. We’ll cover how to use TransactionScopes without locking up the database, avoiding MSDTC escalation, using internal batching functions in the BCL through reflection, avoiding unnecessary round trips, and much more. These are tips, tricks, and best practices that I ensure all my developers are taught before they have a chance of committing code to our production systems.</p>
</blockquote>
<h2 id="Understanding_Data_Files_at_the_Byte_Level">Understanding Data Files at the Byte Level</h2>
<p>The best part about this session, for me, is watching heads explode only 15 minutes in when I make a live demonstration of how to reverse engineer SQL Server, to persuade it into describing its own data file format. In just 75 minutes I will give you not only a thorough tour of the MDF file format, but also a plethora of techniques on how to analyze your own databases internal storage as well. Using these techniques you’ll be well armed when it comes to schema discussions, column type choice and for those rare events where you need to dive just a bit below the surface to discover what’s really happening.</p>
<blockquote>
<p>This session won’t explain when to use a heap instead of an index, but you will learn how they work – and differ – behind the scenes. Demonstrations will show how data files are organized on the disk and how that organization allows SQL Server to effectively query the data. Knowing how data files are organized will in turn help immensely when it comes to optimizing databases for both performance and storage efficiency.</p>
</blockquote>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>


<div class="paging">
	<a href="/page/2/"><div class="past">« Past</div></a>
	
	<div class="clear"></div>
</div>

				</div>
			</div>

			<div id="asides">
				<div class="categories aside">
					<span class="sectiontitle">CATEGORIES</span>
					<ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/category/.NET/">.NET</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/AS/Flex/Flash/">AS/Flex/Flash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Amazon Web Services/">Amazon Web Services</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Computer Science/">Computer Science</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Conferences and Presenting/">Conferences and Presenting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/IIS/">IIS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Life/">Life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Miscellaneous/">Miscellaneous</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Performance/">Performance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Poker/">Poker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server/">SQL Server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Community/">SQL Server - Community</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Data Types/">SQL Server - Data Types</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Internals/">SQL Server - Internals</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Optimization/">SQL Server - Optimization</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Tricks/">SQL Server - Tricks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Testing/">Testing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Tools of the Trade/">Tools of the Trade</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Umbraco/">Umbraco</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Visual Studio/">Visual Studio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Web/">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windbg/">Windbg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windows/">Windows</a></li></ul>

					
				</div>

				<div class="archive aside">
					<span class="sectiontitle">ARCHIVE</span>
					<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archive/2014">2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2013">2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2012">2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2011">2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2010">2010</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2009">2009</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2008">2008</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2007">2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2006">2006</a></li></ul>
				</div>
			</div>

			<div class="clear"></div>
		</div>
		
		<footer>
			<div class="wrapper">Copyright &copy; 2014 Mark S. Rasmussen</div>
		</footer>

		<script type="text/javascript">
			$(function () {
				// Show mobile menu
				$("li.navicon").click(function () {
					if ($("header ul.mobile a").length == 0) {
						// Pages
						$mobilePages = $("div#naviconcontent ul.pages");
						$("header nav ul.normal > li").not(".navicon").each(function (i, el) {
							$mobilePages.append($(el).clone());
						});

						// Categories
						$mobileCategories = $("div#naviconcontent ul.categories");
						$("div#asides div.categories > ul > li").each(function (i, el) {
							$mobileCategories.append($(el).clone());
						});

						// Archive
						$mobileArchive = $("div#naviconcontent ul.archive");
						$("div#asides div.archive > ul > li").each(function (i, el) {
							$mobileArchive.append($(el).clone());
						});
					};

					$("header ul.mobile").toggle();
				});

				// Fancybox setup
				$("a.fancy").fancybox({
					hideOnContentClick: true,
					overlayShow: true
				});
			});
		</script>
	</body>
</html>