<!DOCTYPE html>
<html>
	

<head>
	<title>Mark S. Rasmussen</title>
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
	<meta charset="UTF-8" />
	<meta property="og:locale" content="en_US" />
	<meta property="og:type" content="website" />
	<meta name="google-site-verification" content="alt7-wfK3ZujMQ4D0jYNd0yC5LGetGdqBlBmZsqQlVw" />
	<link rel="alternative" href="http://feeds.feedburner.com/Improvedk" title="Mark S. Rasmussen" type="application/atom+xml">
	<script src="/js/combined.js"></script>
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-2479580-1', 'improve.dk');
		ga('send', 	'pageview');
	</script>
	<link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
	<body>
		<div id="headerline"></div>
	
		<header>
			<div class="wrapper">
				<div id="title">
					<a href="/">Mark S. Rasmussen</a> <span>improve.dk</span>
				</div>
				
				<nav>
					<ul class="normal">
						<li class="navicon"><img src="/img/navicon.png" /></li>
						<li><a href="/about-me/">About Me</a></li>
					</ul>
				</nav>
				
				<ul id="sharing">
					<li><a href="mailto:mark@improve.dk"><img src="/img/at.png" /></a></li>
					<li><a href="http://feeds.feedburner.com/Improvedk" id="rssfeed"><img src="/img/rss.png" /></a></li>
					<li><a href="https://twitter.com/improvedk"><img src="/img/twitter.png" /></a></li>
					<li><a href="https://github.com/improvedk"><img src="/img/github.png" /></a></li>
					<li><a href="https://www.linkedin.com/in/markrasmussen/"><img src="/img/linkedin.png" /></a></li>
				</ul>

				<div class="clear"></div>
				
				<div id="naviconcontent">
					<ul class="mobile">
						<li>
							Pages
							<ul class="pages"></ul>
						</li>
						<li>
							Categories
							<ul class="categories"></ul>
						</li>
						<li>
							Archive
							<ul class="archive"></ul>
						</li>
					</ul>
				</div>
			</div>
		</header>

		<div id="mainwrapper">
			<div id="contentwrapper">
				<div id="content">
				
					
	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Oct</span>
			<span class="day">07</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/keeping-track-of-time-while-presenting/" title="Keeping Track of Time While Presenting" rel="bookmark">Keeping Track of Time While Presenting</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>One of the most important aspects of presenting is to stay within the allotted time slot. You should aim at finishing exactly on time, neither exceeding nor finishing too early.</p>
<a id="more"></a>

<p>Some prefer to rely on the room monitor giving you the 15, 10 and 5 minute signs, while others prefer to just watch the clock on the laptop. Personally I prefer neither. Depending on the venue, you may not have a room monitor available. Also, the room monitor might not be as precise as you’d like – giving you 30 min marks, etc. As for using the laptop, that may work well during demos, but while Powerpoint’s running, you’ll have a tough time checking the time.</p>
<p>What I do is to open up my iPad, turn off the auto-locking and maximize the screen brightness. Depending on the style, I’ll then place the iPad in an easily viewable location with a big watch on it. This allows me to always have a clock readily available in an easily readable format. I can also put it on the floor enabling me to walk around, while still being able to get the time by just glancing quickly towards the floor.</p>
<h2 id="Examples">Examples</h2>
<div class="imgwrapper" style=""><div><a href="/keeping-track-of-time-while-presenting/d1rzwd_4.jpg" class="fancy"><img src="/keeping-track-of-time-while-presenting/d1rzwd_4.jpg" style="max-height: 250px"/></a></div></div>

<p><em>Here I am presenting an all day session (as evidenced by the Red Bulls). From my view I have complete control of the time and audience. The timer on the laptop is the Zoomit break timer.</em></p>
<div class="imgwrapper" style=""><div><a href="/keeping-track-of-time-while-presenting/DSC01610.jpg" class="fancy"><img src="/keeping-track-of-time-while-presenting/DSC01610.jpg" style="max-height: 250px"/></a></div></div>

<p><em>Also works good lying down to avoid blocking anyone’s view of the screen behind me.</em></p>
<div class="imgwrapper" style=""><div><a href="/keeping-track-of-time-while-presenting/IMAG0648_2.jpg" class="fancy"><img src="/keeping-track-of-time-while-presenting/IMAG0648_2.jpg" style="max-height: 250px"/></a></div></div>

<p><em>Fits snuggly under the mouse wire.</em></p>
<div class="imgwrapper" style=""><div><a href="/keeping-track-of-time-while-presenting/311452_10150292274357307_724027306_8401350_506801497_n_4.jpg" class="fancy"><img src="/keeping-track-of-time-while-presenting/311452_10150292274357307_724027306_8401350_506801497_n_4.jpg" style="max-height: 250px"/></a></div></div>

<p><em>If you look closely, you’ll see the iPad right in front of me, on the floor, allowing me a perfect time view even when walking around on the stage.</em></p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Oct</span>
			<span class="day">05</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/reflections-on-sqlbits-9-and-getting-the-most-from-conferences/" title="Reflections on SQLBits 9 and Getting the Most From Conferences" rel="bookmark">Reflections on SQLBits 9 and Getting the Most From Conferences</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>After getting back to Denmark from an excellent SQLBits 9, I’ve had a chance to reflect a bit on my experiences. Not just on SQLBits itself, but the very concept of attending conferences and how to get the most of it.</p>
<a id="more"></a>

<h2 id="SQLBits">SQLBits</h2>
<p>What can I say, it’s an excellent conference. The price is very low compared to comparable offerings, and there’s even free content if you’re just going on the Saturday. I loved the informality, placing it somewhere between the more serious PASS Summit and the king of informality, Miracle Open World.</p>
<p>One of the really great things about SQLBits was the layout. There was no separate exhibition hall, instead, it was smack in the middle of the lunch and walkthrough area. This meant people constantly went by the exhibitor booths and generally had a ball in the common area.</p>
<p>I presented a precon and a general session and I’m generally satisfied with the outcome. I look forward to receiving the feedback from SQLBits so I know how to create even better sessions next time! A special thanks goes out to <a href="http://sqlblogcasts.com/blogs/simons/" target="_blank">Simon Sabin</a> who not only cheered me on to continue OrcaMDF back in April, but also pushed me to turn my internals session into a fully fledged precon.</p>
<p>Now for a couple of observations and tips to get the most from the conferences you attend.</p>
<h2 id="Sit_up_front">Sit up front</h2>
<p>Some sessions were packed, others were scarcely populated. In almost all the sessions, you had a pretty free choice of where to sit. If the screen isn’t too close, and there’s space, make sure to get a front row seat! You’ll get an unobstructed view of the screen, better connection with the speaker and optimal conditions for saying hi to the speaker afterwards.</p>
<p>I used to always place myself near the back, just as I’d preferred it in school. Wouldn’t want that nasty teacher to ask you a question, would we? Well, this isn’t school! You’re most likely here voluntarily, so why not get the most from it? The speaker won’t ask you questions unless you participate yourself, so there’s nothing to fear. However, you should participate!</p>
<h2 id="Participate">Participate</h2>
<p>If there’s anything you’re in doubt of, disagree with or would like to have explained in further detail – raise your hand! The speaker will politely make it clear if there’s no time for questions, but most likely, he/she’ll enjoy the interaction. And don’t worry, there are no dumb questions – you’ll most likely find others pondering the same question, but just not wanting to raise their hand.</p>
<p>Not only will participation increase the chances of you going home satisfied, it’ll also improve the dynamics of the session. As a speaker, there’s nothing better than the feeling of an engaged audience.</p>
<h2 id="Don’t_be_a_wallflower">Don’t be a wallflower</h2>
<div class="imgwrapper" style=""><div><a href="/reflections-on-sqlbits-9-and-getting-the-most-from-conferences/148157_458200187635_524362635_5715992_6612638_n_2.jpg" class="fancy"><img src="/reflections-on-sqlbits-9-and-getting-the-most-from-conferences/148157_458200187635_524362635_5715992_6612638_n_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Wes Brown wrote an excellent piece on <a href="http://sqlserverio.com/2011/09/02/plucking_wallflowers/" target="_blank">plucking wallflowers</a>. I’ve attended quite a number of conferences so far, but never have I gotten as much out of them as I have this time at SQLBits. Why? I met people!</p>
<p>I went to the PASS Summit last year, not knowing anybody. I had a great time, but I didn’t meet very many people – all to the credit of myself. As most of us are, I’m an introvert – talking to strangers doesn’t come naturally to me. However, I know I should, so I try to do my best. At PASS I signed up for the excellent Inappropriate Sessions Meetup, a small community event where everyone seems to know each other. Not knowing anyone, it was a fun way for me to push some boundaries.</p>
<p>This year at SQLBits, I had the advantage of knowing a couple of people in real life. Even better, I’d connected with 20-30 people over Twitter during the last half year. I hadn’t met any of these outside of Twitter, but this really laid the foundation for a lot of great connections.</p>
<p>When you walk around and spot someone whose name you know, introduce yourself! Doesn’t matter if you don’t have anything clever to say, just shake their hand, introduce yourself and walk on if you feel like it. This makes it much much easier to start a conversation later on in the bar, during a session or lunch, etc.</p>
<p>If you liked a presentation, walk up to the presenter afterwards and introduce yourself. If you don’t have any comments, just say how you liked the session – presenters love that. And once again, you’ve set yourself up for an easier conversation later on.</p>
<h2 id="Speakers_aren’t_special">Speakers aren’t special</h2>
<p>On the topic of presenting yourself to people – don’t be afraid of speakers. The amount of speaker bite related injuries have been on a steady decline for the past several years, making it safer than ever. Joking aside, you’ll find that most speakers are just normal persons who love to have a conversation. Though speakers may seem very extrovert, many are actually introverts that have just managed to overcome that social boundary in the very moment. Talk to them! Introduce yourself! Set yourself up for conversation later by shaking their hand after a session.</p>
<p>I had a number of people come up to me during the days and just comment on my session, and all of a sudden, we had a conversation. It’s a great way of starting a conversation, and I love meeting new people, getting feedback on my sessions and hearing about their conference experience.</p>
<h2 id="Stay_at_the_conference_hotel">Stay at the conference hotel</h2>
<p>The conference hotel is usually the most expensive option. At the same time, it’s one of the cheapest boosts you can give your conference experience. Staying there makes it much more convenient for you to stay at the bar until 4 AM while making friends and awesome conversation.</p>
<p>It’s also much more convenient when you realize the coffee you’ve spilt on your white shirt during the first session. And even more convenient once you get back with your new shirt and realize you also spilt coffee all over your badge and business cards, and thus have to make yet another trip to the room. I totally did this, and it didn’t take me more than 10 minutes to be back in the game.</p>
<p>Staying at the conference hotel will also make it much easier to hook up for dinner events, going out after the sessions, etc. Basically, it’ll make the tough social game easier – it’ll improve your odds of not becoming a wallflower.</p>
<h2 id="The_PASS_Summit">The PASS Summit</h2>
<p>I’m leaving for Seattle this Saturday. This’ll be my second PASS Summit, and I absolutely can’t wait. I’m fully determined to get the most from the Summit this year, taking advantage of all the after hours events. There are basically public social events Monday – Friday, many days are even double booked.</p>
<p>Make sure to get the most out of the Summit not just by attending all of the great sessions, but by connecting with people – that’s the one thing you can’t do at home sitting in your chair while watching the DVDs!</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Oct</span>
			<span class="day">03</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/sqlbits-presentation-materials/" title="SQLBits Presentation Materials" rel="bookmark">SQLBits Presentation Materials</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I’ve got a blog post coming up tomorrow on general SQLBits reflections (‘twas awesome), for now I’ll just post my session materials as promised :)</p>
<a id="more"></a>

<h2 id="Precon_attendees">Precon attendees</h2>
<p>To those of you who attended my precon – thank you! I’m trying to see if I can get the materials sent out to you directly. Until I get that figured out, you can email me at <a href="mailto:mark@improve.dk">mark@improve.dk</a> and I’ll send the materials directly to you. I’m not keen on publishing the whole slide deck and demo archive so I hope you understand.</p>
<h2 id="Knowing_the_Internals_–_Who_Needs_SQL_Server_Anyway?">Knowing the Internals – Who Needs SQL Server Anyway?</h2>
<p>Once again – thanks for attending! It was an extremely fast paced session but I hope you got an idea of what’s going on behind the scenes of SQL Server.</p>
<p>You can download a rar file containing the slide deck, the SNSC tool and the demos here:</p>
<p><a href="sqlbits_2011_09_30_knowing_the_internals.rar">sqlbits_2011_09_30_knowing_the_internals.rar</a></p>
<p>If you saw my session, you might be interested in the following links (besides the internals related posts on this blog):</p>
<p><a href="https://github.com/improvedk/OrcaMDF" target="_blank">OrcaMDF on Github</a><br><a href="https://github.com/improvedk/SNSC" target="_blank">SNSC on Github</a></p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Sep</span>
			<span class="day">10</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/orcamdf-feature-recap/" title="OrcaMDF Feature Recap" rel="bookmark">OrcaMDF Feature Recap</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Time flies – it’s been about four months since I originally <a href="/introducing-orcamdf">introduced my pet project, OrcaMDF</a>. Since then, quite a lot has happened and OrcaMDF is somewhat more capable than when it started out. As a result I thought I’d provide a recap of what OrcaMDF is currently capable of, as well as what my plans are for the future.</p>
<a id="more"></a>

<h2 id="Page_types">Page types</h2>
<p>OrcaMDF currently supports full parsing of Data, Index, TextMix, TextTree, GAM, SGAM, IAM, and PFS pages. It also supports minimal parsing of the Boot page, used for finding the starting point of the base table metadata.</p>
<p>Remaining are Sort, FileHeader, DiffMap and MLMap pages. As MLMap and DiffMap use the same bitmap format as IAM, GAM and SGAM pages, parsing those should be straightforward. FileHeader is a bit more tricky and will require some DBCC PAGE love. Sort pages are less relevant as those are only used temporarily while SQL Server is running and should thus not be stored in your MDF file.</p>
<h2 id="Data_types">Data types</h2>
<p>I’ve been adding more and more data types to OrcaMDF, lately I’ve added support for parsing all of the LOB types except for XML. Currently supported data are:</p>
<ul>
<li>bigint</li>
<li>binary</li>
<li>bit</li>
<li>char</li>
<li>datetime</li>
<li>decimal</li>
<li>image</li>
<li>int</li>
<li>nchar</li>
<li>ntext</li>
<li>nvarchar(x)</li>
<li>nvarchar(MAX)</li>
<li>smallint</li>
<li>sysname</li>
<li>text</li>
<li>tinyint</li>
<li>varbinary(x)</li>
<li>varbinary(MAX)</li>
<li>varchar(x)</li>
<li>varchar(MAX)</li>
</ul>
<p>Adding support for further data types is relatively easy, it’s just a matter of analyzing the storage format and <a href="/implementing-data-types-in-orcamdf">implementing the ISqlType interface</a>.</p>
<h2 id="Table_&amp;_index_structures">Table &amp; index structures</h2>
<p>Using the DataScanner class, OrcaMDF is able to scan both clustered tables as well as heaps. Using the IndexScanner class enables you to scan nonclustered indexes, whether they’re applied to a clustered table or a heap.</p>
<h2 id="Metadata">Metadata</h2>
<p>The only publicly exposed metadata that OrcaMDF currently exposes is a list of table names. Internally, OrcaMDF is able to parse both indexes, tables, partitions, allocation units and columns. This enables you to scan a clustered table/heap/index, providing just its name. OrcaMDF will automatically parse the schema of the object and discover where the IAM chain starts (for heaps) or find the root page for indexes.</p>
<h2 id="Notable_leftovers">Notable leftovers</h2>
<p>OrcaMDF currently only supports single-file databases, that is, no secondary data files. Adding support would be trivial, but my efforts are concentrated on supporting the core data structures in data files, so secondary files wouldn’t change much. As for corrupted files &amp; corruption detection, OrcaMDF assumes the MDF files to be in perfect condition. There are many places where corruption could be detected, but I’ll postpone that until the day I feel OrcaMDF is able to parse most functioning databases correctly. The projected start out (and still is) as a way of getting a deeper understanding of SQL Server internals, and as such, corruption detection is less important at this stage – though it’s definitely something I’d like to add eventually.</p>
<h2 id="What’s_coming_next">What’s coming next</h2>
<p>I want to extend the current metadata parsing capabilities, especially with focus on exposing the metadata publicly. Through OrcaMDF, it should be possible to reproduce the database/object/column tree as seen in SQL Server Management Studio. I want to provide table names, indexes, schemas, keys, etc. I also want to take a look at compression, starting out with row compression. As the format is rather well documented (compared to LOB structures, for example), it shouldn’t pose too many problems.</p>
<p>If you have any suggestions or features you’d love to see supported, do let me know!</p>
<p>I’ve also had a number of requests for examples of how to use OrcaMDF. I’ll probably end up creating a series of blog posts showcasing examples of how to use various features of OrcaMDF through code. I’m also planning to create a post on how to fetch the source code and compile it and finally how to run it from there – just to make it a tad easier to take it for a spin :)</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Aug</span>
			<span class="day">23</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/2011-fall-presentation-schedule/" title="2011 Fall Presentation Schedule" rel="bookmark">2011 Fall Presentation Schedule</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>My fall schedule is starting to fall into place, and boy, is it a busy one. I am absolutely thrilled that I’ll be going to the three major SQL Server conferences this fall: <a href="http://sqlbits.com/" target="_blank">SQLBits</a>, <a href="http://www.sqlpass.org/summit/2011/" target="_blank">PASS Summit</a> and <a href="http://www.sqlpass.org/sqlrally/2011/nordic/" target="_blank">PASS SQLRally Nordic</a>. While I’m thrilled that I’ll be attending, I’m even more thrilled, humbled and excited over the fact that I’ll be presenting at all three.</p>
<a id="more"></a>

<p>There’s a lot of people I’m looking forward to meet at this years events, presentations I can’t wait to see, and beer I can’t wait to taste :)</p>
<h2 id="September_6th,_Aarhus,_Denmark">September 6th, Aarhus, Denmark</h2>
<p>As preparation for my training day at SQLBits, I’ll be giving a free preview of my presentation. <a href="http://www.trifork.com/" target="_blank">Trifork</a> has kindly offered to provide facilities and refreshments. We’ll start up at 1PM and continue until 7PM. You can register (once again, totally free) here: <a href="http://gotocon.com/aarhus-2011/freeevent/index.jsp?eventOID=3556" target="_blank">http://gotocon.com/aarhus-2011/freeevent/index.jsp?eventOID=3556</a></p>
<h2 id="September_15th,_Malmö,_Sweden">September 15th, Malmö, Sweden</h2>
<p>I will be giving a 60-minute presentation on the undocumented storage internals of SQL Server at the <a href="http://www.sqlug.se/" target="_blank">Swedish SQL Server User Group</a>. Registration is free, though limited. Make sure to register before space runs out! - <a href="http://sqlug20110915.eventbrite.com/" target="_blank">http://sqlug20110915.eventbrite.com/</a></p>
<h2 id="September_29th,_Liverpool,_UK">September 29th, Liverpool, UK</h2>
<p>I’ll start out SQLBits by giving a full training day on the <a href="http://sqlbits.com/information/Event9/SQL_Server_Storage_Engine_and_MDF_File_Internals/TrainingDetails.aspx" target="_blank">SQL Server Storage Engine and MDF File Internals</a>. During this full day session, I’ll give a thorough walkthrough of the MDF file internals, how data is stored, parsed and used optimally. I will be providing a plethora of demos and slides on never-seen-before undocumented internals. I couldn’t ask for a bigger recommendation than what Simon Sabin has written on his blog: <a href="http://sqlblogcasts.com/blogs/simons/archive/2011/07/26/must-attend-training-day-for-anyone-serious-about-sql.aspx" target="_blank">Must attend training day for anyone serious about SQL</a>. You can still make the £375.00 <a href="http://www.regonline.com/Register/Checkin.aspx?EventID=987503" target="_blank">SQLBits early bird discount</a> (expires midnight, August 26th) on the complete conference, including the training day.</p>
<h2 id="September_30th,_Liverpool,_UK">September 30th, Liverpool, UK</h2>
<p>For those not attending my training day, I’ll be giving a 60-minute version where I’ll condense my training day down to the most useful &amp; interesting topics. Hopefully you’ll end up with some valuable knowledge and an unquenchable thirst for more internals knowledge. As mentioned above, you can still make the early bird discount before August 26th – so what are you waiting for?</p>
<h2 id="October_11-14,_Seattle,_USA">October 11-14, Seattle, USA</h2>
<p>While the final scheduling hasn’t been announced yet, I’ll be giving a lightning talk at this years PASS Summit. In my <a href="http://www.sqlpass.org/summit/2011/Speakers/CallForSpeakers/SessionDetail.aspx?sid=2103" target="_blank">Revealing the magic</a> lightning talk I will, with the speed of a lightning, attempt to walk you through how to parse the data of a given table given nothing but a table name and an MDF file. We’ll start by parsing the boot page and end up parsing the data records. My goal is not for you to be able to do this afterwards (it’s only 5 minutes, after all), but hopefully I’ll demonstrate that it’s not all magic. Only a little bit.</p>
<h2 id="October_22nd,_Aarhus,_Denmark">October 22nd, Aarhus, Denmark</h2>
<p>For those of you who prefer to get hands on, I’m hosting a 6 hour code camp on SQL Server internals &amp; performance tuning. I’m aiming for a developer oriented audience who have limited to some experience with SQL Server. A laptop will be required. During the day I’ll be switching between presentations and workshop mode. I’ll introduce concepts after which you’ll be able to try it out yourself, with me helping out as necessary. While it’s aimed at developers, I’ll aim high, don’t expect me to go too easy on you ;) I’ll post once the signup page has been launched.</p>
<h2 id="November_8-9,_Aronsborg,_Sweden">November 8-9, Aronsborg, Sweden</h2>
<p>At the last event of the year, PASS SQLRally Nordic, I’ll be giving my <a href="http://www.sqlpass.org/sqlrally/2011/nordic/Agenda/Sessions/SessionsDBA.aspx" target="_blank">Knowing the Internals, Who Needs SQL Server Anyway?</a> session. This is an improved version of the session I held earlier this year at <a href="http://mow2011.dk/speakers/mark-s-rasmussen.aspx" target="_blank">Miracle Open World</a>. Since then, I’ve spent almost four months developing <a href="https://github.com/improvedk/OrcaMDF" target="_blank">OrcaMDF</a>, not to mention turning it into an open source project. Suffice to say, I’ve got a lot more to show this time around.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Aug</span>
			<span class="day">04</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/presenting-a-free-preview-of-my-sql-server-storage-engine-and-mdf-file-internals-training-day/" title="Presenting a Free Preview of my SQL Server Storage Engine and MDF File Internals Training Day" rel="bookmark">Presenting a Free Preview of my SQL Server Storage Engine and MDF File Internals Training Day</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>In collaboration with <a href="http://www.trifork.com" target="_blank">Trifork</a>, I’ll be giving a free preview of my <a href="http://www.sqlbits.com/information/Event9/SQL_Server_Storage_Engine_and_MDF_File_Internals/TrainingDetails.aspx" target="_blank">SQL Server Storage Engine and MDF File Internals training day at SQLBits</a>.</p>
<a id="more"></a>

<p>The event will take place at Trifork A/S, Margrethepladsen 4, 8000 Aarhus C on the 6th of September from 1PM – 7PM. Note that there’s a limit of just 30 attendees, so make sure to register soon if you want to join.</p>
<p><a href="http://gotocon.com/aarhus-2011/freeevent/index.jsp?eventOID=3556" target="_blank"><strong>Click here for more details and free registration</strong></a></p>
<p>Trifork has kindly chosen to sponsor some sandwiches and drinks for the night, that way you won’t be running completely dry by listening to me for six hours ;)</p>
<p>Whether you’re a SQL Server DBA/Dev that wants to take it to the next step, by gaining an extreme insight into the internals, or just a developer with a passion for bytes &amp; hacking, this should be an interesting session for you :)</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Aug</span>
			<span class="day">03</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/sqlbits-9-agenda-published/" title="SQLBits 9 Agenda Published" rel="bookmark">SQLBits 9 Agenda Published</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>The <a href="http://sqlbits.com/information/Agenda.aspx" target="_blank">agenda for SQLBits 9</a> has been published (though it’s still provisional). It’s looking really, really good. Especially so when you consider the price of the event – you’ve got until the 26th of August to get the <a href="http://sqlbits.com/information/Pricing.aspx" target="_blank">early bird price</a> of £375 for two complete days of conference – PLUS a whole day of <a href="http://sqlbits.com/information/TrainingDay.aspx" target="_blank">full day training sessions</a>.</p>
<a id="more"></a>

<h2 id="My_presentation">My presentation</h2>
<p>I’ll be presenting my <a href="http://sqlbits.com/Sessions/Event9/Knowing_the_Internals_Who_Needs_SQL_Server_Anyway_" target="_blank">Knowing the Internals, Who Needs SQL Server Anyway?</a> session. This is by far my favorite session! I originally gave it back in April at Miracle Open World, though under the name “Anatomy of an MDF File”. Since then, I’ve added a good three months of development onto <a href="https://github.com/improvedk/OrcaMDF" target="_blank">OrcaMDF</a>, the project on which the backend of the session is based. As such, this session will be even more awesome than last! Here’s the abstract:</p>
<blockquote>
<p>You’re stuck on a remote island with just a laptop and your main database .MDF file. The boss calls and asks you to retrieve some data, but alas, you forgot to install SQL Server on your laptop. Luckily you have a HEX editor by your side! </p>
<p>In this level 500 deep dive session we will go into the intimate details of the MDF file format. Think using DBCC Page is pushing it? Think again! As a learning experiment, I’ve created an open source parser for MDF files, called OrcaMDF. Using the OrcaMDF parser I’ll go through the primary storage structures, how to parse page headers, boot pages, internal system tables, data &amp; index records, b-tree structures as well as the supporting IAM, GAM, SGAM &amp; PFS pages. </p>
<p>Has your database suffered an unrecoverable disk corruption? This session might just be your way out! Using a corrupt &amp; unattachable MDF file, I’ll demo how to recover as much data as possible. This session is not for the faint of heart, there will be bits &amp; bytes.</p>
</blockquote>
<h2 id="My_training_day">My training day</h2>
<p>If you think the session sounds awesome, fret not, you can opt in for a full day of delicious SQL Server internals at a level few people venture to! As I just blogged about recently, <a href="/how-not-to-reinvent-indexes">knowing the internals is the key to creating efficient databases</a>, without knowing how to do so. I’m honored to have <a href="http://sqlblogcasts.com/blogs/simons/archive/2011/07/26/must-attend-training-day-for-anyone-serious-about-sql.aspx" target="_blank">Simon Sabin feature my training day on his blog</a>, and I really cannot promote it any better than he does. This is the official abstract:</p>
<blockquote>
<p>Join me for a journey into the depths of the SQL Server storage engine. Through a series of lectures and demonstrations we’ll look at the internals of pages, data types, indexes, heaps, extent &amp; page allocation, allocation units, system views, base tables and nightmarish ways of data recovery. We’ll look at several storage structures that are either completely undocumented or very scarcely so.  By the end of the day, not only will you know about the most important data structures in SQL Server, you’ll also be able to parse every bit of a SQL Server data file yourself, using just a hex editor! There will be lots of hands on demos, a few of them performed in C# to demonstrate the parsing of data files outside of SQL Server.</p>
</blockquote>
<p>For a more thorough agenda, you should <a href="http://sqlbits.com/information/Event9/SQL_Server_Storage_Engine_and_MDF_File_Internals/TrainingDetails.aspx" target="_blank">go check it out at the SQLBits website</a>.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Aug</span>
			<span class="day">01</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/how-not-to-reinvent-indexes/" title="How Not to Reinvent Indexes" rel="bookmark">How Not to Reinvent Indexes</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server/">SQL Server</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>In a moment of weakness I <a href="https://twitter.com/#!/improvedk/status/96646125402062849" target="_blank">pleged to make an absolute fool of myself</a> for this months <a href="http://thomaslarock.com/2011/07/meme-monday-for-august/" target="_blank">Meme Monday</a>. I wish I could say that this happened 20 years ago, when I was but a young grasshopper. To my disgrace, this happened fewer years ago than I’d like to admit.</p>
<a id="more"></a>

<h2 id="Wow,_that’s_a_lot_of_data!">Wow, that’s a lot of data!</h2>
<p>As part of beginning a new project that would publish catalogs on the web, I tried to do some capacity calculations on storing user statistics. We needed to be able to query the number of views a single page in a given catalog had had, by the hour. Assuming a worst case scenario of 24/7 visitors for a catalog with 100 pages, that would equal 100 pages <em> 24 hours </em> 365 days, roughly equal to a million rows per year, per catalog.</p>
<p>At this point I’d been working with SQL Server for some years, though exclusively as a developer. I had no knowledge of the inner workings, storage, index internals, etc. I knew enough to get by as a normal web dev, never really reaching any limits in SQL Server no matter how brain dead my solutions were. As a result, when I figured we might have hundreds of these catalogs, we might have hundreds of millions of rows. Wow, there’s absolutely no way SQL Server will be able to search that must data in a table!</p>
<h2 id="Reinventing_the_clustered_index">Reinventing the clustered index</h2>
<p>Being convinced there was no way SQL Server would be able to search that many rows in a single table, I chose to shard my data. Not into separate tables, that’d be too easy. Instead I opted to create a database per catalog, with the sole purpose of storing statistics.</p>
<p>This was brilliant. It really was. Or at least I thought so.</p>
<p>Now instead of SQL Server having to search through a hundred million row large table, I would just query my catalog statistics like so:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> CatalogStatistics_[CatalogID].dbo.StatisticsTable <span class="keyword">WHERE</span> Period BETWEEN @X <span class="keyword">AND</span> @Y</span>
</pre></figure>

<p>I knew indexes were crucial to querying so I made sure to create a nonclustered index on the Period column. Usually It’d go unused as it would require massive amounts of bookmark lookups and there’d be sufficiently small amounts of data that a clustered index scan was more effective.</p>
<h2 id="Knowing_of_indexes_does_not_mean_you_understand_them">Knowing of indexes does not mean you understand them</h2>
<p>Obviously I’d heard of indexes, I’d even used them actively. I thought I understood them – you just create them on the columns you query and everything works faster, right?</p>
<p>I’ll give myself the credit that I knew SQL Server would need some kind of way to quickly narrow down the data it had to search. I thought I’d help out SQL Server by storing the data in separate databases, making sure it would be easy for it to scan just the data for a specific catalog. Had I known how indexes really worked, being stored in an ordered binary tree, I’d realize SQL Server wouldn’t benefit from my scheme at all.</p>
<p>I just made stuff worse by causing log trashing, disk trashing, memory trashing, management trashing, backup trashing, you name it, I trashed it.</p>
<h2 id="Dude,_this_isn’t_gonna_work">Dude, this isn’t gonna work</h2>
<p>Fast forward a couple of months. Performance wasn’t the bottleneck as there just wasn’t nearly enough data or querying to really cause concern. What was becoming a bottleneck on the other hand; management. We were on a managed server solution with an external hosting company acting as DBAs, though only ensuring SQL Server was running and was backed up. I got an email saying that they were having trouble handling our backups. At that point we had just short of 3.000 databases on the instance.</p>
<p>At the same time I was having trouble satisfying our querying requirements. In the beginning we just needed to query the statistics of a single catalog at a time. Later on we needed to dynamically aggregate statistics across several catalogs at a time. Suffice to say, this didn’t work out well in the long run:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span> X, Y, Z <span class="keyword">FROM</span> CatalogStatistics_123.dbo.StatisticsTable <span class="keyword">WHERE</span> Period BETWEEN @X <span class="keyword">AND</span> @Y

<span class="keyword">UNION</span> <span class="keyword">ALL</span>

<span class="keyword">SELECT</span> X, Y, Z <span class="keyword">FROM</span> CatalogStatistics_392.dbo.StatisticsTable <span class="keyword">WHERE</span> Period BETWEEN @X <span class="keyword">AND</span> @Y

<span class="keyword">UNION</span> <span class="keyword">ALL</span>

<span class="keyword">SELECT</span> X, Y, Z <span class="keyword">FROM</span> CatalogStatistics_940.dbo.StatisticsTable <span class="keyword">WHERE</span> Period BETWEEN @X <span class="keyword">AND</span> @Y

<span class="keyword">UNION</span> <span class="keyword">ALL</span>

<span class="keyword">SELECT</span> X, Y, Z <span class="keyword">FROM</span> CatalogStatistics_1722.dbo.StatisticsTable <span class="keyword">WHERE</span> Period BETWEEN @X <span class="keyword">AND</span> @Y

...</span>
</pre></figure>

<h2 id="My_revelation">My revelation</h2>
<p>I remember going to my first SQL Server conference, attending an entry level internals session. Suddenly I knew what a page was, I knew, on a high level, how data was stored in SQL Server. Suddenly I understood the importance of the data being stored in a b-tree and how much it meant to my scalability concerns.</p>
<p>What I really like about this whole ordeal, when looking back at it, is how I didn’t attend a session on proper indexing. I didn’t attend a session about SQL Server limitations, how to store hundreds of millions of rows. Nope, I intended a session on the internals. Having just that basic knowledge of the internals suddenly provided me the necessary knowledge to figure it out myself. Maybe this is the real reason I’ve become slightly obsessed with internals ever since.</p>
<p>I don’t want a fish, I want to know how to fish.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jul</span>
			<span class="day">18</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/" title="What is the Size of the LOB Pointer for (MAX) Types Like Varchar, Varbinary, Etc?" rel="bookmark">What is the Size of the LOB Pointer for (MAX) Types Like Varchar, Varbinary, Etc?</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - Internals/">SQL Server - Internals</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>LOB types like varchar(MAX), nvarchar(MAX), varbinary(MAX) and xml suffer from split personality disorder. SQL Server may store values in-row or off-row depending on the size of the value, the available space in the record and the table settings. Because of this, it’s no easy task to predict the size of the pointer left in the record itself. You might even say… It depends.</p>
<a id="more"></a>

<p>Based on <a href="http://www.sqlservercentral.com/Forums/Topic1143500-391-1.aspx" target="_blank">this post</a>, and the fact that I’m working on LOB type support for <a href="/introducing-orcamdf">OrcaMDF</a> at the moment, I decided to look into the LOB pointer storage structures.</p>
<h2 id="Setup">Setup</h2>
<p>For testing, we’ll use a very simple schema:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Lob
(
	A <span class="keyword">char</span>(<span class="number">5000</span>) <span class="keyword">NULL</span>,
	B <span class="keyword">varchar</span>(<span class="aggregate">MAX</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>
)</span>
</pre></figure>

<h2 id="The_[BLOB_Inline_Data]_for_in-row_data">The [BLOB Inline Data] for in-row data</h2>
<p>If data is small enough (“small enough” being hard to define as it depends on the free space in the page, the mood of SQL Server and probably a bunch of other undocumented factors), it will be stored in the record itself. Let’s insert a single small row:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Lob (B) <span class="keyword">VALUES</span> (<span class="string">'Test'</span>)</span>
</pre></figure>

<p>Since A takes up 5000 bytes and we only try to insert 4 bytes into B, there’s plenty of space for it to be stored in-row, taking up only the expected 4 bytes that we inserted. This behavior is just as a normal varchar(X) SLOB column would react.</p>
<div class="imgwrapper" style=""><div><a href="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/image_4.png" class="fancy"><img src="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/image_4.png" style="max-height: 250px"/></a></div></div>

<h2 id="The_[BLOB_Inline_Root]_for_row-overflow_data">The [BLOB Inline Root] for row-overflow data</h2>
<p>Now let’s truncate the table and insert a new row, forcing SQL Server to push the data off-row as there isn’t enough space on the original record:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> LOB
<span class="keyword">INSERT</span> <span class="keyword">INTO</span> Lob (B) <span class="keyword">VALUES</span> (REPLICATE(<span class="keyword">CAST</span>(<span class="string">'a'</span> <span class="keyword">AS</span> <span class="keyword">varchar</span>(<span class="aggregate">max</span>)), <span class="number">4000</span>))</span>
</pre></figure>

<p>Since A once again takes up a fixed amount of 5000 bytes and we’re now trying to insert 4000 more bytes, we exceed the maximum capacity of 8096 bytes for the page body, causing SQL Server to push the data off-row. Running a DBCC IND confirms that SQL Server has allocated a new IAM page to track the LOB data pages:</p>
<figure class="highlight sql"><pre>DBCC IND (X, 'Lob', -1)
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/image_6.png" class="fancy"><img src="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/image_6.png" style="max-height: 250px"/></a></div></div>

<p>Extracting the record and looking at column 2 reveals that we’re now storing a 24 byte row-overflow pointer:</p>
<div class="imgwrapper" style=""><div><a href="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/image_8.png" class="fancy"><img src="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/image_8.png" style="max-height: 250px"/></a></div></div>

<p>This pointer, once again, is exactly like a SLOB column would be stored. The (MAX) LOB variants do have one trick that SLOBs don’t have though – they can be longer than 8000 bytes. In that case, we need more than one page to store the value – and thus the off-row pointer needs to point at more than one page. The off-row pointer, at an abstract level, points to a root of pointers that then point onwards to the actual data pages (or onto another root in case we need more than two levels of page references). If the root is small enough, it’ll be stored in-row. The smallest root possible is 12 bytes – a single page reference (the extra 12 bytes is due to overhead). Each following page reference takes up an extra 12 bytes. Thus, an inline root pointing to two pages will take up 36 bytes of space, and so forth, just look at this:</p>
<div class="imgwrapper" style=""><div><a href="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/image_10.png" class="fancy"><img src="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/image_10.png" style="max-height: 250px"/></a></div></div>

<div class="imgwrapper" style=""><div><a href="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/image_12.png" class="fancy"><img src="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/image_12.png" style="max-height: 250px"/></a></div></div>

<div class="imgwrapper" style=""><div><a href="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/image_14.png" class="fancy"><img src="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/image_14.png" style="max-height: 250px"/></a></div></div>

<div class="imgwrapper" style=""><div><a href="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/image_16.png" class="fancy"><img src="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/image_16.png" style="max-height: 250px"/></a></div></div>

<div class="imgwrapper" style=""><div><a href="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/image_18.png" class="fancy"><img src="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/image_18.png" style="max-height: 250px"/></a></div></div>

<p>Note how we go from 24 to 36, 48, 60 and finally 72 bytes for a total of 40.000 bytes of data, stored on five data pages. Once we exceed 72 bytes, SQL Server doesn’t store the whole root inline any longer, instead if points to a single new slot on another page. The (1:379) page is a text_tree page, containing references to the pages where the data is stored:</p>
<div class="imgwrapper" style=""><div><a href="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/image_20.png" class="fancy"><img src="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/image_20.png" style="max-height: 250px"/></a></div></div>

<p>I haven’t been able to make SQL Server store inline blob roots any larger than 72 bytes so I’m guessing that’s a hard cutoff value before it’ll start referencing text_tree pages. Ignoring text_tree pages, the pointer format so far has been exactly the same as for SLOBs. So when exactly does SQL Server store a classic 16 byte LOB pointer for (MAX) LOB types?</p>
<h2 id="The_[Textpointer]_for_LOB_data">The [Textpointer] for LOB data</h2>
<p>SQL Server will <em>never</em> store a LOB pointer for the (MAX) LOB types, <em>unless</em> the <a href="http://msdn.microsoft.com/en-us/library/ms173530.aspx" target="_blank">large value types out of row</a> setting has been turned on. Let’s clear the table, set the setting, and then insert a new row like before:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> LOB
<span class="keyword">EXEC</span> sp_tableoption N<span class="string">'Lob'</span>, <span class="string">'large value types out of row'</span>, <span class="string">'ON'</span>
<span class="keyword">INSERT</span> <span class="keyword">INTO</span> Lob (B) <span class="keyword">VALUES</span> (REPLICATE(<span class="keyword">CAST</span>(<span class="string">'a'</span> <span class="keyword">AS</span> <span class="keyword">varchar</span>(<span class="aggregate">max</span>)), <span class="number">4000</span>))</span>
</pre></figure>

<p>Now just as with the inline root, SQL Server allocates an IAM page to track the LOB data pages:</p>
<div class="imgwrapper" style=""><div><a href="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/image_22.png" class="fancy"><img src="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/image_22.png" style="max-height: 250px"/></a></div></div>

<p>But when we look at the record stored on page (1:4380), we see that it stores a Textpointer instead of an inline blob root:</p>
<div class="imgwrapper" style=""><div><a href="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/image_24.png" class="fancy"><img src="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/image_24.png" style="max-height: 250px"/></a></div></div>

<h2 id="Mixed_pointer_types">Mixed pointer types</h2>
<p>As long as the <a href="http://msdn.microsoft.com/en-us/library/ms173530.aspx" target="_blank">large value types out of row</a> setting is off (which it is by default), the (MAX) LOB types will act exactly like a SLOB column, except for the fact that the data can be larger than 8000 bytes. Once we turn the setting on, the (MAX) LOB types start acting like classic LOB types. So does this mean that the tables will always either use inline blob roots or textpointers? No, if only it were that simple. Take a look at this sample:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> TrickyLob
(
	A <span class="keyword">varchar</span>(<span class="aggregate">MAX</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>
)
<span class="keyword">INSERT</span> <span class="keyword">INTO</span> TrickyLob <span class="keyword">VALUES</span> (<span class="string">'Mark'</span>)
<span class="keyword">INSERT</span> <span class="keyword">INTO</span> TrickyLob <span class="keyword">VALUES</span> (REPLICATE(<span class="keyword">CAST</span>(<span class="string">'a'</span> <span class="keyword">AS</span> <span class="keyword">varchar</span>(<span class="aggregate">MAX</span>)), <span class="number">9000</span>))
<span class="keyword">EXEC</span> sp_tableoption N<span class="string">'TrickyLob'</span>, <span class="string">'large value types out of row'</span>, <span class="string">'ON'</span>
<span class="keyword">INSERT</span> <span class="keyword">INTO</span> TrickyLob <span class="keyword">VALUES</span> (REPLICATE(<span class="keyword">CAST</span>(<span class="string">'a'</span> <span class="keyword">AS</span> <span class="keyword">varchar</span>(<span class="aggregate">MAX</span>)), <span class="number">4000</span>))</span>
</pre></figure>

<p>Running DBCC PAGE on the single allocated data page reveals that we now have three records using three different pointer types:</p>
<div class="imgwrapper" style=""><div><a href="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/image_28.png" class="fancy"><img src="/what-is-the-size-of-the-lob-pointer-for-max-types-like-varchar-varbinary-etc/image_28.png" style="max-height: 250px"/></a></div></div>

<p>Lesson: When sp_tableoption is run to set the <a href="http://msdn.microsoft.com/en-us/library/ms173530.aspx" target="_blank">large value types out of row</a> setting, it only takes effect for newly added records. A table rebuild won’t affect existing inline blob roots either, only updates to existing records will rebuild the record and convert the inline blob root to a textpointers.</p>
<h2 id="Conclusion">Conclusion</h2>
<p>Predicting the LOB pointer type &amp; size can be tricky as it depends on multiple factors. Using the above, you should be able to get a notion of what will be stored, as well as to interpret the DBCC PAGE results you might run into.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jul</span>
			<span class="day">16</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/the-8-byte-record-that-was-9-bytes-while-making-no-sense/" title="The 8 Byte Record That Was 9 Bytes While Making No Sense" rel="bookmark">The 8 Byte Record That Was 9 Bytes While Making No Sense</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - Internals/">SQL Server - Internals</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Warning: this is a <em>select is (most likely) not broken, it’s just not working as I’d expect</em>. It may very well be that I’m just overlooking something, in which case I hope someone will correct me :)</p>
<a id="more"></a>

<p>I’ve previously blogged about <a href="/the-null-bitmap-is-not-always-present-in-data-records/">how sparse-column-only table records didn’t have a null bitmap</a>, nor did they store the usual column count, except for the number of variable length columns. In my effort to test <a href="https://github.com/improvedk/OrcaMDF" target="_blank">OrcaMDF</a>, I added the following SQL code as the setup for a test:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ScanAllNullSparse
(
	A <span class="keyword">int</span> SPARSE,
	B <span class="keyword">int</span> SPARSE
)
<span class="keyword">INSERT</span> <span class="keyword">INTO</span> ScanAllNullSparse <span class="keyword">DEFAULT</span> <span class="keyword">VALUES</span></span>
</pre></figure>

<p>Dumping out the resulting record yields the following:</p>
<div class="imgwrapper" style=""><div><a href="/the-8-byte-record-that-was-9-bytes-while-making-no-sense/image_21.png" class="fancy"><img src="/the-8-byte-record-that-was-9-bytes-while-making-no-sense/image_21.png" style="max-height: 250px"/></a></div></div>

<p>And this is where things start to get weird. The status bits (<span style="color: #ff0000;">red</span>) are all off, meaning there’s neither a null bitmap nor variable length columns in this record. The next two (<span style="color: #0000ff;">blue</span>) bytes indicate the end offset of the fixed length portion – right after those two very bytes, since we don’t have any fixed length data.</p>
<p>At this point I’m not too sure what to expect next – after all, in the <a href="/the-null-bitmap-is-not-always-present-in-data-records/">previous blog post</a> I showed how the column count wasn’t stored in all-sparse tables. Also, the status bits indicate that there’s no null bitmap. But what is the <span style="color: #008000;">green</span> 0x0100 (decimal value 1) bytes then? The only value I can see them possible indicating is the number of variable length columns. But why would that be present when the status bits indicate there are no such columns? Oh well, if that’s the case, then the next two (<span style="color: #ff0080;">pink</span>) bytes must be the offset array entry for the variable length column – having a value of 8 indicates that the variable length column has no value.</p>
<p>But wait, if the variable length column doesn’t have a value, then what is that last (<span style="color: #d16349;">orange/brownish</span>) 0x00 byte doing at the very end? That’s beyond the offset marked in the (assumedly) variable length offset array… And if the <span style="color: #ff0080;">pink</span> bytes really is the variable length offset array – should it not indicate a complex column for the sparse vector? (though it would make sense for it not to do so, if it weren’t stored in the record).</p>
<p>I can still parse this by just taking some precautions, but I still don’t understand what’s going on. Any suggestions?</p>
<h2 id="It’s_not_just_DBCC_PAGE">It’s not just DBCC PAGE</h2>
<p>To clear DBCC PAGE of any suspicion I amended my original test by inserting two extra rows with DEFAULT VALUES. The resulting offset table looks like this:</p>
<div class="imgwrapper" style=""><div><a href="/the-8-byte-record-that-was-9-bytes-while-making-no-sense/image_42.png" class="fancy"><img src="/the-8-byte-record-that-was-9-bytes-while-making-no-sense/image_42.png" style="max-height: 250px"/></a></div></div>

<p>As can be seen, the storage engine allocates 9 bytes for all three rows (though we can only verify the first two). Thus it’s not just DBCC PAGE that reads the records as being 9 bytes, so does the storage engine. This just strengthens the case that SQL Server knows best, now if only I could figure out why :)</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>


<div class="paging">
	<a href="/page/8/"><div class="past">« Past</div></a>
	<a href="/page/6/"><div class="future">Future »</div></a>
	<div class="clear"></div>
</div>

				</div>
			</div>

			<div id="asides">
				<div class="categories aside">
					<span class="sectiontitle">CATEGORIES</span>
					<ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/category/.NET/">.NET</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/AS/Flex/Flash/">AS/Flex/Flash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Amazon Web Services/">Amazon Web Services</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Computer Science/">Computer Science</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Conferences and Presenting/">Conferences and Presenting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/IIS/">IIS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Life/">Life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Miscellaneous/">Miscellaneous</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Performance/">Performance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Poker/">Poker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server/">SQL Server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Community/">SQL Server - Community</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Data Types/">SQL Server - Data Types</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Internals/">SQL Server - Internals</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Optimization/">SQL Server - Optimization</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Tricks/">SQL Server - Tricks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Testing/">Testing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Tools of the Trade/">Tools of the Trade</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Umbraco/">Umbraco</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Visual Studio/">Visual Studio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Web/">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windbg/">Windbg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windows/">Windows</a></li></ul>

					
				</div>

				<div class="archive aside">
					<span class="sectiontitle">ARCHIVE</span>
					<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archive/2014">2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2013">2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2012">2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2011">2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2010">2010</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2009">2009</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2008">2008</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2007">2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2006">2006</a></li></ul>
				</div>
			</div>

			<div class="clear"></div>
		</div>
		
		<footer>
			<div class="wrapper">Copyright &copy; 2014 Mark S. Rasmussen</div>
		</footer>

		<script type="text/javascript">
			$(function () {
				// Show mobile menu
				$("li.navicon").click(function () {
					if ($("header ul.mobile a").length == 0) {
						// Pages
						$mobilePages = $("div#naviconcontent ul.pages");
						$("header nav ul.normal > li").not(".navicon").each(function (i, el) {
							$mobilePages.append($(el).clone());
						});

						// Categories
						$mobileCategories = $("div#naviconcontent ul.categories");
						$("div#asides div.categories > ul > li").each(function (i, el) {
							$mobileCategories.append($(el).clone());
						});

						// Archive
						$mobileArchive = $("div#naviconcontent ul.archive");
						$("div#asides div.archive > ul > li").each(function (i, el) {
							$mobileArchive.append($(el).clone());
						});
					};

					$("header ul.mobile").toggle();
				});

				// Fancybox setup
				$("a.fancy").fancybox({
					hideOnContentClick: true,
					overlayShow: true
				});
			});
		</script>
	</body>
</html>