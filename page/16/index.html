<!DOCTYPE html>
<html>
	

<head>
	<title>Mark S. Rasmussen</title>
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
	<meta charset="UTF-8" />
	<meta property="og:locale" content="en_US" />
	<meta property="og:type" content="website" />
	<meta name="google-site-verification" content="alt7-wfK3ZujMQ4D0jYNd0yC5LGetGdqBlBmZsqQlVw" />
	<meta content="article" property="og:type">
<meta content="Mark S. Rasmussen" property="og:title">
<meta content="http://improve.dk/page/16/" property="og:url">
<meta property="og:image">
<meta content="Mark S. Rasmussen" property="og:site_name">
<meta property="og:description">
<meta content="summary" name="twitter:card">
	<link rel="alternative" href="http://feeds.feedburner.com/Improvedk" title="Mark S. Rasmussen" type="application/atom+xml">
	<script src="/js/combined.js"></script>
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-2479580-1', 'improve.dk');
		ga('require', 'displayfeatures');
		ga('send', 	'pageview');
	</script>
	<link rel="stylesheet" href="/css/style.css" type="text/css" />
</head>
	<body>
		<div id="headerline"></div>
	
		<header>
			<div class="wrapper">
				<div id="title">
					<a href="/">Mark S. Rasmussen</a> <span>improve.dk</span>
				</div>
				
				<nav>
					<ul class="normal">
						<li class="navicon"></li>
						<li><a href="/about-me/">About Me</a></li>
					</ul>
				</nav>
				
				<ul id="sharing">
					<li><a href="mailto:mark@improve.dk" id="shareat"></a></li>
					<li><a href="http://feeds.feedburner.com/Improvedk" id="rssfeed"></a></li>
					<li><a href="https://twitter.com/improvedk" id="sharetwitter"></a></li>
					<li><a href="https://github.com/improvedk" id="sharegithub"></a></li>
					<li><a href="https://www.linkedin.com/in/markrasmussen/" id="sharelinkedin"></a></li>
				</ul>

				<div class="clear"></div>
				
				<div id="naviconcontent">
					<ul class="mobile">
						<li>
							Pages
							<ul class="pages"></ul>
						</li>
						<li>
							Categories
							<ul class="categories"></ul>
						</li>
						<li>
							Archive
							<ul class="archive"></ul>
						</li>
					</ul>
				</div>
			</div>
		</header>

		<div id="mainwrapper">
			<div id="contentwrapper">
				<div id="content">
				
					
	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Aug</span>
			<span class="day">06</span>
		</div>
		<div class="lower">2008</div>
	</div>

	<div class="title">
		<h1><a href="/techtalk-material-security-2008/" title="TechTalk Material" rel="bookmark">TechTalk Material</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I held my TechTalk on CAS security in the .NET framework today. As promised, here are the demos and slides (in Danish). If you’re asked for a key password, it’s “123456”.</p>
<a id="more"></a>

<p><a href="Net_Security_Introduction_Slides.ppt">Net_Security_Introduction_Slides.ppt</a><br><a href="Net_Security_Introduction_Demos.zip">Net_Security_Introduction_Demos.zip</a></p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jun</span>
			<span class="day">13</span>
		</div>
		<div class="lower">2008</div>
	</div>

	<div class="title">
		<h1><a href="/dotnet-security-techtalk/" title=".NET Security TechTalk" rel="bookmark">.NET Security TechTalk</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I will be hosting two TechTalks on security in .NET, at Microsoft Denmark in August. The TechTalks will be held in DANISH.</p>
<a id="more"></a>

<p><a href="http://www.intellect.dk/" target="_blank">Jakob Andersen</a> will be co-hosting the TechTalks, hopefully filling in on my weak points and vice versa.</p>
<p>I urge participants to comment on this post regarding topics you would like us to talk about, problems you’ve had, suggestions and so forth.</p>
<p>If you’re not attending, please comment anyways - I’ll be blogging a lot on security for the time being and I’m always seeking relevant topics to research further :)</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jun</span>
			<span class="day">13</span>
		</div>
		<div class="lower">2008</div>
	</div>

	<div class="title">
		<h1><a href="/providing-custom-assembly-evidence/" title="Providing Custom Assembly Evidence" rel="bookmark">Providing Custom Assembly Evidence</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I recently <a href="/analyzing-assembly-evidence/">mentioned</a> the possibility of having an assembly provide custom evidence alongside the CLR provided evidence. Let’s see how to do it.</p>
<a id="more"></a>

<h2 id="Creating_the_evidence">Creating the evidence</h2>
<p>The first step is to actually create the evidence itself. The evidence can be in any form, as long as it’s serializable. That means you can use strings, complex types (provided they’re serializable), or plain old’n’good XML. In lack of a better example, I’ll create a piece of evidence that tells the birthdate and name of the developer behind the assembly. Really useful, I know.</p>
<figure class="highlight xml"><pre><span class="pi">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span>
<span class="tag">&lt;<span class="title">myEvidence</span>&gt;</span>
	<span class="tag">&lt;<span class="title">birthDay</span>&gt;</span>1985-07-25<span class="tag">&lt;/<span class="title">birthDay</span>&gt;</span>
	<span class="tag">&lt;<span class="title">name</span>&gt;</span>Mark S. Rasmussen<span class="tag">&lt;/<span class="title">name</span>&gt;</span>
<span class="tag">&lt;/<span class="title">myEvidence</span>&gt;</span>
</pre></figure>

<h2 id="Saving_the_evidence_in_binary_form">Saving the evidence in binary form</h2>
<p>To embed our XML as evidence, we first have to save it in binary form. To save a bit of typing, I use my SaveXmlAsBinaryEvidence function:</p>
<figure class="highlight cs"><pre><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
<span class="comment"><span class="xmlDocTag">///</span> Saves the input XML in binary format that can be used when linking custom evidence to an assembly</span>
<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="xml"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span>
<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="outputFile"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span>
<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SaveXmlAsBinaryEvidence</span>(<span class="keyword">string</span> xml, <span class="keyword">string</span> outputFile)
{
	Evidence customEvidence = <span class="keyword">new</span> Evidence();
	customEvidence.AddAssembly(xml);

	<span class="keyword">using</span> (FileStream fs = <span class="keyword">new</span> FileStream(outputFile, FileMode.Create))
	{
		BinaryFormatter bf = <span class="keyword">new</span> BinaryFormatter();
		bf.Serialize(fs, customEvidence);
	}
}
</pre></figure>

<p>This allows us to save out the evidence in binary format using a single line:</p>
<figure class="highlight cs"><pre>EvidenceCreator.SaveXmlAsBinaryEvidence(File.ReadAllText(<span class="string">"MyEvidence.xml"</span>), <span class="string">"MyEvidence.evidence"</span>);
</pre></figure>

<h2 id="Compiling_the_relevant_assembly_in_netmodule_form">Compiling the relevant assembly in netmodule form</h2>
<p>I’ve created a simple assembly named TestAssembly that consists of a single file, MyClass:</p>
<figure class="highlight cs"><pre><span class="keyword">using</span> System;

namespace TestAssembly
{
	<span class="keyword">public</span> <span class="keyword">class</span> MyClass
	{
		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Test</span>()
		{
			Console.Write(<span class="string">"Hello world!"</span>);
		}
	}
}
</pre></figure>

<p>If we compile it directly in Visual Studio, we end up with an assembly called TestAssembly.dll - this is not what we want. We need to compile the code into a .netmodule module file so we can manually link it together with our assembly into a finished assembly. Running the following command (with relevant path variables setup, or from the Visual Studio Command Prompt) will compile MyClass into a netmodule called MyClass.netmodule:</p>
<figure class="highlight cs"><pre>csc /target:module MyClass.cs
</pre></figure>

<p>You can actually load the .netmodule file into Reflector to verify the contents. It’ll work nicely, though Reflector will give a warning since our netmodule does not contain an assembly manifest.</p>
<h2 id="Creating_an_assembly_by_linking_the_netmodule_and_evidence_together">Creating an assembly by linking the netmodule and evidence together</h2>
<p>The final step is to link our evidence (MyEvidence.evidence) and netmodule (MyClass.netmodule) together. Make sure both files reside in the same directory (they don’t have to, but it’ll be easier). The following command will invoke AL.exe and do the final assembly linking:</p>
<figure class="highlight cs"><pre>al /target:library /evidence:MyEvidence.evidence /<span class="keyword">out</span>:MyClass.dll MyClass.netmodule
</pre></figure>

<p>If you load up the resulting assembly in Reflector, you’ll see the attached evidence under the Resources directory:</p>
<div class="imgwrapper" style=""><div><a href="/providing-custom-assembly-evidence/reflector_evidence_2.jpg" class="fancy"><img src="/providing-custom-assembly-evidence/reflector_evidence_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Now, if we <a href="/analyzing-assembly-evidence/">analyze the assembly evidence</a> by loading the assembly and enumerating the assembly provided evidence like so:</p>
<figure class="highlight cs"><pre>al /target:library /evidence:MyEvidence.evidence /<span class="keyword">out</span>:MyClass.dll MyClass.netmodule
</pre></figure>

<p>We see our custom evidence:</p>
<div class="imgwrapper" style=""><div><a href="/providing-custom-assembly-evidence/analyzing_custom_evidence_2.jpg" class="fancy"><img src="/providing-custom-assembly-evidence/analyzing_custom_evidence_2.jpg" style="max-height: 250px"/></a></div></div>

<h2 id="Trustworthiness">Trustworthiness</h2>
<p><a href="/analyzing-assembly-evidence/">As mentioned earlier</a>, assembly provided evidence is inherently not trustworthy. There are however ways to secure it. We could use a public/private cryptosystem to sign the actual evidence. That way, anyone reading the evidence could verify the evidence providers signature and thus be sure that the entity linking the evidence into the assembly is trustworthy.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jun</span>
			<span class="day">12</span>
		</div>
		<div class="lower">2008</div>
	</div>

	<div class="title">
		<h1><a href="/as3-numbers-get-real/" title="AS3 Numbers - Get Real" rel="bookmark">AS3 Numbers - Get Real</a></h1>
		<div class="categories">
			
				<a href="/category/AS/Flex/Flash/">AS/Flex/Flash</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Skilled developers are hard to come by these days, that includes Flash/AS3/Flex developers. As the product I’m working on is very much dependent on a Flash based frontend, I’ve been forced to learn &amp; work with AS3 &amp; Flex recently.</p>
<a id="more"></a>

<p>It’s a great experience, learning a new language - especially now that Silverlight is marching forward. As the old saying goes, know your enemy. Anyways, enough with the chit chatting, on with the problems.</p>
<p>Today I tried making a very simple functionality, I wanted to be able to select a number of images by making them highlight when selected, and dim out when deselected:</p>
<figure class="highlight mxml"><pre><span class="pi">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="tag">&lt;<span class="title">mx:Application
	xmlns:mx="http:</span>//<span class="attribute">www.adobe.com</span>/<span class="attribute">2006</span>/<span class="attribute">mxml</span>"
	<span class="attribute">layout</span>=<span class="value">"absolute"</span>&gt;</span>

	<span class="tag">&lt;<span class="title">mx:Script</span>&gt;</span>
		<span class="cdata">&lt;![CDATA[
			private function onClick():void
			{
				if(btnTest.alpha == 0.5)
					btnTest.alpha = 1;
				else
					btnTest.alpha = 0.5;
			}
		]]&gt;</span>
	<span class="tag">&lt;/<span class="title">mx:Script</span>&gt;</span>

	<span class="tag">&lt;<span class="title">mx:Button</span> <span class="attribute">id</span>=<span class="value">"btnTest"</span> <span class="attribute">click</span>=<span class="value">"onClick()"</span> <span class="attribute">label</span>=<span class="value">"Click me!"</span>/&gt;</span>

<span class="tag">&lt;/<span class="title">mx:Application</span>&gt;</span>
</pre></figure>

<p><a href="120.swf">A.swf - Demo</a></p>
<p>In this case the button is “selected” from the start (alpha = 1). When clicked, the alpha changes to half opaque (0.5), switches back to 1 when reclicked, and so forth. All working good.</p>
<p>But it’s a bit hard to differentiate between selected and non selected, so let’s change the alpha setting to 0.4 instead of 0.5:</p>
<figure class="highlight mxml"><pre><span class="pi">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="tag">&lt;<span class="title">mx:Application
	xmlns:mx="http:</span>//<span class="attribute">www.adobe.com</span>/<span class="attribute">2006</span>/<span class="attribute">mxml</span>"
	<span class="attribute">layout</span>=<span class="value">"absolute"</span>&gt;</span>

	<span class="tag">&lt;<span class="title">mx:Script</span>&gt;</span>
		<span class="cdata">&lt;![CDATA[
			private function onClick():void
			{
				if(btnTest.alpha == 0.4)
					btnTest.alpha = 1;
				else
					btnTest.alpha = 0.4;
			}
		]]&gt;</span>
	<span class="tag">&lt;/<span class="title">mx:Script</span>&gt;</span>

	<span class="tag">&lt;<span class="title">mx:Button</span> <span class="attribute">id</span>=<span class="value">"btnTest"</span> <span class="attribute">click</span>=<span class="value">"onClick()"</span> <span class="attribute">label</span>=<span class="value">"Click me!"</span>/&gt;</span>

<span class="tag">&lt;/<span class="title">mx:Application</span>&gt;</span>
</pre></figure>

<p><a href="121.swf">B.swf - Demo</a></p>
<p>But what’s this, now we’re only able to dim it, not reselect it. Why’s that? Nothing’s changed other than the alpha value. The problem becomes apparent if we trace out the buttons alpha value like so:</p>
<figure class="highlight mxml"><pre><span class="pi">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="tag">&lt;<span class="title">mx:Application
	xmlns:mx="http:</span>//<span class="attribute">www.adobe.com</span>/<span class="attribute">2006</span>/<span class="attribute">mxml</span>"
	<span class="attribute">layout</span>=<span class="value">"absolute"</span>&gt;</span>

	<span class="tag">&lt;<span class="title">mx:Script</span>&gt;</span>
		<span class="cdata">&lt;![CDATA[
			private function onClick():void
			{
				if(btnTest.alpha == 0.4)
					btnTest.alpha = 1;
				else
					btnTest.alpha = 0.4;

				mx.controls.Alert.show(btnTest.alpha.toString());
			}
		]]&gt;</span>
	<span class="tag">&lt;/<span class="title">mx:Script</span>&gt;</span>

	<span class="tag">&lt;<span class="title">mx:Button</span> <span class="attribute">id</span>=<span class="value">"btnTest"</span> <span class="attribute">click</span>=<span class="value">"onClick()"</span> <span class="attribute">label</span>=<span class="value">"Click me!"</span>/&gt;</span>

<span class="tag">&lt;/<span class="title">mx:Application</span>&gt;</span>
</pre></figure>

<p><a href="122.swf">C.swf - Demo</a></p>
<p>In case you don’t have Flash 9 installed, or are just too lazy to click the button, the resulting Alert box shows the following value: 0.3984375 - obviously not quite the 0.4 we specified.</p>
<p>Ok, let’s dumb it down a bit and do some quick testing:</p>
<figure class="highlight mxml"><pre>&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span>?&gt;
&lt;mx:Application
	xmlns:mx=<span class="string">"http://www.adobe.com/2006/mxml"</span>
	layout=<span class="string">"absolute"</span>
	initialize=<span class="string">"onInitialize()"</span>&gt;

	&lt;mx:Script&gt;
		&lt;![CDATA[

			<span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">onInitialize</span><span class="params">()</span><span class="type">:void</span>
			{</span>
				<span class="comment">// true</span>
				trace(<span class="number">0.4</span> == <span class="number">0.4</span>);

				<span class="comment">// true</span>
				<span class="keyword">var</span> zeroPointFour:Number = <span class="number">0.4</span>;
				trace(zeroPointFour == <span class="number">0.4</span>);

				<span class="comment">// true</span>
				<span class="keyword">var</span> secondZeroPointFour:Number = <span class="number">0.4</span>;
				trace(zeroPointFour == secondZeroPointFour);

				<span class="comment">// false</span>
				<span class="keyword">var</span> testSprite:Sprite = <span class="keyword">new</span> Sprite();
				testSprite.alpha = <span class="number">0.4</span>;
				trace(testSprite.alpha == <span class="number">0.4</span>);

				<span class="comment">// 0.3984375</span>
				trace(testSprite.alpha);

				<span class="comment">// false - duh</span>
				trace(<span class="number">0.3984375</span> == <span class="number">0.4</span>)
			}

		]]&gt;
	&lt;/mx:Script&gt;

&lt;/mx:Application&gt;
</pre></figure>

<p>Now this is where things start getting weird. We can obviously store the value 0.4 in a number (which is a 64 bit double-precision format according to the <a href="http://en.wikipedia.org/wiki/IEEE_754" target="_blank">IEEE-754 spec</a>). Furthermore, we’re also able to compare two instances of Number with the value 0.4 and get the expected equality comparison result, true. Now, it would seem that as soon we set the alpha value on our Sprite, it’s corrupted. Sprite inherits the alpha property from <a href="http://livedocs.adobe.com/flex/2/langref/flash/display/DisplayObject.html" target="_blank">DisplayObject</a> - which obviously lists alpha as a value of type Number.</p>
<p>Why does this happen? It’s no problem storing the value 0.4 in a 64 bit double precision number:</p>
<figure class="highlight"><pre><span class="attribute">Sign</span>: <span class="string">+1</span>
<span class="attribute">Exponent</span>: <span class="string">-2</span>
<span class="attribute">Mantissa</span>: <span class="string">1.6</span>
<span class="attribute">Result</span>: <span class="string">sign x 2&lt;sup&gt;exponent&lt;/sup&gt; x mantissa =&gt; +1 x 2&lt;sup&gt;-2&lt;/sup&gt; x 1.6 = 0.4</span>
</pre></figure>

<p>It might be (and probably is) me not understanding something right. Can somebody explain to me how the Flash VM handles Numbers, and thereby, explain why this is happening? Is it perhaps not due to the VM’s handling of Numbers, but instead just a simple matter of an odd implementation of the alpha property on DisplayObject?</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jun</span>
			<span class="day">11</span>
		</div>
		<div class="lower">2008</div>
	</div>

	<div class="title">
		<h1><a href="/analyzing-assembly-evidence/" title="Analyzing Assembly Evidence" rel="bookmark">Analyzing Assembly Evidence</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>When the CLR loads an assembly and needs to determine the appropriate permission set to apply, it’s based on various evidence. Assembly evidence tells the CLR about the origins of the assembly, the zone it’s loaded from and the file hash of the actual assembly file - these are just some of the more common evidence types the CLR uses, there are a lot more that are rarely used. Any object can be a piece of evidence, the CLR will only react on well known evidence types though.</p>
<a id="more"></a>

<p>There are two different overall origins of evidence, assembly provided and CLR provided. When the CLR loads an assembly, it recognizes the evidence based on the location the assembly is loaded from, file hash and so forth - this is the CLR provided evidence. The other type of evidence is custom evidence provided by the assembly itself. Although useful, we have to be careful not to blindly trust this evidence as it’s provided by the assembly manufacturer. Thus an assembly manufacturer might provide a piece of evidence claiming that the assembly is provided by Microsoft / Google / some other trustworthy corporation - even though that might not be the case.</p>
<p>Any loaded assembly has an evidence property of type <a href="http://msdn.microsoft.com/en-us/library/system.security.policy.evidence.aspx" target="_blank">System.Security.Policy.Evidence</a>. The Evidence class has three relevant functions for obtaining the actual evidence, namely GetHostEnumerator, GetAssemblyEnumerator and GetEnumerator. GetHostEnumerator returns an IEnumerator containing the evidence policies, likewise the GetAssemblyEnumerator returns the assembly provided (and inherently untrustworthy) policies, while the GetEnumerator returns the union of the two.</p>
<p>Just a quick tip. I hate using enumerators, I much prefer foreach loops. The following method will take an IEnumerator and yield an IEnumerable, enabling you to foreach the collection:</p>
<figure class="highlight cs"><pre><span class="keyword">public</span> <span class="keyword">static</span> IEnumerable <span class="title">GetEnumerable</span>(IEnumerator enumerator)
{
	<span class="keyword">while</span> (enumerator.MoveNext())
		<span class="keyword">yield</span> <span class="keyword">return</span> enumerator.Current;
}
</pre></figure>

<p>I’ve created a simple assembly containing an empty class (the contents of the assembly is not relevant in regards to evidence) called TestAssembly. The following code will load in the TestAssembly from the application directory and enumerate the CLR provided evidence. Note that I’ve got a special case for the<a href="http://msdn.microsoft.com/en-us/library/system.security.policy.hash(VS.80" target="_blank">System.Security.Policy.Hash</a>.aspx) type as it includes a rather lengthy hash of the file. The hash evidence can be used to validate the assembly contents against a pre-known hash of the assembly as a simple way of tamper protecting your applications assemblies.</p>
<figure class="highlight cs"><pre>Assembly asm = Assembly.LoadFile(Path.Combine(Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location), <span class="string">"TestAssembly.dll"</span>));

<span class="keyword">foreach</span> (<span class="keyword">object</span> obj <span class="keyword">in</span> EnumeratorHelper.GetEnumerable(asm.Evidence.GetHostEnumerator()))
	<span class="keyword">if</span> (obj <span class="keyword">is</span> Hash)
		Console.WriteLine(<span class="string">@"&lt;System.Security.Policy.Hash version=""1""&gt;&lt;RawData&gt;4D5A900003...00000&lt;/RawData&gt;&lt;/System.Security.Policy.Hash&gt;"</span>);
	<span class="keyword">else</span>
		Console.WriteLine(obj.ToString());
</pre></figure>

<p>This is the resulting output:</p>
<figure class="highlight xml"><pre><span class="tag">&lt;<span class="title">System.Security.Policy.Zone</span> <span class="attribute">version</span>=<span class="value">"1"</span>&gt;</span>
	<span class="tag">&lt;<span class="title">Zone</span>&gt;</span>MyComputer<span class="tag">&lt;/<span class="title">Zone</span>&gt;</span>
<span class="tag">&lt;/<span class="title">System.Security.Policy.Zone</span>&gt;</span>

<span class="tag">&lt;<span class="title">System.Security.Policy.Url</span> <span class="attribute">version</span>=<span class="value">"1"</span>&gt;</span>
	<span class="tag">&lt;<span class="title">Url</span>&gt;</span>file:///D:/Webmentor Projekter/Security/AnalyzeEvidence2/bin/Debug/TestAssembly.DLL<span class="tag">&lt;/<span class="title">Url</span>&gt;</span>
<span class="tag">&lt;/<span class="title">System.Security.Policy.Url</span>&gt;</span>

<span class="tag">&lt;<span class="title">System.Security.Policy.Hash</span> <span class="attribute">version</span>=<span class="value">"1"</span>&gt;</span>
	<span class="tag">&lt;<span class="title">RawData</span>&gt;</span>4D5A900003...00000<span class="tag">&lt;/<span class="title">RawData</span>&gt;</span>
<span class="tag">&lt;/<span class="title">System.Security.Policy.Hash</span>&gt;</span>
</pre></figure>

<p>As we can see, it gives us the URL from where the assembly was loaded, our security zone (MyComputer since it was loaded locally), and finally the dummy hash.</p>
<p>I’ve got a test server running called Mirage. Mirage is part of the Active Directory domain ipaper.lan and I’ve set a website up on it answering to the default address <a href="http://mirage.ipaper.lan" target="_blank">http://mirage.ipaper.lan</a>. When loading the TestAssembly from this website, the evidence changes a bit:</p>
<figure class="highlight cs"><pre>Assembly asm = Assembly.LoadFrom(<span class="string">"http://mirage.ipaper.lan/TestAssembly.dll"</span>);
</pre></figure>


<figure class="highlight xml"><pre><span class="tag">&lt;<span class="title">System.Security.Policy.Zone</span> <span class="attribute">version</span>=<span class="value">"1"</span>&gt;</span>
	<span class="tag">&lt;<span class="title">Zone</span>&gt;</span>Internet<span class="tag">&lt;/<span class="title">Zone</span>&gt;</span>
<span class="tag">&lt;/<span class="title">System.Security.Policy.Zone</span>&gt;</span>

<span class="tag">&lt;<span class="title">System.Security.Policy.Url</span> <span class="attribute">version</span>=<span class="value">"1"</span>&gt;</span>
	<span class="tag">&lt;<span class="title">Url</span>&gt;</span>http://mirage.ipaper.lan/TestAssembly.dll<span class="tag">&lt;/<span class="title">Url</span>&gt;</span>
<span class="tag">&lt;/<span class="title">System.Security.Policy.Url</span>&gt;</span>

<span class="tag">&lt;<span class="title">System.Security.Policy.Site</span> <span class="attribute">version</span>=<span class="value">"1"</span>&gt;</span>
	<span class="tag">&lt;<span class="title">Name</span>&gt;</span>mirage.ipaper.lan<span class="tag">&lt;/<span class="title">Name</span>&gt;</span>
<span class="tag">&lt;/<span class="title">System.Security.Policy.Site</span>&gt;</span>

<span class="tag">&lt;<span class="title">System.Security.Policy.Hash</span> <span class="attribute">version</span>=<span class="value">"1"</span>&gt;</span>
	<span class="tag">&lt;<span class="title">RawData</span>&gt;</span>4D5A900003...00000<span class="tag">&lt;/<span class="title">RawData</span>&gt;</span>
<span class="tag">&lt;/<span class="title">System.Security.Policy.Hash</span>&gt;</span>
</pre></figure>

<p>This time the SecurityZone is defined as Internet. Although my server is placed on my local network, it’s known as the internet by my computer. This time we also get the Site policy since the assembly is loaded from a website, namely mirage.ipaper.lan. The security zone is actually provided by Windows (using the<a href="http://msdn.microsoft.com/en-us/library/ms537133(VS.85" target="_blank">IInternetSecurityManager::MapUrlToZone method</a>.aspx)) and not by the CLR itself, except in the case of locally loaded assemblies - in which it’ll automatically set the zone to MyComputer. Thus, if I add mirage.ipaper.lan to my Internet Options control panel Intranet sites list, my SecurityZone changes to Intranet instead of Internet. Likewise I can add it to my trusted &amp; untrusted sites list and modify the resulting SecurityZone.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jun</span>
			<span class="day">02</span>
		</div>
		<div class="lower">2008</div>
	</div>

	<div class="title">
		<h1><a href="/using-idispoable-to-write-indented-text/" title="Using IDisposable to Write Indented Text" rel="bookmark">Using IDisposable to Write Indented Text</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I often need to output indented text in one way of the other, it could be HTML, XML, source code etc (please look beyond the actual problem domain - I’d enver write XML this way, it’s just an example). Usually that involved me writing tab characters manually (or by calling a function that returned the current indentation string), cluttering the actual output. An example might look like this:</p>
<a id="more"></a>


<figure class="highlight cs"><pre>StringBuilder sb = <span class="keyword">new</span> StringBuilder();
sb.AppendLine(<span class="string">"public static void Hello()"</span>);
sb.AppendLine(<span class="string">"{"</span>);
sb.AppendLine(<span class="string">"\tif(true)"</span>);
sb.AppendLine(<span class="string">"\t\tConsole.WriteLine("</span>World!<span class="string">");"</span>);
sb.AppendLine(<span class="string">"}"</span>);

Console.Write(sb.ToString());
Console.Read();
</pre></figure>

<p>This ought to result in the following snippet:</p>
<figure class="highlight cs"><pre><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Hello</span>()
{
	<span class="keyword">if</span>(<span class="keyword">true</span>)
		Console.WriteLine(<span class="string">"World!"</span>);
}
</pre></figure>

<p>Pretty simple code, but it’s a bit hard for the eyes, especially if there’s a lot of it.</p>
<p>By utilizing the IDisposable interface, we can create a StringBuilder-esque class that handles the indentation for us. Here’s an example of how we might write the previous snippet using the IndentedStringBuilder (note that it’s not really a StringBuilder since StringBuilder’s a sealed class):</p>
<figure class="highlight cs"><pre><span class="keyword">using</span> (IndentedStringBuilder sb = <span class="keyword">new</span> IndentedStringBuilder())
{
	sb.AppendLine(<span class="string">"public static void Hello()"</span>);
	sb.AppendLine(<span class="string">"{"</span>);

	<span class="keyword">using</span> (sb.IncreaseIndent())
	{
		sb.AppendLine(<span class="string">"if(true)"</span>);

		<span class="keyword">using</span> (sb.IncreaseIndent())
			sb.AppendLine(<span class="string">"Console.WriteLine("</span>World!<span class="string">");"</span>);
	}

	sb.AppendLine(<span class="string">"}"</span>);

	Console.Write(sb.ToString());
	Console.Read();
}
</pre></figure>

<p>Each time Dispose() is called on the instance, the indentation level is decreased. Calling IncreaseIndent() increases the indentation level, as well as returning a reference to the IndentedStringBuilder instance itself. The using construct will make sure Dispose is called on the reference each time we exit the using block - and calling Dispose does not do anything to the object other than calling the Dispose method - which’ll decrease the indentation level.</p>
<p>Here’s the IndentedStringBuilder class:</p>
<figure class="highlight cs"><pre><span class="keyword">using</span> System;
<span class="keyword">using</span> System.Text;

namespace Improve.Framework.Text
{
	<span class="keyword">public</span> <span class="keyword">class</span> IndentedStringBuilder : IDisposable
	{
		<span class="keyword">private</span> StringBuilder sb;
		<span class="keyword">private</span> <span class="keyword">string</span> indentationString = <span class="string">"\t"</span>;
		<span class="keyword">private</span> <span class="keyword">string</span> completeIndentationString = <span class="string">""</span>;
		<span class="keyword">private</span> <span class="keyword">int</span> indent = <span class="number">0</span>;

		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span>  Creates an IndentedStringBuilder</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		<span class="keyword">public</span> <span class="title">IndentedStringBuilder</span>()
		{
			sb = <span class="keyword">new</span> StringBuilder();
		}

		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> Appends a string</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="value"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Append</span>(<span class="keyword">string</span> <span class="keyword">value</span>)
		{
			sb.Append(completeIndentationString + <span class="keyword">value</span>);
		}

		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> Appends a line</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="value"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AppendLine</span>(<span class="keyword">string</span> <span class="keyword">value</span>)
		{
			Append(<span class="keyword">value</span> + Environment.NewLine);
		}

		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> The string/chars to use for indentation, t by default</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		<span class="keyword">public</span> <span class="keyword">string</span> IndentationString
		{
			<span class="keyword">get</span> { <span class="keyword">return</span> indentationString; }
			<span class="keyword">set</span>
			{
				indentationString = <span class="keyword">value</span>;

				updateCompleteIndentationString();
			}
		}

		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> Creates the actual indentation string</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		<span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateCompleteIndentationString</span>()
		{
			completeIndentationString = <span class="string">""</span>;

			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; indent; i++)
				completeIndentationString += indentationString;
		}

		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> Increases indentation, returns a reference to an IndentedStringBuilder instance which is only to be used for disposal</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span>
		<span class="keyword">public</span> IndentedStringBuilder <span class="title">IncreaseIndent</span>()
		{
			indent++;

			updateCompleteIndentationString();

			<span class="keyword">return</span> <span class="keyword">this</span>;
		}

		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> Decreases indentation, may only be called if indentation &gt; 1</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DecreaseIndent</span>()
		{
			<span class="keyword">if</span> (indent &gt; <span class="number">0</span>)
			{
				indent--;

				updateCompleteIndentationString();
			}
		}

		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> Decreases indentation</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>()
		{
			DecreaseIndent();
		}

		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> Returns the text of the internal StringBuilder</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span>
		<span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">string</span> <span class="title">ToString</span>()
		{
			<span class="keyword">return</span> sb.ToString();
		}
	}
}
</pre></figure>



				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">May</span>
			<span class="day">13</span>
		</div>
		<div class="lower">2008</div>
	</div>

	<div class="title">
		<h1><a href="/generic-dijkstras-algorithm/" title="Generic Dijkstra&#39;s Algorithm" rel="bookmark">Generic Dijkstra&#39;s Algorithm</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Through various projects, I’ve had to do some shortest-path finding in a connected graph. An efficient and straight-forward way to do this is using <a href="http://en.wikipedia.org/wiki/Dijkstra&#39;s_algorithm" target="_blank">Dijkstra’s Algorithm</a>. Notice that it’ll only work for graphs with non negative path weights, like 2D maps for instance. While I’ve used the algorithm on several occasions, it’s only now that I’ve rewritten it in generic form</p>
<a id="more"></a>

<p>The code is pretty much self explanatory if you keep the <a href="http://en.wikipedia.org/wiki/Dijkstra&#39;s_algorithm#Pseudocode" target="_blank">pseudo code implementation</a> next to it.</p>
<figure class="highlight cs"><pre><span class="keyword">using</span> System;
<span class="keyword">using</span> System.Collections.Generic;
<span class="keyword">using</span> System.Linq;

namespace Improve.Framework.Algorithms
{
	<span class="keyword">public</span> <span class="keyword">class</span> Dijkstra&lt;TNode&gt;
	{
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> Calculates the shortest route from a source node to a target node given a set of nodes and connections. Will only work for graphs with non-negative path weights.</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="connections"&gt;</span>All the nodes, as well as the list of their connections.<span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="sourceNode"&gt;</span>The node to start from.<span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="targetNode"&gt;</span>The node we should seek.<span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="fnEquals"&gt;</span>A function used for testing if two nodes are equal.<span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="fnDistance"&gt;</span>A function used for calculating the distance/weight between two nodes.<span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>An ordered list of nodes from source-&gt;target giving the shortest path from the source to the target node. Returns null if no path is possible.<span class="xmlDocTag">&lt;/returns&gt;</span></span>
		<span class="keyword">public</span> <span class="keyword">static</span> List&lt;TNode&gt; <span class="title">ShortestPath</span>(IDictionary&lt;TNode, List&lt;TNode&gt;&gt; connections, TNode sourceNode, TNode targetNode, Func&lt;TNode, TNode, <span class="keyword">bool</span>&gt; fnEquals, Func&lt;TNode, TNode, <span class="keyword">double</span>&gt; fnDistance)
		{
			<span class="comment">// Initialize values</span>
			Dictionary&lt;TNode, <span class="keyword">double</span>&gt; distance = <span class="keyword">new</span> Dictionary&lt;TNode, <span class="keyword">double</span>&gt;(); ;
			Dictionary&lt;TNode, TNode&gt; previous = <span class="keyword">new</span> Dictionary&lt;TNode, TNode&gt;(); ;
			List&lt;TNode&gt; localNodes = <span class="keyword">new</span> List&lt;TNode&gt;();

			<span class="comment">// For all nodes, copy it to our local list as well as set it's distance to null as it's unknown</span>
			<span class="keyword">foreach</span> (TNode node <span class="keyword">in</span> connections.Keys)
			{
				localNodes.Add(node);
				distance.Add(node, <span class="keyword">double</span>.PositiveInfinity);
			}

			<span class="comment">// We know the distance from source-&gt;source is 0 by definition</span>
			distance[sourceNode] = <span class="number">0</span>;

			<span class="keyword">while</span> (localNodes.Count &gt; <span class="number">0</span>)
			{
				<span class="comment">// Return and remove best vertex (that is, connection with minimum distance</span>
				TNode minNode = localNodes.OrderBy(n =&gt; distance[n]).First();
				localNodes.Remove(minNode);

				<span class="comment">// Loop all connected nodes</span>
				<span class="keyword">foreach</span> (TNode neighbor <span class="keyword">in</span> connections[minNode])
				{
					<span class="comment">// The positive distance between node and it's neighbor, added to the distance of the current node</span>
					<span class="keyword">double</span> dist = distance[minNode] + fnDistance(minNode, neighbor);

					<span class="keyword">if</span> (dist &lt; distance[neighbor])
					{
						distance[neighbor] = dist;
						previous[neighbor] = minNode;
					}
				}

				<span class="comment">// If we're at the target node, break</span>
				<span class="keyword">if</span> (fnEquals(minNode, targetNode))
					<span class="keyword">break</span>;
			}

			<span class="comment">// Construct a list containing the complete path. We'll start by looking at the previous node of the target and then making our way to the beginning.</span>
			<span class="comment">// We'll reverse it to get a source-&gt;target list instead of the other way around. The source node is manually added.</span>
			List&lt;TNode&gt; result = <span class="keyword">new</span> List&lt;TNode&gt;();
			TNode target = targetNode;
			<span class="keyword">while</span> (previous.ContainsKey(target))
			{
				result.Add(target);
				target = previous[target];
			}
			result.Add(sourceNode);
			result.Reverse();

			<span class="keyword">if</span> (result.Count &gt; <span class="number">1</span>)
				<span class="keyword">return</span> result;
			<span class="keyword">else</span>
				<span class="keyword">return</span> <span class="keyword">null</span>;
		}
	}
}
</pre></figure>

<p>Once we’ve made the list of nodes &amp; connections, invoking the algorithm is rather simple. We just need to provide an equality function as well as a distance function:</p>
<figure class="highlight cs"><pre><span class="comment">// Run Dijkstra's algorithm</span>
List&lt;Point2D&gt; result = Dijkstra&lt;Point2D&gt;.ShortestPath(connections, mouse, target, (p1, p2) =&gt; p1 == p2, (p1, p2) =&gt; p1.DistanceTo(p2));
</pre></figure>

<div class="video-container"><iframe src="//www.youtube.com/embed/ctEXUmZ5TDY" frameborder="0" allowfullscreen></iframe></div>



<h2 id="Downloads">Downloads</h2>
<p><a href="Shortest_Path.zip">Shortest_Path.zip - Sample code</a></p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">May</span>
			<span class="day">08</span>
		</div>
		<div class="lower">2008</div>
	</div>

	<div class="title">
		<h1><a href="/book-programmers-at-work/" title="Programmers at Work" rel="bookmark">Programmers at Work</a></h1>
		<div class="categories">
			
				<a href="/category/Miscellaneous/">Miscellaneous</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I just finished reading the book <a href="http://www.amazon.com/Programmers-Work-Interviews-Computer-Industry/dp/1556152116" target="_blank">Programmers at Work</a> by Susan Lammers.</p>
<a id="more"></a>

<div class="imgwrapper" style=""><div><a href="/book-programmers-at-work/programmersatwork_2.jpg" class="fancy"><img src="/book-programmers-at-work/programmersatwork_2.jpg" style="max-height: 250px"/></a></div></div>

<p>It’s a unique book unlike most others I’ve read. Most of the books I read are practically oriented, how to do this, how to do that (in an abstract way, but still practical).</p>
<p>Programmers at Work contains interviews with 19 of the most influential computer programmers, written in the early 80’s. It’s an eye opener how similar the though processes, scenarios and development ideas where back then to what we’re used to today. They didn’t have nearly the same facilities at hand, neither hardware nor codewise, but the goals were the same. It’s fun to read some fundamental discussions about whether OS’s have a place at all, or whether they should simply be discarded (I guess that’d be the embedded devices of today).</p>
<p>While all interviewees are techy guys in one way or the other, there’s great diversity among them. Some are downright developers/architects while others work on the UI, graphics and even audio design.</p>
<p>There are lots of great war stories in most interviews, 40% of them about Apple - it really becomes clear how big a part Apple played back then, and how small they became for a period which seems to be nearing an end.</p>
<p>Leonard Richardson has a great writeup on <a href="http://www.crummy.com/2008/02/17/0" target="_blank">where the original interviewees are at today</a>.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">May</span>
			<span class="day">02</span>
		</div>
		<div class="lower">2008</div>
	</div>

	<div class="title">
		<h1><a href="/mapping-datareader-to-objects-using-reflection-emit/" title="Mapping Datareader to Objects Using Reflection.Emit" rel="bookmark">Mapping Datareader to Objects Using Reflection.Emit</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I’ve previously written of how to automatically <a href="/automatically-mapping-datatable-to-objects/">map a DataTable into a strongly typed collection of objects</a>. There’s a problem though, <a href="/performance-comparison-reading-data-from-the-database-strongly-typed/">it’s not fast</a>… I wanted to improve on it, and this is what I ended up with.</p>
<a id="more"></a>

<p>The original method relied heavily on reflection to set the values directly. Reflection’s bad in regards of speed, mkay? But reflection is not necessarily evil, you can do great good with it. Now, the problem with the original method is that each field is set using reflection for each row, that’s [number of fields] * [number of rows] fields being set using reflection, resulting in pretty poor performance. If we compare it to the <a href="/performance-comparison-reading-data-from-the-database-strongly-typed/">manual way</a>, there’s obviously some kind of a gap. If we could just somehow, in a generic way, create mapper methods like we do manually…</p>
<p>We’ll have to create a DynamicMethod that takes in a DbDataReader, converts the current row to a generic type T. We’ll call it MapDR, although it doesn’t really matter what it’s called.</p>
<figure class="highlight cs"><pre><span class="comment">// Our method will take in a single parameter, a DbDataReader</span>
Type[] methodArgs = { <span class="keyword">typeof</span>(DbDataReader) };

<span class="comment">// The MapDR method will map a DbDataReader row to an instance of type T</span>
DynamicMethod dm = <span class="keyword">new</span> DynamicMethod(<span class="string">"MapDR"</span>, <span class="keyword">typeof</span>(T), methodArgs, Assembly.GetExecutingAssembly().GetType().Module);
ILGenerator il = dm.GetILGenerator();
</pre></figure>

<p>In this method, we’ll create an instance of the generic type T and store it as a variable.</p>
<figure class="highlight cs"><pre><span class="comment">// We'll have a single local variable, the instance of T we're mapping</span>
il.DeclareLocal(<span class="keyword">typeof</span>(T));

<span class="comment">// Create a new instance of T and save it as variable 0</span>
il.Emit(OpCodes.Newobj, <span class="keyword">typeof</span>(T).GetConstructor(Type.EmptyTypes));
il.Emit(OpCodes.Stloc_0);
</pre></figure>

<p>Then we’ll look each property of the type.</p>
<figure class="highlight cs"><pre><span class="keyword">foreach</span> (PropertyInfo pi <span class="keyword">in</span> <span class="keyword">typeof</span>(T).GetProperties())
</pre></figure>

<p>Now we’ll read the column value from the DbDataReader using the properties name. By reading it, we’re pushing it onto the stack.</p>
<figure class="highlight cs"><pre><span class="comment">// Load the T instance, SqlDataReader parameter and the field name onto the stack</span>
il.Emit(OpCodes.Ldloc_0);
il.Emit(OpCodes.Ldarg_0);
il.Emit(OpCodes.Ldstr, pi.Name);

<span class="comment">// Push the column value onto the stack</span>
il.Emit(OpCodes.Callvirt, <span class="keyword">typeof</span>(DbDataReader).GetMethod(<span class="string">"get_Item"</span>, <span class="keyword">new</span> Type[] { <span class="keyword">typeof</span>(<span class="keyword">string</span>) }));
</pre></figure>

<p>Now’s the ugly part. Depending on the type, there are different ways to convert it into the corresponding .NET type, i’ve made a switch statement handling most common types, although it does lack support for nullable types, guids and various other numeric formats. It should show to idea though. Converting the value will push the resulting correctly typed value onto the stack, and pop the original value in the process.</p>
<figure class="highlight cs"><pre><span class="comment">// Depending on the type of the property, convert the datareader column value to the type</span>
<span class="keyword">switch</span> (pi.PropertyType.Name)
{
	<span class="keyword">case</span> <span class="string">"Int16"</span>:
		il.Emit(OpCodes.Call, <span class="keyword">typeof</span>(Convert).GetMethod(<span class="string">"ToInt16"</span>, <span class="keyword">new</span> Type[] { <span class="keyword">typeof</span>(<span class="keyword">object</span>) }));
		<span class="keyword">break</span>;
	<span class="keyword">case</span> <span class="string">"Int32"</span>:
		il.Emit(OpCodes.Call, <span class="keyword">typeof</span>(Convert).GetMethod(<span class="string">"ToInt32"</span>, <span class="keyword">new</span> Type[] { <span class="keyword">typeof</span>(<span class="keyword">object</span>) }));
		<span class="keyword">break</span>;
	<span class="keyword">case</span> <span class="string">"Int64"</span>:
		il.Emit(OpCodes.Call, <span class="keyword">typeof</span>(Convert).GetMethod(<span class="string">"ToInt64"</span>, <span class="keyword">new</span> Type[] { <span class="keyword">typeof</span>(<span class="keyword">object</span>) }));
		<span class="keyword">break</span>;
	<span class="keyword">case</span> <span class="string">"Boolean"</span>:
		il.Emit(OpCodes.Call, <span class="keyword">typeof</span>(Convert).GetMethod(<span class="string">"ToBoolean"</span>, <span class="keyword">new</span> Type[] { <span class="keyword">typeof</span>(<span class="keyword">object</span>) }));
		<span class="keyword">break</span>;
	<span class="keyword">case</span> <span class="string">"String"</span>:
		il.Emit(OpCodes.Callvirt, <span class="keyword">typeof</span>(<span class="keyword">string</span>).GetMethod(<span class="string">"ToString"</span>, <span class="keyword">new</span> Type[] { }));
		<span class="keyword">break</span>;
	<span class="keyword">case</span> <span class="string">"DateTime"</span>:
		il.Emit(OpCodes.Call, <span class="keyword">typeof</span>(Convert).GetMethod(<span class="string">"ToDateTime"</span>, <span class="keyword">new</span> Type[] { <span class="keyword">typeof</span>(<span class="keyword">object</span>) }));
		<span class="keyword">break</span>;
	<span class="keyword">case</span> <span class="string">"Decimal"</span>:
		il.Emit(OpCodes.Call, <span class="keyword">typeof</span>(Convert).GetMethod(<span class="string">"ToDecimal"</span>, <span class="keyword">new</span> Type[] { <span class="keyword">typeof</span>(<span class="keyword">object</span>) }));
		<span class="keyword">break</span>;
	<span class="keyword">default</span>:
		<span class="comment">// Don't set the field value as it's an unsupported type</span>
		<span class="keyword">continue</span>;
}
</pre></figure>

<p>And finally we set the properties value, thereby popping the value from the stack.</p>
<figure class="highlight cs"><pre><span class="comment">// Set the T instances property value</span>
il.Emit(OpCodes.Callvirt, <span class="keyword">typeof</span>(T).GetMethod(<span class="string">"set_"</span> + pi.Name, <span class="keyword">new</span> Type[] { pi.PropertyType }));
</pre></figure>

<p>After we’ve mapped all the properties, we’ll load the T instance onto the stack and return it.</p>
<figure class="highlight cs"><pre><span class="comment">// Load the T instance onto the stack</span>
il.Emit(OpCodes.Ldloc_0);

<span class="comment">// Return</span>
il.Emit(OpCodes.Ret);
</pre></figure>

<p>To improve performance, let’s cache this mapper method as it’ll work for the type T the next time we need it. Notice that what we’re caching is not the method itself, but a delegate to the method - enabling us to actually call the method.</p>
<figure class="highlight cs"><pre><span class="keyword">private</span> <span class="keyword">delegate</span> T mapEntity&lt;T&gt;(DbDataReader dr);
<span class="keyword">private</span> <span class="keyword">static</span> Dictionary&lt;Type, Delegate&gt; cachedMappers = <span class="keyword">new</span> Dictionary&lt;Type, Delegate&gt;();

<span class="comment">// Cache the method so we won't have to create it again for the type T</span>
cachedMappers.Add(<span class="keyword">typeof</span>(T), dm.CreateDelegate(<span class="keyword">typeof</span>(mapEntity&lt;T&gt;)));

<span class="comment">// Get a delegate reference to the dynamic method</span>
mapEntity&lt;T&gt; invokeMapEntity = (mapEntity&lt;T&gt;)cachedMappers[<span class="keyword">typeof</span>(T)];
</pre></figure>

<p>Now all we gotta do is loop the DbDataReader rows and return the mapped entities.</p>
<figure class="highlight cs"><pre><span class="comment">// For each row, map the row to an instance of T and yield return it</span>
<span class="keyword">while</span> (dr.Read())
	<span class="keyword">yield</span> <span class="keyword">return</span> invokeMapEntity(dr);
</pre></figure>

<p>And of course, here’s the final method/class. Remember that this is more a proof of concept than a complete class. It ought to handle all necessary types. Also, it might be relevant to consider whether one should map public as well as private properties. Whether it should handle type validation errors, missing columns or not, I’m not sure. As it is now, it’ll throw a normal ArgumentOutOfRangeException in cases of missing columns, and relevant type conversion errors - all those can be handled by the callee using try/catch blocks.</p>
<figure class="highlight cs"><pre><span class="keyword">using</span> System;
<span class="keyword">using</span> System.Collections.Generic;
<span class="keyword">using</span> System.Data.Common;
<span class="keyword">using</span> System.Reflection;
<span class="keyword">using</span> System.Reflection.Emit;

namespace Improve.Framework.Data
{
	<span class="keyword">public</span> <span class="keyword">class</span> EntityMapper
	{
		<span class="keyword">private</span> <span class="keyword">delegate</span> T mapEntity&lt;T&gt;(DbDataReader dr);
		<span class="keyword">private</span> <span class="keyword">static</span> Dictionary&lt;Type, Delegate&gt; cachedMappers = <span class="keyword">new</span> Dictionary&lt;Type, Delegate&gt;();

		<span class="keyword">public</span> <span class="keyword">static</span> IEnumerable&lt;T&gt; MapToEntities&lt;T&gt;(DbDataReader dr)
		{
			<span class="comment">// If a mapping function from dr -&gt; T does not exist, create and cache one</span>
			<span class="keyword">if</span> (!cachedMappers.ContainsKey(<span class="keyword">typeof</span>(T)))
			{
				<span class="comment">// Our method will take in a single parameter, a DbDataReader</span>
				Type[] methodArgs = { <span class="keyword">typeof</span>(DbDataReader) };

				<span class="comment">// The MapDR method will map a DbDataReader row to an instance of type T</span>
				DynamicMethod dm = <span class="keyword">new</span> DynamicMethod(<span class="string">"MapDR"</span>, <span class="keyword">typeof</span>(T), methodArgs, Assembly.GetExecutingAssembly().GetType().Module);
				ILGenerator il = dm.GetILGenerator();
				
				<span class="comment">// We'll have a single local variable, the instance of T we're mapping</span>
				il.DeclareLocal(<span class="keyword">typeof</span>(T));

				<span class="comment">// Create a new instance of T and save it as variable 0</span>
				il.Emit(OpCodes.Newobj, <span class="keyword">typeof</span>(T).GetConstructor(Type.EmptyTypes));
				il.Emit(OpCodes.Stloc_0);

				<span class="keyword">foreach</span> (PropertyInfo pi <span class="keyword">in</span> <span class="keyword">typeof</span>(T).GetProperties())
				{
					<span class="comment">// Load the T instance, SqlDataReader parameter and the field name onto the stack</span>
					il.Emit(OpCodes.Ldloc_0);
					il.Emit(OpCodes.Ldarg_0);
					il.Emit(OpCodes.Ldstr, pi.Name);

					<span class="comment">// Push the column value onto the stack</span>
					il.Emit(OpCodes.Callvirt, <span class="keyword">typeof</span>(DbDataReader).GetMethod(<span class="string">"get_Item"</span>, <span class="keyword">new</span> Type[] { <span class="keyword">typeof</span>(<span class="keyword">string</span>) }));

					<span class="comment">// Depending on the type of the property, convert the datareader column value to the type</span>
					<span class="keyword">switch</span> (pi.PropertyType.Name)
					{
						<span class="keyword">case</span> <span class="string">"Int16"</span>:
							il.Emit(OpCodes.Call, <span class="keyword">typeof</span>(Convert).GetMethod(<span class="string">"ToInt16"</span>, <span class="keyword">new</span> Type[] { <span class="keyword">typeof</span>(<span class="keyword">object</span>) }));
							<span class="keyword">break</span>;
						<span class="keyword">case</span> <span class="string">"Int32"</span>:
							il.Emit(OpCodes.Call, <span class="keyword">typeof</span>(Convert).GetMethod(<span class="string">"ToInt32"</span>, <span class="keyword">new</span> Type[] { <span class="keyword">typeof</span>(<span class="keyword">object</span>) }));
							<span class="keyword">break</span>;
						<span class="keyword">case</span> <span class="string">"Int64"</span>:
							il.Emit(OpCodes.Call, <span class="keyword">typeof</span>(Convert).GetMethod(<span class="string">"ToInt64"</span>, <span class="keyword">new</span> Type[] { <span class="keyword">typeof</span>(<span class="keyword">object</span>) }));
							<span class="keyword">break</span>;
						<span class="keyword">case</span> <span class="string">"Boolean"</span>:
							il.Emit(OpCodes.Call, <span class="keyword">typeof</span>(Convert).GetMethod(<span class="string">"ToBoolean"</span>, <span class="keyword">new</span> Type[] { <span class="keyword">typeof</span>(<span class="keyword">object</span>) }));
							<span class="keyword">break</span>;
						<span class="keyword">case</span> <span class="string">"String"</span>:
							il.Emit(OpCodes.Callvirt, <span class="keyword">typeof</span>(<span class="keyword">string</span>).GetMethod(<span class="string">"ToString"</span>, <span class="keyword">new</span> Type[] { }));
							<span class="keyword">break</span>;
						<span class="keyword">case</span> <span class="string">"DateTime"</span>:
							il.Emit(OpCodes.Call, <span class="keyword">typeof</span>(Convert).GetMethod(<span class="string">"ToDateTime"</span>, <span class="keyword">new</span> Type[] { <span class="keyword">typeof</span>(<span class="keyword">object</span>) }));
							<span class="keyword">break</span>;
						<span class="keyword">case</span> <span class="string">"Decimal"</span>:
							il.Emit(OpCodes.Call, <span class="keyword">typeof</span>(Convert).GetMethod(<span class="string">"ToDecimal"</span>, <span class="keyword">new</span> Type[] { <span class="keyword">typeof</span>(<span class="keyword">object</span>) }));
							<span class="keyword">break</span>;
						<span class="keyword">default</span>:
							<span class="comment">// Don't set the field value as it's an unsupported type</span>
							<span class="keyword">continue</span>;
					}

					<span class="comment">// Set the T instances property value</span>
					il.Emit(OpCodes.Callvirt, <span class="keyword">typeof</span>(T).GetMethod(<span class="string">"set_"</span> + pi.Name, <span class="keyword">new</span> Type[] { pi.PropertyType }));
				}

				<span class="comment">// Load the T instance onto the stack</span>
				il.Emit(OpCodes.Ldloc_0);

				<span class="comment">// Return</span>
				il.Emit(OpCodes.Ret);
				
				<span class="comment">// Cache the method so we won't have to create it again for the type T</span>
				cachedMappers.Add(<span class="keyword">typeof</span>(T), dm.CreateDelegate(<span class="keyword">typeof</span>(mapEntity&lt;T&gt;)));
			}

			<span class="comment">// Get a delegate reference to the dynamic method</span>
			mapEntity&lt;T&gt; invokeMapEntity = (mapEntity&lt;T&gt;)cachedMappers[<span class="keyword">typeof</span>(T)];
			
			<span class="comment">// For each row, map the row to an instance of T and yield return it</span>
			<span class="keyword">while</span> (dr.Read())
				<span class="keyword">yield</span> <span class="keyword">return</span> invokeMapEntity(dr);
		}

		<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ClearCachedMapperMethods</span>()
		{
			cachedMappers.Clear();
		}
	}
}
</pre></figure>



				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Apr</span>
			<span class="day">30</span>
		</div>
		<div class="lower">2008</div>
	</div>

	<div class="title">
		<h1><a href="/performance-comparison-reading-data-from-the-database-strongly-typed/" title="Performance Comparison - Reading Data From the Database Strongly Typed" rel="bookmark">Performance Comparison - Reading Data From the Database Strongly Typed</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I’m a big fan of strongly typed database querying as well as returning strong typed results. Due to the nature of static languages, you’ll get compile time checking of all our tables and columns. You can easily rename columns as you can be sure all your (internal) references are accounted for.</p>
<a id="more"></a>

<p>Returning strongly typed lists of objects instead of DataReaders/DataTables / any other object based containers will also make it easier to transfer through data layers as you’re always certain of what’s available for you to read and what’s not.</p>
<p>But it comes at a cost. Performance.</p>
<p>I set out to test various different ways we could query our database and generate a strongly typed List with the results in it. I’m using the <a href="http://codeplex.com/SqlServerSamples" target="_blank">standard AdventureWorks 2005 database</a> for my testing. For the actual profiling, I’ll be using <a href="/profiling-code-the-easy-way/">my CodeProfiler class</a> from a previous blogpost.</p>
<p>I’ll be using two different entities, Product and CompleteProduct:</p>
<figure class="highlight cs"><pre>[Table(Name = <span class="string">"Production.Product"</span>)]
<span class="keyword">public</span> <span class="keyword">class</span> Product
{
	[Column]
	<span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">int</span> ProductID { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">string</span> Name { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">string</span> ProductNumber { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">bool</span> MakeFlag { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">short</span> SafetyStockLevel { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">decimal</span> ListPrice { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">virtual</span> DateTime SellStartDate { <span class="keyword">get</span>; <span class="keyword">set</span>; }
}

[Table(Name = <span class="string">"Production.Product"</span>)]
<span class="keyword">public</span> <span class="keyword">class</span> CompleteProduct
{
	[Column]
	<span class="keyword">public</span> <span class="keyword">int</span> ProductID { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">string</span> Name { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">string</span> ProductNumber { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">bool</span> MakeFlag { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">bool</span> FinishedGoodsFlag { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">string</span> Color { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">short</span> SafetyStockLevel { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">short</span> ReorderPoint { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">decimal</span> StandardCost { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">decimal</span> ListPrice { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">string</span> Size { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">string</span> SizeUnitMeasureCode { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">string</span> WeightUnitMeasureCode { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">decimal</span>? Weight { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">int</span> DaysToManufacture { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">string</span> ProductLine { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">string</span> Class { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">string</span> Style { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">int</span>? ProductSubcategoryID { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">int</span>? ProductModelID { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> DateTime SellStartDate { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> DateTime? SellEndDate { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> DateTime? DiscontinuedDate { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> Guid rowguid { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> DateTime ModifiedDate { <span class="keyword">get</span>; <span class="keyword">set</span>; }
}
</pre></figure>

<p>They both map to the same table, Production.Product. CompleteProduct covers all columns, Product just covers the ones I’m interested in.</p>
<h2 id="Method_#1_-_Manually_mapping_from_DataReader">Method #1 - Manually mapping from DataReader</h2>
<figure class="highlight cs"><pre><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">performDataReader</span>()
{
	<span class="keyword">var</span> result = <span class="keyword">new</span> List&lt;Product&gt;();

	<span class="keyword">using</span> (SqlConnection conn = <span class="keyword">new</span> SqlConnection(CONNECTION_STRING))
	{
		<span class="keyword">using</span> (SqlCommand cmd = conn.CreateCommand())
		{
			cmd.CommandText = COMMAND_TEXT;

			conn.Open();
			<span class="keyword">using</span> (SqlDataReader sqldr = cmd.ExecuteReader())
			{
				<span class="keyword">while</span> (sqldr.Read())
				{
					Product p = <span class="keyword">new</span> Product();
					p.ProductID = Convert.ToInt32(sqldr[<span class="string">"ProductID"</span>]);
					p.Name = sqldr[<span class="string">"Name"</span>].ToString();
					p.ProductNumber = sqldr[<span class="string">"ProductNumber"</span>].ToString();
					p.MakeFlag = Convert.ToBoolean(sqldr[<span class="string">"MakeFlag"</span>]);
					p.SafetyStockLevel = Convert.ToInt16(sqldr[<span class="string">"SafetyStockLevel"</span>]);
					p.ListPrice = Convert.ToDecimal(sqldr[<span class="string">"ListPrice"</span>]);
					p.SellStartDate = Convert.ToDateTime(sqldr[<span class="string">"SellStartDate"</span>]);

					result.Add(p);
				}
			}
		}
	}
}
</pre></figure>

<p>Pros: <em>Fast</em></p>
<p>Cons: <em>Has to be written for each object model</em></p>
<h2 id="Method_#2_-_Manully_mapping_from_DataTable">Method #2 - Manully mapping from DataTable</h2>
<figure class="highlight cs"><pre><span class="keyword">private</span> <span class="keyword">static</span> DataTable <span class="title">getDT</span>()
{
	DataTable result = <span class="keyword">new</span> DataTable();

	<span class="keyword">using</span> (SqlConnection conn = <span class="keyword">new</span> SqlConnection(CONNECTION_STRING))
	{
		<span class="keyword">using</span> (SqlCommand cmd = conn.CreateCommand())
		{
			cmd.CommandText = COMMAND_TEXT;

			<span class="keyword">using</span> (SqlDataAdapter sqlda = <span class="keyword">new</span> SqlDataAdapter(cmd))
				sqlda.Fill(result);
		}
	}

	<span class="keyword">return</span> result;
}

<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">performDataTable</span>()
{
	<span class="keyword">var</span> result = <span class="keyword">new</span> List&lt;Product&gt;();

	<span class="keyword">foreach</span> (DataRow dr <span class="keyword">in</span> getDT().Rows)
	{
		Product p = <span class="keyword">new</span> Product();
		p.ProductID = Convert.ToInt32(dr[<span class="string">"ProductID"</span>]);
		p.Name = dr[<span class="string">"Name"</span>].ToString();
		p.ProductNumber = dr[<span class="string">"ProductNumber"</span>].ToString();
		p.MakeFlag = Convert.ToBoolean(dr[<span class="string">"MakeFlag"</span>]);
		p.SafetyStockLevel = Convert.ToInt16(dr[<span class="string">"SafetyStockLevel"</span>]);
		p.ListPrice = Convert.ToDecimal(dr[<span class="string">"ListPrice"</span>]);
		p.SellStartDate = Convert.ToDateTime(dr[<span class="string">"SellStartDate"</span>]);

		result.Add(p);
	}
}
</pre></figure>

<p>Pros: <em>Pretty fast, easy row access, disconnected from database</em></p>
<p>Cons: <em>Has to be written for each object model</em></p>
<p>Comment: <em>I often use a getDT()’ish way of accessing my tables. It’s easier than using DataReaders as they’re disconnected, you can traverse them back and forth multiple times.</em></p>
<h2 id="Method_#3_-_Automatic_mapping_using_DataContext-Translate">Method #3 - Automatic mapping using DataContext.Translate</h2>
<figure class="highlight cs"><pre><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">performEntityQuery</span>()
{
	List&lt;Product&gt; result;

	<span class="keyword">using</span> (SqlConnection conn = <span class="keyword">new</span> SqlConnection(CONNECTION_STRING))
	{
		<span class="keyword">using</span> (DataContext dc = <span class="keyword">new</span> DataContext(conn))
		{
			<span class="keyword">using</span> (SqlCommand cmd = conn.CreateCommand())
			{
				cmd.CommandText = COMMAND_TEXT;

				conn.Open();
				<span class="keyword">using</span>(SqlDataReader sqldr = cmd.ExecuteReader())
				{
					result = dc.Translate&lt;Product&gt;(sqldr).ToList();
				}
			}
		}
	}
}
</pre></figure>

<p>Pros: <em>Works for all object models, easy to use</em></p>
<p>Cons: <em>Slow</em></p>
<h2 id="Method_#4_-_Linq_to_SQL_query_for_complete_entity">Method #4 - Linq to SQL query for complete entity</h2>
<figure class="highlight cs"><pre><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">performLinqQuery</span>()
{
	List&lt;Product&gt; result;

	<span class="keyword">using</span>(DataContext dc = <span class="keyword">new</span> DataContext(CONNECTION_STRING))
	{
		result = dc.GetTable&lt;Product&gt;().OrderBy(p =&gt; p.ProductID).Take(rowcount).ToList();
	}
}
</pre></figure>

<p>Pros: <em>Could it be easier? Works for all object models</em></p>
<p>Cons: <em>Slow</em></p>
<h2 id="Method_#5_-_Linq_to_SQL_query_for_partial_entity">Method #5 - Linq to SQL query for partial entity</h2>
<figure class="highlight cs"><pre><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">performSubsetLinqQuery</span>()
{
	List&lt;Product&gt; result;

	<span class="keyword">using</span> (DataContext dc = <span class="keyword">new</span> DataContext(CONNECTION_STRING))
	{
		result = dc.GetTable&lt;CompleteProduct&gt;().OrderBy(p =&gt; p.ProductID).Take(rowcount).Select(p =&gt; <span class="keyword">new</span> Product() {
			ListPrice = p.ListPrice,
			ProductID = p.ProductID,
			MakeFlag = p.MakeFlag,
			Name = p.Name,
			ProductNumber = p.ProductNumber,
			SafetyStockLevel = p.SafetyStockLevel,
			SellStartDate = p.SellStartDate }).ToList();
	}
}
</pre></figure>

<p>Pros: <em>Easy, works for all object models</em></p>
<p>Cons: <em>Slow</em></p>
<p>Comments: <em>In the previous method I retrieved complete Product entities. This time I’m retrieving only some columns of the CompleteProduct entity, mapping them over into a new Product. I’ve included this to see if there’s any performance difference in comparison to loading complete entities.</em></p>
<h2 id="Method_#6_-_Automatically_mapping_from_DataReader">Method #6 - Automatically mapping from DataReader</h2>
<figure class="highlight cs"><pre><span class="keyword">private</span> <span class="keyword">static</span> List&lt;T&gt; mapList&lt;T&gt;(SqlDataReader dr)
{
	List&lt;T&gt; list = <span class="keyword">new</span> List&lt;T&gt;();

	PropertyInfo[] properties = <span class="keyword">typeof</span>(T).GetProperties();
	T t = Activator.CreateInstance&lt;T&gt;();

	<span class="keyword">while</span>(dr.Read())
	{
		<span class="keyword">foreach</span> (PropertyInfo pi <span class="keyword">in</span> properties)
			pi.SetValue(t, dr[pi.Name], <span class="keyword">null</span>);

		list.Add(t);
	}

	<span class="keyword">return</span> list;
}

<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">performAutomappedDataReader</span>()
{
	List&lt;Product&gt; result;

	<span class="keyword">using</span> (SqlConnection conn = <span class="keyword">new</span> SqlConnection(CONNECTION_STRING))
	{
		<span class="keyword">using</span> (SqlCommand cmd = conn.CreateCommand())
		{
			cmd.CommandText = COMMAND_TEXT;

			conn.Open();
			<span class="keyword">using</span> (SqlDataReader sqldr = cmd.ExecuteReader())
			{
				result = mapList&lt;Product&gt;(sqldr);
			}
		}
	}
}
</pre></figure>

<p>Pros: <em>Simple to use, works for all object models</em></p>
<p>Cons: <em>Slow, reflection based</em></p>
<h2 id="Method_#7_-_Enhanced_automatic_mapping_from_DataReader">Method #7 - Enhanced automatic mapping from DataReader</h2>
<figure class="highlight cs"><pre><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">performEnhancedAutomappedDataReader</span>()
{
	List&lt;Product&gt; result;

	<span class="keyword">using</span> (SqlConnection conn = <span class="keyword">new</span> SqlConnection(CONNECTION_STRING))
	{
		<span class="keyword">using</span> (SqlCommand cmd = conn.CreateCommand())
		{
			cmd.CommandText = COMMAND_TEXT;

			conn.Open();
			<span class="keyword">using</span> (SqlDataReader sqldr = cmd.ExecuteReader())
			{
				result = EntityMapper.MapToEntities&lt;Product&gt;(sqldr).ToList();
			}
		}
	}
}
</pre></figure>

<p>Pros: <em>???</em></p>
<p>Cons: <em>???</em></p>
<p>Comments: <em>This is an enhanced version of the previous method that I’ve made. Explaining the inner workings is outside the scope of this particular topic so I’ll have to explain it in my next post. For now, just imagine something very cool and sexy. UPDATE: <a href="/mapping-datareader-to-objects-using-reflection-emit/">you can read about the method here</a>.</em></p>
<h2 id="Method_#8_-_SubSonic_SqlQuery">Method #8 - SubSonic SqlQuery</h2>
<figure class="highlight cs"><pre><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">performSubSonicQuery</span>()
{
	List&lt;Product&gt; result =
		<span class="keyword">new</span> Select
			(
				Subsonic.Product.ProductIDColumn.QualifiedName,
				Subsonic.Product.NameColumn.QualifiedName,
				Subsonic.Product.ProductNumberColumn.QualifiedName,
				Subsonic.Product.MakeFlagColumn.QualifiedName,
				Subsonic.Product.SafetyStockLevelColumn.QualifiedName,
				Subsonic.Product.ListPriceColumn.QualifiedName,
				Subsonic.Product.SellStartDateColumn.QualifiedName
			)
			.Top(rowcount.ToString())
			.From(Subsonic.Product.Schema)
			.OrderAsc(Subsonic.Product.ProductIDColumn.QualifiedName)
			.ExecuteTypedList&lt;Product&gt;();
}
</pre></figure>

<p>Pros: <em>Works for all object models</em></p>
<p>Cons: <em>Slow</em></p>
<p>Comments: <em>I’ve never used SubSonic before, so I may have overlooked some obvious performance enhancements, thus, take my numbers with a grain of salt.</em></p>
<h2 id="Method_#9_-_NHibernate_CreateCriteria">Method #9 - NHibernate CreateCriteria</h2>
<figure class="highlight cs"><pre><span class="keyword">private</span> <span class="keyword">static</span> Configuration nhCfg;
<span class="keyword">private</span> <span class="keyword">static</span> ISessionFactory nhFactory;

<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">performNHibernateQuery</span>()
{
	List&lt;Product&gt; result;

	<span class="keyword">using</span> (ISession session = nhFactory.OpenSession())
	{
		result = (List&lt;Product&gt;)session.CreateCriteria(<span class="keyword">typeof</span>(Product)).AddOrder(Order.Asc(<span class="string">"ProductID"</span>)).SetMaxResults(rowcount).List&lt;Product&gt;();
	}
}
</pre></figure>

<p>Pros: <em>Easy, works for all object models, concise querying</em></p>
<p>Cons: <em>Slow</em></p>
<p>Comments: <em>I’ve never used NHibernate before, so I may have overlooked some obvious performance enhancements, thus, take my numbers with a grain of salt.</em></p>
<h2 id="Method_#10_-_Compiled_LinqQuery">Method #10 - Compiled LinqQuery</h2>
<figure class="highlight cs"><pre><span class="keyword">private</span> <span class="keyword">static</span> Func&lt;DataContext, <span class="keyword">int</span>, IEnumerable&lt;Product&gt;&gt; compiledQuery;
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">performCompiledLinqQuery</span>()
{
	List&lt;Product&gt; result;

	<span class="keyword">using</span> (DataContext dc = <span class="keyword">new</span> DataContext(CONNECTION_STRING))
	{
		result = compiledQuery(dc, rowcount).ToList();
	}
}
</pre></figure>

<p>Pros: <em>Among the fastest, no matter the rowcount, works for all object models</em></p>
<p>Cons: <em>Requires a bit more setting up and helper functionality to store the compiled queries</em></p>
<h2 id="The_profiling">The profiling</h2>
<p>I profiled each of the test cases by returning 1, 10, 100, 1.000, 10.000 and 100.000 rows. The numbers are the total execution time of 50 iterations of each method. I’m on a quad core machine so I set the max parallelization degree to three, thus saving myself a core for running SQL Server and Windows.</p>
<figure class="highlight cs"><pre><span class="keyword">static</span> <span class="keyword">void</span> Main(<span class="keyword">string</span>[] args)
{
	<span class="comment">// Make sure we don't get disturbed by other processes</span>
	Process.GetCurrentProcess().PriorityClass = ProcessPriorityClass.High;

	<span class="comment">// We'll let NHibernate cache it's Configuration and SessionFactory as we'd probably do this in most live applications</span>
	nhCfg = <span class="keyword">new</span> Configuration();
	nhCfg.AddAssembly(Assembly.GetExecutingAssembly());
	nhFactory = nhCfg.BuildSessionFactory();

	<span class="keyword">foreach</span>(<span class="keyword">int</span> rc <span class="keyword">in</span> <span class="keyword">new</span> <span class="keyword">int</span>[] { <span class="number">1</span>, <span class="number">10</span>, <span class="number">100</span>, <span class="number">1000</span>, <span class="number">10000</span>, <span class="number">100000</span> })<span class="comment">//, 100, 1000, 10000, 100000 })</span>
	{
		Console.WriteLine(<span class="string">"Rowcount: "</span> + rc);
		rowcount = rc;

		<span class="comment">// Set the rowcount</span>
		COMMAND_TEXT = ORIGINAL_COMMAND_TEXT.Replace(<span class="string">"{rowcount}"</span>, rowcount.ToString());

		<span class="comment">// Make sure the enhanced automapped datareader does not use cached resources from previous run</span>
		EntityMapper.ClearCachedMapperMethods();

		<span class="comment">// Compile the query for the compiled linq query test</span>
		compiledQuery = CompiledQuery.Compile&lt;DataContext, <span class="keyword">int</span>, IEnumerable&lt;Product&gt;&gt;((DataContext dc, <span class="keyword">int</span> takeCount) =&gt; dc.GetTable&lt;Product&gt;().OrderBy(p =&gt; p.ProductID).Take(takeCount));

		Console.WriteLine(<span class="string">"performDataReader: "</span> + CodeProfiler.ProfileAction(performDataReader, iterations, <span class="number">3</span>));
		Console.WriteLine(<span class="string">"performDataTable: "</span> + CodeProfiler.ProfileAction(performDataTable, iterations, <span class="number">3</span>));
		Console.WriteLine(<span class="string">"performEntityQuery: "</span> + CodeProfiler.ProfileAction(performEntityQuery, iterations, <span class="number">3</span>));
		Console.WriteLine(<span class="string">"performLinqQuery: "</span> + CodeProfiler.ProfileAction(performLinqQuery, iterations, <span class="number">3</span>));
		Console.WriteLine(<span class="string">"performCompiledLinqQuery: "</span> + CodeProfiler.ProfileAction(performCompiledLinqQuery, iterations, <span class="number">3</span>));
		Console.WriteLine(<span class="string">"performSubsetLinqQuery: "</span> + CodeProfiler.ProfileAction(performSubsetLinqQuery, iterations, <span class="number">3</span>));
		Console.WriteLine(<span class="string">"performAutomappedDataReader: "</span> + CodeProfiler.ProfileAction(performAutomappedDataReader, iterations, <span class="number">3</span>));
		Console.WriteLine(<span class="string">"performEnhancedAutomappedDataReader: "</span> + CodeProfiler.ProfileAction(performEnhancedAutomappedDataReader, iterations, <span class="number">3</span>));
		Console.WriteLine(<span class="string">"performSubSonicQuery: "</span> + CodeProfiler.ProfileAction(performSubSonicQuery, iterations, <span class="number">3</span>));
		Console.WriteLine(<span class="string">"performNHibernateQuery: "</span> + CodeProfiler.ProfileAction(performNHibernateQuery, iterations, <span class="number">3</span>));
	}

	Console.Write(<span class="string">"Done"</span>);
	Console.Read();
}
</pre></figure>

<h2 id="The_results">The results</h2>
<p>The following two graphs shows the total runtime of 50 iterations for each different method, as well as the total runtime divided by number of rows. Runtime in seconds along the Y-axis, number of rows along the X-axis. It basically shows that all LINQ to SQL flavors suffer from initial setup, but they scale extremely well, ending up outperforming all other contestants by a fair margin. One could argue that it’s rarely relevant in cases of more than a thousand rows as we’ll rarely pull out that much data at once. Never the less, I find it interesting - it’s something I’ll have to look under the hood to find an explanation of. Ignoring some variance due to the low row number, DataReader, DataTable and my Enhanced Automapped DataReader functions outperform most contestants.</p>
<p>UPDATE:</p>
<p>It seems the reason the LINQ flavors are so speedy is because their object mapper methods are being cached in the local thread cache. And since the CodeProfiler will execute all iterations on the same thread, each iteration (except the first) will simply reuse the mapper methods. See System.Data.Linq.SqlClient.ObjectReaderCompiler.Compile() for reference.</p>
<p>UPDATE 2:</p>
<p>As <a href="http://www.u2u.info/Blogs/Kris" target="_blank">Kris Vandermotten</a> duly commented, I should have tested a compiled LINQ query as well as that really is a separate scenario. I’ve added a tenth method as well as a new line in the graphs. The compiled LINQ query, although requiring a bit more plumbing code, really blows the competition away. It’s fast for even single row queries since we no longer suffer from the compilation time. For larger rowsets the advantage diminishes as the saved compilation time is spread out over a large amount of rows.</p>
<p>UPDATE 3:</p>
<p>As a friend of mine, <a href="http://intellect.dk/" target="_blank">Jakob Andersen</a> points out, I really should be a bit more specific in regards to the purpose of these comparisons.</p>
<p>I am in no way trying to make the claim that it’s unreasonable that an OR/M framework hurts performance. Neither am I claiming that my comparisons between LINQ to SQL, Subsonic and nHibernate are fair. Really, to make a fair comparison, one should compare the very specific features of the frameworks, not a feature set as general as what I’m doing in these tests.</p>
<p>The thing is, some of these frameworks (nHibernate, I’m looking at you especially) just offer so much more functionality that it’s a burden they have to live with. While this extra functionality might cost a bit when we’re just trying to test the actual object translation performance, it might gain you a whole lot more in real life scenarios. Take for instance, if you utilize nHibernates caching, you might save the time that goes towards the database lookups - saving you much more than the actual translation process in most cases.</p>
<p>So, as mentioned in a couple of tests - take these results with a grain of salt. They’re rather out-of-the-box simple tests of direct querying &amp; result translation performance. We’re ignoring all of the extra OR/M features that we have available, and we’re ignoring that these different frameworks offer very different functionality.</p>
<h3 id="Total_runtime">Total runtime</h3>
<div class="imgwrapper" style=""><div><a href="/performance-comparison-reading-data-from-the-database-strongly-typed/totalgraph1_2.jpg" class="fancy"><img src="/performance-comparison-reading-data-from-the-database-strongly-typed/totalgraph1_2.jpg" style="max-height: 250px"/></a></div></div>

<h3 id="Runtime_per_row">Runtime per row</h3>
<div class="imgwrapper" style=""><div><a href="/performance-comparison-reading-data-from-the-database-strongly-typed/totalgraph2_2.jpg" class="fancy"><img src="/performance-comparison-reading-data-from-the-database-strongly-typed/totalgraph2_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Remember, even though there seems to be somewhat of a speed difference, the fastest method takes only 0,000074 seconds, while the slowest takes 0,00085 seconds. No matter what, you should’nt consider refactoring your solutions in regards to performance unless you really have a high hit count, or unless it’s for valid architectural reasons. Otherwise you might just risk having Ted Dziuba <a href="http://teddziuba.com/2008/04/im-going-to-scale-my-foot-up-y.html" target="_blank">shove his foot up your ass</a>.</p>
<h2 id="Downloads">Downloads</h2>
<p><a href="PerformanceComparison_ReadingStronglyTyped.zip">PerformanceComparison_ReadingStronglyTyped.zip - Sample code</a><br><a href="Reading_Data_From_Database_Profiling.xlsx">Reading_Data_From_Database_Profiling.xslx - Profiling results</a></p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>


<div class="paging">
	<a href="/page/17/"><div class="past">« Past</div></a>
	<a href="/page/15/"><div class="future">Future »</div></a>
	<div class="clear"></div>
</div>

				</div>
			</div>

			<div id="asides">
				<div class="categories aside">
					<span class="sectiontitle">CATEGORIES</span>
					<ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/category/.NET/">.NET</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/AS/Flex/Flash/">AS/Flex/Flash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Amazon Web Services/">Amazon Web Services</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Computer Science/">Computer Science</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Conferences and Presenting/">Conferences and Presenting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/IIS/">IIS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Life/">Life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Miscellaneous/">Miscellaneous</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Performance/">Performance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Poker/">Poker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server/">SQL Server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Community/">SQL Server - Community</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Data Types/">SQL Server - Data Types</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Internals/">SQL Server - Internals</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Optimization/">SQL Server - Optimization</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Tricks/">SQL Server - Tricks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Testing/">Testing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Tools of the Trade/">Tools of the Trade</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Umbraco/">Umbraco</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Visual Studio/">Visual Studio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Web/">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windbg/">Windbg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windows/">Windows</a></li></ul>

					
				</div>

				<div class="archive aside">
					<span class="sectiontitle">ARCHIVE</span>
					<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archive/2014">2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2013">2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2012">2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2011">2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2010">2010</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2009">2009</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2008">2008</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2007">2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2006">2006</a></li></ul>
				</div>
			</div>

			<div class="clear"></div>
		</div>
		
		<footer>
			<div class="wrapper">Copyright &copy; 2014 Mark S. Rasmussen</div>
		</footer>

		<script type="text/javascript">
			$(function () {
				// Show mobile menu
				$("li.navicon").click(function () {
					if ($("header ul.mobile a").length == 0) {
						// Pages
						$mobilePages = $("div#naviconcontent ul.pages");
						$("header nav ul.normal > li").not(".navicon").each(function (i, el) {
							$mobilePages.append($(el).clone());
						});

						// Categories
						$mobileCategories = $("div#naviconcontent ul.categories");
						$("div#asides div.categories > ul > li").each(function (i, el) {
							$mobileCategories.append($(el).clone());
						});

						// Archive
						$mobileArchive = $("div#naviconcontent ul.archive");
						$("div#asides div.archive > ul > li").each(function (i, el) {
							$mobileArchive.append($(el).clone());
						});
					};

					$("header ul.mobile").toggle();
				});

				// Fancybox setup
				$("a.fancy").fancybox({
					hideOnContentClick: true,
					overlayShow: true
				});
			});
		</script>
	</body>
</html>