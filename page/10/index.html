<!DOCTYPE html>
<html>
	

<head>
	<title>Mark S. Rasmussen</title>
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
	<meta charset="UTF-8" />
	<meta property="og:locale" content="en_US" />
	<meta property="og:type" content="website" />
	<meta name="google-site-verification" content="alt7-wfK3ZujMQ4D0jYNd0yC5LGetGdqBlBmZsqQlVw" />
	<meta content="article" property="og:type">
<meta content="Mark S. Rasmussen" property="og:title">
<meta content="http://improve.dk/page/10/" property="og:url">
<meta property="og:image">
<meta content="Mark S. Rasmussen" property="og:site_name">
<meta property="og:description">
<meta content="summary" name="twitter:card">
	<link rel="alternative" href="http://feeds.feedburner.com/Improvedk" title="Mark S. Rasmussen" type="application/atom+xml">
	<script src="/js/combined.js"></script>
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-2479580-1', 'improve.dk');
		ga('require', 'displayfeatures');
		ga('send', 	'pageview');
	</script>
	<link rel="stylesheet" href="/css/style.css" type="text/css" />
</head>
	<body>
		<div id="headerline"></div>
	
		<header>
			<div class="wrapper">
				<div id="title">
					<a href="/">Mark S. Rasmussen</a> <span>improve.dk</span>
				</div>
				
				<nav>
					<ul class="normal">
						<li class="navicon"></li>
						<li><a href="/about-me/">About Me</a></li>
					</ul>
				</nav>
				
				<ul id="sharing">
					<li><a href="mailto:mark@improve.dk" id="shareat"></a></li>
					<li><a href="http://feeds.feedburner.com/Improvedk" id="rssfeed"></a></li>
					<li><a href="https://twitter.com/improvedk" id="sharetwitter"></a></li>
					<li><a href="https://github.com/improvedk" id="sharegithub"></a></li>
					<li><a href="https://www.linkedin.com/in/markrasmussen/" id="sharelinkedin"></a></li>
				</ul>

				<div class="clear"></div>
				
				<div id="naviconcontent">
					<ul class="mobile">
						<li>
							Pages
							<ul class="pages"></ul>
						</li>
						<li>
							Categories
							<ul class="categories"></ul>
						</li>
						<li>
							Archive
							<ul class="archive"></ul>
						</li>
					</ul>
				</div>
			</div>
		</header>

		<div id="mainwrapper">
			<div id="contentwrapper">
				<div id="content">
				
					
	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">May</span>
			<span class="day">19</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/checking-which-database-is-stored-in-a-deattached-mdf-file/" title="Checking Which Database is Stored in a Detached MDF File" rel="bookmark">Checking Which Database is Stored in a Detached MDF File</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				, 
			
				<a href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Inspired by <a href="http://stackoverflow.com/questions/6061510/any-way-to-quickly-tell-which-database-if-any-is-attached-to-a-mdf-file" target="_blank">this</a> question on StackOverflow, I’ve made a quick script to demonstrate how this might be done using <a href="https://github.com/improvedk/OrcaMDF" target="_blank">OrcaMDF</a>.</p>
<a id="more"></a>

<p>In this example I’m looping all .mdf files in my local SQL Server data directory. Each one is loaded using OrcaMDF, the boot page is fetched and finally the database name is printed:</p>
<figure class="highlight csharp"><pre><span class="keyword">using</span> System;
<span class="keyword">using</span> System.IO;
<span class="keyword">using</span> OrcaMDF.Core.Engine;

<span class="class"><span class="keyword">namespace</span> <span class="title">OrcaMDF</span>.<span class="title">Adhoc</span>
{</span>
    <span class="class"><span class="keyword">class</span> <span class="title">Program</span>
    {</span>
        <span class="keyword">static</span> <span class="keyword">void</span> Main()
        {
			<span class="keyword">foreach</span> (<span class="keyword">string</span> mdfPath in Directory.GetFiles(@<span class="string">"C:\Program Files\Microsoft SQL Server\MSSQL10_50.MSSQLSERVER\MSSQL\DATA"</span>))
			{
				if (!mdfPath.ToLower().EndsWith(<span class="string">".mdf"</span>))
					continue;

				<span class="keyword">using</span> (<span class="keyword">var</span> file = <span class="keyword">new</span> MdfFile(mdfPath))
				{
					<span class="keyword">var</span> bootPage = file.GetBootPage();
					Console.WriteLine(bootPage.DatabaseName);
				}
			}
        }
    }
}
</pre></figure>

<p>And the following is the output we get:</p>
<div class="imgwrapper" style=""><div><a href="/checking-which-database-is-stored-in-a-deattached-mdf-file/image_21.png" class="fancy"><img src="/checking-which-database-is-stored-in-a-deattached-mdf-file/image_21.png" style="max-height: 250px"/></a></div></div>

<p>Which, coincidentally, matches up to the databases I’ve got attached to my local SQL Server. At this point we could match this list up to the one we’d get from sys.databases and see which files didn’t have a matching database, and thus weed out the non-attached mdf files from our data directory.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">May</span>
			<span class="day">19</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/bridging-the-gap-between-smallint-and-int/" title="Bridging the Gap Between Smallint and Int" rel="bookmark">Bridging the Gap Between Smallint and Int</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - Optimization/">SQL Server - Optimization</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Being a proponent of <a href="/wasted-bytes-add-up-consider-your-data-types-carefully">carefully choosing your data types</a>, I’ve often longed for the <a href="http://dev.mysql.com/doc/refman/5.0/en/numeric-types.html" target="_blank">mediumint data type</a> that MySQL has. Both smallint and int are signed data types, meaning their ranges are –32,768 to 32,767 for smallint and –2,147,483,648 to 2,147,483,647 for int. For most relational db schemas, positive identity values are used, meaning we’re looking at a possible 32,767 vs 2,147,483,647 values for smallint vs int. That’s a humongous difference, and it comes at a storage cost as well – 2 vs 4 bytes per column. If only there was something in between…</p>
<a id="more"></a>

<h2 id="You_say_mediumint,_I_say_binary(3)">You say mediumint, I say binary(3)</h2>
<p>While there’s no native mediumint data type in SQL Server, there is a binary data type. Internally it’s basically just a byte array, just as any other data type. An int is just a binary(4) with some custom processing on top of it, smallint being a binary(2) and nvarchar being a binary(length * 2). What that means is there’s no stopping us from saving whatever bytes we want into a binary(3) column, including numbers. Using the following sample table:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ThreeByteInt
(
	MediumInt binary(<span class="number">3</span>),
	Filler <span class="keyword">char</span>(<span class="number">20</span>) <span class="keyword">NULL</span>
)

<span class="keyword">CREATE</span> CLUSTERED INDEX CX_ThreeByteInt <span class="keyword">ON</span> ThreeByteInt (MediumInt)</span>
</pre></figure>

<p>We can insert values through SQL either using byte constants or using numbers as normal:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ThreeByteInt (MediumInt) <span class="keyword">VALUES</span> (<span class="number">0xC9DF48</span>)
<span class="keyword">INSERT</span> <span class="keyword">INTO</span> ThreeByteInt (MediumInt) <span class="keyword">VALUES</span> (<span class="number">0x000000</span>)
<span class="keyword">INSERT</span> <span class="keyword">INTO</span> ThreeByteInt (MediumInt) <span class="keyword">VALUES</span> (<span class="number">0xFFFFFF</span>)
<span class="keyword">INSERT</span> <span class="keyword">INTO</span> ThreeByteInt (MediumInt) <span class="keyword">VALUES</span> (<span class="number">13229896</span>)
<span class="keyword">INSERT</span> <span class="keyword">INTO</span> ThreeByteInt (MediumInt) <span class="keyword">VALUES</span> (<span class="number">1500</span>)
<span class="keyword">INSERT</span> <span class="keyword">INTO</span> ThreeByteInt (MediumInt) <span class="keyword">VALUES</span> (<span class="number">0</span>)
<span class="keyword">INSERT</span> <span class="keyword">INTO</span> ThreeByteInt (MediumInt) <span class="keyword">VALUES</span> (<span class="number">16777215</span>)</span>
</pre></figure>

<p>And querying works like normal as well:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> ThreeByteInt</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/bridging-the-gap-between-smallint-and-int/image_23.png" class="fancy"><img src="/bridging-the-gap-between-smallint-and-int/image_23.png" style="max-height: 250px"/></a></div></div>

<h2 id="Scans_ahoy!">Scans ahoy!</h2>
<p>However, take a look at the plans for these two queries:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> ThreeByteInt <span class="keyword">WHERE</span> MediumInt = <span class="number">1500</span>
<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> ThreeByteInt <span class="keyword">WHERE</span> MediumInt = <span class="number">0x0005DC</span></span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/bridging-the-gap-between-smallint-and-int/image_41.png" class="fancy"><img src="/bridging-the-gap-between-smallint-and-int/image_41.png" style="max-height: 250px"/></a></div></div>

<p>They both contain a predicate looking for a value of 1500, one written as an integer constant, the other as a hex constant. One is causing a scan, the other is using a seek. Taking a closer look at the scan reveals an IMPLICIT_CONVERT which renders are index useless and thus causing the scan:</p>
<div class="imgwrapper" style=""><div><a href="/bridging-the-gap-between-smallint-and-int/image_61.png" class="fancy"><img src="/bridging-the-gap-between-smallint-and-int/image_61.png" style="max-height: 250px"/></a></div></div>

<p>The easiest way of avoiding this is just to replace the implicit conversion with an explicit cast in the query:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> ThreeByteInt <span class="keyword">WHERE</span> MediumInt = <span class="keyword">CAST</span>(<span class="number">1500</span> <span class="keyword">as</span> binary(<span class="number">3</span>))</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/bridging-the-gap-between-smallint-and-int/image_81.png" class="fancy"><img src="/bridging-the-gap-between-smallint-and-int/image_81.png" style="max-height: 250px"/></a></div></div>

<h2 id="Unsigned_integers_&amp;_overflow">Unsigned integers &amp; overflow</h2>
<p>Whereas smallint, int and bigint are all signed integer types (the ability to have negative values), tinyint is not. Tinyint is able to store values in the 0-255 range. Had it been a signed type, it would be able to handle values in the –128 to 127 range. Just like tinyint, binary(3)/mediumint is an unsigned type, giving us a range of 0 to 16,777,215.</p>
<p>Most developers &amp; DBAs have experienced <a href="http://en.wikipedia.org/wiki/Integer_overflow" target="_blank">integer overflow</a> at some point, usually causing havoc in the application. In short, an overflow occurs when you assign a value larger or smaller than what the data type can handle. In our case, that might be –1 or 16,777,216. We can easily demonstrate what’s happening by casting an integer to binary(3) and back to int again like so:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span>
	<span class="keyword">CAST</span>(<span class="keyword">CAST</span>(<span class="number">16777214</span> <span class="keyword">AS</span> binary(<span class="number">3</span>)) <span class="keyword">AS</span> <span class="keyword">int</span>),
	<span class="keyword">CAST</span>(<span class="keyword">CAST</span>(<span class="number">16777215</span> <span class="keyword">AS</span> binary(<span class="number">3</span>)) <span class="keyword">AS</span> <span class="keyword">int</span>),
	<span class="keyword">CAST</span>(<span class="keyword">CAST</span>(<span class="number">16777216</span> <span class="keyword">AS</span> binary(<span class="number">3</span>)) <span class="keyword">AS</span> <span class="keyword">int</span>)

<span class="keyword">UNION</span> <span class="keyword">ALL</span>

<span class="keyword">SELECT</span>
	<span class="keyword">CAST</span>(<span class="keyword">CAST</span>(-<span class="number">1</span> <span class="keyword">AS</span> binary(<span class="number">3</span>)) <span class="keyword">AS</span> <span class="keyword">int</span>),
	<span class="keyword">CAST</span>(<span class="keyword">CAST</span>(<span class="number">0</span> <span class="keyword">AS</span> binary(<span class="number">3</span>)) <span class="keyword">AS</span> <span class="keyword">int</span>),
	<span class="keyword">CAST</span>(<span class="keyword">CAST</span>(<span class="number">1</span> <span class="keyword">AS</span> binary(<span class="number">3</span>)) <span class="keyword">AS</span> <span class="keyword">int</span>)

<span class="keyword">UNION</span> <span class="keyword">ALL</span>

<span class="keyword">SELECT</span>
	<span class="keyword">CAST</span>(<span class="keyword">CAST</span>(<span class="number">33554430</span> <span class="keyword">AS</span> binary(<span class="number">3</span>)) <span class="keyword">AS</span> <span class="keyword">int</span>),
	<span class="keyword">CAST</span>(<span class="keyword">CAST</span>(<span class="number">33554431</span> <span class="keyword">AS</span> binary(<span class="number">3</span>)) <span class="keyword">AS</span> <span class="keyword">int</span>),
	<span class="keyword">CAST</span>(<span class="keyword">CAST</span>(<span class="number">33554432</span> <span class="keyword">AS</span> binary(<span class="number">3</span>)) <span class="keyword">AS</span> <span class="keyword">int</span>)</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/bridging-the-gap-between-smallint-and-int/image_101.png" class="fancy"><img src="/bridging-the-gap-between-smallint-and-int/image_101.png" style="max-height: 250px"/></a></div></div>

<h2 id="Working_with_binary(3)_on_the_client_side">Working with binary(3) on the client side</h2>
<p>Now that we’ve got our mediumint data type, all we need is to be able to insert &amp; query data from the client.</p>
<p>Inserting is easy – just send values is as integers and it’ll be converted as appropriate – just make sure to check for over/underflows as necessary:</p>
<figure class="highlight csharp"><pre>using(var conn = new SqlConnection("Data Source=.;Initial Catalog=MediumIntTest;Integrated Security=SSPI;"))
{
	var <span class="operator"><span class="keyword">insert</span> = new SqlCommand(<span class="string">"INSERT INTO ThreeByteInt (MediumInt) VALUES (@MediumInt)"</span>);</span>
	<span class="operator"><span class="keyword">insert</span>.Parameters.<span class="keyword">Add</span>(<span class="string">"@MediumInt"</span>, SqlDbType.<span class="keyword">Int</span>).<span class="keyword">Value</span> = <span class="number">439848</span>;</span>
	<span class="operator"><span class="keyword">insert</span>.<span class="keyword">Connection</span> = conn;</span>

	conn.Open();
	<span class="operator"><span class="keyword">insert</span>.ExecuteNonQuery();</span>
	conn.Close();
}
</pre></figure>

<p>Querying requires slightly more effort. We’ll still pass in the value as an integer, but we’ll have to perform a CAST in the query to avoid scans. We could also pass the value in as a three byte array, but provided we have access to the query text, it’s easier to perform the conversion there. Furthermore there’s no standard three byte integer type in C#, so we’ll have do perform some ugly magic to convert the three bytes into a normal .NET integer:</p>
<figure class="highlight csharp"><pre><span class="keyword">using</span>(<span class="keyword">var</span> conn = <span class="keyword">new</span> SqlConnection(<span class="string">"Data Source=.;Initial Catalog=MediumIntTest;Integrated Security=SSPI;"</span>))
{
	<span class="keyword">var</span> <span class="keyword">select</span> = <span class="keyword">new</span> SqlCommand(<span class="string">"SELECT MediumInt FROM ThreeByteInt WHERE MediumInt = CAST(@MediumInt AS binary(3))"</span>);
	<span class="keyword">select</span>.Parameters.Add(<span class="string">"@MediumInt"</span>, SqlDbType.Int).Value = <span class="number">439848</span>;
	<span class="keyword">select</span>.Connection = conn;

	conn.Open();
	<span class="keyword">byte</span>[] bytes = (<span class="keyword">byte</span>[])<span class="keyword">select</span>.ExecuteScalar();
	<span class="keyword">int</span> result = BitConverter.ToInt32(<span class="keyword">new</span> <span class="keyword">byte</span>[] { bytes[<span class="number">2</span>], bytes[<span class="number">1</span>], bytes[<span class="number">0</span>], <span class="number">0</span> }, <span class="number">0</span>);
	conn.Close();

	Console.WriteLine(result);
}
</pre></figure>

<h2 id="Summing_it_up">Summing it up</h2>
<p>As I’ve shown, we can easily create our own mediumint data type, just as we can create a 5 byte integer, 6 byte… Well, you get it. However, there are obviously some trade offs in that you’ll have to manage this data type yourself. While you can query it more or less like a normal data type, you have to be wary of scans. Finally, retrieving values will require some extra work, though that could easily be abstracted away in a custom type.</p>
<p>So should you do it? Probably not. Saving a single byte per column will gain you very little, unless you have a humongous table, especially so if you have a lot of columns that fit in between the smallint and int value range. For those humongous archival tables, this might just be a way to shave an extra byte off per <em>mediumint</em> column.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">May</span>
			<span class="day">19</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/reverse-engineering-sql-server-page-headers/" title="Reverse Engineering SQL Server Page Headers" rel="bookmark">Reverse Engineering SQL Server Page Headers</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				, 
			
				<a href="/category/SQL Server - Internals/">SQL Server - Internals</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>One of the first challenges I faced when starting out the development of <a href="https://github.com/improvedk/OrcaMDF" target="_blank">OrcaMDF</a> was parsing page headers. We all know that <a href="/deciphering-a-sql-server-data-page/">pages are basically split in two parts</a>, the 96 byte header and the 8096 byte body of remaining bytes. Much has been written about headers and Paul Randal (<a href="http://www.sqlskills.com/BLOGS/PAUL/" target="_blank">b</a>|<a href="http://twitter.com/#!/paulrandal" target="_blank">t</a>) has a great post describing the <a href="http://www.sqlskills.com/blogs/paul/post/Inside-the-Storage-Engine-Anatomy-of-a-page.aspx" target="_blank">contents of the header</a> as well. However, though the contents have been described, I’ve been completely unable to find any kind of details on the storage format. What data types are the individual fields, and what’s the order? Oh well, we’ve always got DBCC PAGE.</p>
<a id="more"></a>

<p>Firing up DBCC PAGE, I scoured for a random data page whose header I could dump, in this case page (1:101):</p>
<figure class="highlight sql"><pre>DBCC TRACEON (3604)
DBCC PAGE (TextTest, 1, 101, 2)
</pre></figure>

<p>The result comes in two parts, first we’ve got the header contents as DBCC PAGE kindly parses for us, while the second part is a dump of the 96 bytes that make up the header data:</p>
<div class="imgwrapper" style=""><div><a href="/reverse-engineering-sql-server-page-headers/image_2.png" class="fancy"><img src="/reverse-engineering-sql-server-page-headers/image_2.png" style="max-height: 250px"/></a></div></div>

<p>Armed with this, the hunt begins! What we’re looking for is a match between the parsed values and the bytes in the header. To make it easy, we need to spot some unique values so we don’t get a lot of ambiguity in where the value might be stored. Starting out with m_freeCnt, we see it has a value of 4066. The body size is 8060 bytes so it’s clear that the number can’t be a tinyint. It wouldn’t make sense to make it an int as that supporst way larger values than we need. An educated guess would be that m_freeCnt is probably stored as a smallint, leaving plenty of space for the 0-8060 range we need.</p>
<p>Now, 4066 represented in hex is 0x0FE2. Byte swapped, that becomes 0xE20F, and what do you know, we have a match!</p>
<div class="imgwrapper" style=""><div><a href="/reverse-engineering-sql-server-page-headers/image_4.png" class="fancy"><img src="/reverse-engineering-sql-server-page-headers/image_4.png" style="max-height: 250px"/></a></div></div>

<p>And thus we have identified the first field of our header:</p>
<figure class="highlight csharp"><pre>/*
	Bytes	Content
	-----	-------
	00-27	?
	28-29	FreeCnt (smallint)
	30-95	?
*/
</pre></figure>

<p>Continuing the search we see that m_freeData = 3895. In hex that’s 0x0F37 and 0x370F when swapped. And voilá, that’s stored right next to m_freeCnt:</p>
<div class="imgwrapper" style=""><div><a href="/reverse-engineering-sql-server-page-headers/image_6.png" class="fancy"><img src="/reverse-engineering-sql-server-page-headers/image_6.png" style="max-height: 250px"/></a></div></div>

<p>Continuing on with this technique, we can map all the distinct header values where there’s no ambiguity as to where they’re stored. But what about a field like m_level? It has the same value as m_xactReserved, m_reservedCnt, m_ghostRecCnt, etc. How do we know which one of those zero values is really m_level? And how do we find out what the data type is? It could be anything from a tinyint to bigint!</p>
<p>Time to bring out the big guns! We’ll start out by shutting down MSSQL / SQL Server:</p>
<div class="imgwrapper" style=""><div><a href="/reverse-engineering-sql-server-page-headers/image_8.png" class="fancy"><img src="/reverse-engineering-sql-server-page-headers/image_8.png" style="max-height: 250px"/></a></div></div>

<p>Then we’ll open up the .mdf file in Visual Studio:</p>
<div class="imgwrapper" style=""><div><a href="/reverse-engineering-sql-server-page-headers/image_10.png" class="fancy"><img src="/reverse-engineering-sql-server-page-headers/image_10.png" style="max-height: 250px"/></a></div></div>

<p>This’ll open up the file in hex editor mode, allowing direct access to all the yummy data! As we know the page id was 101, we need to jump to byte offset 101 * 8192 = 827,392 to get to the first byte of page 101:</p>
<div class="imgwrapper" style=""><div><a href="/reverse-engineering-sql-server-page-headers/image_12.png" class="fancy"><img src="/reverse-engineering-sql-server-page-headers/image_12.png" style="max-height: 250px"/></a></div></div>

<p>Looking at these bytes we see that they’re identical to our header contents, thus confirming we’ve jumped to the correct offset:</p>
<div class="imgwrapper" style=""><div><a href="/reverse-engineering-sql-server-page-headers/image_16.png" class="fancy"><img src="/reverse-engineering-sql-server-page-headers/image_16.png" style="max-height: 250px"/></a></div></div>

<p>Now I’m going to ask you to do something that will make sheep loving people cry – write some gibberish in there and save the file! Please <strong>do not</strong> do this to a database with any kind of important data in it. Before:</p>
<div class="imgwrapper" style=""><div><a href="/reverse-engineering-sql-server-page-headers/image_18.png" class="fancy"><img src="/reverse-engineering-sql-server-page-headers/image_18.png" style="max-height: 250px"/></a></div></div>

<p>After:</p>
<div class="imgwrapper" style=""><div><a href="/reverse-engineering-sql-server-page-headers/image_22.png" class="fancy"><img src="/reverse-engineering-sql-server-page-headers/image_22.png" style="max-height: 250px"/></a></div></div>

<p>Oh the horrors! Now restart MSSQL / SQL Server and rerun the DBCC PAGE query from before:</p>
<figure class="highlight sql"><pre>DBCC TRACEON (3604)
DBCC PAGE (TextTest, 1, 101, 2)
</pre></figure>

<p>And notice the header we get as a result:</p>
<div class="imgwrapper" style=""><div><a href="/reverse-engineering-sql-server-page-headers/image_24.png" class="fancy"><img src="/reverse-engineering-sql-server-page-headers/image_24.png" style="max-height: 250px"/></a></div></div>

<p>Several values have changed! m_xactReserved had an ambiguous value of 0 before, now it’s at 30,806. Converting that to byte swapped hex we get a value of 0x5678. Looking at the header, we’ve now pinpointed yet another field and datatype (smallint):</p>
<div class="imgwrapper" style=""><div><a href="/reverse-engineering-sql-server-page-headers/image_26.png" class="fancy"><img src="/reverse-engineering-sql-server-page-headers/image_26.png" style="max-height: 250px"/></a></div></div>

<p>And thus we can update our header reference table:</p>
<figure class="highlight csharp"><pre>/*
	Bytes	Content
	-----	-------
	00-27	?
	28-29	FreeCnt (smallint)
	30-49	?
	50-51	XactReserved (smallint)
	30-95	?
*/
</pre></figure>

<p>Continuing down this path, messing up the header, correlating messed up values with values parsed by DBCC PAGE, it’s possible to locate all the fields and their corresponding data types. If you see the following message, you know you’ve messed it up properly:</p>
<div class="imgwrapper" style=""><div><a href="/reverse-engineering-sql-server-page-headers/image_28.png" class="fancy"><img src="/reverse-engineering-sql-server-page-headers/image_28.png" style="max-height: 250px"/></a></div></div>

<p>You should be proud of yourself. No go clean up the mess you’ve made!</p>
<p>Jumping forward, I’ve compiled a reference to the page header structure:</p>
<figure class="highlight csharp"><pre>/*
	Bytes	Content
	-----	-------
	00	HeaderVersion (tinyint)
	01	Type (tinyint)
	02	TypeFlagBits (tinyint)
	03	Level (tinyint)
	04-05	FlagBits (smallint)
	06-07	IndexID (smallint)
	08-11	PreviousPageID (int)
	12-13	PreviousFileID (smallint)
	14-15	Pminlen (smallint)
	16-19	NextPageID (int)
	20-21	NextPageFileID (smallint)
	22-23	SlotCnt (smallint)
	24-27	ObjectID (int)
	28-29	FreeCnt (smallint)
	30-31	FreeData (smallint)
	32-35	PageID (int)
	36-37	FileID (smallint)
	38-39	ReservedCnt (smallint)
	40-43	Lsn1 (int)
	44-47	Lsn2 (int)
	48-49	Lsn3 (smallint)
	50-51	XactReserved (smallint)
	52-55	XdesIDPart2 (int)
	56-57	XdesIDPart1 (smallint)
	58-59	GhostRecCnt (smallint)
	60-95	?
*/
</pre></figure>

<p>I’m not sure what lies in the remaining bytes of the header as DBCC PAGE doesn’t seem to parse stuff there, and it seems to be zeroed out for all pages I’ve tested. I’m assuming it’s reserved bytes for future usage. Once we’ve got the format, parsing becomes a simple task of reading each field, field by field:</p>
<figure class="highlight csharp"><pre>HeaderVersion = header[<span class="number">0</span>]<span class="comment">;</span>
Type = (PageType)header[<span class="number">1</span>]<span class="comment">;</span>
TypeFlagBits = header[<span class="number">2</span>]<span class="comment">;</span>
Level = header[<span class="number">3</span>]<span class="comment">;</span>
FlagBits = BitConverter<span class="preprocessor">.ToInt</span>16(header, <span class="number">4</span>)<span class="comment">;</span>
IndexID = BitConverter<span class="preprocessor">.ToInt</span>16(header, <span class="number">6</span>)<span class="comment">;</span>
PreviousPage = new PagePointer(BitConverter<span class="preprocessor">.ToInt</span>16(header, <span class="number">12</span>), BitConverter<span class="preprocessor">.ToInt</span>32(header, <span class="number">8</span>))<span class="comment">;</span>
Pminlen = BitConverter<span class="preprocessor">.ToInt</span>16(header, <span class="number">14</span>)<span class="comment">;</span>
NextPage = new PagePointer(BitConverter<span class="preprocessor">.ToInt</span>16(header, <span class="number">20</span>), BitConverter<span class="preprocessor">.ToInt</span>32(header, <span class="number">16</span>))<span class="comment">;</span>
SlotCnt = BitConverter<span class="preprocessor">.ToInt</span>16(header, <span class="number">22</span>)<span class="comment">;</span>
ObjectID = BitConverter<span class="preprocessor">.ToInt</span>32(header, <span class="number">24</span>)<span class="comment">;</span>
FreeCnt = BitConverter<span class="preprocessor">.ToInt</span>16(header, <span class="number">28</span>)<span class="comment">;</span>
FreeData = BitConverter<span class="preprocessor">.ToInt</span>16(header, <span class="number">30</span>)<span class="comment">;</span>
Pointer = new PagePointer(BitConverter<span class="preprocessor">.ToInt</span>16(header, <span class="number">36</span>), BitConverter<span class="preprocessor">.ToInt</span>32(header, <span class="number">32</span>))<span class="comment">;</span>
ReservedCnt = BitConverter<span class="preprocessor">.ToInt</span>16(header, <span class="number">38</span>)<span class="comment">;</span>
Lsn = <span class="string">"("</span> + BitConverter<span class="preprocessor">.ToInt</span>32(header, <span class="number">40</span>) + <span class="string">":"</span> + BitConverter<span class="preprocessor">.ToInt</span>32(header, <span class="number">44</span>) + <span class="string">":"</span> + BitConverter<span class="preprocessor">.ToInt</span>16(header, <span class="number">48</span>) + <span class="string">")"</span><span class="comment">;</span>
XactReserved = BitConverter<span class="preprocessor">.ToInt</span>16(header, <span class="number">50</span>)<span class="comment">;</span>
XdesID = <span class="string">"("</span> + BitConverter<span class="preprocessor">.ToInt</span>16(header, <span class="number">56</span>) + <span class="string">":"</span> + BitConverter<span class="preprocessor">.ToInt</span>32(header, <span class="number">52</span>) + <span class="string">")"</span><span class="comment">;</span>
GhostRecCnt = BitConverter<span class="preprocessor">.ToInt</span>16(header, <span class="number">58</span>)<span class="comment">;</span>
</pre></figure>

<p>You can also see the <a href="https://github.com/improvedk/OrcaMDF/blob/master/src/OrcaMDF.Core/Engine/Pages/PageHeader.cs" target="_blank">full source of the header parsing at GitHub</a>.</p>
<h2 id="Wan’t_more?">Wan’t more?</h2>
<p>If this isn’t enough for you, you should go and <a href="http://www.sqlpass.org/summit/2011/Speakers/SessionPreferencing.aspx?spid=245&amp;p=1&amp;preferred=False" target="_blank">vote for one or more of my OrcaMDF related sessions</a> at the PASS Summit.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">May</span>
			<span class="day">17</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/wasted-bytes-add-up-consider-your-data-types-carefully/" title="Wasted Bytes Add Up, Consider Your Data Types Carefully" rel="bookmark">Wasted Bytes Add Up, Consider Your Data Types Carefully</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - Optimization/">SQL Server - Optimization</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I recently had a look at the statistics storage of a system I designed some time ago. As is usually the case, back when I made it, I neither expected nor planned for a large amount data, and yet somehow that table currently has about 750m rows in it.</p>
<a id="more"></a>

<p>The basic schema for the table references a given entity and a page number, both represented by ints. Furthermore we register the users Flash version, their IP and the date of the hit.</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> #HitsV1
(
	EntityID <span class="keyword">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,
	PageNumber <span class="keyword">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,
	Created datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span>,
	FlashVersion <span class="keyword">int</span> <span class="keyword">NULL</span>,
	IP <span class="keyword">varchar</span>(<span class="number">15</span>) <span class="keyword">NULL</span>
)</span>
</pre></figure>

<p>Taking a look at the schema, we can calculate the size of the data in the record (synonymous to a row, indicating the structure on disk) to be 4 + 4 + 8 + 4 + 15 = 35 bytes. However, there’s overhead to a record as well, and the narrower the row, the more overhead, relatively.</p>
<p>In this case, the overhead consists of:</p>
<table>
<thead>
<tr>
<th>Bytes</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>Status bits A &amp; B</td>
</tr>
<tr>
<td>2</td>
<td>Length of fixed-length data</td>
</tr>
<tr>
<td>2</td>
<td>Number of columns</td>
</tr>
<tr>
<td>1</td>
<td>NULL bitmap</td>
</tr>
<tr>
<td>2</td>
<td>Number of variable length columns</td>
</tr>
<tr>
<td>2</td>
<td>Variable length column offset array</td>
</tr>
</tbody>
</table>
<p>Finally, each record has an accompanying two byte pointer in the row offset array, meaning the total overhead per record amounts to 13 bytes. Thus we’ve got 48 bytes in total per record, and with 8096 bytes of available data space per page, that amounts to a max of about 168 rows per page.</p>
<p>To test things out, we’ll insert 100k rows into the table:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">BEGIN</span> TRAN
<span class="keyword">DECLARE</span> @Cnt <span class="keyword">int</span> = <span class="number">0</span>
WHILE @Cnt &lt; <span class="number">100000</span> <span class="keyword">BEGIN</span>

	<span class="keyword">INSERT</span> <span class="keyword">INTO</span> #HitsV1 <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>, getdate(), <span class="number">1</span>, <span class="string">'255.255.255.255'</span>)

	<span class="keyword">SET</span> @Cnt = @Cnt + <span class="number">1</span>
<span class="keyword">END</span>
<span class="keyword">COMMIT</span></span>
</pre></figure>

<p>Note that the actual values doesn’t matter as we’re only looking at the storage effects. Given 168 rows per page, 100.000 rows should fit in about 100.000 / 168 ~= 596 pages. Taking a look at the currently used page count, it’s a pretty close estimate:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span>
	AU.*
<span class="keyword">FROM</span>
	sys.allocation_units AU
<span class="keyword">INNER</span> <span class="keyword">JOIN</span>
	sys.partitions P <span class="keyword">ON</span> AU.container_id = P.partition_id
<span class="keyword">INNER</span> <span class="keyword">JOIN</span>
	sys.objects O <span class="keyword">ON</span> O.object_id = P.object_id
<span class="keyword">WHERE</span>
	O.name <span class="keyword">LIKE</span> <span class="string">'#HitsV1%'</span></span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/wasted-bytes-add-up-consider-your-data-types-carefully/image_25.png" class="fancy"><img src="/wasted-bytes-add-up-consider-your-data-types-carefully/image_25.png" style="max-height: 250px"/></a></div></div>

<h2 id="Reconsidering_data_types_by_looking_at_reality_and_business_specs?">Reconsidering data types by looking at reality and business specs?</h2>
<p>If we start out by looking at the overhead, we’ve got a total of four bytes spent on managing the single variable-length IP field. We could change it into a char(15), but then we’d waste space for IP’s like 127.0.0.1 and there’s the whole spaces-at-the-end issue. If we instead convert the IP into an 8-byte bigint on the application side, we save 7 bytes on the column itself, plus 4 for the overhead!</p>
<p>Looking at the FlashVersion field, why do we need a 4-byte integer capable of storing values between –2.147.483.468 and 2.147.483.647 when the actual Flash version range between 1 and 11? Changing that field into a tinyint just saved us 3 bytes more per record!</p>
<p>Reading through our product specs I realize we’ll never need to support more than 1000 pages per entity, and we don’t need to store statistics more precisely than to-the-hour. Converting PageNumber to a smallint just saved 2 extra bytes per record!</p>
<p>As for the Created field, it currently takes up 8 bytes per record and has the ability to store the time with a precision down to one thee-hundredth of a second – obviously way more precise than what we need. Smalldatetime would be much more fitting, storing the precision down to the minute and taking up only 4 bytes – saving a final 4 bytes per record. I we wanted to push it to the extreme we could split Created into two fields – a 3 byte date field and a 1 byte tinyint field for the hour. Though it’d take up the same space, we just gained the ability to store dates all the way up to year 9999 instead of <em>only </em>2079. As the rapture is coming up shortly, we’ll skip that for now.</p>
<p>So to sum it up, we just saved:</p>
<table>
<thead>
<tr>
<th>Bytes</th>
<th>Cause</th>
</tr>
</thead>
<tbody>
<tr>
<td>11</td>
<td>Converting IP to bigint</td>
</tr>
<tr>
<td>3</td>
<td>Converting FlashVersion to tinyint</td>
</tr>
<tr>
<td>2</td>
<td>Converting PageNumber to smallint</td>
</tr>
<tr>
<td>4</td>
<td>Converting Created to smalldatetime</td>
</tr>
</tbody>
</table>
<p>In total, 20 bytes per record, resulting in a new total record size of 26 – 28 including the slot offset array pointer. This means we can now fit in 289 rows per page instead of the previous 168.</p>
<p>Testing the new format reveals we’re down to just 364 pages now:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> #HitsV2
(
	EntityID <span class="keyword">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,
	CategoryID <span class="keyword">smallint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,
	Created smalldatetime <span class="keyword">NOT</span> <span class="keyword">NULL</span>,
	FlashVersion tinyint <span class="keyword">NULL</span>,
	IP bigint <span class="keyword">NULL</span>
)

<span class="keyword">BEGIN</span> TRAN
<span class="keyword">DECLARE</span> @Cnt <span class="keyword">int</span> = <span class="number">0</span>
WHILE @Cnt &lt; <span class="number">100000</span> <span class="keyword">BEGIN</span>

	<span class="keyword">INSERT</span> <span class="keyword">INTO</span> #HitsV2 <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>, getdate(), <span class="number">1</span>, <span class="number">1</span>)

	<span class="keyword">SET</span> @Cnt = @Cnt + <span class="number">1</span>
<span class="keyword">END</span>
<span class="keyword">COMMIT</span>

<span class="keyword">SELECT</span>
	AU.*
<span class="keyword">FROM</span>
	sys.allocation_units AU
<span class="keyword">INNER</span> <span class="keyword">JOIN</span>
	sys.partitions P <span class="keyword">ON</span> AU.container_id = P.partition_id
<span class="keyword">INNER</span> <span class="keyword">JOIN</span>
	sys.objects O <span class="keyword">ON</span> O.object_id = P.object_id
<span class="keyword">WHERE</span>
	O.name <span class="keyword">LIKE</span> <span class="string">'#HitsV2%'</span></span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/wasted-bytes-add-up-consider-your-data-types-carefully/image_42.png" class="fancy"><img src="/wasted-bytes-add-up-consider-your-data-types-carefully/image_42.png" style="max-height: 250px"/></a></div></div>

<h2 id="The_more_rows,_the_more_waste">The more rows, the more waste</h2>
<p>Looking back at the 750m table, the original format would (assuming an utopian zero fragmentation) take up just about:</p>
<blockquote>
<p>750.000.000 / 168 * 8 / 1024 / 1024 ~= 34 gigabytes.</p>
</blockquote>
<p>Whereas the new format takes up a somewhat lower:</p>
<blockquote>
<p>750.000.000 / 289 * 8 / 1024 / 1024 ~= 20 gigabytes.</p>
</blockquote>
<p>And there we have it – spending just a short while longer considering the actual business &amp; data needs when designing your tables can save you some considerable space, resulting in better performance and lower IO subsystem requirements.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">May</span>
			<span class="day">12</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/reading-bits-in-orcamdf/" title="Reading Bits in OrcaMDF" rel="bookmark">Reading Bits in OrcaMDF</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - Internals/">SQL Server - Internals</a>
				, 
			
				<a href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Bits are stored very differently from other fixed length data types in SQL Server. Usually all fixed length columns will be present, one after the other, in the fixed data part of a record. As the smallest unit of data we can write to disk is a byte, the naïve approach to storing bits would be to use a whole bit for each bit. It would be very simple to parse as it would follow the usual scheme, but it would also waste quite some space.</p>
<a id="more"></a>

<h2 id="How_are_bits_stored_internally_on_records?">How are bits stored internally on records?</h2>
<p>Instead, several bit columns values are stored in a single byte, up to a total of 8 max, naturally. Say we had a table definition like this:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> BitTest
(
	A <span class="keyword">bit</span>
	B <span class="keyword">bit</span>
	C <span class="keyword">bit</span>
	D <span class="keyword">int</span>
)</span>
</pre></figure>

<p>The fixed length data part of our record would be 5 bytes, 4 for the integer column and a single byte, of which only three bits are used, for the bit columns.</p>
<div class="imgwrapper" style=""><div><a href="/reading-bits-in-orcamdf/image_27.png" class="fancy"><img src="/reading-bits-in-orcamdf/image_27.png" style="max-height: 250px"/></a></div></div>

<p>Let’s add some more columns:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> BitTest
(
	A <span class="keyword">bit</span>
	B <span class="keyword">bit</span>
	C <span class="keyword">bit</span>
	D <span class="keyword">int</span>
	E <span class="keyword">bit</span>
	F <span class="keyword">bit</span>
	G <span class="keyword">bit</span>
	H <span class="keyword">smallint</span>
	I <span class="keyword">bit</span>
	J <span class="keyword">bit</span>
	K <span class="keyword">bit</span>
)</span>
</pre></figure>

<p>The bit columns E-G’s ordinal position is after D, but they’ll continue to use the first “bit byte” until it’s full. The following diagram shows that the H smallint column is stored directly after the int column, and not until we add the 9th bit is a new bit byte added:</p>
<div class="imgwrapper" style=""><div><a href="/reading-bits-in-orcamdf/image_43.png" class="fancy"><img src="/reading-bits-in-orcamdf/image_43.png" style="max-height: 250px"/></a></div></div>

<h2 id="The_need_for_state_while_reading_bits_from_records">The need for state while reading bits from records</h2>
<p>Obviously we can’t just read one field at a time, incrementing the fixed length data offset pointer for each read, as we usually do for normal fixed length data types. We need some kind of state that will tell us which byte we’re currently reading bits from, and when to read a new bit byte. Allow me to introduce RecordReadState:</p>
<figure class="highlight csharp"><pre><span class="keyword">public</span> <span class="keyword">class</span> RecordReadState
{
	<span class="comment">// We start out having consumed all bits as none have been read</span>
	<span class="keyword">private</span> <span class="keyword">int</span> currentBitIndex = <span class="number">8</span>;
	<span class="keyword">private</span> <span class="keyword">byte</span> bits;

	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LoadBitByte</span>(<span class="keyword">byte</span> bits)
	{
		<span class="keyword">this</span>.bits = bits;
		currentBitIndex = <span class="number">0</span>;
	}

	<span class="keyword">public</span> <span class="keyword">bool</span> AllBitsConsumed
	{
		<span class="keyword">get</span> { <span class="keyword">return</span> currentBitIndex == <span class="number">8</span>; }
	}

	<span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">GetNextBit</span>()
	{
		<span class="keyword">return</span> (bits & (<span class="number">1</span> &lt;&lt; currentBitIndex++)) != <span class="number">0</span>;
	}
}
</pre></figure>

<p>RecordReadState is currently only used for handling bits, but I’ve decided on not creating a BitReadState as we may need to save further read state further along. RecordReadState holds a single byte as well as a pointer that points to the next available bit in that byte. If the byte is exhausted (currentBixIndex = 8 (0-7 being the available bits)), AllBitsConsumed will return true, indicating we need to read in a new bit byte. GetNextBit simply reads the current bit from the bit byte, after which it increases the current bit index. <a href="https://github.com/improvedk/OrcaMDF/blob/58250bef24265900b6d94ec90be41b0647508b35/src/OrcaMDF.Core.Tests/Engine/Records/RecordReadStateTests.cs" target="_blank">See the tests</a> for demonstration.</p>
<h2 id="Implementing_SqlBit">Implementing SqlBit</h2>
<p>Once we have the read state implemented, we can implement the SqlBit type:</p>
<figure class="highlight csharp"><pre><span class="keyword">public</span> <span class="keyword">class</span> SqlBit : ISqlType
{
	<span class="keyword">private</span> <span class="keyword">readonly</span> RecordReadState readState;

	<span class="keyword">public</span> <span class="title">SqlBit</span>(RecordReadState readState)
	{
		<span class="keyword">this</span>.readState = readState;
	}

	<span class="keyword">public</span> <span class="keyword">bool</span> IsVariableLength
	{
		<span class="keyword">get</span> { <span class="keyword">return</span> <span class="keyword">false</span>; }
	}

	<span class="keyword">public</span> <span class="keyword">short</span>? FixedLength
	{
		<span class="keyword">get</span>
		{
			<span class="keyword">if</span> (readState.AllBitsConsumed)
				<span class="keyword">return</span> <span class="number">1</span>;

			<span class="keyword">return</span> <span class="number">0</span>;
		}
	}

	<span class="keyword">public</span> <span class="keyword">object</span> <span class="title">GetValue</span>(<span class="keyword">byte</span>[] <span class="keyword">value</span>)
	{
		<span class="keyword">if</span>(readState.AllBitsConsumed && <span class="keyword">value</span>.Length != <span class="number">1</span>)
			<span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">"All bits consumed, invalid value length: "</span> + <span class="keyword">value</span>.Length);

		<span class="keyword">if</span> (<span class="keyword">value</span>.Length == <span class="number">1</span>)
			readState.LoadBitByte(<span class="keyword">value</span>[<span class="number">0</span>]);

		<span class="keyword">return</span> readState.GetNextBit();
	}
}
</pre></figure>

<p>SqlBit requires a read state in the constructor, which is scoped for the current record read operation. It’s important to note that the FixedLength depends on the current AllBitsConsumed value of the read state. Once all bits have been consumed, the current bit field will technically have a length of one – causing a byte to be read. If it’s zero, no bytes will be read, but GetValue will still be invoked. GetValue asserts that there are bits available in case a byte wasn’t read (value.Length == 0). If a value was read, we ask the read state to load a new bit byte, after which we can call GetNextBit to return the current bit from the read state. <a href="https://github.com/improvedk/OrcaMDF/blob/58250bef24265900b6d94ec90be41b0647508b35/src/OrcaMDF.Core.Tests/Engine/SqlTypes/SqlBitTests.cs" target="_blank">See tests of SqlBit</a>.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">May</span>
			<span class="day">10</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/parsing-dates-in-orcamdf/" title="Parsing Dates in OrcaMDF" rel="bookmark">Parsing Dates in OrcaMDF</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - Internals/">SQL Server - Internals</a>
				, 
			
				<a href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>There are several different date related data types in SQL Server. Currently <a href="/introducing-orcamdf">OrcaMDF</a> supports the three most common types: <a href="http://msdn.microsoft.com/en-us/library/bb630352.aspx" target="_blank">date</a>, <a href="http://msdn.microsoft.com/en-us/library/ms187819.aspx" target="_blank">datetime</a> &amp; <a href="http://msdn.microsoft.com/en-us/library/ms182418.aspx" target="_blank">smalldatetime</a>.</p>
<a id="more"></a>

<h2 id="Implementing_SqlDate">Implementing SqlDate</h2>
<p>The simplest of the three is date – it’s a 3 byte fixed length type that stores the number of days passed since the default value of 1900-01-01. The only tricky part is that .NET does not have any standard representation of three byte integer values, only shorts &amp; ints which are either too large or too small. Thus, to read the number of days correctly, we’ll have to perform some shift magic to get the correct number into a .NET four byte integer. Once we’ve got the date, we can just create a new default DateTime and add the number of days.</p>
<figure class="highlight csharp"><pre><span class="keyword">public</span> <span class="keyword">class</span> SqlDate : ISqlType
{
	<span class="keyword">public</span> <span class="keyword">bool</span> IsVariableLength
	{
		<span class="keyword">get</span> { <span class="keyword">return</span> <span class="keyword">false</span>; }
	}

	<span class="keyword">public</span> <span class="keyword">short</span>? FixedLength
	{
		<span class="keyword">get</span> { <span class="keyword">return</span> <span class="number">3</span>; }
	}

	<span class="keyword">public</span> <span class="keyword">object</span> <span class="title">GetValue</span>(<span class="keyword">byte</span>[] <span class="keyword">value</span>)
	{
		<span class="keyword">if</span> (<span class="keyword">value</span>.Length != <span class="number">3</span>)
			<span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">"Invalid value length: "</span> + <span class="keyword">value</span>.Length);

		<span class="comment">// Magic needed to read a 3 byte integer into .NET's 4 byte representation.</span>
		<span class="comment">// Reading backwards due to assumed little endianness.</span>
		<span class="keyword">int</span> date = (<span class="keyword">value</span>[<span class="number">2</span>] &lt;&lt; <span class="number">16</span>) + (<span class="keyword">value</span>[<span class="number">1</span>] &lt;&lt; <span class="number">8</span>) + <span class="keyword">value</span>[<span class="number">0</span>];

		<span class="keyword">return</span> <span class="keyword">new</span> DateTime(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>).AddDays(date);
	}
}
</pre></figure>

<p>You can see the <a href="https://github.com/improvedk/OrcaMDF/blob/58250bef24265900b6d94ec90be41b0647508b35/src/OrcaMDF.Core.Tests/Engine/SqlTypes/SqlDateTests.cs" target="_blank">relevant tests here</a>.</p>
<h2 id="Adding_time_–_implementing_SqlDateTime">Adding time – implementing SqlDateTime</h2>
<p>Whereas date only stores the date, datetime also stores a time factor. Datetime is stored as a fixed length 8 byte value, the first being the time part while the second is the date part. Calculating the date is done more or less the same way as in the date example, except this time it’s stored as a normal four byte integer, so it’s much easier to handle. The time part is stored as the number of clock ticks since midnight, with one tick being 1/300th of a second. To represent the tick value, we first define a constant with the value 10d/3d.</p>
<p>All time values are actually stored in the same integer time value, so to access the individual values, we’ll need to perform some division &amp; modulus.</p>
<table>
<thead>
<tr>
<th>Part</th>
<th>Calculations</th>
</tr>
</thead>
<tbody>
<tr>
<td>Hours</td>
<td>X / 300 / 60 / 60</td>
</tr>
<tr>
<td>Minutes</td>
<td>X / 300 / 60 % 60</td>
</tr>
<tr>
<td>Seconds</td>
<td>X / 300 % 60</td>
</tr>
<tr>
<td>Milliseconds</td>
<td>X % 300 * 10d / 3d</td>
</tr>
</tbody>
</table>
<figure class="highlight csharp"><pre><span class="keyword">public</span> <span class="keyword">class</span> SqlDateTime : ISqlType
{
	<span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">double</span> CLOCK_TICK_MS = <span class="number">10</span>d/<span class="number">3</span>d;

	<span class="keyword">public</span> <span class="keyword">bool</span> IsVariableLength
	{
		<span class="keyword">get</span> { <span class="keyword">return</span> <span class="keyword">false</span>; }
	}

	<span class="keyword">public</span> <span class="keyword">short</span>? FixedLength
	{
		<span class="keyword">get</span> { <span class="keyword">return</span> <span class="number">8</span>; }
	}

	<span class="keyword">public</span> <span class="keyword">object</span> <span class="title">GetValue</span>(<span class="keyword">byte</span>[] <span class="keyword">value</span>)
	{
		<span class="keyword">if</span> (<span class="keyword">value</span>.Length != <span class="number">8</span>)
			<span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">"Invalid value length: "</span> + <span class="keyword">value</span>.Length);

		<span class="keyword">int</span> time = BitConverter.ToInt32(<span class="keyword">value</span>, <span class="number">0</span>);
		<span class="keyword">int</span> date = BitConverter.ToInt32(<span class="keyword">value</span>, <span class="number">4</span>);

		<span class="keyword">return</span> <span class="keyword">new</span> DateTime(<span class="number">1900</span>, <span class="number">1</span>, <span class="number">1</span>, time/<span class="number">300</span>/<span class="number">60</span>/<span class="number">60</span>, time/<span class="number">300</span>/<span class="number">60</span>%<span class="number">60</span>, time/<span class="number">300</span>%<span class="number">60</span>, (<span class="keyword">int</span>)Math.Round(time%<span class="number">300</span>*CLOCK_TICK_MS)).AddDays(date);
	}
}
</pre></figure>

<p>You can see the <a href="https://github.com/improvedk/OrcaMDF/blob/58250bef24265900b6d94ec90be41b0647508b35/src/OrcaMDF.Core.Tests/Engine/SqlTypes/SqlDateTimeTests.cs" target="_blank">relevant tests here</a>.</p>
<h2 id="Last_but_not_least,_SqlSmallDateTime">Last but not least, SqlSmallDateTime</h2>
<p>Smalldatetime is brilliant when you need to store a date with limited range (~1900 - ~2079) and a precision down to one second. For most purposes, a time precision of one second is plenty, and we save a lot of space by limiting the precision and date range. A smalldatetime value takes up just 4 bytes, the first two being the number of minutes since midnight, and the last two being the number of days since the default values of 1900-1-1. The math processing done is the same as with datetime, though at a smaller scale.</p>
<table>
<thead>
<tr>
<th>Part</th>
<th>Calculation</th>
</tr>
</thead>
<tbody>
<tr>
<td>Hours</td>
<td>X / 60</td>
</tr>
<tr>
<td>Minutes</td>
<td>X % 60</td>
</tr>
</tbody>
</table>
<figure class="highlight csharp"><pre><span class="keyword">public</span> <span class="keyword">class</span> SqlSmallDateTime : ISqlType
{
	<span class="keyword">public</span> <span class="keyword">bool</span> IsVariableLength
	{
		<span class="keyword">get</span> { <span class="keyword">return</span> <span class="keyword">false</span>; }
	}

	<span class="keyword">public</span> <span class="keyword">short</span>? FixedLength
	{
		<span class="keyword">get</span> { <span class="keyword">return</span> <span class="number">4</span>; }
	}

	<span class="keyword">public</span> <span class="keyword">object</span> <span class="title">GetValue</span>(<span class="keyword">byte</span>[] <span class="keyword">value</span>)
	{
		<span class="keyword">if</span> (<span class="keyword">value</span>.Length != <span class="number">4</span>)
			<span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">"Invalid value length: "</span> + <span class="keyword">value</span>.Length);

		<span class="keyword">ushort</span> time = BitConverter.ToUInt16(<span class="keyword">value</span>, <span class="number">0</span>);
		<span class="keyword">ushort</span> date = BitConverter.ToUInt16(<span class="keyword">value</span>, <span class="number">2</span>);

		<span class="keyword">return</span> <span class="keyword">new</span> DateTime(<span class="number">1900</span>, <span class="number">1</span>, <span class="number">1</span>, time / <span class="number">60</span>, time % <span class="number">60</span>, <span class="number">0</span>).AddDays(date);
	}
}
</pre></figure>

<p>You can see the <a href="https://github.com/improvedk/OrcaMDF/blob/58250bef24265900b6d94ec90be41b0647508b35/src/OrcaMDF.Core.Tests/Engine/SqlTypes/SqlSmallDateTimeTests.cs" target="_blank">relevant tests here</a>.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">May</span>
			<span class="day">05</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/implementing-data-types-in-orcamdf/" title="Implementing Data Types in OrcaMDF" rel="bookmark">Implementing Data Types in OrcaMDF</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - Internals/">SQL Server - Internals</a>
				, 
			
				<a href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Implementing parsing support for SQL Server data types in <a href="/introducing-orcamdf">OrcaMDF</a> is a simple matter of implementing the ISqlType interface:</p>
<a id="more"></a>


<figure class="highlight csharp"><pre><span class="keyword">public</span> <span class="keyword">interface</span> ISqlType
{
	<span class="keyword">bool</span> IsVariableLength { <span class="keyword">get</span>; }
	<span class="keyword">short</span>? FixedLength { <span class="keyword">get</span>; }
	<span class="keyword">object</span> GetValue(<span class="keyword">byte</span>[] <span class="keyword">value</span>);
}
</pre></figure>

<p><em>IsVariableLength</em> returns whether this data type has a fixed length size or is variable. <em>FixedLength</em> returns the fixed length of the data type, provided that it is fixed length, otherwise it returns null. The data type parser itself does not care about the length of variable length fields, the size of the input bytes will determine that. Finally <em>GetValue</em> parses the input bytes into and converts them into a .NET object of relevant type.</p>
<h2 id="SqlInt_implementation">SqlInt implementation</h2>
<p>int is very simple as it’s fixed length and is very straight forward to convert using BitConverter:</p>
<figure class="highlight csharp"><pre><span class="keyword">public</span> <span class="keyword">class</span> SqlInt : ISqlType
{
	<span class="keyword">public</span> <span class="keyword">bool</span> IsVariableLength
	{
		<span class="keyword">get</span> { <span class="keyword">return</span> <span class="keyword">false</span>; }
	}

	<span class="keyword">public</span> <span class="keyword">short</span>? FixedLength
	{
		<span class="keyword">get</span> { <span class="keyword">return</span> <span class="number">4</span>; }
	}

	<span class="keyword">public</span> <span class="keyword">object</span> <span class="title">GetValue</span>(<span class="keyword">byte</span>[] <span class="keyword">value</span>)
	{
		<span class="keyword">if</span> (<span class="keyword">value</span>.Length != <span class="number">4</span>)
			<span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">"Invalid value length: "</span> + <span class="keyword">value</span>.Length);

		<span class="keyword">return</span> BitConverter.ToInt32(<span class="keyword">value</span>, <span class="number">0</span>);
	}
}
</pre></figure>

<p>And the related tests:</p>
<figure class="highlight csharp"><pre>[TestFixture]
<span class="keyword">public</span> <span class="keyword">class</span> SqlIntTests
{
	[Test]
	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetValue</span>()
	{
		<span class="keyword">var</span> type = <span class="keyword">new</span> SqlInt();
		<span class="keyword">byte</span>[] input;

		input = <span class="keyword">new</span> <span class="keyword">byte</span>[] { <span class="number">0x5e</span>, <span class="number">0x3b</span>, <span class="number">0x27</span>, <span class="number">0x2a</span> };
		Assert.AreEqual(<span class="number">707214174</span>, Convert.ToInt32(type.GetValue(input)));

		input = <span class="keyword">new</span> <span class="keyword">byte</span>[] { <span class="number">0x8d</span>, <span class="number">0xf9</span>, <span class="number">0xaa</span>, <span class="number">0x30</span> };
		Assert.AreEqual(<span class="number">816511373</span>, Convert.ToInt32(type.GetValue(input)));

		input = <span class="keyword">new</span> <span class="keyword">byte</span>[] { <span class="number">0x7a</span>, <span class="number">0x4a</span>, <span class="number">0x72</span>, <span class="number">0xe2</span> };
		Assert.AreEqual(-<span class="number">495826310</span>, Convert.ToInt32(type.GetValue(input)));
	}

	[Test]
	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Length</span>()
	{
		<span class="keyword">var</span> type = <span class="keyword">new</span> SqlInt();

		Assert.Throws&lt;ArgumentException&gt;(() =&gt; type.GetValue(<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">3</span>]));
		Assert.Throws&lt;ArgumentException&gt;(() =&gt; type.GetValue(<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">5</span>]));
	}
}
</pre></figure>

<h2 id="SqlNVarchar_implementation">SqlNVarchar implementation</h2>
<p>nvarchar is very simple as well – note that we return null for the length as the length varies and the ISqlType implementation must be stateless. GetValue simply converts whatever amount of input bytes it gets into the relevant .NET data type, string in this case.</p>
<figure class="highlight csharp"><pre><span class="keyword">public</span> <span class="keyword">class</span> SqlNVarchar : ISqlType
{
	<span class="keyword">public</span> <span class="keyword">bool</span> IsVariableLength
	{
		<span class="keyword">get</span> { <span class="keyword">return</span> <span class="keyword">true</span>; }
	}

	<span class="keyword">public</span> <span class="keyword">short</span>? FixedLength
	{
		<span class="keyword">get</span> { <span class="keyword">return</span> <span class="keyword">null</span>; }
	}

	<span class="keyword">public</span> <span class="keyword">object</span> <span class="title">GetValue</span>(<span class="keyword">byte</span>[] <span class="keyword">value</span>)
	{
		<span class="keyword">return</span> Encoding.Unicode.GetString(<span class="keyword">value</span>);
	}
}
</pre></figure>

<p>And the relevant test in this case:</p>
<figure class="highlight csharp"><pre>[TestFixture]
<span class="keyword">public</span> <span class="keyword">class</span> SqlNvarcharTests
{
	[Test]
	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetValue</span>()
	{
		<span class="keyword">var</span> type = <span class="keyword">new</span> SqlNVarchar();
		<span class="keyword">byte</span>[] input = <span class="keyword">new</span> <span class="keyword">byte</span>[] { <span class="number">0x47</span>, <span class="number">0x04</span>, <span class="number">0x2f</span>, <span class="number">0x04</span>, <span class="number">0xe6</span>, <span class="number">0x00</span> };

		Assert.AreEqual(<span class="string">"u0447u042fu00e6"</span>, (<span class="keyword">string</span>)type.GetValue(input));
	}
}
</pre></figure>

<h2 id="Other_implementations">Other implementations</h2>
<p>OrcaMDF currently <a href="https://github.com/improvedk/OrcaMDF/tree/2b2403c4422cc47b309857d42fb182970bbe11d8/src/OrcaMDF.Core/Engine/SqlTypes" target="_blank">supports 12 data types</a> out of the box. I’ll be covering datetime and bit later as those are a tad special compared to the rest of the current types. As the remaining types are implemented, I will be covering those too.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">May</span>
			<span class="day">03</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/introducing-orcamdf/" title="Introducing OrcaMDF" rel="bookmark">Introducing OrcaMDF</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - Internals/">SQL Server - Internals</a>
				, 
			
				<a href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I’ve been spamming Twitter the last couple of days with progress on my pet project, OrcaMDF. But what is OrcaMDF really?</p>
<a id="more"></a>

<h2 id="Miracle_Open_World_2011">Miracle Open World 2011</h2>
<p>I was invited to speak at <a href="http://mow2011.dk/" target="_blank">MOW2011</a> for the SQL Server track. Last year I got good reviews for my presentation on <a href="Dissecting_PDF_Documents_1.pdf">Dissecting PDF Documents</a>, a deep dive into the file format of PDF files. Wanting to stay in the same grove, I decided to take a look at the MDF format as it’s somewhat closer to SQL Server DBA’s than PDF files. Having almost worn my <a href="http://www.amazon.com/Microsoft%C2%AE-SQL-Server%C2%AE-2008-Internals/dp/0735626243" target="_blank">SQL Server 2008 Internals</a> book down from reading, I’ve always been interested in the internals, though I still felt like I was lacking a lot of knowledge.</p>
<h2 id="A_parser_is_born">A parser is born</h2>
<p>For my demos at MOW I wanted to at least read the records from a data page, just like the output from DBCC Page. The basic page format is well documented, and it’s not the first time I’ve taken a <a href="/deciphering-a-sql-server-data-page">deeper look</a> at pages. Surprisingly quickly, I had record parsing from data pages functioning using a hardcoded schema. Parsing a single page is fun, but really, I’d like to get all the data from a table. Restricting myself to just consider clustered tables made it simpler as it’d just be a matter of following the linked list of pages from start to end. However, that meant I’d have to parse the header as well. There’s some good information out there on the <a href="http://sqlskills.com/blogs/paul/post/Inside-the-Storage-Engine-Anatomy-of-a-page.aspx" target="_blank">anatomy of pages</a>, but everything I could find had a distinct lack of information on the actual header structure and field types.</p>
<a id="more"></a>

<p>While resorting to <a href="http://search.twitter.com/search?q=%23sqlhelp" target="_blank">#sqlhelp</a> didn’t directly help me, <a href="http://www.sqlskills.com/blogs/Kimberly/" target="_blank">Kimberly Tripp</a> was kind enough to point out that I’d probably not have any luck in finding deeper documentation out there.</p>
<div class="imgwrapper" style=""><div><a href="/introducing-orcamdf/image_29.png" class="fancy"><img src="/introducing-orcamdf/image_29.png" style="max-height: 250px"/></a></div></div>

<p>Fast forward a <em>bit</em> of patience, some help from <a href="http://search.twitter.com/search?q=%23sqlhelp" target="_blank">#sqlhelp</a> and <a href="http://twitter.com/#!/PaulRandal" target="_blank">@PaulRandal</a> in particular, I managed to reverse engineer the header format, as well as a bit more than I initially set out to do for MOW.</p>
<h2 id="Feature_outtakes">Feature outtakes</h2>
<p>With a lot of preconditions (2008 R2 format especially), these are some of the abilities OrcaMDF currently possesses:</p>
<ul>
<li>Parsing data, GAM, SGAM, IAM, PFS, TextMix, clustered index and and the boot page (preliminary).</li>
<li>Scanning linked pages.</li>
<li>Scanning clustered indexes, either by depth-first into linked-page scan or by forced use of the b-tree structure.</li>
<li>Scanning heaps using IAM chains.</li>
<li>Scanning tables (clustered or heaps) using just the table name as input – root IAM/index page is found through metadata lookup.</li>
<li>Able to parse the following column types: bigint, binary, bit, char, datetime, int, nchar, nvarchar, smallint, tinyint, varbinary &amp; varchar. Adding remaining types is straightforward.</li>
<li>Parsing of four crucial system tables: sysallocunits, sysschobjs, sysrowsets, sysrowsetcolumns.</li>
<li>Parsing of key metadata like table names, types and columns.</li>
</ul>
<p>There’s probably some errors here and there, and I’ve liberally ignored some complexity here and there thus far, so don’t expect this to work on everything yet. I’m continuing development of OrcaMDF. My hope is to have it support 95+% of typically used features, allowing most MDF files to be parsed. If you have a specific use case or scenario you’d like covered, please get in touch and let me know.</p>
<h2 id="Why_oh_why_are_you_doing_this?">Why oh why are you doing this?</h2>
<p>I thought I understood most of what I  read about internals. I can now tell you, I did not. Actually parsing this stuff has taught me so much more, as well as given me a really good hands-on understanding of the internals. I’ve still never touched SSIS, SSAS, SSRS and all of that other fancy BI stuff, but I believe having a solid understanding of the internals will make the later stuff so much easier to comprehend.</p>
<p>Furthermore, I think there’s a big opportunity for a number of community supported SQL Server tools to arise. Some possibilities that come to mind (just thinking aloud here, don’t take it too concretely):</p>
<ul>
<li>Easily distributable read-only access to MDF files to desktops, mobile &amp; embedded clients.</li>
<li>Disaster recovery – forgot to backup and can’t restore your corrupt DB? You might just be able to extract important bits using OrcaMDF.</li>
<li>Need to probe the contents of a DB without attaching it to an instance?</li>
<li>Reading .BAK files – should be possible, will allow single-table restores and object level probing of backup files.</li>
<li>DBCC CHECKDB of non-attached MDF files – this is probably not going to happen, but theoretically possible.</li>
<li>Learning opportunities.</li>
</ul>
<p>By opening up the code to everybody, this should provide some solid teaching and learning opportunities by looking at samples of how to actually parse the contents and not just read &amp; talk about it.</p>
<h2 id="Alright,_alright,_show_me_the_codez!">Alright, alright, show me the codez!</h2>
<p>All source code is <a href="https://github.com/improvedk/OrcaMDF" target="_blank">available on GitHub</a> under the GPLv3 license. Feel free to fork, watch or comment. The only thing I ask for is that you respect the license. If you end up trying out the code or actually using it, please let me know – I’d love to hear about it. Want to follow the latest developments – why don’t you <a href="http://twitter.com/#!/improvedk" target="_blank">come over and say hi</a>?</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">May</span>
			<span class="day">03</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/my-pass-summit-2011-abstracts/" title="My PASS Summit 2011 Abstracts" rel="bookmark">My PASS Summit 2011 Abstracts</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Last year I went on a marathon conference trip, starting out in LA at <a href="http://2010.max.adobe.com/" target="_blank">Adobe Max</a>, continuing on to <a href="http://qconsf.com/sf2010/" target="_blank">QCon</a> in San Francisco before finally ending up in lovely Seattle for the <a href="http://www.sqlpass.org/summit/na2010/" target="_blank">PASS Summit</a>.</p>
<a id="more"></a>

<div class="imgwrapper" style=""><div><a href="/my-pass-summit-2011-abstracts/71624_444201957306_724027306_5893683_5375463_n_2.jpg" class="fancy"><img src="/my-pass-summit-2011-abstracts/71624_444201957306_724027306_5893683_5375463_n_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Of the three, the one I’ll definitely be returning to this year is the PASS Summit. Last year I had the honor of getting a nice neon green “FIRST-TIMER” snippet on my badge, a snippet I wore with honor. This year however, I’m aiming for the Alumni snippet, and perhaps even the speaker snippet by submitting a couple of abstracts.</p>
<p>As I’ve been somewhat busy with <a href="/introducing-orcamdf">OrcaMDF</a> in my spare time recently, both of my abstracts use OrcaMDF as the origin for going into the internals. I really hope I get a chance to present about this as I’m super psyched about it :)</p>
<h2 id="Knowing_the_Internals_–_Who_Needs_SQL_Server_Anyway?">Knowing the Internals – Who Needs SQL Server Anyway?</h2>
<p>You’re stuck on a remote island with just a laptop and your main database .MDF file. The boss calls and asks you to retrieve some data, but alas, you forgot to install SQL Server on your laptop. Luckily you have a HEX editor by your side!</p>
<p>In this level 500 deep dive session we will go into the intimate details of the MDF file format. Think using DBCC Page is pushing it? Think again! As a learning experiment, I’ve created an open source parser for MDF files, called OrcaMDF. Using the OrcaMDF parser I’ll go through the primary storage mechanisms, how to parse page headers, boot pages, internal system tables, data &amp; index records, b-tree structures as well as the supporting IAM, GAM, SGAM &amp; PFS pages.</p>
<p>Has your database suffered an unrecoverable disk corruption? This session might just be your way out! Using a corrupt &amp; unattachable MDF file, I’ll demo how to recover as much data as possible. This session is not for the faint of heart, there will be bytes!</p>
<h3 id="Why_&amp;_What?">Why &amp; What?</h3>
<p>I originally gave this presentation at <a href="http://mow2011.dk/mow2011.aspx" target="_blank">Miracle Open World 2011</a> and got some great feedback. Fueled by positive feedback I continued the development and am now at the point where I have so much content I considered doing a 3½ hour session instead. By attending this session you will not only see diagrams of internal structures on slides, you’ll actually see C# code demonstrated that parses &amp; utilizes them!</p>
<h2 id="Demystifying_Database_Metadata">Demystifying Database Metadata</h2>
<p>You know how to query sys.tables, sys.columns and perhaps even sys.system_internals_allocation_units to discover the metadata contents of a database. But where are these views getting their data from, and how do the core system tables relate?</p>
<p>Based on my work with OrcaMDF, an open source C# parser for MDF files, I will demonstrate how to parse the internal system tables. Using just the boot page as origin, we’ll discover how to traverse the chain of references that ultimately end up in references to the actual system table data, from where we can parse the data records.</p>
<p>Once we’ve got the system table data, I’ll demonstrate how to correlate the different tables to end up with the data we see in common system views.</p>
<h3 id="Why_&amp;_What?-1">Why &amp; What?</h3>
<p>As I continued the development of OrcaMDF I used the various system views extensively – sys.objects, tables, columns, indexes, internals_allocation_units etc. However, as development moved forward and I needed to parse that metadata myself, I had to look into the underlying tables – sysallocunits, sysschobjs, sysrowsets, sysrowsetcolumns. Join this session and let’s enter the realm of the hidden metadata and let’s explore it together!</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Apr</span>
			<span class="day">28</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/converting-page-pointers-into-a-human-readable-format/" title="Converting Page Pointers Into a Humanly Readable Format" rel="bookmark">Converting Page Pointers Into a Humanly Readable Format</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - Internals/">SQL Server - Internals</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I often like to spend my weekends perusing the sys.system_internals_allocation_units table, looking for the remnants of Frodo and his crew. In the sys.system_internals_allocation_units there are several references to relevant pages:</p>
<a id="more"></a>


<figure class="highlight sql"><pre><span class="operator"><span class="keyword">select</span>
	first_page,
	root_page,
	first_iam_page
<span class="keyword">from</span>
	sys.system_internals_allocation_units</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/converting-page-pointers-into-a-human-readable-format/image_2.png" class="fancy"><img src="/converting-page-pointers-into-a-human-readable-format/image_2.png" style="max-height: 250px"/></a></div></div>

<p>Once you get used to reading these pointers, it becomes rather trivial – byte swap the last two pointers to get the file ID (0 or 1 in all of the above rows), and byte swap the first four bytes to get the page ID. To make it a bit more easier for myself and for those who do not read HEX natively, I’ve made a simple function to convert the pointers into a more easily read format.</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">create</span> function getPageLocationFromPointer
(
	@Pointer binary(<span class="number">6</span>)
)
returns <span class="keyword">varchar</span>(<span class="number">17</span>)
<span class="keyword">begin</span>

	return 
		<span class="string">'('</span> + 
		<span class="keyword">cast</span>(
			<span class="keyword">cast</span>(
				substring(@Pointer, <span class="number">6</span>, <span class="number">1</span>) +
				substring(@Pointer, <span class="number">5</span>, <span class="number">1</span>)
				<span class="keyword">as</span> <span class="keyword">smallint</span>
			) <span class="keyword">as</span> <span class="keyword">varchar</span>
		) +
		<span class="string">':'</span> +
		<span class="keyword">cast</span>(
			<span class="keyword">cast</span>(
				substring(@Pointer, <span class="number">4</span>, <span class="number">1</span>) +
				substring(@Pointer, <span class="number">3</span>, <span class="number">1</span>) +
				substring(@Pointer, <span class="number">2</span>, <span class="number">1</span>) +
				substring(@Pointer, <span class="number">1</span>, <span class="number">1</span>)
				<span class="keyword">as</span> <span class="keyword">int</span>
			) <span class="keyword">as</span> <span class="keyword">varchar</span>
		) +
		<span class="string">')'</span>

<span class="keyword">end</span></span>
</pre></figure>

<p>While not beautiful, it is rather simple. The result:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">select</span>
	first_page,
	dbo.getPageLocationFromPointer(first_page) <span class="keyword">as</span> first_page_location,
	root_page,
	dbo.getPageLocationFromPointer(root_page) <span class="keyword">as</span> root_page_location,
	first_iam_page,
	dbo.getPageLocationFromPointer(first_iam_page) <span class="keyword">as</span> first_iam_page_location
<span class="keyword">from</span>
	sys.system_internals_allocation_units</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/converting-page-pointers-into-a-human-readable-format/image_4.png" class="fancy"><img src="/converting-page-pointers-into-a-human-readable-format/image_4.png" style="max-height: 250px"/></a></div></div>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>


<div class="paging">
	<a href="/page/11/"><div class="past">« Past</div></a>
	<a href="/page/9/"><div class="future">Future »</div></a>
	<div class="clear"></div>
</div>

				</div>
			</div>

			<div id="asides">
				<div class="categories aside">
					<span class="sectiontitle">CATEGORIES</span>
					<ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/category/.NET/">.NET</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/AS/Flex/Flash/">AS/Flex/Flash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Amazon Web Services/">Amazon Web Services</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Computer Science/">Computer Science</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Conferences and Presenting/">Conferences and Presenting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/IIS/">IIS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Life/">Life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Miscellaneous/">Miscellaneous</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Performance/">Performance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Poker/">Poker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server/">SQL Server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Community/">SQL Server - Community</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Data Types/">SQL Server - Data Types</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Internals/">SQL Server - Internals</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Optimization/">SQL Server - Optimization</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Tricks/">SQL Server - Tricks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Testing/">Testing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Tools of the Trade/">Tools of the Trade</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Umbraco/">Umbraco</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Visual Studio/">Visual Studio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Web/">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windbg/">Windbg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windows/">Windows</a></li></ul>

					
				</div>

				<div class="archive aside">
					<span class="sectiontitle">ARCHIVE</span>
					<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archive/2014">2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2013">2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2012">2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2011">2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2010">2010</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2009">2009</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2008">2008</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2007">2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2006">2006</a></li></ul>
				</div>
			</div>

			<div class="clear"></div>
		</div>
		
		<footer>
			<div class="wrapper">Copyright &copy; 2014 Mark S. Rasmussen</div>
		</footer>

		<script type="text/javascript">
			$(function () {
				// Show mobile menu
				$("li.navicon").click(function () {
					if ($("header ul.mobile a").length == 0) {
						// Pages
						$mobilePages = $("div#naviconcontent ul.pages");
						$("header nav ul.normal > li").not(".navicon").each(function (i, el) {
							$mobilePages.append($(el).clone());
						});

						// Categories
						$mobileCategories = $("div#naviconcontent ul.categories");
						$("div#asides div.categories > ul > li").each(function (i, el) {
							$mobileCategories.append($(el).clone());
						});

						// Archive
						$mobileArchive = $("div#naviconcontent ul.archive");
						$("div#asides div.archive > ul > li").each(function (i, el) {
							$mobileArchive.append($(el).clone());
						});
					};

					$("header ul.mobile").toggle();
				});

				// Fancybox setup
				$("a.fancy").fancybox({
					hideOnContentClick: true,
					overlayShow: true
				});
			});
		</script>
	</body>
</html>