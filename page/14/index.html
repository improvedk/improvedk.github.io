<!DOCTYPE html>
<html>
	

<head>
	<title>Mark S. Rasmussen</title>
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
	<meta charset="UTF-8" />
	<meta property="og:locale" content="en_US" />
	<meta property="og:type" content="website" />
	<meta name="google-site-verification" content="alt7-wfK3ZujMQ4D0jYNd0yC5LGetGdqBlBmZsqQlVw" />
	<meta content="article" property="og:type">
<meta content="Mark S. Rasmussen" property="og:title">
<meta content="http://improve.dk/page/14/" property="og:url">
<meta property="og:image">
<meta content="Mark S. Rasmussen" property="og:site_name">
<meta property="og:description">
<meta content="summary" name="twitter:card">
	<link rel="alternative" href="http://feeds.feedburner.com/Improvedk" title="Mark S. Rasmussen" type="application/atom+xml">
	<script src="/js/combined.js"></script>
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-2479580-1', 'improve.dk');
		ga('require', 'displayfeatures');
		ga('send', 	'pageview');
	</script>
	<link rel="stylesheet" href="/css/style.css" type="text/css" />
</head>
	<body>
		<div id="headerline"></div>
	
		<header>
			<div class="wrapper">
				<div id="title">
					<a href="/">Mark S. Rasmussen</a> <span>improve.dk</span>
				</div>
				
				<nav>
					<ul class="normal">
						<li class="navicon"></li>
						<li><a href="/about-me/">About Me</a></li>
					</ul>
				</nav>
				
				<ul id="sharing">
					<li><a href="mailto:mark@improve.dk" id="shareat"></a></li>
					<li><a href="http://feeds.feedburner.com/Improvedk" id="rssfeed"></a></li>
					<li><a href="https://twitter.com/improvedk" id="sharetwitter"></a></li>
					<li><a href="https://github.com/improvedk" id="sharegithub"></a></li>
					<li><a href="https://www.linkedin.com/in/markrasmussen/" id="sharelinkedin"></a></li>
				</ul>

				<div class="clear"></div>
				
				<div id="naviconcontent">
					<ul class="mobile">
						<li>
							Pages
							<ul class="pages"></ul>
						</li>
						<li>
							Categories
							<ul class="categories"></ul>
						</li>
						<li>
							Archive
							<ul class="archive"></ul>
						</li>
					</ul>
				</div>
			</div>
		</header>

		<div id="mainwrapper">
			<div id="contentwrapper">
				<div id="content">
				
					
	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Apr</span>
			<span class="day">29</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/implementing-a-simple-genetic-algorithm/" title="Implementing a Simple Genetic Algorithm" rel="bookmark">Implementing a Simple Genetic Algorithm</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>In this blog post I’ll give a quick introduction to what <a href="http://en.wikipedia.org/wiki/Genetic_algorithm" target="_blank">genetic algorithms</a> are and what they can be used for. We’ll implement a genetic algorithm that attempts to guess an RGB color by evolving upon a random set of initial guesses, until it at some point evolves into the correct RGB value.</p>
<a id="more"></a>

<h2 id="What_are_genetic_algorithms?">What are genetic algorithms?</h2>
<p>Contrary to other types of algorithms, genetic algorithms do not have a clear path of improvement for solution candidiates, and it’s not an exhaustive search. A genetic algorithm requires a few base components:</p>
<ul>
<li>A representation of a candidate solutions.</li>
<li>A way of calculating the correctness of a candidate solution, commonly referred to as the fitness function.</li>
<li>A mutation function that changes a candidate solution slightly, in an attempt to obtain a better candidate.</li>
</ul>
<p>There are many different ways of implementing genetic algorithms, and there are usually many variables to adjust in a genetic algorithm. How large should the initial population be? How many solutions survives each generation? How do the survivors reproduce? In reproduction, does each survivor give birth to a single child, or multiple? As is noticeable from the terminology, genetic algorithms closely simulate biology.</p>
<h2 id="The_building_blocks">The building blocks</h2>
<p>What we’re trying to accomplish with this demo implementation, is to guess a random RGB value. The RGB values are stored in what is basically a triple class. The only added functionality is an override of the ToString function to make it easier for us to print the solution candidates.</p>
<figure class="highlight csharp"><pre>class Rgb
{
	<span class="keyword">internal</span> <span class="keyword">int</span> R { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	<span class="keyword">internal</span> <span class="keyword">int</span> G { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	<span class="keyword">internal</span> <span class="keyword">int</span> B { <span class="keyword">get</span>; <span class="keyword">set</span>; }

	<span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">string</span> <span class="title">ToString</span>()
	{
		<span class="keyword">return</span> <span class="keyword">string</span>.Format(<span class="string">"({0}, {1}, {2})"</span>, R, G, B);
	}
}
</pre></figure>

<p>Next up, we have an interface that represents a basic chromosome. In this implementation, a chromosome is basically a candidate solution. The chromosome is also the type that implements the fitness function, to evaluate it’s own correctness. The fitness is returned as an arbitrary double value, the higher the value the better a candidate. The ChromosomeValue property is the actual value being tested - in this case, an instance of Rgb.</p>
<figure class="highlight csharp"><pre><span class="keyword">interface</span> IChromosome&lt;T&gt;
{
	<span class="keyword">double</span> Fitness { <span class="keyword">get</span>; }
	T ChromosomeValue { <span class="keyword">get</span>; }
}
</pre></figure>

<h2 id="Template_based_genetic_algorithm">Template based genetic algorithm</h2>
<p>I’ve implemented the genetic algorithm using the <a href="http://www.dofactory.com/Patterns/PatternTemplate.aspx" target="_blank">template pattern</a> for easy customization and implementation of the algorithm. The algorithm itself is an abstract generic class. This means we have to subtype it before we can use it, a requirement due to the abstract template based implementation.</p>
<figure class="highlight csharp"><pre><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> GeneticAlgorithm&lt;T&gt;
</pre></figure>

<p>There’s a number of properties that are rather self explanatory, given the commenting.</p>
<figure class="highlight csharp"><pre><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
<span class="comment"><span class="xmlDocTag">///</span> This is the amount of chromosomes that will be in the population at any generation.</span>
<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
<span class="keyword">protected</span> <span class="keyword">int</span> ChromosomePopulationSize;

<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
<span class="comment"><span class="xmlDocTag">///</span> This is the number of chromosomes that survive each generation, after which they're mutated.</span>
<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
<span class="keyword">protected</span> <span class="keyword">int</span> GenerationSurvivorCount;

<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
<span class="comment"><span class="xmlDocTag">///</span> This list holdes the chromosomes of the current population.</span>
<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
<span class="keyword">protected</span> IList&lt;IChromosome&lt;T&gt;&gt; ChromosomePopulation;

<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
<span class="comment"><span class="xmlDocTag">///</span> This is the current generation number. Incremented each time a new generation is made.</span>
<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
<span class="keyword">public</span> <span class="keyword">int</span> CurrentGenerationNumber;

<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
<span class="comment"><span class="xmlDocTag">///</span> This is the current generation population.</span>
<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
<span class="keyword">public</span> IEnumerable&lt;IChromosome&lt;T&gt;&gt; CurrentGenerationPopulation
{
	<span class="keyword">get</span> { <span class="keyword">return</span> ChromosomePopulation.AsEnumerable(); }
}
</pre></figure>

<p>The constructor takes in two parameters, the size of the population at any given generation, as well as the number of survivors when an evolution is performed - and a new generation is created, based on the survivors of the old generation.</p>
<p>Lastly, we set the current generation as generation number 1, and then we call createInitialChromosomes to instantiate the initial generation 1 population.</p>
<figure class="highlight csharp"><pre><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
<span class="comment"><span class="xmlDocTag">///</span> Initializes the genetic algorithm by evolving the initial generation of chromosomes.</span>
<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="chromosomePopulationSize"&gt;</span>The size of any generation.<span class="xmlDocTag">&lt;/param&gt;</span></span>
<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="generationSurvivorCount"&gt;</span>The number of chromosomes to survive the evolution of a generation.<span class="xmlDocTag">&lt;/param&gt;</span></span>
<span class="keyword">public</span> <span class="title">GeneticAlgorithm</span>(<span class="keyword">int</span> populationSize, <span class="keyword">int</span> generationSurvivorCount)
{
	<span class="keyword">if</span> (generationSurvivorCount &gt;= populationSize)
		<span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">"The survival count of a generation must be smaller than the population size. Otherwise the population will become stagnant"</span>);

	<span class="keyword">if</span> (generationSurvivorCount &lt; <span class="number">2</span>)
		<span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">"Where would we be today if either Adam or Eve were alone?"</span>);

	ChromosomePopulationSize = populationSize;
	GenerationSurvivorCount = generationSurvivorCount;

	<span class="comment">// Create initial population and set generation</span>
	CurrentGenerationNumber = <span class="number">1</span>;
	createInitialChromosomes();
}
</pre></figure>

<p>The createInitialChromosome initializes the ChromosomePopulation list, and then it’ll continue adding new chromosomes to it until the current population reaches the specified ChromosomePopulationSize. The initial random chromosomes are returned from the CreateInitialRandomChromosome function.</p>
<figure class="highlight csharp"><pre><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
<span class="comment"><span class="xmlDocTag">///</span> Creates the initial population of random chromosomes.</span>
<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
<span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createInitialChromosomes</span>()
{
	ChromosomePopulation = <span class="keyword">new</span> List&lt;IChromosome&lt;T&gt;&gt;();

	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ChromosomePopulationSize; i++)
		ChromosomePopulation.Add(CreateInitialRandomChromosome());
}
</pre></figure>

<p>There are three abstract methods that must be implemented by any subclass, CreateInitialRandomChromosome being one of them. I’ll go over the actual implementations later on.</p>
<figure class="highlight csharp"><pre><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
<span class="comment"><span class="xmlDocTag">///</span> Creates an arbitrary number of mutated chromosomes, based on the input chromosome.</span>
<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
<span class="keyword">protected</span> <span class="keyword">abstract</span> IEnumerable&lt;IChromosome&lt;T&gt;&gt; <span class="title">Mutate</span>(IChromosome&lt;T&gt; chromosome);

<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
<span class="comment"><span class="xmlDocTag">///</span> Creates a single random chromosome for the initial chromosome population.</span>
<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
<span class="keyword">protected</span> <span class="keyword">abstract</span> IChromosome&lt;T&gt; <span class="title">CreateInitialRandomChromosome</span>();

<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
<span class="comment"><span class="xmlDocTag">///</span> Selects the surviving chromosomes of the current generation.</span>
<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>Returns a list of survivors of the current generation.<span class="xmlDocTag">&lt;/returns&gt;</span></span>
<span class="keyword">protected</span> <span class="keyword">abstract</span> IEnumerable&lt;IChromosome&lt;T&gt;&gt; <span class="title">GetGenerationSurvivors</span>();
</pre></figure>

<p>The last method that’s implemented in the abstract GeneticAlgorithm class is PerformEvolution. PerformEvolution will create a new population for the next generation. First the survivors of the old generation are selected by calling the GetGenerationSurvivors method, which is to be implemented by a subclass. All survivors of the old generation are automatically added to the new generation population.</p>
<p>Then we’ll select a random survivor based on an weighted average of their fitness. The randomly selected survivor will be mutated, and the result of the mutation is added to the new generation population. The Mutate function may return an arbitrary number of results, so technically a single survivor could be the parent of all children in the new generation.</p>
<p>Finally we set the current population and increment the generation number.</p>
<figure class="highlight csharp"><pre><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
<span class="comment"><span class="xmlDocTag">///</span> Performs an evolution by picking up the generation survivors and mutating them.</span>
<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PerformEvolution</span>()
{
	IList&lt;IChromosome&lt;T&gt;&gt; newGeneration = <span class="keyword">new</span> List&lt;IChromosome&lt;T&gt;&gt;();

	<span class="comment">// Get the survivors of the last generation</span>
	IEnumerable&lt;IChromosome&lt;T&gt;&gt; survivors = GetGenerationSurvivors();

	<span class="comment">// Add the survivors of the previous generation</span>
	<span class="keyword">foreach</span> (<span class="keyword">var</span> survivor <span class="keyword">in</span> survivors)
		newGeneration.Add(survivor);

	<span class="comment">// Until the population is full, add a new mutation of any two survivors, selected by weighted random based on their fitness.</span>
	Random rnd = <span class="keyword">new</span> Random();

	<span class="keyword">while</span> (newGeneration.Count &lt; ChromosomePopulationSize)
	{
		<span class="comment">// Get two random survivors, weighted random sort based on fitness</span>
		<span class="keyword">var</span> randomSurvivor = survivors
			.OrderBy(c =&gt; rnd.NextDouble() * c.Fitness)
			.First();

		<span class="keyword">foreach</span> (<span class="keyword">var</span> offspring <span class="keyword">in</span> Mutate(randomSurvivor))
		{
			<span class="keyword">if</span> (newGeneration.Count == ChromosomePopulationSize)
				<span class="keyword">break</span>;

			newGeneration.Add(offspring);
		}
	}

	<span class="comment">// Overwrite current population</span>
	ChromosomePopulation = newGeneration;

	<span class="comment">// Increment the current generation</span>
	CurrentGenerationNumber++;
}
</pre></figure>

<h2 id="The_rgb_guessing_implementation">The rgb guessing implementation</h2>
<p>The actual implementation is a class inheriting from GeneticAlgorithm, specifying Rgb as the generic type we’ll be working with.</p>
<figure class="highlight csharp"><pre><span class="class"><span class="keyword">class</span> <span class="title">RgbGuesser</span> : <span class="title">GeneticAlgorithm</span><span class="inheritance">&lt;<span class="parent">Rgb</span></span>&gt;</span>
</pre></figure>

<p>The constructor just calls the base class directly, specifying the population size to be 100, and that there should be 10 survivors of each generation.</p>
<figure class="highlight csharp"><pre><span class="keyword">public</span> <span class="title">RgbGuesser</span>()
	: <span class="title">base</span>(100, 10)
{ }
</pre></figure>

<p>The CreateInitialRandomChromosome method just returns a new Rgb instance with random R, G and B vlaues between 1 and 255.</p>
<figure class="highlight csharp"><pre><span class="keyword">protected</span> <span class="keyword">override</span> IChromosome&lt;Rgb&gt; <span class="title">CreateInitialRandomChromosome</span>()
{
	<span class="keyword">return</span> <span class="keyword">new</span> RgbChromosome(random.Next(<span class="number">1</span>, <span class="number">256</span>), random.Next(<span class="number">1</span>, <span class="number">256</span>), random.Next(<span class="number">1</span>, <span class="number">256</span>));
}
</pre></figure>

<p>I’ve implemented an optimization that makes sure the most fit candidate chromosome is always included in the survivors of each generation. This’ll make sure we’ll never have a new generation with a worse candidate solution that the last.</p>
<p>After returning the top candidate, we then return the remaining candidates based on a weighted random selection of the remaining population. The reason why we’re not just returning the “top GenerationSurvivorCount” chromosomes is to avoid <a href="http://en.wikipedia.org/wiki/Genetic_algorithm" target="_blank">premature convergence</a>. Premature convergence is basically a fancy way to describe inbreeding. When our gene pool diversity is limited, so is the range of candidates that may come out of it. It’s not a really big issue in the RGB guessing implementation, but premature convergence can be a big issue in other implementations - especially depending on the mutation implementation.</p>
<figure class="highlight csharp"><pre><span class="keyword">protected</span> <span class="keyword">override</span> IEnumerable&lt;IChromosome&lt;Rgb&gt;&gt; <span class="title">GetGenerationSurvivors</span>()
{
	<span class="comment">// Return the best chromosome</span>
	<span class="keyword">var</span> topChromosome = <span class="keyword">this</span>.ChromosomePopulation
		.OrderByDescending(c =&gt; c.Fitness)
		.First();

	<span class="comment">// Return the remaining chromosomes from the pool</span>
	<span class="keyword">var</span> survivors = <span class="keyword">this</span>.ChromosomePopulation
		.Where(c =&gt; c != topChromosome)
		.OrderByDescending(c =&gt; random.NextDouble() * c.Fitness)
		.Take(<span class="keyword">this</span>.GenerationSurvivorCount - <span class="number">1</span>);

	<span class="keyword">yield</span> <span class="keyword">return</span> topChromosome;

	<span class="keyword">foreach</span> (<span class="keyword">var</span> survivor <span class="keyword">in</span> survivors)
		<span class="keyword">yield</span> <span class="keyword">return</span> survivor;
}
</pre></figure>

<p>The final method to implement is the Mutate method. This is the one that’s responsible for mutating a survivor into a new candidate solution that’ll hopefully be better than the last. The implementation is really simple. We just make a new RgbChromosome and set it’s R, G and B values to the same value as the parent chromosome, added a random value between -5 and 5. The Math.Max and Math.Min juggling is to avoid negative and 255+ values.</p>
<figure class="highlight csharp"><pre>protected override IEnumerable&lt;IChromosome&lt;Rgb&gt;&gt; Mutate(IChromosome&lt;Rgb&gt; chromosome)
{
	RgbChromosome mutation = new RgbChromosome(chromosome<span class="preprocessor">.ChromosomeValue</span><span class="preprocessor">.R</span>, chromosome<span class="preprocessor">.ChromosomeValue</span><span class="preprocessor">.G</span>, chromosome<span class="preprocessor">.ChromosomeValue</span><span class="preprocessor">.B</span>)<span class="comment">;</span>
	mutation<span class="preprocessor">.ChromosomeValue</span><span class="preprocessor">.R</span> = Math<span class="preprocessor">.Min</span>(<span class="number">255</span>, Math<span class="preprocessor">.Max</span>(<span class="number">0</span>, mutation<span class="preprocessor">.ChromosomeValue</span><span class="preprocessor">.R</span> + random<span class="preprocessor">.Next</span>(-<span class="number">5</span>, <span class="number">6</span>)))<span class="comment">;</span>
	mutation<span class="preprocessor">.ChromosomeValue</span><span class="preprocessor">.G</span> = Math<span class="preprocessor">.Min</span>(<span class="number">255</span>, Math<span class="preprocessor">.Max</span>(<span class="number">0</span>, mutation<span class="preprocessor">.ChromosomeValue</span><span class="preprocessor">.G</span> + random<span class="preprocessor">.Next</span>(-<span class="number">5</span>, <span class="number">6</span>)))<span class="comment">;</span>
	mutation<span class="preprocessor">.ChromosomeValue</span><span class="preprocessor">.B</span> = Math<span class="preprocessor">.Min</span>(<span class="number">255</span>, Math<span class="preprocessor">.Max</span>(<span class="number">0</span>, mutation<span class="preprocessor">.ChromosomeValue</span><span class="preprocessor">.B</span> + random<span class="preprocessor">.Next</span>(-<span class="number">5</span>, <span class="number">6</span>)))<span class="comment">;</span>

	yield return mutation<span class="comment">;</span>
}
</pre></figure>

<h2 id="The_RgbChromosome">The RgbChromosome</h2>
<p>The final class is the one implementing the IChromosome interface.</p>
<figure class="highlight csharp"><pre><span class="class"><span class="keyword">class</span> <span class="title">RgbChromosome</span> : <span class="title">IChromosome</span><span class="inheritance">&lt;<span class="parent">Rgb</span></span>&gt;</span>
</pre></figure>

<p>In this case I’ve hardcoded a target RGB value that we wish to guess. Note that this is only for demonstrations sake - usually in genetic algorithms we don’t know the “answer” and will therefor have to base the fitness function on a set of rules that evaluate the fitness of the candidate.</p>
<figure class="highlight csharp"><pre><span class="keyword">private</span> <span class="built_in">Rgb</span> targetRgb = <span class="keyword">new</span> <span class="built_in">Rgb</span> { R = <span class="number">127</span>, G = <span class="number">240</span>, B = <span class="number">50</span> };
</pre></figure>

<p>The fitness function calculates the total difference in RGB values and subtracts that from the maximum difference. As a result, we get a fitness value with lower values indicating a worse solution.</p>
<figure class="highlight csharp"><pre><span class="keyword">public</span> <span class="keyword">double</span> Fitness
{
	<span class="keyword">get</span>
	{
		<span class="keyword">int</span> maxDiff = <span class="number">255</span> * <span class="number">3</span>;

		<span class="keyword">int</span> rDiff = Math.Abs(chromosome.R - targetRgb.R);
		<span class="keyword">int</span> gDiff = Math.Abs(chromosome.G - targetRgb.G);
		<span class="keyword">int</span> bDiff = Math.Abs(chromosome.B - targetRgb.B);
		<span class="keyword">int</span> totalDiff = rDiff + gDiff + bDiff;

		<span class="keyword">return</span> maxDiff - totalDiff;
	}
}
</pre></figure>

<p>Here is the full IChromosome implementation:</p>
<figure class="highlight csharp"><pre>class RgbChromosome : IChromosome&lt;Rgb&gt;
{
	<span class="keyword">private</span> Rgb targetRgb = <span class="keyword">new</span> Rgb { R = <span class="number">127</span>, G = <span class="number">240</span>, B = <span class="number">50</span> };
	<span class="keyword">private</span> Rgb chromosome;

	<span class="keyword">public</span> <span class="title">RgbChromosome</span>(<span class="keyword">int</span> r, <span class="keyword">int</span> g, <span class="keyword">int</span> b)
	{
		<span class="keyword">this</span>.chromosome = <span class="keyword">new</span> Rgb { R = r, G = g, B = b };
	}

	<span class="keyword">public</span> <span class="keyword">double</span> Fitness
	{
		<span class="keyword">get</span>
		{
			<span class="keyword">int</span> maxDiff = <span class="number">255</span> * <span class="number">3</span>;

			<span class="keyword">int</span> rDiff = Math.Abs(chromosome.R - targetRgb.R);
			<span class="keyword">int</span> gDiff = Math.Abs(chromosome.G - targetRgb.G);
			<span class="keyword">int</span> bDiff = Math.Abs(chromosome.B - targetRgb.B);
			<span class="keyword">int</span> totalDiff = rDiff + gDiff + bDiff;

			<span class="keyword">return</span> maxDiff - totalDiff;
		}
	}

	<span class="keyword">public</span> Rgb ChromosomeValue
	{
		<span class="keyword">get</span> { <span class="keyword">return</span> chromosome; }
	}
}
</pre></figure>

<h2 id="Running_the_algorithm">Running the algorithm</h2>
<p>Running the algorithm is as simple as instantiating a new RgbGuesser and then calling PerformEvolution on it repeatedly. Note that there’s no built in stop criteria in the algorithm, so it’ll continue to evolve the candidates even though a perfect candidate may already have been evolved. This I’ve introduced a simple check to see whether a perfect candidate exists:</p>
<figure class="highlight csharp"><pre>if (topChromosomes<span class="preprocessor">.Where</span>(c =&gt; c<span class="preprocessor">.Fitness</span> == <span class="number">255</span> * <span class="number">3</span>)<span class="preprocessor">.Count</span>() &gt; <span class="number">0</span>)
</pre></figure>

<p>The full code can be seen below:</p>
<figure class="highlight csharp"><pre>// Setup RgbGuesser
RgbGuesser rgbGuesser = new RgbGuesser()<span class="comment">;</span>

// For each generation, write the generation number + top <span class="number">5</span> chromosomes + fitness
for (int i = <span class="number">1</span><span class="comment">; i &lt; 100000; i++)</span>
{
	Console<span class="preprocessor">.WriteLine</span>(<span class="string">"Generation: "</span> + rgbGuesser<span class="preprocessor">.CurrentGenerationNumber</span>)<span class="comment">;</span>
	Console<span class="preprocessor">.WriteLine</span>(<span class="string">"-----"</span>)<span class="comment">;</span>

	// Get top <span class="number">5</span> chromosomes
	var topChromosomes = rgbGuesser<span class="preprocessor">.CurrentGenerationPopulation</span>
		<span class="preprocessor">.OrderByDescending</span>(c =&gt; c<span class="preprocessor">.Fitness</span>)
		<span class="preprocessor">.Take</span>(<span class="number">5</span>)<span class="comment">;</span>

	// Get bottom <span class="number">5</span> chromosomes
	var bottomChromosomes = rgbGuesser<span class="preprocessor">.CurrentGenerationPopulation</span>
		<span class="preprocessor">.OrderBy</span>(c =&gt; c<span class="preprocessor">.Fitness</span>)
		<span class="preprocessor">.Take</span>(<span class="number">5</span>)<span class="comment">;</span>

	if (topChromosomes<span class="preprocessor">.Where</span>(c =&gt; c<span class="preprocessor">.Fitness</span> == <span class="number">255</span> * <span class="number">3</span>)<span class="preprocessor">.Count</span>() &gt; <span class="number">0</span>)
	{
		Console<span class="preprocessor">.WriteLine</span>()<span class="comment">;</span>
		Console<span class="preprocessor">.WriteLine</span>()<span class="comment">;</span>
		Console<span class="preprocessor">.WriteLine</span>()<span class="comment">;</span>
		Console<span class="preprocessor">.WriteLine</span>(<span class="string">"### Perfect match found at generation "</span> + rgbGuesser<span class="preprocessor">.CurrentGenerationNumber</span> + <span class="string">"!"</span>)<span class="comment">;</span>
		Console<span class="preprocessor">.Read</span>()<span class="comment">;</span>
		return<span class="comment">;</span>
	}

	// Print <span class="keyword">out</span> top <span class="number">5</span> <span class="keyword">and</span> bottom <span class="number">5</span> chromosomes
	foreach (var chromosome <span class="keyword">in</span> topChromosomes)
		Console<span class="preprocessor">.WriteLine</span>(Convert<span class="preprocessor">.ToInt</span>32(chromosome<span class="preprocessor">.Fitness</span>)<span class="preprocessor">.ToString</span>()<span class="preprocessor">.PadLeft</span>(<span class="number">3</span>) + <span class="string">": "</span> + chromosome<span class="preprocessor">.ChromosomeValue</span>)<span class="comment">;</span>
	Console<span class="preprocessor">.WriteLine</span>(<span class="string">"-----"</span>)<span class="comment">;</span>
	foreach (var chromosome <span class="keyword">in</span> bottomChromosomes<span class="preprocessor">.OrderByDescending</span>(c =&gt; c<span class="preprocessor">.Fitness</span>))
		Console<span class="preprocessor">.WriteLine</span>(Convert<span class="preprocessor">.ToInt</span>32(chromosome<span class="preprocessor">.Fitness</span>)<span class="preprocessor">.ToString</span>()<span class="preprocessor">.PadLeft</span>(<span class="number">3</span>) + <span class="string">": "</span> + chromosome<span class="preprocessor">.ChromosomeValue</span>)<span class="comment">;</span>

	Console<span class="preprocessor">.WriteLine</span>()<span class="comment">;</span>
	Console<span class="preprocessor">.WriteLine</span>()<span class="comment">;</span>

	// Homage to Charles Darwin
	rgbGuesser<span class="preprocessor">.PerformEvolution</span>()<span class="comment">;</span>
}

Console<span class="preprocessor">.WriteLine</span>(<span class="string">"Done"</span>)<span class="comment">;</span>
Console<span class="preprocessor">.ReadLine</span>()<span class="comment">;</span>
</pre></figure>

<p>Running the application should eventually result in a perfect candidate being found. If you’re lucky, you’ll find it at generation 42 :)</p>
<div class="imgwrapper" style=""><div><a href="/implementing-a-simple-genetic-algorithm/genetic_run_2.jpg" class="fancy"><img src="/implementing-a-simple-genetic-algorithm/genetic_run_2.jpg" style="max-height: 250px"/></a></div></div>

<h2 id="Doing_the_numbers">Doing the numbers</h2>
<p>There are different ways of guessing an RGB value. We could just randomly guess until we hit the correct one - with a probability of 1/(255^3).</p>
<p>We could also iterate over all 255^3 solutions, eventually hitting one. Provided the target is completely random, we should hit it after 50% of the solutions have been tested - that is, after just about 8 million tests.</p>
<p>Another more clever approach, given the fitness function would be to just increment each RGB value once and fine the point at which an increment results in a lower score - then we’ve solved one of the RGB values. Using this approach, we can solve the problem in just 255*3 number of tries at most. But really, that’s no fun!</p>
<p>Based on a quick series of tests, 50 seems to be the average max generation we’ll have to hit before we’ve guess the correct RGB value. That’s 50 generations of 100 candidates, for a total candidate count of 5000 - somewhat less than the random guessing and iterative solutions. To conclude - in this case, a genetic algorithm is far from the optimal solution, but it’s an interesting way of approaching hard-to-define problems that may not have a single optimal solution that can be calculated within a certain time restraint. In those cases genetic algorithms can be a great way of approximating a close-to-perfect solution.</p>
<h2 id="Update">Update</h2>
<p>Based on some of the comments I’ve received, I’ve posted an <a href="http://www.improve.dk/blog/2009/05/01/evolution-of-the-simple-genetic-algorithm" target="_blank">update to the genetic algorithm</a> to make it more “genetic”.</p>
<h2 id="Downloads">Downloads</h2>
<p>Sample solution code:<br><a href="GeneticTesting.zip">GeneticTesting.zip</a></p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Apr</span>
			<span class="day">24</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/txf-presentation-materials/" title="TxF presentation materials" rel="bookmark">TxF presentation materials</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Yesterday I presented on how to use Transactional NTFS (TxF) in .NET, at the <a href="http://www.cnug.dk/" target="_blank">Copenhagen .NET User Group</a>.</p>
<a id="more"></a>

<h2 id="Downloads">Downloads</h2>
<p>Slides: <a href="TxF.pptx">TxF.pptx</a><br>Materials: <a href="TxFMaterials.zip">TxFMaterials.zip</a></p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Apr</span>
			<span class="day">08</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/thoughts-on-blogging/" title="Thoughts on Blogging" rel="bookmark">Thoughts on Blogging</a></h1>
		<div class="categories">
			
				<a href="/category/Miscellaneous/">Miscellaneous</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I am hastily nearing my third year blogging at improve.dk. Before reinventing my blog, I wrote articles and tutorials at the same address, though in Danish. When I rebooted my blog I completely ditched my old material and started blogging in English. After discussing the concept of blogging a lot recently, I’ve gathered up my thoughts on the subject.</p>
<a id="more"></a>

<h2 id="Why_blog?">Why blog?</h2>
<p>I generally recommend starting a blog to all of my peers. But why do it? There’s no single answer, as it’s very much a subjective matter resulting in different goals.</p>
<p>I recently had a discussion with <a href="http://blogs.msdn.com/danielmf" target="_blank">Daniel</a> from Microsoft Denmark regarding the language of blogs, a discussion that later merged into a discussion on the topic of blogging itself. The discussion originated from a <a href="http://blogs.msdn.com/danielmf/archive/2009/03/07/n-r-du-blogger-p-dansk.aspx" target="_blank">blog post</a> of Daniels (in Danish unfortunately), on why he felt Danish people should blog in Danish. In the following <a href="http://search.twitter.com/search?q=&amp;ands=&amp;phrase=&amp;ors=&amp;nots=&amp;tag=&amp;lang=all&amp;from=improvedk&amp;to=danielovich&amp;ref=&amp;near=&amp;within=15&amp;units=mi&amp;since=2009-03-30&amp;until=2009-04-03&amp;rpp=50" target="_blank">discussion on Twitter</a>, one of Daniels tweets stood out:</p>
<blockquote><br>    <a href="http://twitter.com/Danielovich/statuses/1423952537" target="_blank">danielovich:</a><br>    Why should I write blogposts if no one wanted to read them? Then I would write a word document for myself!<br></blockquote>

<p>The above was written as answer to a statement I made on the benefits of blogging:</p>
<blockquote><br>    <a href="http://twitter.com/improvedk/statuses/1423925133" target="_blank">improvedk:</a><br>    You measure benefit only in readers! I benefit by improving my writing skill, using the blog as an incentive to learn new stuff.<br></blockquote>


<p>These quotes really show the core issue that we were debating, and at the same time explain why we will never agree. We have different goals. Neither goal is superior, though they have vastly different foundations.</p>
<p><a href="http://www.brentozar.com/" target="_blank">Brent Ozar</a> recently posted a great blog topic on <a href="http://www.brentozar.com/archive/2009/04/how-to-pick-blog-presentation-topics" target="_blank">How to Pick Blog &amp; Presentation Topics</a>. The two most important quotes, in my opinion, of Brent Ozars post are the following:</p>
<blockquote><br>    As a presenter, your job isn’t to learn things.<br>    Your job is to pass on things you’ve already learned.<br></blockquote>

<p>I absolutely agree with Brent Ozar. As a presenter, your job isn’t to learn things - it’s to pass on the things you’ve already learned. However, this begs the question, am I a presenter? Do I want to be a presenter?</p>
<p>Though I am starting to do more live presentations, I still don’t see myself as a presenter when it comes to my blog.</p>
<blockquote><br>    <a href="http://twitter.com/improvedk/statuses/1423889131" target="_blank">improvedk:</a><br>    Even if there were nobody to read my blog, I would benefit tremendously by blogging.<br></blockquote>

<p>When I blog, I do it as a means of improving my own learning ability. If I reach a level of knowledge where I’m able to share that knowledge and explain it so others can understand it, then I know that I’ve understood the material. By forcing myself to blog about new knowledge I acquire, I also force myself to fully understand it, and hence improve my ability to learn.</p>
<p>While broadening my knowledge is the primary goal of my blog, it is of course not the only one. There’s a reason I haven’t put an IP restriction on the blog, why I have an RSS feed, why I’m running Google Analytics. Of course it does provide encouragement, seeing that people actually read what I write. It does confirm to me that my secondary mission of giving something back to the community is working out. Reader, I thank thee.</p>
<h2 id="The_choice_of_language">The choice of language</h2>
<p>My native language is Danish, a language that’s quite foreign to the English speaking population of the internet. Given that there’s only about 6 million Danish speaking people in the world, it’s a basic fact that the potential reach of my blog will be humongous when written in English, compared to Danish.</p>
<p>At <a href="http://www.ipaper.dk/Default.aspx?AreaID=6" target="_blank">iPaper</a>, most of our daily communication is in English, both written and spoken. We’re an international company with partners all around the world, and we have employees at our office that don’t speak Danish at all. Thus, speaking English becomes second nature, and why not continue the trend on my blog? After all, being able to speak and write English is not a transient requirement in the industry.</p>
<p><a href="http://khebbie.dk/" target="_blank">Klaus Hebsgaard</a> had a very good <a href="http://blogs.msdn.com/danielmf/archive/2009/03/07/n-r-du-blogger-p-dansk.aspx#comments" target="_blank">comment</a> on the English vs. Danish discussion.</p>
<blockquote><br>    When I search for the solution to a problem, then I search in English through Google<br></blockquote>

<p>There are just that many more blogs in English out there, the chances of finding a result quickly diminish if I start searching in Danish. I am but a drop in the ocean, there’s a lot of extremely skilled bloggers out there with non-English native languages. I’d be very saddened if they stopped blogging in English. What great blogs am I missing out on at the moment because they’re not written in English?</p>
<p>While I compare Danish and English in this post, I believe my arguments are universal, whether it be Swedish, Hebrew, Finnish etc.</p>
<h2 id="Blogs_need_not_be_unique">Blogs need not be unique</h2>
<p>One final quote from the discussion with Daniel is perhaps the one I oppose the strongest.</p>
<blockquote><br>    <a href="http://twitter.com/Danielovich/statuses/1423874508" target="_blank">danielovich:</a><br>    Yes, if you don’t have anything unique to offer you shouldn’t even try!<br><br>    <a href="http://twitter.com/Danielovich/statuses/1423880044" target="_blank">danielovich:</a><br>    … And that’s in terms of blogging in English. It will just be pollution in the end!<br></blockquote>

<p>If your blogging goal is mostly selfish, to improve your own learning ability, then you should not care the least about the uniqueness of your content. Neither should you care about spelling, grammar etc. If you can combine your own goals with producing unique content, then that is of course the ultimate goal, just like improving spelling &amp; grammar should also be a goal itself.</p>
<p>I subscribe to a number of blogs I find interesting, it’s a way for me to keep myself up to date on what’s happening, and to ensure I read the blog entries of the people I admire. For all other content, I find it through Google. As we all know, Google is extremely good at sorting away pollution. Thus, even if your non-unique content could be perceived as pollution, <strong>it does not matter</strong>! Please do blog, if not for our sakes, then for yours!</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Apr</span>
			<span class="day">02</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/speaking-at-devlink-2009/" title="Speaking at devLink 2009" rel="bookmark">Speaking at devLink 2009</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>The <a href="http://devlink.net/Sessions/tabid/124/Default.aspx" target="_blank">session list</a> for <a href="http://devlink.net/" target="_blank">devLink 2009</a> has been announced. I’m delighted to announce that <a href="http://devlink.net/Speakers/MarkRasmussen/tabid/169/Default.aspx" target="_blank">one of my abstracts</a> was chosen - I will be speaking at devLink 2009 in Nashville, TN.</p>
<a id="more"></a>

<div class="imgwrapper" style=""><div><a href="/speaking-at-devlink-2009/devlinklogo_2.png" class="fancy"><img src="/speaking-at-devlink-2009/devlinklogo_2.png" style="max-height: 250px"/></a></div></div>

<p>I am presenting a session called “Using Network Load Balancing for Availability &amp; Scalability” - I know, original naming is not really part of my skillset. During the session, I will be introducing NLB and demoing how to set it up using a multitude of VMs (might have to get an extra 4 gigs of memory in my laptop). I will also cover some of the basic characteristics scalable &amp; available websites must possess, and how to solve the issue of reliable session state when we start to load balance our webservers - without resorting to SQL Server.</p>
<p>I look forward to attending devLink 2009, it’s an awesome list of sessions &amp; speakers! Hope to see some of you there.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Apr</span>
			<span class="day">01</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/solving-deadlocks-through-locking-hints/" title="Solving Deadlocks Through Locking Hints" rel="bookmark">Solving Deadlocks Through Locking Hints</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				, 
			
				<a href="/category/SQL Server - Optimization/">SQL Server - Optimization</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Deadlocks in any database can be a hard beast to weed out, especially since they may hide latently in your code, awaiting that specific moment when they explode. An API website, exposing a series of webservices, had been working fine for months, until I decided to run my client app with a lot more threads than usual.</p>
<a id="more"></a>

<div class="imgwrapper" style=""><div><a href="/solving-deadlocks-through-locking-hints/deadlock-hint-1_2.jpg" class="fancy"><img src="/solving-deadlocks-through-locking-hints/deadlock-hint-1_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Great. So we have a deadlock, what’s the first step in fixing it? I’ve outlined the code in PaperHandler.cs that caused the issue, though in pseudo code format:</p>
<figure class="highlight csharp"><pre>using (var ts = new TransactionScope())
{
	<span class="keyword">if</span> ((SELECT COUNT(*) FROM tblPapers WHERE Url = <span class="string">'newurl'</span>) &gt; <span class="number">0</span>)
		throw new UrlNotUniqueException();

	// <span class="keyword">...</span> Further validation checks

	INSERT INTO tblPapers <span class="keyword">...</span> // This is where the deadlock occurred
}
</pre></figure>

<p>To see how the above code may result in a deadlock, let’s test it out in SQL Server Management Studio (SSMS). Open a new query and execute the following, to create the test database &amp; schema:</p>
<figure class="highlight sql"><pre><span class="comment">-- Create new test database - change name if necessary</span>
<span class="operator"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> Test
<span class="keyword">GO</span>

USE Test

-- <span class="keyword">Create</span> the test <span class="keyword">table</span>
<span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tblPapers
(
	ID <span class="keyword">int</span> <span class="keyword">identity</span>(<span class="number">1</span>,<span class="number">1</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,
	Url nvarchar(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>
)

-- Make the ID <span class="keyword">column</span> a <span class="keyword">primary</span> clustered <span class="keyword">key</span>
<span class="keyword">ALTER</span> <span class="keyword">TABLE</span> dbo.tblPapers <span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> PK_tblPapers <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> CLUSTERED 
(
	ID <span class="keyword">ASC</span>
)
<span class="keyword">ON</span> [<span class="keyword">PRIMARY</span>]

-- <span class="keyword">Add</span> a nonclustered <span class="keyword">unique</span> index <span class="keyword">on</span> the Url <span class="keyword">column</span> <span class="keyword">to</span> ensure uniqueness
<span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> NONCLUSTERED INDEX NC_Url <span class="keyword">ON</span> tblPapers
(
	Url <span class="keyword">ASC</span>
)
<span class="keyword">ON</span> [<span class="keyword">PRIMARY</span>]</span>
</pre></figure>

<p>The tblPapers table contains a number of entities, and each of them must have a unique Url value. Therefore, before we insert a new row into tblPapers, we need to ensure that it’s going to be unique.</p>
<p>Now open two new query windows and insert the following query text into both of them:</p>
<figure class="highlight sql"><pre>USE Test

<span class="operator"><span class="keyword">SET</span> <span class="keyword">TRANSACTION</span> <span class="keyword">ISOLATION</span> <span class="keyword">LEVEL</span> SERIALIZABLE

<span class="keyword">BEGIN</span> TRAN

-- Ensure <span class="keyword">unique</span> URL
<span class="keyword">DECLARE</span> @NewUrl <span class="keyword">varchar</span>(<span class="number">128</span>);</span> <span class="operator"><span class="keyword">SET</span> @NewUrl = <span class="string">'newurl'</span>
<span class="keyword">SELECT</span> <span class="aggregate">COUNT</span>(*) <span class="keyword">FROM</span> tblPapers <span class="keyword">WHERE</span> Url = @NewUrl

-- <span class="keyword">Insert</span> <span class="keyword">row</span> <span class="keyword">if</span> above query returned <span class="number">0</span> &lt;=&gt; URL <span class="keyword">is</span> <span class="keyword">unique</span>
<span class="keyword">DECLARE</span> @NewUrl <span class="keyword">varchar</span>(<span class="number">128</span>);</span> <span class="operator"><span class="keyword">SET</span> @NewUrl = <span class="string">'newurl'</span>
<span class="keyword">INSERT</span> <span class="keyword">INTO</span> tblPapers (Url) <span class="keyword">VALUES</span> (@NewUrl)</span>
</pre></figure>

<p>In SQL Server 2005/2008, READ COMMITTED is the default transaction level - we’re being explicit about using the SERIALIZABLE isolation level, however. The reason we’re going to use the SERIALIZABLE isolation mode is that while READ COMMITTED is the default mode in SQL Server, whenever you create an implicit transaction using TransactionScope, it’s <a href="http://msdn.microsoft.com/en-us/library/ms172152.aspx" target="_blank">using the SERIALIZABLE isolation mode by default</a>!</p>
<p>Now, observe what happens if you run two queries concurrently in the following order:</p>
<h3 id="Query_A">Query A</h3>
<figure class="highlight sql"><pre>USE Test
<span class="operator"><span class="keyword">SET</span> <span class="keyword">TRANSACTION</span> <span class="keyword">ISOLATION</span> <span class="keyword">LEVEL</span> SERIALIZABLE				
<span class="keyword">BEGIN</span> TRAN</span>
</pre></figure>

<h3 id="Query_B">Query B</h3>
<figure class="highlight sql"><pre>USE Test
<span class="operator"><span class="keyword">SET</span> <span class="keyword">TRANSACTION</span> <span class="keyword">ISOLATION</span> <span class="keyword">LEVEL</span> SERIALIZABLE				
<span class="keyword">BEGIN</span> TRAN</span>
</pre></figure>

<h3 id="Query_A-1">Query A</h3>
<figure class="highlight sql"><pre><span class="comment">-- Ensure unique URL</span>
DECLARE @NewUrl varchar(128); <span class="operator"><span class="keyword">SET</span> @NewUrl = <span class="string">'newurl'</span>				
<span class="keyword">SELECT</span> <span class="aggregate">COUNT</span>(*) <span class="keyword">FROM</span> tblPapers <span class="keyword">WHERE</span> Url = @NewUrl</span>
</pre></figure>

<h3 id="Query_B-1">Query B</h3>
<figure class="highlight sql"><pre><span class="comment">-- Ensure unique URL</span>
DECLARE @NewUrl varchar(128); <span class="operator"><span class="keyword">SET</span> @NewUrl = <span class="string">'newurl'</span>				
<span class="keyword">SELECT</span> <span class="aggregate">COUNT</span>(*) <span class="keyword">FROM</span> tblPapers <span class="keyword">WHERE</span> Url = @NewUrl</span>
</pre></figure>

<h3 id="Query_A-1">Query A</h3>
<figure class="highlight sql"><pre><span class="comment">-- Insert row since URL is unique</span>
DECLARE @NewUrl varchar(128); <span class="operator"><span class="keyword">SET</span> @NewUrl = <span class="string">'newurl'</span>				
<span class="keyword">INSERT</span> <span class="keyword">INTO</span> tblPapers (Url) <span class="keyword">VALUES</span> (@NewUrl)</span>
</pre></figure>

<h3 id="Query_B-1">Query B</h3>
<figure class="highlight sql"><pre><span class="comment">-- Insert row since URL is unique</span>
DECLARE @NewUrl varchar(128); <span class="operator"><span class="keyword">SET</span> @NewUrl = <span class="string">'newurl'</span>				
<span class="keyword">INSERT</span> <span class="keyword">INTO</span> tblPapers (Url) <span class="keyword">VALUES</span> (@NewUrl)</span>
</pre></figure>

<p>After executing the last query, you should get the following error in one of the windows:</p>
<figure class="highlight"><pre>Msg <span class="number">1205</span>, Level <span class="number">13</span>, State <span class="number">47</span>, Line <span class="number">4</span>
Transaction (Process ID <span class="number">53</span>) was deadlocked <span class="function_start"><span class="keyword">on</span></span> lock resources <span class="keyword">with</span> another process <span class="keyword">and</span> has been chosen <span class="keyword">as</span> <span class="keyword">the</span> deadlock victim. Rerun <span class="keyword">the</span> <span class="keyword">transaction</span>.
</pre></figure>

<p>While in the second window, you’ll notice that the insertion went through:</p>
<figure class="highlight"><pre><span class="list">(<span class="title">1</span> row<span class="list">(<span class="title">s</span>)</span> affected)</span>
</pre></figure>

<p>What happened here is that the two transactions get locked up in a deadlock. That is, neither one of them could continue without one of them giving up, as they were both waiting on a resource the other transaction had locked.</p>
<p>But what happened, how did this go wrong? Isn’t the usual trick to make sure you perform actions in the same order, and you’ll avoid deadlocks? Unfortunately it’s not that simple, your isolation level plays a large part as well. In this case we know which queries caused the deadlock, but we could’ve gotten the same information using the profiler. Perform a rollback of the non-victimized transaction so the tblPapers table remains unaffected.</p>
<p>Startup the profiler and connect to the database server. Choose the TSQL_Locks template:</p>
<div class="imgwrapper" style=""><div><a href="/solving-deadlocks-through-locking-hints/deadlock-hint-2_2.jpg" class="fancy"><img src="/solving-deadlocks-through-locking-hints/deadlock-hint-2_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Make sure only the relevant events are chosen, to limit the amount of data we’ll be presented with. If necessary, put extra filters on the database name so we avoid queries from other databases. You can also filter it on the connection ID’s from SSMS if necessary:</p>
<div class="imgwrapper" style=""><div><a href="/solving-deadlocks-through-locking-hints/deadlock-hint-3_2.jpg" class="fancy"><img src="/solving-deadlocks-through-locking-hints/deadlock-hint-3_2.jpg" style="max-height: 250px"/></a></div></div>

<p>If we run the profiler in the background while executing all steps in SSMS in the meantime, we’ll notice a an important event in the profiler, the Deadlock graph. If we hover the mouse over either of the circles representing the two individual processes, we’ll get a tooltip showing the exact query that was run when the deadlock occurred - the two insert queries:</p>
<div class="imgwrapper" style=""><div><a href="/solving-deadlocks-through-locking-hints/deadlock-hint-4_2.jpg" class="fancy"><img src="/solving-deadlocks-through-locking-hints/deadlock-hint-4_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Ok, so now that we know what step caused the deadlock, the question now is, why did it occur? Perform a rollback of the non-victimized transaction. Now run step 1-3 again, and run the following query in window A:</p>
<figure class="highlight sql"><pre>sp_lock @@SPID
</pre></figure>

<p>The result should resemble this (ID’s will be different):</p>
<div class="imgwrapper" style=""><div><a href="/solving-deadlocks-through-locking-hints/deadlock-hint-5_2.jpg" class="fancy"><img src="/solving-deadlocks-through-locking-hints/deadlock-hint-5_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Notice the highlighted object ID. Now right click on the deadlock graph in the profiler results table and select “Extract event data”. Save the file somewhere and open it in Visual Studio (as XML).</p>
<p>You’ll notice the following two lines:</p>
<figure class="highlight xml"><pre><span class="tag">&lt;<span class="title">process</span> <span class="attribute">id</span>=<span class="value">"process383a5c8"</span> <span class="attribute">...</span> <span class="attribute">waitresource</span>=<span class="value">"KEY: 7:72057594039238656 (5701f5018387)"</span> <span class="attribute">...</span> /&gt;</span>
<span class="tag">&lt;<span class="title">process</span> <span class="attribute">id</span>=<span class="value">"process383a868"</span> <span class="attribute">...</span> <span class="attribute">waitresource</span>=<span class="value">"KEY: 7:72057594039238656 (5701f5018387)"</span> <span class="attribute">...</span> /&gt;</span>
</pre></figure>

<p>What these lines tells us is that both processes are waiting on the same resource, namely 5701f5018387. Looking at our sp_locks result from before, we can see that that particular resource has a shared lock (S) on it.</p>
<p>And this brings us down to the core issue - the SERIALIZABLE isolation mode. Different isolation modes provide different locking levels, serializable being one of the more pessimistic ones. SERIALIZABLE will:</p>
<ul>
<li>Request shared locks on all read data (and keep them until the transaction ends), preventing non-repeatable reads as other transactions can’t modify data we’ve read.</li>
<li>Prevent phantom reads - that is, a SELECT query will return the same result even if run multiple times - other transactions can’t insert data while we’ve locked it. SQL Server accomplishes this by either locking at the table or key-range level.</li>
</ul>
<p>If we look at the <a href="http://msdn.microsoft.com/en-us/library/ms186396(SQL.90" target="_blank">Lock Compatibility chart</a>.aspx), we’ll see that “Shared (S)” locks are compatible with other S &amp; IS (Intent Shared) locks. This means both of the processes are able to perform a shared lock on the initial SELECT COUNT(*) key range. When the INSERT statement is then performed, the database will then attempt to get an exclusive (X) lock on the data - but since the other process has a shared lock, we’ll have to wait for it to be released. When the second process tries to perform an INSERT as well, it’ll try to get an exclusive lock on the same data. At this point we have two processes that both have a shared lock on the same piece of data, and they both want an exclusive lock on the data. The only way to get out of this situation is to dedicate one of the transactions as a victim and perform a rollback. The unaffected process will perform the INSERT and will be able to commit.</p>
<p>How do we then get rid of the deadlock situation? We <em>could</em> change the isolation mode to the default READ COMMITTED like so:</p>
<figure class="highlight csharp"><pre>var tsOptions = new TransactionOptions();
tsOptions.IsolationLevel = IsolationLevel.ReadCommitted;

using (var ts = new TransactionScope(TransactionScopeOption.Required, tsOptions))
{
	<span class="keyword">...</span>

	ts.Complete();
}
</pre></figure>

<p>However, that will result in another problem if we run the same steps as before:</p>
<figure class="highlight"><pre>Msg <span class="number">2601</span>, Level <span class="number">14</span>, State <span class="number">1</span>, Line <span class="number">3</span>
Cannot insert duplicate key row in <span class="class"><span class="keyword">object</span> '<span class="title">dbo</span>.<span class="title">tblPapers</span>' <span class="keyword">with</span> <span class="title">unique</span> <span class="title">index</span> '<span class="title">NC_Url</span>'.</span>
The statement has been terminated.
</pre></figure>

<p>As READ COMMITTED does not protect us against phantom reads, it won’t take shared locks on read data. Thus the second process is able to perform the insert without us knowing (we still think COUNT(*) is = 0). As a result, we’ll fail by violating the unique NC_Url index constraint.</p>
<p>What we’re looking for is an even more pessimistic isolation level - we not only need to protect ourselves against phantom reads, we need to protect against locks on the same data as we’ve read (we don’t care if someone reads our data using READ UNCOMMITTED, that’s their problem - as long as they don’t lock our data). However, SERILIZABLE is the most pessimistic isolation level in SQL Server, so we’re outta luck. That is… Unless we use a locking hint.</p>
<p>Locking hints tell the database engine what kind of locking we would like to use. Take note that locking hints are purely hints - they’re not orders. In this case however, SQL Server does obey our command. What we need is the UPDLOCK hint. Change the query so it includes an UPDLOCK hint in the first SELECT statement:</p>
<figure class="highlight sql"><pre><span class="comment">-- Ensure unique URL</span>
DECLARE @NewUrl varchar(128); <span class="operator"><span class="keyword">SET</span> @NewUrl = <span class="string">'newurl'</span>
<span class="keyword">SELECT</span> <span class="aggregate">COUNT</span>(*) <span class="keyword">FROM</span> tblPapers (UPDLOCK) <span class="keyword">WHERE</span> Url = @NewUrl</span>
</pre></figure>

<p>The UPDLOCK hint tells SQL Server to acquire an update lock on the key/range that we’ve selected. Since shared locks and update locks are not compatible, the second process will have to wait until the first transaction either commits or performs a rollback. The second process won’t return the result of the first SELECT COUNT(*) query until the first process is done - or a timeout occurs.</p>
<p>Note that while this method protects us against the deadlocks &amp; constraint violations, it does so at the cost of decreased concurrency. This will result in other operations being blocked until the insertion procedure is done. In my case, this is a rather rare procedure, so it does not matter. One way to alleviate this problem would be to use the <a href="http://www.databasejournal.com/features/mssql/article.php/3566746/Controlling-Transactions-and-Locks-Part-5-SQL-2005-Snapshots.htm" target="_blank">READ COMMITTED SNAPSHOT isolation level</a> in other parts of the application where it’s applicable. YMMV!</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Mar</span>
			<span class="day">26</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/deciphering-a-sql-server-data-page/" title="Deciphering a SQL Server Data Page" rel="bookmark">Deciphering a SQL Server Data Page</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - Internals/">SQL Server - Internals</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>SQL Server stores all of it’s data in what is basically a large array of “pages”. Each page is exactly 8kb and can contain various kinds of data, depending on the page type. In this entry we’ll explore how to decipher a data page.</p>
<a id="more"></a>

<p>As mentioned, all data in SQL Server is stored in pages, this includes data, index data and various other page types (GAM/SGAM/IAM/PFS etc) to support the operations of SQL Server. Each page type has a unique page content and will thus require separate analysis to understand their content. In this entry I’ll concentrate on a normal data page, that is, the pages that contain the data of either heap tables or clustered indexes.</p>
<p>A page has a basic structure consisting of a header, the actual page content and finally an array noting the locations of the individual rows in the content section.</p>
<div class="imgwrapper" style=""><div><a href="/deciphering-a-sql-server-data-page/deciph-page-structure_2.jpg" class="fancy"><img src="/deciphering-a-sql-server-data-page/deciph-page-structure_2.jpg" style="max-height: 250px"/></a></div></div>

<p>First of all, we need to create a new empty database for this to work:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> Test</span>
</pre></figure>

<p>To make it easier to reset &amp; redo the examples, you should start a new transaction by running “BEGIN TRAN” as the first command (I’m assuming you’re running these queries in SSMS). When you want to reset / start over, just run “ROLLBACK” and nothing will be saved.</p>
<p>First we will look at the structure of data pages for a <a href="http://www.mssqltips.com/tip.asp?tip=1254" target="_blank">heap table</a>. We’ll create a simple table containing only a single int (identity) field:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp
(
	ID <span class="keyword">int</span> <span class="keyword">identity</span>(<span class="number">1</span>,<span class="number">1</span>)
)</span>
</pre></figure>

<p>Now, let’s insert 2 rows into the table:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tmp <span class="keyword">DEFAULT</span> <span class="keyword">VALUES</span>
<span class="keyword">GO</span> <span class="number">2</span></span>
</pre></figure>

<p>If you do a SELECT on the tmp table at this point, you should get two rows with values 1-2 in the ID column. At this point we want to retrieve a list of the pages used to store the contents of the tmp table. We can do this by using the undocumented DBCC IND command:</p>
<figure class="highlight sql"><pre>DBCC IND(Test, tmp, -1)
</pre></figure>

<p>The first parameter is the database name, Test in our case. The next parameter is the name of the table, while the last parameter is an index ID - using -1 as the ID will return all indexes, which is fine in our case. Running the above command should yield a result like the one below:</p>
<div class="imgwrapper" style=""><div><a href="/deciphering-a-sql-server-data-page/deciph-dbcc-ind1_2.jpg" class="fancy"><img src="/deciphering-a-sql-server-data-page/deciph-dbcc-ind1_2.jpg" style="max-height: 250px"/></a></div></div>

<p>The only two important columns at this point are the PagePID, IAMPID and PageType columns. PagePID is the unique (within this database file) page ID for a specific page. IAMPID defines a parent/child relationship between pages. PageType defines the type of page that we’re looking at. The most common page types you’ll run into are:</p>
<ul>
<li>1 - Data page</li>
<li>2 - Index page</li>
<li>3/4 - Text pages</li>
<li>8 - <a href="http://blogs.msdn.com/sqlserverstorageengine/archive/2006/07/08/under-the-covers-gam-sgam-and-pfs-pages.aspx" target="_blank">GAM</a> page</li>
<li>9 - <a href="http://blogs.msdn.com/sqlserverstorageengine/archive/2006/07/08/under-the-covers-gam-sgam-and-pfs-pages.aspx" target="_blank">SGAM</a> page</li>
<li>10 - <a href="https://blogs.msdn.com/sqlserverstorageengine/archive/2006/06/24/645803.aspx" target="_blank">IAM</a> page</li>
<li>11 - <a href="http://blogs.msdn.com/sqlserverstorageengine/archive/2006/07/08/under-the-covers-gam-sgam-and-pfs-pages.aspx" target="_blank">PFS</a> page</li>
</ul>
<p>At this point we’re interested in the root IAM (page type = 10) page with page ID 119. This is the root page of our heap table index. This is the page that currently tracks all of the data pages belonging to the tmp table. Currently there’s only one IAM page, but if necessary, there can be multiple nested IAM pages to support more data pages than can be referenced on a single IAM page.</p>
<p>The root page has a NULL IAMPID, signaling that it doesn’t have any parent pages. The second page has an IAMPID of 119 - the ID of the root page. Thus the second page is a child page of the root page. We can also see that the second page is a data page since it’s page type is = 1. Notice the page ID of the second page, as both the root and child page ID’s will most likely be different in your test!</p>
<p>Before we can retrieve the contents of the page, we have to turn on a specific trace flag, otherwise we won’t see any results of the following command, as they’re sent only to the error log by default:</p>
<figure class="highlight sql"><pre>DBCC TRACEON(3604)
</pre></figure>

<p>After the trace flag has been turned on, we’re ready to run the undocumented DBCC PAGE command. The DBCC PAGE command takes four parameters, the first one being the database name. The second is the file number in the database - this will be 1 since there’s only a single file per database by default. The third parameter is the page ID we want to analyze - notice that this varies and will most likely be different in your situation. The final parameter defines the level of detail (0-3) to be included in the output. The most common levels are 0 and 1, 0 outputting only the header values while 1 also includes the actual row data.</p>
<figure class="highlight sql"><pre>DBCC PAGE(Test, 1, 1839, 1)
</pre></figure>

<p>The result should resemble the following:</p>
<figure class="highlight"><pre><span class="attribute">PAGE</span>: <span class="string">(1:119)</span>

<span class="mathematica">BUFFER:

BUF @<span class="number">0x0000000080FF0980</span>

bpage = <span class="number">0x0000000080C26000</span>           bhash = <span class="number">0x0000000000000000</span>           bpageno = (<span class="number">1</span>:<span class="number">119</span>)
bdbid = <span class="number">6</span>                            breferences = <span class="number">0</span>                      bUse1 = <span class="number">13010</span>
bstat = <span class="number">0xc0000b</span>                     blog = <span class="number">0x32159bb</span>                     bnext = <span class="number">0x0000000000000000</span>

PAGE HEADER:

Page @<span class="number">0x0000000080C26000</span>

m_pageId = (<span class="number">1</span>:<span class="number">119</span>)                   m_headerVersion = <span class="number">1</span>                  m_type = <span class="number">1</span>
m_typeFlagBits = <span class="number">0x4</span>                 m_level = <span class="number">0</span>                          m_flagBits = <span class="number">0x8000</span>
m_objId (AllocUnitId.idObj) = <span class="number">232</span>    m_indexId (AllocUnitId.idInd) = <span class="number">256</span>  
Metadata: AllocUnitId = <span class="number">72057594053132288</span>                                 
Metadata: PartitionId = <span class="number">72057594044219392</span>                                 Metadata: IndexId = <span class="number">0</span>
Metadata: ObjectId = <span class="number">1477580302</span>      m_prevPage = (<span class="number">0</span>:<span class="number">0</span>)                   m_nextPage = (<span class="number">0</span>:<span class="number">0</span>)
pminlen = <span class="number">8</span>                          m_slotCnt = <span class="number">2</span>                        m_freeCnt = <span class="number">8070</span>
m_freeData = <span class="number">118</span>                     m_reservedCnt = <span class="number">0</span>                    m_lsn = (<span class="number">217</span>:<span class="number">17834</span>:<span class="number">77</span>)
m_xactReserved = <span class="number">0</span>                   m_xdesId = (<span class="number">0</span>:<span class="number">0</span>)                     m_ghostRecCnt = <span class="number">0</span>
m_tornBits = <span class="number">0</span>                       

Allocation Status

GAM (<span class="number">1</span>:<span class="number">2</span>) = ALLOCATED                SGAM (<span class="number">1</span>:<span class="number">3</span>) = ALLOCATED               
PFS (<span class="number">1</span>:<span class="number">1</span>) = <span class="number">0x61</span> MIXED_EXT ALLOCATED  <span class="number">50</span>_PCT_FULL                         DIFF (<span class="number">1</span>:<span class="number">6</span>) = CHANGED
ML (<span class="number">1</span>:<span class="number">7</span>) = NOT MIN_LOGGED            

DATA:

<span class="keyword">Slot</span> <span class="number">0</span>, <span class="keyword">Offset</span> <span class="number">0x60</span>, <span class="keyword">Length</span> <span class="number">11</span>, DumpStyle BYTE

<span class="keyword">Record</span> Type = PRIMARY_RECORD         <span class="keyword">Record</span> <span class="keyword">Attributes</span> =  NULL_BITMAP     
Memory Dump @<span class="number">0x000000000B05C060</span>

<span class="number">0000000000000000</span>:   <span class="number">10000800</span> <span class="number">01000000</span> <span class="number">0100</span>fe†††††††††††††...........      

<span class="keyword">Slot</span> <span class="number">1</span>, <span class="keyword">Offset</span> <span class="number">0x6b</span>, <span class="keyword">Length</span> <span class="number">11</span>, DumpStyle BYTE

<span class="keyword">Record</span> Type = PRIMARY_RECORD         <span class="keyword">Record</span> <span class="keyword">Attributes</span> =  NULL_BITMAP     
Memory Dump @<span class="number">0x000000000B05C06B</span>

<span class="number">0000000000000000</span>:   <span class="number">10000800</span> <span class="number">02000000</span> <span class="number">0100</span>fe†††††††††††††...........      

OFFSET TABLE:

<span class="keyword">Row</span> - <span class="keyword">Offset</span>                         
<span class="number">1</span> (<span class="number">0x1</span>) - <span class="number">107</span> (<span class="number">0x6b</span>)                 
<span class="number">0</span> (<span class="number">0x0</span>) - <span class="number">96</span> (<span class="number">0x60</span>)</span>
</pre></figure>

<p>I’ll elegantly jump over the buffer &amp; header parts as they’re begging for posts on their own, and I can’t realistically show them the respect they need in this post. Instead we’ll concentrate on the DATA &amp; OFFSET TABLE parts.</p>
<p>Let’s start out from the bottom up and look at the OFFSET TABLE:</p>
<figure class="highlight"><pre><span class="keyword">Row</span> - <span class="keyword">Offset</span>                         
<span class="number">1</span> (<span class="number">0x1</span>) - <span class="number">107</span> (<span class="number">0x6b</span>)                 
<span class="number">0</span> (<span class="number">0x0</span>) - <span class="number">96</span> (<span class="number">0x60</span>)
</pre></figure>

<p>Notice that it should be read from the bottom up as well, row 0 being the first, 1 being the second. The row offset table is basically an integer array pointing out the to locations in the 8KB page of the individual row locations. As we have two rows in our table, and they both fit on this page, there’s two entries in the offset table. The first row starts at byte index 96 - the first byte after the 96 byte header. The second row starts at index 107, 11 bytes after the first row. Let’s take a look at the first row (the rows are identical):</p>
<figure class="highlight"><pre><span class="keyword">Slot</span> <span class="number">0</span>, <span class="keyword">Offset</span> <span class="number">0x60</span>, <span class="keyword">Length</span> <span class="number">11</span>, DumpStyle BYTE

<span class="keyword">Record</span> Type = PRIMARY_RECORD         <span class="keyword">Record</span> <span class="keyword">Attributes</span> =  NULL_BITMAP     
Memory Dump @<span class="number">0x000000000B05C060</span>

<span class="number">0000000000000000</span>:   <span class="number">10000800</span> <span class="number">01000000</span> <span class="number">0100</span>fe†††††††††††††...........
</pre></figure>

<p>The first row has slot 0, it’s offset is 0x60 (96) and we already know the length is 11 bytes, from the offset table. Let’s take a look at the rows actual content, to understand what is stored.</p>
<ul>
<li><strong>10</strong>000800 01000000 0100FE  The first byte is a status byte that contains info on how to parse the row contents. The value 0x10 defines the inclusion of a NULL_BITMAP, as indicated by the record attributes.</li>
<li>10<strong>00</strong>0800 01000000 0100FE  The next byte is currently (MSSQL2005) unused, but may be used in future versions.</li>
<li>1000<strong>0800</strong> 01000000 0100FE  The next two bytes store the byte index position of where to find the number of columns in this row, within the rows data. SQL Server stores numbers with the low order byte first, so the bytes must be switched around to get the position. Thus 0x0800 becomes 0x0008 (8 in decimal).</li>
<li>10000800 <strong>01000000</strong> 0100FE  The next four bytes are the contents of the first column, a four byte integer. This is our identity column, and you’ll notice that the first row has a value of 0x00000001 while the second has a value of 0x00000002.</li>
<li>10000800 01000000 <strong>0100</strong>FE  The next two bytes store the number of columns. Notice that this is stored at byte index 8, as indicated by the third and fourth bytes in the row.</li>
<li>10000800 01000000 0100<strong>FE</strong>  Finally the null bitmap is stored in the last byte. 0xFE converted to binary is 1111 1110, indicating that the first column value is not null (the first 0, read backwards). The rest have a default value of 1, actually indicating that it is null. But since there’s only one column, these bits are never read. Note that one byte in the null bitmap can support up to 8 columns. The formula for determining the null bitmap size is (#cols+7)/8, using integer division.</li>
</ul>
<p>Let’s do a rollback and create a new table with a slightly changed schema and values:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp
(
	ID <span class="keyword">int</span>
)

<span class="keyword">CREATE</span> CLUSTERED INDEX CI <span class="keyword">ON</span> tmp (ID)

<span class="keyword">INSERT</span> <span class="keyword">INTO</span> tmp (ID) <span class="keyword">VALUES</span> (<span class="number">1</span>)
<span class="keyword">GO</span> <span class="number">2</span></span>
</pre></figure>

<p>We still have a single ID column, but this time it’s not an identity column, and we’re manually inserting the value “1” into the column. Thus both rows will have the same value. If we runn DBCC IND to get the page id, and then DBCC PAGE on the data page, we’ll get the following two rows:</p>
<figure class="highlight"><pre><span class="keyword">Slot</span> <span class="number">0</span>, <span class="keyword">Offset</span> <span class="number">0x60</span>, <span class="keyword">Length</span> <span class="number">11</span>, DumpStyle BYTE

<span class="keyword">Record</span> Type = PRIMARY_RECORD         <span class="keyword">Record</span> <span class="keyword">Attributes</span> =  NULL_BITMAP     
Memory Dump @<span class="number">0x000000000D90C060</span>

<span class="number">0000000000000000</span>:   <span class="number">10000800</span> <span class="number">01000000</span> <span class="number">0200</span>fc†††††††††††††...........      

<span class="keyword">Slot</span> <span class="number">1</span>, <span class="keyword">Offset</span> <span class="number">0x6b</span>, <span class="keyword">Length</span> <span class="number">19</span>, DumpStyle BYTE

<span class="keyword">Record</span> Type = PRIMARY_RECORD         <span class="keyword">Record</span> <span class="keyword">Attributes</span> =  NULL_BITMAP VARIABLE_COLUMNS

Memory Dump @<span class="number">0x000000000D90C06B</span>

<span class="number">0000000000000000</span>:   <span class="number">30000800</span> <span class="number">01000000</span> <span class="number">0200</span>fc01 <span class="number">00130001</span> †<span class="number">0.</span>.............. 
<span class="number">0000000000000010</span>:   <span class="number">000000</span>†††††††††††††††††††††††††††††††...
</pre></figure>

<p>The first row is almost identical to the last. It’s still 11 bytes long and its status bits indicate there’s only a null bitmap. One thing has changed however.</p>
<ul>
<li>10000800 01000000 <strong>0200</strong>FC  The number of columns indicater now has a value of 0x0002, indicating there is now two columns. How can that be? We only defined one column, and the row length is still 11 bytes.</li>
</ul>
<p>If we take a look at the second row, we’ll see that the length is 19 bytes, an extra 8 bytes. Furthermore, the status byte has changed its value to 0x30, indicating there’s both a null bitmap, as well as a “variable columns” section. Take a look at the row data (note that I’ve concatenated the two lines to make it more readable):</p>
<ul>
<li>30000800 <strong>01000000</strong> 0200FC01 00130001 000000  Obviously the value in this row is also 1, meaning both rows have the same value in the clustered index.</li>
<li>30000800 01000000 0200<strong>FC</strong>01 00130001 000000  The null bitmap has changed into the value 0xFC or 1111 1100, indicating that the first two (in other words, all) columns do not have null values.</li>
<li>30000800 01000000 0200FC01 001300<strong>01 000000</strong>  The last four bytes is a “uniqueifier” value that is added since the clustered key value is identical for multiple rows. Why wasn’t this added before? On the first table we didn’t define a clustered index, and therefore it was a heap table. In heap tables, pages are referenced by their phyiscal location and not their clustered key value. In a clustered table, rows are always referenced by their clustered key value. To uniquely reference a column, it’s important that each clustered key value is unique (which is why the clustered key is usually also the primary key, as is also the default in SSMS). If a clustered key is not unique, SQL Server adds its own uniqueifier value that makes the key unique - note that this only occurs when necessary, thus the lack of a uniqueifier on the first row, since that one is already unique. The uniqueifier is treated as a variable length column as we can potentially have more than 2^31-1 rows with the same value, at which point the uniqueifier will have to utilize eight bytes to ensure unique clustered key values.</li>
<li>30000800 01000000 0200FC<strong>01 001300</strong>01 000000  The previous four bytes are used to support the variable length column(s) in the row. The first two bytes indicate the number of variable length columns in the row (0x0001 - the single uniqueifier column), while the second pair of bytes indicate the end index of the first variable length column, that is 0x0013 (19 in decimal, which is also the total length of the row).</li>
</ul>
<p>To elaborate on the variable length columns, consider the following table and values:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp
(
	t1 nvarchar(<span class="number">5</span>),
	t2 nvarchar(<span class="number">5</span>)
)

<span class="keyword">INSERT</span> <span class="keyword">INTO</span> tmp (t1, t2) <span class="keyword">VALUES</span> (<span class="string">'a'</span>, <span class="string">'b'</span>)</span>
</pre></figure>

<p>Let’s look at the row contents:</p>
<ul>
<li><strong>30000400</strong> 0200FC02 000f0011 00610062 00  The first bytes are used for the status &amp; unused bytes, as well as the “number of columns” index.</li>
<li>30000400 <strong>0200</strong>FC02 000f0011 00610062 00  The next two bytes at index 0x0004 indicate there’s two columns.</li>
<li>30000400 0200<strong>FC</strong>02 000f0011 00610062 00  The null bitmap indicates that no columns have null values.</li>
<li>30000400 0200FC<strong>02 00</strong>0f0011 00610062 00  The next two bytes indicate the number of variable length columns, 0x0002.</li>
<li>30000400 0200FC02 00<strong>0f00</strong>11 00610062 00  The next two bytes indicate the ending position of the first variable length column, 0x000f (15).</li>
<li>30000400 0200FC02 000f00<strong>11 00</strong>610062 00  Likewise, the next two bytes indicate the ending position of the second variable length column, 0x0011 (17). If there were more variable length columns, each one of them would have a two-byte length indicator here, before the actual contents.</li>
<li>30000400 0200FC02 000f0011 00<strong>6100</strong>62 00  After the variable length column end index indicators, the actual content is stored. We know that the first variable length column value ends at index 15, which gives us the value 0x0061 which happens to be a lowercase ‘a’.</li>
<li>30000400 0200FC02 000f0011 006100<strong>62 00</strong>  Likewise, we know that the second column ends at index 17, giving us the value 0x0062, being a lowercase ‘b’.</li>
</ul>
<p>As a final example, let’s look at what happens when we have null values in our columns.</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp
(
	t1 nvarchar(<span class="number">5</span>),
	t2 nvarchar(<span class="number">5</span>)
)

<span class="keyword">INSERT</span> <span class="keyword">INTO</span> tmp (t1, t2) <span class="keyword">VALUES</span> (<span class="string">'a'</span>, <span class="string">'b'</span>)
<span class="keyword">INSERT</span> <span class="keyword">INTO</span> tmp (t1, t2) <span class="keyword">VALUES</span> (<span class="keyword">NULL</span>, <span class="string">'b'</span>)
<span class="keyword">INSERT</span> <span class="keyword">INTO</span> tmp (t1, t2) <span class="keyword">VALUES</span> (<span class="string">'a'</span>, <span class="keyword">NULL</span>)
<span class="keyword">INSERT</span> <span class="keyword">INTO</span> tmp (t1, t2) <span class="keyword">VALUES</span> (<span class="keyword">NULL</span>, <span class="keyword">NULL</span>)</span>
</pre></figure>

<p>The resulting four rows should look like this:</p>
<figure class="highlight"><pre><span class="keyword">Slot</span> <span class="number">0</span>, <span class="keyword">Offset</span> <span class="number">0x60</span>, <span class="keyword">Length</span> <span class="number">17</span>, DumpStyle BYTE
<span class="keyword">Record</span> Type = PRIMARY_RECORD         <span class="keyword">Record</span> <span class="keyword">Attributes</span> =  NULL_BITMAP VARIABLE_COLUMNS
Memory Dump @<span class="number">0x000000000DB0C060</span>
<span class="number">0000000000000000</span>:   <span class="number">30000400</span> <span class="number">0200</span>fc02 <span class="number">000</span>f0011 <span class="number">00610062</span> †<span class="number">0.</span>...........a.b 
<span class="number">0000000000000010</span>:   <span class="number">00</span>†††††††††††††††††††††††††††††††††††.                

<span class="keyword">Slot</span> <span class="number">1</span>, <span class="keyword">Offset</span> <span class="number">0x71</span>, <span class="keyword">Length</span> <span class="number">15</span>, DumpStyle BYTE
<span class="keyword">Record</span> Type = PRIMARY_RECORD         <span class="keyword">Record</span> <span class="keyword">Attributes</span> =  NULL_BITMAP VARIABLE_COLUMNS
Memory Dump @<span class="number">0x000000000DB0C071</span>
<span class="number">0000000000000000</span>:   <span class="number">30000400</span> <span class="number">0200</span>fd02 <span class="number">000</span>d000f <span class="number">006200</span>††††<span class="number">0.</span>...........b.  

<span class="keyword">Slot</span> <span class="number">2</span>, <span class="keyword">Offset</span> <span class="number">0x80</span>, <span class="keyword">Length</span> <span class="number">13</span>, DumpStyle BYTE
<span class="keyword">Record</span> Type = PRIMARY_RECORD         <span class="keyword">Record</span> <span class="keyword">Attributes</span> =  NULL_BITMAP VARIABLE_COLUMNS
Memory Dump @<span class="number">0x000000000DB0C080</span>
<span class="number">0000000000000000</span>:   <span class="number">30000400</span> <span class="number">0200</span>fe01 <span class="number">000</span>d0061 <span class="number">00</span>††††††††<span class="number">0.</span>.........a.    

<span class="keyword">Slot</span> <span class="number">3</span>, <span class="keyword">Offset</span> <span class="number">0x8d</span>, <span class="keyword">Length</span> <span class="number">9</span>, DumpStyle BYTE
<span class="keyword">Record</span> Type = PRIMARY_RECORD         <span class="keyword">Record</span> <span class="keyword">Attributes</span> =  NULL_BITMAP     
Memory Dump @<span class="number">0x000000000DB0C08D</span>
<span class="number">0000000000000000</span>:   <span class="number">10000400</span> <span class="number">0200</span>ff00 <span class="number">00</span>†††††††††††††††††.........
</pre></figure>

<p>As a proof of SQL Server only adding fields when needed, there are no variable_columns attributes in the fourth row, since both columns are null and we therefore do not need to keep track of the length of the columns.</p>
<ul>
<li>30000400 0200FC02 000F0011 00610062 00  The first row is identical to what we saw before.&nbsp;</li>
<li>30000400 0200FD02 000D000F 006200  In the second row the null bitmap is different: fd (1111 1101), indicating that the first column is null. We can also see that there’s two bytes missing from the row (0x0061) compared to the first row. 0d00 indicates that the first variable length column ends at index 0x000d (13), while the second variable length column ends at index 0f00 / 0x000f / 15. What’s interesting is that the variable column length indicators themselves end at index 13, and thus the first row ends where it starts - that is, it’s not there at all, it’s null. The second column is stored at index 14 + 15, the 6200 / 0x0062 / ‘b’ value.&nbsp;</li>
<li>30000400 0200FE01 000D0061 00  The third row takes up two bytes less, even though it has only a single null field like the second row. The null bitmap is slightly different (fe / 1111 1110) since it’s now the second column that’s null. What’s interesting is that in this row, only a single variable length column is present, not two. Thus there’s only a single variable length column end index identifier, 0d00 / 0x000d / 13. From that we can conclude that columns are handled in order, and thus one might want to consider the order of columns, if a specific column is usually null, it might be more efficient to have it ordered last.&nbsp;</li>
<li>10000400 0200FF00 00  The fourth row takes up just 9 bytes, this time sparing the data of both variable length columns since they’re both null according to the null bitmap (ff / 1111 1111).</li>
</ul>
<h2 id="Conclusion">Conclusion</h2>
<ul>
<li>By using the undocumented DBCC commands IND and PAGE, we can get the actual page data from any page in the database.</li>
<li>SQL Server uses a fixed and deterministic row layout, depending on the table metadata and column contents.</li>
<li>By understanding the way SQL Server stores data, we’re able to optimize our storage even further than we would normally be able to.</li>
<li>Data pages are just one of many page types in SQL Server. Later on, I might introduce other page types.</li>
</ul>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Mar</span>
			<span class="day">20</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/query-optimization-a-case-study/" title="Query Optimization - A Case Study" rel="bookmark">Query Optimization - A Case Study</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - Optimization/">SQL Server - Optimization</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Yesterday I did an interview with <a href="http://www.publicvoid.dk/" target="_blank">Søren Spelling Lund</a> for <a href="http://www.anug.dk/" target="_blank">ANUG</a> (Aarhus .NET User Group) on SQL Server Optimization, as a followup to my recent talk on that subject. He asked me an interesting question - what is the normal process of determining the need of an optimization, and how to actually do it? This is a case study from today.</p>
<a id="more"></a>

<p>The issue started out by one of the sales people telling me the catalogs were loading slowly. Being a limited number of people in a small office, my usual first resolution is to simply ask if anyone in the office are downloading/uploading files, since that’ll usually exhaust our rather limited network connection. Unfortunately, that was not the reason. Next step - locate the exact location of the issue. I asked which catalogs specifically were loading slowly, and whether it was all of it loading slowly, just the images or anything else that might narrow down the issue.</p>
<p>The response was quite a bit more precise than I’d hoped for:</p>
<div class="imgwrapper" style=""><div><a href="/query-optimization-a-case-study/sqlio-timeout_2.jpg" class="fancy"><img src="/query-optimization-a-case-study/sqlio-timeout_2.jpg" style="max-height: 250px"/></a></div></div>

<p>So it wasn’t a matter of things loading slowly… It was a matter of things not loading at all! Funny thing is, during the ANUG interview, Søren asked me how one could detect when optimizations were needed - part of my answer was “When SqlCommands start timing out”.</p>
<p>Armed with a precise error message and the location of the error, I detected the exact operation that caused the timeout. It’s a simple statistics page, showing the number of page views during the last 7 days - nothing exotic, but yet it failed.</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span>
    <span class="aggregate">SUM</span>(TDH.SmallViewCount)
<span class="keyword">FROM</span>
    tblFEStatsDayHits TDH
<span class="keyword">INNER</span> <span class="keyword">JOIN</span>
    tblFEStatsDays TD <span class="keyword">ON</span> TD.DayID = TDH.DayID
<span class="keyword">WHERE</span>
    TDH.PaperID = <span class="number">304275</span> <span class="keyword">AND</span>
    DATEDIFF(dd, TD.<span class="keyword">Day</span>, GETDATE()) &lt; <span class="number">7</span></span>
</pre></figure>

<p>The query is rather basic, it tries to sum up the SmallViewCount (containing the number of views of a single page) from the table tblFEStatsDayHits. This table has a reference to the helper table tblFEStatsDays, containing a single row per day. Thus tblFEStatsDays is a very small table which is only used for getting the actual day this event occurred on. We filter on a PaperID (which is basically a specific catalog) as well as on DATEDIFF(dd, TD.Day, GETDATE()) being below 7 - making sure we only consider data for the last 7 days. So given a rather simple query, how can this be so bad?</p>
<p>Take a look at the IO statistics:</p>
<figure class="highlight"><pre>Table <span class="string">'tblFEStatsDayHits'</span>. Scan count <span class="number">5</span>, logical reads <span class="number">484959</span>, physical reads <span class="number">3</span>, <span class="built_in">read</span>-ahead reads <span class="number">304063</span>, lob logical reads <span class="number">0</span>, lob physical reads <span class="number">0</span>, lob <span class="built_in">read</span>-ahead reads <span class="number">0</span>.
Table <span class="string">'tblFEStatsDays'</span>. Scan count <span class="number">5</span>, logical reads <span class="number">10</span>, physical reads <span class="number">0</span>, <span class="built_in">read</span>-ahead reads <span class="number">0</span>, lob logical reads <span class="number">0</span>, lob physical reads <span class="number">0</span>, lob <span class="built_in">read</span>-ahead reads <span class="number">0</span>.
</pre></figure>

<p>This confirms that tblFEStatsDays isn’t of interest to us since it only had 10 page reads. tblFEStatsDayHits on the other hand had 484959 page reads. That’s around 3,7 (484959 * 8KB per page) gigs of data being read. Though it’s logical reads (that is, from memory), that’s still an insane amount, especially since they’re most likely physical reads the first time they’re read. The database server is running on a RAID1 15k SAS mirror, giving us at most about 150MB/sec of IO performance - ignoring any other active tasks. That’s about 25 seconds of uninterrupted IO read time - that’s bound to blow up at some point.</p>
<p>Let’s look at the execution plan:</p>
<div class="imgwrapper" style=""><div><a href="/query-optimization-a-case-study/sqlio-plan1_2.jpg" class="fancy"><img src="/query-optimization-a-case-study/sqlio-plan1_2.jpg" style="max-height: 250px"/></a></div></div>

<p>This pretty much confirms the issue lies in the Clustered Index Scan - which is more or less the last operation you want to see in an exceution plan. It represents a complete read of the whole clustered index - an operation that scales rather linearly with the amount of data you have in your tables. So how big is this table?</p>
<div class="imgwrapper" style=""><div><a href="/query-optimization-a-case-study/sqlio-storage_2.jpg" class="fancy"><img src="/query-optimization-a-case-study/sqlio-storage_2.jpg" style="max-height: 250px"/></a></div></div>

<p>It’s got a bit short of 60M rows, 3,7 gigs of data (matching up to our 3,7 gig read earlier), and an additional ~3 gigs of extra index data. Clearly, if this operation is to be fast, we need to use indexes wisely so we avoid reading all of this data.</p>
<p>If we look at the execution plan in SQL Server Management Studio 2008 (won’t work in SMS2005), it’ll actually give us a recommendation for a specific index that it could’ve used:</p>
<div class="imgwrapper" style=""><div><a href="/query-optimization-a-case-study/sqlio-missing-index_2.jpg" class="fancy"><img src="/query-optimization-a-case-study/sqlio-missing-index_2.jpg" style="max-height: 250px"/></a></div></div>


<figure class="highlight sql"><pre><span class="operator"><span class="keyword">CREATE</span> NONCLUSTERED INDEX
    [&lt;Name <span class="keyword">of</span> Missing Index, sysname,&gt;]
<span class="keyword">ON</span>
    [dbo].[tblFEStatsDayHits] ([PaperID])
INCLUDE
    ([DayID],[SmallViewCount])</span>
</pre></figure>

<p>That specific index would allow us to filter on the PaperID while including the DayID and SmallViewCount columns at the leaf level. The PaperID column has a rather high cardinality, so by filtering on that, we’ve already reduced the data amount considerably. SMS predicts adding this index will optimize the query by about 99% - sounds good, let’s try:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">CREATE</span> NONCLUSTERED INDEX [NC_PaperID] <span class="keyword">ON</span> [dbo].[tblFEStatsDayHits] 
(
    [PaperID] <span class="keyword">ASC</span>
)
INCLUDE
(
    [DayID],
    [SmallViewCount]
)</span>
</pre></figure>

<p>After adding the index and rerunning the query, these are the new IO statistiscs:</p>
<figure class="highlight"><pre>Table <span class="string">'tblFEStatsDayHits'</span>. Scan count <span class="number">5</span>, logical reads <span class="number">1770</span>, physical reads <span class="number">0</span>, <span class="built_in">read</span>-ahead reads <span class="number">0</span>, lob logical reads <span class="number">0</span>, lob physical reads <span class="number">0</span>, lob <span class="built_in">read</span>-ahead reads <span class="number">0</span>.
Table <span class="string">'tblFEStatsDays'</span>. Scan count <span class="number">5</span>, logical reads <span class="number">10</span>, physical reads <span class="number">0</span>, <span class="built_in">read</span>-ahead reads <span class="number">0</span>, lob logical reads <span class="number">0</span>, lob physical reads <span class="number">0</span>, lob <span class="built_in">read</span>-ahead reads <span class="number">0</span>.
</pre></figure>

<p>We’re down from 484959 to only 1770 page reads, that’s an optimization of 99,6%, not too shabby. Let’s look at the new execution plan:</p>
<div class="imgwrapper" style=""><div><a href="/query-optimization-a-case-study/sqlio-plan2_2.jpg" class="fancy"><img src="/query-optimization-a-case-study/sqlio-plan2_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Comparing the two plans reveals that we’ve now replaced that nasty clustered index scan with an index seek - one of the most efficient operations that exist. Now most of the time is spent in the parallelism/hash match operations. These operations make individual sums of the SmallViewCount column for all rows with the same DayID value. It’s running on multiple threads as indicated by the presence of a parallelism operator.</p>
<p>Now, we’re still spending quite a lot of time reading in all of the rows for that specific PaperID and grouping them together by DayID. If a catalog has been having visitors for a year, that’s basically 358 extra days of data we’re reading in for no reason. How about if we change the query to this semantically identical one (given that it’s the 12th of March 2009, 09:52 AM):</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span>
    <span class="aggregate">SUM</span>(TDH.SmallViewCount)
<span class="keyword">FROM</span>
    tblFEStatsDayHits TDH
<span class="keyword">INNER</span> <span class="keyword">JOIN</span>
    tblFEStatsDays TD <span class="keyword">ON</span> TD.DayID = TDH.DayID
<span class="keyword">WHERE</span>
    TDH.PaperID = <span class="number">304275</span> <span class="keyword">AND</span>
    TD.<span class="keyword">Day</span> &gt; <span class="string">'2009-03-12 09:52:00'</span></span>
</pre></figure>

<p>What does this change give us? The “DATEDIFF(dd, TD.Day, GETDATE()) &lt; 7” predicate requires SQL Server to look at each row, performing the DATEDIFF operation to determine whether it should be part of hte final sum aggregate. Doing it this way severely limits the usability of our indexes since we can no longer make an index seek on the Day column. If we from the application instead take the current date and subtract 7 days, that’s basically the cutoff point that we’re interested in. Thus we’ve now changed the predicate to only select columns with a Day value higher than the current date minus 7 days.</p>
<p>Take a look at the resulting execution plan:</p>
<div class="imgwrapper" style=""><div><a href="/query-optimization-a-case-study/sqlio-plan3_2.jpg" class="fancy"><img src="/query-optimization-a-case-study/sqlio-plan3_2.jpg" style="max-height: 250px"/></a></div></div>

<p>It’s dramatically simpler. One important point is that if we look at the index seek on tblFEStatsDayHits, it’s now using the index called NC_DayID_PaperID! This is not the one we made just before, this is another lingering index on the table. Let’s look at it’s definition:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">CREATE</span> NONCLUSTERED INDEX [NC_DayID_PaperID] <span class="keyword">ON</span> [dbo].[tblFEStatsDayHits] 
(
    [DayID] <span class="keyword">ASC</span>,
    [PaperID] <span class="keyword">ASC</span>
)</span>
</pre></figure>

<p>Why is it suddenly using this index? To understand, we first have to know what’s actually happening. The whole process has been turned upside down compared to the last plan. In the last plan, we first read in the actual data filtered by PaperID, and then we filtered on the relevant days. Now we’re first finding the relevant DayIDs by joining the tblFEStatsDays table with the NC_DayID_PaperID index, and for each relevant row, we perform a bookmark lookup in the tblFEStatsDayHits table. So why is it not using the NC_PaperID index we made just before? NC_PaperID had a single index column and two included ones (and the implicitly contained clustered key, which is irrelevant as it’s also included in the NC_DayID_PaperID index). Thus, NC_PaperID has three int columns, totalling at 12 bytes of index data per row. The NC_DayID_PaperID only has two keys - PaperID and DayID, totalling at 8 bytes per row. If we add the implicit 4 bytes for the clustered key, thats 16 and 12 bytes per row. With a page size of 8060 bytes of index data, that’s either 503 rows per page or 671 rows per page. That’s about 30% IO saved by using the smaller index. Let’s take a look at the IO statistics for this plan:</p>
<figure class="highlight"><pre>Table <span class="string">'tblFEStatsDayHits'</span>. Scan count <span class="number">7</span>, logical reads <span class="number">96712</span>, physical reads <span class="number">77</span>, <span class="built_in">read</span>-ahead reads <span class="number">73</span>, lob logical reads <span class="number">0</span>, lob physical reads <span class="number">0</span>, lob <span class="built_in">read</span>-ahead reads <span class="number">0</span>.
Table <span class="string">'tblFEStatsDays'</span>. Scan count <span class="number">1</span>, logical reads <span class="number">2</span>, physical reads <span class="number">0</span>, <span class="built_in">read</span>-ahead reads <span class="number">0</span>, lob logical reads <span class="number">0</span>, lob physical reads <span class="number">0</span>, lob <span class="built_in">read</span>-ahead reads <span class="number">0</span>.
</pre></figure>

<p>Now what happened here? We went from 1770 page reads to just short of 100K reads! If we hover our mouse on the nested loops step of the query plan, we can see there’s about 23,5K rows being returned:</p>
<div class="imgwrapper" style=""><div><a href="/query-optimization-a-case-study/sqlio-bookmark-io_2.jpg" class="fancy"><img src="/query-optimization-a-case-study/sqlio-bookmark-io_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Thus, for each of those 23,5K rows, we have to perform a bookmark lookup in the tblFEStatsDayHits table, that’s about 4 page lookups per resulting row (since the predicate at this point is a DayID, there may be several relevant rows in the tblFEStatsDayHits table, thus the large amount of page reads). The only reason that this is still reasonably fast is that all the pages are already present in memory, so this is a pure CPU operation. But having 100K pages (100000 * 8KB = ~780MB) of data in memory just for this purpose is definitely not optimal! Granted, there’s most likely a lot of reuse in these pages, so the sum may not be 780MB’s (we’d have to count the number of unique pages that were needed for that), but it’s bad nonetheless.</p>
<p>If we hover the mouse on the bookmark lookup operator, we get some extra information:</p>
<div class="imgwrapper" style=""><div><a href="/query-optimization-a-case-study/sqlio-bookmark-output_2.jpg" class="fancy"><img src="/query-optimization-a-case-study/sqlio-bookmark-output_2.jpg" style="max-height: 250px"/></a></div></div>

<p>If we look at the output section, we see that the only column that’s actually being returned from these bookmark lookups is the SmallViewCount column. Given that we’re already using the NC_DayID_PaperID index, how about we add the SmallViewCount column as an included column in that index:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">CREATE</span> NONCLUSTERED INDEX [NC_DayID_PaperID] <span class="keyword">ON</span> [dbo].[tblFEStatsDayHits] 
(
    [DayID] <span class="keyword">ASC</span>,
    [PaperID] <span class="keyword">ASC</span>
)
INCLUDE ([SmallViewCount])</span>
</pre></figure>

<p>Let’s check the execution plan again:</p>
<div class="imgwrapper" style=""><div><a href="/query-optimization-a-case-study/sqlio-plan4_2.jpg" class="fancy"><img src="/query-optimization-a-case-study/sqlio-plan4_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Now we’re starting to get somewhere! Now we’re doing two highly effective index seeks on the tblFEStatsDayHits and tblFEStatsDays tables before we join them together. Let’s take a look at the IO statistics as well:</p>
<figure class="highlight"><pre>Table <span class="string">'tblFEStatsDayHits'</span>. Scan count <span class="number">7</span>, logical reads <span class="number">83</span>, physical reads <span class="number">0</span>, <span class="built_in">read</span>-ahead reads <span class="number">0</span>, lob logical reads <span class="number">0</span>, lob physical reads <span class="number">0</span>, lob <span class="built_in">read</span>-ahead reads <span class="number">0</span>.
Table <span class="string">'tblFEStatsDays'</span>. Scan count <span class="number">1</span>, logical reads <span class="number">2</span>, physical reads <span class="number">0</span>, <span class="built_in">read</span>-ahead reads <span class="number">0</span>, lob logical reads <span class="number">0</span>, lob physical reads <span class="number">0</span>, lob <span class="built_in">read</span>-ahead reads <span class="number">0</span>.
</pre></figure>

<p>83 page reads! If we compare that to the original 484959 page reads, that’s an optimization of 99,982%! A query that took upwards of 30 seconds now takes milliseconds. There’s the added reward of having to cache less data in memory (thereby allowing other more important data to stay in memory) and reducing IO load considerably.</p>
<p>Let’s for the kicks of it try and run the original DATEDIFF() query and see the resulting execution plan:</p>
<div class="imgwrapper" style=""><div><a href="/query-optimization-a-case-study/sqlio-plan5_2.jpg" class="fancy"><img src="/query-optimization-a-case-study/sqlio-plan5_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Using the function predicate requires us to scan the whole tblFEStatsDays.NC_Day index, instead of performing a seek. If we run both queries alongside in SMS, we can see a rather large performance advantage of the non-DATEDIFF query (1 : 99 performance ratio):</p>
<div class="imgwrapper" style=""><div><a href="/query-optimization-a-case-study/sqlio-plan6_2.jpg" class="fancy"><img src="/query-optimization-a-case-study/sqlio-plan6_2.jpg" style="max-height: 250px"/></a></div></div>

<h2 id="Conclusion">Conclusion</h2>
<ul>
<li>Locate the exact cause of the issue before optimizing.</li>
<li>Do consider SMS’s (and other tools for that sakes) suggestions, but don’t take for granted that it’s the best solution!</li>
<li>Just because a query plan looks simple, check out the IO statistics to get a better feeling for what actually happens.</li>
<li>Avoid using functions &amp; other advanced predicates that avoid you from taking advantage of your indexes.</li>
<li>Watch out for your query changing mind about what indexes to utilize when you make changes to the query.</li>
</ul>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Mar</span>
			<span class="day">12</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/anug-talk-optimizing-sql-server-2005/" title="ANUG Talk: Optimizing SQL Server 2005" rel="bookmark">ANUG Talk: Optimizing SQL Server 2005</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Tonight I held my SQL Server Optimization talk at <a href="http://www.anug.dk/" target="_blank">ANUG</a>. There was an impressive turnout of almost 50 people, and based on the feedback I’ve received so far, I think it went alright :)</p>
<a id="more"></a>

<p>You can download the slides, code and sample database (with sample data) below. Note that slides are in Danish.</p>
<p><a href="Optimizing_SQL_Server_2005.zip">Optimizing_SQL_Server_2005.zip - Slides + code</a><br><a href="Test.zip">Test.zip - Sample database</a></p>
<p>I’m afraid the query scripts are not in text format, they’re only included as images in the slides. I’ll probably be presenting some of the topics on my blog over time, where the scripts will also be included.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Mar</span>
			<span class="day">08</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/resource-urls-and-their-effect-on-client-side-caching/" title="Resource URLs and Their Effect on Client Side Caching" rel="bookmark">Resource URLs and Their Effect on Client Side Caching</a></h1>
		<div class="categories">
			
				<a href="/category/Performance/">Performance</a>
				, 
			
				<a href="/category/Web/">Web</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>One of the best way to improve performance of any website is to reduce the load from clients by allowing them to cache resources. There are various ways to ensure we utilize client side caching to the fullest extent, an often overlooked parameter however, is the actual URL for the resource we want to cache.</p>
<a id="more"></a>

<h2 id="The_traditional_methods">The traditional methods</h2>
<p>Basically client side caching comes down to three different parameters, the cache policy, the expiration dates as well as the last-modified / etag of the resource.</p>
<p>Through the no-cache policy we can completely disallow all caching of the resource, in which case the resource URL does not matter at all. For this blog entry, I’ll assume we allow caching, just as I’ll assume we have control over the HTML rendered that references the resource.</p>
<p>When caching is allowed, the expiration date defines whether the client can use a locally stored version or whether it has to make a request for the server. Before the browser makes a request to the server, it’ll check if the resource is cached locally. If it is, it will check the expires header of the file - and as long as the expiration date has not been passed, the file will be loaded locally, and no request will be made to the server. Obviously, this is the optimal solution since we completely avoid the overhead of a request to the server - which will help both the client &amp; server performance.</p>
<p>If the expiry date has been passed - or if an expiry date wasn’t sent along with the resource when it was cached - the browser will have to make a request to the server. The server can then check whether the resource has been modified since the last-modified header or etag header (provided the server sent these with the resource originally, and thereby enabling the client to send them back) and send either a 304 or a 200 status back.</p>
<h2 id="URL_impact">URL impact</h2>
<p>So what does the actual resource URL have to do with caching? Let’s take Google as an example. On the frontpage of Google there’s an ever changing doodle logo, let’s for discussions sake say the url is google.com/doodle.jpg. Now, since the image isn’t static, we definitely need either to send an expiry header, or if that’s not possible, an etag/last-modified header so the client can at least cache the resource data, and only have to make a if-modified-since request to the server.</p>
<p>Why might it not be possible to send an expiry header? Remember that if we specify an expiry date, the client will not even check in with the server for updates to that resource until the resource has expired locally. Thus, if the resource needs to change in the meantime, clients will suddenly show outdated conent. Because of this, if we do not know the schedule for when resources might change, it can be dangerous / inappropriate to send an expiry header.</p>
<p>There’s a simple way of avoiding the unknown schedule problem while still allowing the client to fully cache the resource without making if-modified-since requests. Simply change the resource URL. If the doodle url is google.com/doodle.jpg, make the next one google.com/doodle1.jpg, doodle2.jpg etc. The URL will still have to be sent along with the HTML code, so there’s no harm in sending a different URL for the new doodle. In this way, the client can be allowed to cache the resource indefinitely - as long as a change in the resource will be saved as a new URL.</p>
<h2 id="Surrogate_vs_natural_keys_in_URLs">Surrogate vs natural keys in URLs</h2>
<p>Imagine a scenario where we published books on the internet, with any number of related pages. The catch is, the pages may change over time. Maybe the publisher corrected some errors, added an appendix etc. This rules out setting an expiry header on the individual page resources since we have to be sure we always fetch the most recent version.</p>
<p>There are two ways we might store the data in the database. Here’s one:</p>
<figure class="highlight"><pre><span class="attr_selector">[tblBooks]</span>  
<span class="tag">BookID</span>, <span class="tag">Name</span>
</pre></figure>


<figure class="highlight"><pre>[tblPages]  
BookID, <span class="built_in">Number</span>, Data
</pre></figure>

<p>In this example, we use the page’s natural key, a composite of the BookID and Number columns. The pages of a book will always be numbered 1..n and there can be no two pages with the same number, so we have a unique index. Using this table layout, our resource URLs would probably look like this: /Books/[BookID]/[Number]. This means page 2 of the book with ID 5 will always have the same URL: /Books/5/2. Since the URL is the same, the resource might change (if the page is replaced), and we can’t predict when the change will occur (a publisher can do it at any point), we have to rely on last-modified/etags and have the client perform if-modified since requests.</p>
<p>A second way to store the data in the database would be this:</p>
<figure class="highlight"><pre><span class="attr_selector">[tblBooks]</span>  
<span class="tag">BookID</span>, <span class="tag">Name</span>
</pre></figure>


<figure class="highlight"><pre>[tblPages]  
PageID, BookID, <span class="built_in">Number</span>, Data
</pre></figure>

<p>The difference being that we’ve introduced a surrogate key in the tblPages table: PageID. This allows us to use URLs like this: /Books/[BookID]/[PageID]. While not as user friendly, it allows us to set an indefinite expiry header and thereby allowing the client to avoid server requests completely.</p>
<h2 id="Adding_versions_to_URLs">Adding versions to URLs</h2>
<p>Keeping with the book/pages example, let’s add a [LastModified] column to the [tblPages] table:</p>
<figure class="highlight"><pre>[tblPages]
BookID, <span class="built_in">Number</span>, Data, LastModified
</pre></figure>

<p>We still have a natural key, but now we also store the last modification date of the row - this could either be an application updated value or a database timestamp. The idea is to preserve the natural key in the URLs, but add the LastModified value to the URL for no other reason than to generate a new resource URL when it changes. The first URL might be /Books/5/2/?v=2009-03-08_11:25:00, while the updated version of the page will result in a URL like this: /Books/5/2/?v=2009-03-10_07:32:00. The v parameter is not used for anything serverside, but to the client, it’s a completely unrelated URL and will thus ignore the previously cached resource. This way we can keep the natural base URL the same while still forcing clients to request the new resource whenever it’s changed.</p>
<h2 id="Recap">Recap</h2>
<p>While properly utilizing caching headers itself is an often overlooked issue, it can be further improved by choosing resource URLs wisely. By combining correct caching headers with changing resource URLs, we can effectively allow the client to cache resources entirely clientside for just the right amount of time, resulting in increased performance for both servers and clients. It’s no silver bullet as caching strategies will always be very domain specific - make sure you understand your domain and create a caching strategy accordingly.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Feb</span>
			<span class="day">15</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/utilizing-transactional-ntfs-through-dotnet/" title="Utilizing Transactional NTFS Through .NET" rel="bookmark">Utilizing Transactional NTFS Through .NET</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>We’re used to using transactions when dealing with the database layer. Transactions ensure we can perform multiple queries as one atomic event, either they all succed or they all fail, obeying the rules of <a href="http://en.wikipedia.org/wiki/ACID" target="_blank">ACIDity</a>. Until Vista, performing transactional file operations haven’t been possible.</p>
<a id="more"></a>

<p>Transaction NTFS (or TxF) is available from Vista and onwards, which means Server 2008 is also capable. XP and Server 2003 do not support TxF and there are currently no plans of adding TxF support in systems previous to Vista.</p>
<p>So what is the benefit of using TxF? The benefit is that we can now perform ACID operations in the file level, meaning we can perform several file operations (whether that be moves, deletions, creations etc) and make sure all of them are committed atomically. It also provides isolation from/for other processes, so whenever a transaction has been started, we will always see a consistent view of a view until we have committed the transaction, even though it has been modified otherwhere. Surendra Verma has a great video on Channel 9 <a href="http://channel9.msdn.com/shows/Going+Deep/Surendra-Verma-Vista-Transactional-File-System/" target="_blank">explaining TxF</a>. Jon Cargille and Christian Allred has another video on Channel 9 that goes even more in-depth on the <a href="http://channel9.msdn.com/shows/Going+Deep/Transactional-Vista-Kernel-Transaction-Manager-and-friends-TxF-TxR/" target="_blank">inner workings on TxF and the Vista KTM</a>.</p>
<p>Why hasn’t TxF gotten more momentum? Most likely because it’s not part of the BCL! To utilize TxF we have to call Win32 API functions, which is a big step away from lazily utilizing database transactions by just wrapping our code inside of a <a href="http://msdn.microsoft.com/en-us/library/system.transactions.transactionscope.aspx" target="_blank">TransactionScope</a>.</p>
<p>Using TxF is actually quite simple once we’ve made a couple of necessary managed wrapper classes. Let me present you to KtmTransactionHandle:</p>
<figure class="highlight csharp"><pre><span class="keyword">using</span> System;
<span class="keyword">using</span> System.ComponentModel;
<span class="keyword">using</span> System.Runtime.InteropServices;
<span class="keyword">using</span> System.Transactions;
<span class="keyword">using</span> Microsoft.Win32.SafeHandles;

namespace TxFTest
{
	<span class="keyword">public</span> <span class="keyword">class</span> KtmTransactionHandle : SafeHandleZeroOrMinusOneIsInvalid
	{
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> http://msdn.microsoft.com/en-us/library/aa344210(VS.85).aspx</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		[ComImport]
		[InterfaceType(ComInterfaceType.InterfaceIsIUnknown)]
		[Guid(<span class="string">"79427A2B-F895-40e0-BE79-B57DC82ED231"</span>)]
		<span class="keyword">private</span> <span class="keyword">interface</span> IKernelTransaction
		{
			<span class="keyword">void</span> GetHandle([Out] <span class="keyword">out</span> IntPtr handle);
		}

		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> http://msdn.microsoft.com/en-us/library/ms724211.aspx</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		[DllImport(<span class="string">"kernel32"</span>)]
		<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">bool</span> <span class="title">CloseHandle</span>(IntPtr handle);

		<span class="keyword">private</span> <span class="title">KtmTransactionHandle</span>(IntPtr handle): <span class="title">base</span>(<span class="keyword">true</span>)
		{
			<span class="keyword">this</span>.handle = handle;
		}

		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> http://msdn.microsoft.com/en-us/library/cc303707.aspx</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		<span class="keyword">public</span> <span class="keyword">static</span> KtmTransactionHandle <span class="title">CreateKtmTransactionHandle</span>()
		{
			<span class="keyword">if</span> (Transaction.Current == <span class="keyword">null</span>)
				<span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">"Cannot create a KTM handle without Transaction.Current"</span>);

			<span class="keyword">return</span> KtmTransactionHandle.CreateKtmTransactionHandle(Transaction.Current);
		}

		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> http://msdn.microsoft.com/en-us/library/cc303707.aspx</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		<span class="keyword">public</span> <span class="keyword">static</span> KtmTransactionHandle <span class="title">CreateKtmTransactionHandle</span>(Transaction managedTransaction)
		{
			IKernelTransaction tx = (IKernelTransaction)TransactionInterop.GetDtcTransaction(Transaction.Current);
			IntPtr txHandle;
			tx.GetHandle(<span class="keyword">out</span> txHandle);

			<span class="keyword">if</span> (txHandle == IntPtr.Zero)
				<span class="keyword">throw</span> <span class="keyword">new</span> Win32Exception(<span class="string">"Could not get KTM transaction handle."</span>);

			<span class="keyword">return</span> <span class="keyword">new</span> KtmTransactionHandle(txHandle);
		}

		<span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">bool</span> <span class="title">ReleaseHandle</span>()
		{
			<span class="keyword">return</span> CloseHandle(handle);
		}
	}
}
</pre></figure>

<p>The KtmTransactionHandle represents a specific transaction going on inside of the <a href="http://en.wikipedia.org/wiki/Kernel_Transaction_Manager" target="_blank">KTM</a>. In the code, there’s references for further reading of the specific fucntions, most of them stemming from MSDN. Note that the CreateTransactionHandle method assumes there’s already a current transaction, if there is not, an exception will be thrown.</p>
<p>The second class we need is called TransactedFile. I basically made this to be used as a direct replacement of System.IO.File. It does not include all of the functionality of System.IO.File, but it does have the two most important ones, Open and Delete - most of the other functions are just wrappers of these two, so they are easily appended later on.</p>
<figure class="highlight csharp"><pre><span class="keyword">using</span> System;
<span class="keyword">using</span> System.ComponentModel;
<span class="keyword">using</span> System.IO;
<span class="keyword">using</span> System.Runtime.InteropServices;
<span class="keyword">using</span> Microsoft.Win32.SafeHandles;

namespace TxFTest
{
	<span class="keyword">public</span> <span class="keyword">class</span> TransactedFile
	{
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> http://msdn.microsoft.com/en-us/library/aa363916(VS.85).aspx</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		[DllImport(<span class="string">"kernel32"</span>, SetLastError=<span class="keyword">true</span>)]
		<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">bool</span> <span class="title">DeleteFileTransactedW</span>(
			[<span class="title">MarshalAs</span>(UnmanagedType.LPWStr)]<span class="keyword">string</span> file,
			KtmTransactionHandle transaction);

		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> http://msdn.microsoft.com/en-us/library/aa363859(VS.85).aspx</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		[DllImport(<span class="string">"kernel32"</span>, SetLastError=<span class="keyword">true</span>)]
		<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> SafeFileHandle <span class="title">CreateFileTransactedW</span>(
			[<span class="title">MarshalAs</span>(UnmanagedType.LPWStr)]<span class="keyword">string</span> lpFileName,
			NativeFileAccess dwDesiredAccess,
			NativeFileShare dwShareMode,
			IntPtr lpSecurityAttributes,
			NativeFileMode dwCreationDisposition,
			<span class="keyword">int</span> dwFlagsAndAttributes,
			IntPtr hTemplateFile,
			KtmTransactionHandle hTransaction,
			IntPtr pusMiniVersion,
			IntPtr pExtendedParameter);

		[Flags]
		<span class="keyword">private</span> <span class="keyword">enum</span> NativeFileShare
		{
			FILE_SHARE_NONE = <span class="number">0x00</span>,
			FILE_SHARE_READ = <span class="number">0x01</span>,
			FILE_SHARE_WRITE = <span class="number">0x02</span>,
			FILE_SHARE_DELETE = <span class="number">0x04</span>
		}

		[Flags]
		<span class="keyword">private</span> <span class="keyword">enum</span> NativeFileMode
		{
			CREATE_NEW = <span class="number">1</span>,
			CREATE_ALWAYS = <span class="number">2</span>,
			CREATE_EXISTING = <span class="number">3</span>,
			OPEN_ALWAYS = <span class="number">4</span>,
			TRUNCATE_EXISTING = <span class="number">5</span>
		}

		[Flags]
		<span class="keyword">private</span> <span class="keyword">enum</span> NativeFileAccess
		{
			GENERIC_READ = <span class="keyword">unchecked</span>((<span class="keyword">int</span>)<span class="number">0x80000000</span>),
			GENERIC_WRITE = <span class="number">0x40000000</span>
		}

		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> Transaction aware implementation of System.IO.File.Open</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="path"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="mode"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="access"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="share"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span>
		<span class="keyword">public</span> <span class="keyword">static</span> FileStream <span class="title">Open</span>(<span class="keyword">string</span> path, FileMode mode, FileAccess access, FileShare share)
		{
			<span class="keyword">using</span> (KtmTransactionHandle ktmHandle = KtmTransactionHandle.CreateKtmTransactionHandle())
			{
				SafeFileHandle fileHandle = CreateFileTransactedW(
					path,
					TranslateFileAccess(access),
					TranslateFileShare(share),
					IntPtr.Zero,
					TranslateFileMode(mode),
					<span class="number">0</span>,
					IntPtr.Zero,
					ktmHandle,
					IntPtr.Zero,
					IntPtr.Zero);

				<span class="keyword">if</span> (fileHandle.IsInvalid)
					<span class="keyword">throw</span> <span class="keyword">new</span> Win32Exception(Marshal.GetLastWin32Error());

				<span class="keyword">return</span> <span class="keyword">new</span> FileStream(fileHandle, access);
			}
		}

		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> Reads all text from a file as part of a transaction</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="path"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="contents"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span>
		<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">ReadAllText</span>(<span class="keyword">string</span> path)
		{
			<span class="keyword">using</span> (StreamReader reader = <span class="keyword">new</span> StreamReader(Open(path, FileMode.Open, FileAccess.Read, FileShare.Read)))
			{
				<span class="keyword">return</span> reader.ReadToEnd();
			}
		}

		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> Writes text to a file as part of a transaction</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="path"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="contents"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">WriteAllText</span>(<span class="keyword">string</span> path, <span class="keyword">string</span> contents)
		{
			<span class="keyword">using</span> (StreamWriter writer = <span class="keyword">new</span> StreamWriter(Open(path, FileMode.OpenOrCreate, FileAccess.Write, FileShare.None)))
			{
				writer.Write(contents);
			}
		}

		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> Deletes a file as part of a transaction</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="file"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Delete</span>(<span class="keyword">string</span> file)
		{
			<span class="keyword">using</span> (KtmTransactionHandle ktmHandle = KtmTransactionHandle.CreateKtmTransactionHandle())
			{
				<span class="keyword">if</span> (!DeleteFileTransactedW(file, ktmHandle))
					<span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Unable to perform transacted file delete."</span>);
			}
		}

		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> Managed -&gt; Native mapping</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="mode"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span>
		<span class="keyword">private</span> <span class="keyword">static</span> NativeFileMode <span class="title">TranslateFileMode</span>(FileMode mode)
		{
			<span class="keyword">if</span> (mode != FileMode.Append)
				<span class="keyword">return</span> (NativeFileMode)(<span class="keyword">int</span>)mode;
			<span class="keyword">else</span>
				<span class="keyword">return</span> (NativeFileMode)(<span class="keyword">int</span>)FileMode.OpenOrCreate;
		}

		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> Managed -&gt; Native mapping</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="access"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span>
		<span class="keyword">private</span> <span class="keyword">static</span> NativeFileAccess <span class="title">TranslateFileAccess</span>(FileAccess access)
		{
			<span class="keyword">if</span> (access == FileAccess.Read)
				<span class="keyword">return</span> NativeFileAccess.GENERIC_READ;
			<span class="keyword">else</span>
				<span class="keyword">return</span> NativeFileAccess.GENERIC_WRITE;
		}

		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> Direct Managed -&gt; Native mapping</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="share"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span>
		<span class="keyword">private</span> <span class="keyword">static</span> NativeFileShare <span class="title">TranslateFileShare</span>(FileShare share)
		{
			<span class="keyword">return</span> (NativeFileShare)(<span class="keyword">int</span>)share;
		}
	}
}
</pre></figure>

<p>The primary two API functions used are <a href="http://msdn.microsoft.com/en-us/library/aa363916(VS.85" target="_blank">DeleteFileTransactedW</a>.aspx) and <a href="http://msdn.microsoft.com/en-us/library/aa363859(VS.85" target="_blank">CreateFileTransactedW</a>.aspx). Note that these functions are the ‘W’ versions, accepting unicode paths for the files. To send the strings as null terminated unicode, we have to add the MarshalAs(UnmanagedType.LPWstr) attribute to the ‘path’ parameter.</p>
<p>The BCL FileMode, FileShare and FileAccess all have native counterparts. The constant values are in the Microsoft.Win32.NativeMethods class, but unfortunately it’s internal so we’ll have to make our own. There are three helper functions for translating between the managed and native versions of FileMode, FileShare and FileAccess.</p>
<p>The Open and Delete methods both try to obtain a KTM transaction handle as their first action. If a current transaction does not exist, they will throw an exception since KtmTransactionHandle assumes one exists. We could modify these to either perform a transacted operation or non transacted, depending on the availability of a current transaction, but in this case we’re explicitly assuming a transaction will be available.</p>
<p>Next up the Delete operation will attempt to delete the file using the DeleteFileTransactedW function, passing in the KTM transaction handle. The Open function first tries to obtain a <a href="http://msdn.microsoft.com/en-us/library/microsoft.win32.safehandles.safefilehandle.aspx" target="_blank">SafeFileHandle</a> for the file, which is basically a wrapper class around a normal file handle. Using the SafeFileHandle, we can create a new FileStream, passing in the file handle as a parameter.</p>
<p>Using these two classes, we can now perform transactional file operations:</p>
<figure class="highlight csharp"><pre>using System;
using System.Data.SqlClient;
using System.Transactions;

namespace TxFTest
{
	class Program
	{
		static void Main(string[] args)
		{
			try
			{
				using (var ts = new TransactionScope())
				{
					TransactedFile.WriteAllText(<span class="string">"test.txt"</span>, <span class="string">"hello world"</span>);
				}

				// At this point test.txt does not exist since we didn't ts.complete()

				using (var ts = new TransactionScope())
				{
					TransactedFile.WriteAllText(<span class="string">"test.txt"</span>, <span class="string">"hello world"</span>);

					// The transaction hasn't been committed, so the file is still not logically available outisde
					// of the transaction, but it is available inside of the transaction
					Console.WriteLine(TransactedFile.ReadAllText(<span class="string">"test.txt"</span>));

					// After the transaction is committed, the file is available outside of the transaction
					ts.Complete();
				}

				// Since the TransactionScope works for both database and files, we can combine the two. This is great for ensuring
				// integrity when we store database related files
				using (var ts = new TransactionScope())
				{
					SqlCommand cmd = new SqlCommand(<span class="string">"INSERT INTO SomeTable (A, B) VALUES ('a', 'b'); SELECT @@IDENTITY"</span>);
					int insertedID = Convert.ToInt32(cmd.ExecuteScalar());

					TransactedFile.WriteAllText(insertedID + <span class="string">".txt"</span>, <span class="string">"Blob file related to inserted database row"</span>);

					ts.Complete();
				}
			}
			catch (Exception ex)
			{
				Console.WriteLine(ex);
			}

			Console.Write(<span class="string">"Done"</span>);
			Console.Read();
		}
	}
}
</pre></figure>

<p>Note that the KTM transaction is able to participate in a distributed transaction using the MS DTC service. That means we can both perform database and file operations inside of a transaction scope and have all of them performed ACIDically.</p>
<p>Using transactions comes at a cost - performance. Since the system has to guarantee the ACID properties are respected, there will be administrative overhead as well as the possibility of extra disk activity. Whenever we modify an existing file, the original file is left untouched until the new file has been written to disk, otherwise we might risk destryoying the original file if the computer were to crash halfways through a write procedure.</p>
<p>There are of course <a href="http://msdn.microsoft.com/en-us/library/aa365738(VS.85" target="_blank">limitations in TxF</a>.aspx), as there are in all good things. Most notably it’ll only work for local volumes, you can’t use TxF on file shares as it’s not supported by the CIFS/SMB protocols.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>


<div class="paging">
	<a href="/page/15/"><div class="past">« Past</div></a>
	<a href="/page/13/"><div class="future">Future »</div></a>
	<div class="clear"></div>
</div>

				</div>
			</div>

			<div id="asides">
				<div class="categories aside">
					<span class="sectiontitle">CATEGORIES</span>
					<ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/category/.NET/">.NET</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/AS/Flex/Flash/">AS/Flex/Flash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Amazon Web Services/">Amazon Web Services</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Computer Science/">Computer Science</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Conferences and Presenting/">Conferences and Presenting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/IIS/">IIS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Life/">Life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Miscellaneous/">Miscellaneous</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Performance/">Performance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Poker/">Poker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server/">SQL Server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Community/">SQL Server - Community</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Data Types/">SQL Server - Data Types</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Internals/">SQL Server - Internals</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Optimization/">SQL Server - Optimization</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Tricks/">SQL Server - Tricks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Testing/">Testing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Tools of the Trade/">Tools of the Trade</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Umbraco/">Umbraco</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Visual Studio/">Visual Studio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Web/">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windbg/">Windbg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windows/">Windows</a></li></ul>

					
				</div>

				<div class="archive aside">
					<span class="sectiontitle">ARCHIVE</span>
					<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archive/2014">2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2013">2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2012">2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2011">2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2010">2010</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2009">2009</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2008">2008</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2007">2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2006">2006</a></li></ul>
				</div>
			</div>

			<div class="clear"></div>
		</div>
		
		<footer>
			<div class="wrapper">Copyright &copy; 2014 Mark S. Rasmussen</div>
		</footer>

		<script type="text/javascript">
			$(function () {
				// Show mobile menu
				$("li.navicon").click(function () {
					if ($("header ul.mobile a").length == 0) {
						// Pages
						$mobilePages = $("div#naviconcontent ul.pages");
						$("header nav ul.normal > li").not(".navicon").each(function (i, el) {
							$mobilePages.append($(el).clone());
						});

						// Categories
						$mobileCategories = $("div#naviconcontent ul.categories");
						$("div#asides div.categories > ul > li").each(function (i, el) {
							$mobileCategories.append($(el).clone());
						});

						// Archive
						$mobileArchive = $("div#naviconcontent ul.archive");
						$("div#asides div.archive > ul > li").each(function (i, el) {
							$mobileArchive.append($(el).clone());
						});
					};

					$("header ul.mobile").toggle();
				});

				// Fancybox setup
				$("a.fancy").fancybox({
					hideOnContentClick: true,
					overlayShow: true
				});
			});
		</script>
	</body>
</html>