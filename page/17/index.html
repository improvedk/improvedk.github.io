<!DOCTYPE html>
<html>
	

<head>
	<title>Mark S. Rasmussen</title>
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
	<meta charset="UTF-8" />
	<meta property="og:locale" content="en_US" />
	<meta property="og:type" content="website" />
	<meta name="google-site-verification" content="alt7-wfK3ZujMQ4D0jYNd0yC5LGetGdqBlBmZsqQlVw" />
	<meta content="article" property="og:type">
<meta content="Mark S. Rasmussen" property="og:title">
<meta content="http://improve.dk/page/17/" property="og:url">
<meta property="og:image">
<meta content="Mark S. Rasmussen" property="og:site_name">
<meta property="og:description">
<meta content="summary" name="twitter:card">
	<link rel="alternative" href="http://feeds.feedburner.com/Improvedk" title="Mark S. Rasmussen" type="application/atom+xml">
	<script src="/js/combined.js"></script>
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-2479580-1', 'improve.dk');
		ga('require', 'displayfeatures');
		ga('send', 	'pageview');
	</script>
	<link rel="stylesheet" href="/css/style.css" type="text/css" />
</head>
	<body>
		<div id="headerline"></div>
	
		<header>
			<div class="wrapper">
				<div id="title">
					<a href="/">Mark S. Rasmussen</a> <span>improve.dk</span>
				</div>
				
				<nav>
					<ul class="normal">
						<li class="navicon"></li>
						<li><a href="/about-me/">About Me</a></li>
					</ul>
				</nav>
				
				<ul id="sharing">
					<li><a href="mailto:mark@improve.dk" id="shareat"></a></li>
					<li><a href="http://feeds.feedburner.com/Improvedk" id="rssfeed"></a></li>
					<li><a href="https://twitter.com/improvedk" id="sharetwitter"></a></li>
					<li><a href="https://github.com/improvedk" id="sharegithub"></a></li>
					<li><a href="https://www.linkedin.com/in/markrasmussen/" id="sharelinkedin"></a></li>
				</ul>

				<div class="clear"></div>
				
				<div id="naviconcontent">
					<ul class="mobile">
						<li>
							Pages
							<ul class="pages"></ul>
						</li>
						<li>
							Categories
							<ul class="categories"></ul>
						</li>
						<li>
							Archive
							<ul class="archive"></ul>
						</li>
					</ul>
				</div>
			</div>
		</header>

		<div id="mainwrapper">
			<div id="contentwrapper">
				<div id="content">
				
					
	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Apr</span>
			<span class="day">30</span>
		</div>
		<div class="lower">2008</div>
	</div>

	<div class="title">
		<h1><a href="/performance-comparison-reading-data-from-the-database-strongly-typed/" title="Performance Comparison - Reading Data From the Database Strongly Typed" rel="bookmark">Performance Comparison - Reading Data From the Database Strongly Typed</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I’m a big fan of strongly typed database querying as well as returning strong typed results. Due to the nature of static languages, you’ll get compile time checking of all our tables and columns. You can easily rename columns as you can be sure all your (internal) references are accounted for.</p>
<a id="more"></a>

<p>Returning strongly typed lists of objects instead of DataReaders/DataTables / any other object based containers will also make it easier to transfer through data layers as you’re always certain of what’s available for you to read and what’s not.</p>
<p>But it comes at a cost. Performance.</p>
<p>I set out to test various different ways we could query our database and generate a strongly typed List with the results in it. I’m using the <a href="http://codeplex.com/SqlServerSamples" target="_blank">standard AdventureWorks 2005 database</a> for my testing. For the actual profiling, I’ll be using <a href="/profiling-code-the-easy-way/">my CodeProfiler class</a> from a previous blogpost.</p>
<p>I’ll be using two different entities, Product and CompleteProduct:</p>
<figure class="highlight cs"><pre>[Table(Name = <span class="string">"Production.Product"</span>)]
<span class="keyword">public</span> <span class="keyword">class</span> Product
{
	[Column]
	<span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">int</span> ProductID { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">string</span> Name { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">string</span> ProductNumber { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">bool</span> MakeFlag { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">short</span> SafetyStockLevel { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">decimal</span> ListPrice { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">virtual</span> DateTime SellStartDate { <span class="keyword">get</span>; <span class="keyword">set</span>; }
}

[Table(Name = <span class="string">"Production.Product"</span>)]
<span class="keyword">public</span> <span class="keyword">class</span> CompleteProduct
{
	[Column]
	<span class="keyword">public</span> <span class="keyword">int</span> ProductID { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">string</span> Name { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">string</span> ProductNumber { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">bool</span> MakeFlag { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">bool</span> FinishedGoodsFlag { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">string</span> Color { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">short</span> SafetyStockLevel { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">short</span> ReorderPoint { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">decimal</span> StandardCost { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">decimal</span> ListPrice { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">string</span> Size { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">string</span> SizeUnitMeasureCode { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">string</span> WeightUnitMeasureCode { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">decimal</span>? Weight { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">int</span> DaysToManufacture { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">string</span> ProductLine { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">string</span> Class { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">string</span> Style { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">int</span>? ProductSubcategoryID { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> <span class="keyword">int</span>? ProductModelID { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> DateTime SellStartDate { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> DateTime? SellEndDate { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> DateTime? DiscontinuedDate { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> Guid rowguid { <span class="keyword">get</span>; <span class="keyword">set</span>; }
	[Column]
	<span class="keyword">public</span> DateTime ModifiedDate { <span class="keyword">get</span>; <span class="keyword">set</span>; }
}
</pre></figure>

<p>They both map to the same table, Production.Product. CompleteProduct covers all columns, Product just covers the ones I’m interested in.</p>
<h2 id="Method_#1_-_Manually_mapping_from_DataReader">Method #1 - Manually mapping from DataReader</h2>
<figure class="highlight cs"><pre><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">performDataReader</span>()
{
	<span class="keyword">var</span> result = <span class="keyword">new</span> List&lt;Product&gt;();

	<span class="keyword">using</span> (SqlConnection conn = <span class="keyword">new</span> SqlConnection(CONNECTION_STRING))
	{
		<span class="keyword">using</span> (SqlCommand cmd = conn.CreateCommand())
		{
			cmd.CommandText = COMMAND_TEXT;

			conn.Open();
			<span class="keyword">using</span> (SqlDataReader sqldr = cmd.ExecuteReader())
			{
				<span class="keyword">while</span> (sqldr.Read())
				{
					Product p = <span class="keyword">new</span> Product();
					p.ProductID = Convert.ToInt32(sqldr[<span class="string">"ProductID"</span>]);
					p.Name = sqldr[<span class="string">"Name"</span>].ToString();
					p.ProductNumber = sqldr[<span class="string">"ProductNumber"</span>].ToString();
					p.MakeFlag = Convert.ToBoolean(sqldr[<span class="string">"MakeFlag"</span>]);
					p.SafetyStockLevel = Convert.ToInt16(sqldr[<span class="string">"SafetyStockLevel"</span>]);
					p.ListPrice = Convert.ToDecimal(sqldr[<span class="string">"ListPrice"</span>]);
					p.SellStartDate = Convert.ToDateTime(sqldr[<span class="string">"SellStartDate"</span>]);

					result.Add(p);
				}
			}
		}
	}
}
</pre></figure>

<p>Pros: <em>Fast</em></p>
<p>Cons: <em>Has to be written for each object model</em></p>
<h2 id="Method_#2_-_Manully_mapping_from_DataTable">Method #2 - Manully mapping from DataTable</h2>
<figure class="highlight cs"><pre><span class="keyword">private</span> <span class="keyword">static</span> DataTable <span class="title">getDT</span>()
{
	DataTable result = <span class="keyword">new</span> DataTable();

	<span class="keyword">using</span> (SqlConnection conn = <span class="keyword">new</span> SqlConnection(CONNECTION_STRING))
	{
		<span class="keyword">using</span> (SqlCommand cmd = conn.CreateCommand())
		{
			cmd.CommandText = COMMAND_TEXT;

			<span class="keyword">using</span> (SqlDataAdapter sqlda = <span class="keyword">new</span> SqlDataAdapter(cmd))
				sqlda.Fill(result);
		}
	}

	<span class="keyword">return</span> result;
}

<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">performDataTable</span>()
{
	<span class="keyword">var</span> result = <span class="keyword">new</span> List&lt;Product&gt;();

	<span class="keyword">foreach</span> (DataRow dr <span class="keyword">in</span> getDT().Rows)
	{
		Product p = <span class="keyword">new</span> Product();
		p.ProductID = Convert.ToInt32(dr[<span class="string">"ProductID"</span>]);
		p.Name = dr[<span class="string">"Name"</span>].ToString();
		p.ProductNumber = dr[<span class="string">"ProductNumber"</span>].ToString();
		p.MakeFlag = Convert.ToBoolean(dr[<span class="string">"MakeFlag"</span>]);
		p.SafetyStockLevel = Convert.ToInt16(dr[<span class="string">"SafetyStockLevel"</span>]);
		p.ListPrice = Convert.ToDecimal(dr[<span class="string">"ListPrice"</span>]);
		p.SellStartDate = Convert.ToDateTime(dr[<span class="string">"SellStartDate"</span>]);

		result.Add(p);
	}
}
</pre></figure>

<p>Pros: <em>Pretty fast, easy row access, disconnected from database</em></p>
<p>Cons: <em>Has to be written for each object model</em></p>
<p>Comment: <em>I often use a getDT()’ish way of accessing my tables. It’s easier than using DataReaders as they’re disconnected, you can traverse them back and forth multiple times.</em></p>
<h2 id="Method_#3_-_Automatic_mapping_using_DataContext-Translate">Method #3 - Automatic mapping using DataContext.Translate</h2>
<figure class="highlight cs"><pre><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">performEntityQuery</span>()
{
	List&lt;Product&gt; result;

	<span class="keyword">using</span> (SqlConnection conn = <span class="keyword">new</span> SqlConnection(CONNECTION_STRING))
	{
		<span class="keyword">using</span> (DataContext dc = <span class="keyword">new</span> DataContext(conn))
		{
			<span class="keyword">using</span> (SqlCommand cmd = conn.CreateCommand())
			{
				cmd.CommandText = COMMAND_TEXT;

				conn.Open();
				<span class="keyword">using</span>(SqlDataReader sqldr = cmd.ExecuteReader())
				{
					result = dc.Translate&lt;Product&gt;(sqldr).ToList();
				}
			}
		}
	}
}
</pre></figure>

<p>Pros: <em>Works for all object models, easy to use</em></p>
<p>Cons: <em>Slow</em></p>
<h2 id="Method_#4_-_Linq_to_SQL_query_for_complete_entity">Method #4 - Linq to SQL query for complete entity</h2>
<figure class="highlight cs"><pre><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">performLinqQuery</span>()
{
	List&lt;Product&gt; result;

	<span class="keyword">using</span>(DataContext dc = <span class="keyword">new</span> DataContext(CONNECTION_STRING))
	{
		result = dc.GetTable&lt;Product&gt;().OrderBy(p =&gt; p.ProductID).Take(rowcount).ToList();
	}
}
</pre></figure>

<p>Pros: <em>Could it be easier? Works for all object models</em></p>
<p>Cons: <em>Slow</em></p>
<h2 id="Method_#5_-_Linq_to_SQL_query_for_partial_entity">Method #5 - Linq to SQL query for partial entity</h2>
<figure class="highlight cs"><pre><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">performSubsetLinqQuery</span>()
{
	List&lt;Product&gt; result;

	<span class="keyword">using</span> (DataContext dc = <span class="keyword">new</span> DataContext(CONNECTION_STRING))
	{
		result = dc.GetTable&lt;CompleteProduct&gt;().OrderBy(p =&gt; p.ProductID).Take(rowcount).Select(p =&gt; <span class="keyword">new</span> Product() {
			ListPrice = p.ListPrice,
			ProductID = p.ProductID,
			MakeFlag = p.MakeFlag,
			Name = p.Name,
			ProductNumber = p.ProductNumber,
			SafetyStockLevel = p.SafetyStockLevel,
			SellStartDate = p.SellStartDate }).ToList();
	}
}
</pre></figure>

<p>Pros: <em>Easy, works for all object models</em></p>
<p>Cons: <em>Slow</em></p>
<p>Comments: <em>In the previous method I retrieved complete Product entities. This time I’m retrieving only some columns of the CompleteProduct entity, mapping them over into a new Product. I’ve included this to see if there’s any performance difference in comparison to loading complete entities.</em></p>
<h2 id="Method_#6_-_Automatically_mapping_from_DataReader">Method #6 - Automatically mapping from DataReader</h2>
<figure class="highlight cs"><pre><span class="keyword">private</span> <span class="keyword">static</span> List&lt;T&gt; mapList&lt;T&gt;(SqlDataReader dr)
{
	List&lt;T&gt; list = <span class="keyword">new</span> List&lt;T&gt;();

	PropertyInfo[] properties = <span class="keyword">typeof</span>(T).GetProperties();
	T t = Activator.CreateInstance&lt;T&gt;();

	<span class="keyword">while</span>(dr.Read())
	{
		<span class="keyword">foreach</span> (PropertyInfo pi <span class="keyword">in</span> properties)
			pi.SetValue(t, dr[pi.Name], <span class="keyword">null</span>);

		list.Add(t);
	}

	<span class="keyword">return</span> list;
}

<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">performAutomappedDataReader</span>()
{
	List&lt;Product&gt; result;

	<span class="keyword">using</span> (SqlConnection conn = <span class="keyword">new</span> SqlConnection(CONNECTION_STRING))
	{
		<span class="keyword">using</span> (SqlCommand cmd = conn.CreateCommand())
		{
			cmd.CommandText = COMMAND_TEXT;

			conn.Open();
			<span class="keyword">using</span> (SqlDataReader sqldr = cmd.ExecuteReader())
			{
				result = mapList&lt;Product&gt;(sqldr);
			}
		}
	}
}
</pre></figure>

<p>Pros: <em>Simple to use, works for all object models</em></p>
<p>Cons: <em>Slow, reflection based</em></p>
<h2 id="Method_#7_-_Enhanced_automatic_mapping_from_DataReader">Method #7 - Enhanced automatic mapping from DataReader</h2>
<figure class="highlight cs"><pre><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">performEnhancedAutomappedDataReader</span>()
{
	List&lt;Product&gt; result;

	<span class="keyword">using</span> (SqlConnection conn = <span class="keyword">new</span> SqlConnection(CONNECTION_STRING))
	{
		<span class="keyword">using</span> (SqlCommand cmd = conn.CreateCommand())
		{
			cmd.CommandText = COMMAND_TEXT;

			conn.Open();
			<span class="keyword">using</span> (SqlDataReader sqldr = cmd.ExecuteReader())
			{
				result = EntityMapper.MapToEntities&lt;Product&gt;(sqldr).ToList();
			}
		}
	}
}
</pre></figure>

<p>Pros: <em>???</em></p>
<p>Cons: <em>???</em></p>
<p>Comments: <em>This is an enhanced version of the previous method that I’ve made. Explaining the inner workings is outside the scope of this particular topic so I’ll have to explain it in my next post. For now, just imagine something very cool and sexy. UPDATE: <a href="/mapping-datareader-to-objects-using-reflection-emit/">you can read about the method here</a>.</em></p>
<h2 id="Method_#8_-_SubSonic_SqlQuery">Method #8 - SubSonic SqlQuery</h2>
<figure class="highlight cs"><pre><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">performSubSonicQuery</span>()
{
	List&lt;Product&gt; result =
		<span class="keyword">new</span> Select
			(
				Subsonic.Product.ProductIDColumn.QualifiedName,
				Subsonic.Product.NameColumn.QualifiedName,
				Subsonic.Product.ProductNumberColumn.QualifiedName,
				Subsonic.Product.MakeFlagColumn.QualifiedName,
				Subsonic.Product.SafetyStockLevelColumn.QualifiedName,
				Subsonic.Product.ListPriceColumn.QualifiedName,
				Subsonic.Product.SellStartDateColumn.QualifiedName
			)
			.Top(rowcount.ToString())
			.From(Subsonic.Product.Schema)
			.OrderAsc(Subsonic.Product.ProductIDColumn.QualifiedName)
			.ExecuteTypedList&lt;Product&gt;();
}
</pre></figure>

<p>Pros: <em>Works for all object models</em></p>
<p>Cons: <em>Slow</em></p>
<p>Comments: <em>I’ve never used SubSonic before, so I may have overlooked some obvious performance enhancements, thus, take my numbers with a grain of salt.</em></p>
<h2 id="Method_#9_-_NHibernate_CreateCriteria">Method #9 - NHibernate CreateCriteria</h2>
<figure class="highlight cs"><pre><span class="keyword">private</span> <span class="keyword">static</span> Configuration nhCfg;
<span class="keyword">private</span> <span class="keyword">static</span> ISessionFactory nhFactory;

<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">performNHibernateQuery</span>()
{
	List&lt;Product&gt; result;

	<span class="keyword">using</span> (ISession session = nhFactory.OpenSession())
	{
		result = (List&lt;Product&gt;)session.CreateCriteria(<span class="keyword">typeof</span>(Product)).AddOrder(Order.Asc(<span class="string">"ProductID"</span>)).SetMaxResults(rowcount).List&lt;Product&gt;();
	}
}
</pre></figure>

<p>Pros: <em>Easy, works for all object models, concise querying</em></p>
<p>Cons: <em>Slow</em></p>
<p>Comments: <em>I’ve never used NHibernate before, so I may have overlooked some obvious performance enhancements, thus, take my numbers with a grain of salt.</em></p>
<h2 id="Method_#10_-_Compiled_LinqQuery">Method #10 - Compiled LinqQuery</h2>
<figure class="highlight cs"><pre><span class="keyword">private</span> <span class="keyword">static</span> Func&lt;DataContext, <span class="keyword">int</span>, IEnumerable&lt;Product&gt;&gt; compiledQuery;
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">performCompiledLinqQuery</span>()
{
	List&lt;Product&gt; result;

	<span class="keyword">using</span> (DataContext dc = <span class="keyword">new</span> DataContext(CONNECTION_STRING))
	{
		result = compiledQuery(dc, rowcount).ToList();
	}
}
</pre></figure>

<p>Pros: <em>Among the fastest, no matter the rowcount, works for all object models</em></p>
<p>Cons: <em>Requires a bit more setting up and helper functionality to store the compiled queries</em></p>
<h2 id="The_profiling">The profiling</h2>
<p>I profiled each of the test cases by returning 1, 10, 100, 1.000, 10.000 and 100.000 rows. The numbers are the total execution time of 50 iterations of each method. I’m on a quad core machine so I set the max parallelization degree to three, thus saving myself a core for running SQL Server and Windows.</p>
<figure class="highlight cs"><pre><span class="keyword">static</span> <span class="keyword">void</span> Main(<span class="keyword">string</span>[] args)
{
	<span class="comment">// Make sure we don't get disturbed by other processes</span>
	Process.GetCurrentProcess().PriorityClass = ProcessPriorityClass.High;

	<span class="comment">// We'll let NHibernate cache it's Configuration and SessionFactory as we'd probably do this in most live applications</span>
	nhCfg = <span class="keyword">new</span> Configuration();
	nhCfg.AddAssembly(Assembly.GetExecutingAssembly());
	nhFactory = nhCfg.BuildSessionFactory();

	<span class="keyword">foreach</span>(<span class="keyword">int</span> rc <span class="keyword">in</span> <span class="keyword">new</span> <span class="keyword">int</span>[] { <span class="number">1</span>, <span class="number">10</span>, <span class="number">100</span>, <span class="number">1000</span>, <span class="number">10000</span>, <span class="number">100000</span> })<span class="comment">//, 100, 1000, 10000, 100000 })</span>
	{
		Console.WriteLine(<span class="string">"Rowcount: "</span> + rc);
		rowcount = rc;

		<span class="comment">// Set the rowcount</span>
		COMMAND_TEXT = ORIGINAL_COMMAND_TEXT.Replace(<span class="string">"{rowcount}"</span>, rowcount.ToString());

		<span class="comment">// Make sure the enhanced automapped datareader does not use cached resources from previous run</span>
		EntityMapper.ClearCachedMapperMethods();

		<span class="comment">// Compile the query for the compiled linq query test</span>
		compiledQuery = CompiledQuery.Compile&lt;DataContext, <span class="keyword">int</span>, IEnumerable&lt;Product&gt;&gt;((DataContext dc, <span class="keyword">int</span> takeCount) =&gt; dc.GetTable&lt;Product&gt;().OrderBy(p =&gt; p.ProductID).Take(takeCount));

		Console.WriteLine(<span class="string">"performDataReader: "</span> + CodeProfiler.ProfileAction(performDataReader, iterations, <span class="number">3</span>));
		Console.WriteLine(<span class="string">"performDataTable: "</span> + CodeProfiler.ProfileAction(performDataTable, iterations, <span class="number">3</span>));
		Console.WriteLine(<span class="string">"performEntityQuery: "</span> + CodeProfiler.ProfileAction(performEntityQuery, iterations, <span class="number">3</span>));
		Console.WriteLine(<span class="string">"performLinqQuery: "</span> + CodeProfiler.ProfileAction(performLinqQuery, iterations, <span class="number">3</span>));
		Console.WriteLine(<span class="string">"performCompiledLinqQuery: "</span> + CodeProfiler.ProfileAction(performCompiledLinqQuery, iterations, <span class="number">3</span>));
		Console.WriteLine(<span class="string">"performSubsetLinqQuery: "</span> + CodeProfiler.ProfileAction(performSubsetLinqQuery, iterations, <span class="number">3</span>));
		Console.WriteLine(<span class="string">"performAutomappedDataReader: "</span> + CodeProfiler.ProfileAction(performAutomappedDataReader, iterations, <span class="number">3</span>));
		Console.WriteLine(<span class="string">"performEnhancedAutomappedDataReader: "</span> + CodeProfiler.ProfileAction(performEnhancedAutomappedDataReader, iterations, <span class="number">3</span>));
		Console.WriteLine(<span class="string">"performSubSonicQuery: "</span> + CodeProfiler.ProfileAction(performSubSonicQuery, iterations, <span class="number">3</span>));
		Console.WriteLine(<span class="string">"performNHibernateQuery: "</span> + CodeProfiler.ProfileAction(performNHibernateQuery, iterations, <span class="number">3</span>));
	}

	Console.Write(<span class="string">"Done"</span>);
	Console.Read();
}
</pre></figure>

<h2 id="The_results">The results</h2>
<p>The following two graphs shows the total runtime of 50 iterations for each different method, as well as the total runtime divided by number of rows. Runtime in seconds along the Y-axis, number of rows along the X-axis. It basically shows that all LINQ to SQL flavors suffer from initial setup, but they scale extremely well, ending up outperforming all other contestants by a fair margin. One could argue that it’s rarely relevant in cases of more than a thousand rows as we’ll rarely pull out that much data at once. Never the less, I find it interesting - it’s something I’ll have to look under the hood to find an explanation of. Ignoring some variance due to the low row number, DataReader, DataTable and my Enhanced Automapped DataReader functions outperform most contestants.</p>
<p>UPDATE:</p>
<p>It seems the reason the LINQ flavors are so speedy is because their object mapper methods are being cached in the local thread cache. And since the CodeProfiler will execute all iterations on the same thread, each iteration (except the first) will simply reuse the mapper methods. See System.Data.Linq.SqlClient.ObjectReaderCompiler.Compile() for reference.</p>
<p>UPDATE 2:</p>
<p>As <a href="http://www.u2u.info/Blogs/Kris" target="_blank">Kris Vandermotten</a> duly commented, I should have tested a compiled LINQ query as well as that really is a separate scenario. I’ve added a tenth method as well as a new line in the graphs. The compiled LINQ query, although requiring a bit more plumbing code, really blows the competition away. It’s fast for even single row queries since we no longer suffer from the compilation time. For larger rowsets the advantage diminishes as the saved compilation time is spread out over a large amount of rows.</p>
<p>UPDATE 3:</p>
<p>As a friend of mine, <a href="http://intellect.dk/" target="_blank">Jakob Andersen</a> points out, I really should be a bit more specific in regards to the purpose of these comparisons.</p>
<p>I am in no way trying to make the claim that it’s unreasonable that an OR/M framework hurts performance. Neither am I claiming that my comparisons between LINQ to SQL, Subsonic and nHibernate are fair. Really, to make a fair comparison, one should compare the very specific features of the frameworks, not a feature set as general as what I’m doing in these tests.</p>
<p>The thing is, some of these frameworks (nHibernate, I’m looking at you especially) just offer so much more functionality that it’s a burden they have to live with. While this extra functionality might cost a bit when we’re just trying to test the actual object translation performance, it might gain you a whole lot more in real life scenarios. Take for instance, if you utilize nHibernates caching, you might save the time that goes towards the database lookups - saving you much more than the actual translation process in most cases.</p>
<p>So, as mentioned in a couple of tests - take these results with a grain of salt. They’re rather out-of-the-box simple tests of direct querying &amp; result translation performance. We’re ignoring all of the extra OR/M features that we have available, and we’re ignoring that these different frameworks offer very different functionality.</p>
<h3 id="Total_runtime">Total runtime</h3>
<div class="imgwrapper" style=""><div><a href="/performance-comparison-reading-data-from-the-database-strongly-typed/totalgraph1_2.jpg" class="fancy"><img src="/performance-comparison-reading-data-from-the-database-strongly-typed/totalgraph1_2.jpg" style="max-height: 250px"/></a></div></div>

<h3 id="Runtime_per_row">Runtime per row</h3>
<div class="imgwrapper" style=""><div><a href="/performance-comparison-reading-data-from-the-database-strongly-typed/totalgraph2_2.jpg" class="fancy"><img src="/performance-comparison-reading-data-from-the-database-strongly-typed/totalgraph2_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Remember, even though there seems to be somewhat of a speed difference, the fastest method takes only 0,000074 seconds, while the slowest takes 0,00085 seconds. No matter what, you should’nt consider refactoring your solutions in regards to performance unless you really have a high hit count, or unless it’s for valid architectural reasons. Otherwise you might just risk having Ted Dziuba <a href="http://teddziuba.com/2008/04/im-going-to-scale-my-foot-up-y.html" target="_blank">shove his foot up your ass</a>.</p>
<h2 id="Downloads">Downloads</h2>
<p><a href="PerformanceComparison_ReadingStronglyTyped.zip">PerformanceComparison_ReadingStronglyTyped.zip - Sample code</a><br><a href="Reading_Data_From_Database_Profiling.xlsx">Reading_Data_From_Database_Profiling.xslx - Profiling results</a></p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Apr</span>
			<span class="day">16</span>
		</div>
		<div class="lower">2008</div>
	</div>

	<div class="title">
		<h1><a href="/profiling-code-the-easy-way/" title="Profiling Code the Easy Way" rel="bookmark">Profiling Code the Easy Way</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I often do code profiling, usually involving a stopwatch and some boilerplate code. I decided to make a quick’n’simple class that’ll help me get rid of some of that code and concentrate on the actual code being profiled.</p>
<a id="more"></a>

<p>There are just four functions in the class, all overload variations. In a nutshell, they’ll allow you to profile a single action with &amp; without warmup, multiple iterations and multiple iterations run i parallel. The code is more or less self explanable so I’ll just throw it out there:</p>
<figure class="highlight cs"><pre><span class="keyword">using</span> System;
<span class="keyword">using</span> System.Collections.Generic;
<span class="keyword">using</span> System.Diagnostics;
<span class="keyword">using</span> System.Threading;

namespace CodeProfiler
{
	<span class="keyword">public</span> <span class="keyword">class</span> CodeProfiler
	{
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> Measures the runtime of an action once</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="action"&gt;</span>The action to profile<span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="warmup"&gt;</span>Whether the action should be run once before the actual measurement<span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>The total runtime<span class="xmlDocTag">&lt;/returns&gt;</span></span>
		<span class="keyword">public</span> <span class="keyword">static</span> TimeSpan <span class="title">ProfileAction</span>(Action action, <span class="keyword">bool</span> warmup)
		{
			<span class="keyword">if</span> (warmup)
				action();

			Stopwatch sw = <span class="keyword">new</span> Stopwatch();
			sw.Start();
			action();
			sw.Stop();
			<span class="keyword">return</span> sw.Elapsed;
		}

		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> Measures the runtime of an action once, will run the action before to warm up</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="action"&gt;</span>The action to profile<span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>The total runtime<span class="xmlDocTag">&lt;/returns&gt;</span></span>
		<span class="keyword">public</span> <span class="keyword">static</span> TimeSpan <span class="title">ProfileAction</span>(Action action)
		{
			<span class="keyword">return</span> ProfileAction(action, <span class="keyword">true</span>);
		}

		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> Measures the total runtime of performing the specified action multiple times</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="action"&gt;</span>The action to profile<span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="iterations"&gt;</span>The number of iterations the action should be performed<span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>The total runtime<span class="xmlDocTag">&lt;/returns&gt;</span></span>
		<span class="keyword">public</span> <span class="keyword">static</span> TimeSpan <span class="title">ProfileAction</span>(Action action, <span class="keyword">int</span> iterations)
		{
			TimeSpan total = <span class="keyword">new</span> TimeSpan();

			<span class="comment">// Perform single warmup</span>
			action();

			<span class="comment">// Profile iterations</span>
			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; iterations; i++)
				total = total.Add(ProfileAction(action, <span class="keyword">false</span>));

			<span class="keyword">return</span> total;
		}

		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> Measures the total runtime of performing the specified action using multiple threads</span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="action"&gt;</span>The action to profile<span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="iterations"&gt;</span>The total number of iterations that should be profiled<span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="dop"&gt;</span>The number of simultaneous threads that should be used<span class="xmlDocTag">&lt;/param&gt;</span></span>
		<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>The total runtime<span class="xmlDocTag">&lt;/returns&gt;</span></span>
		<span class="keyword">public</span> <span class="keyword">static</span> TimeSpan <span class="title">ProfileAction</span>(Action action, <span class="keyword">int</span> iterations, <span class="keyword">int</span> dop)
		{
			<span class="keyword">object</span> locker = <span class="keyword">new</span> <span class="keyword">object</span>();
			List&lt;Thread&gt; threads = <span class="keyword">new</span> List&lt;Thread&gt;(iterations);

			<span class="comment">// Warmup</span>
			action();

			<span class="comment">// Create profiling threads</span>
			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; dop; i++)
			{
				Thread t = <span class="keyword">new</span> Thread(<span class="keyword">delegate</span>()
				{
					<span class="keyword">while</span> (<span class="keyword">true</span>)
					{
						<span class="keyword">lock</span> (locker)
						{
							<span class="keyword">if</span> (iterations &gt; <span class="number">0</span>)
								iterations--;
							<span class="keyword">else</span>
								<span class="keyword">break</span>;
						}

						action();
					}
				});
				threads.Add(t);
			}

			Stopwatch sw = <span class="keyword">new</span> Stopwatch();
			sw.Start();

			<span class="comment">// Start profiling threads</span>
			threads.ForEach(t =&gt; t.Start());

			<span class="comment">// Wait for all threads to stop</span>
			threads.ForEach(t =&gt; t.Join());

			sw.Stop();

			<span class="keyword">return</span> sw.Elapsed;
		}
	}
}
</pre></figure>

<p>Using the CodeProfiler class, it’s easy for us to do code profiling, including measuring the effects of parallelization. Here’s an example of calculating the square root of the numbers 1 through 10 million 100 times, using 1-16 simultaneous threads. FYI I’m runing on a quad core machine.</p>
<figure class="highlight cs"><pre><span class="keyword">using</span> System;

namespace CodeProfiler
{
	class Program
	{
		<span class="keyword">static</span> <span class="keyword">void</span> Main(<span class="keyword">string</span>[] args)
		{
			Action action = () =&gt;
			{
				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000000</span>; i++)
					Math.Sqrt(i);
			};

			<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>; i&lt;=<span class="number">16</span>; i++)
				Console.WriteLine(i + <span class="string">" thread(s):t"</span> + CodeProfiler.ProfileAction(action, <span class="number">100</span>, i));

			Console.Read();
		}
	}
}
</pre></figure>

<p>And the result as expected, the performance panning out when threads &gt;= cores. Using more threads than there is cores will usually not result in added performance, just increased context switching which is not desirable. Here’s the resulting execution times with seconds on the Y axis and number of threads on the X axis.</p>
<div class="imgwrapper" style=""><div><a href="/profiling-code-the-easy-way/codeprofilergraph_2.jpg" class="fancy"><img src="/profiling-code-the-easy-way/codeprofilergraph_2.jpg" style="max-height: 250px"/></a></div></div>

<div class="imgwrapper" style=""><div><a href="/profiling-code-the-easy-way/codeprofilercmd_2.jpg" class="fancy"><img src="/profiling-code-the-easy-way/codeprofilercmd_2.jpg" style="max-height: 250px"/></a></div></div>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Apr</span>
			<span class="day">16</span>
		</div>
		<div class="lower">2008</div>
	</div>

	<div class="title">
		<h1><a href="/securing-dotnet-code/" title="Securing .NET Code" rel="bookmark">Securing .NET Code</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				, 
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Time flies fast. Back in 2006, during my time as an <a href="http://en.wikipedia.org/wiki/Microsoft_Student_Partners" target="_blank">MSP</a>, I made a series of presentations on securing intellectual property in .NET code, resulting in my <a href="/securing-dotnet-code-article/">Securing .NET Code</a> article. Although it’s about two years old, most points are still valid today, unfortunately.</p>
<a id="more"></a>

<p>I recorded a screencast of this article sometime in 2007, but I never really got it published, except for a link on the Microsoft Denmark site. It was my first screencast and unfortunately I made some mistakes, the biggest one being the click sounds from the mouse. An even bigger mistake was me deleting the original Camtasia recording files so I can’t create a new version without them.</p>
<p>Never the less, if you prefer watching to reading, it might be interesting to look through.</p>
<div class="video-container"><iframe src="//www.youtube.com/embed/Dc9EE4YRGy8" frameborder="0" allowfullscreen></iframe></div>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Apr</span>
			<span class="day">07</span>
		</div>
		<div class="lower">2008</div>
	</div>

	<div class="title">
		<h1><a href="/spawning-threads-in-aspnet-can-be-dangerous/" title="Spawning Threads in ASP.NET Can Be Dangerous" rel="bookmark">Spawning Threads in ASP.NET Can Be Dangerous</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>In my <a href="/response-transmitfile-close-will-kill-your-application/">earlier blog post</a> about the dangers of using Response.TransmitFile, I gave an example of a workaround involving spawning a new thread in the ASP.NET page. While this does solve the issue at hand, it presents us with a new way to kill our application even quicker than last.</p>
<a id="more"></a>

<p>Usually when an uncaught exception occurs in an ASP.NET application, we will be presented with a “friendly” error message like the one below:</p>
<div class="imgwrapper" style=""><div><a href="/spawning-threads-in-aspnet-can-be-dangerous/caughtexception.jpg" class="fancy"><img src="/spawning-threads-in-aspnet-can-be-dangerous/caughtexception.jpg" style="max-height: 250px"/></a></div></div>

<p>While there is an overhead of exceptions being thrown, they’re not directly dangerous and will at worst affect scalability (ignoring the actual reason of the exception being thrown). The problem is that ASP.NET will <em>only catch exceptions on the processing thread</em>. That means, if you spawn a new thread and an exception is thrown (and is not caught inside the thread itself), it will propagate and eventually <em>crash the w3wp.exe process</em>.</p>
<h3 id="Safe">Safe</h3>
<figure class="highlight cs"><pre><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Page_Load</span>(<span class="keyword">object</span> sender, EventArgs e)
{
	Response.Write(<span class="string">"CAN HAZ W3WP.EXE?"</span>);

	<span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"I'll will be caught by ASP.NET :D"</span>);
}
</pre></figure>

<h3 id="Unsafe,_will_crash_w3wp-exe">Unsafe, will crash w3wp.exe</h3>
<figure class="highlight cs"><pre><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Page_Load</span>(<span class="keyword">object</span> sender, EventArgs e)
{
	Response.Write(<span class="string">"CAN HAZ W3WP.EXE?"</span>);

	<span class="keyword">new</span> Thread(<span class="keyword">delegate</span>()
	{
		<span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"I'll not be caught by ASP.NET :("</span>);
	}).Start();
}
</pre></figure>

<p>There are several repercussions of the w3wp.exe crashing. There’s a major overhead in spawning a new w3wp.exe process on the next request, you will loose all session (if you’re using inprocess session storage), application and cache state. If you have error reporting turned on, you furthermore also see the “DW20.exe” process running and taking up 100% CPU for a significant amount of time (depending on w3wp.exe memory usage, etc) - if this happens often, you might have a large amount of DW20.exe error reporting processes running, effectively crashing your server.</p>
<p>So how do we avoid this? Simple, make sure <em>all code</em> in spawned threads is handling exceptions:</p>
<figure class="highlight cs"><pre><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Page_Load</span>(<span class="keyword">object</span> sender, EventArgs e)
{
	Response.Write(<span class="string">"CAN HAZ W3WP.EXE?"</span>);

	<span class="keyword">new</span> Thread(<span class="keyword">delegate</span>()
	{
		<span class="keyword">try</span>
		{
			<span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"I'll be caught by our own exception handler :)"</span>);
		}
		<span class="keyword">catch</span>
		{
			Response.Write(<span class="string">"What doesn't kill me will make me stronger!"</span>);
		}
	}).Start();
}
</pre></figure>

<p>If you’re experiencing this issue, you will see errors in the System event log like this one:</p>
<blockquote>
<p>A process serving application pool ‘DefaultAppPool’ terminated unexpectedly. The process id was ‘708’. THe process exit code was ‘0xe0434f4d’.</p>
</blockquote>
<p>And like this one in the Application log:</p>
<blockquote>
<p>EventType clr20r3, P1 w3wp.exe, P2 6.0.3790.3959, P3 45d6968e, P4 crashw3wp, P5 1.0.0.0, P6 47f94ca4, P7 3, P8 b, P9 system.exception, P10 NIL.</p>
</blockquote>
<p><a href="http://blogs.msdn.com/tess" target="_blank">Tess</a> has a really great post on <a href="http://blogs.msdn.com/tess/archive/2006/04/27/584927.aspx" target="_blank">how to debug an unknown cause of the crash</a>.</p>
<p>This issue is relevant to all flavors of Windows and all versions of IIS &amp; .NET.</p>
<h2 id="Downloads">Downloads</h2>
<p><a href="CrashW3WP.zip">CrashW3WP.zip - Sample code</a></p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Apr</span>
			<span class="day">01</span>
		</div>
		<div class="lower">2008</div>
	</div>

	<div class="title">
		<h1><a href="/missing-asp-net-performance-counter-values/" title="Missing ASP.NET Performance Counters" rel="bookmark">Missing ASP.NET Performance Counters</a></h1>
		<div class="categories">
			
				<a href="/category/Windows/">Windows</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Before attempting to optimize code or fix any kind of load issue, you should first gather data and become aware of what bottlenecks you’re experiencing. A great way to do this is through the Performance Monitor application. Recently I tried monitoring my ASP.NET applications, but all my counters had a value of 0. As I thought initially, it’s a simple problem, but the solution was not easily found.</p>
<a id="more"></a>

<p>In <a href="http://www.velocityreviews.com/forums/t101885-aspnet-performance-counters-not-updating.html" target="_blank">some</a> <a href="http://www.velocityreviews.com/forums/t70137-re-aspnet-performance-counters-are-all-zero-.html" target="_blank">cases</a> it might be due to lack of permissions on the performance counter registry keys.</p>
<p>In my case it’s because I was running Server 2003 x64, but my IIS was running in 32 bit mode (due to a couple of reasons, mainly lack of x64 support in some 3rd party components). When you run the IIS worker processes in 32 bit mode, the performance counters that are used are part of the SysWow64 scheme. The problem with this is that the usual Performance Monitor application will not read these 32 bit performance counters, and as a result you will see them all with a value of 0.</p>
<p>The fix is simple… Simply open up C:\Windows\SysWOW64\perfmon.exe instead of the usual Performance Monitor link in the Administrative Tools directory. This version of perfmon is the good old 32 bit version that will read the 32 bit ASP.NET performance counters. This trick applies for all x64 versions of Windows.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Mar</span>
			<span class="day">29</span>
		</div>
		<div class="lower">2008</div>
	</div>

	<div class="title">
		<h1><a href="/xmloutput-vs-xmlserializer-performance/" title="XmlOutput vs XmlSerializer Performance" rel="bookmark">XmlOutput vs XmlSerializer Performance</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I got quite a lot of comments for my <a href="/xmldocument-fluent-interface/">XmlDocument fluent interface</a>, and I’m very glad I did. I’m always open towards new ways to solve problems, and I got a couple of suggestions to my post that I afterwards experimented with. One of those is using the XmlSerializer to serialize strongly typed classes (or structs - performance is the same) into XML. <a href="http://www.vonsharp.net/" target="_blank">Jon von Gillern</a> originally suggested it, but <a href="http://www.u2u.info/Blogs/Kris" target="_blank">Kris Vandermotten</a> made me want to test it out.</p>
<a id="more"></a>

<p>There are two aspects of these solutions, one is readability &amp; maintanability, the other is pure performance. I said that my XmlDocument wrapper would be a lot faster than the serialization way using Reflection, but Kris wasn’t so sure. Admittedly, I hadn’t tested it out, so I though I might actually be wrong in that assumption. Let the testing commence.</p>
<p>I’ll be using my User XML snippet as an example. This is how the XML is generated using my API:</p>
<figure class="highlight cs"><pre>XmlOutput xo = <span class="keyword">new</span> XmlOutput()
	.XmlDeclaration()
	.Node(<span class="string">"root"</span>).Within()
		.Node(<span class="string">"user"</span>).Within()
			.Node(<span class="string">"username"</span>).InnerText(<span class="string">"orca"</span>)
			.Node(<span class="string">"realname"</span>).InnerText(<span class="string">"Mark S. Rasmussen"</span>)
			.Node(<span class="string">"description"</span>).InnerText(<span class="string">"I'll handle any escaping (like &lt; & &gt; for example) needs automagically."</span>)
			.Node(<span class="string">"articles"</span>).Within()
				.Node(<span class="string">"article"</span>).Attribute(<span class="string">"id"</span>, <span class="string">"25"</span>).InnerText(<span class="string">"Handling DBNulls"</span>)
				.Node(<span class="string">"article"</span>).Attribute(<span class="string">"id"</span>, <span class="string">"26"</span>).InnerText(<span class="string">"Accessing my privates"</span>)
				.EndWithin()
			.Node(<span class="string">"hobbies"</span>).Within()
				.Node(<span class="string">"hobby"</span>).InnerText(<span class="string">"Fishing"</span>)
				.Node(<span class="string">"hobby"</span>).InnerText(<span class="string">"Photography"</span>)
				.Node(<span class="string">"hobby"</span>).InnerText(<span class="string">"Work"</span>);

<span class="keyword">string</span> output = xo.GetOuterXml();
</pre></figure>

<p>Note that I just retrieve the complete XML in a string, I don’t print or save this, it’s just to get a valid comparison point. This is how we’ll generate the same code using the XmlSerializer:</p>
<figure class="highlight cs"><pre><span class="keyword">public</span> <span class="keyword">class</span> User
{
	<span class="keyword">public</span> <span class="keyword">string</span> Username;
	<span class="keyword">public</span> <span class="keyword">string</span> Realname;
	<span class="keyword">public</span> <span class="keyword">string</span> Description;
	<span class="keyword">public</span> List&lt;Article&gt; Articles;
	<span class="keyword">public</span> List&lt;Hobby&gt; Hobbies;
}

<span class="keyword">public</span> <span class="keyword">class</span> Article
{
	[XmlAttribute]
	<span class="keyword">public</span> <span class="keyword">int</span> ID;

	[XmlText]
	<span class="keyword">public</span> <span class="keyword">string</span> Content;
}

<span class="keyword">public</span> <span class="keyword">class</span> Hobby
{
	[XmlText]
	<span class="keyword">public</span> <span class="keyword">string</span> Content;
}
</pre></figure>


<figure class="highlight cs"><pre><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">ConvertToXml</span>(<span class="keyword">object</span> item)
{
	XmlSerializer xmlser = <span class="keyword">new</span> XmlSerializer(item.GetType());

	<span class="keyword">using</span> (MemoryStream ms = <span class="keyword">new</span> MemoryStream())
	{
		xmlser.Serialize(ms, item);
		UTF8Encoding textconverter = <span class="keyword">new</span> UTF8Encoding();
		<span class="keyword">return</span> textconverter.GetString(ms.ToArray());
	}
}
</pre></figure>


<figure class="highlight cs"><pre>User user = <span class="keyword">new</span> User();
user.Username = <span class="string">"orca"</span>;
user.Realname = <span class="string">"Mark S. Rasmussen"</span>;
user.Description = <span class="string">"I'll handle any escaping (like &lt; & &gt; for example) needs automagically."</span>;

user.Articles = <span class="keyword">new</span> List&lt;Article&gt;();
user.Articles.Add(<span class="keyword">new</span> Article() { ID = <span class="number">25</span>, Content = <span class="string">"Handling DBNulls"</span> });
user.Articles.Add(<span class="keyword">new</span> Article() { ID = <span class="number">26</span>, Content = <span class="string">"Accessing my privates"</span>});

user.Hobbies = <span class="keyword">new</span> List&lt;Hobby&gt;();
user.Hobbies.Add(<span class="keyword">new</span> Hobby() { Content = <span class="string">"Fishing"</span> });
user.Hobbies.Add(<span class="keyword">new</span> Hobby() { Content = <span class="string">"Photography"</span> });
user.Hobbies.Add(<span class="keyword">new</span> Hobby() { Content = <span class="string">"Work"</span> });

<span class="keyword">string</span> output = ConvertToXml(user);
</pre></figure>

<p>Note that only the last codesnippet is the one being looped, the other two are simply one-time helpers to actually create the XML. I have run the tests in a number of iterations to get a total code time, furthermore, I’ve run each of the iteration tests 10 times to calculate the average execution time. This is the basic code to run the tests:</p>
<figure class="highlight cs"><pre>sw.Reset();
iterationTime = <span class="number">0</span>;
<span class="keyword">for</span> (<span class="keyword">int</span> testIteration = <span class="number">0</span>; testIteration &lt; testIterations; testIteration++)
{
	sw.Start();
	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; iterations; i++)
	{
		<span class="comment">// Perform XML creation</span>
	}
	sw.Stop();
	iterationTime += sw.ElapsedMilliseconds;
	Console.WriteLine(sw.ElapsedMilliseconds);

	sw.Reset();
}
Console.WriteLine(<span class="string">"Total XmlSerializer: "</span> + iterationTime / testIterations);
</pre></figure>

<p>And finally, the results (times in ms on a base 10 logarithmic scale):</p>
<div class="imgwrapper" style=""><div><a href="/xmloutput-vs-xmlserializer-performance/xmloutputspeed_2.jpg" class="fancy"><img src="/xmloutput-vs-xmlserializer-performance/xmloutputspeed_2.jpg" style="max-height: 250px"/></a></div></div>

<p>As expected, the XmlSerializer is somewhat slower on the low iteration numbers, this is due to the initial code emits XmlSerializer will do, as Kris also mentioned. This is also the reason XmlSerializer is actually speeding up as the iterations go up, the initial compilation is meaning less and less. XmlOutput has a rather linear use of time. Never the less, the initial compilation time is neglible as it’s only the first request that has this performance hit (and we could sgen followed by ngen this to avoid it). Thus, if we simply reset the timer after the first iteration, this is the new graph we get (note that we can’t plot the 1st iteration as a value of 0 cannot be plotted on the logarithmic scale):</p>
<div class="imgwrapper" style=""><div><a href="/xmloutput-vs-xmlserializer-performance/xmloutputspeed2_2.jpg" class="fancy"><img src="/xmloutput-vs-xmlserializer-performance/xmloutputspeed2_2.jpg" style="max-height: 250px"/></a></div></div>

<p>This time XmlSerializer behaves a lot more linearly like XmlOutput, but it’s still several factors slower than XmlOutput. In conclusion, speed does not seem to be the advantage of XmlSerializer. Depending on your scenario, using strongly typed classes might be more appropriate, but I really believe this is scenario dependent and thus I’ll leave that out of the discussion.</p>
<h2 id="Downloads">Downloads</h2>
<p><a href="SerializationBenchmark.zip">SerializationBenchmark.zip - Sample code</a></p>
<h2 id="Update">Update</h2>
<p>I misread Kris’ comment about sgen, I read it as ngen. I’ve removed my comment regarding this. To be fair, I’ve redone the performance tests, using sgen on the assembly during compilation. And I must say, it certainly does improve the performance somewhat of the serializer, though still not enough to compete with XmlOutput/XmlDocument.</p>
<div class="imgwrapper" style=""><div><a href="/xmloutput-vs-xmlserializer-performance/xmloutputspeed3_2.jpg" class="fancy"><img src="/xmloutput-vs-xmlserializer-performance/xmloutputspeed3_2.jpg" style="max-height: 250px"/></a></div></div>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Mar</span>
			<span class="day">29</span>
		</div>
		<div class="lower">2008</div>
	</div>

	<div class="title">
		<h1><a href="/response-transmitfile-close-will-kill-your-application/" title="Response.TransmitFile + Close Will Kill Your Application" rel="bookmark">Response.TransmitFile + Close Will Kill Your Application</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Just before last weekend I noticed that a website I’m responsible for started spitting out “Server is busy” messages, not something you want to see on a website with millions of visitors per day. The quickfix was to recycle the application pool, and thus I solved the symptoms by setting a 15 mins recycle cycle on all the application pools. Not exactly optimal, but sometimes pissing your pants is the way to go.</p>
<a id="more"></a>

<p>The first step I made to analyze what was causing this is the Performance Monitor tool. We weren’t experiencing above average traffic, so that couldn’t explain it. What first struck me was the the “ASP.NETRequests Queued” queue was 0, not 5000+ as I’d expected! That meant the requests were not being queued, so the server didn’t have trouble handling the requests themselves. The reason was to be found in the “ASP.NETRequests Current” counter. This was constantly rising even though the CPU, memory and disk counters looked fine. It obviously didn’t look like a performance problem, more like a configuration issue. So I increased the appQueueRequestLimit to 20k and set the recycle cycle to 30 minutes, at most the “ASP.NETRequests Current” went to about 10k before being recycled and thus reset to 0.</p>
<p>Now, that didn’t fix the problem, just the symptom. We hadn’t experienced this issue previously, so I thought back at what changes had been made in the latest release version. The primary functionality of the system is to serve images, thus we have an Image.ashx file with a responsibility of serving the images as well as logging various parameters of the request. The previous system version had a funtionality like so:</p>
<ul>
<li>Find image path</li>
<li>Response.TransmitFile()</li>
<li>Logging</li>
</ul>
<p>The disadvantage of doing it that way is that the client will not have the image served before the statistics have been logged, even though that’s purely a serverside functionality. I wanted the client to receive the image as quickly as possible, and then letting the server continue its job afterwards. The obvious solution is to spawn a new thread doing the logging, but with the amount of requests we’ve got, I really don’t want to spawn any more threads than absolutely neccessary, excessive context switching will have a negative impact when the thread count gets high enough. So the new version functioned like this:</p>
<ul>
<li>Find image path</li>
<li>Response.TransmitFile()</li>
<li>Response.Flush()</li>
<li>Response.Close()</li>
<li>Logging</li>
</ul>
<p>This had the great advantage that the client receives the image immediatly while the server continues logging afterwards. We use only a single thread, the actual request thread. A friend of mine pointed out I might want to move the logging out of the ASP.NET worker process so as to not block incoming requests. The thing is, this will require new thread spawning, and I really don’t mind blocking a worker process as we can easily tune the amount of concurrent worker processes, and the “Server too busy” functionality is actually there for a reason - I don’t wanna end up in a situation where the server is running a million logging threads but still accepting new connections willingly - in <em>that</em> case, I’d really like the server to block new requests.</p>
<p>Anyways, although this looked good, this was the sole reason for the “Server too busy” errors we were experiencing! After some testing I discovered that if you call Response.TransmitFile() and then afterwards call Response.Close(), the request process is stuck! It will simply keep on living, and thus the “ASP.NETRequests Current” counter will keep increasing. It will not be removed until a pool recycle event is fired! This does not happen if you use Response.WriteFile, Response.BinaryWrite or if you manually stream the file, only if you use TransmitFile!</p>
<h3 id="This_will_kill_your_application:">This will kill your application:</h3>
<figure class="highlight cs"><pre><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Page_Load</span>(<span class="keyword">object</span> sender, EventArgs e)
{
	Response.Buffer = <span class="keyword">false</span>;
	Response.TransmitFile(<span class="string">"Tree.jpg"</span>);
	Response.Close();
}
</pre></figure>

<h3 id="But_this_won’t:">But this won’t:</h3>
<figure class="highlight cs"><pre><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Page_Load</span>(<span class="keyword">object</span> sender, EventArgs e)
{
	Response.WriteFile(<span class="string">"Tree.jpg"</span>);
	Response.Flush();
	Response.Close();
}

<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Page_Load</span>(<span class="keyword">object</span> sender, EventArgs e)
{
	Response.BinaryWrite(File.ReadAllBytes(Server.MapPath(<span class="string">"Tree.jpg"</span>)));
	Response.Flush();
	Response.Close();
}

<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Page_Load</span>(<span class="keyword">object</span> sender, EventArgs e)
{
	<span class="keyword">int</span> chunkSize = <span class="number">64</span>;
	<span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[chunkSize];
	<span class="keyword">int</span> offset = <span class="number">0</span>;
	<span class="keyword">int</span> read = <span class="number">0</span>;
	<span class="keyword">using</span> (FileStream fs = File.Open(Server.MapPath(<span class="string">"Tree.jpg"</span>), FileMode.Open, FileAccess.Read, FileShare.Read))
	{
		<span class="keyword">while</span> ((read = fs.Read(buffer, offset, chunkSize)) &gt; <span class="number">0</span>)
		{
			Response.OutputStream.Write(buffer, <span class="number">0</span>, read);
			Response.Flush();
		}
	}

	Response.Close();
}
</pre></figure>

<p>I can replicate the exact same errors on Server 2003 with IIS running i *32 mode, Vista x64 and Server 2003 in x64 mode. It does not matter if you’re running ASPX pages or ASHX HttpHandlers, same problem.</p>
<p>I used this code snippet to get a list of the current active requests in IIS (to verify that the “ASP.NETRequests Current” and “W3SVC_W3WPActive Requests” are not lying:</p>
<figure class="highlight cs"><pre>ServerManager iisManager = <span class="keyword">new</span> ServerManager();

<span class="keyword">foreach</span> (WorkerProcess w3wp <span class="keyword">in</span> iisManager.WorkerProcesses)
{
	Console.WriteLine(<span class="string">"W3WP ({0})"</span>, w3wp.ProcessId);

	<span class="keyword">foreach</span> (Request request <span class="keyword">in</span> w3wp.GetRequests(<span class="number">0</span>).Where(req =&gt; req.Url == <span class="string">"/default.aspx"</span>))
	{
		Console.WriteLine(<span class="string">"URL: "</span> + request.Url);
		Console.WriteLine(<span class="string">"TimeElapsed: "</span> + request.TimeElapsed);
		Console.WriteLine(<span class="string">"TimeInState: "</span> + request.TimeInState);
		Console.WriteLine(<span class="string">"TimeInModule: "</span> + request.TimeInModule);
		Console.WriteLine(<span class="string">"CurrentModule: "</span> + request.CurrentModule);
		Console.WriteLine(<span class="string">"PipelineState: "</span> + request.PipelineState);
		Console.WriteLine();
	}
}
</pre></figure>


<figure class="highlight"><pre>W3WP (<span class="number">7580</span>)
<span class="label">URL:</span> /default<span class="preprocessor">.aspx</span>
<span class="label">TimeElapsed:</span> <span class="number">4223509</span>
<span class="label">TimeInState:</span> <span class="number">4223509</span>
<span class="label">TimeInModule:</span> <span class="number">4223509</span>
<span class="label">CurrentModule:</span> IsapiModule
<span class="label">PipelineState:</span> ExecuteRequestHandler

<span class="label">URL:</span> /default<span class="preprocessor">.aspx</span>
<span class="label">TimeElapsed:</span> <span class="number">2529463</span>
<span class="label">TimeInState:</span> <span class="number">2529463</span>
<span class="label">TimeInModule:</span> <span class="number">2529463</span>
<span class="label">CurrentModule:</span> IsapiModule
<span class="label">PipelineState:</span> ExecuteRequestHandler

<span class="label">URL:</span> /default<span class="preprocessor">.aspx</span>
<span class="label">TimeElapsed:</span> <span class="number">2527809</span>
<span class="label">TimeInState:</span> <span class="number">2527809</span>
<span class="label">TimeInModule:</span> <span class="number">2527809</span>
<span class="label">CurrentModule:</span> IsapiModule
<span class="label">PipelineState:</span> ExecuteRequestHandler

<span class="label">URL:</span> /default<span class="preprocessor">.aspx</span>
<span class="label">TimeElapsed:</span> <span class="number">2521117</span>
<span class="label">TimeInState:</span> <span class="number">2521117</span>
<span class="label">TimeInModule:</span> <span class="number">2521117</span>
<span class="label">CurrentModule:</span> IsapiModule
<span class="label">PipelineState:</span> ExecuteRequestHandler

<span class="label">URL:</span> /default<span class="preprocessor">.aspx</span>
<span class="label">TimeElapsed:</span> <span class="number">2516562</span>
<span class="label">TimeInState:</span> <span class="number">2516562</span>
<span class="label">TimeInModule:</span> <span class="number">2516562</span>
<span class="label">CurrentModule:</span> IsapiModule
<span class="label">PipelineState:</span> ExecuteRequestHandler

<span class="label">URL:</span> /default<span class="preprocessor">.aspx</span>
<span class="label">TimeElapsed:</span> <span class="number">2515470</span>
<span class="label">TimeInState:</span> <span class="number">2515470</span>
<span class="label">TimeInModule:</span> <span class="number">2515470</span>
<span class="label">CurrentModule:</span> IsapiModule
<span class="label">PipelineState:</span> ExecuteRequestHandler

<span class="label">URL:</span> /default<span class="preprocessor">.aspx</span>
<span class="label">TimeElapsed:</span> <span class="number">2514378</span>
<span class="label">TimeInState:</span> <span class="number">2514378</span>
<span class="label">TimeInModule:</span> <span class="number">2514378</span>
<span class="label">CurrentModule:</span> IsapiModule
<span class="label">PipelineState:</span> ExecuteRequestHandler

<span class="label">URL:</span> /default<span class="preprocessor">.aspx</span>
<span class="label">TimeElapsed:</span> <span class="number">2291749</span>
<span class="label">TimeInState:</span> <span class="number">2291749</span>
<span class="label">TimeInModule:</span> <span class="number">2291749</span>
<span class="label">CurrentModule:</span> IsapiModule
<span class="label">PipelineState:</span> ExecuteRequestHandler
</pre></figure>

<p>So obviously the requests are there, they’re just stale.</p>
<p>If we take a look at an <a href="http://iismonitor.motobit.com/" target="_blank">IISTrace</a> trace, we can see all of the requests in the “Send data” state. They have all sent all the data and no further data is being sent, but they’re still stuck in the “Send data” state:</p>
<div class="imgwrapper" style=""><div><a href="/response-transmitfile-close-will-kill-your-application/iistrace_2.jpg" class="fancy"><img src="/response-transmitfile-close-will-kill-your-application/iistrace_2.jpg" style="max-height: 250px"/></a></div></div>

<p>For all the other ways to send the file, the request exits the Send data state as soon as all processing is done (that is, not directly after Response.Close). Calling Response.End has no influence.</p>
<h2 id="Symptoms">Symptoms</h2>
<p>You may be experiencing this problem without knowing it. Unless you have a some load on your site, chances are you will never actually see this problem. While the requests will go stale and continue to live, a recycle event will kill them off as the process is closed. But you will see this in your System log:</p>
<p>A process serving application pool ‘Classic .NET AppPool’ exceeded time limits during shut down. The process id was ‘13304’.</p>
<p>Since the requests continue living, recycling the pool will time out and thus force the process to shut down, and thereby generating the above event. This may lead to increased memory usage depending on your recycle settings. So unless you have more requests than the Request queue limit setting on your application pool, within the recycle period, you will not notice this problem.</p>
<h2 id="Fix">Fix</h2>
<p>The easiest way to get around this problem (bug?) is to just spawn a new thread doing the logging so the main thread will complete right after TransmitFile. In most cases the logging operation will be rather fast so the threads will be shortlived and thus not create too many concurrent threading operations.</p>
<figure class="highlight cs"><pre>Response.Buffer = <span class="keyword">false</span>;
Response.TransmitFile(<span class="string">"Tree.jpg"</span>);

Thread t = <span class="keyword">new</span> Thread(<span class="keyword">delegate</span>()
{
	<span class="comment">// Logging</span>
});
t.Start();
</pre></figure>

<h2 id="Bonus_code">Bonus code</h2>
<p>Jonathan Gilbert posted a couple of great comments regarding spawning your own threads in the process and the possibility of extracing the actual logging process into a separate service. Since my blogs comments suck in regards to posting code, here are his code parts:</p>
<figure class="highlight cs"><pre><span class="keyword">static</span> <span class="keyword">object</span> log_sync = <span class="keyword">new</span> <span class="keyword">object</span>();
<span class="keyword">static</span> Queue&lt;LogData&gt; log_queue = <span class="keyword">new</span> Queue&lt;LogData&gt;();
<span class="keyword">static</span> <span class="keyword">bool</span> log_thread_running = <span class="keyword">false</span>;

<span class="keyword">static</span> <span class="keyword">void</span> post_log_entry(LogData log_entry)
{
	<span class="keyword">lock</span> (log_sync)
	{
		log_queue.Enqueue(log_entry);

		<span class="keyword">if</span> (log_thread_running)
			Monitor.PulseAll(log_sync);
		<span class="keyword">else</span>
			<span class="keyword">new</span> Thread(log_thread_proc).Start();
	}
}

<span class="keyword">static</span> <span class="keyword">void</span> log_thread_proc()
{
	<span class="keyword">lock</span> (log_sync)
	{
		<span class="keyword">if</span> (log_thread_running)
			<span class="keyword">return</span>;

		log_thread_running = <span class="keyword">true</span>;

		<span class="keyword">try</span>
		{
			<span class="keyword">while</span> (<span class="keyword">true</span>)
			{
				<span class="keyword">while</span> (log_queue.Count == <span class="number">0</span>)
					Monitor.Wait(log_sync);

				LogData one_item = <span class="keyword">null</span>;
				List&lt;LogData&gt; multiple_items = <span class="keyword">null</span>;

				<span class="keyword">if</span> (log_queue.Count == <span class="number">1</span>)
					one_item = log_queue.Dequeue();
				<span class="keyword">else</span>
				{
					multiple_items = <span class="keyword">new</span> List&lt;LogData&gt;(log_queue);
					log_queue.Clear();
				}

				<span class="comment">// The following block: Exit; try/finally{Enter}</span>
				<span class="comment">// ..is the logical inverse of a lock() block. :-)</span>
				Monitor.Exit(log_sync);

				<span class="keyword">try</span>
				{
					<span class="keyword">if</span> (one_item != <span class="keyword">null</span>)
						process_log_entry(one_item);

					<span class="keyword">if</span> (multiple_items != <span class="keyword">null</span>)
						<span class="keyword">foreach</span> (LogData item <span class="keyword">in</span> multiple_items)
							process_log_entry(item);
				}
				<span class="keyword">finally</span>
				{
					Monitor.Enter(log_sync);
				}
			}
		}
		<span class="keyword">catch</span> (Exception e)
		{
			<span class="comment">// TODO: log this unexpected error</span>
		}
		<span class="keyword">finally</span>
		{
			log_thread_running = <span class="keyword">false</span>;
		}
	}
}
</pre></figure>


<figure class="highlight cs"><pre><span class="keyword">static</span> <span class="keyword">object</span> log_sync = <span class="keyword">new</span> <span class="keyword">object</span>();
<span class="keyword">static</span> BinaryFormatter log_formatter = <span class="keyword">new</span> BinaryFormatter(); <span class="comment">// in System.Runtime.Serialization.Formatters.Binary</span>
<span class="keyword">static</span> Stream log_stream;

<span class="keyword">static</span> <span class="keyword">void</span> post_log_entry(LogData log_entry)
{
	<span class="keyword">lock</span> (log_sync)
	{
		<span class="keyword">if</span> (log_writer == <span class="keyword">null</span>)
		{
			Socket socket = <span class="keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);

			<span class="comment">// In practice, I would let the OS pick the port number when binding in the Windows Service</span>
			<span class="comment">// and write it to a central location that the ASP.NET process can read from.</span>
			socket.Connect(<span class="keyword">new</span> IPEndPoint(IPAddress.Loopback, SecretPortNumber));

			log_stream = <span class="keyword">new</span> NetworkStream(socket, <span class="keyword">true</span>);
		}

		log_formatter.Serialize(log_stream, log_entry);
	}
}
</pre></figure>


<figure class="highlight cs"><pre>class LogService : System.ServiceProcess.ServiceBase
{
	<span class="keyword">static</span> <span class="keyword">void</span> Main(<span class="keyword">string</span>[] args)
	{
		<span class="keyword">if</span> ((args.Length &gt; <span class="number">0</span>) && <span class="keyword">string</span>.Equals(args[<span class="number">0</span>], <span class="string">"/console"</span>, StringComparison.InvariantCultureIgnoreCase))
		{
			LogService service = <span class="keyword">new</span> LogService();

			service.StartDirect();
			Console.WriteLine(<span class="string">"Press enter to stop debugging"</span>);
			Console.ReadLine();
			service.StopDirect();
		}
		<span class="keyword">else</span>
			ServiceBase.Run(<span class="keyword">new</span> LogService());
	}

	LogService()
	{
		ServiceName = <span class="string">"LogService"</span>;
		CanStop = <span class="keyword">true</span>;
	}

	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StartDirect</span>()
	{
		OnStart(<span class="keyword">null</span>);
	}

	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StopDirect</span>()
	{
		OnStop();
	}

	<span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnStart</span>(<span class="keyword">string</span>[] args)
	{
		socket = <span class="keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);

		<span class="comment">// Again, in implementation, change this to bind to port 0 and then after the Bind call</span>
		<span class="comment">// has succeeded, read the port number back from the LocalEndPoint property and write it</span>
		<span class="comment">// to a place where the ASP.NET side can read it.</span>
		socket.Bind(<span class="keyword">new</span> IPEndPoint(IPAddress.Loopback, SecretPortNumber));

		socket.Listen(<span class="number">5</span>);

		shutdown = <span class="keyword">false</span>;

		Thread main_thread = <span class="keyword">new</span> Thread(main_thread_proc);

		main_thread.IsBackground = <span class="keyword">true</span>;
		main_thread.Start();
	}

	<span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnStop</span>()
	{
		shutdown = <span class="keyword">true</span>;
	}

	Socket socket;
	<span class="keyword">bool</span> shutdown;

	<span class="keyword">void</span> main_thread_proc()
	{
		BinaryFormatter log_formatter = <span class="keyword">new</span> BinaryFormatter();

		<span class="keyword">using</span> (NetworkStream log_stream = <span class="keyword">new</span> NetworkStream(socket, <span class="keyword">true</span>))
		{
			<span class="keyword">while</span> (!shutdown)
			{
				LogData log_entry = (LogData)log_formatter.Deserialize(stream);

				process_log_entry(log_entry);
			}
		}
	}
}
</pre></figure>

<h2 id="Downloads">Downloads</h2>
<p><a href="ResponseCloseTest.zip">ResponseCloseTest.zip - Sample code</a></p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Mar</span>
			<span class="day">23</span>
		</div>
		<div class="lower">2008</div>
	</div>

	<div class="title">
		<h1><a href="/sql-server-mirroring-a-practical-approach/" title="SQL Server Mirroring - A Practical Approach" rel="bookmark">SQL Server Mirroring - A Practical Approach</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server/">SQL Server</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>In this post I’ll take a practical approach at talking about what SQL Server Mirroring is, the advantages and considerations that follows.</p>
<a id="more"></a>

<h2 id="Availability,_not_scalability">Availability, not scalability</h2>
<p>SQL Server Mirroring aims to increase database availability, not scalability. Boiled down, a mirrored database consists of a principal database on SQL Server instance X and an exact mirror of that database on instance Y. Everytime a transaction has occured on X, it is executed on Y as well. While this is happening, the Y instance database is in recovery mode, meaning you cannot query it directly, and thus you cannot use this as a secondary readonly database to achieve scalability.</p>
<p>While you can run mirroring on different SQL Server instances on the same machine, this defeats the purpose as most errors will be hardware/system based, and usually these will affect all instances on the same phyiscal server. Trying out mirroring across instances is a good way to test it out however. In my demos I will be using virtual PCs, each loaded with SQL Server 2005 Enterprise sp1.</p>
<h2 id="Operating_modes">Operating modes</h2>
<p>SQL Server supports <a href="http://msdn2.microsoft.com/en-us/library/ms191456.aspx" target="_blank">three different operating modes</a>.</p>
<h3 id="High_performance_(asynchronous)">High performance (asynchronous)</h3>
<p>As the name implies, maintaining high performance is the key issue in this mode. Whenever a transaction is completed on the principal, the log is sent to the mirror, but the principal does not wait for this to complete. Thus if the mirror were to die out, throw an error during execution, the databases would become out of synch. The mirror could also trail behind due to a difference in computing power or other external factors. If the principal fails, you will have to do a manual failover to the mirror.</p>
<h3 id="High_safety_(synchronous)_-_also_known_as_“high_protection”">High safety (synchronous) - also known as “high protection”</h3>
<p>As with the high performance mode, each time a transaction occurs on the principal, it is sent to the mirror. The principal will not commit the transaction until the mirror has committed the transaction also. Thus you will never risk your databases being out of synch. The downside is that your mirrored setup will be no faster than the slowest machine that is part of the mirror, plus the implicit overhead in server chatting. As with the high performance mode, you will have to make a manual failover in case of principal failure.</p>
<h3 id="High_safety_with_automatic_failover_(synchronous)">High safety with automatic failover (synchronous)</h3>
<p>This mode involves a third instance besides the principal and mirror, known as the witness. The witness instance constantly monitors the principal for availability, and if a problem is detected, it will automatically perform a failover. At this point, the database as a whole will still be available, but you should manually get the failed mirror up and running again and reinitiate mirroring.</p>
<h2 id="Prerequisites">Prerequisites</h2>
<p>There are a <a href="http://msdn2.microsoft.com/en-us/library/ms366349.aspx" target="_blank">couple of things that should be in place</a> before attempting to setup database mirroring.</p>
<h3 id="Service_pack_1">Service pack 1</h3>
<p>Make sure all instances have been upgraded to <a href="http://www.microsoft.com/downloads/details.aspx?FamilyID=cb6c71ea-d649-47ff-9176-e7cac58fd4bc&amp;displaylang=en" target="_blank">service pack 1</a>. If you do not have service pack 1, you will receive the following warning when trying to start the mirror:</p>
<div class="imgwrapper" style=""><div><a href="/sql-server-mirroring-a-practical-approach/enablemirroring_2.jpg" class="fancy"><img src="/sql-server-mirroring-a-practical-approach/enablemirroring_2.jpg" style="max-height: 250px"/></a></div></div>

<h3 id="Unified_SQL_Server_service_account">Unified SQL Server service account</h3>
<p>If you’re using Active Directory, make sure the SQL Server service accounts are running as the same user. Local System will not work as it does not have any network credentials. If you’re not using Active Directory, just make sure the services are running on an account with the same name &amp; password on each machine. Make sure you change the service account through the SQL Server Configuration application and not the services console. Alternatively you can specify user accounts that should be used for mirror replication, but having the servers run on the same domain account is the easiest way.</p>
<h3 id="Full_recovery_model">Full recovery model</h3>
<p>Make sure the database you want to mirror is setup to use the full recovery backup model, otherwise there’ll be no log to ship to the mirror instance and mirroring will not be possible.</p>
<h2 id="Licensing">Licensing</h2>
<p>Mirroring is supported in the SQL Server Standard and Enterprise editions. Neither Express nor Workgroup edition will work. Enterprise supports the high performance operating mode, Standard only supports the two high safety modes. You can use the free Express version for the mirror server. Note that you <a href="http://www.microsoft.com/sql/howtobuy/sqlserverlicensing.mspx" target="_blank">do NOT need an extra SQL Server license for the mirroring server</a>, provided that it does nothing else but maintain the mirrored database - take note of the 30 days clause.</p>
<h2 id="Test_setup">Test setup</h2>
<p>My demos will be using three servers, all running Windows Server 2003 Standard (fully updated) through Virtual PC. All three have SQL Server 2005 Enterprise installed. I will be using the Microsoft sample database Adventureworks. You can <a href="http://codeplex.com/SqlServerSamples#databases" target="_blank">download the AdventureWorks database</a> at CodePlex.</p>
<p>The three servers are RIO, MANDALAY and MGM (yes, I like Vegas). MGM will only be used for setting up a witness, RIO and MANDALAY will both host the actual databases, MANDALAY being the initial principal and RIO being the initial mirror. All servers are completely fresh installations using SQL Server authentication.</p>
<p>I will be connecting to the instances from SQL Server Management Studio running on my desktop computer.</p>
<h2 id="Initial_setup_of_the_databases">Initial setup of the databases</h2>
<p>The first step is to restore the AdventureWorks .bak backup file to both servers. On the principal (MANDALAY) we should make a normal restore (RESTORE WITH RECOVERY) so the database is online. On the mirror (RIO), we should restore into the recovering state so no changes can be made (RESTORE WITH NORECOVERY). You can watch how it’s done here, or skip on to the next section.</p>
<div class="video-container"><iframe src="//www.youtube.com/embed/eHeVZ1NzIO0" frameborder="0" allowfullscreen></iframe></div>



<h2 id="Mirroring_configuration">Mirroring configuration</h2>
<p>Now that we’ve got both databases setup, we’re ready to setup the actual mirror. A couple of notes on what I’m doing during the setup. In the first demo, I’ll setup a synchronous high safety mirror with a witness. As all the virtual PCs are running on the same machine, I’ll have to use different ports for the endpoints. Whether you want to use encryption for the endpoint communication is scenario specific. Encryption will <a href="http://www.microsoft.com/technet/prodtechnol/sql/2005/technologies/dbm_best_pract.mspx" target="_blank">have an overhead</a> - albeit a minor one - so it’s up to you to determine if it’s neccessary. As our SQL Services are running on the same account across the machines, we do not have to specify any custom service account names during the setup.</p>
<p>For some reason, SQL Server needs a fully qualified domain name for the instance addresses. If you’re setting this up on a computer that is part of the domain, you should simply use the domain name, [Computer].[domain]:port. In this example my desktop is not part of the Active Directory domain and thus it’ll use addresses like TCP://COMPUTER:PORT which is not accepted. I’ll fix it by simply writing the machine IP addresses manually instead. The IP for MANDALAY is 192.168.0.31 and for RIO it’s 192.168.0.33. Note that you should ALWAYS use FQDNs, using IPs are not recommended as it may result in configuration as well as runtime issues. See <a href="http://sqlblog.com/blogs/adam_machanic/archive/2007/06/13/database-mirroring-fqdns-are-your-friends.aspx" target="_blank">Adam Machanics blogpost</a> on the same issue as I ran into a couple of times.</p>
<div class="video-container"><iframe src="//www.youtube.com/embed/rlAMl3D47bo" frameborder="0" allowfullscreen></iframe></div>



<h2 id="Testing_the_mirror">Testing the mirror</h2>
<p>Besides my DBA excesses, I’m a developer. And what’s more natural than to whip together a small application that tests the mirrors availability?</p>
<div class="imgwrapper" style=""><div><a href="/sql-server-mirroring-a-practical-approach/mirrortester_2.jpg" class="fancy"><img src="/sql-server-mirroring-a-practical-approach/mirrortester_2.jpg" style="max-height: 250px"/></a></div></div>

<p>It continuously attempts to connect to the databases using three different connection strings:</p>
<figure class="highlight cs"><pre><span class="keyword">string</span> principalConnection = <span class="string">"Data Source=Mandalay;Connect Timeout=1;Initial Catalog=AdventureWorks;User Id=sa;Password=sadpassword;Pooling=false"</span>;
<span class="keyword">string</span> mirrorConnection = <span class="string">"Data Source=Rio;Connect Timeout=1;Initial Catalog=AdventureWorks;User Id=sa;Password=sadpassword;Pooling=false"</span>;
<span class="keyword">string</span> totalConnection = <span class="string">"Data Source=Mandalay;Failover Partner=Rio;Connect Timeout=1;Initial Catalog=AdventureWorks;User Id=sa;Password=sadpassword;Pooling=false"</span>;
</pre></figure>

<p>The first connects directly to MANDALAY, the principal database. The second one goes to RIO, the mirror. And the last one is the mirror enabled connection string that combines the two. The principal should respond and act like any other normal database. The mirror will throw an exception as we cannot interact with a datbase in recovery mode. The combined connection will automatically connect to the current principal database, whether it be MANDALAY or RIO.</p>
<p>To detect a broken connection quickly, I connect to the databases every 250ms and display a green bar if the connection succeeded (and an UPDATE &amp; SELECT went well), and red if any kind of exception arose. To detect a connection timeout in a timely fashion, I’m using my <a href="/controlling-sqlconnection-timeouts/">QuickOpen</a> functionality. The SUM(SafetyStockLevel) is the result of a simple SELECT query being done on the database (the UPDATE modifies the same table, hence the changing values), just to make sure we’re actually talking to a live database.</p>
<p>In the following test, it gets a bit more complicated to follow. I’ve got two SQL Server Profiler windows open, the left one is monitoring the MANDALAY server, the right one is monitoring the RIO server. The windows are so small you cannot see what actually gets logged, but that is the point. The only relevant data in this case is the bottom rightmost value, Rows:X that displays an increasing rowcount when the server is active.</p>
<p>I will start out by starting up the mirror testing application. We should see a red bar for the mirror database (RIO) as we cannot connect to it directly, while the principal (MANDALAY) and the mirrored connection should both show green bars. The MANDALAY profiler should also show activity, whilst the RIO profiler should not show any activity.</p>
<p>When it’s running, I’ll initiate a manual mirror failover. A failover means we’re switching roles, thus RIO will become the new principal and MANDALAY will become the mirror. Effectively this should mean the combined connection still shows a green bar, MANDALAY shows red and RIO switches to green.</p>
<div class="video-container"><iframe src="//www.youtube.com/embed/W7iw58KN4Sg" frameborder="0" allowfullscreen></iframe></div>


<h2 id="The_TCP/IP_connection_retry_algorithm">The TCP/IP connection retry algorithm</h2>
<p>The failover went perfect. There’s a short amount of downtime as the actual failover takes place, but shortly thereafter, we get green bars again - but one too many. When we started out, we got a red bar when trying to connect to the mirror, RIO. Shouldn’t we be getting a red bar when trying to connect to MANDALAY after we’ve switched the roles so MANDALAY has now become the new mirror? As you can see in the profilers, only RIO is being queried, so although MANDALAY is not responding, the connection string pointing to MANDALAY is succeeding. And what’s more confusing is that the new instance of the testing application showed the expected result, a green bar for RIO and red for MANDALAY - at the same time as the existing one showed all greens.</p>
<p>The explanation is due to the <a href="http://msdn2.microsoft.com/en-us/library/ms365783.aspx" target="_blank">connection retry algorithm for TCP/IP connections</a>. When we have a mirrored connection, the partner names are cached when used. Although we couldn’t query RIO before, the partner name was cached. Thus when we make the failover and MANDALAY looses connection, it’ll automatically make a retry attempt by connecting to the mirror partner, RIO. When the database comes up again, RIO is responding to both connections successfully. So although the connection string specifies MANDALAY as the endpoint, we’re actually talking to RIO directly.</p>
<p>Now, when the cache times out, or if we start a new application (the cache is tied to the SqlClient within a specific AppDomain), the partner name has not been cached and a retry will not be attempted, and that’s why the new instance shows the expected result alongside the old instance.</p>
<h2 id="When_a_database_dies">When a database dies</h2>
<p>This is the scenario we’ve been preparing for. But what happens when one of the databases die? In high safety mode, a transaction has to be committed on both the principal and on the mirror before it’s declared successful, but in case the mirror dies (whether due to the service stopping, the physical hardware crashing or something else) the principal will enter a disconnected state, still offering full availability. When you get the mirror database up and running again, it will automatically synchronize with the principal and the mirror will continue as if nothing had happened. High performance mode will also continue unaffected with a dead mirror, and it will also automatically resynch when the mirror comes back online.</p>
<p>Here’s a quick video demonstrating the availability of the principal when the mirror goes down (the short red bars are caused by Virtual PC pausing all VPCs when the menu bar is open).</p>
<div class="video-container"><iframe src="//www.youtube.com/embed/UQFrD3RmNrg" frameborder="0" allowfullscreen></iframe></div>



<p>If the principal dies, we need to promote the mirror to the principal role. As soon as the mirror has undertaken the principal role, we have access to our database again. This can be done safely in the synchronous high safety operating mode as we do not risk any dataloss due to all transactions being made simultaneously in both databases. In the high performance mode thugh, we cannot do this as there could potentially be transactions that has not yet been transferred to the mirror, which would result in data loss. In this case we have to get the principal back online - or accept possible data loss, depending on what’s acceptable.</p>
<p>In the following video I’ll simulate a dead principal. I’ll show the availability tester application running, using MANDALAY as the principal, RIO being the mirror. I’ll the pause the MANDALAY server, effectively simulating it dropping completely off the network. You’ll then notice all red bars in the tester application, as expected. To get the database up again, we have to do a manual failover to the mirror server, making it the new principal. We do that by executing the query:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">ALTER</span> <span class="keyword">DATABASE</span> AdventureWorks <span class="keyword">SET</span> PARTNER FORCE_SERVICE_ALLOW_DATA_LOSS</span>
</pre></figure>

<p>There is no GUI that’ll execute this query. Soon after I’ve executed the query, we get green bars again. Notice that all bars are green, this is due to the connection retry algorithm as explained earlier - the MANDALAY server is still offline. As I refresh the database list on RIO, you’ll notice that the database is now listed as “Principal, Disconnected”, confirming that the RIO database has undertaken the principal role, while disconnected from the mirror. I’ll then resume MANDALAY, and as I refresh the MANDALAY database list, you’ll notice that the database automatically changed state into “Mirror, Suspended / Restoring” - it picked up on the role change and is now awaiting further commands. It will not automatically resynch as mirroring is suspended when we force the principiality change through the ALLOW_SERVICE_DATA_LOSS parameter. We first have to resume the mirroring functionality. After having resumed mirroring, I’ll wait for the databases to synch up completely, after which I’ll do a manual failover so MANDALAY becomes the principal again. There’s a short downtime as the failover takes place, but after that, we’ve got green bars and MANDALAY returns as the principal, RIO changing to mirror.</p>
<div class="video-container"><iframe src="//www.youtube.com/embed/R73OPBzS0ag" frameborder="0" allowfullscreen></iframe></div>



<p>And there we go, we just experienced a principal going down with minimal service unavailability.</p>
<h2 id="High_security_with_a_witness">High security with a witness</h2>
<p>The restoration process we just experienced can be automated if we choose to utilize a third server known as the witness. The witness server continually monitors the principal and will initiate a failover in case the principal dies, as well as restoring the mirrors functionality when it returns (that is, converting the previous principal to the new mirror). It requires a third server, MGM (IP 192.168.0.35) for the witness part. Setup is more or less as usual, we just need to include the FQDN for the witness server.</p>
<p>In the last video I’ll show how to setup the mirroring including a witness server. I will then start the availability testing application and pause the principal server afterwards. This will immediatly result in red boxes all over, but after a short while, the RIO server (the new principal) becomes green, and a moment after, the mirrored connection itself also becomes green. The MANDALAY box is also green, but again, this is due to the retry mechanism as explained earlier. You’ll then see that the previous mirror database has now changed status to “Principal, Disconnected”, proving that it has overtaken the principal responsibility and that it has lost connection to the mirror. I’ll then show how the MANDALAY database has changed status to mirror, and how we can do a manual failover so everything goes back to normal. This is the point when FQDNs became neccessary. Using IPs resulted in the mirror not being able to make the failover. As stated earlier, using IPs is a bad practice, you should always use FQDNs. I’ve added the AD hostnames to my hosts file so I can enter them from my non-AD member desktop machine.</p>
<div class="video-container"><iframe src="//www.youtube.com/embed/oa6ZYxIPNFg" frameborder="0" allowfullscreen></iframe></div>



<h2 id="Conclusion">Conclusion</h2>
<p>SQL Mirroring is a great way to increase your availability rate in case of database failures. You need to understand precisely where mirroring will help and where it won’t make a difference. It won’t help when you fire out a TRUNCATE [WRONG_TABLE] statement since it’ll just be replicated on the mirror, for that you’ll still have to make a rollback via the logs. It’ll help you in the case of a server crashing due to either hardware, software or network failures (depending on your network setup) and so forth. It’ll also enable you to <a href="http://msdn2.microsoft.com/en-us/library/bb497962.aspx" target="_blank">do rolling upgrades</a>.</p>
<p>While configuration is rather straight forward, mirroring will add complexity to your setup and errors may be harder to track down. You also have to consider the licensing requirements depending on the level of mirroring you’re planning to use.</p>
<h2 id="Downloads">Downloads</h2>
<p><a href="SQL_Mirroring_Tester.zip">SQL_Mirroring_Tester.zip - Test solution</a></p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Mar</span>
			<span class="day">13</span>
		</div>
		<div class="lower">2008</div>
	</div>

	<div class="title">
		<h1><a href="/csharp-string-enumerations/" title="C# String Enumerations" rel="bookmark">C# String Enumerations</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Switches are rarely nice in an architectural aspect, but they are often required none the less. One of the ways we can reduce the risk of errors as well as increase readability is to use enumeration values instead of constants. Unfortunately this only works for numeric types, we cannot create a string enumeration. Here’s a workaround.  This is a typical console application, taking in an input value (stored in the input variable) and switching on the content:</p>
<a id="more"></a>


<figure class="highlight cs"><pre><span class="keyword">using</span> System;

namespace StringEnumeration
{
	class Program
	{
		<span class="keyword">static</span> <span class="keyword">void</span> Main(<span class="keyword">string</span>[] args)
		{
			<span class="keyword">string</span> input = <span class="string">"Hello"</span>;

			<span class="keyword">switch</span> (input)
			{
				<span class="keyword">case</span> <span class="string">"Hello"</span>:
					Console.WriteLine(<span class="string">"Hello world!"</span>);
					<span class="keyword">break</span>;
				<span class="keyword">case</span> <span class="string">"Goodbye"</span>:
					Console.WriteLine(<span class="string">"Goodbye world!"</span>);
					<span class="keyword">break</span>;
				<span class="keyword">default</span>:
					Console.WriteLine(<span class="string">"Does not compute!"</span>);
					<span class="keyword">break</span>;
			}
		}
	}
}
</pre></figure>

<p>The first step is to define the enumeration of values we need to have in our switch statement:</p>
<figure class="highlight cs"><pre><span class="keyword">enum</span> Input
{
	Hello,
	Goodbye
}
</pre></figure>

<p>We cannot convert from strings to the Input enumeration type directly, so we’ll have to use a magic function like this:</p>
<figure class="highlight cs"><pre>class EnumHelper
{
	<span class="keyword">public</span> <span class="keyword">static</span> T Parse&lt;T&gt;(<span class="keyword">string</span> input)
	{
		<span class="keyword">return</span> (T)Enum.Parse(<span class="keyword">typeof</span>(T), input, <span class="keyword">true</span>);
	}
}
</pre></figure>

<p>Using the above function, we can refactor our initial code like so:</p>
<figure class="highlight cs"><pre><span class="keyword">string</span> input = <span class="string">"Hello"</span>;

<span class="keyword">switch</span> (EnumHelper.Parse&lt;Input&gt;(input))
{
	<span class="keyword">case</span> Input.Hello:
		Console.WriteLine(<span class="string">"Hello world!"</span>);
		<span class="keyword">break</span>;
	<span class="keyword">case</span> Input.Goodbye:
		Console.WriteLine(<span class="string">"Goodbye world!"</span>);
		<span class="keyword">break</span>;
	<span class="keyword">default</span>:
		Console.WriteLine(<span class="string">"Does not compute!"</span>);
		<span class="keyword">break</span>;
}
</pre></figure>

<p>Take notice that I’m passing in true as the third parameter of the Enum.Parse method, this means the type conversion will not be case sensitive, you can change this parameter as needed, or maybe refactor it into a parameter of the function. If the conversion fails - if a matching enumeration does not exist - an ArgumentException is thrown.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Mar</span>
			<span class="day">10</span>
		</div>
		<div class="lower">2008</div>
	</div>

	<div class="title">
		<h1><a href="/controlling-sqlconnection-timeouts/" title="Controlling SqlConnection Timeouts" rel="bookmark">Controlling SqlConnection Timeouts</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>When performing queries against a SQL Server database, there are a couple of methods readily available. However, an option is missing.</p>
<a id="more"></a>

<p>The primary timeout value is that of SqlConnection.ConnectionTimeout. This specifies how long time the SQL Server service has to respond to a connection attempt. You cannot set this value directly, you’ll have to set it as part of the connection string:</p>
<figure class="highlight"><pre><span class="attribute">Data Source</span>=<span class="string">server;Initial Catalog=databaseUser Id=username;Password=password;Connect Timeout=30</span>
</pre></figure>

<p>Note that the value is expressed in seconds, not milliseconds. The default value is 30 seconds. Secondly, we can use the <a href="http://msdn2.microsoft.com/en-us/library/system.data.sqlclient.sqlcommand.commandtimeout.aspx" target="_blank">SqlCommand.CommandTimeout</a> value. This sets the timeout value of a specific query running on SQL Server. The problem with these two is that we’re missing a point in the pipeline, which goes:</p>
<p>TCP Connection to SQL Server -&gt; SqlConnection.Open -&gt; SqlCommand.Execute</p>
<p>The last two are covered, but if for some reason the SQL Server is dead, taken off the network, totally overloaded, we may get a timeout on the TCP level - and this could take a while. We currently have no way of controlling this timeout besides a server wide network level setting. Often, it’s not desirable to have your application potentially spending several minutes before receiving a TCP timeout - or sometimes simply wait indefinitely. We need some way to control this.</p>
<p>What I present below is an example of a SqlConnection extension method called QuickOpen (in lack of a better name, it isn’t quicker, it simply fails quicker). It’ll take a timeout parameter in milliseconds, after which it’ll throw a simple Exception. You can modify this to a more proper exception, this is just to show the point. Overall, using this method will introduce a slight delay (a couple of ms), so use it only when necessary, or when a couple of ms per SqlConnection.Open doesn’t matter.</p>
<figure class="highlight cs"><pre><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> SqlExtensions
{
	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">QuickOpen</span>(<span class="keyword">this</span> SqlConnection conn, <span class="keyword">int</span> timeout)
	{
		<span class="comment">// We'll use a Stopwatch here for simplicity. A comparison to a stored DateTime.Now value could also be used</span>
		Stopwatch sw = <span class="keyword">new</span> Stopwatch();
		<span class="keyword">bool</span> connectSuccess = <span class="keyword">false</span>;

		<span class="comment">// Try to open the connection, if anything goes wrong, make sure we set connectSuccess = false</span>
		Thread t = <span class="keyword">new</span> Thread(<span class="keyword">delegate</span>()
		{
			<span class="keyword">try</span>
			{
				sw.Start();
				conn.Open();
				connectSuccess = <span class="keyword">true</span>;
			}
			<span class="keyword">catch</span> { }
		});

		<span class="comment">// Make sure it's marked as a background thread so it'll get cleaned up automatically</span>
		t.IsBackground = <span class="keyword">true</span>;
		t.Start();

		<span class="comment">// Keep trying to join the thread until we either succeed or the timeout value has been exceeded</span>
		<span class="keyword">while</span> (timeout &gt; sw.ElapsedMilliseconds)
			<span class="keyword">if</span> (t.Join(<span class="number">1</span>))
				<span class="keyword">break</span>;

		<span class="comment">// If we didn't connect successfully, throw an exception</span>
		<span class="keyword">if</span> (!connectSuccess)
			<span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Timed out while trying to connect."</span>);
	}
}
</pre></figure>



				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>


<div class="paging">
	<a href="/page/18/"><div class="past">« Past</div></a>
	<a href="/page/16/"><div class="future">Future »</div></a>
	<div class="clear"></div>
</div>

				</div>
			</div>

			<div id="asides">
				<div class="categories aside">
					<span class="sectiontitle">CATEGORIES</span>
					<ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/category/.NET/">.NET</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/AS/Flex/Flash/">AS/Flex/Flash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Amazon Web Services/">Amazon Web Services</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Computer Science/">Computer Science</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Conferences and Presenting/">Conferences and Presenting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/IIS/">IIS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Life/">Life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Misc/">Misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Miscellaneous/">Miscellaneous</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Performance/">Performance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Poker/">Poker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server/">SQL Server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Community/">SQL Server - Community</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Data Types/">SQL Server - Data Types</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Internals/">SQL Server - Internals</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Optimization/">SQL Server - Optimization</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Tricks/">SQL Server - Tricks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Testing/">Testing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Tools of the Trade/">Tools of the Trade</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Umbraco/">Umbraco</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Visual Studio/">Visual Studio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Web/">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windbg/">Windbg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windows/">Windows</a></li></ul>

					
				</div>

				<div class="archive aside">
					<span class="sectiontitle">ARCHIVE</span>
					<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archive/2014">2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2013">2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2012">2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2011">2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2010">2010</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2009">2009</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2008">2008</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2007">2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2006">2006</a></li></ul>
				</div>
			</div>

			<div class="clear"></div>
		</div>
		
		<footer>
			<div class="wrapper">Copyright &copy; 2014 Mark S. Rasmussen</div>
		</footer>

		<script type="text/javascript">
			$(function () {
				// Show mobile menu
				$("li.navicon").click(function () {
					if ($("header ul.mobile a").length == 0) {
						// Pages
						$mobilePages = $("div#naviconcontent ul.pages");
						$("header nav ul.normal > li").not(".navicon").each(function (i, el) {
							$mobilePages.append($(el).clone());
						});

						// Categories
						$mobileCategories = $("div#naviconcontent ul.categories");
						$("div#asides div.categories > ul > li").each(function (i, el) {
							$mobileCategories.append($(el).clone());
						});

						// Archive
						$mobileArchive = $("div#naviconcontent ul.archive");
						$("div#asides div.archive > ul > li").each(function (i, el) {
							$mobileArchive.append($(el).clone());
						});
					};

					$("header ul.mobile").toggle();
				});

				// Fancybox setup
				$("a.fancy").fancybox({
					hideOnContentClick: true,
					overlayShow: true
				});
			});
		</script>
	</body>
</html>