<!DOCTYPE html>
<html>
	

<head>
	<title>Mark S. Rasmussen</title>
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
	<meta charset="UTF-8" />
	<meta property="og:locale" content="en_US" />
	<meta property="og:type" content="website" />
	<meta name="google-site-verification" content="alt7-wfK3ZujMQ4D0jYNd0yC5LGetGdqBlBmZsqQlVw" />
	<meta content="article" property="og:type">
<meta content="Mark S. Rasmussen" property="og:title">
<meta content="http://improve.dk/page/9/" property="og:url">
<meta property="og:image">
<meta content="Mark S. Rasmussen" property="og:site_name">
<meta property="og:description">
<meta content="summary" name="twitter:card">
	<link rel="alternative" href="http://feeds.feedburner.com/Improvedk" title="Mark S. Rasmussen" type="application/atom+xml">
	<script src="/js/combined.js"></script>
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-2479580-1', 'improve.dk');
		ga('require', 'displayfeatures');
		ga('send', 	'pageview');
	</script>
	<link rel="stylesheet" href="/css/style.css" type="text/css" />
</head>
	<body>
		<div id="headerline"></div>
	
		<header>
			<div class="wrapper">
				<div id="title">
					<a href="/">Mark S. Rasmussen</a> <span>improve.dk</span>
				</div>
				
				<nav>
					<ul class="normal">
						<li class="navicon"></li>
						<li><a href="/about-me/">About Me</a></li>
					</ul>
				</nav>
				
				<ul id="sharing">
					<li><a href="mailto:mark@improve.dk" id="shareat"></a></li>
					<li><a href="http://feeds.feedburner.com/Improvedk" id="rssfeed"></a></li>
					<li><a href="https://twitter.com/improvedk" id="sharetwitter"></a></li>
					<li><a href="https://github.com/improvedk" id="sharegithub"></a></li>
					<li><a href="https://www.linkedin.com/in/markrasmussen/" id="sharelinkedin"></a></li>
				</ul>

				<div class="clear"></div>
				
				<div id="naviconcontent">
					<ul class="mobile">
						<li>
							Pages
							<ul class="pages"></ul>
						</li>
						<li>
							Categories
							<ul class="categories"></ul>
						</li>
						<li>
							Archive
							<ul class="archive"></ul>
						</li>
					</ul>
				</div>
			</div>
		</header>

		<div id="mainwrapper">
			<div id="contentwrapper">
				<div id="content">
				
					
	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jul</span>
			<span class="day">12</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/sqlbits-9-voting-amp-registration-open/" title="SQLBits 9 Voting &amp; Registration Open" rel="bookmark">SQLBits 9 Voting &amp; Registration Open</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>The <a href="http://sqlbits.com/information/Pricing.aspx" target="_blank">registration for SQLBits 9 is now open</a>.Equally important, the voting for sessions is has also opened. Simply login and take a look at the <a href="http://sqlbits.com/information/PublicSessions.aspx" target="_blank">list of sessions</a> to vote for your preferred sessions.</p>
<a id="more"></a>

<h2 id="My_sessions">My sessions</h2>
<p><img style="margin: 15px; display: inline; float: right;" alt="Training Day" src="http://sqlbits.com/images/SQLBits/SQLBitsTrainingDay.png" align="right" /></p>
<p>Besides doing a full day training on the <a href="http://sqlbits.com/information/Event9/SQL_Server_Storage_Engine_and_MDF_File_Internals/TrainingDetails.aspx" target="_blank">SQL Server Storage Engine and MDF File Internals</a>, I’ve also submitted two related sessions that present a subset of the training day material, in a much more dense format. Both sessions are very technical deep dives on the storage internals. If you think they sound interesting, I’d appreciate a vote :)</p>
<h3 id="Knowing_The_Internals,_Who_Needs_SQL_Server_Anyway?">Knowing The Internals, Who Needs SQL Server Anyway?</h3>
<p>You’re stuck on a remote island with just a laptop and your main database .MDF file. The boss calls and asks you to retrieve some data, but alas, you forgot to install SQL Server on your laptop. Luckily you have a HEX editor by your side!</p>
<p>In this level 500 deep dive session we will go into the intimate details of the MDF file format. Think using DBCC Page is pushing it? Think again! As a learning experiment, I’ve created an open source parser for MDF files, called OrcaMDF. Using the OrcaMDF parser I’ll go through the primary storage structures, how to parse page headers, boot pages, internal system tables, data &amp; index records, b-tree structures as well as the supporting IAM, GAM, SGAM &amp; PFS pages.</p>
<p>Has your database suffered an unrecoverable disk corruption? This session might just be your way out! Using a corrupt &amp; unattachable MDF file, I’ll demo how to recover as much data as possible. This session is not for the faint of heart, there will be bits &amp; bytes.</p>
<h3 id="Demystifying_Database_Metadata">Demystifying Database Metadata</h3>
<p>You know how to query sys.tables, sys.columns and perhaps even sys.system_internals_allocation_units to discover the metadata contents of a database. But where are these views getting their data from, and how do the core system tables relate?</p>
<p>Based on my work with OrcaMDF, an open source C# parser for MDF files, I will demonstrate how to parse the internal system tables. Using just the boot page as origin, we’ll discover how to traverse the chain of references that ultimately end up in references to the actual system table data, from where we can parse the data records.</p>
<p>Once we’ve got the system table data, I’ll demonstrate how to correlate the different tables to end up with the data we see in common system views.</p>
<h2 id="My_picks">My picks</h2>
<p><img style="margin: 15px; display: inline; float: right;" alt="Sessions Title" src="http://sqlbits.com/images/headings/Sessions.png" width="286" height="98" align="right" />Having only 10 votes, it’s tough to pick out the top 10 sessions from a list of almost ~150 sessions. Though it was a struggle, I ended up with the following votes:</p>
<p><a href="http://sqlbits.com/Sessions/Event9/Performance_tuning_from_the_field" target="_blank">Performance tuning from the field</a> by Simon Sabin<br><a href="http://sqlbits.com/Sessions/Event9/Transaction_Log_Performance_and_Troubleshooting-Deep_Dive" target="_blank">Transaction Log Performance and Troubleshooting – Deep Dive</a> by Chirag Roy<br><a href="http://sqlbits.com/Sessions/Event9/SQL_Server_Denali-Always_On_Deep_Dive" target="_blank">SQL Server Denali – Always On Deep Dive</a> by Bob Duffy<br><a href="http://sqlbits.com/Sessions/Event9/HA_DR-Focus_on_Options_Comparisons_and_Interoperability" target="_blank">HA/DR – Focus on Options, Comparisons and Interoperability</a> by Chirag Roy<br><a href="http://sqlbits.com/Sessions/Event9/READPAST__Furious_Transactions_Locking_and_Isolation" target="_blank">READPAST &amp; Furious: Transactions, Locking and Isolation</a> by Mark Broadbent<br><a href="http://sqlbits.com/Sessions/Event9/Preparation_for_Disaster" target="_blank">Preparation for Disaster</a> by Steve Jones<br><a href="http://sqlbits.com/Sessions/Event9/Busted_A_journey_into_the_most_common_TSQL__Tuning_myths" target="_blank">Busted! A journey into the most common TSQL &amp; Tuning myths</a> by David Morrison<br><a href="http://sqlbits.com/Sessions/Event9/Turbocharge_Database_Recoverability_Performance" target="_blank">Turbocharge Database Recoverability Performance</a> by Chirag Roy<br><a href="http://sqlbits.com/Sessions/Event9/Implementing_Real-Time_Data_Warehouse" target="_blank">Implementing Real-Time Data Warehouse</a> by Sutha Thiru<br><a href="http://sqlbits.com/Sessions/Event9/Replication-Best_Practices_Troubleshooting__Performance" target="_blank">Replication – Best Practices, Troubleshooting &amp; Performance</a> by Neil Hambly  </p>
<p>Not until now did I notice that three of my sessions are by <a href="http://sqlking.wordpress.com/" target="_blank">Chirag Roy</a>, I’ll use this as an opportunity to congratulate him on becoming the latest <a href="http://www.microsoft.com/learning/en/us/certification/master-sql.aspx" target="_blank">Microsoft Certified Master</a>!</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jul</span>
			<span class="day">11</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/converting-between-base-2-10-and-16-in-t-sql/" title="Converting Between Base 2, 10 and 16 in T-SQL" rel="bookmark">Converting Between Base 2, 10 and 16 in T-SQL</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - Tricks/">SQL Server - Tricks</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>There are many <a href="http://en.wikipedia.org/wiki/List_of_numeral_systems" target="_blank">numeral systems</a>, the most common ones in computer science being <a href="http://en.wikipedia.org/wiki/Binary_numeral_system" target="_blank">binary</a> (base 2), <a href="http://en.wikipedia.org/wiki/Decimal" target="_blank">decimal</a> (base 10) and <a href="http://en.wikipedia.org/wiki/Hexadecimal" target="_blank">hexadecimal</a> (base 16). All numbers can be expressed in either system and you may now and then need to convert between them.</p>
<a id="more"></a>

<p>Take the number 493.202.384 as an example, it can be be expressed as either 0n493202384 in decimal, 0x1D65ABD0 in hexadecimal or 0b11101011001011010101111010000 in binary. Note how the 0n prefix declares a decimal value, 0x a hexadecimal and 0b a binary value.</p>
<h2 id="Converting_using_Google">Converting using Google</h2>
<p>If you’ve got an internet connection, the quickest and simplest way is often to just use Google. We can convert the above number using “in X” queries:</p>
<p><a href="http://www.google.dk/search?sourceid=chrome&amp;ie=UTF-8&amp;q=493202384+in+hex" target="_blank">493202384 in hex</a><br><a href="http://www.google.dk/search?sourceid=chrome&amp;ie=UTF-8&amp;q=493202384+in+binary" target="_blank">493202384 in binary</a></p>
<h2 id="Converting_using_Windows_Calculator">Converting using Windows Calculator</h2>
<p>You can also open Windows Calculator, switch to the programmer mode and type in the decimal value (or the hex/binary value):</p>
<div class="imgwrapper" style=""><div><a href="/converting-between-base-2-10-and-16-in-t-sql/image_25.png" class="fancy"><img src="/converting-between-base-2-10-and-16-in-t-sql/image_25.png" style="max-height: 250px"/></a></div></div>

<p>And from then on we can just switch the numerical system selector to the left:</p>
<div class="imgwrapper" style=""><div><a href="/converting-between-base-2-10-and-16-in-t-sql/image_43.png" class="fancy"><img src="/converting-between-base-2-10-and-16-in-t-sql/image_43.png" style="max-height: 250px"/></a></div></div>

<div class="imgwrapper" style=""><div><a href="/converting-between-base-2-10-and-16-in-t-sql/image_63.png" class="fancy"><img src="/converting-between-base-2-10-and-16-in-t-sql/image_63.png" style="max-height: 250px"/></a></div></div>

<h2 id="Converting_between_decimal_&amp;_hex_in_T-SQL">Converting between decimal &amp; hex in T-SQL</h2>
<p>Sometimes however, it’s just a tad easier if we could do it directly from a T-SQL query. Converting between decimal and hexadecimal is straightforward and can be done using just built in functions:</p>
<figure class="highlight sql"><pre><span class="comment">-- Decimal to hex</span>
<span class="operator"><span class="keyword">SELECT</span> <span class="keyword">CAST</span>(<span class="number">493202384</span> <span class="keyword">AS</span> varbinary)

-- Hex <span class="keyword">to</span> <span class="keyword">decimal</span>
<span class="keyword">SELECT</span> <span class="keyword">CAST</span>(<span class="number">0x1D65ABD0</span> <span class="keyword">AS</span> <span class="keyword">int</span>)

-- <span class="keyword">Decimal</span> <span class="keyword">to</span> hex <span class="keyword">to</span> <span class="keyword">decimal</span>
<span class="keyword">SELECT</span> <span class="keyword">CAST</span>(<span class="keyword">CAST</span>(<span class="number">493202384</span> <span class="keyword">AS</span> varbinary) <span class="keyword">AS</span> <span class="keyword">int</span>)</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/converting-between-base-2-10-and-16-in-t-sql/image_84.png" class="fancy"><img src="/converting-between-base-2-10-and-16-in-t-sql/image_84.png" style="max-height: 250px"/></a></div></div>

<h2 id="Converting_binary_to_decimal_using_T-SQL">Converting binary to decimal using T-SQL</h2>
<p>Converting to/from binary is a bit more tricky though, as there are no built in functions for formatting a decimal number as a binary string, nor converting the latter to the first.</p>
<p>The following function takes in a binary string and returns a bigint with the decimal value:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">CREATE</span> FUNCTION [dbo].[BinaryToDecimal]
(
	@<span class="keyword">Input</span> <span class="keyword">varchar</span>(<span class="number">255</span>)
)
RETURNS bigint
<span class="keyword">AS</span>
<span class="keyword">BEGIN</span>

	<span class="keyword">DECLARE</span> @Cnt tinyint = <span class="number">1</span>
	<span class="keyword">DECLARE</span> @Len tinyint = LEN(@<span class="keyword">Input</span>)
	<span class="keyword">DECLARE</span> @<span class="keyword">Output</span> bigint = <span class="keyword">CAST</span>(SUBSTRING(@<span class="keyword">Input</span>, @Len, <span class="number">1</span>) <span class="keyword">AS</span> bigint)

	WHILE(@Cnt &lt; @Len) <span class="keyword">BEGIN</span>
		<span class="keyword">SET</span> @<span class="keyword">Output</span> = @<span class="keyword">Output</span> + POWER(<span class="keyword">CAST</span>(SUBSTRING(@<span class="keyword">Input</span>, @Len - @Cnt, <span class="number">1</span>) * <span class="number">2</span> <span class="keyword">AS</span> bigint), @Cnt)

		<span class="keyword">SET</span> @Cnt = @Cnt + <span class="number">1</span>
	<span class="keyword">END</span>

	RETURN @<span class="keyword">Output</span>	

<span class="keyword">END</span></span>
</pre></figure>

<p>The function looks at each char in the input string (starting from behind), adding POWER(2, @Cnt) to the result if the bit is set – with special handling of the first (that is, from behind) character since POWER(2, 0) is 1 while we need it to be 0.</p>
<p>Usage is straight forward:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span> dbo.BinaryToDecimal(<span class="string">'11101011001011010101111010000'</span>)</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/converting-between-base-2-10-and-16-in-t-sql/image_182.png" class="fancy"><img src="/converting-between-base-2-10-and-16-in-t-sql/image_182.png" style="max-height: 250px"/></a></div></div>

<h2 id="Converting_decimal_to_binary_using_T-SQL">Converting decimal to binary using T-SQL</h2>
<p>The following function takes a bigint as input and returns a varchar with the binary representation, using the <a href="http://www.wikihow.com/Convert-from-Decimal-to-Binary" target="_blank">short division by two with remainder</a> algorithm:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">CREATE</span> FUNCTION [dbo].[DecimalToBinary]
(
	@<span class="keyword">Input</span> bigint
)
RETURNS <span class="keyword">varchar</span>(<span class="number">255</span>)
<span class="keyword">AS</span>
<span class="keyword">BEGIN</span>

	<span class="keyword">DECLARE</span> @<span class="keyword">Output</span> <span class="keyword">varchar</span>(<span class="number">255</span>) = <span class="string">''</span>

	WHILE @<span class="keyword">Input</span> &gt; <span class="number">0</span> <span class="keyword">BEGIN</span>

		<span class="keyword">SET</span> @<span class="keyword">Output</span> = @<span class="keyword">Output</span> + <span class="keyword">CAST</span>((@<span class="keyword">Input</span> % <span class="number">2</span>) <span class="keyword">AS</span> <span class="keyword">varchar</span>)
		<span class="keyword">SET</span> @<span class="keyword">Input</span> = @<span class="keyword">Input</span> / <span class="number">2</span>

	<span class="keyword">END</span>

	RETURN REVERSE(@<span class="keyword">Output</span>)

<span class="keyword">END</span></span>
</pre></figure>

<p>Again usage is straight forward:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span> dbo.DecimalToBinary(<span class="number">493202384</span>)</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/converting-between-base-2-10-and-16-in-t-sql/image_123.png" class="fancy"><img src="/converting-between-base-2-10-and-16-in-t-sql/image_123.png" style="max-height: 250px"/></a></div></div>

<h2 id="Ensuring_correctness">Ensuring correctness</h2>
<p>A simple test to ensure correct conversions would be to convert from A to B and back to A again, using both of the above functions. Thus whatever we give as input should be the output as well:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span> dbo.DecimalToBinary(dbo.BinaryToDecimal(<span class="string">'11101011001011010101111010000'</span>))
<span class="keyword">SELECT</span> dbo.BinaryToDecimal(dbo.DecimalToBinary(<span class="number">493202384</span>))</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/converting-between-base-2-10-and-16-in-t-sql/image_202.png" class="fancy"><img src="/converting-between-base-2-10-and-16-in-t-sql/image_202.png" style="max-height: 250px"/></a></div></div>

<p>Et voilá! Once we have the functions, they can easily be used in a normal query:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span>
	object_id,
	<span class="keyword">CAST</span>(object_id <span class="keyword">AS</span> varbinary) <span class="keyword">AS</span> object_id_hex,
	dbo.DecimalToBinary(object_id) <span class="keyword">AS</span> object_id_binary
<span class="keyword">FROM</span>
	sys.objects</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/converting-between-base-2-10-and-16-in-t-sql/image_162.png" class="fancy"><img src="/converting-between-base-2-10-and-16-in-t-sql/image_162.png" style="max-height: 250px"/></a></div></div>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jul</span>
			<span class="day">06</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/" title="Determining the Uniquifier Column Ordinal for Clustered and Nonclustered Indexes" rel="bookmark">Determining the Uniquifier Column Ordinal for Clustered and Nonclustered Indexes</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - Internals/">SQL Server - Internals</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Lately I’ve been working on nonclustered index parsing. One of my test cases proved to be somewhat more tricky than I’d anticipated, namely the parsing of nonclustered indexes for non-unique clustered tables. Working with non-unique clustered indexes, we’ll have to take care of <a href="http://www.mssqltips.com/tip.asp?tip=2082" target="_blank">uniquifiers</a> when necessary.</p>
<a id="more"></a>

<h2 id="The_setup">The setup</h2>
<p>Using an empty database I create the following schema and insert two rows. Note that the clustered index is created on the (ID, Name) columns and will thus have uniquifiers inserted since my rows aren’t unique. Also note that I’m intentionally creating a schema that will cause all three allocation unit types to be created – IN_ROW_DATA by default, LOB_DATA for the text column and finally ROW_OVERFLOW_DATA due to the overflowing varchar filler columns. This won’t serve any practical purpose besides being eye candy when looking at the data :)</p>
<figure class="highlight sql"><pre><span class="comment">-- Create schema</span>
<span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Test
(
	ID <span class="keyword">int</span>,
	Name <span class="keyword">varchar</span>(<span class="number">10</span>),
	FillerA <span class="keyword">varchar</span>(<span class="number">8000</span>) <span class="keyword">DEFAULT</span>(REPLICATE(<span class="string">'x'</span>, <span class="number">5000</span>)),
	FillerB <span class="keyword">varchar</span>(<span class="number">8000</span>) <span class="keyword">DEFAULT</span>(REPLICATE(<span class="string">'y'</span>, <span class="number">5000</span>)),
	Data text <span class="keyword">DEFAULT</span> (<span class="string">''</span>)
)
<span class="keyword">CREATE</span> CLUSTERED INDEX CX_ID_Name <span class="keyword">ON</span> Test (ID, Name)
<span class="keyword">CREATE</span> NONCLUSTERED INDEX IX_ID <span class="keyword">ON</span> Test (ID)

-- <span class="keyword">Insert</span> dummy data
<span class="keyword">INSERT</span> <span class="keyword">INTO</span>
	Test (ID, Name)
<span class="keyword">VALUES</span>
	(<span class="number">1</span>, <span class="string">'Mark'</span>),
	(<span class="number">1</span>, <span class="string">'Mark'</span>)</span>
</pre></figure>

<h2 id="Verifying_the_presence_of_uniquifiers_in_the_clustered_index">Verifying the presence of uniquifiers in the clustered index</h2>
<p>Running a quick DBCC IND on the Test table’s clustered index in the database (I’ve named mine ‘Y’ – I’m lazy), demonstrates the allocation of three allocation unit types as well as their tracking IAM pages.</p>
<figure class="highlight sql"><pre>DBCC IND (Y, 'Test', 1)
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_23.png" class="fancy"><img src="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_23.png" style="max-height: 250px"/></a></div></div>

<p>What we’re interested in are the two data pages of the clustered index – pages (1:89) and (1:114) in my case. Dumping the contents using dump style 3 shows that both have uniquifiers – one with a NULL value (interpreted as zero) and the other with a value of 1.</p>
<figure class="highlight sql"><pre>DBCC TRACEON (3604)
DBCC PAGE (Y, 1, 89, 3)
DBCC PAGE (Y, 1, 114, 3)
</pre></figure>


<figure class="highlight sql"><pre>-- Page (1:89)

Slot 0 Column 0 Offset 0x0 Length 4 Length (physical) 0
UNIQUIFIER = 0                       

Slot 0 Column 1 Offset 0x4 Length 4 Length (physical) 4
ID = 1                               

Slot 0 Column 2 Offset 0x17 Length 4 Length (physical) 4
Name = Mark

&lt;snip&gt;     

-- Page (1:114)

Slot 0 Column 0 Offset 0x17 Length 4 Length (physical) 4
UNIQUIFIER = 1                       

Slot 0 Column 1 Offset 0x4 Length 4 Length (physical) 4
ID = 1                               

Slot 0 Column 2 Offset 0x1b Length 4 Length (physical) 4
Name = Mark                          

&lt;snip&gt;
</pre></figure>

<p>Notice how both are represented as slot 0 – this is because they stem from different pages, I’ve just cut out everything but the uniquifier column interpretation of the DBCC PAGE results. Also note how the first record doesn’t have any physical uniquifier value, while the second one uses 4 bytes. Finally make note that the uniquifier columns both reside at column ordinal 0.</p>
<h2 id="Comparing_the_uniquifiers_in_the_nonclustered_index">Comparing the uniquifiers in the nonclustered index</h2>
<p>Now we’ll run DBCC IND to find the single index page for the nonclustered index – page (1:93) in my case (the uniquifier will only be present in the leaf level index pages – which is all we’ve got in this case).</p>
<figure class="highlight sql"><pre>DBCC IND (Y, 'Test', 2)
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_82.png" class="fancy"><img src="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_82.png" style="max-height: 250px"/></a></div></div>

<p>Dumping the contents of an index page using style 3 works differently for index pages – it returns a table resultset. It does confirm the presence of the uniquifier as well as our clustered index key columns (ID, Name) though:</p>
<figure class="highlight sql"><pre>DBCC PAGE (Y, 1, 93, 1)
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_62.png" class="fancy"><img src="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_62.png" style="max-height: 250px"/></a></div></div>

<p>Dumping in style 1 reveals the byte contents of the two rows, which is exactly what we need to locate the uniquifier:</p>
<figure class="highlight sql"><pre>DBCC PAGE (Y, 1, 93, 1)
</pre></figure>


<figure class="highlight sql"><pre>Slot 0, Offset 0x60, Length 16, DumpStyle BYTE

Record Type = INDEX_RECORD           Record Attributes =  NULL_BITMAP VARIABLE_COLUMNS
Record Size = 16                     
Memory Dump @0x0000000009DEC060

0000000000000000:   36010000 00030000 01001000 4d61726b †6...........Mark 

Slot 1, Offset 0x70, Length 22, DumpStyle BYTE

Record Type = INDEX_RECORD           Record Attributes =  NULL_BITMAP VARIABLE_COLUMNS
Record Size = 22                     
Memory Dump @0x0000000009DEC070

0000000000000000:   36010000 00030000 02001200 16004d61 †6.............Ma 
0000000000000010:   726b0100 0000††††††††††††††††††††††††rk....
</pre></figure>

<p>Notice how the second record is 6 bytes larger than the first. This is caused by the presence of the uniquifier on the second record. Since the uniquifier is stored as a 4 byte integer in the variable length section, we also need 2 extra bytes for storing the length of the uniquifier in the variable length column offset array – thus causing a total overhead of 6. The primary difference however, lies in the fact that the uniquifier is stored as the last variable length column in the nonclustered index (the 0100 0000 part of the second record), while in the clustered index data page it was stored as the first variable length column. This discrepancy is what caused me headaches when trying to parse both page types – I needed a way of determining what column ordinal the uniquifiers had for both the clustered and the nonclustered index.</p>
<h2 id="Locating_the_uniquifier_in_a_clustered_index">Locating the uniquifier in a clustered index</h2>
<p>Thankfully there’s a plethora of DMVs to look in, it’s just a matter of finding the right ones. Let’s start out by querying sys.objects to get the object id of our table:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span>
	*
<span class="keyword">FROM</span>
	sys.objects
<span class="keyword">WHERE</span>
	Name = <span class="string">'Test'</span></span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_102.png" class="fancy"><img src="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_102.png" style="max-height: 250px"/></a></div></div>

<p>Armed with the object id, we can find the default partitions for our clustered and nonclustered indexes:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span>
	*
<span class="keyword">FROM</span>
	sys.partitions
<span class="keyword">WHERE</span>
	object_id = <span class="number">293576084</span></span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_122.png" class="fancy"><img src="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_122.png" style="max-height: 250px"/></a></div></div>

<p>Armed with the partition id, we can find the partition columns for our clustered index (index_id = 1):</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span>
	*
<span class="keyword">FROM</span>
	sys.system_internals_partition_columns
<span class="keyword">WHERE</span>
	partition_id = <span class="number">72057594040483840</span></span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_161.png" class="fancy"><img src="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_161.png" style="max-height: 250px"/></a></div></div>

<p>Now would you take a look at that marvelous is_uniquifier column (we’ll ignore the alternative spelling for now). Using this output we can see that the first row is the uniquifier – being the third part of our clustered key (key_ordinal = 3). The leaf_offset column specifies the physical order in the record, fixed length columns being positive and variable length columns being negative. This confirms what we saw earlier, that the uniquifier is the first variable length column stored, with the remaining columns coming in at leaf offset –2, –3, –4 and –5.</p>
<h2 id="Locating_the_uniquifier_in_a_nonclustered_index">Locating the uniquifier in a nonclustered index</h2>
<p>Well that was easy, let’s just repeat that using the partition id of our nonclustered index (index_id = 2):</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span>
	*
<span class="keyword">FROM</span>
	sys.system_internals_partition_columns
<span class="keyword">WHERE</span>
	partition_id = <span class="number">72057594040549376</span></span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_181.png" class="fancy"><img src="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_181.png" style="max-height: 250px"/></a></div></div>

<p>But what’s this, curses! For nonclustered indexes, the is_uniquifier column is not set, even though we can see there are three columns in our nonclustered index (the explicitly included ID, the implicitly included Name column that’s part of the clustered index key as well as the uniquifier which is also part of the clustered index key). So now we know that the uniquifier is shown in the result set, we just can’t trust the is_uniquifier column. However – to the best of my knowledge no other integer columns are stored as a variable length column, besides the uniquifier. Thus, we can add a predicate to the query returning just integers (system_type_id = 56) with negative leaf_offsets:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span>
	*
<span class="keyword">FROM</span>
	sys.system_internals_partition_columns
<span class="keyword">WHERE</span>
	partition_id = <span class="number">72057594040549376</span> <span class="keyword">AND</span>
	system_type_id = <span class="number">56</span> <span class="keyword">AND</span>
	leaf_offset &lt; <span class="number">0</span></span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_141.png" class="fancy"><img src="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_141.png" style="max-height: 250px"/></a></div></div>

<p>And that’s it, we now have the uniquifier column offset in the variable length part of our nonclustered index record!</p>
<h2 id="The_pessimistic_approach">The pessimistic approach</h2>
<p>As I can’t find any info guaranteeing that the uniquifier is the only integer stored in the variable length part of a record, I came up with a secondary way of finding the uniquifier column offset. This method is way more cumbersome though and I won’t go into complete details. We’ll start out by retrieving all columns in the nonclustered index that are not explicitly part of the nonclustered index itself (by removing all rows present in sys.index_columns for the index):</p>
<figure class="highlight sql"><pre>DECLARE @TableName sysname = 'Test'
DECLARE @NonclusteredIndexName sysname = 'IX_ID'

<span class="operator"><span class="keyword">SELECT</span>
	i.index_id,
	pc.*
<span class="keyword">FROM</span>
	sys.objects o
<span class="keyword">INNER</span> <span class="keyword">JOIN</span>
	sys.indexes i <span class="keyword">ON</span> i.object_id = o.object_id
<span class="keyword">INNER</span> <span class="keyword">JOIN</span>
	sys.partitions p <span class="keyword">ON</span> p.object_id = o.object_id <span class="keyword">AND</span> p.index_id = i.index_id
<span class="keyword">INNER</span> <span class="keyword">JOIN</span>
	sys.system_internals_partition_columns pc <span class="keyword">on</span> pc.partition_id = p.partition_id
<span class="keyword">WHERE</span>
	o.name = @TableName <span class="keyword">AND</span>
	i.name = @NonclusteredIndexName <span class="keyword">AND</span>
	<span class="keyword">NOT</span> <span class="keyword">EXISTS</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sys.index_columns <span class="keyword">WHERE</span> object_id = o.object_id <span class="keyword">AND</span> index_id = i.index_id <span class="keyword">AND</span> key_ordinal = pc.key_ordinal)</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_201.png" class="fancy"><img src="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_201.png" style="max-height: 250px"/></a></div></div>

<p>These are the remaining columns that are stored as the physical part of the index record. Given that they’re not part of the index definition itself, these are the columns that make up the remainder of the clustered key – the <em>Name</em> and <em>Unuiquifier</em> columns in this example.</p>
<p>Now we can perform the same query for the clustered index, though this time only filtering away those that are not part of the key itself (that is, key_ordinal &gt; 0):</p>
<figure class="highlight sql"><pre>DECLARE @TableName sysname = 'Test'
DECLARE @NonclusteredIndexName sysname = 'CX_ID_Name'

<span class="operator"><span class="keyword">SELECT</span>
	i.index_id,
	pc.*
<span class="keyword">FROM</span>
	sys.objects o
<span class="keyword">INNER</span> <span class="keyword">JOIN</span>
	sys.indexes i <span class="keyword">ON</span> i.object_id = o.object_id
<span class="keyword">INNER</span> <span class="keyword">JOIN</span>
	sys.partitions p <span class="keyword">ON</span> p.object_id = o.object_id <span class="keyword">AND</span> p.index_id = i.index_id
<span class="keyword">INNER</span> <span class="keyword">JOIN</span>
	sys.system_internals_partition_columns pc <span class="keyword">on</span> pc.partition_id = p.partition_id
<span class="keyword">WHERE</span>
	o.name = @TableName <span class="keyword">AND</span>
	i.name = @NonclusteredIndexName <span class="keyword">AND</span>
	key_ordinal &gt; <span class="number">0</span>
<span class="keyword">ORDER</span> <span class="keyword">BY</span>
	key_ordinal</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_221.png" class="fancy"><img src="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_221.png" style="max-height: 250px"/></a></div></div>

<p>At this point we can compare these two result sets from the highest key_ordinal and downwards. Basically we just need to find the first match between the uniquifier column in the clustered index output and the assumed uniquifier column in the nonclustered index output. Until my assumption of the uniquifier being the only variable length integer, I wouldn’t recommend using this method though.</p>
<h2 id="The_hardcore_approach_–_using_base_tables">The hardcore approach – using base tables</h2>
<p>All those DMV’s certainly are nifty, but I just can’t help but feel I’m cheating. Let’s try and redo the optimistic (uniquifier being the only variable length integer) approach without using DMVs. Start out by connecting to your database using the <a href="http://msdn.microsoft.com/en-us/library/ms178068.aspx" target="_blank">dedicated administrator connection</a>, this will allow you to query the base tables:</p>
<div class="imgwrapper" style=""><div><a href="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_241.png" class="fancy"><img src="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_241.png" style="max-height: 250px"/></a></div></div>

<p>We’ll start out by querying sys.sysschobjs, which is basically the underlying table for sys.objects:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span>
	*
<span class="keyword">FROM</span>
	sys.sysschobjs
<span class="keyword">WHERE</span>
	name = <span class="string">'Test'</span></span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_26.png" class="fancy"><img src="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_26.png" style="max-height: 250px"/></a></div></div>

<p>Now we’ll query sys.sysrowsets, which is basically the underlying table for sys.partitions. In the base tables, idmajor is the column name we commonly know as object_id and idminor is what we’d usually know as index_id:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span>
	*
<span class="keyword">FROM</span>
	sys.sysrowsets
<span class="keyword">WHERE</span>
	idmajor = <span class="number">293576084</span></span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_281.png" class="fancy"><img src="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_281.png" style="max-height: 250px"/></a></div></div>

<p>Checking out the row with idminor = 2, we’ve now got the rowsetid (partition id) of our nonclustered index. Now we just need to find the columns for the index – and that’s just what sys.sysrscols is for, the base table behind sys.system_internals_partition_columns:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span>
	*,
	<span class="keyword">CAST</span>(<span class="keyword">CAST</span>(offset & <span class="number">0xFFFF</span> <span class="keyword">AS</span> binary(<span class="number">2</span>)) <span class="keyword">AS</span> <span class="keyword">smallint</span>) <span class="keyword">AS</span> leaf_offset
<span class="keyword">FROM</span>
	sys.sysrscols
<span class="keyword">WHERE</span>
	rsid = <span class="number">72057594040549376</span></span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_30.png" class="fancy"><img src="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_30.png" style="max-height: 250px"/></a></div></div>

<p>Note that the leaf_offset column isn’t persisted as an easily read value – it’s actually stored as an integer in the offset column. The offset column stores not only the value for the leaf_offset column but also for the internal_offset column – we just have to do some masking and conversion to get it out.</p>
<p>The following query helps to show exactly what we’re doing to extract the leaf_offset value from the offset column value:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span>
	offset,
	<span class="keyword">CAST</span>(<span class="keyword">CAST</span>(offset & <span class="number">0xFFFF</span> <span class="keyword">AS</span> binary(<span class="number">2</span>)) <span class="keyword">AS</span> <span class="keyword">smallint</span>) <span class="keyword">AS</span> leaf_offset,
	<span class="keyword">CAST</span>(offset <span class="keyword">AS</span> binary(<span class="number">4</span>)) <span class="keyword">AS</span> HexValue,
	<span class="keyword">CAST</span>(offset & <span class="number">0xFFFF</span> <span class="keyword">AS</span> binary(<span class="number">4</span>)) <span class="keyword">AS</span> MaskedHexValue,
	<span class="keyword">CAST</span>(offset & <span class="number">0xFFFF</span> <span class="keyword">AS</span> binary(<span class="number">2</span>)) <span class="keyword">AS</span> ShortenedMaskedHexValue
<span class="keyword">FROM</span>
	sys.sysrscols
<span class="keyword">WHERE</span>
	rsid = <span class="number">72057594040549376</span></span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_36.png" class="fancy"><img src="/determining-the-uniquifier-column-ordinal-for-clustered-and-nonclustered-indexes/image_36.png" style="max-height: 250px"/></a></div></div>

<p>The HexValue shows the offset column value represented in hex – no magic yet. After applying the 0xFFFF bitmask (0b1111111111111111 in binary), only the first 16 bits / 2 (starting from the right since we’re little endian) bytes will keep their value. Converting to binary(2) simply discards the last two bytes (the 0x0000 part).</p>
<p>0x0001 is easily converted to the decimal value 1. 0xFFFF and 0xFFFE correspond to the decimal values 65.535 and 65.534 respectively. The way storing smallints work, 0 is stored as 0x0, 32.767 is stored as 0x7FFF and from there on the decimal value rolls over into –32.768 with a hex value of 0x8000 – continuing all the way up the –1 = 0xFFFF. And that’s why we can convert the binary(2) representations of the offset columns into the –1 and –2 decimal values.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jun</span>
			<span class="day">30</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/presenting-a-precon-at-sqlbits/" title="Presenting a Precon at SQLBits" rel="bookmark">Presenting a Precon at SQLBits</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I’m honored to announce that I’ll be presenting my <em><a href="http://sqlbits.com/information/Event9/SQL_Server_Storage_Engine_and_MDF_File_Internals/TrainingDetails.aspx" target="_blank">SQL Server Storage Engine and MDF File Internals</a></em> precon at <a href="http://sqlbits.com/" target="_blank">SQLBits</a> on September 29th. It’s an amazing bunch of <a href="http://sqlbits.com/information/TrainingDay.aspx" target="_blank">precon sessions and presenters</a>, I didn’t think I’d be speaking at SQLBits, much less presenting a precon – given the lineup of speakers.</p>
<a id="more"></a>

<div class="imgwrapper" style=""><div><a href="/presenting-a-precon-at-sqlbits/ImGoingToSqlBits200.png" class="fancy"><img src="/presenting-a-precon-at-sqlbits/ImGoingToSqlBits200.png" style="max-height: 250px"/></a></div></div>

<h2 id="So_what_will_I_be_presenting?">So what will I be presenting?</h2>
<p>Let me start out with the official abstract:</p>
<blockquote>
<p>Join me for a journey into the depths of the SQL Server storage engine. Through a series of lectures and demonstrations we’ll look at the internals of pages, data types, indexes, heaps, extent &amp; page allocation, allocation units, system views, base tables and nightmarish ways of data recovery. We’ll look at several storage structures that are either completely undocumented or very scarcely so.  By the end of the day, not only will you know about the most important data structures in SQL Server, you’ll also be able to parse every bit of a SQL Server data file yourself, using just a hex editor! There will be lots of hands on demos, a few of them performed in C# to demonstrate the parsing of data files outside of SQL Server.</p>
</blockquote>
<p>It all stems from some experimental coding I did back in March, trying to parse SQL Server data pages using C#. What started out as a learning experiment resulted in me presenting on the <em><a href="http://mow2011.dk/speakers/mark-s-rasmussen.aspx" target="_blank">Anatomy of an MDF File</a></em> at the <a href="http://mow2011.dk/mow2011.aspx" target="_blank">Miracle Open World 2011</a> conference in April. Since then I’ve continued my experiment and officially christened it <a href="https://github.com/improvedk/OrcaMDF" target="_blank">OrcaMDF</a> while opening up the source.</p>
<p>During my research for OrcaMDF I’ve reverse engineered data structures, matched up various undocumented base tables and generally achieved a really great understanding of the storage engine and MDF file format. It’s my goal that attendees of my session will have a complete (well, almost) understanding of the on disk structures we’ll see in typical databases. Not just by looking at them through DBCC PAGE, but by taking it a couple of steps further by attempting to parse the contents by hand. You’ll get an understanding of the importance of the sys.sysallocunits base table and how that fuels all metadata in SQL Server.</p>
<p>For the full agenda, please check the official <a href="http://sqlbits.com/information/Event9/SQL_Server_Storage_Engine_and_MDF_File_Internals/TrainingDetails.aspx" target="_blank">precon description</a>. If you have any questions about the content that you’d like to clear up before signing up for either mine or one of the other precons available, I encourage you to leave a comment here or grab a hold of <a href="http://twitter.com/#!/improvedk" target="_blank">me on Twitter</a>.</p>
<h2 id="Prerequisites">Prerequisites</h2>
<p>While I will give brief introductions to the main concepts, I will assume a solid knowledge of what SQL Server does. I won’t spend a long time explaining why you should use clustered tables over heaps, instead I’ll give you the toolset to hopefully make that decision yourself. I’m not exaggerating when I classified the precon as level 500 – there will be 300 content too but we’ll be peaking at 500 several times during the day. We will be looking at hex codes, converting between decimal, hex and binary as needed – so make sure you don’t throw up when you see binary numbers :)</p>
<h2 id="Registration">Registration</h2>
<p>Registration hasn’t opened yet, but <a href="http://www.sqlbits.com/information/Pricing.aspx" target="_blank">sign up and you’ll be notified</a> as soon as it opens. A three day conference, including a precon day for just £375 really is a steal so make sure to get the early bind discount! I still can’t fathom that Saturday is free, as in £0, no charge – that’s too good an offer to pass up!</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jun</span>
			<span class="day">21</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/copying-a-sql-server-database-file-thatrsquos-in-use-using/" title="Copying a SQL Server Database File That&#39;s in Use Using Volume Shadow Copy" rel="bookmark">Copying a SQL Server Database File That&#39;s in Use Using Volume Shadow Copy</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>When working on <a href="https://github.com/improvedk/OrcaMDF" target="_blank">OrcaMDF</a> I usually setup a test database, force a checkpoint and then perform my tests on the MDF file. Problem is, you can’t open the MDF file for reading, nor copy it, as long as the database is online in SQL Server. I could shut down SQL Server temporarily while copying the file, but that quickly becomes quite a hassle.</p>
<a id="more"></a>

<h2 id="Leveraging_Volume_Shadow_Copy_(VSS)_through_AlphaVSS">Leveraging Volume Shadow Copy (VSS) through AlphaVSS</h2>
<p><a href="http://www.alphaleonis.com/2008/08/alphavss-bringing-windows-shadow-copy-service-vss-to-net/" target="_blank">AlphaVSS</a> is an excellent library for invoking VSS through .NET. While it can do much more, I’m using it to create a snapshot of a single active file, copy it and then dispose of the snapshot afterwards.</p>
<p>The following class presents a single static method that’ll copy any file (locked or not) and copy it to the desired destination. It would be easy to adapt upon this sample to copy multiple files, directories, etc. Note that while a copy file progress clalback is supported, I don’t really care about the progress and am there sending a null reference when calling <a href="http://msdn.microsoft.com/en-us/library/aa363852(v=vs.85" target="_blank">CopyFileEx</a>.aspx).</p>
<figure class="highlight cs"><pre>class VssHelper
{
	[DllImport(<span class="string">"kernel32.dll"</span>, SetLastError = <span class="keyword">true</span>, CharSet = CharSet.Auto)]
	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">bool</span> <span class="title">CopyFileEx</span>(<span class="keyword">string</span> lpExistingFileName, <span class="keyword">string</span> lpNewFileName, CopyProgressRoutine lpProgressRoutine, <span class="keyword">int</span> lpData, <span class="keyword">ref</span> <span class="keyword">int</span> pbCancel, <span class="keyword">uint</span> dwCopyFlags);
	<span class="keyword">private</span> <span class="keyword">delegate</span> <span class="keyword">uint</span> <span class="title">CopyProgressRoutine</span>(<span class="keyword">long</span> TotalFileSize, <span class="keyword">long</span> TotalBytesTransferred, <span class="keyword">long</span> StreamSize, <span class="keyword">long</span> StreamBytesTransferred, <span class="keyword">uint</span> dwStreamNumber, <span class="keyword">uint</span> dwCallbackReason, IntPtr hSourceFile, IntPtr hDestinationFile, IntPtr lpData);

	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CopyFile</span>(<span class="keyword">string</span> source, <span class="keyword">string</span> destination)
	{
		<span class="keyword">var</span> oVSSImpl = VssUtils.LoadImplementation();

		<span class="keyword">using</span> (<span class="keyword">var</span> vss = oVSSImpl.CreateVssBackupComponents())
		{
			vss.InitializeForBackup(<span class="keyword">null</span>);

			vss.SetBackupState(<span class="keyword">false</span>, <span class="keyword">true</span>, VssBackupType.Full, <span class="keyword">false</span>);

			<span class="keyword">using</span> (<span class="keyword">var</span> <span class="keyword">async</span> = vss.GatherWriterMetadata())
				<span class="keyword">async</span>.Wait();

			vss.StartSnapshotSet();
			<span class="keyword">string</span> volume = <span class="keyword">new</span> FileInfo(source).Directory.Root.Name;
			<span class="keyword">var</span> snapshot = vss.AddToSnapshotSet(volume, Guid.Empty);

			<span class="keyword">using</span> (<span class="keyword">var</span> <span class="keyword">async</span> = vss.PrepareForBackup())
				<span class="keyword">async</span>.Wait();

			<span class="keyword">using</span> (<span class="keyword">var</span> <span class="keyword">async</span> = vss.DoSnapshotSet())
				<span class="keyword">async</span>.Wait();

			<span class="keyword">var</span> props = vss.GetSnapshotProperties(snapshot);
			<span class="keyword">string</span> vssFile = source.Replace(volume, props.SnapshotDeviceObject + <span class="string">@""</span>);

			<span class="keyword">int</span> cancel = <span class="number">0</span>;
			CopyFileEx(vssFile, destination, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">ref</span> cancel, <span class="number">0</span>);
		}
	}
}
</pre></figure>



				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jun</span>
			<span class="day">16</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/getting-bit-by-datetime-rounding-or-why-235959-999-ltgt/" title="Getting Bit by Datetime Rounding or Why 23:59:59.999 &lt; &#39;23:59:59.999&#39;" rel="bookmark">Getting Bit by Datetime Rounding or Why 23:59:59.999 &lt; &#39;23:59:59.999&#39;</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - Internals/">SQL Server - Internals</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Earlier today I was doing some ad-hoc querying to retrieve some numbers for the month of May. Not giving it deeper thought, I made a simple query like this:</p>
<a id="more"></a>


<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span>
	<span class="aggregate">SUM</span>(SomeColumn)
<span class="keyword">FROM</span>
	SomeTable
<span class="keyword">WHERE</span>
	SomeDatetime BETWEEN <span class="string">'2011-05-01'</span> <span class="keyword">AND</span> <span class="string">'2011-05-31 23:59:59.999'</span></span>
</pre></figure>

<p>Much to my surprise, the last rows looked like this:</p>
<div class="imgwrapper" style=""><div><a href="/getting-bit-by-datetime-rounding-or-why-235959-999-ltgt/image_2.png" class="fancy"><img src="/getting-bit-by-datetime-rounding-or-why-235959-999-ltgt/image_2.png" style="max-height: 250px"/></a></div></div>

<p>Why in the world are results from June included when I had an explicit predicate limiting the results to May? The answer can be found in one of my <a href="/parsing-dates-in-orcamdf">earlier posts on parsing dates</a>. As SQL Server stores the millisecond part of a datetime with a precision of 1/300th of a second, with .997 being the highest possible stored value. .998 will be rounded down to .997 while .999 will be rounded up – causing a rollover of the day part.</p>
<p>Let’s setup a simple sample data set:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> DateTest
(
	ID <span class="keyword">int</span>,
	Created datetime
)

<span class="keyword">INSERT</span> <span class="keyword">INTO</span>
	DateTest (ID, Created)
<span class="keyword">VALUES</span> 
	(<span class="number">1</span>, <span class="string">'2011-05-31 23:59:59.996'</span>),
	(<span class="number">2</span>, <span class="string">'2011-05-31 23:59:59.997'</span>),
	(<span class="number">3</span>, <span class="string">'2011-05-31 23:59:59.998'</span>),
	(<span class="number">4</span>, <span class="string">'2011-05-31 23:59:59.999'</span>)</span>
</pre></figure>

<p>Performing my simple query reveals the same problem as earlier today:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span>
	*
<span class="keyword">FROM</span>
	DateTest
<span class="keyword">WHERE</span>
	Created BETWEEN <span class="string">'2011-05-01'</span> <span class="keyword">AND</span> <span class="string">'2011-05-31 23:59:59.999'</span></span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/getting-bit-by-datetime-rounding-or-why-235959-999-ltgt/image_4.png" class="fancy"><img src="/getting-bit-by-datetime-rounding-or-why-235959-999-ltgt/image_4.png" style="max-height: 250px"/></a></div></div>

<p>Row number 4 is inserted with a date of 2011-06-01 00:00:00.000 since the .999 millisecond part causes a day rollover. Equally, the .999 value causes the last predicate part to be interpreted as 2011-06-01 00:00:00.000 during the CONVERT_IMPLICIT conversion.</p>
<p>A simple rewrite of the query guarantees to return just the results we want:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span>
	*
<span class="keyword">FROM</span>
	DateTest
<span class="keyword">WHERE</span>
	Created &gt;= <span class="string">'2011-05-01'</span> <span class="keyword">AND</span> Created &lt; <span class="string">'2011-06-01'</span></span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/getting-bit-by-datetime-rounding-or-why-235959-999-ltgt/image_10.png" class="fancy"><img src="/getting-bit-by-datetime-rounding-or-why-235959-999-ltgt/image_10.png" style="max-height: 250px"/></a></div></div>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jun</span>
			<span class="day">14</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/avoiding-regressions-in-orcamdf-by-system-testing/" title="Avoiding Regressions in OrcaMDF by System Testing" rel="bookmark">Avoiding Regressions in OrcaMDF by System Testing</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				, 
			
				<a href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a>
				, 
			
				<a href="/category/Testing/">Testing</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>As I continue to add new features &amp; support for new data structures in <a href="/introducing-orcamdf">OrcaMDF</a>, the risk of <a href="http://en.wikipedia.org/wiki/Software_regression" target="_blank">regressions</a> increase. Especially so as I’m developing in a largely unknown field, given that I can’t plan for structures and relations that I do not yet know about. To reduce the risk of regressions, testing is an obvious need.</p>
<a id="more"></a>

<h2 id="Unit_testing">Unit testing</h2>
<p><a href="http://en.wikipedia.org/wiki/Unit_testing" target="_blank">Unit testing</a> is the process of testing the smallest parts of the code, which would be functions in object oriented programming. A sample test for the <a href="https://github.com/improvedk/OrcaMDF/blob/694dd0cff213dc48b5153b040a41fdc707914680/src/OrcaMDF.Core/Engine/SqlTypes/SqlBigInt.cs" target="_blank">SqlBigInt</a> data type parsing class could look like this:</p>
<figure class="highlight cs"><pre><span class="keyword">using</span> System;
<span class="keyword">using</span> NUnit.Framework;
<span class="keyword">using</span> OrcaMDF.Core.Engine.SqlTypes;

namespace OrcaMDF.Core.Tests.Engine.SqlTypes
{
	[TestFixture]
	<span class="keyword">public</span> <span class="keyword">class</span> SqlBigIntTests
	{
		[Test]
		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetValue</span>()
		{
			<span class="keyword">var</span> type = <span class="keyword">new</span> SqlBigInt();
			<span class="keyword">byte</span>[] input;

			input = <span class="keyword">new</span> <span class="keyword">byte</span>[] { <span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0x7F</span> };
			Assert.AreEqual(<span class="number">9223372036854775807</span>, Convert.ToInt64(type.GetValue(input)));

			input = <span class="keyword">new</span> <span class="keyword">byte</span>[] { <span class="number">0x82</span>, <span class="number">0x5A</span>, <span class="number">0x03</span>, <span class="number">0x1B</span>, <span class="number">0xD5</span>, <span class="number">0x3E</span>, <span class="number">0xCD</span>, <span class="number">0x71</span> };
			Assert.AreEqual(<span class="number">8200279581513702018</span>, Convert.ToInt64(type.GetValue(input)));

			input = <span class="keyword">new</span> <span class="keyword">byte</span>[] { <span class="number">0x7F</span>, <span class="number">0xA5</span>, <span class="number">0xFC</span>, <span class="number">0xE4</span>, <span class="number">0x2A</span>, <span class="number">0xC1</span>, <span class="number">0x32</span>, <span class="number">0x8E</span> };
			Assert.AreEqual(-<span class="number">8200279581513702017</span>, Convert.ToInt64(type.GetValue(input)));
		}

		[Test]
		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Length</span>()
		{
			<span class="keyword">var</span> type = <span class="keyword">new</span> SqlBigInt();

			Assert.Throws&lt;ArgumentException&gt;(() =&gt; type.GetValue(<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">9</span>]));
			Assert.Throws&lt;ArgumentException&gt;(() =&gt; type.GetValue(<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">7</span>]));
		}
	}
}
</pre></figure>

<p>This tests the main entrypoints for the SqlBigInt class, testing for over/underflow of the long bigint data type, as well as checking the length. This works great for simple classes like SqlBigInt. Unit testing more complex interrelated classes requires infrastructure support for mocking out called methods, related classes, etc. While this is a working strategy, it arguably requires some effort, especially at the early stage of a project where the architecture is dynamic.</p>
<h2 id="System_testing">System testing</h2>
<p>On the other end of the spectrum, we have <a href="http://en.wikipedia.org/wiki/System_testing" target="_blank">system testing</a>. System testing seeks to test the system as a whole, largely ignoring the inner workings of either system, which merits a categorization as <a href="http://en.wikipedia.org/wiki/Black_box_testing" target="_blank">black-box testing</a>. In the case of OrcaMDF I’ve estimated that I can catch 90% of all regressions using just 10% of the time, compared to unit testing which would have the reverse properties. As such, it’s a great way to test during development, while allowing for the introduction of key unit &amp; integration tests as necessary.</p>
<p>Say I wanted to test the parsing of user table names in the <a href="https://github.com/improvedk/OrcaMDF/blob/694dd0cff213dc48b5153b040a41fdc707914680/src/OrcaMDF.Core/MetaData/DatabaseMetaData.cs" target="_blank">DatabaseMetaData</a> class, I could mock the values of the SysObjects list, while also mocking <a href="https://github.com/improvedk/OrcaMDF/blob/694dd0cff213dc48b5153b040a41fdc707914680/src/OrcaMDF.Core/Engine/MdfFile.cs" target="_blank">MdfFile</a> as that’s a require parameter for the constructor. To do that, I’d have to extract MdfFile into an interface and use a mocking framework on top of that.</p>
<p>Taking the system testing approach, I’m instead performing the following workflow:</p>
<ul>
<li>Connect to a running SQL Server.</li>
<li>Create test schema in the fixture setup.</li>
<li>Detach the database.</li>
<li>Run OrcaMDF on the detached .mdf file and validate the results.</li>
</ul>
<p>A sample test, creating two user tables and validating the output from the DatabaseMetaData, looks like this:</p>
<figure class="highlight cs"><pre><span class="keyword">using</span> System.Data.SqlClient;
<span class="keyword">using</span> NUnit.Framework;
<span class="keyword">using</span> OrcaMDF.Core.Engine;

namespace OrcaMDF.Core.Tests.Integration
{
	<span class="keyword">public</span> <span class="keyword">class</span> ParseUserTableNames : SqlServerSystemTest
	{
		[Test]
		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ParseTableNames</span>()
		{
			<span class="keyword">using</span>(<span class="keyword">var</span> mdf = <span class="keyword">new</span> MdfFile(MdfPath))
			{
				<span class="keyword">var</span> metaData = mdf.GetMetaData();

				Assert.AreEqual(<span class="number">2</span>, metaData.UserTableNames.Length);
				Assert.AreEqual(<span class="string">"MyTable"</span>, metaData.UserTableNames[<span class="number">0</span>]);
				Assert.AreEqual(<span class="string">"XYZ"</span>, metaData.UserTableNames[<span class="number">1</span>]);
			}
		}

		<span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">RunSetupQueries</span>(SqlConnection conn)
		{
			<span class="keyword">var</span> cmd = <span class="keyword">new</span> SqlCommand(<span class="string">@"
				CREATE TABLE MyTable (ID int);
				CREATE TABLE XYZ (ID int);"</span>, conn);
			cmd.ExecuteNonQuery();
		}
	}
}
</pre></figure>

<p>This allows for extremely quick testing of actual real life scenarios. Want to test the parsing of forwarded records? Simply create a new test, write the T-SQL code to generate the desired database state and then validate the scanned table data.</p>
<h2 id="The_downside_to_system_testing">The downside to system testing</h2>
<p>Unfortunately system testing is no panacea; it has its downsides. The most obvious one is performance. A unit test is usually required to run extremely fast, allowing you to basically run them in the background on each file save. Each of these system tests takes about half a second to run, being CPU bound. Fortunately, they can be run in parallel without problems. On a quad core machine that’ll allow me to run 480 tests per minute. This’ll allow a manageable test time for a complete test set, while still keeping a subset test very quick. Usually a code change won’t impact more than handful of tests.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jun</span>
			<span class="day">09</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/anatomy-of-a-forwarded-record-ndash-the-back-pointer/" title="Anatomy of a Forwarded Record &amp; the Back Pointer" rel="bookmark">Anatomy of a Forwarded Record &amp; the Back Pointer</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - Internals/">SQL Server - Internals</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Earlier this week I provided some details on the <a href="/anatomy-of-a-forwarded-record-ndash-the-forwarding-stub">forwarding stub that’s left behind</a> when a heap record is forwarded. In this post I’ll look at the second part of a forwarded record – the actual record to which the forwarding stub points.</p>
<a id="more"></a>

<h2 id="What’s_in_a_forwarded_record?">What’s in a forwarded record?</h2>
<p>A forwarded record is just like a normal record, only with a couple of minor differences.</p>
<p>For one, the record type (read from bits 1-3 of the first record status byte, see <a href="/anatomy-of-a-forwarded-record-ndash-the-forwarding-stub">the earlier post</a><br>for details) is changed to BlobFragment, decimal value 4. This is important to note when scanning data – as all blob fragment records should be ignored. Instead, blob fragments will automatically be read whenever we scan the forwarding stub which points to the blob fragment. Scanning both directly would result in the records being read twice.</p>
<p>The second part being that there’s an extra variable length column stored in the record. This last variable length column is not part of the table schema, it’s actually a special pointer called the back pointer. The back pointer points back to the <font color="#444444">forwarding stub that points to this record. This makes it easy to find the original record location, given the blob fragment location. When a blob fragment shrinks in size, we can easily check whether it might fit on the original page again. It’s also used if the blob fragment size increases and we therefore might need to allocate it on a new page. In that case, we’ll have to go back to the</font>forwarding stub and change it so it points to the new location.</p>
<p>The naïve implementation would be to just replace the blob fragment with another forwarding stub, thus creating a chain of forwarding stubs, eventually pointing to the forwarded record itself. However, this is not the case - SQL Server will never chain forwarding stubs.</p>
<h2 id="Parsing_the_forwarded_record">Parsing the forwarded record</h2>
<p>To check out the back pointer storage format, I’ve reused the table sample from the <a href="/anatomy-of-a-forwarded-record-ndash-the-forwarding-stub">last post</a>. Thus we’ve got a forwarding stub on page (1:114) pointing to the forwarded record on page (1:118). Let’s try and parse the forwarded record at (1:118:0):  </p>
<p><strong><font color="#ff0000">3200</font><font color="#0000ff">0800</font><font color="#9b00d3">02000000</font><font color="#008000">0200</font></strong><font color="#a5a5a5"><strong>0002 009913a3 93 <snip 5.000 x 0x62> 00047200 00000100 0100</strong></font></p>
<ul>
<li><font face="Lucida Sans Unicode"><font color="#ff0000"><strong>3200  </strong></font>The first two bytes are the two status bytes, indicating that this is a blob fragment record, it’s got a null bitmap and it’s got variable length columns.</font></li>
<li><font face="Lucida Sans Unicode"><font color="#0000ff"><strong>0800  </strong></font><font color="#000000">The next two bytes indicates the total length of the fixed length portion of this record.</font></font></li>
<li><font face="Lucida Sans Unicode"><font color="#9b00d3"><strong>02000000  </strong></font><font color="#000000">Next up is the first and only fixed length column, an integer field with a decimal value of 2.</font></font></li>
<li><font face="Lucida Sans Unicode"><font color="#804000"><font color="#008000"><strong>0200  </strong></font></font><font color="#000000">Indicates the total number of columns in this record – decimal value 2.</font></font>

</li>
</ul>
<p><strong><font color="#a5a5a5">32000800 02000000 0200</font><font color="#ff0000">00</font><font color="#0000ff">02 00</font><font color="#9b00d3">9913a3</font><font color="#9b00d3">93</font><font color="#008000"><snip 5.000 x 0x62></font></strong><font color="#a5a5a5"><strong>00047200 00000100 0100</strong></font></p>
<ul>
<li><font face="Lucida Sans Unicode"><font color="#ff0000"><strong>00  </strong></font><font color="#000000">The next byte is the null bitmap. As there are no nullable columns in this table, no columns have a null bit set, thus the value of 0.</font>    </font></li>
<li><font face="Lucida Sans Unicode"><font color="#0000ff"><strong>0200  </strong></font><font color="#000000">The next two bytes specify the number of variable length columns contained in the record. Hold up - this doesn’t add up! The total number of columns was two, and we’ve got a single fixed length column. So how can there be two variable length columns, adding up to a total of three columns? This extra variable length column is the special back pointer field, as we’ll look at in just a bit.</font>    </font></li>
<li><font face="Lucida Sans Unicode"><font color="#9b00d3"><strong>9913a393  </strong></font><font color="#000000">The next four bytes, in pairs of two, is the variable length column offset array. They hold the offsets (and thus the length) of each variable length field. The first offset is 0x1399 = 5.017. The second offset is a bit more tricky. 0x93a3 has a decimal value of 37.795, clearly above the valid threshold. If we convert that value to binary, we get a value of 0b1001001110100011. No variable column length offset will ever need the high order bit and it’s thus used as an indicator for a pointer column – just like it’s used to indicate a row-overflow pointer. If we flip the high order bit, we get a value of 0b0001001110100011 = 5.027. Subtracting 5.017 from 5.027 gives us a column size of 10 bytes – the size of the back pointer.</font>    </font></li>
<li><font face="Lucida Sans Unicode"><font color="#008000"><strong>5.000 x 0x62  </strong></font><font color="#000000">I’ve snipped the next 5.000 bytes as those are just 5.000 ‘b’s repeated – the data in the Data column.</font></font>


</li>
</ul>
<h2 id="The_back_pointer_format">The back pointer format</h2>
<p>The remaining 10 bytes make up the back pointer:</p>
<p><strong><font color="#a5a5a5">32000800 02000000 02000002 009913a3 93 <snip 5.000 x 0x62><font color="#ff0000">0004</font> <font color="#0000ff">72000000</font> <font color="#9b00d3">0100</font> <font color="#008000">0100</font></font></strong></p>
<ul>
<li><font color="#000000"><font face="Lucida Sans Unicode"><font color="#ff0000"><strong>0004  </strong></font>The first two bytes indicates the special column ID with a decimal value of 1.024, indicating that it’s a back pointer.    </font></font></li>
<li><font color="#000000"><font face="Lucida Sans Unicode"><font color="#0000ff"><strong>72000000  </strong></font>Is the beginning of the back pointer page location. 0x72 = 114 in decimal, which is the page ID of the referencing forwarding stub.    </font></font></li>
<li><font color="#000000"><font face="Lucida Sans Unicode"><font color="#9b00d3"><strong>0100  </strong></font>Indicates the file ID with a decimal value of 1.    </font></font></li>
<li><font color="#000000"><font face="Lucida Sans Unicode"><font color="#008000"><strong>0100  </strong></font>Finally the last two bytes indicates the slot number with a decimal value of 1.</font></font>

</li>
</ul>
<font color="#000000">And so, with the above, we’ve now parsed the complete forwarded record. We can conclude that the back pointer takes up a total of 10 bytes, in this case pointing to the slot (<font color="#9b00d3"><strong>1</strong></font>:<font color="#0000ff"><strong>114</strong></font>:<font color="#008000"><strong>1</strong></font>)</font>

				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jun</span>
			<span class="day">07</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/anatomy-of-a-forwarded-record-ndash-the-forwarding-stub/" title="Anatomy of a Forwarded Record &amp; the Forwarding Stub" rel="bookmark">Anatomy of a Forwarded Record &amp; the Forwarding Stub</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - Internals/">SQL Server - Internals</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>A forwarded record occurs whenever a record in a <a href="http://msdn.microsoft.com/en-us/library/ms188270.aspx" target="_blank">heap</a> increases in size and it no longer fits on the page. Instead of causing a page split, as would happen had the table not been a heap, the record is moved onto another with enough free space, or onto a newly allocated page. Forwarded records can wreak havoc to your performance due to fragmentation, but I’ll leave not cover that here as many other more skilled people <a href="http://sqlblog.com/blogs/kalen_delaney/archive/2009/11/11/fragmentation-and-forwarded-records-in-a-heap.aspx" target="_blank">have</a> <a href="http://blogs.msdn.com/b/mssqlisv/archive/2006/12/01/knowing-about-forwarded-records-can-help-diagnose-hard-to-find-performance-issues.aspx" target="_blank">already</a> <a href="http://www.sqlskills.com/BLOGS/PAUL/post/Forwarding-and-forwarded-records-and-the-back-pointer-size.aspx" target="_blank">done</a> <a href="http://blogs.msdn.com/b/sqlserverstorageengine/archive/2006/09/19/761437.aspx" target="_blank">so</a>.</p>
<a id="more"></a>

<h2 id="Test_setup">Test setup</h2>
<p>As a test table we’ll use a simple table with three wide records, taking up almost a full page of data.</p>
<figure class="highlight sql"><pre><span class="comment">-- Create test table</span>
<span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ForwardedRecordTest
(
	ID <span class="keyword">int</span> <span class="keyword">identity</span>,
	Data <span class="keyword">varchar</span>(<span class="number">8000</span>)
)

-- <span class="keyword">Insert</span> dummy data
<span class="keyword">INSERT</span> <span class="keyword">INTO</span>
	ForwardedRecordTest (Data)
<span class="keyword">VALUES</span> 
	(REPLICATE(<span class="string">'a'</span>, <span class="number">2000</span>)),
	(REPLICATE(<span class="string">'b'</span>, <span class="number">2000</span>)),
	(REPLICATE(<span class="string">'c'</span>, <span class="number">2000</span>))</span>
</pre></figure>

<p>Firing up DBCC IND shows us a single IAM page tracking a single data page:</p>
<figure class="highlight sql"><pre>DBCC IND (Test, ForwardedRecordTest, -1)
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/anatomy-of-a-forwarded-record-ndash-the-forwarding-stub/image_21.png" class="fancy"><img src="/anatomy-of-a-forwarded-record-ndash-the-forwarding-stub/image_21.png" style="max-height: 250px"/></a></div></div>

<p>Now, to force a forwarded record, we’ll update one of the columns so it’ll no longer fit on the page with the other records:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">UPDATE</span>
	ForwardedRecordTest
<span class="keyword">SET</span>
	Data = REPLICATE(<span class="string">'b'</span>, <span class="number">5000</span>)
<span class="keyword">WHERE</span>
	Data = REPLICATE(<span class="string">'b'</span>, <span class="number">2000</span>)</span>
</pre></figure>

<p>Invoking DBCC IND again confirms that a new page has been allocated to our table:</p>
<div class="imgwrapper" style=""><div><a href="/anatomy-of-a-forwarded-record-ndash-the-forwarding-stub/image_41.png" class="fancy"><img src="/anatomy-of-a-forwarded-record-ndash-the-forwarding-stub/image_41.png" style="max-height: 250px"/></a></div></div>

<h2 id="The_FORWARDING_STUB">The FORWARDING_STUB</h2>
<p>By using DBCC PAGE we can take a look at the forwarded recorded, or at least what’s left of it on the original page 114:</p>
<figure class="highlight sql"><pre>DBCC TRACEON (3604)
DBCC PAGE (Test, 1, 114, 3)
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/anatomy-of-a-forwarded-record-ndash-the-forwarding-stub/image_6.png" class="fancy"><img src="/anatomy-of-a-forwarded-record-ndash-the-forwarding-stub/image_6.png" style="max-height: 250px"/></a></div></div>

<p>Identifying a forwarding stub is done by looking at the first status byte of the record. Specifically, bits 1-3 will tell us the record type:</p>
<figure class="highlight sql"><pre>Type = (RecordType)((Convert.ToByte(bits[1]) &lt;&lt; 2) + (Convert.ToByte(bits[2]) &lt;&lt; 1) + Convert.ToByte(bits[3]));
</pre></figure>

<p>With Type being one of the valid SQL Server record types:</p>
<figure class="highlight sql"><pre>public enum RecordType : byte
{
	Primary = 0,
	Forwarded = 1,
	ForwardingStub = 2,
	Index = 3,
	BlobFragment = 4,
	GhostIndex = 5,
	GhostData = 6,
	GhostVersion = 7
}
</pre></figure>

<p>While other record types will have two status bytes, a forwarding stub only has a single status byte. Thus, if we identify the record to be a forwarding stub, we know that the next 8 bytes will be a page pointer.</p>
<h2 id="Parsing_the_forwarding_stub">Parsing the forwarding stub</h2>
<p>Once we know the format, parsing a forwarding stub record is straight forward.</p>
<p>The first byte has a value of 0x04, or 0b100 in binary. Looking at bits 1-3 we get 0b10 or decimal 2 – which matches RecordType.ForwardingStub.</p>
<p>Looking at the next 8 bytes we have <span style="color: #ff0000;">76000000</span> <span style="color: #0000ff;">0001</span> <span style="color: #9b00d3;">0000</span>. I’ve divided them into three groups – in order they contain the page ID, the file ID and finally the slot number.</p>
<p><span style="color: #ff0000;">76000000</span> byte swapped = 0x76 = 118 in decimal.</p>
<p><span style="color: #0000ff;">0001</span> byte swapped = 0x01 = 1 in decimal.</p>
<p><span style="color: #9b00d3;">0000</span> byte swapped = 0x00 = 0 in decimal.</p>
<p>Thus we have the position of the forwarded record: (<span style="color: #0000ff;">1</span>:<span style="color: #ff0000;">118</span>:<span style="color: #9b00d3;">0</span>).</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jun</span>
			<span class="day">01</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/using-fiddler-to-automatically-download-streamed-mp3s/" title="Using Fiddler to Automatically Download Streamed MP3s" rel="bookmark">Using Fiddler to Automatically Download Streamed MP3s</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Eric Lawrence’s <a href="http://www.fiddler2.com/fiddler2/version.asp" target="_blank">Fiddler</a> has many uses. I use it every day for debugging our client/server interaction, caching behavior, etc. What many don’t realize is that Fiddler is also an excellent platform for scripting, enabling you to modify requests and responses as they go out and come back. I made a quick script to automatically download streamed MP3 files as they were played, naming them automatically from the ID3 information contained in them.</p>
<a id="more"></a>

<p>Before we get started, head on over and download the <a href="http://www.fiddler2.com/fiddler/fse.asp" target="_blank">FiddlerScript Editor</a>.</p>
<h2 id="Parsing_ID3_tags">Parsing ID3 tags</h2>
<p>As I’m lazy, and most likely you are too, we’ll use the excellent TagLib Sharp library for parsing the ID3 information in the downloaded MP3 files. You can get the latest version (2.0.4.0 as of this writing) <a href="http://download.banshee.fm/taglib-sharp/" target="_blank">from here</a>.</p>
<p>To gain access to the TagLib Sharp library from Fiddler, add a reference to it in the Fiddler Options dialog:</p>
<div class="imgwrapper" style=""><div><a href="/using-fiddler-to-automatically-download-streamed-mp3s/image_210.png" class="fancy"><img src="/using-fiddler-to-automatically-download-streamed-mp3s/image_210.png" style="max-height: 250px"/></a></div></div>

<h2 id="Setting_up_the_script">Setting up the script</h2>
<p>Now go to to Rules menu and click “Customize Rules…” to open the CustomRules.js file in the FiddlerScript Editor that we installed before.</p>
<div class="imgwrapper" style=""><div><a href="/using-fiddler-to-automatically-download-streamed-mp3s/image_44.png" class="fancy"><img src="/using-fiddler-to-automatically-download-streamed-mp3s/image_44.png" style="max-height: 250px"/></a></div></div>

<p>Go to the OnBeforeResponse function and add the following bit of code to the end:</p>
<figure class="highlight cs"><pre><span class="keyword">if</span>(oSession.url.Contains(<span class="string">"SomeStream.aspx"</span>)) {
	<span class="keyword">var</span> directory: String = <span class="string">"D:\Files\MP3"</span>;
	<span class="keyword">var</span> path: String = System.IO.Path.Combine(directory, Guid.NewGuid() + <span class="string">".mp3"</span>);

	oSession.SaveResponseBody(path);
	<span class="keyword">var</span> file: TagLib.File = TagLib.File.Create(path);

	<span class="keyword">if</span>(file.Tag.Title.Length &gt; <span class="number">0</span>)
	{
		<span class="keyword">var</span> target: String = System.IO.Path.Combine(directory, file.Tag.AlbumArtists + <span class="string">" - "</span> + file.Tag.Title + <span class="string">".mp3"</span>);

		<span class="keyword">if</span>(!System.IO.File.Exists(target))
			System.IO.File.Move(path, target);
		<span class="keyword">else</span>
			System.IO.File.Delete(path);
	}
}
</pre></figure>

<p>The first line identifies the requests that are for MP3 files. Depending on where you’re streaming from, you’ll obviously need to change this line to match your specific requirements.</p>
<p>Once an MP3 response has been detected, we save the file using a GUID as the name. If TagLib Sharp detects a song title, the file is renamed in the “AlbumArtists – Title.mp3” form. If no title is present, we just let the file stay with the GUID name for manual renaming later on.</p>
<p>Save the CustomRules.js file and Fiddler will automatically pick up on the changes and start saving those precious MP3s!</p>
<h2 id="Disclaimer">Disclaimer</h2>
<p>Obviously the above code should only be used to save MP3 files from streams to which you own the rights.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>


<div class="paging">
	<a href="/page/10/"><div class="past">« Past</div></a>
	<a href="/page/8/"><div class="future">Future »</div></a>
	<div class="clear"></div>
</div>

				</div>
			</div>

			<div id="asides">
				<div class="categories aside">
					<span class="sectiontitle">CATEGORIES</span>
					<ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/category/.NET/">.NET</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/AS/Flex/Flash/">AS/Flex/Flash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Amazon Web Services/">Amazon Web Services</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Computer Science/">Computer Science</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Conferences and Presenting/">Conferences and Presenting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/IIS/">IIS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Life/">Life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Misc/">Misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Miscellaneous/">Miscellaneous</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Performance/">Performance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Poker/">Poker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server/">SQL Server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Community/">SQL Server - Community</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Data Types/">SQL Server - Data Types</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Internals/">SQL Server - Internals</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Optimization/">SQL Server - Optimization</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Tricks/">SQL Server - Tricks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Testing/">Testing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Tools of the Trade/">Tools of the Trade</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Umbraco/">Umbraco</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Visual Studio/">Visual Studio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Web/">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windbg/">Windbg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windows/">Windows</a></li></ul>

					
				</div>

				<div class="archive aside">
					<span class="sectiontitle">ARCHIVE</span>
					<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archive/2014">2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2013">2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2012">2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2011">2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2010">2010</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2009">2009</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2008">2008</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2007">2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2006">2006</a></li></ul>
				</div>
			</div>

			<div class="clear"></div>
		</div>
		
		<footer>
			<div class="wrapper">Copyright &copy; 2014 Mark S. Rasmussen</div>
		</footer>

		<script type="text/javascript">
			$(function () {
				// Show mobile menu
				$("li.navicon").click(function () {
					if ($("header ul.mobile a").length == 0) {
						// Pages
						$mobilePages = $("div#naviconcontent ul.pages");
						$("header nav ul.normal > li").not(".navicon").each(function (i, el) {
							$mobilePages.append($(el).clone());
						});

						// Categories
						$mobileCategories = $("div#naviconcontent ul.categories");
						$("div#asides div.categories > ul > li").each(function (i, el) {
							$mobileCategories.append($(el).clone());
						});

						// Archive
						$mobileArchive = $("div#naviconcontent ul.archive");
						$("div#asides div.archive > ul > li").each(function (i, el) {
							$mobileArchive.append($(el).clone());
						});
					};

					$("header ul.mobile").toggle();
				});

				// Fancybox setup
				$("a.fancy").fancybox({
					hideOnContentClick: true,
					overlayShow: true
				});
			});
		</script>
	</body>
</html>