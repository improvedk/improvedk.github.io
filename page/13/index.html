<!DOCTYPE html>
<html>
	

<head>
	<title>Mark S. Rasmussen</title>
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
	<meta charset="UTF-8" />
	<meta property="og:locale" content="en_US" />
	<meta property="og:type" content="website" />
	<meta name="google-site-verification" content="alt7-wfK3ZujMQ4D0jYNd0yC5LGetGdqBlBmZsqQlVw" />
	<meta content="article" property="og:type">
<meta content="Mark S. Rasmussen" property="og:title">
<meta content="http://improve.dk/page/13/" property="og:url">
<meta property="og:image">
<meta content="Mark S. Rasmussen" property="og:site_name">
<meta property="og:description">
<meta content="summary" name="twitter:card">
	<link rel="alternative" href="http://feeds.feedburner.com/Improvedk" title="Mark S. Rasmussen" type="application/atom+xml">
	<script src="/js/combined.js"></script>
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-2479580-1', 'improve.dk');
		ga('require', 'displayfeatures');
		ga('send', 	'pageview');
	</script>
	<link rel="stylesheet" href="/css/style.css" type="text/css" />
</head>
	<body>
		<div id="headerline"></div>
	
		<header>
			<div class="wrapper">
				<div id="title">
					<a href="/">Mark S. Rasmussen</a> <span>improve.dk</span>
				</div>
				
				<nav>
					<ul class="normal">
						<li class="navicon"></li>
						<li><a href="/about-me/">About Me</a></li>
					</ul>
				</nav>
				
				<ul id="sharing">
					<li><a href="mailto:mark@improve.dk" id="shareat"></a></li>
					<li><a href="http://feeds.feedburner.com/Improvedk" id="rssfeed"></a></li>
					<li><a href="https://twitter.com/improvedk" id="sharetwitter"></a></li>
					<li><a href="https://github.com/improvedk" id="sharegithub"></a></li>
					<li><a href="https://www.linkedin.com/in/markrasmussen/" id="sharelinkedin"></a></li>
				</ul>

				<div class="clear"></div>
				
				<div id="naviconcontent">
					<ul class="mobile">
						<li>
							Pages
							<ul class="pages"></ul>
						</li>
						<li>
							Categories
							<ul class="categories"></ul>
						</li>
						<li>
							Archive
							<ul class="archive"></ul>
						</li>
					</ul>
				</div>
			</div>
		</header>

		<div id="mainwrapper">
			<div id="contentwrapper">
				<div id="content">
				
					
	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Oct</span>
			<span class="day">07</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/simple-file-synchronization-using-robocopy/" title="Simple File Synchronization Using Robocopy" rel="bookmark">Simple File Synchronization Using Robocopy</a></h1>
		<div class="categories">
			
				<a href="/category/Windows/">Windows</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>On numerous occations I’ve had a need for synchronizing directories of files &amp; subdirectories. I’ve used it for synchronizing work files from my stationary PC to my laptop in the pre-always-on era (today I use SVN for almost all files that needs to be in synch). Recently I needed to implement a very KISS backup solution that simply synchronized two directories once a week for offsite storing of the backup data.</p>
<a id="more"></a>

<p>While seemingly simple the only hitch was that there would be several thousands of files in binary format, so compression was out of the question. All changes would be additions and deletions - that is, no incremental updates. Finally I’d only have access to the files through a share so it wouldn’t be possible to deploy a local backup solution that monitored for changes and only sent diffs.</p>
<p>I started out using <a href="http://www.tgrmn.com/web/file_synchronization.htm" target="_blank">ViceVersa PRO</a> with the <a href="http://www.tgrmn.com/web/vvengine/vvengine.htm" target="_blank">VVEngine</a> addon for scheduling. It worked great for some time although it wasn’t the most speedy solution given my scenario. Some time later ViceVersa stopped working. Apparently it was simply unable to handle more than a million files (give or take a bit). Their forums are filled with people asking for solutions, though the only suggestion they have is to split the backup job into several smaller jobs. Hence I started taking backups of MyShare/A<em>, MyShare/B</em>, etc. This quickly grew out of hand as the number of files increased.</p>
<p>Sometime later I was introduced to <a href="http://technet.microsoft.com/en-us/library/cc733145(WS.10" target="_blank">Robocopy</a>.aspx). Robocopy ships with Vista, Win7 and Server 2008. For server 2003 and XP it can be downloaded as part of the<a href="http://www.microsoft.com/Downloads/details.aspx?FamilyID=9d467a69-57ff-4ae7-96ee-b18c4790cffd&amp;displaylang=en" target="_blank">Windows Server 2003 Resource Kit Tools</a>.</p>
<p>Robocopy (Robust File Copy) does one job extremely well - it copies files. It’s run from the command line, though there has been made a <a href="http://technet.microsoft.com/en-us/magazine/2006.11.utilityspotlight.aspx" target="_blank">wrapper GUI</a> for it. The basic syntax for calling robocopy is:</p>
<figure class="highlight"><pre>robocopy &lt;Source&gt; &lt;Destination&gt; [&lt;File&gt;[ <span class="keyword">...</span>]] [&lt;Options&gt;]
</pre></figure>

<p>You give it a source and a destination address and it’ll make sure all files &amp; directories from the source are copied to the destination. If an error occurs it’ll wait for 30 seconds (configurable) before retrying, and it’ll continue doing this a million times (configurable). That means robocopy will survive a network error and just resume the copying process once the network is back up again.</p>
<p>What makes robocopy really shine is not it’s ability to copy files, but it’s ability to mirror one directory into another. That means it’ll not just copy files, it’ll also delete any extra files in the destination directory. In comparison to ViceVersa, robocopy goes through the directory structure in a linear fashion and in doing so doesn’t have any major requirements of memory. ViceVersa would initially scan the source and destination and then perform the comparison. As source and destination became larger and larger, more memory was required to perform the initial comparison - until a certain point where it’d just give up.</p>
<p>I ended up with the following command for mirroring the directories using robocopy:</p>
<figure class="highlight"><pre>robocopy <span class="command">\\</span>SourceServer<span class="command">\Share</span> <span class="command">\\</span>DestinationServer<span class="command">\Share</span> /MIR /FFT /Z /XA:H /W:5
</pre></figure>

<ul>
<li>/MIR specifies that robocopy should mirror the source directory and the destination directory. Beware that this may delete files at the destination.</li>
<li>/FFT uses fat file timing instead of NTFS. This means the granularity is a bit less precise. For across-network share operations this seems to be much more reliable - just don’t rely on the file timings to be completely precise to the second.</li>
<li>/Z ensures robocopy can resume the transfer of a large file in mid-file instead of restarting.</li>
<li>/XA:H makes robocopy ignore hidden files, usually these will be system files that we’re not interested in.</li>
<li>/W:5 reduces the wait time between failures to 5 seconds instead of the 30 second default.</li>
</ul>
<p>The robocopy script can be setup as a simply Scheduled Task that runs daily, hourly, weekly etc. Note that robocopy also contains a switch that’ll make robocopy monitor the source for changes and invoke the synchronization script each time a configurable number of changes has been made. This may work in your scenario, but be aware that robocopy will not just copy the changes, it will scan the complete directory structure just like a normal mirroring procedure. If there’s a lot of files &amp; directories, this may hamper performance.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Sep</span>
			<span class="day">30</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/writing-a-calculator-in-csharp-using-sablecc/" title="Writing a Calculator in C# Using SableCC" rel="bookmark">Writing a Calculator in C# Using SableCC</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Writing a calculator is a simple task - just add nine buttons labeled 1-9 and add a plus and minus button and we’re almost good to go. In this entry I’m going to write a calculator called SimpleCalc that does not have a GUI, instead it’ll take in an arbitrary expression and calculate the results of it. The input I’ll use as my immediate goal is the following:</p>
<a id="more"></a>


<figure class="highlight"><pre><span class="number">25</span>-<span class="number">37</span>+<span class="number">2</span><span class="variable">*(</span><span class="number">1.22</span>+<span class="keyword">cos</span>(<span class="number">5</span>))<span class="variable">*sin</span>(<span class="number">5</span>)<span class="variable">*2</span>+<span class="number">5</span><span class="variable">%2</span><span class="variable">*3</span><span class="variable">*sqrt</span>(<span class="number">5</span>+<span class="number">2</span>)
</pre></figure>

<p><a href="http://www.google.dk/search?rlz=1C1CHMG_daDK293DK303&amp;sourceid=chrome&amp;ie=UTF-8&amp;q=25-37%2B2*%281.22%2Bcos%285%29%29*sin%285%29*2%2B5%252*3*sqrt%285%2B2%29" target="_blank">According to Google</a> the result is -9.83033875. Some of the tricky subjects we’ll have to handle is <a href="http://en.wikipedia.org/wiki/Order_of_operations" target="_blank">operator precedence</a> (multiplication before addition etc), nested expressions (2*1.22+cos(5) != 2*(1.22+cos(5))) and <a href="http://en.wikipedia.org/wiki/Associativity" target="_blank">associativity</a> (5+7 == 7+5 &amp; 7-5 != 5-7 etc).</p>
<h2 id="Parsing_the_input_using_SableCC">Parsing the input using SableCC</h2>
<p>Before doing any calculations, we need to parse the input expression so we have an in-memory representation of the input. We need to have the input represented in the form of an <a href="http://en.wikipedia.org/wiki/Abstract_syntax_tree" target="_blank">abstract syntax tree</a> that defines the order of operations and allows us to traverse the different parts of the expression individually. To perform this task, we’ll be using <a href="http://sablecc.org/" target="_blank">SableCC</a>.</p>
<blockquote>
<p>SableCC is a parser generator which generates fully featured object-oriented frameworks for building compilers, interpreters and other text parsers. In particular, generated frameworks include intuitive strictly-typed abstract syntax trees and tree walkers. SableCC also keeps a clean separation between machine-generated code and user-written code which leads to a shorter development cycle.</p>
</blockquote>
<p>In short, SableCC can be used to automatically generate the parser code that’s used in any compiler, as well as in a lot of other cases where input needs to be parsed - like in this case. SableCC itself is written in Java by <a href="http://www.labunix.uqam.ca/~gagnon_et/en/" target="_blank">Etienne M. Gagnon</a> and the <a href="http://sablecc.org/browser/src" target="_blank">source code</a> is freely available.</p>
<p>The standard output from SableCC is Java code. Thus, the parser we’re about to generate will be made into a number of Java files that we can incorporate into our own source code and extend. As I’ll be writing the calculator in C#, I’d much prefer to work with C# source files directly, rather than having to port the Java output or call it by other means. Luckily <a href="http://www.mare.ee/indrek/" target="_blank">Indrek Mandre</a> has made a SableCC variant that’ll generate the parser in either Java, C#, C++, O’Caml, Python, C, Graphviz Dot or XML. All we need to do is to download the <a href="http://www.mare.ee/indrek/sablecc/" target="_blank">sablecc-3-beta.3.altgen.20041114</a> zip file from the frontpage of Indrek’s SableCC page. Once it’s downloaded and unpacked we’re able to run it, as long as Java is installed. First create a bat file with the following contents:</p>
<figure class="highlight"><pre>java -jar <span class="string">"C:Program FilesSableCCsablecc-3-beta.3.altgen.20041114libsablecc.jar"</span> <span class="variable">%1</span> <span class="variable">%2</span> <span class="variable">%3</span> <span class="variable">%4</span> <span class="variable">%5</span> <span class="variable">%6</span> <span class="variable">%7</span> <span class="variable">%8</span> <span class="variable">%9</span>
</pre></figure>

<p>Make sure to replace my path with whatever path you’ve extracted the SableCC altgen package into. When we invoke SableCC from now on, we’ll do it through this bat file that I’ve chosen to call <strong>sablecc_altgen.bat</strong>, just to make the syntax simpler.</p>
<h2 id="Defining_the_grammar">Defining the grammar</h2>
<p>For SableCC to be able to generate our parser, we first need to define the language it should support. The way we do this is to define the language in the <a href="http://en.wikipedia.org/wiki/Extended_Backus%E2%80%93Naur_Form" target="_blank">(E)BNF</a>format. I won’t be writing a generic tutorial on how to write grammers in SableCC as there’s already a number of good ones on the <a href="http://sablecc.org/wiki/DocumentationPage" target="_blank">SableCC Documentation</a> page, as well as <a href="http://nat.truemesh.com/archives/000531.html" target="_blank">one by Nat Pryce</a> that’s not on the documentation page. Finally there’s also a <a href="http://www.nabble.com/SableCC-f12279r0.html" target="_blank">mailing list</a>, though the activity is limited.</p>
<p>We’ll start out by creating a new text file called <em>simplecalc.sablecc</em>, this is where we’ll be defining our SimpleCalc grammar. Furthermore I’ve created a new bat file called simplecalc_sable.bat with the following contents:</p>
<figure class="highlight"><pre><span class="keyword">cls</span>
sablecc_altgen -d generated -t csharp simplecalc<span class="preprocessor">.sablecc</span>
</pre></figure>

<p>The above bat file will call the one we previously made. <strong>-d generated</strong> specifies the output directory name. <strong>-t csharp</strong> specifies the output source code type, C# in this case. The last argument is the name of the input sablecc file. From now on we can simply run <strong>simplecalc_sable</strong> to start the SableCC compilation process.</p>
<p>I’ll post the full simplecalc.sablecc file contents first, and then go through the specific sections one by one afterwards.</p>
<figure class="highlight"><pre>Package SimpleCalc;

Helpers
	digit	= [<span class="comment">'0' .. '9'];</span>

Tokens
	number	= (digit+ | digit+ <span class="comment">'.' digit+);</span>
	add	= <span class="comment">'+';</span>
	<span class="keyword">sub</span>	= <span class="comment">'-';</span>
	mul	= <span class="comment">'*';</span>
	div	= <span class="comment">'/';</span>
	mod	= <span class="comment">'%';</span>
	sqrt	= <span class="comment">'sqrt';</span>
	<span class="built_in">cos</span>	= <span class="comment">'cos';</span>
	<span class="built_in">sin</span>	= <span class="comment">'sin';</span>
	lparen	= <span class="comment">'(';</span>
	rparen	= <span class="comment">')';</span>

Productions		
	<span class="built_in">exp</span> {-&gt; <span class="built_in">exp</span>}
		= {add}		[<span class="built_in">left</span>]:<span class="built_in">exp</span> add [<span class="built_in">right</span>]:factor		{-&gt; <span class="keyword">New</span> <span class="built_in">exp</span>.add(<span class="built_in">left</span>, <span class="built_in">right</span>.<span class="built_in">exp</span>)}
		| {<span class="keyword">sub</span>}		[<span class="built_in">left</span>]:<span class="built_in">exp</span> <span class="keyword">sub</span> [<span class="built_in">right</span>]:factor		{-&gt; <span class="keyword">New</span> <span class="built_in">exp</span>.<span class="keyword">sub</span>(<span class="built_in">left</span>, <span class="built_in">right</span>.<span class="built_in">exp</span>)}
		| {factor}	factor					{-&gt; factor.<span class="built_in">exp</span>}
		;
		
	factor {-&gt; <span class="built_in">exp</span>}
		= {mul}		[<span class="built_in">left</span>]:factor mul [<span class="built_in">right</span>]:unary		{-&gt; <span class="keyword">New</span> <span class="built_in">exp</span>.mul(<span class="built_in">left</span>.<span class="built_in">exp</span>, <span class="built_in">right</span>.<span class="built_in">exp</span>)}
		| {div}		[<span class="built_in">left</span>]:factor div [<span class="built_in">right</span>]:unary		{-&gt; <span class="keyword">New</span> <span class="built_in">exp</span>.div(<span class="built_in">left</span>.<span class="built_in">exp</span>, <span class="built_in">right</span>.<span class="built_in">exp</span>)}
		| {mod}		[<span class="built_in">left</span>]:factor mod [<span class="built_in">right</span>]:unary		{-&gt; <span class="keyword">New</span> <span class="built_in">exp</span>.mod(<span class="built_in">left</span>.<span class="built_in">exp</span>, <span class="built_in">right</span>.<span class="built_in">exp</span>)}
		| {unary}	unary					{-&gt; unary.<span class="built_in">exp</span>}
		;
		
	unary {-&gt; <span class="built_in">exp</span>}
		= {number}	number					{-&gt; <span class="keyword">New</span> <span class="built_in">exp</span>.number(number)}
		| {sqrt}	sqrt lparen <span class="built_in">exp</span> rparen			{-&gt; <span class="keyword">New</span> <span class="built_in">exp</span>.sqrt(<span class="built_in">exp</span>)}
		| {<span class="built_in">cos</span>}		<span class="built_in">cos</span> lparen <span class="built_in">exp</span> rparen			{-&gt; <span class="keyword">New</span> <span class="built_in">exp</span>.<span class="built_in">cos</span>(<span class="built_in">exp</span>)}
		| {<span class="built_in">sin</span>}		<span class="built_in">sin</span> lparen <span class="built_in">exp</span> rparen			{-&gt; <span class="keyword">New</span> <span class="built_in">exp</span>.<span class="built_in">sin</span>(<span class="built_in">exp</span>)}
		| {paren}	lparen <span class="built_in">exp</span> rparen			{-&gt; <span class="keyword">New</span> <span class="built_in">exp</span>.paren(<span class="built_in">exp</span>)}
		;
		
	exp_list {-&gt; <span class="built_in">exp</span>*}
		= {single}	<span class="built_in">exp</span>					{-&gt; [<span class="built_in">exp</span>.<span class="built_in">exp</span>]}
		| {multi}	<span class="built_in">exp</span> [tail]:exp_list			{-&gt; [<span class="built_in">exp</span>.<span class="built_in">exp</span>, tail.<span class="built_in">exp</span>]}
		;
		
Abstract Syntax Tree
	<span class="built_in">exp</span>
		= {add}			[<span class="built_in">left</span>]:<span class="built_in">exp</span> [<span class="built_in">right</span>]:<span class="built_in">exp</span>
		| {<span class="keyword">sub</span>}			[<span class="built_in">left</span>]:<span class="built_in">exp</span> [<span class="built_in">right</span>]:<span class="built_in">exp</span>
		| {mul}			[<span class="built_in">left</span>]:<span class="built_in">exp</span> [<span class="built_in">right</span>]:<span class="built_in">exp</span>
		| {div}			[<span class="built_in">left</span>]:<span class="built_in">exp</span> [<span class="built_in">right</span>]:<span class="built_in">exp</span>
		| {mod}			[<span class="built_in">left</span>]:<span class="built_in">exp</span> [<span class="built_in">right</span>]:<span class="built_in">exp</span>
		| {paren}		<span class="built_in">exp</span>
		| {sqrt}		<span class="built_in">exp</span>
		| {<span class="built_in">cos</span>}			<span class="built_in">exp</span>
		| {<span class="built_in">sin</span>}			<span class="built_in">exp</span>
		| {number}		number
		;
</pre></figure>

<p>In the grammar we’re using 5 different sections, Package, Helpers, Tokens, Productions and Abstract Syntax Tree.</p>
<figure class="highlight"><pre><span class="keyword">Package</span> SimpleCalc;
</pre></figure>

<p>The Package declaration simply defines the name of the overall package. If this is excluded (which is valid according to SableCC) our namesapces int he generated C# code will be blank and thus invalid.</p>
<figure class="highlight"><pre>Helpers
	digit	= [<span class="string">'0'</span> .. <span class="string">'9'</span>];
</pre></figure>

<p>Helpers are basically placeholders you can setup and use throughout the SableCC file. They have no deeper meaning or functionality, it’s just a way to easily be able to express common code by its name. As we’ll be referring to <em>digits</em> multiple times it helps to define it as a helper instead of replicating <strong>[‘0’ .. ‘9’]</strong> multiple times in the code. <strong>[‘0’ .. ‘9’]</strong> means all digits between 0 and 9.</p>
<figure class="highlight"><pre>Tokens
	number		= (digit+ | digit+ <span class="string">'.'</span> digit+);
	add		= <span class="string">'+'</span>;
	<span class="sub"><span class="keyword">sub</span>		= '-';</span>
	mul		= <span class="string">'*'</span>;
	div		= <span class="string">'/'</span>;
	mod		= <span class="string">'%'</span>;
	<span class="keyword">sqrt</span>		= <span class="string">'sqrt'</span>;
	<span class="keyword">cos</span>		= <span class="string">'cos'</span>;
	<span class="keyword">sin</span>		= <span class="string">'sin'</span>;
	lparen		= <span class="string">'('</span>;
	rparen		= <span class="string">')'</span>;
</pre></figure>

<p>Note that I’m jumping ahead and ignoring <strong>Productions</strong> section for now, I’ll come to that in just a bit. The <strong>Abstract Syntax Tree</strong> defines the nodes that will be present in our parsed AST. Each type of operation and function has a corresponding node in the AST. Thus, and add operation will consist of an Add node with two children - a left and a right expression. Those expressions may themselves be constant numbers or nested expressions - since they’re defined as <strong>exp</strong> which is a recursive reference to the actual AST exp type.</p>
<p><strong>Add</strong>, <strong>sub</strong>, <strong>mul</strong>, <strong>div</strong> and <strong>mod</strong> are <strong>binary</strong> operators and thus have two child expressions. <strong>Paren</strong>, <strong>sqrt</strong>, <strong>cos</strong> and <strong>sin</strong> (and in some ways, number) are unary operators in that they only have a single child/parameter - an expression. Number is a leaf node that expresses an actual number constant.</p>
<p>The <strong>Productions</strong> section defines our mapping from the actual input to the AST that we’ve just defined.</p>
<figure class="highlight"><pre>Productions
	<span class="built_in">exp</span> {-&gt; <span class="built_in">exp</span>}
		= {add}		[<span class="built_in">left</span>]:<span class="built_in">exp</span> add [<span class="built_in">right</span>]:factor		{-&gt; <span class="keyword">New</span> <span class="built_in">exp</span>.add(<span class="built_in">left</span>, <span class="built_in">right</span>.<span class="built_in">exp</span>)}
		| {<span class="keyword">sub</span>}		[<span class="built_in">left</span>]:<span class="built_in">exp</span> <span class="keyword">sub</span> [<span class="built_in">right</span>]:factor 		{-&gt; <span class="keyword">New</span> <span class="built_in">exp</span>.<span class="keyword">sub</span>(<span class="built_in">left</span>, <span class="built_in">right</span>.<span class="built_in">exp</span>)}
		| {factor}	factor					{-&gt; factor.<span class="built_in">exp</span>}
		;
</pre></figure>

<p>The first production we define is a generic one for expressing expressions. Note that the way we define operator precedence is by first expressing the least prioritized operator (<strong>add</strong> &amp; <strong>sub</strong>) and then referencing the factor operations (<strong>mul</strong>, <strong>div</strong>, <strong>mod</strong> &amp; <strong>unary</strong>) and thus forth. <strong>exp {-&gt; exp}</strong> signifies that the concrete syntax of an expression is mapped into the abstract syntax tree node called “exp” as well. <strong>Productions</strong> and <strong>Abstract Syntax Tree</strong> are two different namespaces and they may thus share the same names.</p>
<figure class="highlight"><pre><span class="header">= {add}		[left]:exp add [right]:factor		{-&gt; New exp.add(left, right.exp)}</span>
</pre></figure>

<p>The <strong>add</strong> operation is defined by a left expression followed by the add token (defined as ‘+’ previously) and then a factor expression on the right, hence defining the precedence relation between the add operation and factor operations. Finally we define that the add operation maps into a new instance of the exp AST node, having the left and right expressions as parameters (children in the AST). The sub operation is almost identical to the add operator.</p>
<figure class="highlight"><pre>| <span class="cell">{factor}</span>	<span class="built_in">factor</span>		<span class="cell">{-&gt; factor.exp}</span>
</pre></figure>

<p>Any factor expressions are simply mapped onto the factor production defined later on.</p>
<figure class="highlight"><pre>factor {-&gt; <span class="built_in">exp</span>}
	= {mul}		[<span class="built_in">left</span>]:factor mul [<span class="built_in">right</span>]:unary		{-&gt; <span class="keyword">New</span> <span class="built_in">exp</span>.mul(<span class="built_in">left</span>.<span class="built_in">exp</span>, <span class="built_in">right</span>.<span class="built_in">exp</span>)}
	| {div}		[<span class="built_in">left</span>]:factor div [<span class="built_in">right</span>]:unary		{-&gt; <span class="keyword">New</span> <span class="built_in">exp</span>.div(<span class="built_in">left</span>.<span class="built_in">exp</span>, <span class="built_in">right</span>.<span class="built_in">exp</span>)}
	| {mod}		[<span class="built_in">left</span>]:factor mod [<span class="built_in">right</span>]:unary		{-&gt; <span class="keyword">New</span> <span class="built_in">exp</span>.mod(<span class="built_in">left</span>.<span class="built_in">exp</span>, <span class="built_in">right</span>.<span class="built_in">exp</span>)}
	| {unary}	unary					{-&gt; unary.<span class="built_in">exp</span>}
	;
</pre></figure>

<p>The <strong>mul</strong>, <strong>div</strong> and <strong>mod</strong> expressions are basically identical to the add and sub expressions, except defining unary as the next production in the operator precedence chain.</p>
<figure class="highlight"><pre>unary {-&gt; <span class="built_in">exp</span>}
	= {number}	number					{-&gt; <span class="keyword">New</span> <span class="built_in">exp</span>.number(number)}
	| {sqrt}	sqrt lparen <span class="built_in">exp</span> rparen			{-&gt; <span class="keyword">New</span> <span class="built_in">exp</span>.sqrt(<span class="built_in">exp</span>)}
	| {<span class="built_in">cos</span>}		<span class="built_in">cos</span> lparen <span class="built_in">exp</span> rparen			{-&gt; <span class="keyword">New</span> <span class="built_in">exp</span>.<span class="built_in">cos</span>(<span class="built_in">exp</span>)}
	| {<span class="built_in">sin</span>}		<span class="built_in">sin</span> lparen <span class="built_in">exp</span> rparen			{-&gt; <span class="keyword">New</span> <span class="built_in">exp</span>.<span class="built_in">sin</span>(<span class="built_in">exp</span>)}
	| {paren}	lparen <span class="built_in">exp</span> rparen			{-&gt; <span class="keyword">New</span> <span class="built_in">exp</span>.paren(<span class="built_in">exp</span>)}
	;
</pre></figure>

<p>The simplest of all expressions is the unary <strong>number</strong> expression that defines a numeric constant. The number expression is mapped into a new AST node of the type exp.number, having the actual number as a parameter. The <strong>sqrt</strong>, <strong>cos</strong> and <strong>sin</strong> functions all define the input as the function name and the parameter expression enclosed in parentheses. Finally we define the <strong>{paren}</strong> unary function which is an arbitrary expression enclosed in parentheses. This gets mapped into the exp.paren AST type, taking the arbitrary expression as a parameter. The {paren} function allows us to differentiate between expressions like “5*2-7” and “5*(2-7)”.</p>
<figure class="highlight"><pre>exp_list {-&gt; <span class="built_in">exp</span>*}
	= {single}	<span class="built_in">exp</span>					{-&gt; [<span class="built_in">exp</span>.<span class="built_in">exp</span>]}
	| {multi}	<span class="built_in">exp</span> [tail]:exp_list			{-&gt; [<span class="built_in">exp</span>.<span class="built_in">exp</span>, tail.<span class="built_in">exp</span>]}
	;
</pre></figure>

<p>The final production is what allows us to chain expressions. Without the <strong>exp_list</strong> production only single operations would be allowed (5+2, 3*7 etc), not chains of expressions (5+2+3, 5*2+3 etc). <strong>exp_list {-&gt; exp*}</strong> defines that the exp_list production maps into a list of exp’s in the AST.</p>
<p>Anyone having done functional programming will recognize the <a href="http://en.wikipedia.org/wiki/Tail_recursion" target="_blank">tail recursion</a> going on here. If there’s only a single expression, we map it into a list of expressions containing just that one expression. If there’s a single expression and a list of expressions following it (which may be one or more expressions), we map it into a list of expressions containing the first expression as well as the rest of the expressions represented by the tail parameter.</p>
<h2 id="Generating_the_parser">Generating the parser</h2>
<p>Once we’ve defined the grammar, we’re ready to run the <strong>simplecalc_sable</strong> bat file, hopefully resulting in the following output:</p>
<figure class="highlight"><pre>D:<span class="subst">\</span>Webmentor Projekter<span class="subst">\</span>Eclipse Projects<span class="subst">\</span>SableCC<span class="subst">\&gt;</span>simplecalc_sable <span class="attribute">-d</span> generated <span class="attribute">-t</span> c
sharp simplecalc<span class="built_in">.</span>sablecc

D:<span class="subst">\</span>Webmentor Projekter<span class="subst">\</span>Eclipse Projects<span class="subst">\</span>SableCC<span class="subst">\&gt;</span>java <span class="attribute">-jar</span> <span class="string">"C:Program FilesSabl
eCCsablecc-3-beta.3.altgen.20041114libsablecc.jar"</span> <span class="attribute">-d</span> generated <span class="attribute">-t</span> csharp sim
plecalc<span class="built_in">.</span>sablecc

SableCC version <span class="number">3</span><span class="attribute">-beta</span><span class="number">.3</span><span class="built_in">.</span>altgen<span class="number">.20040327</span>
Copyright (C) <span class="number">1997</span><span class="subst">-</span><span class="number">2003</span> Etienne M<span class="built_in">.</span> Gagnon <span class="subst">&lt;</span>etienne<span class="built_in">.</span>gagnon@uqam<span class="built_in">.</span>ca<span class="subst">&gt;</span> <span class="literal">and</span>
others<span class="built_in">.</span>  <span class="literal">All</span> rights reserved<span class="built_in">.</span>

This software comes <span class="keyword">with</span> ABSOLUTELY NO WARRANTY<span class="built_in">.</span>  This is free software,
<span class="literal">and</span> you are welcome <span class="keyword">to</span> redistribute it under certain conditions<span class="built_in">.</span>

<span class="keyword">Type</span> <span class="string">'sablecc -license'</span> <span class="keyword">to</span> view
the complete copyright notice <span class="literal">and</span> license<span class="built_in">.</span>


 <span class="subst">--</span> Generating parser for simplecalc<span class="built_in">.</span>sablecc <span class="keyword">in</span> D:Webmentor ProjekterEclipse P
rojectsSableCCgenerated
Verifying identifiers<span class="built_in">.</span>
Verifying ast identifiers<span class="built_in">.</span>
Adding empty productions <span class="literal">and</span> empty alternative transformation <span class="keyword">if</span> necessary<span class="built_in">.</span>
Adding productions <span class="literal">and</span> alternative transformation <span class="keyword">if</span> necessary<span class="built_in">.</span>
computing alternative symbol table identifiers<span class="built_in">.</span>
Verifying production transform identifiers<span class="built_in">.</span>
Verifying ast alternatives transform identifiers<span class="built_in">.</span>
Generating token classes<span class="built_in">.</span>
Generating production classes<span class="built_in">.</span>
Generating alternative classes<span class="built_in">.</span>
Generating analysis classes<span class="built_in">.</span>
Generating utility classes<span class="built_in">.</span>
Generating the lexer<span class="built_in">.</span>
 State: INITIAL
 <span class="subst">-</span> Constructing NFA<span class="built_in">.</span>
<span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span>
 <span class="subst">-</span> Constructing DFA<span class="built_in">.</span>
<span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span>
<span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="built_in">..</span>
 <span class="subst">-</span> resolving ACCEPT states<span class="built_in">.</span>
Generating the parser<span class="built_in">.</span>
<span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span>
<span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span>
<span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span>
<span class="built_in">..</span>
<span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span>
</pre></figure>

<p>Now if we look in the generated directory, there should be six files: <strong>analysis.cs</strong>, <strong>lexer.cs</strong>, <strong>nodes.cs</strong>, <strong>parser.cs</strong>, <strong>prods.cs</strong> and <strong>tokens.cs</strong>. The files should contain classes in the <strong>SimpleCalc</strong> namespace.</p>
<h2 id="Printing_the_abstract_syntax_tree">Printing the abstract syntax tree</h2>
<p>To help ourselves, the first task we’ll do is to simply print out the AST so we can verify what gets parsed is correct. Create a solution called <strong>SimpleCalc</strong> and either copy the genrated files or create a solution link to the folder. Add a new file called <strong>AstPrinter.cs</strong> and paste the following contents:</p>
<figure class="highlight cs"><pre><span class="keyword">using</span> System;
<span class="keyword">using</span> SimpleCalc.analysis;
<span class="keyword">using</span> SimpleCalc.node;

namespace SimpleCalc
{
	class AstPrinter : DepthFirstAdapter
	{
		<span class="keyword">int</span> indent;

		<span class="keyword">private</span> <span class="keyword">void</span> <span class="title">printIndent</span>()
		{
			Console.Write(<span class="string">""</span>.PadLeft(indent, <span class="string">'t'</span>));
		}

		<span class="keyword">private</span> <span class="keyword">void</span> <span class="title">printNode</span>(Node node)
		{
			printIndent();

			Console.ForegroundColor = ConsoleColor.White;
			Console.Write(node.GetType().ToString().Replace(<span class="string">"SimpleCalc.node."</span>, <span class="string">""</span>));

			<span class="keyword">if</span> (node <span class="keyword">is</span> ANumberExp)
			{
				Console.ForegroundColor = ConsoleColor.DarkGray;
				Console.WriteLine(<span class="string">"  "</span> + node.ToString());
			}
			<span class="keyword">else</span>
				Console.WriteLine();
		}

		<span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DefaultIn</span>(Node node)
		{
			printNode(node);
			indent++;
		}

		<span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DefaultOut</span>(Node node)
		{
			indent--;
		}
	}
}
</pre></figure>

<p>The <strong>DepthFirstAdapter</strong> is a class auto generated by SableCC. It allows us to easily traverse the generated AST depth first, while giving us various hook points along the way. Each node in the tree has an In and Out method that we can override. In is called before the children are traversed while Out is called after the children have been traversed. Note that we may change the tree during the traversal - though we’re not going to do so.</p>
<p>In the AstPrinter class I’ve overriden the <strong>DefaultIn</strong> and <strong>DefaultOut</strong> methods that gets called for each node unless we’ve overriden their specific default methods. In the In method we increase the indent, and likewise we decrease it in the Out method. Furthermore, in the In method we also print the actual node contents to the console. If it’s a ANumberExp node (the name of the node corresponding to the number type in the AST) then we print the actual number, otherwise we just print the name of the node itself.</p>
<p>In the main program file, paste the following:</p>
<figure class="highlight cs"><pre><span class="keyword">using</span> System;
<span class="keyword">using</span> System.IO;
<span class="keyword">using</span> SimpleCalc.lexer;
<span class="keyword">using</span> SimpleCalc.node;
<span class="keyword">using</span> SimpleCalc.parser;

namespace SimpleCalc
{
	class Program
	{
		<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="keyword">string</span>[] args)
		{
			<span class="keyword">if</span> (args.Length != <span class="number">1</span>)
				exit(<span class="string">"Usage: Simplecalc.exe filename"</span>);

			<span class="keyword">using</span> (StreamReader sr = <span class="keyword">new</span> StreamReader(File.Open(args[<span class="number">0</span>], FileMode.Open)))
			{
				<span class="comment">// Read source</span>
				Lexer lexer = <span class="keyword">new</span> Lexer(sr);

				<span class="comment">// Parse source</span>
				Parser parser = <span class="keyword">new</span> Parser(lexer);
				Start ast = <span class="keyword">null</span>;

				<span class="keyword">try</span>
				{
					ast = parser.Parse();
				}
				<span class="keyword">catch</span> (Exception ex)
				{
					exit(ex.ToString());
				}

				<span class="comment">// Print tree</span>
				AstPrinter printer = <span class="keyword">new</span> AstPrinter();
				ast.Apply(printer);
			}

			exit(<span class="string">"Done"</span>);
		}

		<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">exit</span>(<span class="keyword">string</span> msg)
		{
			<span class="keyword">if</span> (msg != <span class="keyword">null</span>)
				Console.WriteLine(msg);
			<span class="keyword">else</span>
				Console.WriteLine();
			
			Console.WriteLine(<span class="string">"Press any key to exit..."</span>);
			Console.Read();
			Environment.Exit(<span class="number">0</span>);
		}
	}
}
</pre></figure>

<p>I’ve made it so the program takes in a single argument, a filename where our calculation expression is written. By taking a file as a parameter, it’s easier for me to change the expression directly in Visual Studio without having to setup launch parameters. The only launch parameter that needs to be set is the file argument.</p>
<div class="imgwrapper" style=""><div><a href="/writing-a-calculator-in-csharp-using-sablecc/simplecalc_properties_2.jpg" class="fancy"><img src="/writing-a-calculator-in-csharp-using-sablecc/simplecalc_properties_2.jpg" style="max-height: 250px"/></a></div></div>

<p>The program tries to open the file and then instantiates the SableCC auto generated <a href="http://en.wikipedia.org/wiki/Lexical_analysis" target="_blank">lexer</a> and <a href="http://en.wikipedia.org/wiki/Parsing" target="_blank">parser</a>.</p>
<p>Now let’s make a new file called <strong>test.ss</strong> and paste the following expression into it: <strong>25-37+2*(1.22+cos(5))*sin(5)*2+5%2*3*sqrt(5+2)</strong>. If you run the application at this point, you should see an output like the following:</p>
<div class="imgwrapper" style=""><div><a href="/writing-a-calculator-in-csharp-using-sablecc/simplecalc_ast_2.jpg" class="fancy"><img src="/writing-a-calculator-in-csharp-using-sablecc/simplecalc_ast_2.jpg" style="max-height: 250px"/></a></div></div>

<p>By comparing the printed AST with the input expression, we’ll see that they match both in contents and in regards to operator precedence. Now all that’s left is to perform the actual calculation of the expression.</p>
<h2 id="Calculating_the_expression_based_on_the_abstract_syntax_tree">Calculating the expression based on the abstract syntax tree</h2>
<p>Add a new file called <strong>AstCalculator.cs</strong> and paste the following contents:</p>
<figure class="highlight cs"><pre><span class="keyword">using</span> System;
<span class="keyword">using</span> System.Collections.Generic;
<span class="keyword">using</span> System.Globalization;
<span class="keyword">using</span> SimpleCalc.analysis;
<span class="keyword">using</span> SimpleCalc.node;

namespace SimpleCalc
{
	class AstCalculator : DepthFirstAdapter
	{
		<span class="keyword">private</span> <span class="keyword">double</span>? result;
		<span class="keyword">private</span> Stack&lt;<span class="keyword">double</span>&gt; stack = <span class="keyword">new</span> Stack&lt;<span class="keyword">double</span>&gt;();

		<span class="keyword">public</span> <span class="keyword">double</span> CalculatedResult
		{
			<span class="keyword">get</span>
			{
				<span class="keyword">if</span> (result == <span class="keyword">null</span>)
					<span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">"Must apply AstCalculator to the AST first."</span>);

				<span class="keyword">return</span> result.Value;
			}
		}

		<span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OutStart</span>(Start node)
		{
			<span class="keyword">if</span> (stack.Count != <span class="number">1</span>)
				<span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Stack should contain only one element at end."</span>);

			result = stack.Pop();
		}
		
		<span class="comment">// Associative operators</span>
		<span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OutAMulExp</span>(AMulExp node)
		{
			stack.Push(stack.Pop() * stack.Pop());
		}

		<span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OutAAddExp</span>(AAddExp node)
		{
			stack.Push(stack.Pop() + stack.Pop());
		}

		<span class="comment">// Non associative operators</span>
		<span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OutASubExp</span>(ASubExp node)
		{
			<span class="keyword">double</span> numB = stack.Pop();

			stack.Push(stack.Pop() - numB);
		}

		<span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OutAModExp</span>(AModExp node)
		{
			<span class="keyword">double</span> numB = stack.Pop();

			stack.Push(stack.Pop() % numB);
		}

		<span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OutADivExp</span>(ADivExp node)
		{
			<span class="keyword">double</span> numB = stack.Pop();

			stack.Push(stack.Pop() / numB);
		}

		<span class="comment">// Unary</span>
		<span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OutASqrtExp</span>(ASqrtExp node)
		{
			stack.Push(Math.Sqrt(stack.Pop()));
		}

		<span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OutACosExp</span>(ACosExp node)
		{
			stack.Push(Math.Cos(stack.Pop()));
		}

		<span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OutASinExp</span>(ASinExp node)
		{
			stack.Push(Math.Sin(stack.Pop()));
		}

		<span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">InANumberExp</span>(ANumberExp node)
		{
			stack.Push(Convert.ToDouble(node.GetNumber().Text.Trim(), <span class="keyword">new</span> CultureInfo(<span class="string">"en-us"</span>)));
		}
	}
}
</pre></figure>

<p>I will not go through all parts of the calculator as many functions are very similar. I’ll outline the important ones below.</p>
<figure class="highlight cs"><pre><span class="keyword">private</span> <span class="keyword">double</span>? result;
<span class="keyword">private</span> Stack&lt;<span class="keyword">double</span>&gt; stack = <span class="keyword">new</span> Stack&lt;<span class="keyword">double</span>&gt;();

<span class="keyword">public</span> <span class="keyword">double</span> CalculatedResult
{
	<span class="keyword">get</span>
	{
		<span class="keyword">if</span> (result == <span class="keyword">null</span>)
			<span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">"Must apply AstCalculator to the AST first."</span>);

		<span class="keyword">return</span> result.Value;
	}
}
</pre></figure>

<p>As all numbers are treated as doubles, the result will be a double as well. The result can be retrieved through the <strong>CalculatedResult</strong> property, but only once the calculation has been performed - thus we check whether the result is null or not.</p>
<p>While traversing the AST to perform the calculations we maintain state through the use of a generic stack of doubles.</p>
<figure class="highlight cs"><pre><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OutStart</span>(Start node)
{
	<span class="keyword">if</span> (stack.Count != <span class="number">1</span>)
		<span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Stack should contain only one element at end."</span>);

	result = stack.Pop();
}
</pre></figure>

<p>When starting out the stack will be empty. Once we’ve traversed the tree the stack should only contain a single element - the result. To ensure there’s no errors we make sure the stack only contains a single element, after which we return it by popping it from the stack.</p>
<figure class="highlight cs"><pre><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">InANumberExp</span>(ANumberExp node)
{
	stack.Push(Convert.ToDouble(node.GetNumber().Text.Trim(), <span class="keyword">new</span> CultureInfo(<span class="string">"en-us"</span>)));
}
</pre></figure>

<p>Probably the most important unary operator is the constant number. Whenever we’re in a <strong>ANumberExp</strong> node we read in the number and push it onto the stack.</p>
<figure class="highlight cs"><pre><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OutASqrtExp</span>(ASqrtExp node)
{
	stack.Push(Math.Sqrt(stack.Pop()));
}
</pre></figure>

<p>The other unary operators follow the same pattern. We pop the stack and perform a math operation on the popped value, after which we push the result back onto the stack.</p>
<figure class="highlight cs"><pre><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OutAMulExp</span>(AMulExp node)
{
	stack.Push(stack.Pop() * stack.Pop());
}
</pre></figure>

<p>The associative operators are simple in that they have no requirements as to which order the input parameters are in. As such, a multiplication simple pops two numbers from the stack and push the multiplied result back onto the stack.</p>
<figure class="highlight cs"><pre><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OutASubExp</span>(ASubExp node)
{
	<span class="keyword">double</span> numB = stack.Pop();

	stack.Push(stack.Pop() - numB);
}
</pre></figure>

<p>The non associative opreators need to first pop one number and store it in a temporary variable. The reason we need to do this is that we’re working with a <a href="http://en.wikipedia.org/wiki/FIFO_%28computing%29" target="_blank">FIFO</a> stack, meaning the second number will not be the topmost on the stack and thus we can’t perform the calculation in a single expression.</p>
<p>Now that we’ve made the AstCalculator class we just need to modify the main method so it runs the calculator.</p>
<figure class="highlight cs"><pre><span class="comment">// Print tree</span>
AstPrinter printer = <span class="keyword">new</span> AstPrinter();
ast.Apply(printer);

<span class="comment">// Calculate expression</span>
AstCalculator calculator = <span class="keyword">new</span> AstCalculator();
ast.Apply(calculator);

Console.WriteLine(<span class="string">"Calculation result: "</span> + calculator.CalculatedResult);
</pre></figure>

<p>Simply instantiate a new <strong>AstCalculator</strong> after printing the AST, and then apply it to the AST. If you make the above modification and run the program, you should see an output similar to this:</p>
<div class="imgwrapper" style=""><div><a href="/writing-a-calculator-in-csharp-using-sablecc/simplecalc_calculation_2.jpg" class="fancy"><img src="/writing-a-calculator-in-csharp-using-sablecc/simplecalc_calculation_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Lo and behold, the result is identical to the one provided by Google originally!</p>
<h2 id="Wrapping_up">Wrapping up</h2>
<p>I’ve now shown how we can define a language grammar in SableCC and have it auto generate a parser for us. Using the SableCC parser we can read an input string and transform it into an abstract syntax tree. Once we have the abstract syntax tree, we can easily traverse it and modify it.</p>
<p>While SableCC originally was only able to generate Java output, we now have multiple options for the output language. Unfortunately the generated C# classes are not partial - a feature that would’ve been very useful once we start doing more advanced stuff with the AST. It’s rather easy to modify the six source files manually, as well as setting up an automated script to do it for us.</p>
<p>Once we read the input and transformed it into an AST we used stack based approach to traverse it and calculate sub results in a very simple way, emulating how most higher level languages work internally.</p>
<p>I’ll be following up on this post later on by extending the grammar and interpreter functionality.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Sep</span>
			<span class="day">25</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/iis7-w3wp-process-hung-on-shutdown/" title="IIS 7 w3wp Process Hung on Shutdown" rel="bookmark">IIS 7 w3wp Process Hung on Shutdown</a></h1>
		<div class="categories">
			
				<a href="/category/IIS/">IIS</a>
				, 
			
				<a href="/category/Windbg/">Windbg</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>A single server has started to sometime leave zombie w3wp.exe processes when trying to recycle. A new process is spawned properly and everything seems to work, except the old processes are still present and take up memory. Task manager reports there’s only a single thread left, far from the active ones that have between 40 and 70 threads usually.  Using <a href="http://technet.microsoft.com/en-us/sysinternals/dd996900.aspx" target="_blank">ProcDump</a> I’ve taken a full memory dump to analyze further in <a href="http://www.microsoft.com/whdc/DevTools/Debugging/default.mspx" target="_blank">WinDbg</a>.  The machine is a Server 2008 R2 x64 8 core machine as stated by WinDbg:</p>
<a id="more"></a>


<figure class="highlight"><pre>Windows <span class="number">7</span> <span class="keyword">Version</span> <span class="number">7600</span> MP (<span class="number">8</span> procs) Free x64
</pre></figure>

<p>After loading sos a printout of the managed threads reveals the following:</p>
<figure class="highlight"><pre><span class="number">0</span>:<span class="number">000</span>&gt; !threads
ThreadCount: <span class="number">19</span>
UnstartedThread: <span class="number">0</span>
BackgroundThread: <span class="number">19</span>
PendingThread: <span class="number">0</span>
DeadThread: <span class="number">0</span>
Hosted Runtime: no
                                              PreEmptive                                                Lock
       ID OSID        ThreadOBJ     State   GC     GC Alloc <span class="keyword">Context</span>                  Domain           <span class="keyword">Count</span> APT Exception
XXXX    <span class="number">1</span>  <span class="number">9</span>d0 <span class="number">000000000209</span>b4c0      <span class="number">8220</span> <span class="keyword">Enabled</span>  <span class="number">0000000000000000</span>:<span class="number">0000000000000000</span> <span class="number">000000000208e770</span>     <span class="number">0</span> Ukn
XXXX    <span class="number">2</span>  c60 <span class="number">00000000020</span>c3130      b220 <span class="keyword">Enabled</span>  <span class="number">000000013</span>fbe5ed0:<span class="number">000000013</span>fbe7da8 <span class="number">000000000208e770</span>     <span class="number">0</span> MTA (Finalizer)
XXXX    <span class="number">3</span>  a24 <span class="number">00000000020</span>f0d60   <span class="number">880</span>a220 <span class="keyword">Enabled</span>  <span class="number">0000000000000000</span>:<span class="number">0000000000000000</span> <span class="number">000000000208e770</span>     <span class="number">0</span> MTA (Threadpool Completion Port)
XXXX    <span class="number">4</span>  <span class="number">97</span>c <span class="number">0000000002105180</span>    <span class="number">80</span>a220 <span class="keyword">Enabled</span>  <span class="number">0000000000000000</span>:<span class="number">0000000000000000</span> <span class="number">000000000208e770</span>     <span class="number">0</span> MTA (Threadpool Completion Port)
XXXX    <span class="number">5</span>  c28 <span class="number">000000000210</span>bfe0      <span class="number">1220</span> <span class="keyword">Enabled</span>  <span class="number">0000000000000000</span>:<span class="number">0000000000000000</span> <span class="number">000000000208e770</span>     <span class="number">0</span> Ukn
XXXX    <span class="number">6</span>  d40 <span class="number">00000000053</span>f9080   <span class="number">180</span>b220 <span class="keyword">Enabled</span>  <span class="number">00000001</span>bfe75d20:<span class="number">00000001</span>bfe767c8 <span class="number">000000000208e770</span>     <span class="number">0</span> MTA (Threadpool Worker)
XXXX    <span class="number">7</span>  c18 <span class="number">00000000053</span>f9b30   <span class="number">180</span>b220 <span class="keyword">Enabled</span>  <span class="number">00000000</span>fff95880:<span class="number">00000000</span>fff97210 <span class="number">000000000208e770</span>     <span class="number">0</span> MTA (Threadpool Worker)
XXXX    <span class="number">8</span>  f7c <span class="number">00000000053</span>fa5e0   <span class="number">180</span>b220 <span class="keyword">Enabled</span>  <span class="number">000000011</span>fbea268:<span class="number">000000011</span>fbea920 <span class="number">000000000208e770</span>     <span class="number">0</span> MTA (Threadpool Worker)
XXXX    <span class="number">9</span>  <span class="number">91</span>c <span class="number">00000000053</span>fb090   <span class="number">180</span>b220 <span class="keyword">Enabled</span>  <span class="number">00000001</span>dfc39138:<span class="number">00000001</span>dfc39670 <span class="number">000000000208e770</span>     <span class="number">0</span> MTA (Threadpool Worker)
XXXX    a  fb0 <span class="number">00000000053</span>fbd20   <span class="number">180</span>b220 <span class="keyword">Enabled</span>  <span class="number">00000000</span>fff922b0:<span class="number">00000000</span>fff93210 <span class="number">000000000208e770</span>     <span class="number">0</span> MTA (Threadpool Worker)
XXXX    b  fc8 <span class="number">00000000053</span>fc9b0   <span class="number">180</span>b220 <span class="keyword">Enabled</span>  <span class="number">0000000160053</span>ea0:<span class="number">0000000160054778</span> <span class="number">000000000208e770</span>     <span class="number">0</span> MTA (Threadpool Worker)
XXXX    c  <span class="number">538</span> <span class="number">00000000053</span>fd460   <span class="number">180</span>b220 <span class="keyword">Enabled</span>  <span class="number">000000017</span>fd8fc98:<span class="number">000000017</span>fd911f8 <span class="number">000000000208e770</span>     <span class="number">0</span> MTA (Threadpool Worker)
XXXX    d  <span class="number">604</span> <span class="number">00000000053</span>fdf10   <span class="number">180</span>b220 <span class="keyword">Enabled</span>  <span class="number">000000019</span>fd7aa78:<span class="number">000000019</span>fd7c648 <span class="number">000000000208e770</span>     <span class="number">0</span> MTA (Threadpool Worker)
   <span class="number">0</span>    f  <span class="number">2</span>cc <span class="number">0000000005514</span>c60       <span class="number">220</span> <span class="keyword">Enabled</span>  <span class="number">0000000000000000</span>:<span class="number">0000000000000000</span> <span class="number">000000000208e770</span>     <span class="number">0</span> Ukn
XXXX   <span class="number">10</span>  <span class="number">9</span>bc <span class="number">00000000020</span>a90c0       <span class="number">220</span> <span class="keyword">Enabled</span>  <span class="number">0000000000000000</span>:<span class="number">0000000000000000</span> <span class="number">000000000208e770</span>     <span class="number">0</span> Ukn
XXXX   <span class="number">11</span>  <span class="number">9</span>c0 <span class="number">00000000056</span>b7a00       <span class="number">220</span> <span class="keyword">Enabled</span>  <span class="number">0000000000000000</span>:<span class="number">0000000000000000</span> <span class="number">000000000208e770</span>     <span class="number">0</span> Ukn
XXXX    e  <span class="number">9</span>d4 <span class="number">00000000056</span>b7fd0       <span class="number">220</span> <span class="keyword">Enabled</span>  <span class="number">0000000000000000</span>:<span class="number">0000000000000000</span> <span class="number">000000000208e770</span>     <span class="number">0</span> Ukn
XXXX   <span class="number">12</span>  <span class="number">9</span>d8 <span class="number">00000000056</span>b85a0       <span class="number">220</span> <span class="keyword">Enabled</span>  <span class="number">0000000000000000</span>:<span class="number">0000000000000000</span> <span class="number">000000000208e770</span>     <span class="number">0</span> Ukn
XXXX   <span class="number">13</span>  cb8 <span class="number">00000000056</span>b8b70       <span class="number">220</span> <span class="keyword">Enabled</span>  <span class="number">0000000000000000</span>:<span class="number">0000000000000000</span> <span class="number">000000000208e770</span>     <span class="number">0</span> Ukn
</pre></figure>

<p>Of more interest however is probably the output of a stack backtrace for the single unmanaged thread remaining:</p>
<figure class="highlight"><pre><span class="number">0</span>:<span class="number">000</span>&gt; ~* kb <span class="number">2000</span>

<span class="label">.  0  Id: 85c.2cc Suspend: -1 Teb:</span> <span class="number">000007</span>ff<span class="escape">`f</span>ffd3000 Unfrozen
<span class="label">RetAddr           : Args to Child                                                           :</span> Call Site
<span class="number">000007</span>fe<span class="escape">`f</span>dcc1843 : <span class="number">00000000</span><span class="escape">`0</span>0fd6b60 <span class="number">00000000</span><span class="escape">`0</span>0fd6b60 ffffffff<span class="escape">`f</span>fffffff <span class="number">00000000</span><span class="escape">`7</span>7bc04a0 : ntdll!ZwClose+<span class="number">0</span>xa
<span class="number">00000000</span><span class="escape">`7</span>7ab2c41 : <span class="number">00000000</span><span class="escape">`7</span>7bc1670 <span class="number">00000000</span><span class="escape">`0</span>0000000 <span class="number">00000000</span><span class="escape">`7</span>7bc04a0 <span class="number">7</span>fffffff<span class="escape">`f</span>fffffff : KERNELBASE!CloseHandle+<span class="number">0</span>x13
<span class="number">000007</span>fe<span class="escape">`f</span>56537c6 : <span class="number">00000000</span><span class="escape">`0</span>0000000 <span class="number">00000000</span><span class="escape">`0</span>0000000 <span class="number">00000000</span><span class="escape">`0</span>12da080 <span class="number">000007</span>fe<span class="escape">`f</span>5442eac : kernel32!CloseHandleImplementation+<span class="number">0</span>x3d
<span class="number">000007</span>fe<span class="escape">`f</span>54443d2 : <span class="number">00000000</span><span class="escape">`0</span>0000007 <span class="number">000007</span>fe<span class="escape">`f</span>5443d3c <span class="number">00000000</span><span class="escape">`0</span>0000000 <span class="number">00000000</span><span class="escape">`7</span>7bc9997 : httpapi!HttpCloseRequestQueue+<span class="number">0</span>xa
<span class="number">000007</span>fe<span class="escape">`f</span>54444c3 : <span class="number">00000000</span><span class="escape">`0</span>0000000 <span class="number">00000000</span><span class="escape">`0</span>12e6900 <span class="number">00000000</span><span class="escape">`0</span>0000000 <span class="number">00000000</span><span class="escape">`7</span>7bd5afa : w3dt!UL_APP_POOL::Cleanup+<span class="number">0</span>x62
<span class="number">000007</span>fe<span class="escape">`f</span>549384a : <span class="number">00000000</span><span class="escape">`0</span>12da080 <span class="number">00000000</span><span class="escape">`0</span>0c93a28 <span class="number">00000000</span><span class="escape">`0</span>12e6900 <span class="number">00000000</span><span class="escape">`0</span>0000000 : w3dt!WP_CONTEXT::CleanupOutstandingRequests+<span class="number">0</span>x83
<span class="number">000007</span>fe<span class="escape">`f</span>549417a : <span class="number">00000000</span><span class="escape">`0</span>0000000 <span class="number">00000000</span><span class="escape">`0</span>000ffff <span class="number">00000000</span><span class="escape">`0</span>0000000 <span class="number">00000000</span><span class="escape">`7</span>7bcf9fd : iiscore!W3_SERVER::StopListen+<span class="number">0</span>x4a
<span class="number">000007</span>fe<span class="escape">`f</span>562b5bf : <span class="number">00000000</span><span class="escape">`0</span>12d2f30 <span class="number">00000000</span><span class="escape">`0</span>0000000 <span class="number">00000000</span><span class="escape">`0</span>0000000 <span class="number">00000000</span><span class="escape">`0</span>000ffff : iiscore!IISCORE_PROTOCOL_MANAGER::StopListenerChannel+<span class="number">0</span>x5a
<span class="number">000007</span>fe<span class="escape">`f</span>5626e8f : <span class="number">00000000</span><span class="escape">`0</span>12d2f30 <span class="number">00000000</span><span class="escape">`0</span>0000000 <span class="number">00000000</span><span class="escape">`0</span>0424380 <span class="number">00000000</span><span class="escape">`0</span>0000000 : w3wphost!LISTENER_CHANNEL_STOP_WORKITEM::ExecuteWorkItem+<span class="number">0</span>x7b
<span class="number">00000000</span><span class="escape">`7</span>7bcf8eb : <span class="number">00000000</span><span class="escape">`0</span>21782b0 <span class="number">00000000</span><span class="escape">`0</span>21782b0 <span class="number">00000000</span><span class="escape">`0</span>0000000 <span class="number">00000000</span><span class="escape">`0</span>0000001 : w3wphost!W3WP_HOST::ExecuteWorkItem+<span class="number">0</span>xf
<span class="number">00000000</span><span class="escape">`7</span>7bc9d9f : <span class="number">00000000</span><span class="escape">`0</span>0000000 <span class="number">00000000</span><span class="escape">`0</span>12d2f30 <span class="number">00000000</span><span class="escape">`0</span>0424380 <span class="number">00000000</span><span class="escape">`0</span>10aa528 : ntdll!RtlpTpWorkCallback+<span class="number">0</span>x16b
<span class="number">00000000</span><span class="escape">`7</span>7aaf56d : <span class="number">00000000</span><span class="escape">`0</span>0000000 <span class="number">00000000</span><span class="escape">`0</span>0000000 <span class="number">00000000</span><span class="escape">`0</span>0000000 <span class="number">00000000</span><span class="escape">`0</span>0000000 : ntdll!TppWorkerThread+<span class="number">0</span>x5ff
<span class="number">00000000</span><span class="escape">`7</span>7be3281 : <span class="number">00000000</span><span class="escape">`0</span>0000000 <span class="number">00000000</span><span class="escape">`0</span>0000000 <span class="number">00000000</span><span class="escape">`0</span>0000000 <span class="number">00000000</span><span class="escape">`0</span>0000000 : kernel32!BaseThreadInitThunk+<span class="number">0</span>xd
<span class="number">00000000</span><span class="escape">`0</span>0000000 : <span class="number">00000000</span><span class="escape">`0</span>0000000 <span class="number">00000000</span><span class="escape">`0</span>0000000 <span class="number">00000000</span><span class="escape">`0</span>0000000 <span class="number">00000000</span><span class="escape">`0</span>0000000 : ntdll!RtlUserThreadStart+<span class="number">0</span>x1d
</pre></figure>

<p>From the stack trace it’s obvious that the w3wp process is trying to shut down and perform its cleanup tasks, but for some reason ntdll!ZwClose is hanging up. It’s been hung for several days without change - and without apparent side effects besides an increased amount of memory usage.</p>
<p>The w3wp processes do not hang up all the time, I have yet to find a reproducible pattern. In the meantime, any suggestions for further debugging?</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Sep</span>
			<span class="day">23</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/iis-request-filtering-woes/" title="IIS Request Filtering Woes" rel="bookmark">IIS Request Filtering Woes</a></h1>
		<div class="categories">
			
				<a href="/category/IIS/">IIS</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I recently put a number of load balanced websites in production by using the newly released <a href="http://www.iis.net/extensions/ApplicationRequestRouting" target="_blank">IIS7 Application Request Routing</a> v2 Beta extension. Everything seemed to run perfectly both performance and functionality wise. There was a slight problem however.</p>
<a id="more"></a>

<p>Some users were reporting mysterious errors when uploading files to the website, apparently seeming like a timeout. When I tried to reproduce, all smallish files when through, though larger files did fail. I checked out the responses in <a href="http://www.fiddler2.com/fiddler2/" target="_blank">Fiddler</a> and to my surprise the ones working returned 200 while the failing ones returned a 404 error after a while. To the trained eye, the problem might already be apparent - unfortunately it wasn’t apparent to me at the time. I’d expect a status 200 for working uploads and a 500 for failed uploads. A 404 should only happen when the URL is wrong, which certainly shouldn’t vary depending on file size.</p>
<p>Circumventing the ARR load balancing server fixed the issue, so I quickly pinpointed that the addition of the ARR load balancer was the root cause. Enabling IIS logging on the content servers revealed that the failing requests never reached the content servers, hinting that the actual problem occurred on the ARR machine before even being proxied on to the content servers.</p>
<p>Checking out the IIS log of the ARR server revealed the following crucial line (unimportant parts abbreviated):</p>
<figure class="highlight"><pre>[DATETIME] [USER_IP] <span class="keyword">GET</span> / - <span class="number">80</span> - [USER_IP] [UserAgent] <span class="number">404</span> <span class="number">13</span> <span class="number">0</span> <span class="number">1</span>
</pre></figure>

<p>The HTTP status code is 404 as shown by Fiddler. The interesting part however is the HTTP substatus code of 13. Checking up on the HTTP substatus codes utilized by the <a href="http://www.iis.net/ConfigReference/system.webServer/security/requestFiltering" target="_blank">IIS7 Request Filtering module</a> revals that 404.13 is caused by a too large content length. If the ARR IIS had spat out a detailed IIS error page instead of a generic 404, the problem would have been apparent much quicker since the substatus code would’ve been included. Unfortunately the detailed errors are disabled on the ARR ISS for security reasons.</p>
<p>The solution is simple. By opening the <a href="http://learn.iis.net/page.aspx/124/introduction-to-applicationhostconfig/" target="_blank">C:WindowsSystem32inetsrvconfigapplicationHost.config</a> (the main IIS configuration file) and setting the <a href="http://msdn.microsoft.com/en-us/library/ms689462.aspx" target="_blank">maxAllowedContentLength</a><br>in system.webServer/security/requestFiltering/requestLimits to a higher value, we automatically allow larger bodies for incoming requests and thus avoiding the 404.13 error caused by the request filtering module. In the below example I’ve set the limit to 256 MB - the value is expressed in bytes.</p>
<figure class="highlight xml"><pre><span class="tag">&lt;<span class="title">system.webServer</span>&gt;</span>
	<span class="tag">&lt;<span class="title">security</span>&gt;</span>
		<span class="tag">&lt;<span class="title">requestFiltering</span>&gt;</span>
			<span class="tag">&lt;<span class="title">requestLimits</span> <span class="attribute">maxAllowedContentLength</span>=<span class="value">"268435456"</span> /&gt;</span>
		<span class="tag">&lt;/<span class="title">requestFiltering</span>&gt;</span>
	<span class="tag">&lt;/<span class="title">security</span>&gt;</span>
<span class="tag">&lt;/<span class="title">system.webServer</span>&gt;</span>
</pre></figure>

<p>Tip: Instead of editing the applicationHost.config file manually you can also install the <a href="http://blogs.msdn.com/carlosag/archive/2008/05/13/IISAdminPackTechnicalPreview2Released.aspx" target="_blank">IIS Admin Pack Tech Preview 2</a> which will give you the option to edit request filtering settings directly from the IIS Manager, as well as a number of other management GUI improvements.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Sep</span>
			<span class="day">16</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/combining-paths-with-multiple-parts/" title="Combining Paths With Multiple Parts" rel="bookmark">Combining Paths With Multiple Parts</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Whenever you concatenate multiple strings into a path, you really ought to be using the <a href="http://msdn.microsoft.com/en-us/library/system.io.path.aspx" target="_blank">System.IO.Path</a> class’s Combine method. At times you may be concatenating a number of smaller parts of a path instead of just the two that the <a href="http://msdn.microsoft.com/en-us/library/fyy7a5kt.aspx" target="_blank">Path.Combine()</a> method takes. Nested Path.Combine calls quickly become difficult to read and error prone:</p>
<a id="more"></a>


<figure class="highlight cs"><pre><span class="keyword">string</span> partOne = <span class="string">@"C:"</span>;
<span class="keyword">string</span> partTwo = <span class="string">"Windows"</span>;
<span class="keyword">string</span> partThree = <span class="string">@"System32\drivers"</span>;
<span class="keyword">string</span> partFour = <span class="string">@"etc\hosts"</span>;
<span class="keyword">string</span> combinedPath;

combinedPath = Path.Combine(Path.Combine(Path.Combine(partOne, partTwo), partThree), partFour);
</pre></figure>

<p>Often we won’t have all of our path parts in named variables, and even when we do, they’ll rarely be named partOne, partTwo, partX etc. If we mix literal strings with variables and multiple levels of nested Path.Combine calls, mayhem will arise.</p>
<p>As an alternative I’m using a simple wrapper method above the Path.Combine method:</p>
<figure class="highlight cs"><pre><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> PathCombiner
{
	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">Combine</span>(<span class="keyword">string</span> path1, <span class="keyword">string</span> path2, <span class="keyword">params</span> <span class="keyword">string</span>[] pathn)
	{
		<span class="keyword">string</span> path = Path.Combine(path1, path2);

		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pathn.Length; i++)
			path = Path.Combine(path, pathn[i]);

		<span class="keyword">return</span> path;
	}
}
</pre></figure>

<p>The C# <a href="http://msdn.microsoft.com/en-us/library/w5zay9db(VS.71" target="_blank">params</a>.aspx) keyword allows us to make a method take in any number of parameters of the same type - string in this case. Note that I’ve split the paths up into three parts - path1, path2 and pathn. If we were to only take the params string[] parameter, the user might send in no parameters at all - which wouldn’t make sense. By forcing the user to send in at least two paths, we maintain the interface of Path.Combine and just add extra functionality on top of it - though the user may still just send in two paths as before.</p>
<figure class="highlight cs"><pre><span class="keyword">static</span> <span class="keyword">void</span> Main(<span class="keyword">string</span>[] args)
{
	<span class="keyword">string</span> partOne = <span class="string">@"C:"</span>;
	<span class="keyword">string</span> partTwo = <span class="string">"Windows"</span>;
	<span class="keyword">string</span> partThree = <span class="string">@"System32\drivers"</span>;
	<span class="keyword">string</span> partFour = <span class="string">@"etc\hosts"</span>;
	<span class="keyword">string</span> combinedPath;

	<span class="comment">// Using System.IO.Path</span>
	combinedPath = Path.Combine(Path.Combine(Path.Combine(partOne, partTwo), partThree), partFour);
	Console.WriteLine(combinedPath);
	
	<span class="comment">// Using PathCombiner</span>
	combinedPath = PathCombiner.Combine(partOne, partTwo, partThree, partFour);
	Console.WriteLine(combinedPath);

	Console.Read();
}
</pre></figure>

<p>An extension method you say? The logical place to put this function would be in the Path class itself, perhaps named CombineMultiple. Unfortunately the Path class is static so we’re unable to extend it. Another option might be directly on string as a CombinePath method like this:</p>
<figure class="highlight cs"><pre><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> PathCombiner
{
	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">Combine</span>(<span class="keyword">string</span> path1, <span class="keyword">string</span> path2, <span class="keyword">params</span> <span class="keyword">string</span>[] pathn)
	{
		<span class="keyword">string</span> path = Path.Combine(path1, path2);

		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pathn.Length; i++)
			path = Path.Combine(path, pathn[i]);

		<span class="keyword">return</span> path;
	}

	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">CombinePath</span>(<span class="keyword">this</span> <span class="keyword">string</span> path1, <span class="keyword">string</span> path2, <span class="keyword">params</span> <span class="keyword">string</span>[] pathn)
	{
		<span class="keyword">return</span> Combine(path1, path2, pathn);
	}
}
</pre></figure>

<p>We’d call the extension method like so:</p>
<figure class="highlight cs"><pre>combinedPath = partOne.CombinePath(partTwo).CombinePath(partThree).CombinePath(partFour);
</pre></figure>

<p>While this does work, I really don’t recommend it. I’m against overly use of extension methods unless there’s a good reason. I think it’s much cleaner to contain this code in a separate class whose only purpose is path combining. Now devs are going to be confused when they sometimes see the CombinePath method in Intellisense and not at other times, depending on whether the namespace has been imported. Also, I think the PathCombiner.Combine syntax is the cleanest on top of that, but you be the judge:</p>
<figure class="highlight cs"><pre><span class="keyword">string</span> partOne = <span class="string">@"C:"</span>;
<span class="keyword">string</span> partTwo = <span class="string">"Windows"</span>;
<span class="keyword">string</span> partThree = <span class="string">@"System32\drivers"</span>;
<span class="keyword">string</span> partFour = <span class="string">@"etc\hosts"</span>;
<span class="keyword">string</span> combinedPath;

<span class="comment">// Using System.IO.Path</span>
combinedPath = Path.Combine(Path.Combine(Path.Combine(partOne, partTwo), partThree), partFour);
Console.WriteLine(combinedPath);

<span class="comment">// Using PathCombiner</span>
combinedPath = PathCombiner.Combine(partOne, partTwo, partThree, partFour);
Console.WriteLine(combinedPath);

combinedPath = partOne.CombinePath(partTwo).CombinePath(partThree).CombinePath(partFour);
Console.WriteLine(combinedPath);

Console.Read();
</pre></figure>


<figure class="highlight cs"><pre>C:\Windows\System32\drivers\etc\hosts
C:\Windows\System32\drivers\etc\hosts
C:\Windows\System32\drivers\etc\hosts
</pre></figure>



				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Sep</span>
			<span class="day">12</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/the-cost-of-latent-logging-code/" title="The Cost of Latent Logging Code" rel="bookmark">The Cost of Latent Logging Code</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Logging is an integral part of most applications, whether it’s for logging performance metrics or causality data. Avoiding performance hits due to logging can be tricky though as we don’t want to spend CPU cycles on the logging infrastructure when logging is disabled, while still keeping the full logging ability when required.</p>
<a id="more"></a>

<p>Imagine the following scenario in which we want to log an exception in our application:</p>
<figure class="highlight cs"><pre>Logger.Log(<span class="string">"An error occured at "</span> + DateTime.Now + <span class="string">" on computer "</span> + Environment.MachineName + <span class="string">" in process"</span> + Process.GetCurrentProcess().ProcessName + <span class="string">"."</span>);
</pre></figure>

<p>Inside the Logger.Log method we may have a check for whether logging is enabled like the following:</p>
<figure class="highlight cs"><pre><span class="keyword">if</span>(LoggingEnabled)
	File.AppendAllText(<span class="string">"Log.txt"</span>, logMessage + Environment.NewLine);
</pre></figure>

<p>What’s the problem? Although we do not touch the file system when logging is disabled, we still incur the rather large overhead of string concatenation and retrieving the machine and process name. Usually this overhead will be even larger depending on what extra information is logged as part of the actual log message. Yes, we could append the machine and process names within the Logger.Log method, but that’s beyond the problem I’m describing.</p>
<p>We can avoid this by checking for LoggingEnabled in our actual application code:</p>
<figure class="highlight cs"><pre><span class="keyword">if</span>(Logger.LoggingEnabled)
	Logger.Log(<span class="string">"An error occured at "</span> + DateTime.Now + <span class="string">" on computer "</span> + Environment.MachineName + <span class="string">" in process"</span> + Process.GetCurrentProcess().ProcessName + <span class="string">"."</span>);
</pre></figure>

<p>While this does save us from doing string concatenation and retrieving other data when logging is disabled, it’s rather ugly to have logging checks scattered around the application code.</p>
<p>An alternative to sending a log message directly to the Logger.Log method would be to send a Func that fetches the log message if needed:</p>
<figure class="highlight cs"><pre><span class="keyword">public</span> <span class="keyword">class</span> Logger
{
	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Log</span>(Func&lt;<span class="keyword">string</span>&gt; message)
	{
		<span class="keyword">if</span> (LoggingEnabled)
			File.AppendAllText(<span class="string">"Log.txt"</span>, message() + Environment.NewLine);
	}
}
</pre></figure>


<figure class="highlight cs"><pre>Logger.Log(() =&gt; <span class="string">"An error occured at "</span> + DateTime.Now + <span class="string">" on computer "</span> + Environment.MachineName + <span class="string">" in process"</span> + Process.GetCurrentProcess().ProcessName + <span class="string">"."</span>);
</pre></figure>

<p>This has the big benefit of only executing the actual logging message functionality if logging is enabled, thus reducing the overhead to a near zero.</p>
<p>While this is rather straight forward as long as the logging is performed synchrounously, there’s a pitfall if we perform asynchronous logging. Take the following asynchronous Logger implementation as an example:</p>
<figure class="highlight cs"><pre><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> Logger
{
	<span class="keyword">private</span> <span class="keyword">static</span> Queue&lt;Func&lt;<span class="keyword">string</span>&gt;&gt; logMessages = <span class="keyword">new</span> Queue&lt;Func&lt;<span class="keyword">string</span>&gt;&gt;();
	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> LoggingEnabled { <span class="keyword">get</span>; <span class="keyword">set</span>; }

	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Log</span>(Func&lt;<span class="keyword">string</span>&gt; message)
	{
		<span class="keyword">if</span> (LoggingEnabled)
			logMessages.Enqueue(message);
	}

	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">FlushMessages</span>()
	{
		<span class="keyword">while</span>(logMessages.Count &gt; <span class="number">0</span>)
			File.AppendAllText(<span class="string">"Log.txt"</span>, logMessages.Dequeue()() + Environment.NewLine);
	}
}
</pre></figure>

<p>Instead of outputting the log message to the log file immediately when the Log function is called, we now store the actual log messages in a <a href="http://en.wikipedia.org/wiki/FIFO_(computing" target="_blank">FIFO</a>) queue. At some point we’ll call Logger.FlushMessages to flush out the messages to the text file. To optimize the process we’d usually concatenate the messages in a StringBuilder and perform just a single sequential write to disk, but to KISS I’m just writing out the messages one by one.</p>
<p>We’ll perform a number of logs using the following code:</p>
<figure class="highlight cs"><pre><span class="keyword">string</span> date = DateTime.Now.ToString();

Logger.Log(<span class="string">"An error occured at "</span> + DateTime.Now + <span class="string">" ("</span> + date + <span class="string">") on computer "</span> + Environment.MachineName + <span class="string">" in process"</span> + Process.GetCurrentProcess().ProcessName + <span class="string">"."</span>);
</pre></figure>

<p>If you open the log file, you’ll notice a discrepancy between the two dates that are logged, while you might expect them to be identical. As the actual lambda function is performed at log flush time instead of log time, the DateTime.Now variable will include the flush moment instead of the original logging moment.</p>
<p>The solution in this case is simple. All we need to do is to store the results of the log Funcs instead of the actual funcs:</p>
<figure class="highlight cs"><pre><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> Logger
{
	<span class="keyword">private</span> <span class="keyword">static</span> Queue&lt;<span class="keyword">string</span>&gt; logMessages = <span class="keyword">new</span> Queue&lt;<span class="keyword">string</span>&gt;();
	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> LoggingEnabled { <span class="keyword">get</span>; <span class="keyword">set</span>; }

	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Log</span>(Func&lt;<span class="keyword">string</span>&gt; message)
	{
		<span class="keyword">if</span> (LoggingEnabled)
			logMessages.Enqueue(message());
	}

	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">FlushMessages</span>()
	{
		<span class="keyword">while</span>(logMessages.Count &gt; <span class="number">0</span>)
			File.AppendAllText(<span class="string">"Log.txt"</span>, logMessages.Dequeue() + Environment.NewLine);
	}
}
</pre></figure>

<p>We can still implement asynchronous logging, as long as the actual log message is retrieved synchronously or we make sure the logging Func only references local immutable variables - though the last case kinda destroys the performance gain.</p>
<figure class="highlight cs"><pre><span class="keyword">string</span> date = DateTime.Now.ToString();

Logger.Log(() =&gt; <span class="string">"An error occured at "</span> + date + <span class="string">" on computer "</span> + Environment.MachineName + <span class="string">" in process"</span> + Process.GetCurrentProcess().ProcessName + <span class="string">"."</span>);
</pre></figure>

<p>To sum up the speed gains of using deferrered lambda logging, I’ve implemented a simple synchronous Logger implementation:</p>
<figure class="highlight cs"><pre><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> Logger
{
	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> LoggingEnabled { <span class="keyword">get</span>; <span class="keyword">set</span>; }

	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Log</span>(<span class="keyword">string</span> message)
	{
		<span class="keyword">if</span> (LoggingEnabled)
			File.AppendAllText(<span class="string">"Log.txt"</span>, message + Environment.NewLine);
	}

	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Log</span>(Func&lt;<span class="keyword">string</span>&gt; message)
	{
		<span class="keyword">if</span> (LoggingEnabled)
			File.AppendAllText(<span class="string">"Log.txt"</span>, message() + Environment.NewLine);
	}
}
</pre></figure>

<p>And to perform the actual performance measurements I’m using my <a href="http://www.improve.dk/blog/2008/04/16/profiling-code-the-easy-way" target="_blank">CodeProfiler</a> class with 1000 iterations of the logging code:</p>
<figure class="highlight cs"><pre>class Program
{
	<span class="keyword">static</span> <span class="keyword">void</span> Main(<span class="keyword">string</span>[] args)
	{
		Logger.LoggingEnabled = <span class="keyword">true</span>;
		<span class="keyword">var</span> timeWithLoggingEnabled = profileCode();
		<span class="keyword">var</span> lambdaTimeWithLoggingEnabled = profileLambdaCode();

		Logger.LoggingEnabled = <span class="keyword">false</span>;
		<span class="keyword">var</span> timeWithLoggingDisabled = profileCode();
		<span class="keyword">var</span> lambdaTimeWithLoggingDisabled = profileLambdaCode();

		Console.WriteLine(<span class="string">"Logging enabled: "</span> + timeWithLoggingEnabled.TotalMilliseconds);
		Console.WriteLine(<span class="string">"Lambda logging enabled: "</span> + lambdaTimeWithLoggingEnabled.TotalMilliseconds);
		Console.WriteLine(<span class="string">"Logging disabled: "</span> + timeWithLoggingDisabled.TotalMilliseconds);
		Console.WriteLine(<span class="string">"Lambda logging disabled: "</span> + lambdaTimeWithLoggingDisabled.TotalMilliseconds);
		Console.Read();
	}

	<span class="keyword">static</span> TimeSpan profileCode()
	{
		<span class="keyword">return</span> CodeProfiler.ProfileAction(() =&gt;
		{
			Logger.Log(<span class="string">"An error occured at "</span> + DateTime.Now + <span class="string">" on computer "</span> + Environment.MachineName + <span class="string">" in process"</span> + Process.GetCurrentProcess().ProcessName + <span class="string">"."</span>);
		}, <span class="number">1000</span>);
	}

	<span class="keyword">static</span> TimeSpan profileLambdaCode()
	{
		<span class="keyword">return</span> CodeProfiler.ProfileAction(() =&gt;
		{
			Logger.Log(() =&gt; <span class="string">"An error occured at "</span> + DateTime.Now + <span class="string">" on computer "</span> + Environment.MachineName + <span class="string">" in process"</span> + Process.GetCurrentProcess().ProcessName + <span class="string">"."</span>);
		}, <span class="number">1000</span>);
	}
}
</pre></figure>

<p>The results:</p>
<blockquote><br>Logging enabled: 1440,2764<br>Lambda logging enabled: 1483,0738<br>Logging disabled: 763,1717<br>Lambda logging disabled: 0,6516<br></blockquote>

<p>As we can see from the results, even with logging disabled it still costs us 763ms using the normal logging procedure. By deferring the execution of the log message we only incur an overhead of 0,65ms when logging is disabled. When logging is enabled the execution costs are ~identical.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Aug</span>
			<span class="day">24</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/making-the-aspnet-state-service-work-across-network/" title="Making the ASP.NET State Service Work Across Network" rel="bookmark">Making the ASP.NET State Service Work Across Network</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				, 
			
				<a href="/category/IIS/">IIS</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Once you start distributing your ASP.NET website across multiple webservers, you’re going to need a way to share session state. That is, unless your app is stateless, in which case scaling it should be a breeze!</p>
<a id="more"></a>

<p>One of the easiest ways to provide common session state for a small cluster (very dependant on load and hardware specs, but ~10 servers max, per state server), is to use the built-in ASP.NET State Service. It’s a free service that’s installed alongside the .NET Framework on all Windows servers.</p>
<p>While the InProc session storage is stored directly in the w3wp process, the ASP.NET State Service is an independant process that runs alongside your IIS w3wp processes. The State Service does not have to run on a machine with IIS installed - it can run on a machine dedicated to serving session state for other web servers running IIS.</p>
<h2 id="Performance">Performance</h2>
<p>Switching from InProc to State Service <em>will</em> have an impact on performance. We now have to cross not only process boundaries, but also machine boundaries. Furthermore, once we go out-of-process, all objects will have to be serialized, requiring extra work and requires all objects to be marked with the <a href="http://msdn.microsoft.com/en-us/library/system.serializableattribute.aspx" target="_blank">[Serializable]</a> attribute.</p>
<p>The State Service performance is heavily reliant on memory. Once physical memory has been exhausted it’ll start paging to disk which will kill performance quickly. Make sure to monitor the memory load on your State Service machine(s) and adjust memory accordingly.</p>
<h2 id="Enabling_remote_connectivity">Enabling remote connectivity</h2>
<p>By default, the State Service will only allow local-to-machine connections. To allow remote connections you’ll have to set the HKLMSYSTEMCurrentControlSetServicesaspnet_stateParametersAllowRemoteConnection key to a value of ‘1’. After changing the AllowRemoveConnection key value, you’ll have to restart the State Service service for the change to take effect. Also make sure your firewall allows connectivity to the State Service port (TCP 42424 by default).</p>
<h2 id="Requirements">Requirements</h2>
<ul>
<li>All session objects must be serializable.</li>
<li>All IIS websites that are to share session state must have a common IIS application path (the ID column in the sites list). I strongly recommend you look into the IIS7 <a href="http://learn.iis.net/page.aspx/264/shared-configuration/" target="_blank">Shared Configuration</a> feature as it’ll help you keep all the web servers IIS7 configuration in synch, including the application path.</li>
<li>All websites that are to share session state must have the same <a href="http://msdn.microsoft.com/en-us/library/ms998288.aspx" target="_blank"><machineKey /></a> values so they’re able to read one anothers sessions. You can <a href="http://aspnetresources.com/tools/keycreator.aspx" target="_blank">generate the keys online</a>.</li>
</ul>
<h2 id="Scalability">Scalability</h2>
<p>If you start saturating your dedicated State Service machine, it’s possible to implement session state partitioning by implementing the<a href="http://msdn.microsoft.com/en-us/library/system.web.ipartitionresolver.aspx" target="_blank">System.Web.IPartitionResolver</a> interface. By creating your own implementating, you can route new requests to different state servers and perhaps even check whether the state servers are available or not, to add redundancy. Note however that this will not give you redundancy in case the State Service crashes either due to software or hardware.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Aug</span>
			<span class="day">17</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/devlink-2009-followup/" title="devLink 2009 Followup" rel="bookmark">devLink 2009 Followup</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I’m finally sitting in the train on my way home from the Airport and an excellent week spent in Nashville, also known as Nash Vegas.</p>
<a id="more"></a>

<p>First of all, major kudos go out to <a href="http://www.johnkellar.com/" target="_blank">John Kellar (@johnkellar)</a> and the rest of the <a href="http://www.devlink.net/" target="_blank">devLINK</a> team. I still can’t believe the amazing quality of devLINK as a conference, the speaker lineup, food, party, etc, all for a price of just $75! From what I gathered, there were only three international participants at devLINK this year, including me and <a href="http://www.twitter.com/KasperVesth" target="_blank">@KasperVesth</a> - if devLINK continues its current path, I’m sure there’ll be plenty more next year.</p>
<p>Also thanks to Elijah Manor for giving me and <a href="http://www.twitter.com/KasperVesth" target="_blank">@KasperVesth</a> a ride home from <a href="http://www.lipscomb.edu/" target="_blank">Lipscomb</a> - cabs are nowhere to be found out there! Likewise, thanks to John Doe (sorry, can’t remember your name!) from who we hitched a ride back to the Sheraton from Lipscomb after having walked a mile down the road and realized cabs weren’t around.</p>
<p>Besides having to reboot my laptop at the last minute due to my virtual machines not recognizing my network, I think the presentation went quite well. Not as many people as I’d hoped for, but I guess having the last slot with a narrow topic is a challenge in that regard.</p>
<p>You can download my <a href="http://www.improve.dk/downloads/Speech_NLB.rar" target="_blank">code, slides and videos here</a>. I’ve not included the virtual PCs since they’d take up around 40GB to download.</p>
<p>I hope I’ll be able to join you again next year, providing the economy &amp; work schedule allows it :)</p>
<div class="imgwrapper" style=""><div><a href="/devlink-2009-followup/devlink1_2.jpg" class="fancy"><img src="/devlink-2009-followup/devlink1_2.jpg" style="max-height: 250px"/></a></div></div>

<p><em><a href="http://twitter.com/gainesk" target="_blank">Gaines Kergosien</a> in his chainmail at the Community Leadership Summit the day before devLINK.</em></p>
<div class="imgwrapper" style=""><div><a href="/devlink-2009-followup/devlink2_2.jpg" class="fancy"><img src="/devlink-2009-followup/devlink2_2.jpg" style="max-height: 250px"/></a></div></div>

<p><em>The outdoor eating area.</em></p>
<div class="imgwrapper" style=""><div><a href="/devlink-2009-followup/devlink3_2.jpg" class="fancy"><img src="/devlink-2009-followup/devlink3_2.jpg" style="max-height: 250px"/></a></div></div>

<p><em>I’ve never seen this high a concentration of guitars at any conference!</em></p>
<div class="imgwrapper" style=""><div><a href="/devlink-2009-followup/devlink4_2.jpg" class="fancy"><img src="/devlink-2009-followup/devlink4_2.jpg" style="max-height: 250px"/></a></div></div>

<p><em>The main entrance at Lipscomb University - perfect venue for the event. Could’ve used more cabs in the vicinity however.</em></p>
<div class="imgwrapper" style=""><div><a href="/devlink-2009-followup/devlink5_2.jpg" class="fancy"><img src="/devlink-2009-followup/devlink5_2.jpg" style="max-height: 250px"/></a></div></div>

<div class="imgwrapper" style=""><div><a href="/devlink-2009-followup/devlink6_2.jpg" class="fancy"><img src="/devlink-2009-followup/devlink6_2.jpg" style="max-height: 250px"/></a></div></div>

<p><em>Hands down the best conference party I’ve attended. Free buffet at the local Nashville Sounds baseball game. Awesome.</em></p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jul</span>
			<span class="day">08</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/iis7-the-object-identifier-does-not-represent-a-valid-object/" title="The Object Identifier Does Not Represent a Valid Object" rel="bookmark">The Object Identifier Does Not Represent a Valid Object</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				, 
			
				<a href="/category/IIS/">IIS</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>When adding sites to IIS7 either by script or by editing the config files directly, you may receive an error in the sites list that says:</p>
<a id="more"></a>

<blockquote>
<p>Unknown: The object identifier does not represent a valid object. (Exception from HRESULT: 0x800710D8)</p>
</blockquote>
<div class="imgwrapper" style=""><div><a href="/iis7-the-object-identifier-does-not-represent-a-valid-object/iisvalidobject_2.jpg" class="fancy"><img src="/iis7-the-object-identifier-does-not-represent-a-valid-object/iisvalidobject_2.jpg" style="max-height: 250px"/></a></div></div>

<p>I’m running multiple servers in an NLB setup, using the shared configuration feature of IIS7 (config files are stored on a SAN exposed through a CIFS share). My first thoughts were that this was probably related to the shared configuration / network access, but I’m able to reproduce the problem even with location configuration. An interesting observation is that all IIS’s on all servers using the shared config will display the same errors on the same sites.</p>
<p>Restarting the sites, app pool or even IIS does not help on the issue, neither does restarting the IIS Manager itself. I have not tried restarting the servers, and I’m not going to.</p>
<p>The only relevant info I could find on Google was <a href="http://forums.iis.net/t/1151841.aspx" target="_blank">this thread</a> on forums.iis.net. Besides various mutations of the restart option, the thread mentions it might be a permissions issue. I’m running IIS Manager under an administrative account and all application pools run under processes with access to the configuration directory. Running Process Monitor confirms that there are no permission issues.</p>
<p>What I’ve found since then is that a simple file tocuh will fix the problem. That is, if I open the file in notepad and make/undo a change and save the file, all IIS’s will reload the configuration and all sites will have loaded correctly on all servers. Using Process Monitor I’ve verified that change notifications are being sent out to all servers, thereby notifying them of an update to the configuration, causing the reload in IIS. The aforementioned thread does note that IIS will basically start a timer with an interval of a few ms before it’ll update the site list of a config change - if reading the config file takes longer than this timeout, we may be in trouble. However, this issue should be fixed by a refresh and most certainly by a restart of the IIS. Also, since this is happening on all servers, it would seem weird that they all exceed the timeout.</p>
<p>To add confusion, this bug is temporal. If I add three sites programmaticaly (three transactions - they’re not committed all at once, but in succession) using code like this:</p>
<figure class="highlight cs"><pre><span class="keyword">using</span> (ServerManager mgr = <span class="keyword">new</span> ServerManager())
{
	<span class="keyword">if</span> (mgr.Sites[name] != <span class="keyword">null</span>)
		mgr.Sites.Remove(mgr.Sites[name]);

	<span class="comment">// Create site</span>
	Site site = mgr.Sites.Add(name, <span class="string">"http"</span>, <span class="string">"*:80:"</span> + domain, physicalPath);

	<span class="comment">// Set app pool</span>
	<span class="keyword">foreach</span> (<span class="keyword">var</span> app <span class="keyword">in</span> site.Applications)
		app.ApplicationPoolName = pool;

	<span class="comment">// Add extra bindings</span>
	<span class="keyword">foreach</span> (<span class="keyword">string</span> hostname <span class="keyword">in</span> extraBindings)
		site.Bindings.Add(<span class="string">"*:80:"</span> + hostname, <span class="string">"http"</span>);

	mgr.CommitChanges();
}
</pre></figure>

<p>Sometimes all sites work, sometimes 1-3 of them don’t. Usually two of them will have failed while one will be working. Running the exact code again will fix the problem. The code is made so it’ll just recreate a website if it already exists and thus running the code again will basically just touch the file, causing reloads of the config files across the servers. If I try to access the sites programmatically, I’ll receive the same exception as is displayed in the IIS Manager and as a result I might actually be able to detect this issue and just keep retrying until all sites work.</p>
<p>As an alternative, I’ve also tried just generating the complete applicationHost.config file from scratch so that all changes are definitely made at the same time. By creating the applicationHost.config file separately and then replacing the old one, I don’t get the “valid object” error any more. However, a random number of websites &amp; pools will be in the “stopped” state for no apparent reason. All sites &amp; pools have the auto start attributes set to true. I can start the sites manully without problems, it’s not a good solution though seeing as there’s hundreds of sites and it’ll take a considerably amount of time to start half of them manually. Fortunately that part is easy to script:</p>
<figure class="highlight cs"><pre><span class="keyword">using</span> (ServerManager mgr = <span class="keyword">new</span> ServerManager())
{
	<span class="comment">// Start all app pools</span>
	<span class="keyword">foreach</span> (<span class="keyword">var</span> pool <span class="keyword">in</span> mgr.ApplicationPools)
		pool.Start();

	log(<span class="string">"Pools started - Done"</span>);

	<span class="comment">// Start all sites</span>
	<span class="keyword">foreach</span> (<span class="keyword">var</span> site <span class="keyword">in</span> mgr.Sites)
		site.Start();

	log(<span class="string">"Sites started - Done"</span>);
}
</pre></figure>

<p>Anyone else experiencing this issue and have found the cause? Or do you have a better workaround than what I’m doing?</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">May</span>
			<span class="day">06</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/tricky-sql-server-decimal-math/" title="Tricky SQL Server Decimal Math" rel="bookmark">Tricky SQL Server Decimal Math</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - Data Types/">SQL Server - Data Types</a>
				, 
			
				<a href="/category/SQL Server - Optimization/">SQL Server - Optimization</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>SQL Server datatypes are not always what they seem to be. <a href="http://www.performanceduo.com/" target="_blank">Martin Schmidt</a> recently had an <a href="http://www.performanceduo.com/post/Gc3a6t-en-Datatype-.aspx" target="_blank">interesting blog post (in danish)</a> regarding implicit decimal conversion that sparked my interest.</p>
<a id="more"></a>

<p>Let me sketch up the scenario. We have a simple table with a decimal column like so:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tblDecimalTest
(
	DecimalColumn <span class="keyword">dec</span>(<span class="number">5</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>
)</span>
</pre></figure>

<p>Note that the DecimalColumn has a precision of five and a scale of two. That basically boils down to 999.99 being the largest number we can store and -999.99 being the smallest. The precision of five defines the maximum number of digits in the number, scale defines the number of digits to the right of the decimal point. If we insert an integer value of 999 it’ll have .00 stored implicity, thus we can’t insert neither 1000 nor 10000 without any decimal digits. Knowing the configured precision and scale is important, as we’ll see in just a moment.</p>
<p>Let us insert a single row into the tblDecimalTest table.</p>
<figure class="highlight sql"><pre>DECLARE @Decimal1 dec(5,2) = 20.5
DECLARE @Decimal2 dec(5,2) = 27.52
<span class="operator"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tblDecimalTest (DecimalColumn) <span class="keyword">VALUES</span> (@Decimal1 / @Decimal2)</span>
</pre></figure>

<p>This is the result if we perform a select on the table:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tblDecimalTest

DecimalColumn
<span class="number">0.74</span></span>
</pre></figure>

<p>Both decimal variables were declared as dec(5,2) so it matches the column in the table. Calculating 20.5 / 27.52 on a standard calculator gives a result of 0.7449127, but as we’re storing this with a scale of two, the value is rounded off to 0.74.</p>
<p>We just inserted a value of 20.5 / 27.52 into a dec(5,2) column. Let’s make a select using those same variables:</p>
<figure class="highlight sql"><pre>DECLARE @Decimal1 dec(5,2) = 20.5
DECLARE @Decimal2 dec(5,2) = 27.52
<span class="operator"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tblDecimalTest <span class="keyword">WHERE</span> DecimalColumn = @Decimal1 / @Decimal2

Results:
(<span class="number">0</span> <span class="keyword">row</span>(s) affected)</span>
</pre></figure>

<p>What is that? No results! Why does this happen? After all, we just inserted @Decimal1 / @Decimal2, so surely we should be able to select that row again? The key lies in how SQL Server <a href="http://msdn.microsoft.com/en-us/library/ms190476.aspx" target="_blank">converts decimal datatypes during math operations</a>. What we’re looking for is the divison operator which defines the following precision and scale calculations:</p>
<figure class="highlight"><pre>e1 / e2:
Result <span class="keyword">precision</span> = p1 - s1 + s2 + <span class="built_in">max</span>(<span class="number">6</span>, s1 + p2 + <span class="number">1</span>)
Result scale = <span class="built_in">max</span>(<span class="number">6</span>, s1 + p2 + <span class="number">1</span>)
</pre></figure>

<p>Let’s input our values into that formula.</p>
<figure class="highlight"><pre>dec(<span class="number">5</span>,<span class="number">2</span>) <span class="subst">/</span> dec(<span class="number">5</span>,<span class="number">2</span>):
Precision	<span class="subst">=</span> p1<span class="attribute">-s1</span><span class="subst">+</span>s2 <span class="subst">+</span> <span class="keyword">max</span>(<span class="number">6</span>, s1<span class="subst">+</span>p2<span class="subst">+</span><span class="number">1</span>)	<span class="subst">=</span> <span class="number">5</span><span class="subst">-</span><span class="number">2</span><span class="subst">+</span><span class="number">2</span> <span class="subst">+</span> <span class="keyword">max</span>(<span class="number">6</span>, <span class="number">2</span><span class="subst">+</span><span class="number">5</span><span class="subst">+</span><span class="number">1</span>)		<span class="subst">=</span> <span class="number">5</span> <span class="subst">+</span> <span class="keyword">max</span>(<span class="number">6</span>,<span class="number">8</span>)	<span class="subst">=</span> <span class="number">5</span><span class="subst">+</span><span class="number">8</span> <span class="subst">=</span> <span class="number">13</span>
Scale		<span class="subst">=</span> <span class="keyword">max</span>(<span class="number">6</span>, s1<span class="subst">+</span>p2<span class="subst">+</span><span class="number">1</span>)		<span class="subst">=</span> <span class="keyword">max</span>(<span class="number">6</span>, <span class="number">2</span><span class="subst">+</span><span class="number">5</span><span class="subst">+</span><span class="number">1</span>)			<span class="subst">=</span> <span class="keyword">max</span>(<span class="number">6</span>,<span class="number">8</span>)	<span class="subst">=</span> <span class="number">8</span>
<span class="keyword">Type</span>		<span class="subst">=</span> dec(<span class="number">13</span>,<span class="number">8</span>)
</pre></figure>

<p>Thus, our division of two dec(5,2) variables is implicitly converted into a dec(13,8) value! Similar conversions are made for addition, subtraction and multiplication.</p>
<figure class="highlight"><pre>dec(<span class="number">5</span>,<span class="number">2</span>) <span class="subst">+</span> dec(<span class="number">5</span>,<span class="number">2</span>), dec(<span class="number">5</span>,<span class="number">2</span>) <span class="subst">-</span> dec(<span class="number">5</span>,<span class="number">2</span>):
Precision	<span class="subst">=</span> <span class="keyword">max</span>(s1, s2) <span class="subst">+</span> <span class="keyword">max</span>(p1<span class="attribute">-s1</span>, p2<span class="attribute">-s2</span>) <span class="subst">+</span> <span class="number">1</span>	<span class="subst">=</span> <span class="keyword">max</span>(<span class="number">5</span>, <span class="number">5</span>) <span class="subst">+</span> <span class="keyword">max</span>(<span class="number">3</span>, <span class="number">3</span>) <span class="subst">+</span> <span class="number">1</span>	<span class="subst">=</span> <span class="number">5</span><span class="subst">+</span><span class="number">3</span><span class="subst">+</span><span class="number">1</span>	<span class="subst">=</span> <span class="number">9</span>
Scale		<span class="subst">=</span> <span class="keyword">max</span>(<span class="number">2</span>, <span class="number">2</span>)				<span class="subst">=</span> <span class="number">2</span>
<span class="keyword">Type</span>		<span class="subst">=</span> dec(<span class="number">9</span>,<span class="number">2</span>)

dec(<span class="number">5</span>,<span class="number">2</span>) <span class="subst">*</span> dec(<span class="number">5</span>,<span class="number">2</span>):
Precision	<span class="subst">=</span> p1<span class="subst">+</span>p2<span class="subst">+</span><span class="number">1</span>	<span class="subst">=</span> <span class="number">5</span><span class="subst">+</span><span class="number">5</span><span class="subst">+</span><span class="number">1</span>	<span class="subst">=</span> <span class="number">11</span>
Scale		<span class="subst">=</span> s1<span class="subst">+</span><span class="number">2</span>		<span class="subst">=</span> <span class="number">2</span><span class="subst">+</span><span class="number">2</span>	<span class="subst">=</span> <span class="number">4</span>
<span class="keyword">Type</span>		<span class="subst">=</span> dec(<span class="number">11</span>,<span class="number">4</span>)
</pre></figure>

<p>Let’s try and check the division result directly:</p>
<figure class="highlight sql"><pre>DECLARE @Decimal1 dec(5,2) = 20.5
DECLARE @Decimal2 dec(5,2) = 27.52
<span class="operator"><span class="keyword">SELECT</span> @Decimal1 / @Decimal2

(<span class="keyword">No</span> <span class="keyword">column</span> name)
<span class="number">0.74491279</span></span>
</pre></figure>

<p>When performing the WHERE clause, we’re in fact comparing a dec(5,2) column with a dec(13,8) value. Behind the scenes, SQL Server will implicitly convert the values to a common datatype that fits both - which is dec(13,8). With a precision of 13 and a scale of 8, 0.74 and 0.74491279 are not equal, and thus we don’t get any results back. If we were to cast the divison as a dec(5,2) explicitly, we would find the row:</p>
<figure class="highlight sql"><pre>DECLARE @Decimal1 dec(5,2) = 20.5
DECLARE @Decimal2 dec(5,2) = 27.52
<span class="operator"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tblDecimalTest <span class="keyword">WHERE</span> DecimalColumn = <span class="keyword">CAST</span>(@Decimal1 / @Decimal2 <span class="keyword">AS</span> <span class="keyword">dec</span>(<span class="number">5</span>,<span class="number">2</span>))

DecimalColumn
<span class="number">0.74</span></span>
</pre></figure>

<p>While testing in SQL Server Management Studio, this might be an obvious problem. When encountering the same problem from code, it’s much more difficult to notice - especially if you don’t know the precise schema you’re working against. Observe the following code working on an empty tblDecimalTest table.</p>
<figure class="highlight cs"><pre><span class="keyword">using</span>(SqlConnection conn = <span class="keyword">new</span> SqlConnection(<span class="string">@"Data Source=.SQL2008;Initial Catalog=Test;Integrated Security=SSPI"</span>))
{
	<span class="keyword">using</span>(SqlCommand cmd = conn.CreateCommand())
	{
		<span class="keyword">decimal</span> dec1 = <span class="number">20.5</span>M;
		<span class="keyword">decimal</span> dec2 = <span class="number">27.52</span>M;

		cmd.CommandText = <span class="string">"INSERT INTO tblDecimalTest (DecimalColumn) VALUES (@DecimalValue)"</span>;
		cmd.Parameters.Add(<span class="string">"@DecimalValue"</span>, SqlDbType.Decimal).Value = dec1 / dec2;

		conn.Open();
		cmd.ExecuteNonQuery();

		cmd.CommandText = <span class="string">"SELECT COUNT(*) FROM tblDecimalTest WHERE DecimalColumn = @DecimalValue"</span>;
		Console.WriteLine(<span class="string">"Implicit cast: "</span> + cmd.ExecuteScalar());

		cmd.CommandText = <span class="string">"SELECT COUNT(*) FROM tblDecimalTest WHERE DecimalColumn = CAST(@DecimalValue as dec(5,2))"</span>;
		Console.WriteLine(<span class="string">"Explicit cast: "</span> + cmd.ExecuteScalar());
	}
}
</pre></figure>

<p>The result:</p>
<figure class="highlight"><pre>Implicit <span class="keyword">cast</span>: <span class="number">0</span>
Explicit <span class="keyword">cast</span>: <span class="number">1</span>
</pre></figure>

<p>Without knowledge of the schema, and how SQL Server treats decimal math operations, this could’ve been a tough bug to track down.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>


<div class="paging">
	<a href="/page/14/"><div class="past">« Past</div></a>
	<a href="/page/12/"><div class="future">Future »</div></a>
	<div class="clear"></div>
</div>

				</div>
			</div>

			<div id="asides">
				<div class="categories aside">
					<span class="sectiontitle">CATEGORIES</span>
					<ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/category/.NET/">.NET</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/AS/Flex/Flash/">AS/Flex/Flash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Amazon Web Services/">Amazon Web Services</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Computer Science/">Computer Science</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Conferences and Presenting/">Conferences and Presenting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/IIS/">IIS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Life/">Life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Miscellaneous/">Miscellaneous</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Performance/">Performance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Poker/">Poker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server/">SQL Server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Community/">SQL Server - Community</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Data Types/">SQL Server - Data Types</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Internals/">SQL Server - Internals</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Optimization/">SQL Server - Optimization</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Tricks/">SQL Server - Tricks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Testing/">Testing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Tools of the Trade/">Tools of the Trade</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Umbraco/">Umbraco</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Visual Studio/">Visual Studio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Web/">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windbg/">Windbg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windows/">Windows</a></li></ul>

					
				</div>

				<div class="archive aside">
					<span class="sectiontitle">ARCHIVE</span>
					<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archive/2014">2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2013">2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2012">2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2011">2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2010">2010</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2009">2009</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2008">2008</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2007">2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2006">2006</a></li></ul>
				</div>
			</div>

			<div class="clear"></div>
		</div>
		
		<footer>
			<div class="wrapper">Copyright &copy; 2014 Mark S. Rasmussen</div>
		</footer>

		<script type="text/javascript">
			$(function () {
				// Show mobile menu
				$("li.navicon").click(function () {
					if ($("header ul.mobile a").length == 0) {
						// Pages
						$mobilePages = $("div#naviconcontent ul.pages");
						$("header nav ul.normal > li").not(".navicon").each(function (i, el) {
							$mobilePages.append($(el).clone());
						});

						// Categories
						$mobileCategories = $("div#naviconcontent ul.categories");
						$("div#asides div.categories > ul > li").each(function (i, el) {
							$mobileCategories.append($(el).clone());
						});

						// Archive
						$mobileArchive = $("div#naviconcontent ul.archive");
						$("div#asides div.archive > ul > li").each(function (i, el) {
							$mobileArchive.append($(el).clone());
						});
					};

					$("header ul.mobile").toggle();
				});

				// Fancybox setup
				$("a.fancy").fancybox({
					hideOnContentClick: true,
					overlayShow: true
				});
			});
		</script>
	</body>
</html>