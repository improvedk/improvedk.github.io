<!DOCTYPE html>
<html>
	

<head>
	<title>Mark S. Rasmussen</title>
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
	<meta charset="UTF-8" />
	<meta property="og:locale" content="en_US" />
	<meta property="og:type" content="website" />
	<meta name="google-site-verification" content="alt7-wfK3ZujMQ4D0jYNd0yC5LGetGdqBlBmZsqQlVw" />
	<link rel="alternative" href="http://feeds.feedburner.com/Improvedk" title="Mark S. Rasmussen" type="application/atom+xml">
	<script src="/js/combined.js"></script>
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-2479580-1', 'improve.dk');
		ga('send', 	'pageview');
	</script>
	<link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
	<body>
		<div id="headerline"></div>
	
		<header>
			<div class="wrapper">
				<div id="title">
					<a href="/">Mark S. Rasmussen</a> <span>improve.dk</span>
				</div>
				
				<nav>
					<ul class="normal">
						<li class="navicon"><img src="/img/navicon.png" /></li>
						<li><a href="/about-me/">About Me</a></li>
					</ul>
				</nav>
				
				<ul id="sharing">
					<li><a href="mailto:mark@improve.dk"><img src="/img/at.png" /></a></li>
					<li><a href="http://feeds.feedburner.com/Improvedk" id="rssfeed"><img src="/img/rss.png" /></a></li>
					<li><a href="https://twitter.com/improvedk"><img src="/img/twitter.png" /></a></li>
					<li><a href="https://github.com/improvedk"><img src="/img/github.png" /></a></li>
					<li><a href="https://www.linkedin.com/in/markrasmussen/"><img src="/img/linkedin.png" /></a></li>
				</ul>

				<div class="clear"></div>
				
				<div id="naviconcontent">
					<ul class="mobile">
						<li>
							Pages
							<ul class="pages"></ul>
						</li>
						<li>
							Categories
							<ul class="categories"></ul>
						</li>
						<li>
							Archive
							<ul class="archive"></ul>
						</li>
					</ul>
				</div>
			</div>
		</header>

		<div id="mainwrapper">
			<div id="contentwrapper">
				<div id="content">
				
					
	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">May</span>
			<span class="day">23</span>
		</div>
		<div class="lower">2013</div>
	</div>

	<div class="title">
		<h1><a href="/could-not-load-type-newrelic-agent-core-agentapi/" title="Could Not Load Type &#39;NewRelic.Agent.Core.AgentApi&#39;" rel="bookmark">Could Not Load Type &#39;NewRelic.Agent.Core.AgentApi&#39;</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Recently I’ve begun using <a href="http://newrelic.com/" target="_blank">New Relic</a>, and so far it’s been an excellent experience. About two weeks ago I started using their <a href="https://newrelic.com/docs/dotnet/the-net-agent-api" target="_blank">.NET Agent API</a> to customize some of the data reported by our application to their servers. This makes the data way more valuable to us as we can now selectively ignore certain parts of our application while getting better reporting from other, more critical, parts of the application.</p>
<a id="more"></a>

<h2 id="Random_Outages">Random Outages</h2>
<p>Unfortunately, in the last couple of weeks, ever since introducing the .NET Agent API, we’ve had a number of outages (thankfully invisible to the customers due to a self-healing load-balancer setup shielding the individual application servers) where one of our applications servers would randomly start throwing the same exception on all requests:</p>
<figure class="highlight"><pre>System.TypeLoadException: Could not <span class="operator"><span class="keyword">load</span> type <span class="string">'NewRelic.Agent.Core.AgentApi'</span> <span class="keyword">from</span> assembly <span class="string">'NewRelic.Api.Agent, Version=2.5.112.0, Culture=neutral, PublicKeyToken=06552fced0b33d87'</span>. 
<span class="keyword">at</span> NewRelic.Api.Agent.NewRelic.SetTransactionName(String category, String name) 
<span class="keyword">at</span> System.Web.HttpApplication.SyncEventExecutionStep.System.Web.HttpApplication.IExecutionStep.<span class="keyword">Execute</span>() 
<span class="keyword">at</span> System.Web.HttpApplication.ExecuteStep(IExecutionStep step, Boolean& completedSynchronously)</span>
</pre></figure>

<p>The error seemed to crop up randomly on all of our servers, though not at the same time and in with no predictable patterns - except it was always just after an application pool recycle. Once the error occurred it would continue happening until we either recycled the pool manually or it was recycled automatically according to its schedule.</p>
<h2 id="The_Support_Experience">The Support Experience</h2>
<p>To make a long story short, I opened a support case with New Relic as I couldn’t find anything in neither their docs, nor on Google, related to the specific exception. After about a week of going back and forth between their engineers and me they managed to track down the root cause:</p>
<blockquote>
<p>It appears that some of the caching we do is not being correctly invalidated. I have removed the caching code and you should see this fix in our next release.</p>
</blockquote>
<p>In the meantime I’ve had to stop using the .NET Agent API to avoid the issue from happening again. This doesn’t mean we won’t get any data; it’s just not as well polished as before. I’m eagerly looking forward to the next agent release so we can get back to using the .NET Agent API again.</p>
<p>In conclusion I must say I’m impressed by the overall support experience. The responses have been quick and professional. Naturally I’d prefer not to have had any issues, but we all know they can happen, and in those cases it’s a matter of having a solid triage process - and in this case I’m just happy to be able to assist in identifying the cause.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">May</span>
			<span class="day">21</span>
		</div>
		<div class="lower">2013</div>
	</div>

	<div class="title">
		<h1><a href="/partial-dns-forwarding-using-individual-windows-dns-zones/" title="Partial DNS Forwarding Using Individual Windows DNS Zones" rel="bookmark">Partial DNS Forwarding Using Individual Windows DNS Zones</a></h1>
		<div class="categories">
			
				<a href="/category/Windows/">Windows</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>At our office, all machines are using a local Windows DNS server for their outgoing DNS queries. This allows us to make internal zones like .ipaperlan that points to all of our internal systems, while setting up the DNS server to forward all unknown queries to Google DNS. One feature I’m missing in the standard Windows DNS server is the option to partially forward individual zones. However, there is a workaround that will allow you to setup partial DNS forwarding using individual Windows DNS zones.</p>
<a id="more"></a>

<h2 id="The_Scenario">The Scenario</h2>
<p>Imagine you have a domain <em>improve.dk</em> that already has a number of public DNS records like the following.</p>
<div class="imgwrapper" style=""><div><a href="/partial-dns-forwarding-using-individual-windows-dns-zones/Capture.png" class="fancy"><img src="/partial-dns-forwarding-using-individual-windows-dns-zones/Capture.png" style="max-height: 250px"/></a></div></div>

<p>In this case all I want to do is to add a record on our internal network, <em>jira.improve.dk</em>. As this record should only be made available internally, we can’t just add it to the public DNS records for the domain.</p>
<p>I could make a new DNS zone for the improve.dk domain in our local DNS server, but that would result in all DNS queries for improve.dk being answered by our local DNS server, rather than being forwarded. As long as I recreate all public DNS records in our local DNS server, this would work fine, but it’s not a viable solution as I’d now have to keep the two DNS setups in sync manually.</p>
<h2 id="The_Solution">The Solution</h2>
<p>Instead of creating a zone for the whole improve.dk domain, you can make a zone specifically for just the record you need to add. First right click “Forward Lookup Zones” and select “New Zone…” and then follow these steps (pretty much all defaults):</p>
<div class="imgwrapper" style=""><div><a href="/partial-dns-forwarding-using-individual-windows-dns-zones/1.png" class="fancy"><img src="/partial-dns-forwarding-using-individual-windows-dns-zones/1.png" style="max-height: 250px"/></a></div></div>

<div class="imgwrapper" style=""><div><a href="/partial-dns-forwarding-using-individual-windows-dns-zones/2.png" class="fancy"><img src="/partial-dns-forwarding-using-individual-windows-dns-zones/2.png" style="max-height: 250px"/></a></div></div>

<div class="imgwrapper" style=""><div><a href="/partial-dns-forwarding-using-individual-windows-dns-zones/3.png" class="fancy"><img src="/partial-dns-forwarding-using-individual-windows-dns-zones/3.png" style="max-height: 250px"/></a></div></div>

<div class="imgwrapper" style=""><div><a href="/partial-dns-forwarding-using-individual-windows-dns-zones/4.png" class="fancy"><img src="/partial-dns-forwarding-using-individual-windows-dns-zones/4.png" style="max-height: 250px"/></a></div></div>

<div class="imgwrapper" style=""><div><a href="/partial-dns-forwarding-using-individual-windows-dns-zones/5.png" class="fancy"><img src="/partial-dns-forwarding-using-individual-windows-dns-zones/5.png" style="max-height: 250px"/></a></div></div>

<div class="imgwrapper" style=""><div><a href="/partial-dns-forwarding-using-individual-windows-dns-zones/6.png" class="fancy"><img src="/partial-dns-forwarding-using-individual-windows-dns-zones/6.png" style="max-height: 250px"/></a></div></div>

<p>Now that the zone has been created, simply right click it and choose “New Host (A or AAAA)…”. In the dialog, leave the Name blank as that’ll affect the record itself, while entering the desired IP like so:</p>
<div class="imgwrapper" style=""><div><a href="/partial-dns-forwarding-using-individual-windows-dns-zones/6_b.png" class="fancy"><img src="/partial-dns-forwarding-using-individual-windows-dns-zones/6_b.png" style="max-height: 250px"/></a></div></div>

<div class="imgwrapper" style=""><div><a href="/partial-dns-forwarding-using-individual-windows-dns-zones/7.png" class="fancy"><img src="/partial-dns-forwarding-using-individual-windows-dns-zones/7.png" style="max-height: 250px"/></a></div></div>

<p>And just like that, DNS lookups for jira.improve.dk will now be answered locally while all other requests will be forwarded to whatever DNS server is set up as the forwarding server.</p>
<p><strong>One word of warning</strong> - You might not want to do this on Active Directory domain servers as they’re somewhat more finicky about their DNS setup. I’m honestly not aware of what complications might arise, so I’d advice you to be careful or perhaps find another solution.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">May</span>
			<span class="day">13</span>
		</div>
		<div class="lower">2013</div>
	</div>

	<div class="title">
		<h1><a href="/orcamdf-is-now-available-on-nuget/" title="OrcaMDF Is Now Available on NuGet" rel="bookmark">OrcaMDF Is Now Available on NuGet</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				, 
			
				<a href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Thanks to Justin Dearing (<a href="http://www.justaprogrammer.net/" target="_blank">b</a>|<a href="https://twitter.com/zippy1981" target="_blank">t</a>), OrcaMDF is now available on <a href="https://www.nuget.org/packages/OrcaMDF.Core" target="_blank">NuGet</a>!</p>
<a id="more"></a>

<p>OrcaMDF being on NuGet means the bar just got lowered even more if you want to try it out. Let me show you how easy it is to read the Adventureworks 2008 R2 Database using OrcaMDF:</p>
<p>To begin, let’s create a vanilla .NET <em>Console Application</em>:</p>
<div class="imgwrapper" style=""><div><a href="/orcamdf-is-now-available-on-nuget/1.png" class="fancy"><img src="/orcamdf-is-now-available-on-nuget/1.png" style="max-height: 250px"/></a></div></div>

<p>Once the solution has been made, right click <em>References</em> and go to <em>Manage NuGet Packages</em>:</p>
<div class="imgwrapper" style=""><div><a href="/orcamdf-is-now-available-on-nuget/2.png" class="fancy"><img src="/orcamdf-is-now-available-on-nuget/2.png" style="max-height: 250px"/></a></div></div>

<p>Once the dialog opens, simply search for <em>OrcaMDF</em> and click the <em>Install</em> button for the OrcaMDF.Core package:</p>
<div class="imgwrapper" style=""><div><a href="/orcamdf-is-now-available-on-nuget/3.png" class="fancy"><img src="/orcamdf-is-now-available-on-nuget/3.png" style="max-height: 250px"/></a></div></div>

<p>When done, you should now see a small green checkmark next to the OrcaMDF.Core package:</p>
<div class="imgwrapper" style=""><div><a href="/orcamdf-is-now-available-on-nuget/4.png" class="fancy"><img src="/orcamdf-is-now-available-on-nuget/4.png" style="max-height: 250px"/></a></div></div>

<p>At this point the OrcaMDF.Core assembly will be available and all you have to do is start using it. For example you could print out all of the products along with their prices by modifying the Program.cs file like so (you’ll have to alter the path to AdventureWorks2008R2_Data.mdf file so it points to a local copy (which must not be in use by SQL Server) on your machine):</p>
<figure class="highlight csharp"><pre><span class="keyword">using</span> System;
<span class="keyword">using</span> OrcaMDF.Core.Engine;

<span class="class"><span class="keyword">namespace</span> <span class="title">ConsoleApplication1</span>
{</span>
	<span class="class"><span class="keyword">class</span> <span class="title">Program</span>
	{</span>
		<span class="keyword">static</span> <span class="keyword">void</span> Main()
		{
			<span class="keyword">using</span> (<span class="keyword">var</span> db = <span class="keyword">new</span> Database(@<span class="string">"C:\AdventureWorks2008R2_Data.mdf"</span>))
			{
				<span class="keyword">var</span> scanner = <span class="keyword">new</span> DataScanner(db);

				<span class="keyword">foreach</span> (<span class="keyword">var</span> row in scanner.ScanTable(<span class="string">"Product"</span>))
				{
					Console.WriteLine(row.Field&lt;<span class="keyword">string</span>&gt;(<span class="string">"Name"</span>));
					Console.WriteLine(<span class="string">"Price: "</span> + row.Field&lt;<span class="keyword">double</span>&gt;(<span class="string">"ListPrice"</span>));
					Console.WriteLine();
				}
			}
		}
	}
}
</pre></figure>

<p>And then just running the solution:</p>
<div class="imgwrapper" style=""><div><a href="/orcamdf-is-now-available-on-nuget/5.png" class="fancy"><img src="/orcamdf-is-now-available-on-nuget/5.png" style="max-height: 250px"/></a></div></div>

<p>And there you have it, in just a few quick short steps you’ve now fetched OrcaMDF and read the Products table, from the standard AdventureWorks 2008 R2 database, without even touching SQL Server.</p>
<p>With OrcaMDF now being available on NuGet as well as with <a href="/orcamdf-studio-release-feature-recap/">a simple GUI</a>, it really doesn’t get any simpler to take it for a spin :)</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">May</span>
			<span class="day">07</span>
		</div>
		<div class="lower">2013</div>
	</div>

	<div class="title">
		<h1><a href="/how-to-identify-which-request-caused-a-runaway-thread-using-windbg/" title="How to Identify Which Request Caused a Runaway Thread, Using Windbg" rel="bookmark">How to Identify Which Request Caused a Runaway Thread, Using Windbg</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				, 
			
				<a href="/category/IIS/">IIS</a>
				, 
			
				<a href="/category/Windbg/">Windbg</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>When your w3wp process is stuck at 100% like, <a href="/debugging-in-production-part-1-analyzing-100-cpu-usage-using-windbg/">like when I used a non-thread-safe Dictionary concurrently</a>, you may want to identify what request the runaway thread is actually serving. Let me show you how to identify which request caused a runaway thread, using windbg.</p>
<a id="more"></a>

<p>First you’ll want to identify the process ID (PID) of the w3wp process. In my case, that’s <strong>102600</strong>:</p>
<div class="imgwrapper" style=""><div><a href="/how-to-identify-which-request-caused-a-runaway-thread-using-windbg/Taskmgr.png" class="fancy"><img src="/how-to-identify-which-request-caused-a-runaway-thread-using-windbg/Taskmgr.png" style="max-height: 250px"/></a></div></div>

<p>Next you’ll want to start up Windbg (make sure to use the correct bitness (x86 vs x64) that corresponds to the bitness of your process). Once started, press <strong>F6</strong> to open up the <em>Attach to Process</em> dialog. Once open, enter your process ID and click OK.</p>
<div class="imgwrapper" style=""><div><a href="/how-to-identify-which-request-caused-a-runaway-thread-using-windbg/Attach-to-Process.png" class="fancy"><img src="/how-to-identify-which-request-caused-a-runaway-thread-using-windbg/Attach-to-Process.png" style="max-height: 250px"/></a></div></div>

<p>Doing so should bring up the Command window, ready for your command:</p>
<div class="imgwrapper" style=""><div><a href="/how-to-identify-which-request-caused-a-runaway-thread-using-windbg/Windbg11.png" class="fancy"><img src="/how-to-identify-which-request-caused-a-runaway-thread-using-windbg/Windbg11.png" style="max-height: 250px"/></a></div></div>

<p>As the first thing, start out by loading the <a href="http://msdn.microsoft.com/en-us/library/bb190764.aspx" target="_blank">Son of Strike</a> extension, allowing us to debug managed code.</p>
<figure class="highlight"><pre><span class="number">0</span>:<span class="number">039</span>&gt; <span class="preprocessor">.loadby</span> sos <span class="keyword">clr</span>
</pre></figure>

<p>Then continue by running the !runaway command to get a list of runaway (basically threads using lots of CPU) threads:</p>
<figure class="highlight"><pre>0<span class="pseudo">:039</span>&gt; !<span class="tag">runaway</span>

 <span class="tag">User</span> <span class="tag">Mode</span> <span class="tag">Time</span>
  <span class="tag">Thread</span>       <span class="tag">Time</span>
  20<span class="pseudo">:14930</span>      0 <span class="tag">days</span> 0<span class="pseudo">:21</span><span class="pseudo">:44</span><span class="class">.261</span>
  21<span class="pseudo">:15204</span>      0 <span class="tag">days</span> 0<span class="pseudo">:21</span><span class="pseudo">:00</span><span class="class">.878</span>
  27<span class="pseudo">:19d48</span>      0 <span class="tag">days</span> 0<span class="pseudo">:04</span><span class="pseudo">:23</span><span class="class">.860</span>
  32<span class="pseudo">:18748</span>      0 <span class="tag">days</span> 0<span class="pseudo">:02</span><span class="pseudo">:59</span><span class="class">.260</span>
  31<span class="pseudo">:18bcc</span>      0 <span class="tag">days</span> 0<span class="pseudo">:02</span><span class="pseudo">:19</span><span class="class">.277</span>
  30<span class="pseudo">:19d80</span>      0 <span class="tag">days</span> 0<span class="pseudo">:01</span><span class="pseudo">:44</span><span class="class">.083</span>
  25<span class="pseudo">:19ec0</span>      0 <span class="tag">days</span> 0<span class="pseudo">:01</span><span class="pseudo">:32</span><span class="class">.446</span>
  24<span class="pseudo">:16534</span>      0 <span class="tag">days</span> 0<span class="pseudo">:01</span><span class="pseudo">:31</span><span class="class">.135</span>
  29<span class="pseudo">:19a80</span>      0 <span class="tag">days</span> 0<span class="pseudo">:01</span><span class="pseudo">:08</span><span class="class">.297</span>
  23<span class="pseudo">:19110</span>      0 <span class="tag">days</span> 0<span class="pseudo">:00</span><span class="pseudo">:30</span><span class="class">.591</span>
   6<span class="pseudo">:19b40</span>      0 <span class="tag">days</span> 0<span class="pseudo">:00</span><span class="pseudo">:00</span><span class="class">.109</span>
  26<span class="pseudo">:18a14</span>      0 <span class="tag">days</span> 0<span class="pseudo">:00</span><span class="pseudo">:00</span><span class="class">.015</span>
   0<span class="pseudo">:19dcc</span>      0 <span class="tag">days</span> 0<span class="pseudo">:00</span><span class="pseudo">:00</span><span class="class">.015</span>
  39<span class="pseudo">:16fa8</span>      0 <span class="tag">days</span> 0<span class="pseudo">:00</span><span class="pseudo">:00</span><span class="class">.000</span>
  ...
</pre></figure>

<p>Threads 20 &amp; 21 seem to be the interesting ones. Let’s start out by selecting thread #20 as the active thread:</p>
<figure class="highlight"><pre>0<span class="pseudo">:039</span>&gt; ~20<span class="tag">s</span>

000007<span class="tag">fe</span>`913<span class="tag">a15d9</span> 3<span class="tag">bc5</span>            <span class="tag">cmp</span>     <span class="tag">eax</span>,<span class="tag">ebp</span>
</pre></figure>

<p>Once selected, we can analyze the stack and its parameters by running the !CLRStack command with the -p parameter:</p>
<figure class="highlight"><pre><span class="number">0</span>:<span class="number">020</span>&gt; !CLRStack -p

OS Thread Id: <span class="number">0x14930</span> (<span class="number">20</span>)
        Child SP               IP <span class="keyword">Call</span> Site
<span class="number">000000000</span>dccdb00 <span class="number">000007</span>fe913a15d9 System<span class="preprocessor">.Collections</span><span class="preprocessor">.Generic</span><span class="preprocessor">.Dictionary</span>`<span class="number">2</span>[[System<span class="preprocessor">.Int</span>16, mscorlib],[System.__Canon, mscorlib]]<span class="preprocessor">.FindEntry</span>(Int16)
    PARAMETERS:
        this = &lt;no data&gt;
        key = &lt;no data&gt;

<span class="number">000000000</span>dccdb50 <span class="number">000007</span>fe913a14c0 System<span class="preprocessor">.Collections</span><span class="preprocessor">.Generic</span><span class="preprocessor">.Dictionary</span>`<span class="number">2</span>[[System<span class="preprocessor">.Int</span>16, mscorlib],[System.__Canon, mscorlib]]<span class="preprocessor">.get</span>_Item(Int16)
    PARAMETERS:
        this = &lt;no data&gt;
        key = &lt;no data&gt;

<span class="number">000000000</span>dccdb80 <span class="number">000007</span>fe91421cbb iPaper<span class="preprocessor">.BL</span><span class="preprocessor">.Backend</span><span class="preprocessor">.Modules</span><span class="preprocessor">.Languages</span><span class="preprocessor">.LanguageCache</span><span class="preprocessor">.GetLanguageByID</span>(Int32, iPaper<span class="preprocessor">.BL</span><span class="preprocessor">.Backend</span><span class="preprocessor">.Infrastructure</span><span class="preprocessor">.PartnerConfiguration</span><span class="preprocessor">.IPartnerConfig</span>) [e:\iPaperCMS\BL\Backend\Modules\Languages\LanguageCache<span class="preprocessor">.cs</span> @ <span class="number">44</span>]
    PARAMETERS:
        languageID (<span class="number">0x000000000dccdc20</span>) = <span class="number">0x0000000000000001</span>
        partnerConfig (<span class="number">0x000000000dccdc28</span>) = <span class="number">0x00000000fffc3e50</span>

<span class="number">000000000</span>dccdc20 <span class="number">000007</span>fe91421dfa iPaper<span class="preprocessor">.BL</span><span class="preprocessor">.Backend</span><span class="preprocessor">.Modules</span><span class="preprocessor">.Languages</span><span class="preprocessor">.Language</span><span class="preprocessor">.GetFontFileForLanguage</span>(Int32, iPaper<span class="preprocessor">.BL</span><span class="preprocessor">.Backend</span><span class="preprocessor">.Infrastructure</span><span class="preprocessor">.PartnerConfiguration</span><span class="preprocessor">.IPartnerConfig</span>) [e:\iPaperCMS\BL\Backend\Modules\Languages\Language<span class="preprocessor">.cs</span> @ <span class="number">37</span>]
    PARAMETERS:
        languageID (<span class="number">0x000000000dccdc70</span>) = <span class="number">0x0000000000000001</span>
        partnerConfig (<span class="number">0x000000000dccdc78</span>) = <span class="number">0x00000000fffc3e50</span>

<span class="number">000000000</span>dccdc70 <span class="number">000007</span>fe91417400 iPaper<span class="preprocessor">.Web</span><span class="preprocessor">.FlexFrontend</span><span class="preprocessor">.BL</span><span class="preprocessor">.Common</span><span class="preprocessor">.CachedUrlInformation</span><span class="preprocessor">.GetFromUrlDirectoryPath</span>(System<span class="preprocessor">.String</span>, System<span class="preprocessor">.String</span>, iPaper<span class="preprocessor">.BL</span><span class="preprocessor">.Backend</span><span class="preprocessor">.Infrastructure</span><span class="preprocessor">.PartnerConfiguration</span><span class="preprocessor">.IPartnerConfig</span>) [e:\iPaperCMS\Frontend\BL\Common\CachedUrlInformation<span class="preprocessor">.cs</span> @ <span class="number">89</span>]
    PARAMETERS:
        url (<span class="number">0x000000000dccde80</span>) = <span class="number">0x00000003fff27e30</span>
        host (<span class="number">0x000000000dccde88</span>) = <span class="number">0x00000003fff29618</span>
        partnerConfig (<span class="number">0x000000000dccde90</span>) = <span class="number">0x00000000fffc3e50</span>

<span class="number">000000000</span>dccde80 <span class="number">000007</span>fe91417576 iPaper<span class="preprocessor">.Web</span><span class="preprocessor">.FlexFrontend</span><span class="preprocessor">.BL</span><span class="preprocessor">.Common</span><span class="preprocessor">.CachedUrlInformation</span><span class="preprocessor">.GetFromHttpContext</span>(System<span class="preprocessor">.String</span>, System<span class="preprocessor">.Web</span><span class="preprocessor">.HttpContext</span>, iPaper<span class="preprocessor">.BL</span><span class="preprocessor">.Backend</span><span class="preprocessor">.Infrastructure</span><span class="preprocessor">.PartnerConfiguration</span><span class="preprocessor">.IPartnerConfig</span>) [e:\iPaperCMS\Frontend\BL\Common\CachedUrlInformation<span class="preprocessor">.cs</span> @ <span class="number">122</span>]
    PARAMETERS:
        paperPath (<span class="number">0x000000000dcce010</span>) = <span class="number">0x00000003fff27e30</span>
        context (<span class="number">0x000000000dcce018</span>) = <span class="number">0x00000000fffa6040</span>
        partnerConfig (<span class="number">0x000000000dcce020</span>) = <span class="number">0x00000000fffc3e50</span>

<span class="number">000000000</span>dcce010 <span class="number">000007</span>fe91415529 iPaper<span class="preprocessor">.Web</span><span class="preprocessor">.FlexFrontend</span><span class="preprocessor">.BL</span><span class="preprocessor">.RequestHandler</span><span class="preprocessor">.RequestHandler</span><span class="preprocessor">.loadFrontendContext</span>(System<span class="preprocessor">.String</span>) [e:\iPaperCMS\Frontend\BL\RequestHandler\RequestHandler<span class="preprocessor">.cs</span> @ <span class="number">469</span>]
    PARAMETERS:
        this (<span class="number">0x000000000dcce260</span>) = <span class="number">0x00000000fffa9590</span>
        paperPath (<span class="number">0x000000000dcce268</span>) = <span class="number">0x00000003fff27e30</span>

<span class="number">000000000</span>dcce260 <span class="number">000007</span>fe91414b73 iPaper<span class="preprocessor">.Web</span><span class="preprocessor">.FlexFrontend</span><span class="preprocessor">.BL</span><span class="preprocessor">.RequestHandler</span><span class="preprocessor">.RequestHandler</span><span class="preprocessor">.context</span>_PostAcquireRequestState(System<span class="preprocessor">.Object</span>, System<span class="preprocessor">.EventArgs</span>) [e:\iPaperCMS\Frontend\BL\RequestHandler\RequestHandler<span class="preprocessor">.cs</span> @ <span class="number">95</span>]
    PARAMETERS:
        this (<span class="number">0x000000000dcce5f0</span>) = <span class="number">0x00000000fffa9590</span>
        sender (<span class="number">0x000000000dcce5f8</span>) = <span class="number">0x00000000fffa8a50</span>
        e (<span class="number">0x000000000dcce600</span>) = <span class="number">0x00000000fffaebb0</span>

<span class="number">000000000</span>dcce5f0 <span class="number">000007</span>fedb72c520 System<span class="preprocessor">.Web</span><span class="preprocessor">.HttpApplication</span>+SyncEventExecutionStep<span class="preprocessor">.System</span><span class="preprocessor">.Web</span><span class="preprocessor">.HttpApplication</span><span class="preprocessor">.IExecutionStep</span><span class="preprocessor">.Execute</span>()
    PARAMETERS:
        this = &lt;no data&gt;

<span class="number">000000000</span>dcce650 <span class="number">000007</span>fedb70b745 System<span class="preprocessor">.Web</span><span class="preprocessor">.HttpApplication</span><span class="preprocessor">.ExecuteStep</span>(IExecutionStep, Boolean ByRef)
    PARAMETERS:
        this (<span class="number">0x000000000dcce6f0</span>) = <span class="number">0x00000000fffa8a50</span>
        step (<span class="number">0x000000000dcce6f8</span>) = <span class="number">0x00000000fffabc28</span>
        completedSynchronously (<span class="number">0x000000000dcce700</span>) = <span class="number">0x000000000dcce77a</span>

<span class="number">000000000</span>dcce6f0 <span class="number">000007</span>fedb72a4e1 System<span class="preprocessor">.Web</span><span class="preprocessor">.HttpApplication</span>+PipelineStepManager<span class="preprocessor">.ResumeSteps</span>(System<span class="preprocessor">.Exception</span>)
    PARAMETERS:
        this (<span class="number">0x000000000dcce7d0</span>) = <span class="number">0x00000000fffac718</span>
        error = &lt;no data&gt;

<span class="number">000000000</span>dcce7d0 <span class="number">000007</span>fedb70b960 System<span class="preprocessor">.Web</span><span class="preprocessor">.HttpApplication</span><span class="preprocessor">.BeginProcessRequestNotification</span>(System<span class="preprocessor">.Web</span><span class="preprocessor">.HttpContext</span>, System<span class="preprocessor">.AsyncCallback</span>)
    PARAMETERS:
        this = &lt;no data&gt;
        context = &lt;no data&gt;
        cb = &lt;no data&gt;

<span class="number">000000000</span>dcce820 <span class="number">000007</span>fedb704c8e System<span class="preprocessor">.Web</span><span class="preprocessor">.HttpRuntime</span><span class="preprocessor">.ProcessRequestNotificationPrivate</span>(System<span class="preprocessor">.Web</span><span class="preprocessor">.Hosting</span><span class="preprocessor">.IIS</span>7WorkerRequest, System<span class="preprocessor">.Web</span><span class="preprocessor">.HttpContext</span>)
    PARAMETERS:
        this (<span class="number">0x000000000dcce8c0</span>) = <span class="number">0x00000000fff3fb20</span>
        wr (<span class="number">0x000000000dcce8c8</span>) = <span class="number">0x00000000fffa5eb0</span>
        context (<span class="number">0x000000000dcce8d0</span>) = <span class="number">0x00000000fffa6040</span>

<span class="number">000000000</span>dcce8c0 <span class="number">000007</span>fedb70e771 System<span class="preprocessor">.Web</span><span class="preprocessor">.Hosting</span><span class="preprocessor">.PipelineRuntime</span><span class="preprocessor">.ProcessRequestNotificationHelper</span>(IntPtr, IntPtr, IntPtr, Int32)
    PARAMETERS:
        rootedObjectsPointer = &lt;no data&gt;
        nativeRequestContext (<span class="number">0x000000000dccea58</span>) = <span class="number">0x0000000000ccccc0</span>
        moduleData = &lt;no data&gt;
        flags = &lt;no data&gt;

<span class="number">000000000</span>dccea50 <span class="number">000007</span>fedb70e2c2 System<span class="preprocessor">.Web</span><span class="preprocessor">.Hosting</span><span class="preprocessor">.PipelineRuntime</span><span class="preprocessor">.ProcessRequestNotification</span>(IntPtr, IntPtr, IntPtr, Int32)
    PARAMETERS:
        rootedObjectsPointer = &lt;no data&gt;
        nativeRequestContext = &lt;no data&gt;
        moduleData = &lt;no data&gt;
        flags = &lt;no data&gt;

<span class="number">000000000</span>dcceaa0 <span class="number">000007</span>fedbe6b461 DomainNeutralILStubClass<span class="preprocessor">.IL</span>_STUB_ReversePInvoke(Int64, Int64, Int64, Int32)
    PARAMETERS:
        &lt;no data&gt;
        &lt;no data&gt;
        &lt;no data&gt;
        &lt;no data&gt;

<span class="number">000000000</span>dccf298 <span class="number">000007</span>fef0a9334e [InlinedCallFrame: <span class="number">000000000</span>dccf298] System<span class="preprocessor">.Web</span><span class="preprocessor">.Hosting</span><span class="preprocessor">.UnsafeIISMethods</span><span class="preprocessor">.MgdIndicateCompletion</span>(IntPtr, System<span class="preprocessor">.Web</span><span class="preprocessor">.RequestNotificationStatus</span> ByRef)
<span class="number">000000000</span>dccf298 <span class="number">000007</span>fedb7b9c4b [InlinedCallFrame: <span class="number">000000000</span>dccf298] System<span class="preprocessor">.Web</span><span class="preprocessor">.Hosting</span><span class="preprocessor">.UnsafeIISMethods</span><span class="preprocessor">.MgdIndicateCompletion</span>(IntPtr, System<span class="preprocessor">.Web</span><span class="preprocessor">.RequestNotificationStatus</span> ByRef)
<span class="number">000000000</span>dccf270 <span class="number">000007</span>fedb7b9c4b DomainNeutralILStubClass<span class="preprocessor">.IL</span>_STUB_PInvoke(IntPtr, System<span class="preprocessor">.Web</span><span class="preprocessor">.RequestNotificationStatus</span> ByRef)
    PARAMETERS:
        &lt;no data&gt;
        &lt;no data&gt;

<span class="number">000000000</span>dccf340 <span class="number">000007</span>fedb70e923 System<span class="preprocessor">.Web</span><span class="preprocessor">.Hosting</span><span class="preprocessor">.PipelineRuntime</span><span class="preprocessor">.ProcessRequestNotificationHelper</span>(IntPtr, IntPtr, IntPtr, Int32)
    PARAMETERS:
        rootedObjectsPointer = &lt;no data&gt;
        nativeRequestContext = &lt;no data&gt;
        moduleData = &lt;no data&gt;
        flags = &lt;no data&gt;

<span class="number">000000000</span>dccf4d0 <span class="number">000007</span>fedb70e2c2 System<span class="preprocessor">.Web</span><span class="preprocessor">.Hosting</span><span class="preprocessor">.PipelineRuntime</span><span class="preprocessor">.ProcessRequestNotification</span>(IntPtr, IntPtr, IntPtr, Int32)
    PARAMETERS:
        rootedObjectsPointer = &lt;no data&gt;
        nativeRequestContext = &lt;no data&gt;
        moduleData = &lt;no data&gt;
        flags = &lt;no data&gt;

<span class="number">000000000</span>dccf520 <span class="number">000007</span>fedbe6b461 DomainNeutralILStubClass<span class="preprocessor">.IL</span>_STUB_ReversePInvoke(Int64, Int64, Int64, Int32)
    PARAMETERS:
        &lt;no data&gt;
        &lt;no data&gt;
        &lt;no data&gt;
        &lt;no data&gt;

<span class="number">000000000</span>dccf768 <span class="number">000007</span>fef0a935a3 [ContextTransitionFrame: <span class="number">000000000</span>dccf768]
</pre></figure>

<p>This returns the full stack with a lot of frames that we’re not really interested in. What we’re looking for is the first instance of an HttpContext. If we start from the bottom and work our way up, this seems to be the first time an HttpContext is present:</p>
<figure class="highlight"><pre><span class="number">000000000</span>dcce820 <span class="number">000007</span>fedb704c8e System<span class="preprocessor">.Web</span><span class="preprocessor">.HttpRuntime</span><span class="preprocessor">.ProcessRequestNotificationPrivate</span>(System<span class="preprocessor">.Web</span><span class="preprocessor">.Hosting</span><span class="preprocessor">.IIS</span>7WorkerRequest, System<span class="preprocessor">.Web</span><span class="preprocessor">.HttpContext</span>)
    PARAMETERS:
        this (<span class="number">0x000000000dcce8c0</span>) = <span class="number">0x00000000fff3fb20</span>
        wr (<span class="number">0x000000000dcce8c8</span>) = <span class="number">0x00000000fffa5eb0</span>
        context (<span class="number">0x000000000dcce8d0</span>) = <span class="number">0x00000000fffa6040</span>
</pre></figure>

<p>Knowing that the HttpContext contains a reference to an HttpRequest, and that HttpRequest contains the RawUrl string value, we’ll start digging in. Start out by dumping the HttpContext object using the !do command:</p>
<figure class="highlight"><pre><span class="number">0</span>:<span class="number">020</span>&gt; !do <span class="number">0x00000000fffa6040</span>

<span class="label">Name:</span>        System<span class="preprocessor">.Web</span><span class="preprocessor">.HttpContext</span>
<span class="label">MethodTable:</span> <span class="number">000007</span>fedb896398
<span class="label">EEClass:</span>     <span class="number">000007</span>fedb4882e0
<span class="label">Size:</span>        <span class="number">416</span>(<span class="number">0x1a0</span>) bytes
<span class="label">File:</span>        C:\Windows\Microsoft<span class="preprocessor">.Net</span>\assembly\GAC_64\System<span class="preprocessor">.Web</span>\v4<span class="number">.0</span>_4<span class="number">.0</span><span class="number">.0</span><span class="number">.0</span>__b03f5f7f11d50a3a\System<span class="preprocessor">.Web</span><span class="preprocessor">.dll</span>
<span class="label">Fields:</span>
              MT    Field   Offset                 Type VT     Attr            Value Name
<span class="number">000007</span>fedb897c80  <span class="number">40010</span>a3        <span class="number">8</span> ..<span class="preprocessor">.IHttpAsyncHandler</span>  <span class="number">0</span> instance <span class="number">0000000000000000</span> _asyncAppHandler
<span class="number">000007</span>fedb88e618  <span class="number">40010</span>a4      <span class="number">158</span>         System<span class="preprocessor">.Int</span>32  <span class="number">1</span> instance                <span class="number">0</span> _asyncPreloadModeFlags
<span class="number">000007</span>feef9fdc30  <span class="number">40010</span>a5      <span class="number">168</span>       System<span class="preprocessor">.Boolean</span>  <span class="number">1</span> instance                <span class="number">0</span> _asyncPreloadModeFlagsSet
<span class="number">000007</span>fedb895610  <span class="number">40010</span>a6       <span class="number">10</span> ..<span class="preprocessor">.b</span><span class="preprocessor">.HttpApplication</span>  <span class="number">0</span> instance <span class="number">00000000</span>fffa8a50 _appInstance
<span class="number">000007</span>fedb897ce8  <span class="number">40010</span>a7       <span class="number">18</span> ...<span class="preprocessor">.Web</span><span class="preprocessor">.IHttpHandler</span>  <span class="number">0</span> instance <span class="number">00000003</span>fff28c20 _handler
<span class="number">000007</span>fedb898170  <span class="number">40010</span>a8       <span class="number">20</span> ..<span class="preprocessor">.m</span><span class="preprocessor">.Web</span><span class="preprocessor">.HttpRequest</span>  <span class="number">0</span> instance <span class="number">00000000</span>fffa61f8 _request
<span class="number">000007</span>fedb898550  <span class="number">40010</span>a9       <span class="number">28</span> ...<span class="preprocessor">.Web</span><span class="preprocessor">.HttpResponse</span>  <span class="number">0</span> instance <span class="number">00000000</span>fffa6378 _response
<span class="number">000007</span>fedb893cb0  <span class="number">40010</span>aa       <span class="number">30</span> ..<span class="preprocessor">.HttpServerUtility</span>  <span class="number">0</span> instance <span class="number">00000003</span>fff27ed8 _server
<span class="number">000007</span>feefa05ac0  <span class="number">40010</span>ab       <span class="number">38</span> ..<span class="preprocessor">.Collections</span><span class="preprocessor">.Stack</span>  <span class="number">0</span> instance <span class="number">0000000000000000</span> _traceContextStack
<span class="number">000007</span>fedb8a41d8  <span class="number">40010</span>ac       <span class="number">40</span> ...<span class="preprocessor">.Web</span><span class="preprocessor">.TraceContext</span>  <span class="number">0</span> instance <span class="number">0000000000000000</span> _topTraceContext
<span class="number">000007</span>feefa00548  <span class="number">40010</span>ad       <span class="number">48</span> ..<span class="preprocessor">.ections</span><span class="preprocessor">.Hashtable</span>  <span class="number">0</span> instance <span class="number">00000000</span>fffab198 _items
<span class="number">000007</span>feef9f85e0  <span class="number">40010</span>ae       <span class="number">50</span> ..<span class="preprocessor">.ections</span><span class="preprocessor">.ArrayList</span>  <span class="number">0</span> instance <span class="number">0000000000000000</span> _errors
<span class="number">000007</span>feef9fc588  <span class="number">40010</span>af       <span class="number">58</span>     System<span class="preprocessor">.Exception</span>  <span class="number">0</span> instance <span class="number">0000000000000000</span> _tempError
...
</pre></figure>

<p>This contains a lot of fields (some of which I’ve snipped out). The interesting part however, is this line:</p>
<figure class="highlight"><pre><span class="number">000007</span>fedb898170  <span class="number">40010</span>a8       <span class="number">20</span> ..<span class="preprocessor">.m</span><span class="preprocessor">.Web</span><span class="preprocessor">.HttpRequest</span>  <span class="number">0</span> instance <span class="number">00000000</span>fffa61f8 _request
</pre></figure>

<p>This contains a pointer to the HttpRequest instance. Let’s try dumping that one:</p>
<figure class="highlight"><pre><span class="number">0</span>:<span class="number">020</span>&gt; !do <span class="number">00000000</span>fffa61f8 

<span class="label">Name:</span>        System<span class="preprocessor">.Web</span><span class="preprocessor">.HttpRequest</span>
<span class="label">MethodTable:</span> <span class="number">000007</span>fedb898170
<span class="label">EEClass:</span>     <span class="number">000007</span>fedb488c00
<span class="label">Size:</span>        <span class="number">384</span>(<span class="number">0x180</span>) bytes
<span class="label">File:</span>        C:\Windows\Microsoft<span class="preprocessor">.Net</span>\assembly\GAC_64\System<span class="preprocessor">.Web</span>\v4<span class="number">.0</span>_4<span class="number">.0</span><span class="number">.0</span><span class="number">.0</span>__b03f5f7f11d50a3a\System<span class="preprocessor">.Web</span><span class="preprocessor">.dll</span>
<span class="label">Fields:</span>
              MT    Field   Offset                 Type VT     Attr            Value Name
<span class="number">000007</span>fedb89aa30  <span class="number">4001150</span>        <span class="number">8</span> ..<span class="preprocessor">.HttpWorkerRequest</span>  <span class="number">0</span> instance <span class="number">00000000</span>fffa5eb0 _wr
<span class="number">000007</span>fedb896398  <span class="number">4001151</span>       <span class="number">10</span> ..<span class="preprocessor">.m</span><span class="preprocessor">.Web</span><span class="preprocessor">.HttpContext</span>  <span class="number">0</span> instance <span class="number">00000000</span>fffa6040 _context
...
<span class="number">000007</span>fee6e1dc48  <span class="number">4001165</span>       <span class="number">90</span>           System<span class="preprocessor">.Uri</span>  <span class="number">0</span> instance <span class="number">00000003</span>fff29588 _url
<span class="number">000007</span>fee6e1dc48  <span class="number">4001166</span>       <span class="number">98</span>           System<span class="preprocessor">.Uri</span>  <span class="number">0</span> instance <span class="number">0000000000000000</span> _referrer
<span class="number">000007</span>fedb900718  <span class="number">4001167</span>       a0 ..<span class="preprocessor">.b</span><span class="preprocessor">.HttpInputStream</span>  <span class="number">0</span> instance <span class="number">0000000000000000</span> _inputStream
<span class="number">000007</span>fedb8c43d0  <span class="number">4001168</span>       a8 ..<span class="preprocessor">.ClientCertificate</span>  <span class="number">0</span> instance <span class="number">0000000000000000</span> _clientCertificate
<span class="number">000007</span>feefa07e90  <span class="number">4001169</span>       b0 ..<span class="preprocessor">.l</span><span class="preprocessor">.WindowsIdentity</span>  <span class="number">0</span> instance <span class="number">0000000000000000</span> _logonUserIdentity
<span class="number">000007</span>fedb8d7fd0  <span class="number">400116</span>a       b8 ..<span class="preprocessor">.ng</span><span class="preprocessor">.RequestContext</span>  <span class="number">0</span> instance <span class="number">0000000000000000</span> _requestContext
<span class="number">000007</span>feef9fc358  <span class="number">400116</span>b       c0        System<span class="preprocessor">.String</span>  <span class="number">0</span> instance <span class="number">00000000</span>fffa64f0 _rawUrl
<span class="number">000007</span>feefa008b8  <span class="number">400116</span>c       c8     System<span class="preprocessor">.IO</span><span class="preprocessor">.Stream</span>  <span class="number">0</span> instance <span class="number">0000000000000000</span> _readEntityBodyStream
<span class="number">000007</span>fedb8d5ac8  <span class="number">400116</span>d      <span class="number">160</span>         System<span class="preprocessor">.Int</span>32  <span class="number">1</span> instance                <span class="number">0</span> _readEntityBodyMode
<span class="number">000007</span>fedb8bbcb0  <span class="number">400116</span>e       d0 ..<span class="preprocessor">.atedRequestValues</span>  <span class="number">0</span> instance <span class="number">00000003</span>fff27fe8 _unvalidatedRequestValues
...
</pre></figure>

<p>Once again there are a lot of fields that we don’t care about. The interesting one is this one:</p>
<figure class="highlight"><pre><span class="number">000007f</span>eef9fc358  <span class="number">400116</span>b       c0        System.String  <span class="number">0</span> instance <span class="number">00000000f</span>ffa64f0 _rawUrl
</pre></figure>

<p>Dumping the RawUrl property reveals the actual URL that made the request which eventually ended up causing a runaway thread:</p>
<figure class="highlight"><pre><span class="number">0</span>:<span class="number">020</span>&gt; !do <span class="number">00000000</span>fffa64f0 

<span class="label">Name:</span>        System<span class="preprocessor">.String</span>
<span class="label">MethodTable:</span> <span class="number">000007</span>feef9fc358
<span class="label">EEClass:</span>     <span class="number">000007</span>feef363720
<span class="label">Size:</span>        <span class="number">150</span>(<span class="number">0x96</span>) bytes
<span class="label">File:</span>        C:\Windows\Microsoft<span class="preprocessor">.Net</span>\assembly\GAC_64\mscorlib\v4<span class="number">.0</span>_4<span class="number">.0</span><span class="number">.0</span><span class="number">.0</span>__b77a5c561934e089\mscorlib<span class="preprocessor">.dll</span>
<span class="label">String:</span>      /Catalogs/SomeClient/Uge45/Image<span class="preprocessor">.ashx</span>?PageNumber=<span class="number">1</span>&ImageType=Thumb
<span class="label">Fields:</span>
              MT    Field   Offset                 Type VT     Attr            Value Name
<span class="number">000007</span>feef9ff108  <span class="number">40000</span>aa        <span class="number">8</span>         System<span class="preprocessor">.Int</span>32  <span class="number">1</span> instance               <span class="number">62</span> m_stringLength
<span class="number">000007</span>feef9fd640  <span class="number">40000</span>ab        c          System<span class="preprocessor">.Char</span>  <span class="number">1</span> instance               <span class="number">2</span>f m_firstChar
<span class="number">000007</span>feef9fc358  <span class="number">40000</span>ac       <span class="number">18</span>        System<span class="preprocessor">.String</span>  <span class="number">0</span>   shared           static Empty
                                 &gt;&gt; Domain:Value  <span class="number">0000000001</span>ec80e0:NotInit  <span class="number">0000000001</span>f8e840:NotInit
</pre></figure>

<p>And there we go! The offending URL seems to be:</p>
<figure class="highlight"><pre>/Catalogs/SomeClient/Uge45/<span class="keyword">Image</span>.ashx?PageNumber=<span class="number">1</span>&<span class="keyword">ImageType</span>=Thumb
</pre></figure>

<p>If you want the complete URL, including hostname, you could dig your way into the _url field on the HttpRequest object and work your way from there. In just the same way you can dig into pretty much any object, whether it’s in your code or in the IIS codebase.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Apr</span>
			<span class="day">30</span>
		</div>
		<div class="lower">2013</div>
	</div>

	<div class="title">
		<h1><a href="/debugging-in-production-part-3-thread-safe-dictionaries/" title="Debugging in Production Part 3 - Thread-Safe Dictionaries" rel="bookmark">Debugging in Production Part 3 - Thread-Safe Dictionaries</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				, 
			
				<a href="/category/Windbg/">Windbg</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p><a href="/debugging-in-production-part-2-latent-race-condition-bugs">In part 2 we found out that the concurrent access to a generic dictionary triggered a race condition bug</a> that caused threads to get stuck at 100% CPU usage. In this part, I’ll show how easy it is to rewrite the code, using the new thread-safe dictionaries in .NET 4.0, so it’s protected from race condition bugs like the one I encountered.</p>
<a id="more"></a>


<h2 id="Enter_ConcurrentDictionary">Enter ConcurrentDictionary</h2>
<p>The problem can be solved by changing just two lines of code. Instead of using a generic Dictionary, we’ll change it to a generic ConcurrentDictionary like so:</p>
<figure class="highlight csharp"><pre><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> ConcurrentDictionary&lt;<span class="keyword">short</span>, ConcurrentDictionary&lt;SettingDescription, SettingDescriptionContainer&gt;&gt; cache =
	<span class="keyword">new</span> ConcurrentDictionary&lt;<span class="keyword">short</span>, ConcurrentDictionary&lt;SettingDescription, SettingDescriptionContainer&gt;&gt;();
</pre></figure>

<p>As described by this <a href="http://msdn.microsoft.com/en-us/library/dd997369.aspx" target="_blank">MSDN article on adding and removing items from a ConcurrentDictionary</a>, it’s fully thread-safe:</p>
<blockquote>
<p>ConcurrentDictionary&lt;TKey, TValue&gt; is designed for multithreaded scenarios. You do not have to use locks in your code to add or remove items from the collection.</p>
</blockquote>
<p>Performance wise ConcurrentDictionary is about 50% slower (anecdotally) than the regular Dictionary type but even if this code is run very often, that is absolutely negligible compared to making just a single database access call.</p>
<p>Besides switching the Dictionary out with a ConcurrentDictionary, we also need to modify the init function since the ConcurrentDictionary way of adding items is slightly different:</p>
<figure class="highlight csharp"><pre><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">object</span> syncRoot = <span class="keyword">new</span> <span class="keyword">object</span>();

<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span>(IPartnerConfig partnerConfig)
{
	<span class="comment">// We only want one inside the init method at a time</span>
	<span class="keyword">lock</span> (syncRoot)
	{
		<span class="keyword">if</span> (cache.ContainsKey(partnerConfig.PartnerID))
			<span class="keyword">return</span>;

		<span class="keyword">var</span> dict = <span class="keyword">new</span> ConcurrentDictionary&lt;SettingDescription, SettingDescriptionContainer&gt;();

		... <span class="comment">// Populate the dict variable with data from the database</span>

		cache.AddOrUpdate(partnerConfig.PartnerID, dict, (k, ov) =&gt; dict);
	}
}
</pre></figure>

<p>The syncRoot lock ensures that only one initialization is going on at the same time. While not necessary in regards of avoiding the race condition, this will avoid hitting the database multiple times if the init method is being called concurrently. This could be optimized in that there could be a syncRoot object per PartnerID to allow concurrently initializing the cache for each PartneriD. But, alas, I opt to keep it simple as the init method is only called once in the lifetime of the application.</p>
<p>Instead of just adding an item to the cache, we have to use the AddOrUpdate() signature that takes in the key, value and a lambda that returns a new value, in case the key already exists in the dictionary. In this case, no matter if the key exists or not, we want to set it to the new value, so the lambda just returns the same value as passed in the second parameter.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Apr</span>
			<span class="day">15</span>
		</div>
		<div class="lower">2013</div>
	</div>

	<div class="title">
		<h1><a href="/debugging-in-production-part-2-latent-race-condition-bugs/" title="Debugging in Production Part 2 - Latent Race Condition Bugs" rel="bookmark">Debugging in Production Part 2 - Latent Race Condition Bugs</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				, 
			
				<a href="/category/IIS/">IIS</a>
				, 
			
				<a href="/category/Tools of the Trade/">Tools of the Trade</a>
				, 
			
				<a href="/category/Windbg/">Windbg</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Having <a href="/debugging-in-production-part-1-analyzing-100-cpu-usage-using-windbg">analyzed the process dump in part 1</a>, let’s take a look at the code we suspect of causing the issue, in particular how race condition bugs can be avoided.</p>
<a id="more"></a>


<h2 id="Looking_at_the_User_Code">Looking at the User Code</h2>
<p>There were three methods in action, all of them in the SettingDescriptionCache class: GetAllDescriptions, init and GetAllDescriptionsAsDictionary. GetAllDescriptions and GetAllDescriptionsAsDictionary are for all intents and purposes identical and both implement a pattern like this:</p>
<figure class="highlight csharp"><pre>public static IEnumerable&lt;SettingDescriptionContainer&gt; GetAllDescriptions(IPartnerConfig partnerConfig)
{
	// Optimistic return. If it fails we'll populate the cache and return it.
	try
	{
		return cache[partnerConfig.PartnerID].Values;
	}
	catch (KeyNotFoundException)
	{
		init(partnerConfig);
	}

	return cache[partnerConfig.PartnerID].Values;
}
</pre></figure>

<p>Both methods access a static variable defined in the class like so:</p>
<figure class="highlight csharp"><pre><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Dictionary&lt;<span class="keyword">short</span>, Dictionary&lt;SettingDescription, SettingDescriptionContainer&gt;&gt; cache =
	<span class="keyword">new</span> Dictionary&lt;<span class="keyword">short</span>, Dictionary&lt;SettingDescription, SettingDescriptionContainer&gt;&gt;();
</pre></figure>

<p>As this code is being called quite a lot, it’s written using an optimistic pattern that assumes the cache is populated. This is faster than checking if the cache is populated beforehand, or performing a TryGet(). I’ve previously blogged about <a href="/defending-against-the-improbable/">why you shouldn’t defend against the improbable</a>.</p>
<h2 id="Dictionaries_are_Not_Thread_Safe">Dictionaries are Not Thread Safe</h2>
<p>Looking up the <a href="http://msdn.microsoft.com/en-us/library/dd997305.aspx" target="_blank">MSDN article on thread-safe collections</a>, you’ll notice the following paragraph describes how the standard Dictionary collections are not thread-safe:</p>
<blockquote>
<p>The collection classes introduced in the .NET Framework 2.0 are found in the System.Collections.Generic namespace. These include List&lt;T&gt;, Dictionary&lt;TKey, TValue&gt;, and so on. These classes provide improved type safety and performance compared to the .NET Framework 1.0 classes. However, the .NET Framework 2.0 collection classes do not provide any thread synchronization; user code must provide all synchronization when items are added or removed on multiple threads concurrently.</p>
</blockquote>
<p>But is this the issue we’re running into? As there are two dictionaries in action, either one of them could potentially be the culprit. If the partnerConfig.PartnerID value was the same there would be a somewhat higher chance of this really being the issue - but how can find out what PartnerID values were being passed in to the methods?</p>
<h2 id="Analyzing_Method_Parameters_Using_Windbg">Analyzing Method Parameters Using Windbg</h2>
<p>Back in Windbg, for each of the threads we can run the !CLRStack command once again, but with the -p parameter. This doesn’t just list the stack trace, but also all of the parameters for each frame.</p>
<figure class="highlight"><pre>~232s
<span class="change">!CLRStack -p</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/debugging-in-production-part-2-latent-race-condition-bugs/Windbg5.png" class="fancy"><img src="/debugging-in-production-part-2-latent-race-condition-bugs/Windbg5.png" style="max-height: 250px"/></a></div></div>

<p>In the fifth frame, there’s a value for the IPartnerConfig parameter:</p>
<figure class="highlight"><pre>iPaper<span class="preprocessor">.BL</span><span class="preprocessor">.Backend</span><span class="preprocessor">.Modules</span><span class="preprocessor">.Paper</span><span class="preprocessor">.Settings</span><span class="preprocessor">.SettingDescriptionCache</span><span class="preprocessor">.GetAllDescriptions</span>(iPaper<span class="preprocessor">.BL</span><span class="preprocessor">.Backend</span><span class="preprocessor">.Infrastructure</span><span class="preprocessor">.PartnerConfiguration</span><span class="preprocessor">.IPartnerConfig</span>)
	PARAMETERS:
		partnerConfig (<span class="number">0x00000000543ac650</span>) = <span class="number">0x0000000260a7bd98</span>
</pre></figure>

<p>The left side value is the local memory address of the pointer itself whilst the right side is the memory location where the actual PartnerConfig instance is stored. By issuing the do (dump object) command, we can inspect the value itself:</p>
<figure class="highlight"><pre>!<span class="keyword">do</span> <span class="number">0</span>x0000000260a7bd98
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/debugging-in-production-part-2-latent-race-condition-bugs/Windbg6.png" class="fancy"><img src="/debugging-in-production-part-2-latent-race-condition-bugs/Windbg6.png" style="max-height: 250px"/></a></div></div>

<p>If you look under the Name column then you’ll be able to pinpoint the individual fields in the PartnerConfiguration instance. In the Value column you can see that the PartnerID field has a value of 230. Doing this for the other four threads yields the same result - all of them are trying to access the cache value belonging to the PartnerID value of 230!</p>
<p>At this point I can quite confidently say that I’m sure this is a threading issue related to the non thread-safe Dictionary usage. I would’ve expected hard failures like like KeyNotFoundException, NullReferenceException and so on. But apparently, under the exact right race conditions, the dictionaries may get stuck at 100% CPU usage.</p>
<p>Stay tuned for part 3 where I’ll show how to use the Dictionaries in a safe way that avoids issues like these!</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Apr</span>
			<span class="day">09</span>
		</div>
		<div class="lower">2013</div>
	</div>

	<div class="title">
		<h1><a href="/last-chance-to-register-for-sqlsaturday-196-in-copenhagen/" title="Last Chance to Register for SQLSaturday" rel="bookmark">Last Chance to Register for SQLSaturday</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - Community/">SQL Server - Community</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>In just a couple of weeks <a href="http://www.sqlsaturday.com/196/eventhome.aspx" target="_blank">SQLSaturday #196</a> will be happening on April 20th in Copenhagen, Denmark. This is a <strong>free</strong> day smack-filled with great speakers, many of them international! <a href="http://www.sqlsaturday.com/196/schedule.aspx" target="_blank">Just check out the schedule.</a></p>
<a id="more"></a>

<p>I cannot recommend attending SQLSaturdays enough, especially so if they’re close to you. Whether you’re a SQL Server or .NET developer, DBA or a BI person, there’s relevant content for you. Looking beyond the schedule, SQLSaturdays are excellent networking opportunities where people from very different business areas meet and mingle.</p>
<p>If you want to go all in, there’s even three precons on Friday the 19th of April - one of which I’m presenting, the other two by <a href="http://mrdenny.com/" target="_blank">Denny Cherry</a> and <a href="http://www.jenstirrup.com/" target="_blank">Jen Stirrup</a>. You can <a href="http://sqlsat196precon.eventbrite.com/" target="_blank">see the lineup and register here</a>.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Apr</span>
			<span class="day">08</span>
		</div>
		<div class="lower">2013</div>
	</div>

	<div class="title">
		<h1><a href="/debugging-in-production-part-1-analyzing-100-cpu-usage-using-windbg/" title="Debugging in Production Part 1 - Analyzing 100% CPU Usage Using Windbg" rel="bookmark">Debugging in Production Part 1 - Analyzing 100% CPU Usage Using Windbg</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				, 
			
				<a href="/category/IIS/">IIS</a>
				, 
			
				<a href="/category/Tools of the Trade/">Tools of the Trade</a>
				, 
			
				<a href="/category/Windbg/">Windbg</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>This is the story of how a simple oversight resulted in a tough to catch bug. As is often the case, it worked on my machine and only manifested itself in production on a live site. In this series we will look at analyzing 100% CPU usage using Windbg.</p>
<a id="more"></a>


<h2 id="The_Symptom">The Symptom</h2>
<p>Some HTTP requests were being rejected by one of our servers with status 503 indicating that the request queue limit had been reached. Looking at the CPU usage, it was clear why this was happening.</p>
<div class="imgwrapper" style=""><div><a href="/debugging-in-production-part-1-analyzing-100-cpu-usage-using-windbg/CPU-Usage.png" class="fancy"><img src="/debugging-in-production-part-1-analyzing-100-cpu-usage-using-windbg/CPU-Usage.png" style="max-height: 250px"/></a></div></div>

<p>Initially I <em>fixed</em> the issue by issuing an iisreset, clearing the queue and getting back to normal. But when this started occurring on multiple servers at random times, I knew there was something odd going on.</p>
<h2 id="Isolating_the_Server_and_Creating_a_Dump">Isolating the Server and Creating a Dump</h2>
<p>To analyze what’s happening, I needed to debug the process on the server while it was going on. So I sat around and waited for the next server to act up, and sure enough, within a couple of hours another one of our servers seemed to be stuck at 100% CPU. Immediately I pulled it out of our load balancers so it wasn’t being served any new requests, allowing me to do my work without causing trouble for the end users.</p>
<p>In server 2008 it’s quite easy to create a dump file. Simply fire up the task manager, right click the process and choose “Create Dump File”.</p>
<div class="imgwrapper" style=""><div><a href="/debugging-in-production-part-1-analyzing-100-cpu-usage-using-windbg/Task-Manager.png" class="fancy"><img src="/debugging-in-production-part-1-analyzing-100-cpu-usage-using-windbg/Task-Manager.png" style="max-height: 250px"/></a></div></div>

<p>Do note that task manager comes in both an x64 and an x86 version. If you run the x64 version and make a dump of an x86 process, it’ll still create an x64 dump, making it unusable. As such, make sure you use whatever task manager that matches the architecture of the process you want to dump. On an x64 machine (with Windows on the C: drive) you can find the x86 task manager here: C:\Windows\SysWOW64\taskmgr.exe. Note that you can’t run both at the same time, so make sure to close the x64 taskmgr.exe process before starting the x86 one.</p>
<p>Once the dump has been created, a message will tell you the location of the .DMP file. This is roughly twice the size of the process at the time of the dump, so make sure you have enough space on your C: drive.</p>
<div class="imgwrapper" style=""><div><a href="/debugging-in-production-part-1-analyzing-100-cpu-usage-using-windbg/Dump.png" class="fancy"><img src="/debugging-in-production-part-1-analyzing-100-cpu-usage-using-windbg/Dump.png" style="max-height: 250px"/></a></div></div>


<h2 id="Finding_the_Root_Cause_Using_Windbg">Finding the Root Cause Using Windbg</h2>
<p>Now that we have the dump, we can open it up in Windbg and look around. You’ll need to have Windbg installed in the correct version (it comes in both x86 and x64 versions). While Windbg can only officially be installed as part of the whole Windows SDK, Windbg itself is xcopy deploy-able, and is <a href="http://www.windbg.org/" target="_blank">available for download here</a>.</p>
<p>To make things simple, I just run Windbg on the server itself. That way I won’t run into issues with differing CLR versions being installed on the machine, making debugging quite difficult.</p>
<p>Once Windbg is running, press Ctrl+D and open the .DMP file.</p>
<div class="imgwrapper" style=""><div><a href="/debugging-in-production-part-1-analyzing-100-cpu-usage-using-windbg/Windbg1.png" class="fancy"><img src="/debugging-in-production-part-1-analyzing-100-cpu-usage-using-windbg/Windbg1.png" style="max-height: 250px"/></a></div></div>

<p>The first command you’ll want to execute is this:</p>
<figure class="highlight"><pre><span class="change">!loadby sos clr</span>
</pre></figure>

<p>This loads in the <a href="http://msdn.microsoft.com/en-us/library/bb190764.aspx" target="_blank">Son of Strike extension</a> that contains a lot of useful methods for debugging .NET code.</p>
<h3 id="Identifying_Runaway_Threads">Identifying Runaway Threads</h3>
<p>As we seem to have a runaway code issue, let’s start out by issuing the following command:</p>
<figure class="highlight"><pre><span class="change">!runaway</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/debugging-in-production-part-1-analyzing-100-cpu-usage-using-windbg/Windbg2.png" class="fancy"><img src="/debugging-in-production-part-1-analyzing-100-cpu-usage-using-windbg/Windbg2.png" style="max-height: 250px"/></a></div></div>

<p>This lists all the threads as well as the time spent executing user mode code. When dealing with a 100% CPU issue, you’ll generally see  some threads chugging away all the time. In this case it’s easy to see that looking at just the top four threads, we’ve already spent over 20 (effective) minutes executing user mode code - these threads would probably be worth investigating.</p>
<h3 id="Analyzing_CLR_Stacks">Analyzing CLR Stacks</h3>
<p>Now that we’ve identified some of the most interesting threads, we can select them one by one like so:<p></p>
<figure class="highlight"><pre>~Xs
</pre></figure>

<p>Switching X out with a thread number (e.g. 234, 232, 238, 259, 328, etc.) allows us to <em>select</em> the thread. Notice how the lower left corner indicates the currently selected thread:</p>
<div class="imgwrapper" style=""><div><a href="/debugging-in-production-part-1-analyzing-100-cpu-usage-using-windbg/Windbg3.png" class="fancy"><img src="/debugging-in-production-part-1-analyzing-100-cpu-usage-using-windbg/Windbg3.png" style="max-height: 250px"/></a></div></div>

<p>Once selected, we can see what the thread is currently doing by executing the following command:</p>
<figure class="highlight"><pre><span class="change">!CLRStack</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/debugging-in-production-part-1-analyzing-100-cpu-usage-using-windbg/Windbg4.png" class="fancy"><img src="/debugging-in-production-part-1-analyzing-100-cpu-usage-using-windbg/Windbg4.png" style="max-height: 250px"/></a></div></div>

<p>Looking at the top frame in the call stack, it seems the thread is stuck in the BCL Dictionary.FindEntry() method:</p>
<figure class="highlight csharp"><pre>System.Collections.Generic.Dictionary`<span class="number">2</span><span class="string">[[System.Int16, mscorlib],[System.__Canon, mscorlib]]</span>.FindEntry(Int16)
</pre></figure>

<p>Tracing back just a few more frames, this seems to be invoked from the following user function:</p>
<figure class="highlight csharp"><pre>iPaper<span class="preprocessor">.BL</span><span class="preprocessor">.Backend</span><span class="preprocessor">.Modules</span><span class="preprocessor">.Paper</span><span class="preprocessor">.Settings</span><span class="preprocessor">.SettingDescriptionCache</span><span class="preprocessor">.GetAllDescriptions</span>()
</pre></figure>

<p>Performing the same act for the top five threads yields a rather clear unanimous picture:</p>
<figure class="highlight csharp"><pre><span class="number">234</span>:
System<span class="preprocessor">.Collections</span><span class="preprocessor">.Generic</span><span class="preprocessor">.Dictionary</span>`<span class="number">2</span>[[System<span class="preprocessor">.Int</span>16, mscorlib],[System.__Canon, mscorlib]]<span class="preprocessor">.FindEntry</span>(Int16)
...
iPaper<span class="preprocessor">.BL</span><span class="preprocessor">.Backend</span><span class="preprocessor">.Modules</span><span class="preprocessor">.Paper</span><span class="preprocessor">.Settings</span><span class="preprocessor">.SettingDescriptionCache</span><span class="preprocessor">.GetAllDescriptions</span>(iPaper<span class="preprocessor">.BL</span><span class="preprocessor">.Backend</span><span class="preprocessor">.Infrastructure</span><span class="preprocessor">.PartnerConfiguration</span><span class="preprocessor">.IPartnerConfig</span>)

<span class="number">232</span>:
System<span class="preprocessor">.Collections</span><span class="preprocessor">.Generic</span><span class="preprocessor">.Dictionary</span>`<span class="number">2</span>[[System<span class="preprocessor">.Int</span>16, mscorlib],[System.__Canon, mscorlib]]<span class="preprocessor">.Insert</span>(Int16, System.__Canon, Boolean)
...
iPaper<span class="preprocessor">.BL</span><span class="preprocessor">.Backend</span><span class="preprocessor">.Modules</span><span class="preprocessor">.Paper</span><span class="preprocessor">.Settings</span><span class="preprocessor">.SettingDescriptionCache</span><span class="preprocessor">.init</span>(iPaper<span class="preprocessor">.BL</span><span class="preprocessor">.Backend</span><span class="preprocessor">.Infrastructure</span><span class="preprocessor">.PartnerConfiguration</span><span class="preprocessor">.IPartnerConfig</span>)

<span class="number">238</span>:
System<span class="preprocessor">.Collections</span><span class="preprocessor">.Generic</span><span class="preprocessor">.Dictionary</span>`<span class="number">2</span>[[System<span class="preprocessor">.Int</span>16, mscorlib],[System.__Canon, mscorlib]]<span class="preprocessor">.FindEntry</span>(Int16)
...
iPaper<span class="preprocessor">.BL</span><span class="preprocessor">.Backend</span><span class="preprocessor">.Modules</span><span class="preprocessor">.Paper</span><span class="preprocessor">.Settings</span><span class="preprocessor">.SettingDescriptionCache</span><span class="preprocessor">.GetAllDescriptions</span>(iPaper<span class="preprocessor">.BL</span><span class="preprocessor">.Backend</span><span class="preprocessor">.Infrastructure</span><span class="preprocessor">.PartnerConfiguration</span><span class="preprocessor">.IPartnerConfig</span>)

<span class="number">259</span>:
System<span class="preprocessor">.Collections</span><span class="preprocessor">.Generic</span><span class="preprocessor">.Dictionary</span>`<span class="number">2</span>[[System<span class="preprocessor">.Int</span>16, mscorlib],[System.__Canon, mscorlib]]<span class="preprocessor">.FindEntry</span>(Int16)
...
iPaper<span class="preprocessor">.BL</span><span class="preprocessor">.Backend</span><span class="preprocessor">.Modules</span><span class="preprocessor">.Paper</span><span class="preprocessor">.Settings</span><span class="preprocessor">.SettingDescriptionCache</span><span class="preprocessor">.GetAllDescriptions</span>(iPaper<span class="preprocessor">.BL</span><span class="preprocessor">.Backend</span><span class="preprocessor">.Infrastructure</span><span class="preprocessor">.PartnerConfiguration</span><span class="preprocessor">.IPartnerConfig</span>)

<span class="number">328</span>:
System<span class="preprocessor">.Collections</span><span class="preprocessor">.Generic</span><span class="preprocessor">.Dictionary</span>`<span class="number">2</span>[[System<span class="preprocessor">.Int</span>16, mscorlib],[System.__Canon, mscorlib]]<span class="preprocessor">.FindEntry</span>(Int16)
...
iPaper<span class="preprocessor">.BL</span><span class="preprocessor">.Backend</span><span class="preprocessor">.Modules</span><span class="preprocessor">.Paper</span><span class="preprocessor">.Settings</span><span class="preprocessor">.SettingDescriptionCache</span><span class="preprocessor">.GetAllDescriptionsAsDictionary</span>(iPaper<span class="preprocessor">.BL</span><span class="preprocessor">.Backend</span><span class="preprocessor">.Infrastructure</span><span class="preprocessor">.PartnerConfiguration</span><span class="preprocessor">.IPartnerConfig</span>)
</pre></figure>

<p>Interestingly, all of the threads are stuck inside internal methods in the base class library Dictionary class. All of them are invoked from the user SettingDescriptionCache class, though from different methods.</p>
<p>Stay tuned for <a href="/debugging-in-production-part-2-latent-race-condition-bugs/">part 2 where we’ll dive into the user code and determine what’s happening</a>!</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Feb</span>
			<span class="day">27</span>
		</div>
		<div class="lower">2013</div>
	</div>

	<div class="title">
		<h1><a href="/native-chrome-flash-player-disabled-by-itself/" title="Native Chrome Flash Player Disabled by Itself All of a Sudden" rel="bookmark">Native Chrome Flash Player Disabled by Itself All of a Sudden</a></h1>
		<div class="categories">
			
				<a href="/category/Miscellaneous/">Miscellaneous</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>At my job we’ve got a product that relies heavily on Flash. The last couple of days I’ve had a number of users complain that, all of a sudden, they couldn’t view Flash content any more. Common for all of them were their browser - Chrome. It would seem that, somehow, the native Chrome Flash player got disabled by itself all of a sudden.</p>
<a id="more"></a>

<p>What’s especially unusual about this is that Chrome has a built-in Flash player, so if anyone, Chrome users should be able to view Flash content. Digging deeper I found that the built-in Flash player extension had been disabled. To check if that’s the case, see here:</p>
<figure class="highlight sql"><pre>Chrome Settings =&gt; Show advanced settings... =&gt; Privacy =&gt; Content settings... =&gt; Plug-ins =&gt; Disable individual plug-ins...
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/native-chrome-flash-player-disabled-by-itself/Flash.png" class="fancy"><img src="/native-chrome-flash-player-disabled-by-itself/Flash.png" style="max-height: 250px"/></a></div></div>

<p>By just clicking “Enable”, everything is working again. But how did it get disabled? This is such a convoluted place to find that I know the users haven’t done so themselves. Looking at Twitter, it seems we’re not alone in seeing this:</p>
<p><a href="https://twitter.com/AnandaWoW/status/306751670258388992" target="_blank">https://twitter.com/AnandaWoW/status/306751670258388992</a></p>
<p><a href="https://twitter.com/RachofSuburbia/status/306426446438617088" target="_blank">https://twitter.com/RachofSuburbia/status/306426446438617088</a></p>
<p><a href="https://twitter.com/linnysvault/status/306420799550660608" target="_blank">https://twitter.com/linnysvault/status/306420799550660608</a></p>
<p><a href="https://twitter.com/Astracius/status/306351364710219776" target="_blank">https://twitter.com/Astracius/status/306351364710219776</a></p>
<p><a href="https://twitter.com/junctionette/status/306230350131130370" target="_blank">https://twitter.com/junctionette/status/306230350131130370</a></p>
<p><a href="https://twitter.com/envyonthetoast/status/306210978201219073" target="_blank">https://twitter.com/envyonthetoast/status/306210978201219073</a></p>
<p>… I think you get the picture. It seems that all of our users had just had their Flash player auto update itself. I’m wondering, could the Internet Explorer Flash plugin perhaps updated itself and, by mistake, disabled the Chrome plugin? If the built-in Chrome Flash player is disabled, Chrome will try to use the regular Flash plugin. However, the Internet Explorer version won’t work in Chrome, so that won’t work.</p>
<p>Anyone else experienced this? Any tips on what’s causing it? The fix is simple, but I’d really like to understand what’s causing this, as well as knowing how widespread the issue is.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Feb</span>
			<span class="day">21</span>
		</div>
		<div class="lower">2013</div>
	</div>

	<div class="title">
		<h1><a href="/sqlsaturday-196-presenting-a-precon/" title="SQLSaturday &amp;#35;196 - Presenting a Precon" rel="bookmark">SQLSaturday &amp;#35;196 - Presenting a Precon</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Seeing SQLSaturday events sprawling up all over the world makes me all warm and fuzzy inside. Long have I been considering whether one might happen in Denmark, but to be honest, I didn’t think the audience would be big enough. I’m biased though as I’ve mainly attended events outside of Denmark, and thus most of my acquaintances have been non-Danish. But lo and behold, Régis Baccaro just announced that <a href="http://www.sqlsaturday.com/196/eventhome.aspx" target="_blank">SQLSaturday #196</a> now has <a href="https://twitter.com/regbac/status/304320528095793154" target="_blank">101 registered attendees</a>! And best of all, it’s held in Copenhagen on the 20th of April.</p>
<a id="more"></a>

<div class="imgwrapper" style=""><div><a href="/sqlsaturday-196-presenting-a-precon/logo.png" class="fancy"><img src="/sqlsaturday-196-presenting-a-precon/logo.png" style="max-height: 250px"/></a></div></div>

<p>Having just about 100 people attend my <a href="http://warmcrocconf.net/Marksr.aspx" target="_blank">Top X SQL Server Developer Mistakes session at Warm Crocodile</a> recently made me realize just how popular SQL Server really is. Nosql might be the hype, but when it comes to business, quite a lot of developers are “stuck” with SQL Server on a daily basis. For the same reason, I absolutely cannot recommend going to SQLSaturday #196 enough! It’s free, it’s an excellent networking opportunity and it’s sure to be full of great speakers and content. Go ahead - <a href="http://www.sqlsaturday.com/196/register.aspx" target="_blank">register here</a>!</p>
<div class="imgwrapper" style=""><div><a href="/sqlsaturday-196-presenting-a-precon/392531_496414643720736_540150277_n-250x166.jpg" class="fancy"><img src="/sqlsaturday-196-presenting-a-precon/392531_496414643720736_540150277_n-250x166.jpg" style="max-height: 250px"/></a></div></div>

<p>I’ll have the pleasure and honor of presenting my <a href="http://sqlsat196precon.eventbrite.com/" target="_blank">A Deep Dive Into the Depths of the SQL Server Storage Engine and MDF File Format</a> precon on the 19th of April, the day before the SQLSaturday event itself. It’s not the first time I’m presenting this precon, in fact, this’ll be my fifth time. This means I’ve now had a number of chances to test my content and optimize the format to ensure you get maximum value out of the day. If you’re planning on attending and have any special requests or questions regarding the content, please do let me know in the comments here!</p>
<p>If storage internals isn’t your thing, there are two other top notch presenters - <a href="http://www.jenstirrup.com/" target="_blank">Jen Stirrup</a> and <a href="http://itknowledgeexchange.techtarget.com/sql-server/" target="_blank">Denny Cherry</a>. Jen will be presenting a <a href="http://sqlsat196precon.eventbrite.com/" target="_blank">Data Visualisation Deep-Dive using SQL Server 2012</a> while Denny will present on <a href="http://sqlsat196precon.eventbrite.com/" target="_blank">SQL Server 2012 in a Highly Available World</a>.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>


<div class="paging">
	<a href="/page/3/"><div class="past">« Past</div></a>
	<a href="/"><div class="future">Future »</div></a>
	<div class="clear"></div>
</div>

				</div>
			</div>

			<div id="asides">
				<div class="categories aside">
					<span class="sectiontitle">CATEGORIES</span>
					<ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/category/.NET/">.NET</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/AS/Flex/Flash/">AS/Flex/Flash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Amazon Web Services/">Amazon Web Services</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Computer Science/">Computer Science</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Conferences and Presenting/">Conferences and Presenting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/IIS/">IIS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Life/">Life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Miscellaneous/">Miscellaneous</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Performance/">Performance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Poker/">Poker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server/">SQL Server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Community/">SQL Server - Community</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Data Types/">SQL Server - Data Types</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Internals/">SQL Server - Internals</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Optimization/">SQL Server - Optimization</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Tricks/">SQL Server - Tricks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Testing/">Testing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Tools of the Trade/">Tools of the Trade</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Umbraco/">Umbraco</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Visual Studio/">Visual Studio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Web/">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windbg/">Windbg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windows/">Windows</a></li></ul>

					
				</div>

				<div class="archive aside">
					<span class="sectiontitle">ARCHIVE</span>
					<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archive/2014">2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2013">2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2012">2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2011">2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2010">2010</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2009">2009</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2008">2008</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2007">2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2006">2006</a></li></ul>
				</div>
			</div>

			<div class="clear"></div>
		</div>
		
		<footer>
			<div class="wrapper">Copyright &copy; 2014 Mark S. Rasmussen</div>
		</footer>

		<script type="text/javascript">
			$(function () {
				// Show mobile menu
				$("li.navicon").click(function () {
					if ($("header ul.mobile a").length == 0) {
						// Pages
						$mobilePages = $("div#naviconcontent ul.pages");
						$("header nav ul.normal > li").not(".navicon").each(function (i, el) {
							$mobilePages.append($(el).clone());
						});

						// Categories
						$mobileCategories = $("div#naviconcontent ul.categories");
						$("div#asides div.categories > ul > li").each(function (i, el) {
							$mobileCategories.append($(el).clone());
						});

						// Archive
						$mobileArchive = $("div#naviconcontent ul.archive");
						$("div#asides div.archive > ul > li").each(function (i, el) {
							$mobileArchive.append($(el).clone());
						});
					};

					$("header ul.mobile").toggle();
				});

				// Fancybox setup
				$("a.fancy").fancybox({
					hideOnContentClick: true,
					overlayShow: true
				});
			});
		</script>
	</body>
</html>