<!DOCTYPE html>
<html>
	

<head>
	<title>Mark S. Rasmussen</title>
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
	<meta charset="UTF-8" />
	<meta property="og:locale" content="en_US" />
	<meta property="og:type" content="website" />
	<meta name="google-site-verification" content="alt7-wfK3ZujMQ4D0jYNd0yC5LGetGdqBlBmZsqQlVw" />
	<meta content="article" property="og:type">
<meta content="Mark S. Rasmussen" property="og:title">
<meta content="http://improve.dk/page/5/" property="og:url">
<meta property="og:image">
<meta content="Mark S. Rasmussen" property="og:site_name">
<meta property="og:description">
<meta content="summary" name="twitter:card">
	<link rel="alternative" href="http://feeds.feedburner.com/Improvedk" title="Mark S. Rasmussen" type="application/atom+xml">
	<script src="/js/combined.js"></script>
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-2479580-1', 'improve.dk');
		ga('require', 'displayfeatures');
		ga('send', 	'pageview');
	</script>
	<link rel="stylesheet" href="/css/style.css" type="text/css" />
</head>
	<body>
		<div id="headerline"></div>
	
		<header>
			<div class="wrapper">
				<div id="title">
					<a href="/">Mark S. Rasmussen</a> <span>improve.dk</span>
				</div>
				
				<nav>
					<ul class="normal">
						<li class="navicon"></li>
						<li><a href="/about-me/">About Me</a></li>
					</ul>
				</nav>
				
				<ul id="sharing">
					<li><a href="mailto:mark@improve.dk" id="shareat"></a></li>
					<li><a href="http://feeds.feedburner.com/Improvedk" id="rssfeed"></a></li>
					<li><a href="https://twitter.com/improvedk" id="sharetwitter"></a></li>
					<li><a href="https://github.com/improvedk" id="sharegithub"></a></li>
					<li><a href="https://www.linkedin.com/in/markrasmussen/" id="sharelinkedin"></a></li>
				</ul>

				<div class="clear"></div>
				
				<div id="naviconcontent">
					<ul class="mobile">
						<li>
							Pages
							<ul class="pages"></ul>
						</li>
						<li>
							Categories
							<ul class="categories"></ul>
						</li>
						<li>
							Archive
							<ul class="archive"></ul>
						</li>
					</ul>
				</div>
			</div>
		</header>

		<div id="mainwrapper">
			<div id="contentwrapper">
				<div id="content">
				
					
	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Feb</span>
			<span class="day">17</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/linqpad-ndash-the-perfect-playground-for-amazon-web-services/" title="LINQPad - The Perfect Playground for Amazon Web Services" rel="bookmark">LINQPad - The Perfect Playground for Amazon Web Services</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				, 
			
				<a href="/category/Amazon Web Services/">Amazon Web Services</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I’ve previously written on <a href="/how-to-set-up-and-serve-private-content-using-s3">why I don’t want to rely on third party GUIs</a> for managing my AWS services. Assuming I’ll be interacting with AWS through the SDK later on, I much prefer doing the initial setup using the SDK as well, to ensure I fully understand what I’ve done. <a href="/how-to-set-up-and-serve-private-content-using-s3">In</a> <a href="/pushing-the-limits-of-amazon-s3-upload-performance">previous</a> <a href="/optimizing-single-instance-amazon-s3-delete-performance">posts</a>, I’ve shown full console application examples on how to use the SDK for various tasks; however, creating a console application project, compiling and running it can be kind of cumbersome, especially if you’re just doing some quick testing or API exploration.</p>
<a id="more"></a>

<h2 id="Enter_LINQPad">Enter LINQPad</h2>
<p>If you haven’t tried <a href="http://www.linqpad.net/" target="_blank">LINQPad</a> out before, go do it now! It’s an awesome scratchpad style application for writing and running C#/VB.NET/F# code, either as a single expression, a set of statements or a full application. There are also various plugins for easily connecting to databases, Azure services and lots more. Probably just a matter of time before someone writes a <a href="http://www.linqpad.net/extensibility.aspx" target="_blank">custom provider</a> for AWS as well.</p>
<h3 id="Getting_started_with_the_AWS_SDK_in_LINQPad">Getting started with the AWS SDK in LINQPad</h3>
<p>First up, you need to <a href="http://aws.amazon.com/sdkfornet/" target="_blank">download</a> and install the AWS SDK. Once installed, open LINQPad and press F4. In the following dialog, click Add…</p>
<div class="imgwrapper" style=""><div><a href="/linqpad-ndash-the-perfect-playground-for-amazon-web-services/image_2.png" class="fancy"><img src="/linqpad-ndash-the-perfect-playground-for-amazon-web-services/image_2.png" style="max-height: 250px"/></a></div></div>

<p>You can either browse to the AWSSDK.dll file manually, or you can pick it from the GAC – which would be the easiest option if you’re just doing some quick testing.</p>
<div class="imgwrapper" style=""><div><a href="/linqpad-ndash-the-perfect-playground-for-amazon-web-services/image_4.png" class="fancy"><img src="/linqpad-ndash-the-perfect-playground-for-amazon-web-services/image_4.png" style="max-height: 250px"/></a></div></div>

<p>After adding it, as a final step, go to the <em>Additional Namespace Imports</em> tab and add Amazon to the list.</p>
<div class="imgwrapper" style=""><div><a href="/linqpad-ndash-the-perfect-playground-for-amazon-web-services/image_61.png" class="fancy"><img src="/linqpad-ndash-the-perfect-playground-for-amazon-web-services/image_61.png" style="max-height: 250px"/></a></div></div>

<h2 id="Discoverability">Discoverability</h2>
<p>There are generally two ways to approach a new and unknown API. You <a href="http://aws.amazon.com/documentation/" target="_blank">could read the documentation</a>, or you could just throw yourself at it, relying on intellisense. Unfortunately the free version of LINQPad does not come with intellisense/auto completion, however, at a price of $39 it’s a bargain.</p>
<div class="imgwrapper" style=""><div><a href="/linqpad-ndash-the-perfect-playground-for-amazon-web-services/image_121.png" class="fancy"><img src="/linqpad-ndash-the-perfect-playground-for-amazon-web-services/image_121.png" style="max-height: 250px"/></a></div></div>

<h3 id="Exception_output">Exception output</h3>
<p>Inevitably, you’ll probably run into an exception or two. Take the following piece of code for example; it works perfectly, but I forgot to assign the IAM user access to the bucket I’m trying to interact with (and before you remind me to remove the keys, don’t worry, the IAM user was temporary and no longer exists):</p>
<figure class="highlight cs"><pre><span class="keyword">var</span> accessKeyID = <span class="string">"AKIAIKB6FI6SSOGGOP7A"</span>;
<span class="keyword">var</span> secretKey = <span class="string">"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"</span>;

<span class="keyword">using</span> (<span class="keyword">var</span> client = AWSClientFactory.CreateAmazonS3Client(accessKeyID, secretKey))
{
	<span class="keyword">var</span> request = <span class="keyword">new</span> Amazon.S3.Model.ListObjectsRequest()
		.WithBucketName(<span class="string">"improve-us.dk"</span>);

	<span class="keyword">using</span> (<span class="keyword">var</span> result = client.ListObjects(request))
	{
		result.Dump();
	}
}
</pre></figure>

<p>What you’ll see is a clear notification saying an exception has occurred, as well as a repeated exception in the output pane:</p>
<div class="imgwrapper" style=""><div><a href="/linqpad-ndash-the-perfect-playground-for-amazon-web-services/image_141.png" class="fancy"><img src="/linqpad-ndash-the-perfect-playground-for-amazon-web-services/image_141.png" style="max-height: 250px"/></a></div></div>

<p>But look what happens once we expand the exception:</p>
<div class="imgwrapper" style=""><div><a href="/linqpad-ndash-the-perfect-playground-for-amazon-web-services/image_161.png" class="fancy"><img src="/linqpad-ndash-the-perfect-playground-for-amazon-web-services/image_161.png" style="max-height: 250px"/></a></div></div>

<p>We get all of the output! Any object, returned or thrown from the code, will automatically be displayed in the output, and can easily be drilled into.</p>
<h3 id="Dumping_objects">Dumping objects</h3>
<p>In case you’re code neither throws exceptions (by some miracle, in my case) nor returns objects, you can always call the .Dump() extension method on any object. Once I granted the IAM user the correct permissions, result.Dump() was called and the result of the ListObjectsRequest was output:</p>
<div class="imgwrapper" style=""><div><a href="/linqpad-ndash-the-perfect-playground-for-amazon-web-services/image_181.png" class="fancy"><img src="/linqpad-ndash-the-perfect-playground-for-amazon-web-services/image_181.png" style="max-height: 250px"/></a></div></div>

<p>Once again it’s easy to drill down and see all of the properties of the result.</p>
<h2 id="Conclusion">Conclusion</h2>
<p>Adhering to my original statement of not liking third party GUIs, using tools like LINQPad is an excellent option for easily writing test code, without the added overhead of starting Visual Studio, compiling, running, etc. The output is neatly presented and really helps you to get a feeling for the API.</p>
<p>Just to finish off – LINQPad has plenty of uses besides AWS, this is just one scenario for which I’ve been using it extensively lately. I’m really considering creating a LINQPad provider for <a href="https://github.com/improvedk/OrcaMDF" target="_blank">OrcaMDF</a> as one of my next projects.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Feb</span>
			<span class="day">13</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/creating-multiplexers-using-logic-gates/" title="Creating Multiplexers Using Logic Gates" rel="bookmark">Creating Multiplexers Using Logic Gates</a></h1>
		<div class="categories">
			
				<a href="/category/Computer Science/">Computer Science</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>So what’s a multiplexer you ask? A multiplexer is an <a href="http://en.wikipedia.org/wiki/Integrated_circuit" target="_blank">integrated circuit</a> that takes a number of inputs and outputs a smaller number of outputs. In this case we’re aiming at creating a 4-to-1 multiplexer. As the name implies, it takes four inputs and outputs exactly one output, determined by a <em>select input</em>. Depending on the number of input lines, one or more select lines may be required. For 2<sup>n</sup> input lines, n select lines are needed. In hardware terms, this is basically the simplest of switches.</p>
<a id="more"></a>

<h2 id="Creating_a_2-to-1_multiplexer">Creating a 2-to-1 multiplexer</h2>
<p>To start out easy, we’ll create a multiplexer taking two inputs and a single selector line. With inputs A and B and select line S, if S is 0, the A input will be the output Z. If S is 1, the B will be the output Z.</p>
<p>The boolean formula for the 2-to-1 multiplexer looks like this:</p>
<figure class="highlight sql"><pre>Z = (A ∧ ¬S) ∨ (B ∧ S)
</pre></figure>

<p>If you’re not used to boolean algebra, it may be easier to see it represented in SQL:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span> @Z = (A & ~S) | (B & S)</span>
</pre></figure>

<p>By ANDing A and B with NOT S and S respectively, we’re guaranteed that either A or B will be output. Creating the circuit, it looks like this:</p>
<div class="imgwrapper" style=""><div><a href="/creating-multiplexers-using-logic-gates/image_thumb1_2.png" class="fancy"><img src="/creating-multiplexers-using-logic-gates/image_thumb1_2.png" style="max-height: 250px"/></a></div></div>

<p>If we enable both A and B inputs but keep S disabled, we see that the A input is passed all the way through to the Z output:</p>
<div class="imgwrapper" style=""><div><a href="/creating-multiplexers-using-logic-gates/image_thumb3_2.png" class="fancy"><img src="/creating-multiplexers-using-logic-gates/image_thumb3_2.png" style="max-height: 250px"/></a></div></div>

<p>And if we enable the S selector line, B is passed through to Z as the output:</p>
<div class="imgwrapper" style=""><div><a href="/creating-multiplexers-using-logic-gates/image_thumb5_2.png" class="fancy"><img src="/creating-multiplexers-using-logic-gates/image_thumb5_2.png" style="max-height: 250px"/></a></div></div>

<h2 id="Creating_a_4-to-1_multiplexer">Creating a 4-to-1 multiplexer</h2>
<p>Now that we’ve created the simplest of multiplexers, let’s get on with the 4-to-1 multiplexer. Given that we have 2<sup>2</sup> inputs, we need two selector lines. The logic is just as before – combining the two selector lines, we have four different combinations. Each combination will ensure that one of the input lines A-D are passed through as the output Z. The formula looks like this:</p>
<figure class="highlight sql"><pre>Z = (A ∧ ¬S0 ∧ ¬S1) ∨ (B ∧ S0 ∧ ¬S1) ∨ (C ∧ ¬S0 ∧ S1) ∨ (D ∧ S0 ∧ S1)
</pre></figure>

<p>And in SQL:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span> Z = (A & ~S0 & ~S1) | (B & S0 & ~S1) | (C & ~S0 & S1) | (D & S0 & S1)</span>
</pre></figure>

<p>The circuit is pretty much the same as in the 2-to-1 multiplexer, except we add all four inputs and implement the 4-input boolean formula, with S<sub>0</sub> on top and S<sub>1</sub> on bottom:</p>
<div class="imgwrapper" style=""><div><a href="/creating-multiplexers-using-logic-gates/image_thumb7_2.png" class="fancy"><img src="/creating-multiplexers-using-logic-gates/image_thumb7_2.png" style="max-height: 250px"/></a></div></div>

<p>I’ll spare you a demo of all the states and just show all four inputs activated while the signal value of 0b10 results in C being pass through to Z as the result:</p>
<div class="imgwrapper" style=""><div><a href="/creating-multiplexers-using-logic-gates/image_thumb9_2.png" class="fancy"><img src="/creating-multiplexers-using-logic-gates/image_thumb9_2.png" style="max-height: 250px"/></a></div></div>

<h2 id="Combining_two_4-to-1_multiplexers_into_an_8-to-1_multiplexer">Combining two 4-to-1 multiplexers into an 8-to-1 multiplexer</h2>
<p>I’ll spare you the algebraic logic this time as it follows the same pattern as previously, except it’s starting to become quite verbose. In the following circuit I’ve taken the the exact 4-to-1 multiplexer circuit that we created just before, and turned it into an integrated circuit (just as I converted the 2-to-1 multiplexer into an integrated circuit). I’ve then added 8 inputs, A through H as well as three selector inputs, S0 through S2.</p>
<p>S0 and S1 are passed directly into each of the 4-1 multiplexers, no matter the value of S2. This means both 4-1 multiplexers are completely unaware of S2s existence. However, as the output from each of the 4-1 multiplexers are passed into a 2-1 multiplexer connected to the S2 selector line, S2 determines which of the 4-1 multiplexers get to deliver the output.</p>
<div class="imgwrapper" style=""><div><a href="/creating-multiplexers-using-logic-gates/image_thumb2_2.png" class="fancy"><img src="/creating-multiplexers-using-logic-gates/image_thumb2_2.png" style="max-height: 250px"/></a></div></div>

<p>Here’s an example where S2 defines the output should come from the second (leftmost) 4-1 multiplexer, while the S0 and S1 selector lines defines the input should come from the second input in that multiplexer, meaning input F gets passed through as the result Z.</p>
<div class="imgwrapper" style=""><div><a href="/creating-multiplexers-using-logic-gates/image_thumb4_2.png" class="fancy"><img src="/creating-multiplexers-using-logic-gates/image_thumb4_2.png" style="max-height: 250px"/></a></div></div>

<h2 id="Combining_two_8-to-1_multiplexers_into_a_16-to-1_multiplexer">Combining two 8-to-1 multiplexers into a 16-to-1 multiplexer</h2>
<p>Ok, let’s just stop here.Using the smaller multiplexers we can continue combining them until we reach the desired size.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Feb</span>
			<span class="day">07</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/orcamdf-row-compression-support/" title="OrcaMDF Row Compression Support" rel="bookmark">OrcaMDF Row Compression Support</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>After two months of on and off work, I finally merged the <a href="https://github.com/improvedk/OrcaMDF" target="_blank">OrcaMDF</a> compression branch into master. This means OrcaMDF now officially supports data row compression!</p>
<a id="more"></a>

<h2 id="Supported_data_types">Supported data types</h2>
<p>Implementing row compression required me to modify nearly all existing data types as compression changes the way they’re stored. Integers are <a href="/the-anatomy-of-row-amp-page-compressed-integers">compressed</a>, decimals are <a href="/how-are-vardecimals-stored">variable length</a> and variable length values are generally truncated instead of padded with 0’s. All previous data types implemented in OrcaMDF supports row compression, just as I’ve added a few. The current list of supported data types is as follows:</p>
<ul>
<li>bigint</li>
<li>binary</li>
<li>bit</li>
<li>char</li>
<li>date</li>
<li>datetime</li>
<li>mal/numeric (including vardecimal, both with and without row compression)</li>
<li>image</li>
<li>int</li>
<li>money</li>
<li>nchar</li>
<li>ntext</li>
<li>nvarchar</li>
<li>smallint</li>
<li>smallmoney</li>
<li>text</li>
<li>time</li>
<li>uniqueidentifier</li>
<li>varbinary</li>
<li>varchar</li>
</ul>
<h2 id="Unicode_compression">Unicode compression</h2>
<p>Nchar and nvarchar proved to be slightly more tricky than the rest as they use the <a href="http://unicode.org/reports/tr6/" target="_blank">SCSU</a> unicode compression format. I found a single <a href="http://gautam-m.blogspot.com/2010/09/standard-compression-scheme-for-unicode.html" target="_blank">.NET implementation of SCSU</a>, but while I was allowed to use the code, it didn’t come with a license and that’s a no go when I want to embed it in OrcaMDF. Furthermore had a lot of Java artifacts lying around (relying on goto for instance) that I didn’t fancy. I chose to implement my own SCSU decompression based on the reference implementation provided by Unicode, Inc. I’ve only implemented decompression to end up with a very slim and simple SCSU decompressor.</p>
<p>I’ll be posting a blog on the decompressor itself as it has some value as a standalone class outside of OrcaMDF.</p>
<h2 id="Architecture_changes">Architecture changes</h2>
<p>I started out thinking I’d be able to finish off compression support within a week or two, after all, it was <a href="http://www.amazon.com/Microsoft%C2%AE-SQL-Server%C2%AE-2008-Internals/dp/0735626243" target="_blank">rather well documented</a>. It didn’t take long before it dawned upon me, just how many changes implementing compression would require. The record parser would obviously need to know whether the page was compressed or not. But where would it know that from? Previously all it got was a page pointer, now I had to lookup the compression (which varies by partition) metadata and make sure it was passed along all the way from the DataScanner to the page parser, to the record parser and onwards to the data type parsers.</p>
<p>I’ve had to implement multiple abstractions on top of the regular parsers to abstract away whether the records were stored in a compressed or non compressed format. Overall it’s resulted in a better architecture, but it took a lot more work than expected. Actually parsing the compressed record format was the smallest part of the ordeal – the documentation was spot on and it’s a simple format. The data types however, that took some more work until I had the format figured out.</p>
<h2 id="Taking_it_for_a_spin">Taking it for a spin</h2>
<p>As always, the <a href="https://github.com/improvedk/OrcaMDF" target="_blank">code is available at Github</a>, feel free to take a look! If you’re not the coding type, I’ve also uploaded the <a href="https://github.com/improvedk/OrcaMDF/downloads" target="_blank">binary download</a> (dated 2012-02-06) of the OrcaMDF Studio, a GUI built on top of OrcaMDF.</p>
<h2 id="Stats">Stats</h2>
<p>Being a lover of numbers myself, I love looking at statistics. Here’s a couple of random stats from OrcaMDF:</p>
<ul>
<li>123 commits, the first one being made on April 15th 2011 – that’s almost a year ago!</li>
<li>~11.700 lines of C# code (excluding blanks).</li>
<li>~1000 lines of comments.</li>
<li>~35% of the code is dedicated to testing, with a test suite comprising of over 200 tests.</li>
<li><a href="https://www.ohloh.net/p/OrcaMDF" target="_blank">Ohloh</a> estimates OrcaMDF has a development cost of $144,090 – makes me wonder if not my time would be better spent elsewhere…</li>
</ul>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Feb</span>
			<span class="day">06</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/adding-67-at-the-logic-gate-level/" title="Adding 6+7 At The Logic Gate Level" rel="bookmark">Adding 6+7 At The Logic Gate Level</a></h1>
		<div class="categories">
			
				<a href="/category/Computer Science/">Computer Science</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Most people can do simple decimal addition in their heads, and even advanced addition using common rules like carrying. Here’s how we’d add 6 + 7:</p>
<a id="more"></a>


<figure class="highlight"><pre><span class="code">  1</span>
<span class="code">   6</span>
<span class="header">+  7
----</span>
<span class="code">  13</span>
</pre></figure>

<p>Adding 6+7 gives a result of 3, with a 1 as a carry. In the final step, the 1 carry simply falls down as a 10 on the result, giving 10 + 3 = 13 as the final result.</p>
<p>It may seem extensive to go through this for such a simple operation, but it’s quite important to know of the carry method when we go on.</p>
<h2 id="Binary_addition">Binary addition</h2>
<p>Just as we added two decimal numbers, we can do the exact same in binary. In binary 6 is represented as 0b110 while 7 is represented as 0b111. Take a look:</p>
<p>First we add the first (rightmost) column, resulting in a 0b1 in the sum:</p>
<figure class="highlight"><pre><span class="code">   110</span>
<span class="header">+  111
------</span>
<span class="code">     1</span>
</pre></figure>

<p>Next up we add the second column. In this case the two ones produce the result 0b10 – meaning we’ll get a sum of 0b0 and a carry of 0b1:</p>
<figure class="highlight"><pre><span class="code">   110</span>
<span class="header">+  111
------</span>
<span class="code">    01</span>
</pre></figure>

<p>Then we add the third column. Ignoring the carry, 0b1 + 0b1 gives a sum of 0b10. Adding the 0b1 we had in carry, we get 0b11 – resulting in a sum of 0b1 as well as a carry of 0b1:</p>
<figure class="highlight"><pre><span class="code">  11</span>
<span class="code">   110</span>
<span class="header">+  111
------</span>
<span class="code">   101</span>
</pre></figure>

<p>And finally we add the final column, in this case containing nothing but the carry:</p>
<figure class="highlight"><pre><span class="code">  11</span>
<span class="code">   110</span>
<span class="header">+  111
------</span>
<span class="code">  1101</span>
</pre></figure>

<p>And there we go – 0b1101 = 13 = 6 + 7.</p>
<h2 id="Implementing_a_simple_ALU_that_does_addition">Implementing a simple ALU that does addition</h2>
<p>Now that we can do binary addition by hand, lets recreate a very simple <a href="http://en.wikipedia.org/wiki/Arithmetic_logic_unit" target="_blank">arithmetic logic unit</a> that’ll do the same. The ALU is at the very core of the CPU that’s powering your machine right now. It’s the hearth that does all of the arithmetic and logical operations that are required to run the computer.</p>
<p>In the following I will generally talk of single bits as being enabled/positive/true/1 or being disabled/negative/false/0. All four designations mean the same and will be used depending on the context.</p>
<h2 id="The_half_adder">The half adder</h2>
<p>The first step is to implement what’s known as a <a href="http://en.wikipedia.org/wiki/Adder_(electronics" target="_blank">half adder</a>#Half_adder). This is the circuit that takes two bits and adds them together. The result is a sum value as well as a carry. Both can be either 0 or 1.</p>
<p>In the following circuit we get two inputs from the left, bits A and B. Both A and B are connected to an <a href="http://en.wikipedia.org/wiki/XOR_gate" target="_blank">XOR gate</a>. The XOR gate (top) gives an output of 1 iff (<strong>if</strong> and only i<strong>f</strong>) only one of the inputs have a value of 1. If A and B have the same value, it gives a result of 0. This is just what we need for the sum – remember, 0b1 + 0b1 gave a result of 0b10 – a sum of 1 and a carry of 0. The XOR gate is thus used to calculate the sum – denoted S in the circuit below.</p>
<p>Both A and B are connected to an <a href="http://en.wikipedia.org/wiki/AND_gate" target="_blank">AND gate</a> as well (bottom). The AND gate gives a result of 1 iff both A and B are 1, in all other cases it gives a result of 0. This is just what we need – if both A and B are 1, it means we get an output of 1 – the carry.</p>
<div class="imgwrapper" style=""><div><a href="/adding-67-at-the-logic-gate-level/image_16.png" class="fancy"><img src="/adding-67-at-the-logic-gate-level/image_16.png" style="max-height: 250px"/></a></div></div>

<p>If we enable A, we see how the signal propagates through the XOR gate and results in an enabled sum:</p>
<div class="imgwrapper" style=""><div><a href="/adding-67-at-the-logic-gate-level/image_6.png" class="fancy"><img src="/adding-67-at-the-logic-gate-level/image_6.png" style="max-height: 250px"/></a></div></div>

<p>The result is exactly the same if we just enable B instead:</p>
<div class="imgwrapper" style=""><div><a href="/adding-67-at-the-logic-gate-level/image_14.png" class="fancy"><img src="/adding-67-at-the-logic-gate-level/image_14.png" style="max-height: 250px"/></a></div></div>

<p>And finally, if we enable both, we get a disabled sum but an enabled carry instead:</p>
<div class="imgwrapper" style=""><div><a href="/adding-67-at-the-logic-gate-level/image_12.png" class="fancy"><img src="/adding-67-at-the-logic-gate-level/image_12.png" style="max-height: 250px"/></a></div></div>

<p>As we’ll be reusing the half adder in the next circuit, I’ve converted it into an integrated circuit (IC). On the left we have the input bits A and B on top &amp; bottom respectively. On the right we have the sum on top and the carry at the bottom.</p>
<div class="imgwrapper" style=""><div><a href="/adding-67-at-the-logic-gate-level/image_18.png" class="fancy"><img src="/adding-67-at-the-logic-gate-level/image_18.png" style="max-height: 250px"/></a></div></div>

<p>Having created the half adder IC, we can now simplify our circuit somewhat:</p>
<div class="imgwrapper" style=""><div><a href="/adding-67-at-the-logic-gate-level/image_20.png" class="fancy"><img src="/adding-67-at-the-logic-gate-level/image_20.png" style="max-height: 250px"/></a></div></div>

<h2 id="The_full_adder">The full adder</h2>
<p>At this point we have a fully working ALU capable of adding two 1-bit numbers and outputting a 2-bit result. As most computers today are either 32-bit or 64-bit, we obviously need to expand our ALU’s capabilities. Let’s work towards making it accept two 2-bit inputs instead.</p>
<p>To do so we first need to create another component, the <a href="http://en.wikipedia.org/wiki/Adder_(electronics" target="_blank">full adder</a>#Full_adder). While the half adder is great for working with just two inputs, to calculate the next column we need to take three inputs – bits A and B, as well as the potential carry C. The result, as before, should still be a sum as well as a carry.</p>
<p>Technically what we’re creating is called a 1-bit full adder, since it’s able to add two 1-bit numbers while also respecting the carry input.</p>
<p>In the following circuit we use two of the half adder IC’s that we created before. Bits A and B are hooked into the first one, while the carry bit is hooked into the second half adder. The sum from the first half adder is used as the second input to the second half adder.</p>
<p>The end sum is a direct sum from both the half adders. For the sum to be enabled, both half adders must produce an enabled sum. Both carry outputs are connected to an <a href="http://en.wikipedia.org/wiki/OR_gate" target="_blank">OR gate</a>. As the name implies, the OR gate will output a positive result if either of the inputs are enabled.</p>
<div class="imgwrapper" style=""><div><a href="/adding-67-at-the-logic-gate-level/image_22.png" class="fancy"><img src="/adding-67-at-the-logic-gate-level/image_22.png" style="max-height: 250px"/></a></div></div>

<p>If we enabled the A bit, the sum passes right through both half adders and results in a positive sum output:</p>
<div class="imgwrapper" style=""><div><a href="/adding-67-at-the-logic-gate-level/image_24.png" class="fancy"><img src="/adding-67-at-the-logic-gate-level/image_24.png" style="max-height: 250px"/></a></div></div>

<p>If we enabled both A and B, the first half adder gives a carry output, which passes right through the OR gate and results in a positive carry output:</p>
<div class="imgwrapper" style=""><div><a href="/adding-67-at-the-logic-gate-level/image_26.png" class="fancy"><img src="/adding-67-at-the-logic-gate-level/image_26.png" style="max-height: 250px"/></a></div></div>

<p>And finally, if we enable the input carry bit as well, we get a carry output from the first half adder and a sum output from the second one:</p>
<div class="imgwrapper" style=""><div><a href="/adding-67-at-the-logic-gate-level/image_28.png" class="fancy"><img src="/adding-67-at-the-logic-gate-level/image_28.png" style="max-height: 250px"/></a></div></div>

<p>The way the circuit is constructed, it doesn’t matter which of the bits are enabled, only the amount of them. If one is enabled, we get a positive sum. Two enabled results in a positive carry. And finally, if all three are enabled, we get a positive sum as well as a positive carry.</p>
<p>Just to demonstrate, we can disable the B input and get the same positive carry result as we got with the A and B bits enabled:</p>
<div class="imgwrapper" style=""><div><a href="/adding-67-at-the-logic-gate-level/image_30.png" class="fancy"><img src="/adding-67-at-the-logic-gate-level/image_30.png" style="max-height: 250px"/></a></div></div>

<p>Just as we can disabled all but the carry input and get a sum output, just like when only the A bit was enabled:</p>
<div class="imgwrapper" style=""><div><a href="/adding-67-at-the-logic-gate-level/image_32.png" class="fancy"><img src="/adding-67-at-the-logic-gate-level/image_32.png" style="max-height: 250px"/></a></div></div>

<p>Having created this circuit, we can now convert it into a full adder IC and simplify our diagram:</p>
<div class="imgwrapper" style=""><div><a href="/adding-67-at-the-logic-gate-level/image_34.png" class="fancy"><img src="/adding-67-at-the-logic-gate-level/image_34.png" style="max-height: 250px"/></a></div></div>

<h2 id="Chaining_1-bit_full_adders_to_create_a_3-bit_ripple_carry_adder">Chaining 1-bit full adders to create a 3-bit ripple carry adder</h2>
<p>Now that we’re able to easily add two 1-bit numbers using our full adder, let’s try and chain them up so we can add two 2-bit numbers.</p>
<p>In the following diagram we have two 2-bit inputs. The first output bit of both inputs are connected to the A and B inputs on the first full adder (rightmost one). Likewise, the second output bits from each input is connected to the A and B inputs on the second full adder. The carry output from the first full adder is connected to the carry input on the second full adder.</p>
<div class="imgwrapper" style=""><div><a href="/adding-67-at-the-logic-gate-level/image_42.png" class="fancy"><img src="/adding-67-at-the-logic-gate-level/image_42.png" style="max-height: 250px"/></a></div></div>

<p>Now, we started out wanting to add the numbers 6 and 7. To do so, we need a 3-bit adder so we can express the input numbers 6 and 7, both requiring three input bits.</p>
<p>At this point it’s a trivial operation to extend the adder with one more bit. We simply connect each output bit from the first input to the A bits on each full adder. Likewise we connect each output bit on the second input to the B input bits on each full adder. The carry from the first full adder is added as carry input to the second, and likewise for the second and third full adders.</p>
<div class="imgwrapper" style=""><div><a href="/adding-67-at-the-logic-gate-level/image_44.png" class="fancy"><img src="/adding-67-at-the-logic-gate-level/image_44.png" style="max-height: 250px"/></a></div></div>

<p>By using the decimal inputs we can now type the input numbers 6 and 7 and see our whole circuit in action, providing the correct output of 13:</p>
<div class="imgwrapper" style=""><div><a href="/adding-67-at-the-logic-gate-level/image_46.png" class="fancy"><img src="/adding-67-at-the-logic-gate-level/image_46.png" style="max-height: 250px"/></a></div></div>

<p>And there we go, we’ve now created a 3-bit <a href="http://en.wikipedia.org/wiki/Adder_(electronics" target="_blank">ripple carry adder</a>#Ripple_carry_adder).</p>
<h2 id="Conclusion">Conclusion</h2>
<p>I’m sure (read: hope) I’m not the only one having the nightmare of an apocalyptic event occurring here on Earth. Imagine the scenario, you’ve got all of the materials in the world as well as all the manpower you need. Unfortunately, you’re the only computer scientist that’s survived. Given time, manpower and materials, would you be able to rebuild the computer as we know it today?</p>
<p>Each layer you peel off of the computer arms you with more knowledge and capability, not just at that layer, but at all of the layers that lie above. Knowing about gate logic enables you to understand so much more of how the CPU works as well as what’s actually being performed once you write “int x = 6+7;” in your application (assuming you also know about all of the layers between the logic gates and your C#/other high level code).</p>
<p>Naturally there are more layers to peel. For instance, you could create your own XOR/AND/OR gates using the base NAND gate. And you could create your own NAND gates using nothing but interconnected transistors. And you could create your own transistors using… You get the point.</p>
<p>I can’t help but feel in total awe of the amount of technology that’s packed in each and every CPU that’s shipped to a home computer somewhere. Experimenting with electrical circuits is lots of fun, and you learn loads from it.</p>
<p>If you want to try it out for yourself, go grab a copy of Steve Kollmansbergers (free) open source <a href="http://www.kolls.net/gatesim/" target="_blank">Logic Gate Simulator</a>.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jan</span>
			<span class="day">31</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/seemingly-random-exceptions-thrown-from-cachedpathdata-validatepath/" title="Seemingly Random Exceptions Thrown From CachedPathData.ValidatePath" rel="bookmark">Seemingly Random Exceptions Thrown From CachedPathData.ValidatePath</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Several times a day I’d get an error report email noting that the following exception had occurred in our ASP.NET 4.0 application:</p>
<a id="more"></a>

<blockquote>
<p>System.Web.HttpException (0x80004005)<br>at System.Web.CachedPathData.ValidatePath(String physicalPath)<br>at System.Web.HttpApplication.PipelineStepManager.ValidateHelper(HttpContext context)</p>
</blockquote>
<p>The 80004005 code is a red herring – it’s used for lots of different errors and doesn’t really indicate what’s wrong. Besides that, there’s no message on the exception, so I was at a loss for what might’ve caused it.</p>
<p>We have several 100k’s of visitors each day and I only got 5-10 of these exceptions a day, so it wasn’t critical. Even so, I don’t like exceptions being thrown without reason. After much digging (and cursing at the combination of our error logging and gmail trimming the affected URL’s), I discovered the cause.</p>
<p>All of the URL’s had an extra %20 at the end – caused by others linking incorrectly to our site.</p>
<p>After a short bit of Googling, I found the new <a href="http://msdn.microsoft.com/en-us/library/system.web.configuration.httpruntimesection.relaxedurltofilesystemmapping.aspx" target="_blank">RelaxedUrlToFileSystemMapping httpRuntime attribute</a> in .NET 4.0. And sure enough, setting it to false (or letting it have it’s default false value), an exception is thrown when I add %20 to the URL. Once set to true, everything works as expected.</p>
<p>Though I got the problem solved, I would’ve appreciated a more descriptive exception being thrown.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jan</span>
			<span class="day">30</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/the-anatomy-of-row-amp-page-compressed-integers/" title="The Anatomy of Row &amp; Page Compressed Integers" rel="bookmark">The Anatomy of Row &amp; Page Compressed Integers</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - Internals/">SQL Server - Internals</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>While working on row compression support for <a href="https://github.com/improvedk/OrcaMDF" target="_blank">OrcaMDF</a>, I ran into some challenges when trying to parse integers. Contrary to normal non-compressed integer storage, these are all variable width – meaning an integer with a value of <em>50</em> will only take up one byte, instead of the usual four. That wasn’t new though, seeing as <a href="/how-are-vardecimals-stored">vardecimals are also stored as variable width</a>. What is different however is the way the numbers are stored on disk. Note that while I was only implementing row compression, the integer compression used in page compression is exactly the same, so this goes for both types of compression.</p>
<a id="more"></a>

<h2 id="Tinyint">Tinyint</h2>
<p>Tinyint is pretty much identical to the usual tinyint storage. The only exception being that a value of 0 will take up no bytes when row compressed, where as in non-compressed storage it’ll store the value 0x0, taking up a single byte. All of the integer types are the same regarding 0-values – the value is indicated by the compression row metadata and thus requires no actual value stored.</p>
<h2 id="Smallint">Smallint</h2>
<p>Let’s start out by looking at a normal non-compressed smallint, for the values –2, –1, 1 and 2. As mentioned before, 0 isn’t interesting as nothing is stored. Note that all of these values are represented exactly as they’re stored on disk – in this case they’re stored in <a href="http://en.wikipedia.org/wiki/Endianness" target="_blank">little endian</a>.</p>
<figure class="highlight cs"><pre>-<span class="number">2</span>	=	<span class="number">0xFEFF</span>
-<span class="number">1</span>	=	<span class="number">0xFFFF</span>
<span class="number">1</span>	=	<span class="number">0x0100</span>
<span class="number">2</span>	=	<span class="number">0x0200</span>
</pre></figure>

<p>Starting with the values 1 and 2, they’re very straightforward. Simply convert it into decimal and you’ve got the actual number. –1 however, is somewhat different. The value 0xFFFF converted to decimal is 65.535 – the maximum value we can store in an unsigned two-byte integer. The SQL Server range for a smallint is –32.768 to 32.767.</p>
<p>Calculating the actual values relies on what’s called <a href="http://en.wikipedia.org/wiki/Integer_overflow" target="_blank">integer overflows</a>. Take a look at the following C# snippet:</p>
<figure class="highlight cs"><pre><span class="keyword">unchecked</span>
{
	Console.WriteLine(<span class="number">0</span> + (<span class="keyword">short</span>)<span class="number">32767</span>);
	Console.WriteLine(<span class="number">0</span> + (<span class="keyword">short</span>)<span class="number">32768</span>);
	Console.WriteLine(<span class="number">0</span> + (<span class="keyword">short</span>)<span class="number">32769</span>);
	<span class="comment">// ...</span>
	Console.WriteLine(<span class="number">0</span> + (<span class="keyword">short</span>)<span class="number">65534</span>);
	Console.WriteLine(<span class="number">0</span> + (<span class="keyword">short</span>)<span class="number">65535</span>);
}
</pre></figure>

<p>The output is as follows:</p>
<figure class="highlight cs"><pre><span class="number">32767</span>
-<span class="number">32768</span>
-<span class="number">32767</span>
-<span class="number">2</span>
-<span class="number">1</span>
</pre></figure>

<p>If we start with the value 0 and add the maximum value for a signed short, 32.767, we obviously end up with just that – 32.767. However, if we add 32.768, which is outside the range of the short, we rollover and end up with the smallest possible short value. Since these are constant numbers, the compiler won’t allow the overflow – unless we encapsulate our code in an unchecked {} section.</p>
<p>You may have heard of the fabled <a href="http://en.wikipedia.org/wiki/Sign_bit" target="_blank">sign bit</a>. Basically it’s the highest order bit that’s being used to designate whether a number is positive or negative. As special sounding as it is, it should be obvious from the above that the sign bit isn’t special in any way – though it can be queried to determine the sign of a given number. Take a look at what happens to the sign bit when we overflow:</p>
<figure class="highlight cs"><pre><span class="number">32.767</span>	=	<span class="number">0</span>b0111111111111111
-<span class="number">32.768</span>	=	<span class="number">0</span>b1000000000000000
-<span class="number">32.767</span>	=	<span class="number">0</span>b1000000000000001
</pre></figure>

<p>For the number to become large enough for it to cause an overflow, the high order “sign bit” needs to be set. It isn’t magical in any way, it’s simply used to cause the overflow.</p>
<p>OK, so that’s some background information on how normal non-compressed integers are stored. Now let’s have a look at how those same smallint values are stored in a row compressed table:</p>
<figure class="highlight cs"><pre>-<span class="number">2</span>	=	<span class="number">0x7E</span>
-<span class="number">1</span>	=	<span class="number">0x7F</span>
<span class="number">1</span>	=	<span class="number">0x81</span>
<span class="number">2</span>	=	<span class="number">0x82</span>
</pre></figure>

<p>Let’s try and convert those directly to decimal, as we did before:</p>
<figure class="highlight cs"><pre>-<span class="number">2</span>	=	<span class="number">0x7E</span>	=	<span class="number">126</span>
-<span class="number">1</span>	=	<span class="number">0x7F</span>	=	<span class="number">127</span>
<span class="number">1</span>	=	<span class="number">0x81</span>	=	<span class="number">129</span>
<span class="number">2</span>	=	<span class="number">0x82</span>	=	<span class="number">130</span>
</pre></figure>

<p>Obviously, these are not stored the same way. The immediate difference is that we’re now only using a single byte – due to the variable-width storage nature. When parsing these values, we should simply look at the number of byte stored. If it’s using a single byte, we know it’s in the 0 to 255 range (for tinyints) or –128 to 127 range for smallints. Smallints in that range will be stored using a single signed byte.</p>
<p>If we use the same methodology as  before, we obviously get the wrong results.1 &lt;&gt; 0 + 129. The trick in this case is to treat the stored values as unsigned integers, and then minimum value as the offset. That is, instead of using 0 as the offset, we’ll use the signed 1-byte minimum value of –128 as the offset:</p>
<figure class="highlight cs"><pre>-<span class="number">2</span>	=	<span class="number">0x7E</span>	=	-<span class="number">128</span> + <span class="number">126</span>
-<span class="number">1</span>	=	<span class="number">0x7F</span>	=	-<span class="number">128</span> + <span class="number">127</span>
<span class="number">1</span>	=	<span class="number">0x81</span>	=	-<span class="number">128</span> + <span class="number">129</span>
<span class="number">2</span>	=	<span class="number">0x82</span>	=	-<span class="number">128</span> + <span class="number">130</span>
</pre></figure>

<p>Aha, so that must mean we’ll need to store two bytes as soon as we exceed the signed 1-byte range, right? Right!</p>
<div class="imgwrapper" style=""><div><a href="/the-anatomy-of-row-amp-page-compressed-integers/image_2.png" class="fancy"><img src="/the-anatomy-of-row-amp-page-compressed-integers/image_2.png" style="max-height: 250px"/></a></div></div>

<p>One extremely important difference is that the non-compressed values will always be stored in little endian on disk, whereas the row compressed integers are stored using big endian! So not only do they use different offset values, they also use different endianness. The end result is the same, but the calculations involved are dramatically different.</p>
<h2 id="Int_&amp;_bigint">Int &amp; bigint</h2>
<p>Once I figured out the endianness and number scheme of the row-compressed integer values, int and bigint were straightforward to implement. As with the other types, they’re still variable width so you may have a 5-byte bigint as well as a 1-byte int. Here’s the main parsing code for my SqlBigInt type implementation:</p>
<figure class="highlight cs"><pre><span class="keyword">switch</span> (<span class="keyword">value</span>.Length)
{
	<span class="keyword">case</span> <span class="number">0</span>:
		<span class="keyword">return</span> <span class="number">0</span>;

	<span class="keyword">case</span> <span class="number">1</span>:
		<span class="keyword">return</span> (<span class="keyword">long</span>)(-<span class="number">128</span> + <span class="keyword">value</span>[<span class="number">0</span>]);

	<span class="keyword">case</span> <span class="number">2</span>:
		<span class="keyword">return</span> (<span class="keyword">long</span>)(-<span class="number">32768</span> + BitConverter.ToUInt16(<span class="keyword">new</span>[] { <span class="keyword">value</span>[<span class="number">1</span>], <span class="keyword">value</span>[<span class="number">0</span>] }, <span class="number">0</span>));

	<span class="keyword">case</span> <span class="number">3</span>:
		<span class="keyword">return</span> (<span class="keyword">long</span>)(-<span class="number">8388608</span> + BitConverter.ToUInt32(<span class="keyword">new</span> <span class="keyword">byte</span>[] { <span class="keyword">value</span>[<span class="number">2</span>], <span class="keyword">value</span>[<span class="number">1</span>], <span class="keyword">value</span>[<span class="number">0</span>], <span class="number">0</span> }, <span class="number">0</span>));

	<span class="keyword">case</span> <span class="number">4</span>:
		<span class="keyword">return</span> (<span class="keyword">long</span>)(-<span class="number">2147483648</span> + BitConverter.ToUInt32(<span class="keyword">new</span>[] { <span class="keyword">value</span>[<span class="number">3</span>], <span class="keyword">value</span>[<span class="number">2</span>], <span class="keyword">value</span>[<span class="number">1</span>], <span class="keyword">value</span>[<span class="number">0</span>] }, <span class="number">0</span>));

	<span class="keyword">case</span> <span class="number">5</span>:
		<span class="keyword">return</span> (<span class="keyword">long</span>)(-<span class="number">549755813888</span> + BitConverter.ToInt64(<span class="keyword">new</span> <span class="keyword">byte</span>[] { <span class="keyword">value</span>[<span class="number">4</span>], <span class="keyword">value</span>[<span class="number">3</span>], <span class="keyword">value</span>[<span class="number">2</span>], <span class="keyword">value</span>[<span class="number">1</span>], <span class="keyword">value</span>[<span class="number">0</span>], <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span> }, <span class="number">0</span>));

	<span class="keyword">case</span> <span class="number">6</span>:
		<span class="keyword">return</span> (<span class="keyword">long</span>)(-<span class="number">140737488355328</span> + BitConverter.ToInt64(<span class="keyword">new</span> <span class="keyword">byte</span>[] { <span class="keyword">value</span>[<span class="number">5</span>], <span class="keyword">value</span>[<span class="number">4</span>], <span class="keyword">value</span>[<span class="number">3</span>], <span class="keyword">value</span>[<span class="number">2</span>], <span class="keyword">value</span>[<span class="number">1</span>], <span class="keyword">value</span>[<span class="number">0</span>], <span class="number">0</span>, <span class="number">0</span> }, <span class="number">0</span>));

	<span class="keyword">case</span> <span class="number">7</span>:
		<span class="keyword">return</span> (<span class="keyword">long</span>)(-<span class="number">36028797018963968</span> + BitConverter.ToInt64(<span class="keyword">new</span> <span class="keyword">byte</span>[] { <span class="keyword">value</span>[<span class="number">6</span>], <span class="keyword">value</span>[<span class="number">5</span>], <span class="keyword">value</span>[<span class="number">4</span>], <span class="keyword">value</span>[<span class="number">3</span>], <span class="keyword">value</span>[<span class="number">2</span>], <span class="keyword">value</span>[<span class="number">1</span>], <span class="keyword">value</span>[<span class="number">0</span>], <span class="number">0</span> }, <span class="number">0</span>));

	<span class="keyword">case</span> <span class="number">8</span>:
		<span class="keyword">return</span> (<span class="keyword">long</span>)(-<span class="number">9223372036854775808</span> + BitConverter.ToInt64(<span class="keyword">new</span>[] { <span class="keyword">value</span>[<span class="number">7</span>], <span class="keyword">value</span>[<span class="number">6</span>], <span class="keyword">value</span>[<span class="number">5</span>], <span class="keyword">value</span>[<span class="number">4</span>], <span class="keyword">value</span>[<span class="number">3</span>], <span class="keyword">value</span>[<span class="number">2</span>], <span class="keyword">value</span>[<span class="number">1</span>], <span class="keyword">value</span>[<span class="number">0</span>] }, <span class="number">0</span>));

	<span class="keyword">default</span>:
		<span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">"Invalid value length: "</span> + <span class="keyword">value</span>.Length);
}
</pre></figure>

<p>The <em>value</em> variable is a byte array containing the bytes as stored on disk. If the length is 0, nothing is stored and hence we know it has a value of 0. For each of the remaining valid lengths, it’s simply a matter of using the smallest representable number as the offset and then adding the stored value onto it.</p>
<p>For non-compressed values we can use the BitConverter class directly as it expects the input value to be in system endianness – and for most Intel and AMD systems, that’ll be little endian (which means OrcaMDF won’t run on a big endian system!). However, as the compressed values are stored in big endian, I have to remap the input array into little endian format, as well as pad the 0-bytes so it matches up with the short, int and long sizes.</p>
<p>For the shorts and ints I’m reading unsigned values in, as that’s really what I’m interested in. This works since int + uint is coerced into a long value. I can’t do the same for the long’s since there’s no data type larger than a long. For the maximum long value of 9.223.372.036.854.775.807, what’s actually stored on disk is 0xFFFFFFFFFFFFFFFF. Parsing that as a signed long value using BitConverter results in the value –1 due to the overflow. Wrong as that may be, it all works out in the end due to an extra negative overflow:</p>
<figure class="highlight cs"><pre>-<span class="number">9.223</span><span class="number">.372</span><span class="number">.036</span><span class="number">.854</span><span class="number">.775</span><span class="number">.808</span> + <span class="number">0xFFFFFFFFFFFFFF</span> =&gt;
-<span class="number">9.223</span><span class="number">.372</span><span class="number">.036</span><span class="number">.854</span><span class="number">.775</span><span class="number">.808</span> + -<span class="number">1</span> =
<span class="number">9.223</span><span class="number">.372</span><span class="number">.036</span><span class="number">.854</span><span class="number">.775</span><span class="number">.807</span>
</pre></figure>

<h2 id="Conclusion">Conclusion</h2>
<p>As usual, I’ve had a lot of fun trying to figure out how the bytes on disk ended up as the values I saw when performing a SELECT query. It doesn’t take long to realize that while the excellent Internals book really takes you far, there’s so much more to dive into.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jan</span>
			<span class="day">26</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/presenting-at-sqlbits-x/" title="Presenting at SQLBits X" rel="bookmark">Presenting at SQLBits X</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p><a href="http://www.sqlbits.com/" target="_blank">SQLBits X</a> is coming up soon, and by the looks of it, it’ll feature a full house of excited attendees:</p>
<a id="more"></a>

<div class="imgwrapper" style=""><div><a href="/presenting-at-sqlbits-x/image_4.png" class="fancy"><img src="/presenting-at-sqlbits-x/image_4.png" style="max-height: 250px"/></a></div></div>

<p>If you haven’t been before, just take a look at these <a href="http://sqlblogcasts.com/blogs/simons/archive/2012/01/26/ten-reason-to-attend-sqlbits-x.aspx?utm_source=twitterfeed&amp;utm_medium=twitter&amp;utm_campaign=Feed%3A+SimonsSqlServerStuff+%28SimonS+SQL+Server+Stuff%29" target="_blank">ten reasons, provided by Simon Sabin</a>. Not convinced yet? Take a look at <a href="http://www.simple-talk.com/community/blogs/jonathanallen/archive/2010/09/20/94522.aspx#105686" target="_blank">10 more reasons, provided by Jonathan Allen</a> (though written for SQLBits 7, they’re just as applicable for SQLBits X).</p>
<h2 id="Revealing_the_Magic">Revealing the Magic</h2>
<p>To my big surprise, I’ve got another chance at speaking at SQLBits – I must’ve done <a href="/sqlbits-9-session-evaluation">something right</a> after all :)</p>
<p>I will once again be presenting a session based on my work with <a href="https://github.com/improvedk/OrcaMDF" target="_blank">OrcaMDF</a>. Here’s the abstract:</p>
<blockquote>
<p>Think SQL Server is magical? You’re right! However, there’s some sense to the magic, and that’s what I’ll show you in this level 500 deep dive session. Through my work in creating OrcaMDF, an open source parser for SQL Server databases, I’ve learned a lot of internal details for the SQL Server database file format. In this session, I will walk you through the internal storage format of MDF files, how we might go about parsing a complete database ourselves, using nothing but a hex editor. I will cover how SQL Server stores its own internal metadata about objects, how it knows where to find your data on disk, and once it finds it, how to read it. Using the knowledge from this session, you’ll find it much easier to predict performance characteristics of queries since you’ll know what needs to be done.</p>
</blockquote>
<p>The basis of the session is the same as <a href="/sqlbits-9-agenda-published">the one I gave last year</a>. However, based on the feedback I got, as well as the work I’ve done with OrcaMDF since then, I’ll be readjusting the content a bit. I’ll not be covering disaster recovery, just as I’ll trim some sections to leave room for some new stuff like compression internals.</p>
<p>Just as last time, the session is meant to <strong>inspire</strong>, not to teach. There’ll be far too much content to understand everything during the session. My hope is to reveal how SQL Server is really governed by a relatively small set of rules – and once you know those, you’ve got a powerful tool to add to your existing arsenal.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jan</span>
			<span class="day">25</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/broadcom-nics-considered-harmful/" title="Broadcom NICs Considered Harmful?" rel="bookmark">Broadcom NICs Considered Harmful?</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server/">SQL Server</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Every night at around 2AM I get an email from my best friend, confirming that she’s OK. It usually looks something like this:</p>
<a id="more"></a>

<blockquote>
<p>JOB RUN:    ‘Backup.Daily’ was run on 04-08-2011 at 02:00:00<br>DURATION:    0 hours, 5 minutes, 57 seconds<br>STATUS:     Succeeded<br>MESSAGES:    The job succeeded.  The Job was invoked by Schedule 9 (Backup.Daily (Mon-Sat)).  The last step to run was step 1 (Daily).</blockquote></p>
</blockquote>
<p>Just the other night, I got one that didn’t look right:</p>
<blockquote>
<p>DURATION: 4 hours, 3 minutes, 32 seconds</p>
</blockquote>
<p>Looking at the event log revealed a symptom of the problem:</p>
<blockquote>
<p>SQL Server has encountered 2 occurrence(s) of I/O requests taking longer than 15 seconds to complete on file [J:XXX.mdf] in database [XXX] (150).  The OS file handle is 0x0000000000003294.  The offset of the latest long I/O is: 0x00000033da0000</p>
</blockquote>
<p>Our databases were the same, the workload was the same. The only teeny, tiny little thing that had changed was that I’d moved all of the data files + backup drive onto a new SAN. Obviously, that’s gotta be the problem.</p>
<h2 id="Broadcom,_how_I_loathe_thee!">Broadcom, how I loathe thee!</h2>
<p>Through some help on #sqlhelp and Database Administrators, I managed to find the root cause as well as to fix it. For a full walkthrough of the process, please see <a href="http://dba.stackexchange.com/questions/10950/i-o-requests-taking-longer-than-15-seconds" target="_blank">my post on Database Administrators</a>.</p>
<p>Mark Storey-Smith ended up giving the vital clue – a link to a <a href="http://blog.serverfault.com/2011/03/04/broadcom-die-mutha/" target="_blank">post by Kyle Brandt</a> which I clearly remember reading earlier on, but didn’t suspect was applicable to my situation. I ended up disabling jumbo frames, large send offload (LSO) and TCP connection offload (TOE), and lo and behold, everything was running smoothly. By enabling each of the features individually I pinpointed the issue to the Broadcom TOE feature on the NICs. Once I enabled TOE, my IO requests were stalling. As soon as I disabled TOE, everything ran smoothly.</p>
<div class="imgwrapper" style=""><div><a href="/broadcom-nics-considered-harmful/image_10.png" class="fancy"><img src="/broadcom-nics-considered-harmful/image_10.png" style="max-height: 250px"/></a></div></div>

<p>After disabling TOE on both NICs, my backups went from looking like this:</p>
<div class="imgwrapper" style=""><div><a href="/broadcom-nics-considered-harmful/image_14.png" class="fancy"><img src="/broadcom-nics-considered-harmful/image_14.png" style="max-height: 250px"/></a></div></div>

<p>To this:</p>
<div class="imgwrapper" style=""><div><a href="/broadcom-nics-considered-harmful/image_12.png" class="fancy"><img src="/broadcom-nics-considered-harmful/image_12.png" style="max-height: 250px"/></a></div></div>

<p>At this point the backup timing was back on track and the event log was all green. I did use the same Broadcom NICs with TOE enabled for the previous SAN, so obviously something must have triggered the issue, whether it’s a problem between the new switches, the drivers, cables, I have no idea. All I know is that I’m apparently not the first to suffer similar issues with Broadcom NICs and I know for sure that I’ll get Intels in my next servers.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jan</span>
			<span class="day">23</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/presenting-at-miracle-open-world-2012/" title="Presenting at Miracle Open World 2012" rel="bookmark">Presenting at Miracle Open World 2012</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Having presented at Miracle Open World back to back in 2010 and 2011, I’m excited to announce I’ll also be present in 2012! Not only will I be presenting, I’ll be presenting a full day track.</p>
<a id="more"></a>

<p>I’ve been continually improving my original internals training day that I <a href="/presenting-a-precon-at-sqlbits">presented at SQLBits</a>. At MOW, I’ll be presenting the evolved session, which now also includes compression internals. As the allotted time at MOW is slightly shorter than at SQLBits, and I have slightly more material, expect to bring coffee :)</p>
<p>For more details on the session, please see <a href="http://mow2012.dk/program/sql-server-storage-engine.aspx" target="_blank">the description at the MOW website</a>.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Dec</span>
			<span class="day">13</span>
		</div>
		<div class="lower">2011</div>
	</div>

	<div class="title">
		<h1><a href="/how-are-vardecimals-stored/" title="The Anatomy of Vardecimals" rel="bookmark">The Anatomy of Vardecimals</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - Internals/">SQL Server - Internals</a>
				, 
			
				<a href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>In this post I’ll do a deep dive into how vardecimals are stored on disk. For a general introduction to what they are and how/when to use them, <a href="http://msdn.microsoft.com/en-us/library/bb326755.aspx" target="_blank">see this post</a>.</p>
<a id="more"></a>

<h2 id="Is_vardecimal_storage_enabled?">Is vardecimal storage enabled?</h2>
<p>First up, we need to determine whether vardecimals are enabled, since it completely changes the way decimals are stored on disk. Vardecimal is not a type itself, so all columns, whether stored as decimals are vardecimals share the same system type (106). Note that in SQL Server, <em>numeric</em> is exactly the same as decimal. Anywhere I mention decimal, you can substitute that with numeric and get the same result.</p>
<p>Provided SQL Server is running, you can execute the following to determine the vardecimal status of any given table:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span> OBJECTPROPERTY(OBJECT_ID(<span class="string">'MyTable'</span>), <span class="string">'TableHasVarDecimalStorageFormat'</span>)</span>
</pre></figure>

<p>If you don’t have access to, or do not want to use the OBJECTPROPERTY function, you can query the sys.system_internals_partition_columns DMV to obtain the same information – see <a href="/determining-if-vardecimal-is-enabled-for-a-table-without-using">Determining If vardecimal Is Enabled For a Table Without Using OBJECTPROPERTY</a>.</p>
<h2 id="Fixed_length_goes_variable_length">Fixed length goes variable length</h2>
<p>Normal decimal columns are stored in the fixed length portion of a <a href="http://sqlskills.com/blogs/paul/post/Inside-the-Storage-Engine-Anatomy-of-a-record.aspx" target="_blank">record</a>. This means all that’s actually stored is the data itself. There is no need for length information as the number of required storage bytes can be calculated exclusively by the use of metadata. Once you enable vardecimals, all decimals are no longer stored in the fixed length portion of the record, but as a variable length field instead.</p>
<p>Storing the decimal as a variable length field has a couple of implications:</p>
<ul>
<li>We can no longer statically calculate the number of bytes required to store a given value.</li>
<li>There’s a two byte overhead for storing the record offset value in the variable length offset array.</li>
<li>If the record previously had no variable length records, that overhead is actually four bytes since we also need to store the number of variable length records in the record offset array.</li>
<li>The actual value of the decimal has a variable amount of bytes that we need to decipher.</li>
</ul>
<h2 id="What_does_the_vardecimal_value_consist_of?">What does the vardecimal value consist of?</h2>
<p>Once we’ve parsed the record and thereby retrieved the vardecimal value bytes from the variable length portion of the record, we need to parse it. There will <em>always</em> be at least <em>two</em> bytes for the value, though there can be up to 20 at most.</p>
<p>Where normal decimals are basically stored as one humongous integer (with the scale metadata defining the decimal position), vardecimals are stored using <a href="http://en.wikipedia.org/wiki/Scientific_notation" target="_blank">scientific notation</a>. Using scientific notation, we need to store three different values:</p>
<ul>
<li>The sign (positive/negative).</li>
<li>The exponent.</li>
<li>The mantissa.</li>
</ul>
<p>Using these three components, we can calculate the actual number using the following formula:</p>
<figure class="highlight"><pre>(sign) * mantissa * 10<span class="tag">&lt;<span class="title">sup</span>&gt;</span>exponent<span class="tag">&lt;/<span class="title">sup</span>&gt;</span>
</pre></figure>

<h3 id="Example">Example</h3>
<p>Assume we have a vardecimal(5,2) column and we store the value 123.45. In scientific notation, that would be expressed as 1.2345 * 10<sup>2</sup>. In this case we have positive sign (1), an mantissa of 1.2345 and an exponent of 2. SQL Server knows that the mantissa always has a fixed decimal point after the first digit, and as such it simply stores the integer value 12345 as the mantissa. While the exponent is 2, SQL Server knows we have a scale of 2 defined, and it subtracts that from the exponent and thus stores 0 as the actual exponent.</p>
<p>Once we read it, we end up with a formula like this for calculating the mantissa (note that at this point we don’t care if the mantissa is positive or negative – we’ll take that into account later):</p>
<figure class="highlight"><pre>mantissa / 10<span class="tag">&lt;<span class="title">sup</span>&gt;</span>floor(log10(mantissa))<span class="tag">&lt;/<span class="title">sup</span>&gt;</span>
</pre></figure>

<p>And plotting in our values, we get:</p>
<figure class="highlight"><pre>12345 / 10<span class="tag">&lt;<span class="title">sup</span>&gt;</span>floor(log10(12345))<span class="tag">&lt;/<span class="title">sup</span>&gt;</span>
</pre></figure>

<p>Through basic simplification we get:</p>
<figure class="highlight"><pre>12345 / 10<span class="tag">&lt;<span class="title">sup</span>&gt;</span>4<span class="tag">&lt;/<span class="title">sup</span>&gt;</span>
</pre></figure>

<p>Which finally ends up in the scientific notation version of the mantissa:</p>
<figure class="highlight"><pre>1.2345
</pre></figure>

<p>So far so good – we now have the mantissa value. At this point we need just two things – to apply the sign and to move the decimal into the right position by factoring in the exponent. As SQL Server knows the scale is 2, it stores an exponent value of 2 instead of 4, in effect subtracting the scale from the exponent value – enabling us to ignore the scale and just calculate the number directly.</p>
<p>And thus we have all we need to calculate the final number:</p>
<figure class="highlight"><pre>(sign) * mantissa * 10<span class="tag">&lt;<span class="title">sup</span>&gt;</span>exponent<span class="tag">&lt;/<span class="title">sup</span>&gt;</span> =&gt; (1) * 1.2345 * 10<span class="tag">&lt;<span class="title">sup</span>&gt;</span>2<span class="tag">&lt;/<span class="title">sup</span>&gt;</span> =&gt; 1.2345 * 10<span class="tag">&lt;<span class="title">sup</span>&gt;</span>2<span class="tag">&lt;/<span class="title">sup</span>&gt;</span> = 123.45
</pre></figure>

<h2 id="Reading_the_sign_&amp;_exponent">Reading the sign &amp; exponent</h2>
<p>The very first byte of the value contains the sign and the exponent. In the previous sample, the value takes up four bytes (plus an additional two for the offset array entry):</p>
<figure class="highlight"><pre>0xC21EDC20
</pre></figure>

<p>If we take a look at just the first byte, and convert it to binary, we get the following:</p>
<pre>
Hex: C2
Bin: <span style="background-color: #dfce04;">1</span>1000010
</pre>

<p>The most significant bit (the leftmost one), or bit 7 (0-indexed) is the sign bit. If it’s set, the value is positive. If it’s not set, it’s negative. Since it has a value of 1, we know that the result is positive.</p>
<p>Bits 0-6 is a 7-bit value containing the exponent. A normal unsigned 7-bit value can contain values from 0 to 127. As the decimal data type has a range of –10<sup>38</sup>+1 to 10<sup>38</sup>-1, we need to be able to store negative numbers. We could use one of those 7 bits as a sign bit, and then store the value in just 6 bits, allowing a range from –64 to 63. SQL Server however does use all 7 bits for the value itself, but stores the value offset by 64. Thus, an exponent value of 0 will store the value 64. An exponent of –1 will store 63 while an exponent of 1 will store 65, and so forth.</p>
<p>In our sample, reading bits 0-6 gives the following value:</p>
<pre>
<span style="font-family: 'Courier New';"><span style="font-size: medium;">0b1</span><span style="font-family: 'Courier New';"><span style="font-size: medium;"><span style="background-color: #dfce04; color: #444444;">1000010</span></span></span><span style="font-family: 'Courier New';"><span style="font-size: medium;"> = 66</span></span> </span>
</pre>

<p>Subtracting the offset of 64 leaves us with an exponent value of 2.</p>
<h2 id="Mantissa_chunk_storage">Mantissa chunk storage</h2>
<p>The remaining bytes contain the mantissa value. Before we get started, let’s convert them into binary:</p>
<pre>
<span style="font-family: 'Courier New'; font-size: medium;">Hex: </span><span style="font-family: 'Courier New'; font-size: medium;">1E       DC       20

Bin: 00011110 11011100 00100000</span>
</pre>

<p>The mantissa is stored in chunks of 10 bits, each chunk representing three digits in the mantissa (and remember, the mantissa is just one large integer – it’s not until later that we begin to think of it as a decimal pointer number). Splitting the bytes into chunks gives us the following grouping:</p>
<pre>
<span style="font-family: 'Courier New'; font-size: medium;">Hex:   1E       DC       20
Bin:   <span style="background-color: #f3a447;">00011110 11</span><span style="background-color: #dfce04;">011100 0010</span>0000

Chunk: <span style="background-color: #f3a447;">1          </span><span style="background-color: #dfce04;">2          </span></span>
</pre>

<p>In this case, SQL Server wastes 4 bits by using a chunk size that doesn’t align with the 8-bit byte size. This begs the question, why choose a chunk size of just exactly 10 bits? Those 10 bits are required to represent all possible values of a three-digit integer (0-999). What if we instead wanted to use a chunk size representing just a single digit?</p>
<p>In that case, we’d need to represent the values 0-9. That requires a total of 4 bits (0b1001 = 9). However, using those 4 bits, we can actually represent a range spanning from 0 to 15 – which means we’re wasting 6 of those values as they’ll never be needed. In percentages, we’re wasting 6/16 = 37.5%!</p>
<p>Let’s try and plot some different chunk sizes into a graph:</p>
<div class="imgwrapper" style=""><div><a href="/how-are-vardecimals-stored/image_3.png" class="fancy"><img src="/how-are-vardecimals-stored/image_3.png" style="max-height: 250px"/></a></div></div>

<p>We see that chunk sizes of both 4 and 7 have massive waste compared to a chunk size of 10. At 20 bits, we’re getting closer, but still waste twice as much as at 10.</p>
<p>Now, waste isn’t everything. For compression, ideally we don’t want to use more digits than absolutely necessary. With a chunk size of 10, representing 3 digits, we’re wasting two digits for values in the range of 0-9. However, for numbers in the range 100-999, we’re spot on. If we were to use a chunk size of 20 bits, representing 6 digits per chunk, we’d be wasting bytes for values 0-99999, while we’d be spot on for values 1000000-999999. Basically it’s a tradeoff – the higher the granularity, with the least amount of waste, the better. The further to the right we go in the graph, the less the granularity. With this, it seems obvious that a chunk size of 10 bits is an excellent choice – it has the lowest amount of waste with a suitable amount of granularity at 3 digits.</p>
<p>There’s just one more detail before we move on. Imagine we need to store the mantissa value 4.12, effectively resulting in the integer value 412.</p>
<pre><span style="font-family: 'Courier New'; font-size: medium;">Dec: 412
Bin: 01100111 00
Hex: 67       0
</span></pre>

<p>In this case, we’d waste 8 bits in the second byte, since we only need a single chunk, but we need two bytes to represent those 10 bits. In this case, given that the last two bits aren’t set, SQL Server will simply truncate that last byte. Thus, if you’re reading a chunk and you run out of bits on disk, you can assume that the remaining bits aren’t set.</p>
<h2 id="Parsing_a_vardecimal_value">Parsing a vardecimal value</h2>
<p>Finally – we’re ready to actually parse a stored vardecimal (implemented in C#)! We’ll use the previous example, storing the 123.45 value in a decimal(5,2) column. On disk, we read the following into a byte array called <em>value</em>:</p>
<pre><span style="font-family: 'Courier New'; font-size: medium;">Hex: C2       1E       DC       20
Bin: 11000010 00011110 11011100 00100000</span></pre>

<h3 id="Reading_the_sign_bit">Reading the sign bit</h3>
<p>Reading the sign bit is relatively simple. We’ll only be working on the first byte:</p>
<pre><span style="font-family: 'Courier New'; font-size: medium;">Hex: C2       1E       DC       20
Bin: <span style="background-color: #dfce04;">1</span>1000010 <span style="color: #a5a5a5;">00011110 11011100 00100000</span></span></pre>

<p>By shifting the bits 7 spots to the right, all we’re left with is the most significant bit, the least significant position. This means we’ll get a value of 1 is the sign is positive, and 0 if it’s negative.</p>
<figure class="highlight cs"><pre><span class="keyword">decimal</span> sign = (<span class="keyword">value</span>[<span class="number">0</span>] &gt;&gt; <span class="number">7</span>) == <span class="number">1</span> ? <span class="number">1</span> : -<span class="number">1</span>;
</pre></figure>

<h3 id="Reading_the_exponent">Reading the exponent</h3>
<p>The next (technically these bits come before the sign bit) 7 bits contain the exponent value.</p>
<pre><span style="font-family: 'Courier New'; font-size: medium;">Hex: C2       <span style="color: #a5a5a5;">1E       DC       20</span>
Bin: 1<span style="background-color: #dfce04;">1000010</span> <span style="color: #a5a5a5;">00011110 11011100 00100000</span></pre>

<p>Converting the value 0b1000010 into decimal yields the decimal result 66. As we know the exponent is always offset by a value of 64, we need to subtract 64 from the stored value to get to the actual exponent value:</p>
<pre><span style="font-family: 'Courier New'; font-size: medium;">Exponent = 0b1000010 – 0n64 <=> Exponent = 66 – 64 = 2</span></pre>

<h3 id="Reading_the_mantissa">Reading the mantissa</h3>
<p>Next up is the mantissa value. As mentioned, we need to read it in chunks of 10 bits, while taking care of there potentially being some truncated bits.</p>
<p>First, we need to know how many bits there are available. Doing this is straightforward – we simply multiply the number of mantissa bytes (which is all of the bytes, except one) by 8:</p>
<figure class="highlight cs"><pre><span class="keyword">int</span> totalBits = (<span class="keyword">value</span>.Length - <span class="number">1</span>) * <span class="number">8</span>;
</pre></figure>

<p>Once we know how many bits are available (3 bytes of 8 bits = 24 in this case), we can calculate the number of chunks:</p>
<figure class="highlight cs"><pre><span class="keyword">int</span> mantissaChunks = (<span class="keyword">int</span>)Math.Ceiling(totalBits / <span class="number">10</span>d);
</pre></figure>

<p>Since each chunk takes up 10 bits, we just need to divide the total number of bits by 10. If there’s padding at the end, to match a byte boundary, it’ll all be 0’s and won’t change the end result. Thus for a 2-byte mantissa we’ll have 8 bits to spare, which will all be non-significant 0’s. For a 3-byte mantissa we’ll have 4 bits to spare – once again adding 0 to the total mantissa value.</p>
<p>At this point we’re ready to read the chunk values. Before doing so, we’ll allocate two variables:</p>
<figure class="highlight cs"><pre><span class="keyword">decimal</span> mantissa = <span class="number">0</span>;
<span class="keyword">int</span> bitPointer = <span class="number">8</span>;
</pre></figure>

<p>The mantissa variable contains the cumulative mantissa value, accumulating value each time we read a new 10-bit chunk. The <em>bitPointer</em> is a pointer to the index of the bit currently being. As we’re not going to read the first byte, we’ll start this one off at bit index 8 (0-based, thus bit index 8 = the first bit of the second byte).</p>
<p>Looking at the bits as one long stream makes it look simple – we just read from left to right, right? Not quite. As you may remember, (visually) the rightmost bit is the least significant, and is thus the first one we should read. However – we need to read one byte at a time. As such, the <em>overall</em> direction is left-to-right, chunkwise. Once we get to any given chunk, we need to read one byte at a time. Bits 1-8 in the first chunk are read from the first byte, while bits 9-10 are read from the second byte, following the orange arrows in the figure (byte read order following the large ones, individual byte bit read order following the smaller ones):</p>
<div class="imgwrapper" style=""><div><a href="/how-are-vardecimals-stored/image_26.png" class="fancy"><img src="/how-are-vardecimals-stored/image_26.png" style="max-height: 250px"/></a></div></div>

<p>To easily access all of the bits, and to avoid doing a lot of manual bit shifting, I initialize a BitArray that contains all of the data bits:</p>
<figure class="highlight cs"><pre><span class="keyword">var</span> mantissaBits = <span class="keyword">new</span> BitArray(<span class="keyword">value</span>);
</pre></figure>

<p>Using this, you have to know how the bit array maps into the bytes. Visually, it looks like this, the mantissaBits array index being on top:</p>
<div class="imgwrapper" style=""><div><a href="/how-are-vardecimals-stored/image_28.png" class="fancy"><img src="/how-are-vardecimals-stored/image_28.png" style="max-height: 250px"/></a></div></div>

<p>I know this may seem complex, but it’s all just a matter of knowing which pointers point to which values. Our source is the array of <em>bytes</em>. The way we access the individual bits is through the <em>mantissaBits</em> array, which is just one big array of pointers to the individual bits.</p>
<p>Looking at just the first 8 bits, the manitssaBits array aligns nicely with the direction we need to read. The first entry (mantissaBits[0]) points to the first/rightmost bit in the first byte. The second entry points to the second bit we need to read, and so forth. Thus, the first 8 bits are straightforward to read. The next two however, they require us to skip 6 entries in the mantissaBits array so we read index 14 and 15, as those point to the last two bits in the next byte.</p>
<p>Reading the second chunk, we have to go back and read bit index 8-13 and then skip to index 20-23, ignoring entries 16-19 as they’re just irrelevant padding. This is rather tricky to get right. Fortunately we can freely choose to read the bits from the least significant to the most significant, or the other way around.</p>
<p>Let’s first look at the implementation:</p>
<figure class="highlight cs"><pre><span class="keyword">for</span> (<span class="keyword">int</span> chunk = mantissaChunks; chunk &gt; <span class="number">0</span>; chunk--)
{
	<span class="comment">// The cumulative value for this 10-bit chunk</span>
	<span class="keyword">decimal</span> chunkValue = <span class="number">0</span>;

	<span class="comment">// For each bit in the chunk, shift it into position, provided it's set</span>
	<span class="keyword">for</span> (<span class="keyword">int</span> chunkBit = <span class="number">9</span>; chunkBit &gt;= <span class="number">0</span>; chunkBit--)
	{
		<span class="comment">// Since we're looping bytes left-to-right, but read bits right-to-left, we need</span>
		<span class="comment">// to transform the bit pointer into a relative index within the current byte.</span>
		<span class="keyword">int</span> byteAwareBitPointer = bitPointer + <span class="number">7</span> - bitPointer % <span class="number">8</span> - (<span class="number">7</span> - (<span class="number">7</span> - bitPointer % <span class="number">8</span>));

		<span class="comment">// If the bit is set and it's available (SQL Server will truncate 0's), shift it into position</span>
		<span class="keyword">if</span> (mantissaBits.Length &gt; bitPointer && mantissaBits[byteAwareBitPointer])
			chunkValue += (<span class="number">1</span> &lt;&lt; chunkBit);

		bitPointer++;
	}

	<span class="comment">// Once all bits are in position, we need to raise the significance according to the chunk</span>
	<span class="comment">// position. First chunk is most significant, last is the least significant. Each chunk</span>
	<span class="comment">// defining three digits.</span>
	mantissa += chunkValue * (<span class="keyword">decimal</span>)Math.Pow(<span class="number">10</span>, (chunk - <span class="number">1</span>) * <span class="number">3</span>);
}
</pre></figure>

<p>The outer for loop loops through the chunks, going from the most significant to the least significant chunk. In this case we’ll first iterate over chunk 2, then chunk 1.</p>
<p>The chunkValue variable holds the total value for the chunk that we’re currently reading. We’ll be shifting bits into the variable until we have parsed all 10 bits.</p>
<p>Next, we loop from the most significant bit to the least significant bit (that is, going from the <em>chunkBit</em> values 9 through 0). By reading the most significant bit first, basically reading the values backwards, we avoid having to skip inside the individual bytes. We’ll always read the bits going from right to left in the mantissaBits array, following the top arrows like this:</p>
<div class="imgwrapper" style=""><div><a href="/how-are-vardecimals-stored/image_30.png" class="fancy"><img src="/how-are-vardecimals-stored/image_30.png" style="max-height: 250px"/></a></div></div>

<p>Though we do read each byte backward, everything else just follows a natural path, which makes parsing a lot easier.</p>
<p>The <em>byteAwareBitPointer</em> variable is the index in our mantissaBits array from where we’ll read the current value. The calculation ensures we read each byte starting from the top mantissaBits index to the lower one. The first chunk is read in the following mantissaBit index order:</p>
<figure class="highlight"><pre>7, 6, 5, 4, 3, 2, 1, 0, 15, 14
</pre></figure>

<p>And the second chunk is read in the following mantissaBit order:</p>
<figure class="highlight"><pre>13, 12, 11, 10, 9, 8, 23, 22, 21, 20
</pre></figure>

<p>Once we’ve read a specific bit, we shift it into position in the chunkValue variable – though only if it’s set and it’s available (that is, it hasn’t been zero-truncated).</p>
<p>Once all bits have been shifted into position, we apply the chunk significance to the value. In our case, storing the value 12345, we’re actually storing the value 123450 (since each chunk stores three digits, it’ll always be a multiple of 3 digits). The first read chunk (<em>chunk 2</em>) contains the value 123, which corresponds to the value 123000. The second read chunk (<em>chunk 1</em>) contains the value 450. Multiplying by 10<sup>(chunk–1)&lt;<em>3</sup> ensures we get the right order of magnitude (x1000 for </em>chunk 2<em> and x1 for </em>chunk 1*). For each chunk iteration, we add the finalized chunk value to the total mantissa sum.</p>
<p>Once we have the integer based mantissa value of 123450, we need to insert the decimal point, using the following formula:</p>
<figure class="highlight"><pre>mantissa = mantissa / 10<span class="tag">&lt;<span class="title">sup</span>&gt;</span>floor(log10(mantissa))<span class="tag">&lt;/<span class="title">sup</span>&gt;</span>
</pre></figure>

<p>Implemented like so:</p>
<figure class="highlight cs"><pre>mantissa = mantissa / (<span class="keyword">decimal</span>)Math.Pow(<span class="number">10</span>, Math.Floor(Math.Log10((<span class="keyword">double</span>)mantissa)));
</pre></figure>

<p>This results in the mantissa having a value of 1.2345</p>
<h3 id="Mantissa_parsing_performance">Mantissa parsing performance</h3>
<p>Before you beat me to it – this implementation is far from fast. To start with, we could easily shift whole groups of bits into position instead of just one at a time. That’d ensure each chunk would take no more than two shifting operations, instead of ~10 in this implementation. However, my goal for this implementation is code clarity first and foremost. I’m nowhere near the point where I want to look at optimizing OrcaMDF for speed.</p>
<h3 id="Putting_it_all_together">Putting it all together</h3>
<p>Once we have the sign, the exponent and the mantissa, we simply calculate the final value like so:</p>
<figure class="highlight cs"><pre><span class="keyword">return</span> sign * mantissa * (<span class="keyword">decimal</span>)Math.Pow(<span class="number">10</span>, exponent);
</pre></figure>

<p>In our case it has the following result:</p>
<figure class="highlight"><pre>1 * 1.2345 * 10<span class="tag">&lt;<span class="title">sup</span>&gt;</span>2<span class="tag">&lt;/<span class="title">sup</span>&gt;</span> = 1.2345 * 100 = 123.45
</pre></figure>

<h2 id="Conclusion">Conclusion</h2>
<p>Vardecimal was the only option for built-in compression back in SQL Server 2005 SP2. Since 2008, we’ve had row &amp; page compression available (which both feature a superset of the vardecimal storage format). Ever since the release of row &amp; page compression, Microsoft has made it clear that vardecimal is a deprecated feature, and it will be removed in a future version. Since vardecimal requires enterprise edition, just like row &amp; page compression, there’s really no reason to use it, unless you’re running SQL Server 2005, or unless you have a very specific dataset that would only benefit from compressing the decimals and no other values.</p>
<p>Knowing how the vardecimal storage format works is a great precursor for looking at compression internals – which I’ll be writing about in a later post – and I’ll be presenting on it at the <a href="/presenting-at-the-2012-spring-sql-server-connections">2012 Spring SQL Server Connections</a>.</p>
<p>In the meantime you can check out my <a href="https://github.com/improvedk/OrcaMDF/blob/83b7460b07d175f6edb21e094106ec8a52d44bf9/src/OrcaMDF.Core/Engine/SqlTypes/SqlDecimal.cs" target="_blank">SqlDecimal.cs implementation on github</a>. Or you can have a look at the complete <a href="https://github.com/improvedk/OrcaMDF" target="_blank">OrcaMDF source code</a>.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>


<div class="paging">
	<a href="/page/6/"><div class="past">« Past</div></a>
	<a href="/page/4/"><div class="future">Future »</div></a>
	<div class="clear"></div>
</div>

				</div>
			</div>

			<div id="asides">
				<div class="categories aside">
					<span class="sectiontitle">CATEGORIES</span>
					<ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/category/.NET/">.NET</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/AS/Flex/Flash/">AS/Flex/Flash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Amazon Web Services/">Amazon Web Services</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Computer Science/">Computer Science</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Conferences and Presenting/">Conferences and Presenting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/IIS/">IIS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Life/">Life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Miscellaneous/">Miscellaneous</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Performance/">Performance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Poker/">Poker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server/">SQL Server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Community/">SQL Server - Community</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Data Types/">SQL Server - Data Types</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Internals/">SQL Server - Internals</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Optimization/">SQL Server - Optimization</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Tricks/">SQL Server - Tricks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Testing/">Testing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Tools of the Trade/">Tools of the Trade</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Umbraco/">Umbraco</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Visual Studio/">Visual Studio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Web/">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windbg/">Windbg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windows/">Windows</a></li></ul>

					
				</div>

				<div class="archive aside">
					<span class="sectiontitle">ARCHIVE</span>
					<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archive/2014">2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2013">2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2012">2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2011">2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2010">2010</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2009">2009</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2008">2008</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2007">2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2006">2006</a></li></ul>
				</div>
			</div>

			<div class="clear"></div>
		</div>
		
		<footer>
			<div class="wrapper">Copyright &copy; 2014 Mark S. Rasmussen</div>
		</footer>

		<script type="text/javascript">
			$(function () {
				// Show mobile menu
				$("li.navicon").click(function () {
					if ($("header ul.mobile a").length == 0) {
						// Pages
						$mobilePages = $("div#naviconcontent ul.pages");
						$("header nav ul.normal > li").not(".navicon").each(function (i, el) {
							$mobilePages.append($(el).clone());
						});

						// Categories
						$mobileCategories = $("div#naviconcontent ul.categories");
						$("div#asides div.categories > ul > li").each(function (i, el) {
							$mobileCategories.append($(el).clone());
						});

						// Archive
						$mobileArchive = $("div#naviconcontent ul.archive");
						$("div#asides div.archive > ul > li").each(function (i, el) {
							$mobileArchive.append($(el).clone());
						});
					};

					$("header ul.mobile").toggle();
				});

				// Fancybox setup
				$("a.fancy").fancybox({
					hideOnContentClick: true,
					overlayShow: true
				});
			});
		</script>
	</body>
</html>