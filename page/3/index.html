<!DOCTYPE html>
<html>
	

<head>
	<title>Mark S. Rasmussen</title>
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
	<meta charset="UTF-8" />
	<meta property="og:locale" content="en_US" />
	<meta property="og:type" content="website" />
	<meta name="google-site-verification" content="alt7-wfK3ZujMQ4D0jYNd0yC5LGetGdqBlBmZsqQlVw" />
	<link rel="alternative" href="http://feeds.feedburner.com/Improvedk" title="Mark S. Rasmussen" type="application/atom+xml">
	<script src="/js/combined.js"></script>
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-2479580-1', 'improve.dk');
		ga('send', 	'pageview');
	</script>
	<link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
	<body>
		<div id="headerline"></div>
	
		<header>
			<div class="wrapper">
				<div id="title">
					<a href="/">Mark S. Rasmussen</a> <span>improve.dk</span>
				</div>
				
				<nav>
					<ul class="normal">
						<li class="navicon"><img src="/img/navicon.png" /></li>
						<li><a href="/about-me/">About Me</a></li>
					</ul>
				</nav>
				
				<ul id="sharing">
					<li><a href="mailto:mark@improve.dk"><img src="/img/at.png" /></a></li>
					<li><a href="http://feeds.feedburner.com/Improvedk" id="rssfeed"><img src="/img/rss.png" /></a></li>
					<li><a href="https://twitter.com/improvedk"><img src="/img/twitter.png" /></a></li>
					<li><a href="https://github.com/improvedk"><img src="/img/github.png" /></a></li>
					<li><a href="https://www.linkedin.com/in/markrasmussen/"><img src="/img/linkedin.png" /></a></li>
				</ul>

				<div class="clear"></div>
				
				<div id="naviconcontent">
					<ul class="mobile">
						<li>
							Pages
							<ul class="pages"></ul>
						</li>
						<li>
							Categories
							<ul class="categories"></ul>
						</li>
						<li>
							Archive
							<ul class="archive"></ul>
						</li>
					</ul>
				</div>
			</div>
		</header>

		<div id="mainwrapper">
			<div id="contentwrapper">
				<div id="content">
				
					
	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Feb</span>
			<span class="day">21</span>
		</div>
		<div class="lower">2013</div>
	</div>

	<div class="title">
		<h1><a href="/sqlsaturday-196-presenting-a-precon/" title="SQLSaturday &amp;#35;196 - Presenting a Precon" rel="bookmark">SQLSaturday &amp;#35;196 - Presenting a Precon</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Seeing SQLSaturday events sprawling up all over the world makes me all warm and fuzzy inside. Long have I been considering whether one might happen in Denmark, but to be honest, I didn’t think the audience would be big enough. I’m biased though as I’ve mainly attended events outside of Denmark, and thus most of my acquaintances have been non-Danish. But lo and behold, Régis Baccaro just announced that <a href="http://www.sqlsaturday.com/196/eventhome.aspx" target="_blank">SQLSaturday #196</a> now has <a href="https://twitter.com/regbac/status/304320528095793154" target="_blank">101 registered attendees</a>! And best of all, it’s held in Copenhagen on the 20th of April.</p>
<a id="more"></a>

<div class="imgwrapper" style=""><div><a href="/sqlsaturday-196-presenting-a-precon/logo.png" class="fancy"><img src="/sqlsaturday-196-presenting-a-precon/logo.png" style="max-height: 250px"/></a></div></div>

<p>Having just about 100 people attend my <a href="http://warmcrocconf.net/Marksr.aspx" target="_blank">Top X SQL Server Developer Mistakes session at Warm Crocodile</a> recently made me realize just how popular SQL Server really is. Nosql might be the hype, but when it comes to business, quite a lot of developers are “stuck” with SQL Server on a daily basis. For the same reason, I absolutely cannot recommend going to SQLSaturday #196 enough! It’s free, it’s an excellent networking opportunity and it’s sure to be full of great speakers and content. Go ahead - <a href="http://www.sqlsaturday.com/196/register.aspx" target="_blank">register here</a>!</p>
<div class="imgwrapper" style=""><div><a href="/sqlsaturday-196-presenting-a-precon/392531_496414643720736_540150277_n-250x166.jpg" class="fancy"><img src="/sqlsaturday-196-presenting-a-precon/392531_496414643720736_540150277_n-250x166.jpg" style="max-height: 250px"/></a></div></div>

<p>I’ll have the pleasure and honor of presenting my <a href="http://sqlsat196precon.eventbrite.com/" target="_blank">A Deep Dive Into the Depths of the SQL Server Storage Engine and MDF File Format</a> precon on the 19th of April, the day before the SQLSaturday event itself. It’s not the first time I’m presenting this precon, in fact, this’ll be my fifth time. This means I’ve now had a number of chances to test my content and optimize the format to ensure you get maximum value out of the day. If you’re planning on attending and have any special requests or questions regarding the content, please do let me know in the comments here!</p>
<p>If storage internals isn’t your thing, there are two other top notch presenters - <a href="http://www.jenstirrup.com/" target="_blank">Jen Stirrup</a> and <a href="http://itknowledgeexchange.techtarget.com/sql-server/" target="_blank">Denny Cherry</a>. Jen will be presenting a <a href="http://sqlsat196precon.eventbrite.com/" target="_blank">Data Visualisation Deep-Dive using SQL Server 2012</a> while Denny will present on <a href="http://sqlsat196precon.eventbrite.com/" target="_blank">SQL Server 2012 in a Highly Available World</a>.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Feb</span>
			<span class="day">20</span>
		</div>
		<div class="lower">2013</div>
	</div>

	<div class="title">
		<h1><a href="/blog-revamp/" title="Blog Revamp" rel="bookmark">Blog Revamp</a></h1>
		<div class="categories">
			
				<a href="/category/Life/">Life</a>
				, 
			
				<a href="/category/Miscellaneous/">Miscellaneous</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Having been at it for almost 11 years, I’ve been through a number of blog revamps through the time. And here we are, once again.</p>
<a id="more"></a>

<p><a href="http://web.archive.org/web/20020929133654/http://www.improve.dk/" target="_blank">I first launched the blog back in 2002</a>, though it was in Danish back then. In 2006 I decided to start over, removed all my Danish content and began blogging in English - at that time, I wrote my own blog engine in a couple of days on a couch in Henderson, Nevada, anxiously waiting to turn 21 so I could participate in the World Series of Poker.</a></p>
<p>Back in 2011 I chose to migrate all my content onto <a href="http://subtextproject.com/" target="_blank">Subtext</a>. What I failed to notice was that the project was pretty much dead, so it was a migration doomed to be still born. It did however allow me access to <a href="http://en.wikipedia.org/wiki/Windows_Live_Writer" target="_blank">Windows Live Writer</a> which served its purpose - it got me blogging again due to its simplicity in use. However, I quickly started to struggle with Subtext as templating was beyond difficult and I had to resort to ugly hacks to make it work the best I could.</p>
<div class="imgwrapper" style=""><div><a href="/blog-revamp/wp-blue-640x9601.png" class="fancy"><img src="/blog-revamp/wp-blue-640x9601.png" style="max-height: 250px"/></a></div></div>

<p>And so it was time for yet another revamp, this time, hopefully the last. Converting everything into Wordpress ought to be a simple task, if it wasn’t for the fact that I had almost 250 posts and 700 comments. Most of them stemming from my homebrewed system, later haphazardly migrated to Subtext, and now lying before Wordpress. I had to write a custom exporter to get most of my content from Subtext into the <a href="http://ipggi.wordpress.com/2011/03/16/the-wordpress-extended-rss-wxr-exportimport-xml-document-format-decoded-and-explained/" target="_blank">Wordpress WXR format</a>. Dealing with attachments, encoding and comments was a major pain. Once I had everything into Wordpress, I had to go through each and every post and manually format the contents - having seven years of legacy left little to no structure, making it impossible to style.</p>
<p>At this point, all I needed to do was to find a good theme and I was up and running. Unfortunately I tend to be quite picky, so I couldn’t find anything I really liked. In the end, I ended up writing my own theme, <a href="https://github.com/improvedk/improve.dk" target="_blank">which I’ve just published to Github</a>. My main priority has been to create a very simplistic theme that worked great across devices, while allowing me to post easily readable code snippets. If you have any suggestions for improvements, I’d love to hear them!</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jan</span>
			<span class="day">17</span>
		</div>
		<div class="lower">2013</div>
	</div>

	<div class="title">
		<h1><a href="/top-x-sql-server-developer-mistakes/" title="Top X SQL Server Developer Mistakes" rel="bookmark">Top X SQL Server Developer Mistakes</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>It’s been a long day, and I’m finally on my way home from Copenhagen to Aarhus. Unfortunately I wasn’t able to attend the first day of the Warm Crocodile conference yesterday. Thankfully I was able to attend today, and even better, I got a chance to present my “Top X SQL Server Developer Mistakes” session today, and I’d like to thank everybody who showed up and helped fill the room to its limit. I got a lot of excellent questions during, as well as after, the session. If I missed yours, please do <a href="mailto:mark@improve.dk">get in touch</a>.</p>
<a id="more"></a>

<p>Both slides, demos and source samples are available on Github:<br><a href="https://github.com/improvedk/Presentation-TopXSQLServerDeveloperMIstakes" target="_blank">https://github.com/improvedk/Presentation-TopXSQLServerDeveloperMIstakes</a></p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jan</span>
			<span class="day">01</span>
		</div>
		<div class="lower">2013</div>
	</div>

	<div class="title">
		<h1><a href="/and-thus-i-lost-my-introduction/" title="And Thus I Lost My Introduction" rel="bookmark">And Thus I Lost My Introduction</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - Community/">SQL Server - Community</a>
				, 
			
				<a href="/category/SQL Server/">SQL Server</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Seeing as most of my presentations are rather technical, I like to start by pointing out the fact that I have no finished higher education (though in progress), no major certifications or recognitions/awards. This leaves a perfect opportunity for me to explain, from the ground up, why I still feel qualified to be standing in front of the audience.</p>
<a id="more"></a>

<p>Today I can no longer use that introduction, as I’ve been awarded as a Microsoft MVP (SQL Server) for 2013. I’m honored to receive the award, but mostly, I’m thankful to my friends in the SQL Family.</p>
<p>The last couple of years have been busy, 2012 definitely taking the cake, by my standards. Through my SQL Server engagement I’ve made countless of friends across the world - The Netherlands, Slovenia, Denmark, Germany, Austria, Sweden, all over the US, South Africa, UK, and many more. I remember how my parents worried about how you couldn’t make friends through the computer… While generally being right, on this point, they were not.</p>
<p>As 2012 neared its end, I also promised myself that I would slow down a tad in 2013. I will still try to keep that promise. I simply cannot afford to travel around as much as I did last year, and I really want to trade just a bit of conference travel for pure leisure travel time. However, this doesn’t mean I’ll go into hibernation for the duration of 2012. Currently I’m scheduled to be presenting at the <a href="http://warmcrocconf.net/" target="_blank">Warm Crocodile</a> conference in Copenhagen on January 17th and I know I’ll do my utmost to attend the PASS Summit this year, having missed it in 2012. What else 2013 will bring, time will tell :)</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Aug</span>
			<span class="day">27</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/where-does-sql-server-store-the-source-for-stored-procedures/" title="Where Does SQL Server Store the Source for Stored Procedures?" rel="bookmark">Where Does SQL Server Store the Source for Stored Procedures?</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - Internals/">SQL Server - Internals</a>
				, 
			
				<a href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>At the moment I’m working on extending <a href="https://github.com/improvedk/OrcaMDF" target="_blank">OrcaMDF Studio</a> to not only list base tables, DMVs and tables, but also stored procedures. That’s easy enough, we just need to query sys.procedures – or that is, the sys.sysschobjs base table, since the sys.procedures DMV isn’t available when SQL Server isn’t running.</p>
<a id="more"></a>

<p>However, I don’t want to just list the stored procedures, I also want to present the source code in them. That brings up a new task – retrieving said source code. Where is it stored? I wasn’t able to find anything on Google, so let’s take a look for ourselves!</p>
<p>I’ve created a new empty database with a data file of three megabytes. In this database, I’ve created a single stored procedure like so:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SET</span> ANSI_NULLS <span class="keyword">ON</span>
<span class="keyword">GO</span>
<span class="keyword">SET</span> QUOTED_IDENTIFIER <span class="keyword">ON</span>
<span class="keyword">GO</span>
-- =============================================
-- Author:		
-- <span class="keyword">Create</span> <span class="keyword">date</span>: 
-- Description:	
-- =============================================
<span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> XYZ
	<span class="keyword">AS</span>
<span class="keyword">BEGIN</span>
	-- <span class="keyword">SET</span> NOCOUNT <span class="keyword">ON</span> added <span class="keyword">to</span> prevent extra result sets <span class="keyword">from</span>
	-- interfering <span class="keyword">with</span> <span class="keyword">SELECT</span> statements.
	<span class="keyword">SET</span> NOCOUNT <span class="keyword">ON</span>;</span>

    <span class="comment">-- Insert statements for procedure here</span>
	<span class="operator"><span class="keyword">SELECT</span> <span class="string">'AABBCC'</span> <span class="keyword">AS</span> <span class="keyword">Output</span>
<span class="keyword">END</span></span>
</pre></figure>

<p>Now when I select from sys.procedures, we can see that the procedure has object ID 2105058535:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">select</span> * <span class="keyword">from</span> sys.procedures</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/where-does-sql-server-store-the-source-for-stored-procedures/image_2.png" class="fancy"><img src="/where-does-sql-server-store-the-source-for-stored-procedures/image_2.png" style="max-height: 250px"/></a></div></div>

<p>So far so good. We can then retrieve the definition itself as an nvarchar(MAX) by querying sys.sql_modules like so:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">select</span> * <span class="keyword">from</span> sys.sql_modules <span class="keyword">where</span> object_id = <span class="number">2105058535</span></span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/where-does-sql-server-store-the-source-for-stored-procedures/image_4.png" class="fancy"><img src="/where-does-sql-server-store-the-source-for-stored-procedures/image_4.png" style="max-height: 250px"/></a></div></div>

<p>And there you have it, the source code for the XYZ procedure! But hold on a moment, while I’ve gotten the object ID for the procedure by querying the sys.sysschobjs base table, I don’t have access to sys.sql_modules yet, as that’s a view and not a base table. Let’s take a look at where sys.sql_modules gets the definition from:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">select</span> object_definition(object_id(<span class="string">'sys.sql_modules'</span>))</span>
</pre></figure>


<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span>
	object_id = o.id,
	definition = Object_definition(o.id),
	uses_ansi_nulls = Sysconv(<span class="keyword">bit</span>, o.status & <span class="number">0x40000</span>), -- OBJMOD_ANSINULLS
	uses_quoted_identifier = sysconv(<span class="keyword">bit</span>, o.status & <span class="number">0x80000</span>),   -- OBJMOD_QUOTEDIDENT
	is_schema_bound = sysconv(<span class="keyword">bit</span>, o.status & <span class="number">0x20000</span>),    -- OBJMOD_SCHEMABOUND
	uses_database_collation = sysconv(<span class="keyword">bit</span>, o.status & <span class="number">0x100000</span>),  -- OBJMOD_USESDBCOLL
	is_recompiled = sysconv(<span class="keyword">bit</span>, o.status & <span class="number">0x400000</span>),     -- OBJMOD_NOCACHE
	null_on_null_input = sysconv(<span class="keyword">bit</span>, o.status & <span class="number">0x200000</span>),   -- OBJMOD_NULLONNULL
	execute_as_principal_id = x.indepid
<span class="keyword">FROM</span>
	sys.sysschobjs o
<span class="keyword">LEFT</span> <span class="keyword">JOIN</span>
	sys.syssingleobjrefs x <span class="keyword">ON</span> x.depid = o.id <span class="keyword">AND</span> x.class = <span class="number">22</span> <span class="keyword">AND</span> x.depsubid = <span class="number">0</span> -- SRC_OBJEXECASOWNER
<span class="keyword">WHERE</span>
	o.pclass &lt;&gt; <span class="number">100</span> <span class="keyword">AND</span>
	(
		(o.type = <span class="string">'TR'</span> <span class="keyword">AND</span> has_access(<span class="string">'TR'</span>, o.id, o.pid, o.nsclass) = <span class="number">1</span>) <span class="keyword">OR</span>
		(type <span class="keyword">IN</span> (<span class="string">'P'</span>,<span class="string">'V'</span>,<span class="string">'FN'</span>,<span class="string">'IF'</span>,<span class="string">'TF'</span>,<span class="string">'RF'</span>,<span class="string">'IS'</span>) <span class="keyword">AND</span> has_access(<span class="string">'CO'</span>, o.id) = <span class="number">1</span>) <span class="keyword">OR</span>
		(type <span class="keyword">IN</span> (<span class="string">'R'</span>,<span class="string">'D'</span>) <span class="keyword">AND</span> o.pid = <span class="number">0</span>)
	)</span>
</pre></figure>

<p>Hmmm, so sys.sql_modules gets the source by using the object_definition system function. Unfortunately, the following doesn’t work:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">select</span> object_definition(object_id(<span class="string">'object_definition'</span>))</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/where-does-sql-server-store-the-source-for-stored-procedures/image_6.png" class="fancy"><img src="/where-does-sql-server-store-the-source-for-stored-procedures/image_6.png" style="max-height: 250px"/></a></div></div>

<p>I happen to remember that sys.sql_modules is a replacement for the, now deprecated, sys.syscomments legacy view. Let’s take a look at where that one gets the source from:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">select</span> object_definition(object_id(<span class="string">'sys.syscomments'</span>))</span>
</pre></figure>


<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span>
	o.id <span class="keyword">AS</span> id,  
	convert(<span class="keyword">smallint</span>, <span class="keyword">case</span> <span class="keyword">when</span> o.type <span class="keyword">in</span> (<span class="string">'P'</span>, <span class="string">'RF'</span>) <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">AS</span> <span class="keyword">number</span>,  
	s.colid,
	s.status,  
	convert(varbinary(<span class="number">8000</span>), s.text) <span class="keyword">AS</span> ctext,  
	convert(<span class="keyword">smallint</span>, <span class="number">2</span> + <span class="number">4</span> * (s.status & <span class="number">1</span>)) <span class="keyword">AS</span> texttype,  
	convert(<span class="keyword">smallint</span>, <span class="number">0</span>) <span class="keyword">AS</span> <span class="keyword">language</span>,  
	sysconv(<span class="keyword">bit</span>, s.status & <span class="number">1</span>) <span class="keyword">AS</span> encrypted,  
	sysconv(<span class="keyword">bit</span>, <span class="number">0</span>) <span class="keyword">AS</span> compressed,  
	s.text  
<span class="keyword">FROM</span>
	sys.sysschobjs o
<span class="keyword">CROSS</span> APPLY
	OpenRowset(<span class="keyword">TABLE</span> SQLSRC, o.id, <span class="number">0</span>) s  
<span class="keyword">WHERE</span>
	o.nsclass = <span class="number">0</span> <span class="keyword">AND</span>
	o.pclass = <span class="number">1</span> <span class="keyword">AND</span>
	o.type <span class="keyword">IN</span> (<span class="string">'C'</span>,<span class="string">'D'</span>,<span class="string">'P'</span>,<span class="string">'R'</span>,<span class="string">'V'</span>,<span class="string">'X'</span>,<span class="string">'FN'</span>,<span class="string">'IF'</span>,<span class="string">'TF'</span>,<span class="string">'RF'</span>,<span class="string">'IS'</span>,<span class="string">'TR'</span>) <span class="keyword">AND</span>
	has_access(<span class="string">'CO'</span>, o.id) = <span class="number">1</span>  

<span class="keyword">UNION</span> <span class="keyword">ALL</span>  

<span class="keyword">SELECT</span>
	c.object_id <span class="keyword">AS</span> id,  
	convert(<span class="keyword">smallint</span>, c.column_id) <span class="keyword">AS</span> <span class="keyword">number</span>,  
	s.colid,
	s.status,  
	convert(varbinary(<span class="number">8000</span>), s.text) <span class="keyword">AS</span> ctext,  
	convert(<span class="keyword">smallint</span>, <span class="number">2</span> + <span class="number">4</span> * (s.status & <span class="number">1</span>)) <span class="keyword">AS</span> texttype,  
	convert(<span class="keyword">smallint</span>, <span class="number">0</span>) <span class="keyword">AS</span> <span class="keyword">language</span>,  
	sysconv(<span class="keyword">bit</span>, s.status & <span class="number">1</span>) <span class="keyword">AS</span> encrypted,  
	sysconv(<span class="keyword">bit</span>, <span class="number">0</span>) <span class="keyword">AS</span> compressed,  
	s.text  
<span class="keyword">FROM</span>
	sys.computed_columns c
<span class="keyword">CROSS</span> APPLY
	OpenRowset(<span class="keyword">TABLE</span> SQLSRC, c.object_id, c.column_id) s  

<span class="keyword">UNION</span> <span class="keyword">ALL</span>  

<span class="keyword">SELECT</span>
	p.object_id <span class="keyword">AS</span> id,  
	convert(<span class="keyword">smallint</span>, p.procedure_number) <span class="keyword">AS</span> <span class="keyword">number</span>,  
	s.colid,
	s.status,  
	convert(varbinary(<span class="number">8000</span>), s.text) <span class="keyword">AS</span> ctext,  
	convert(<span class="keyword">smallint</span>, <span class="number">2</span> + <span class="number">4</span> * (s.status & <span class="number">1</span>)) <span class="keyword">AS</span> texttype,  
	convert(<span class="keyword">smallint</span>, <span class="number">0</span>) <span class="keyword">AS</span> <span class="keyword">language</span>,  
	sysconv(<span class="keyword">bit</span>, s.status & <span class="number">1</span>) <span class="keyword">AS</span> encrypted,  
	sysconv(<span class="keyword">bit</span>, <span class="number">0</span>) <span class="keyword">AS</span> compressed,  
	s.text  
<span class="keyword">FROM</span>
	sys.numbered_procedures p
<span class="keyword">CROSS</span> APPLY
	OpenRowset(<span class="keyword">TABLE</span> SQLSRC, p.object_id, p.procedure_number) s  

<span class="keyword">UNION</span> <span class="keyword">ALL</span>  

<span class="keyword">SELECT</span>
	o.id <span class="keyword">AS</span> id,  
	convert(<span class="keyword">smallint</span>, <span class="keyword">case</span> <span class="keyword">when</span> o.type <span class="keyword">in</span> (<span class="string">'P'</span>, <span class="string">'RF'</span>) <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">AS</span> <span class="keyword">number</span>,  
	s.colid,
	s.status,  
	convert(varbinary(<span class="number">8000</span>), s.text) <span class="keyword">AS</span> ctext,  
	convert(<span class="keyword">smallint</span>, <span class="number">2</span>) <span class="keyword">AS</span> texttype,  
	convert(<span class="keyword">smallint</span>, <span class="number">0</span>) <span class="keyword">AS</span> <span class="keyword">language</span>,  
	sysconv(<span class="keyword">bit</span>, <span class="number">0</span>) <span class="keyword">AS</span> encrypted,  
	sysconv(<span class="keyword">bit</span>, <span class="number">0</span>) <span class="keyword">AS</span> compressed,  
	s.text  
<span class="keyword">FROM</span>
	sys.sysobjrdb o
<span class="keyword">CROSS</span> APPLY
	OpenRowset(<span class="keyword">TABLE</span> SQLSRC, o.id, <span class="number">0</span>) s  
<span class="keyword">WHERE</span>
	db_id() = <span class="number">1</span> <span class="keyword">AND</span> 
	o.type <span class="keyword">IN</span> (<span class="string">'P'</span>,<span class="string">'V'</span>,<span class="string">'X'</span>,<span class="string">'FN'</span>,<span class="string">'IF'</span>,<span class="string">'TF'</span>)</span>
</pre></figure>

<p>Bummer. It doesn’t use object_definition, but instead another internal function in the form of OpenRowset(TABLE SQLSRC, o.id, 0). I’m not one to give up easily though – I’ve previously <a href="/exploring-the-sys-system_internals_partition_columns-ti-field">reverse engineered the OpenRowset(TABLE RSCPROP)</a> function.</p>
<p>Let’s take a different approach to the problem. Everything in SQL Server is stored on 8KB pages in a fixed format. As the procedures aren’t encrypted, they must be stored in clear text somewhere in the database – we just don’t know where. Let’s detach the database and crack open a hex editor (I highly recommend HxD):</p>
<div class="imgwrapper" style=""><div><a href="/where-does-sql-server-store-the-source-for-stored-procedures/image_10.png" class="fancy"><img src="/where-does-sql-server-store-the-source-for-stored-procedures/image_10.png" style="max-height: 250px"/></a></div></div>

<p>Now let’s see if we can find the procedure. On purpose I made it return “SELECT ‘AABBCC’ AS Output” as that would be easy to search for:</p>
<div class="imgwrapper" style=""><div><a href="/where-does-sql-server-store-the-source-for-stored-procedures/image_12.png" class="fancy"><img src="/where-does-sql-server-store-the-source-for-stored-procedures/image_12.png" style="max-height: 250px"/></a></div></div>

<p>And whadda ya know, there it is:</p>
<div class="imgwrapper" style=""><div><a href="/where-does-sql-server-store-the-source-for-stored-procedures/image_14.png" class="fancy"><img src="/where-does-sql-server-store-the-source-for-stored-procedures/image_14.png" style="max-height: 250px"/></a></div></div>

<p>OK, so now we know that the source is stored in the database, just not where specifically. The data is stored at offset 0x00101AF0 in the data file. In decimal, that’s offset 01055472. As each data page is exactly 8KB, we can calculate the ID of the data page that this is stored on (using integer math):</p>
<p>01055472 / 8192 = 128</p>
<p>Aha! At this point we know that the source is stored on page 128 – how about we take a look at that page using DBCC PAGE? After reattaching the database, run:</p>
<figure class="highlight sql"><pre>dbcc traceon (3604)
dbcc page(Test2, 1, 128, 0)
</pre></figure>

<p>Note that I’m using style 0 for the DBCC PAGE command. At this point, I just want to see the header – there just might be something interesting in there:</p>
<div class="imgwrapper" style=""><div><a href="/where-does-sql-server-store-the-source-for-stored-procedures/image_22.png" class="fancy"><img src="/where-does-sql-server-store-the-source-for-stored-procedures/image_22.png" style="max-height: 250px"/></a></div></div>

<p>As expected, it’s a normal data page, as indicated by the m_type field having a value of 1 (which is the internal page type ID for a data page). More interesting though, we can see that the page belongs to object ID 60! Let’s have a look at what lies behind that object ID:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">select</span> * <span class="keyword">from</span> sys.sysobjects <span class="keyword">where</span> id = <span class="number">60</span></span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/where-does-sql-server-store-the-source-for-stored-procedures/image_24.png" class="fancy"><img src="/where-does-sql-server-store-the-source-for-stored-procedures/image_24.png" style="max-height: 250px"/></a></div></div>

<p>And all of a sudden, the hunt is on! Let’s have a look at the contents of sys.sysobjvalues. Note that before you can select from this table, you’ll have to connect using a <a href="http://msdn.microsoft.com/en-us/library/ms189595.aspx" target="_blank">dedicated administrator connection</a>, seeing as it’s an internal base table:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">select</span> * <span class="keyword">from</span> sys.sysobjvalues</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/where-does-sql-server-store-the-source-for-stored-procedures/image_28.png" class="fancy"><img src="/where-does-sql-server-store-the-source-for-stored-procedures/image_28.png" style="max-height: 250px"/></a></div></div>

<p>There’s obviously a lot of stuff in here we don’t care about, but let’s try and filter that objid column down to the object ID of our procedure – 2105058535:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">select</span> * <span class="keyword">from</span> sys.sysobjvalues <span class="keyword">where</span> objid = <span class="number">2105058535</span></span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/where-does-sql-server-store-the-source-for-stored-procedures/image_30.png" class="fancy"><img src="/where-does-sql-server-store-the-source-for-stored-procedures/image_30.png" style="max-height: 250px"/></a></div></div>

<p>I wonder what that imageval column contains, if I remember correctly 0x2D2D would be “—“ in ASCII, which reminds me quite a lot of the beginning of the XYZ procedure. Let’s try and convert that column into human:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">select</span> convert(<span class="keyword">varchar</span>(<span class="aggregate">max</span>), imageval) <span class="keyword">from</span> sys.sysobjvalues <span class="keyword">where</span> objid = <span class="number">2105058535</span></span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/where-does-sql-server-store-the-source-for-stored-procedures/image_32.png" class="fancy"><img src="/where-does-sql-server-store-the-source-for-stored-procedures/image_32.png" style="max-height: 250px"/></a></div></div>

<p>And there you have it my dear reader; the source code for the XYZ stored procedure, as stored in the sys.sysobjvalues base table. As a final example, here’s how you’d retrieve a list of user stored procedures with their source code, without using neither object_definition nor sys.sql_modules:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">select</span>
	p.name,
	<span class="keyword">cast</span>(v.imageval <span class="keyword">as</span> <span class="keyword">varchar</span>(<span class="aggregate">MAX</span>))
<span class="keyword">from</span>
	sys.procedures p
<span class="keyword">inner</span> <span class="keyword">join</span>
	sys.sysobjvalues v <span class="keyword">on</span> p.object_id = v.objid</span>
</pre></figure>

<div class="imgwrapper" style=""><div><a href="/where-does-sql-server-store-the-source-for-stored-procedures/image_34.png" class="fancy"><img src="/where-does-sql-server-store-the-source-for-stored-procedures/image_34.png" style="max-height: 250px"/></a></div></div>

<p>Want to see more stuff like this? Don’t miss my <a href="/presenting-at-sqlsaturday-162-in-cambridge">full-day precon at SQL Saturday #162 in Cambridge, UK</a> (Friday, September 7th), or my <a href="/presenting-at-bleeding-edge-in-slovenia">Revealing the Magic session at Bleeding Edge 2012</a> in Laško, Slovenia (October 23-24th)!</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Aug</span>
			<span class="day">26</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/presenting-at-bleeding-edge-in-slovenia/" title="Presenting at Bleeding Edge in Slovenia" rel="bookmark">Presenting at Bleeding Edge in Slovenia</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I’ve been to Slovenia many times, though only recently in a professional context, as I presented at <a href="/2012-nt-konferenca-slides-demos">NT Konferenca earlier this year</a>. Several times, and from multiple people, I’ve heard about a local conference named Bleeding Edge, and how it was put together with nothing but level 400+ content with top quality speakers.</p>
<a id="more"></a>

<p>This summer, I happened to drop by Ljubljana to visit some friends of mine, as I was in the area on vacation. At some point in the evening, the talk turned to Bleeding Edge again, and before I knew it, <a href="http://weblogs.sqlteam.com/mladenp/default.aspx" target="_blank">Mladen Prajdić</a> said he’d introduce me to one of the organizers, <a href="http://milambda.blogspot.dk/" target="_blank">Matija Lah</a>.</p>
<p>Today, I’m excited to announce that I’ll be presenting my <a href="http://www.bleedingedge.si/Conference/Predavanja#rasmussen" target="_blank">Revealing the Magic</a> session at <a href="http://www.bleedingedge.si/Conference" target="_blank">Bleeding Edge 2012</a> on the 23-24th of October in Laško, Slovenia.</p>
<p>I’ve presented the session before at other venues, and this one will follow the usual fast and furious format. There are 10 hours of content compressed into just one hour. I will be showing the latest <a href="https://github.com/improvedk/OrcaMDF" target="_blank">OrcaMDF</a> bits during the session and my usual warning goes: This session is not meant to teach as much as it’s meant to inspire you. Inspire you to realize how simple SQL Server really is at its core, once you master the immediate complexity. For a full description of the session, I recommend you go to the <a href="http://www.bleedingedge.si/Conference/Predavanja#rasmussen" target="_blank">Bleeding Edge site</a>.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jul</span>
			<span class="day">18</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/presenting-at-sqlsaturday-162-in-cambridge/" title="Presenting at SQLSaturday" rel="bookmark">Presenting at SQLSaturday</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<div class="imgwrapper" style=""><div><a href="/presenting-at-sqlsaturday-162-in-cambridge/image_4.png" class="fancy"><img src="/presenting-at-sqlsaturday-162-in-cambridge/image_4.png" style="max-height: 250px"/></a></div></div>

<a id="more"></a>

<p>The official announcement was made a couple of days ago and I’m embarassingly late to follow up myself. “Unfortunately” this is what I’m doing right now, and I must say that achieving a proper 3G connection in the middle of the <a href="http://en.wikipedia.org/wiki/Dolomites" target="_blank">Dolomites</a> has proven rather difficult…</p>
<p>Anyways, I’m happy and honored to say that I’ll be presenting my <em>A Deep-Dive into the depths of the SQL Server storage engine and MDF file format  </em>precon at SQLSaturday #162 in Cambridge. I’ll be presenting my precon alongside SQL Server authorities like Jen Stirrup and Buck Woody, not to mention all of the regular session speakers, which have yet to be announced.</p>
<p>Allow me to present some of the feedback I got on my <em>Revealing the Magic</em> session, which is a 1-hour version of my precon, at the last SQLBits:</p>
<blockquote>
<p>It was perhaps too much detail to cram into a 1 hour session.</p>
<p>A bit rushed. I can say it is probably the first time I felt my knowledge was not<br>enough to keep up with mark’s content.</p>
<p>Great pace of session - very fast, no messing about - excellent - more sessions<br>should get on with it, like this. Loved the session and very technical - exactly<br>what the benefit of having this stuff delivered face-to-face.</p>
<p>I know he said it at the beginning. but at times it was just too fast. Maybe let the<br>people digest what was said.</p>
</blockquote>
<p>I love receiving constructive feedback, and this is so spot on! I definitely need to weed out a bit of content from my 1-hour session as there’s simply too much to go through in just one hour. Having a full day to present the same content is a much more fitting format, and it will allow me to go at a somewhat more normal pace, as well as leaving plenty of time for Q&amp;A during the presentation.</p>
<p>I will however still warn you that this is a level 500 precon. I will go very in depth and there will be plenty of bits and bytes to show – documented as well as undocumented.</p>
<p>Please check out the <a href="http://sqlcambs.org.uk/" target="_blank">Cambridgeshire SQL Server User Group page</a> for more information on mine, Jen Stirrup and Buck Woodys precons. Make sure to register, if not for mine then for one of the other excellent precons!</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jun</span>
			<span class="day">19</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/video-from-ndc-2012-revealing-the-sql-server-magic/" title="Video From NDC 2012: Revealing the SQL Server Magic" rel="bookmark">Video From NDC 2012: Revealing the SQL Server Magic</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				, 
			
				<a href="/category/SQL Server - Internals/">SQL Server - Internals</a>
				, 
			
				<a href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I’m really lagging behind on my blogging – life is busy as the moment! Just a couple of weeks ago I presented my Revealing the Magic session at the Norwegian Developers Conference in Oslo. I was quite excited to give my SQL Server oriented session to a crowd of developers – a 500 level session, at SQL Server events that is.</p>
<a id="more"></a>

<p>I just got the feedback today – 0 reds, 3 yellows and 15 greens – very happy with that, especially when taking the audience into account. To those of you who haven’t seen my session before, here it is:</p>
<iframe src="http://player.vimeo.com/video/43659054" height="281" width="500" allowfullscreen="allowfullscreen" frameborder="0"></iframe>

<p><a href="http://vimeo.com/43659054" target="_blank">Mark S. Rasmussen - Revealing the SQL Server Magic</a> from <a href="http://vimeo.com/ndcoslo" target="_blank">NDCOslo</a> on <a href="http://vimeo.com" target="_blank">Vimeo</a>.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jun</span>
			<span class="day">01</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/2012-nt-konferenca-slides-demos/" title="2012 NT Konferenca Slides + Demos" rel="bookmark">2012 NT Konferenca Slides + Demos</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I presented two sessions at this years <a href="http://www.ntk.si/" target="_blank">NT Konferenca</a>. It was my first NTK, and what an NTK it was! I’m really hoping I’ll be back to present again – I’ve been to Slovenia many times before on non-technical visits, and now I’ve been able to confirm that they sure know how to run their conferences and cater for the attendees and speakers :)</p>
<a id="more"></a>

<p><a href="2012-05-24-NTK-Optimizing-Storage-and-Performance-Using-Page-and-Row-Compression-60-minutes.rar">Optimizing Storage and Performance Using Page and Row Compression.rar - Slides &amp; demos</a></p>
<p><a href="2012-05-24-NTK-Storing-Character-Data-Optimally-60-minutes.rar">Storing Character Data Optimally.rar - Slides &amp; demos</a></p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">May</span>
			<span class="day">14</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/in-the-nick-of-time-band-aid-solution-for-umbraco/" title="In the Nick of Time: Band Aid Solution for Umbraco 5.1 Performance" rel="bookmark">In the Nick of Time: Band Aid Solution for Umbraco 5.1 Performance</a></h1>
		<div class="categories">
			
				<a href="/category/Umbraco/">Umbraco</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>As I write this I’m finishing the last details on a new website project I’m working on for a client. A couple of months ago I made the easy decision of going with <a href="http://umbraco.org/" target="_blank">Umbraco</a> as the underlying CMS. I’ve had excellent experiences with Umbraco previously and the <a href="http://our.umbraco.org/" target="_blank">community</a> is amazing.</p>
<a id="more"></a>

<p>Umbraco was at a split road however, version 4.7 being a widely deployed and tested version, while the brand new 5.0 rewrite had just been released as a release candidate. It was made clear that 5.0 would not be upgradable from previous versions, so I could basically go with 4.7 and be stuck, or go with a release candidate version. To my luck, 5.0 was finally released as RTM before I had to make the decision, rendering my following decision easy – 5.0 was heralded as being production ready.</p>
<h2 id="Performance,_oh_my">Performance, oh my</h2>
<p>Fast forward a month or so, development well underway. It was clear that there were performance issues. The forums were full of <a href="http://our.umbraco.org/forum/core/umbraco-5-general-discussion/28565-Umbraco-5-Performance-issues" target="_blank">posts</a> asking how to get performance equivalent to what people were used to in 4.7. Unfortunately, there wasn’t really a solution yet. Thankfully 5.1 was released, promising better performance. After spending a couple of days fighting a <a href="http://our.umbraco.org/forum/core/umbraco-5-general-discussion/31197-Failing-to-upgrade-from-501-to-51RC" target="_blank">5.0 –&gt; 5.1 upgrade bug</a>, I finally got 5.1 running. Much to my dismay, performance was still dismal.</p>
<p>This is me requesting the front page of the website:</p>
<div class="imgwrapper" style=""><div><a href="/in-the-nick-of-time-band-aid-solution-for-umbraco/image_2.png" class="fancy"><img src="/in-the-nick-of-time-band-aid-solution-for-umbraco/image_2.png" style="max-height: 250px"/></a></div></div>

<p>1780 individual requests to the database, with several interesting queries like the following:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span> this_.Id <span class="keyword">as</span> Id16_7_, this_.DateCreated <span class="keyword">as</span> DateCrea2_16_7_, this_.DefaultName <span class="keyword">as</span> DefaultN3_16_7_,
this_.AttributeSchemaDefinition_id <span class="keyword">as</span> Attribut4_16_7_, this_.NodeId <span class="keyword">as</span> NodeId16_7_, attribalia1_.NodeVersionId
<span class="keyword">as</span> NodeVers3_9_, attribalia1_.Id <span class="keyword">as</span> Id9_, attribalia1_.Id <span class="keyword">as</span> Id5_0_, attribalia1_.AttributeDefinitionId <span class="keyword">as</span>
Attribut2_5_0_, attribalia1_.NodeVersionId <span class="keyword">as</span> NodeVers3_5_0_, attributed5_.AttributeId <span class="keyword">as</span> Attribut4_10_,
attributed5_.Id <span class="keyword">as</span> Id10_, attributed5_.Id <span class="keyword">as</span> Id1_1_, attributed5_.<span class="keyword">Value</span> <span class="keyword">as</span> Value1_1_, attributed5_.ValueKey
<span class="keyword">as</span> ValueKey1_1_, attributed5_.AttributeId <span class="keyword">as</span> Attribut4_1_1_, attributed5_.LocaleId <span class="keyword">as</span> LocaleId1_1_,
attributed6_.AttributeId <span class="keyword">as</span> Attribut4_11_, attributed6_.Id <span class="keyword">as</span> Id11_, attributed6_.Id <span class="keyword">as</span> Id0_2_, attributed6_.<span class="keyword">Value</span>
<span class="keyword">as</span> Value0_2_, attributed6_.ValueKey <span class="keyword">as</span> ValueKey0_2_, attributed6_.AttributeId <span class="keyword">as</span> Attribut4_0_2_, attributed6_.LocaleId
<span class="keyword">as</span> LocaleId0_2_, attributei4_.AttributeId <span class="keyword">as</span> Attribut4_12_, attributei4_.Id <span class="keyword">as</span> Id12_, attributei4_.Id <span class="keyword">as</span>
Id3_3_, attributei4_.<span class="keyword">Value</span> <span class="keyword">as</span> Value3_3_, attributei4_.ValueKey <span class="keyword">as</span> ValueKey3_3_, attributei4_.AttributeId
<span class="keyword">as</span> Attribut4_3_3_, attributei4_.LocaleId <span class="keyword">as</span> LocaleId3_3_, attributel3_.AttributeId <span class="keyword">as</span> Attribut4_13_,
attributel3_.Id <span class="keyword">as</span> Id13_, attributel3_.Id <span class="keyword">as</span> Id4_4_, attributel3_.<span class="keyword">Value</span> <span class="keyword">as</span> Value4_4_, attributel3_.ValueKey <span class="keyword">as</span>
ValueKey4_4_, attributel3_.AttributeId <span class="keyword">as</span> Attribut4_4_4_, attributel3_.LocaleId <span class="keyword">as</span> LocaleId4_4_,
attributes2_.AttributeId <span class="keyword">as</span> Attribut4_14_, attributes2_.Id <span class="keyword">as</span> Id14_, attributes2_.Id <span class="keyword">as</span> Id6_5_, attributes2_.<span class="keyword">Value</span>
<span class="keyword">as</span> Value6_5_, attributes2_.ValueKey <span class="keyword">as</span> ValueKey6_5_, attributes2_.AttributeId <span class="keyword">as</span> Attribut4_6_5_,
attributes2_.LocaleId <span class="keyword">as</span> LocaleId6_5_, node14_.Id <span class="keyword">as</span> Id9_6_, node14_.DateCreated <span class="keyword">as</span> DateCrea2_9_6_,
node14_.IsDisabled <span class="keyword">as</span> IsDisabled9_6_, node14_1_.Alias <span class="keyword">as</span> Alias10_6_, node14_1_.Description <span class="keyword">as</span> Descript3_10_6_,
node14_1_.Name <span class="keyword">as</span> Name10_6_, node14_1_.Ordinal <span class="keyword">as</span> Ordinal10_6_, node14_1_.AttributeSchemaDefinitionId <span class="keyword">as</span>
Attribut6_10_6_, node14_2_.Alias <span class="keyword">as</span> Alias11_6_, node14_2_.Description <span class="keyword">as</span> Descript3_11_6_, node14_2_.Name <span class="keyword">as</span>
Name11_6_, node14_2_.SchemaType <span class="keyword">as</span> SchemaType11_6_, node14_2_.XmlConfiguration <span class="keyword">as</span> XmlConfi6_11_6_, <span class="keyword">case</span> <span class="keyword">when</span>
node14_1_.NodeId <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">when</span> node14_2_.NodeId <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">then</span> <span class="number">2</span> <span class="keyword">when</span> node14_.Id <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">then</span>
<span class="number">0</span> <span class="keyword">end</span> <span class="keyword">as</span> clazz_6_ <span class="keyword">FROM</span> dbo.NodeVersion this_ <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> dbo.Attribute attribalia1_ <span class="keyword">on</span> this_.Id=attribalia1_.NodeVersionId
<span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> dbo.AttributeDecimalValue attributed5_ <span class="keyword">on</span> attribalia1_.Id=attributed5_.AttributeId <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span>
dbo.AttributeDateValue attributed6_ <span class="keyword">on</span> attribalia1_.Id=attributed6_.AttributeId <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> dbo.AttributeIntegerValue
attributei4_ <span class="keyword">on</span> attribalia1_.Id=attributei4_.AttributeId <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> dbo.AttributeLongStringValue attributel3_
<span class="keyword">on</span> attribalia1_.Id=attributel3_.AttributeId <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> dbo.AttributeStringValue attributes2_ <span class="keyword">on</span>
attribalia1_.Id=attributes2_.AttributeId <span class="keyword">inner</span> <span class="keyword">join</span> dbo.Node node14_ <span class="keyword">on</span> this_.NodeId=node14_.Id <span class="keyword">left</span> <span class="keyword">outer</span>
<span class="keyword">join</span> dbo.[AttributeDefinitionGroup] node14_1_ <span class="keyword">on</span> node14_.Id=node14_1_.NodeId <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> dbo.[AttributeSchemaDefinition]
node14_2_ <span class="keyword">on</span> node14_.Id=node14_2_.NodeId <span class="keyword">WHERE</span> this_.Id <span class="keyword">in</span> (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7, @p8,
@p9, @p10, @p11, @p12, @p13, @p14, @p15, @p16, @p17, @p18, @p19, @p20, @p21, @p22, @p23, @p24, @p25, @p26, @p27,
@p28, @p29, @p30, @p31, @p32, @p33, @p34, @p35, @p36, @p37, @p38, @p39, @p40, @p41, @p42, @p43, @p44, @p45, @p46,
@p47, @p48, @p49, @p50, @p51, @p52, @p53, @p54, @p55, @p56, @p57, @p58, @p59, @p60, @p61, @p62, @p63, @p64, @p65,
@p66, @p67, @p68, @p69, @p70, @p71, @p72, @p73, @p74, @p75, @p76, @p77, @p78, @p79, @p80, @p81, @p82, @p83, @p84,
@p85, @p86, @p87, @p88, @p89, @p90, @p91, @p92, @p93, @p94, @p95, @p96, @p97, @p98, @p99, @p100, @p101, @p102, @p103,
@p104, @p105, @p106, @p107, @p108, @p109, @p110, @p111, @p112, @p113, @p114, @p115, @p116, @p117, @p118, @p119, @p120,
@p121, @p122, @p123, @p124, @p125, @p126, @p127, @p128, @p129, @p130, @p131, @p132, @p133, @p134, @p135, @p136, @p137,
... &lt;snip: <span class="keyword">some</span> <span class="number">700</span> other parameters&gt; ...
@p882, @p883, @p884, @p885, @p886, @p887, @p888, @p889, @p890, @p891, @p892, @p893, @p894, @p895, @p896, @p897, @p898,
@p899, @p900, @p901, @p902, @p903, @p904, @p905, @p906, @p907, @p908, @p909, @p910, @p911, @p912, @p913, @p914, @p915,
@p916, @p917, @p918, @p919, @p920, @p921, @p922, @p923, @p924, @p925, @p926, @p927, @p928, @p929, @p930, @p931, @p932,
@p933, @p934, @p935, @p936, @p937, @p938, @p939, @p940, @p941, @p942, @p943, @p944, @p945, @p946, @p947, @p948, @p949,
@p950, @p951, @p952, @p953, @p954, @p955, @p956) <span class="keyword">and</span> this_.Id <span class="keyword">in</span> (<span class="keyword">SELECT</span> this_0_.Id <span class="keyword">as</span> y0_ <span class="keyword">FROM</span> dbo.NodeVersion this_0_ <span class="keyword">WHERE</span> this_0_.NodeId = @p957)</span>
</pre></figure>

<p>It’s clearly obvious we’re dealing with a serious N+1 problem, made worse by a lack of set based operations as evidenced by the above query. At the same time this query is a ticking time bomb – as soon as it hits the 2100 parameter limit, problems will arise unless they’re handled. The culprit seems to be the fact that the database is queried through a LINQ provider on top of Umbracos own Hive layer, on top of NHibernate. The core team themselves have voiced that NHibernate might be exacerbating the problem as they haven’t tamed the beast completely. I <a href="http://our.umbraco.org/forum/core/umbraco-5-general-discussion/28565-Umbraco-5-Performance-issues?p=14" target="_blank">voiced my own concerns and suggestions</a> on the architecture in the main performance thread. Currently the core team seems to be working on a band aid solution; adding a Lucene based cache to the site to improve performance. In my opinion the only way to really solve the issue is to fix the underlying problem – the N+1 one.</p>
<p>Back in January the Umbraco team posted the following: <a href="http://umbraco.com/follow-us/blog-archive/2012/1/4/umbraco-5-on-performance-and-the-perils-of-premature-optimisation.aspx" target="_blank">Umbraco 5: On performance and the perils of premature optimization</a>. While I completely agree with the sentiment, avoiding N+1 issues is not premature optimization, that’s a requirement before releasing an RTM product.</p>
<p>The Umbraco team does deserve big kudos on owning up to the problem. They’re painfully aware of the issues people are dealing with, being unable to deploy due to crippling performance. I’m sure they’ll be improving on performance, I just hope it happens sooner than later. I did talk to Niels Hartvig and offered my help (regarding the database layer), should they want it. I’ve also had Alex Norcliffe look at my logs over email – a big thanks goes to the team, helping out even though they’re in a pinch themselves.</p>
<h2 id="Band_aid_solutions_while_waiting_for_5-2">Band aid solutions while waiting for 5.2</h2>
<p>As I had to get the website up and running for a trade show, I had no choice but to spin up a High-CPU Extra Large Instance on Amazon EC2. While this costs a minor fortune (compared to what hosting the site should’ve required), it gave me a temporary solution for the trade show. Startup times were still terrible but at least requesting pages went reasonably fast, even though some pages did hang for 5+ seconds, depending on the content shown.</p>
<p>Once the trade show was over, I downgraded the EC2 instance to an m1.large instance. It’s still expensive, but it’s a tad cheaper for development. However, there’s a bigger problem looming on the horizon – the site has to go live in a week or two.</p>
<p>The Umbraco team have said they expect a 5.2 performance release sometime during June, and 5.x being on par with 4.7 by the end of 2012. Unfortunately I don’t have the luxury of waiting for that.</p>
<p>What I’ve now done, to prepare for the launch, was to increase the output cache timeout to 24 hours by modifying web.config like so:</p>
<figure class="highlight xml"><pre><span class="tag">&lt;<span class="title">caching</span>&gt;</span>
  <span class="tag">&lt;<span class="title">outputCacheSettings</span>&gt;</span>
    <span class="tag">&lt;<span class="title">outputCacheProfiles</span>&gt;</span>
      <span class="tag">&lt;<span class="title">add</span> <span class="attribute">name</span>=<span class="value">"umbraco-default"</span> <span class="attribute">duration</span>=<span class="value">"86400"</span> <span class="attribute">varyByParam</span>=<span class="value">"*"</span> <span class="attribute">location</span>=<span class="value">"ServerAndClient"</span>/&gt;</span>
    <span class="tag">&lt;/<span class="title">outputCacheProfiles</span>&gt;</span>
  <span class="tag">&lt;/<span class="title">outputCacheSettings</span>&gt;</span>
<span class="tag">&lt;/<span class="title">caching</span>&gt;</span>
</pre></figure>

<p>This essentially turns the website into a statically cached copy. Doing this results in each page being cached for 24 hours after it’s been visited last. While this is great, it still means those first visitors (for each page on the website) will be suffering from long waits. To fix that, I turn to <a href="http://home.snafu.de/tilman/xenulink.html" target="_blank">Xenu’s Link Sleuth</a>. Given the hostname, Xenu will crawl each page on the website, checking for broken links. As a side effect, every page on the site will be visited and thereby cached. By default, Xenu will use 30 concurrent threads to crawl the site. On my EC2 instance, that resulted in loads of timeouts as the instance simply couldn’t handle it:</p>
<div class="imgwrapper" style=""><div><a href="/in-the-nick-of-time-band-aid-solution-for-umbraco/image_10.png" class="fancy"><img src="/in-the-nick-of-time-band-aid-solution-for-umbraco/image_10.png" style="max-height: 250px"/></a></div></div>

<p>Pressing Ctrl+R forces Xenu to retry all the failed links, eventually resulting in all the links being visited successfully:</p>
<div class="imgwrapper" style=""><div><a href="/in-the-nick-of-time-band-aid-solution-for-umbraco/image_8.png" class="fancy"><img src="/in-the-nick-of-time-band-aid-solution-for-umbraco/image_8.png" style="max-height: 250px"/></a></div></div>

<p>(Sorry for distorting the images – the site isn’t supposed to go completely public yet). For Xenu to find all the links on the site, you’ll have to make sure you’re using &lt;a href /&gt; tags. I had to replace a couple of:</p>
<figure class="highlight html"><pre><span class="tag">&lt;<span class="title">div</span> <span class="attribute">onclick</span>=<span class="value">"window.open('http://xyz.com')"</span>&gt;</span>
</pre></figure>

<p>With corresponding &lt;a href /&gt; implementations, otherwise Xenu blissfully ignored them.</p>
<p>Obviously fixing the performance issue like this comes with a severe cost – memory usage on the server as well as being unable to update the site from the back office. For now I can live with that as the main priority is getting the site live. When I update I’ll have to manually cycle the app pool as well as rerunning Xenu. Currently the site takes up about 500 megs of memory fully cached, so I’ve got some room to spare.</p>
<p>Thankfully there are no protected parts of the site so user-specific caching is not an issue – <a href="http://en.wiktionary.org/wiki/YMMV" target="_blank">YMMV</a>.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>


<div class="paging">
	<a href="/page/4/"><div class="past">« Past</div></a>
	<a href="/page/2/"><div class="future">Future »</div></a>
	<div class="clear"></div>
</div>

				</div>
			</div>

			<div id="asides">
				<div class="categories aside">
					<span class="sectiontitle">CATEGORIES</span>
					<ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/category/.NET/">.NET</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/AS/Flex/Flash/">AS/Flex/Flash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Amazon Web Services/">Amazon Web Services</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Computer Science/">Computer Science</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Conferences and Presenting/">Conferences and Presenting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/IIS/">IIS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Life/">Life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Miscellaneous/">Miscellaneous</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Performance/">Performance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Poker/">Poker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server/">SQL Server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Community/">SQL Server - Community</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Data Types/">SQL Server - Data Types</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Internals/">SQL Server - Internals</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Optimization/">SQL Server - Optimization</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Tricks/">SQL Server - Tricks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Testing/">Testing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Tools of the Trade/">Tools of the Trade</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Umbraco/">Umbraco</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Visual Studio/">Visual Studio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Web/">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windbg/">Windbg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windows/">Windows</a></li></ul>

					
				</div>

				<div class="archive aside">
					<span class="sectiontitle">ARCHIVE</span>
					<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archive/2014">2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2013">2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2012">2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2011">2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2010">2010</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2009">2009</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2008">2008</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2007">2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2006">2006</a></li></ul>
				</div>
			</div>

			<div class="clear"></div>
		</div>
		
		<footer>
			<div class="wrapper">Copyright &copy; 2014 Mark S. Rasmussen</div>
		</footer>

		<script type="text/javascript">
			$(function () {
				// Show mobile menu
				$("li.navicon").click(function () {
					if ($("header ul.mobile a").length == 0) {
						// Pages
						$mobilePages = $("div#naviconcontent ul.pages");
						$("header nav ul.normal > li").not(".navicon").each(function (i, el) {
							$mobilePages.append($(el).clone());
						});

						// Categories
						$mobileCategories = $("div#naviconcontent ul.categories");
						$("div#asides div.categories > ul > li").each(function (i, el) {
							$mobileCategories.append($(el).clone());
						});

						// Archive
						$mobileArchive = $("div#naviconcontent ul.archive");
						$("div#asides div.archive > ul > li").each(function (i, el) {
							$mobileArchive.append($(el).clone());
						});
					};

					$("header ul.mobile").toggle();
				});

				// Fancybox setup
				$("a.fancy").fancybox({
					hideOnContentClick: true,
					overlayShow: true
				});
			});
		</script>
	</body>
</html>