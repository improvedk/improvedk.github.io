<!DOCTYPE html>
<html>
	

<head>
	<title>Mark S. Rasmussen</title>
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
	<meta charset="UTF-8" />
	<meta property="og:locale" content="en_US" />
	<meta property="og:type" content="website" />
	<meta name="google-site-verification" content="alt7-wfK3ZujMQ4D0jYNd0yC5LGetGdqBlBmZsqQlVw" />
	<link rel="alternative" href="http://feeds.feedburner.com/Improvedk" title="Mark S. Rasmussen" type="application/atom+xml">
	<script src="/js/combined.js"></script>
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-2479580-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>
	<link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
	<body>
		<div id="headerline"></div>
	
		<header>
			<div class="wrapper">
				<div id="title">
					<a href="/">Mark S. Rasmussen</a> <span>improve.dk</span>
				</div>
				
				<nav>
					<ul class="normal">
						<li class="navicon"><img src="/img/navicon.png" /></li>
						<li><a href="/about-me/">About Me</a></li>
					</ul>
				</nav>
				
				<ul id="sharing">
					<li><a href="mailto:mark@improve.dk"><img src="/img/at.png" /></a></li>
					<li><a href="http://feeds.feedburner.com/Improvedk"><img src="/img/rss.png" /></a></li>
					<li><a href="https://twitter.com/improvedk"><img src="/img/twitter.png" /></a></li>
					<li><a href="https://github.com/improvedk"><img src="/img/github.png" /></a></li>
					<li><a href="https://www.linkedin.com/in/markrasmussen/"><img src="/img/linkedin.png" /></a></li>
				</ul>

				<div class="clear"></div>
				
				<div id="naviconcontent">
					<ul class="mobile">
						<li>
							Pages
							<ul class="pages"></ul>
						</li>
						<li>
							Categories
							<ul class="categories"></ul>
						</li>
						<li>
							Archive
							<ul class="archive"></ul>
						</li>
					</ul>
				</div>
			</div>
		</header>

		<div id="mainwrapper">
			<div id="contentwrapper">
				<div id="content">
				
					
	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Nov</span>
			<span class="day">19</span>
		</div>
		<div class="lower">2007</div>
	</div>

	<div class="title">
		<h1><a href="/automatically-mapping-datatable-to-objects/" title="Automatically Mapping Datatable to Objects" rel="bookmark">Automatically Mapping Datatable to Objects</a></h1>
		<div class="categories">
			
				<a href="http://improve.dk/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I often need to transfer data from my business layer to my presentation layers in a strongly typed way. In this example I’ll use the following very struct and corresponding DataTable to represent the data I need to transfer:</p>
<a id="more"></a>


<figure class="highlight csharp"><pre><span class="keyword">struct</span> Test
{
	<span class="keyword">public</span> <span class="keyword">string</span> Name;
	<span class="keyword">public</span> <span class="keyword">int</span> Value;
}

<span class="keyword">using</span> (DataTable dt = <span class="keyword">new</span> DataTable())
{
	dt.Columns.Add(<span class="string">"Name"</span>, <span class="keyword">typeof</span>(<span class="keyword">string</span>));
	dt.Columns.Add(<span class="string">"Value"</span>, <span class="keyword">typeof</span>(<span class="keyword">int</span>));
}
</pre></figure>

<p>Our objective is basically to transfer the DataRows in the DataTable into a List that can be transferred on to the next layer.</p>
<p>The fastest way possible would be doing it manually like so:</p>
<figure class="highlight csharp"><pre><span class="keyword">List</span> <span class="keyword">list</span> = <span class="keyword">new</span> <span class="keyword">List</span>();
<span class="keyword">foreach</span> (DataRow dr in dt.Rows)
{
	Test t = <span class="keyword">new</span> Test();
	t.Name = dr[<span class="string">"Name"</span>].ToString();
	t.Value = Convert.ToInt32(dr[<span class="string">"Value"</span>]);

	<span class="keyword">list</span>.Add(t);
}
</pre></figure>

<p>But this takes a lot of time to write, especially if your objects vary a lot and you have to create a lot of them. That’s where my MapList function comes into play:</p>
<figure class="highlight csharp"><pre><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">List</span> MapList(DataTable dt)
{
	<span class="keyword">List</span> <span class="keyword">list</span> = <span class="keyword">new</span> <span class="keyword">List</span>();

	FieldInfo[] fields = typeof(T).GetFields();
	T t = Activator.CreateInstance();

	<span class="keyword">foreach</span> (DataRow dr in dt.Rows)
	{
		<span class="keyword">foreach</span> (FieldInfo fi in fields)
			fi.SetValueDirect(__makeref(t), dr[fi.Name]);

		<span class="keyword">list</span>.Add(t);
	}

	<span class="keyword">return</span> <span class="keyword">list</span>;
}
</pre></figure>

<p>It takes a DataTable as the sole parameter (you could easily use a DataReader if you wanted to). It retrieves the fields of the generic type by reflection. It is important to note that this includes all fields of the type, so we’re expecting there to be a 1:1 map of the DataTable and the types’ fields. Another important remark is that the generic type <em>must</em> be a struct - for us to be able to move the type instantiation outside of the loop (for performance), it must be a struct (since adding it to the List will create a copy). If it were a class, we would overwrite the already existing objects each time we iterated a new row in the DataTable.</p>
<p>The SetValueDirect() method is somewhat faster than SetValue(). Caching the TypedReference for t by creating it outside the loop actually decreased performance, I’ll probably have to look into the IL code to identify why. I’ve also tried caching the DataRow ordinals, there is no performance gain to be seen unless we’re talking several millions of datarows, and in that case - this function is not the way to go.</p>
<p>I would really like to obtain a pointer to the struct fields and set the values directly using some unsafe pointer magic - anyone know how to obtain a pointer to the field hiding behind the FieldInfo type we get by reflection?</p>
<p>So what’s the catch as opposed to doing it manually? Performance. Here’s a graph that shows the performance hit in sets of 1 to 1.000.000 iterations. Note that at 1000 iterations the timing shifts from ticks to milliseconds and that the graph is using a base 10 logarithmic scale.</p>
<div class="imgwrapper" style=""><div><a href="/automatically-mapping-datatable-to-objects/maplistperf_2.jpg" class="fancy"><img src="/automatically-mapping-datatable-to-objects/maplistperf_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Obviously there’s a performance hit - rather consistently, a factor of 10 -, but depending on the situation it is to be used in, mapping the objects by reflection may easily be a viable solution.</p>
<p><a href="ConsoleApplication1.rar">ConsoleApplication1.rar - Sample solution</a></p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Oct</span>
			<span class="day">20</span>
		</div>
		<div class="lower">2007</div>
	</div>

	<div class="title">
		<h1><a href="/xmldocument-fluent-interface/" title="XmlDocument Fluent Interface" rel="bookmark">XmlDocument Fluent Interface</a></h1>
		<div class="categories">
			
				<a href="http://improve.dk/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I do a lot of backend programming for Flash frontends. That basically means a lot of ASPX pages that simply return some XML and accept some incoming XML for parameters. Most of the UI logic ends up getting cluttered with manual XML stringbuilding, so I saw this as an obvious opportunity to play around with a fluent interfaces.</p>
<a id="more"></a>

<p>Now, here’s an example of a typical boolean yes/no result from a Flash query:</p>
<figure class="highlight xml"><pre><span class="pi">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="tag">&lt;<span class="title">root</span>&gt;</span>
	<span class="tag">&lt;<span class="title">result</span> <span class="attribute">type</span>=<span class="value">"boolean"</span>&gt;</span>true<span class="tag">&lt;/<span class="title">result</span>&gt;</span>
<span class="tag">&lt;/<span class="title">root</span>&gt;</span>
</pre></figure>

<p>I’d usually create this bit of XML using a simple StringBuilder like so:</p>
<figure class="highlight csharp"><pre>StringBuilder output = new StringBuilder();
output.Append("<span class="pi">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>");
output.Append("<span class="tag">&lt;<span class="title">root</span>&gt;</span>");
output.Append("<span class="tag">&lt;<span class="title">result</span> <span class="attribute">type</span>=<span class="value">"boolean"</span>&gt;</span>true<span class="tag">&lt;/<span class="title">result</span>&gt;</span>");
output.Append("<span class="tag">&lt;/<span class="title">root</span>&gt;</span>");
</pre></figure>

<p>This has the advantage of being very fast to write, but readability suffers from the escaped quotes, lack of indentation and there’s a whole lot of text when the XML becomes just a bit more advanced.</p>
<p>A “prettier” way is to use the DOM through the XmlDocument like so:</p>
<figure class="highlight csharp"><pre>XmlDocument xd = new XmlDocument()<span class="comment">;</span>
xd<span class="preprocessor">.AppendChild</span>(xd<span class="preprocessor">.CreateXmlDeclaration</span>(<span class="string">"1.0"</span>, <span class="string">"utf-8"</span>, <span class="string">""</span>))<span class="comment">;</span>

XmlNode root = xd<span class="preprocessor">.CreateElement</span>(<span class="string">"root"</span>)<span class="comment">;</span>
xd<span class="preprocessor">.AppendChild</span>(root)<span class="comment">;</span>

XmlNode result = xd<span class="preprocessor">.CreateElement</span>(<span class="string">"result"</span>)<span class="comment">;</span>
result<span class="preprocessor">.InnerText</span> = <span class="string">"true"</span><span class="comment">;</span>

XmlAttribute type = xd<span class="preprocessor">.CreateAttribute</span>(<span class="string">"type"</span>)<span class="comment">;</span>
type<span class="preprocessor">.Value</span> = <span class="string">"boolean"</span><span class="comment">;</span>

result<span class="preprocessor">.Attributes</span><span class="preprocessor">.Append</span>(type)<span class="comment">;</span>
root<span class="preprocessor">.AppendChild</span>(result)<span class="comment">;</span>
</pre></figure>

<p>While this does produce exactly the same XML, it takes up twice as many lines of code, excluding the whitespace lines. Without whitespace it is even more unreadable.</p>
<p>Let me introduce you to my quick’n’simple fluent interface that uses XmlDocument internally, XmlOutput:</p>
<figure class="highlight csharp"><pre>XmlOutput xo = new XmlOutput()
	<span class="preprocessor">.XmlDeclaration</span>()
	<span class="preprocessor">.Node</span>(<span class="string">"root"</span>)<span class="preprocessor">.Within</span>()
		<span class="preprocessor">.Node</span>(<span class="string">"result"</span>)<span class="preprocessor">.Attribute</span>(<span class="string">"type"</span>, <span class="string">"boolean"</span>)<span class="preprocessor">.InnerText</span>(<span class="string">"true"</span>)<span class="comment">;</span>
</pre></figure>

<p>Using XmlOutput we’re down to four lines, the shortest example yet. While linecount is not, and should not be, a measurement of quality, it is preferred. I believe using XmlOutput is, by far, the most readable example.</p>
<p>Basically, using Node() creates a new node within the current node. If no node has been created previously, it will automatically be the root node. Any time a new node is created, it automatically becomes the “current node”. Calling Within() moves the context into the current node, thus any newly created nodes will be created within that node. Attribute() will add an attribute to the current node, likewise will InnerText() set the InnerText of the current node. EndWithin() moves the context to the parent node, it is not mandatory for “closing” the nodes, it is only required when you actually need to move the scope.</p>
<p>Let me present you with a couple of examples. Dynamic data:</p>
<figure class="highlight csharp"><pre>XmlOutput xo = new XmlOutput()
	<span class="preprocessor">.XmlDeclaration</span>()
	<span class="preprocessor">.Node</span>(<span class="string">"root"</span>)<span class="preprocessor">.Within</span>()
		<span class="preprocessor">.Node</span>(<span class="string">"numbers"</span>)<span class="preprocessor">.Within</span>()<span class="comment">;</span>

for (int i = <span class="number">1</span><span class="comment">; i &lt;= 10; i++)</span>
	xo<span class="preprocessor">.Node</span>(<span class="string">"number"</span>)<span class="preprocessor">.Attribute</span>(<span class="string">"value"</span>, i<span class="preprocessor">.ToString</span>())<span class="preprocessor">.InnerText</span>(<span class="string">"This is the number: "</span> + i)<span class="comment">;</span>
</pre></figure>


<figure class="highlight xml"><pre><span class="pi">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="tag">&lt;<span class="title">root</span>&gt;</span>
	<span class="tag">&lt;<span class="title">numbers</span>&gt;</span>
		<span class="tag">&lt;<span class="title">number</span> <span class="attribute">value</span>=<span class="value">"1"</span>&gt;</span>This is the number: 1<span class="tag">&lt;/<span class="title">number</span>&gt;</span>
		<span class="tag">&lt;<span class="title">number</span> <span class="attribute">value</span>=<span class="value">"2"</span>&gt;</span>This is the number: 2<span class="tag">&lt;/<span class="title">number</span>&gt;</span>
		<span class="tag">&lt;<span class="title">number</span> <span class="attribute">value</span>=<span class="value">"3"</span>&gt;</span>This is the number: 3<span class="tag">&lt;/<span class="title">number</span>&gt;</span>
		<span class="tag">&lt;<span class="title">number</span> <span class="attribute">value</span>=<span class="value">"4"</span>&gt;</span>This is the number: 4<span class="tag">&lt;/<span class="title">number</span>&gt;</span>
		<span class="tag">&lt;<span class="title">number</span> <span class="attribute">value</span>=<span class="value">"5"</span>&gt;</span>This is the number: 5<span class="tag">&lt;/<span class="title">number</span>&gt;</span>
		<span class="tag">&lt;<span class="title">number</span> <span class="attribute">value</span>=<span class="value">"6"</span>&gt;</span>This is the number: 6<span class="tag">&lt;/<span class="title">number</span>&gt;</span>
		<span class="tag">&lt;<span class="title">number</span> <span class="attribute">value</span>=<span class="value">"7"</span>&gt;</span>This is the number: 7<span class="tag">&lt;/<span class="title">number</span>&gt;</span>
		<span class="tag">&lt;<span class="title">number</span> <span class="attribute">value</span>=<span class="value">"8"</span>&gt;</span>This is the number: 8<span class="tag">&lt;/<span class="title">number</span>&gt;</span>
		<span class="tag">&lt;<span class="title">number</span> <span class="attribute">value</span>=<span class="value">"9"</span>&gt;</span>This is the number: 9<span class="tag">&lt;/<span class="title">number</span>&gt;</span>
		<span class="tag">&lt;<span class="title">number</span> <span class="attribute">value</span>=<span class="value">"10"</span>&gt;</span>This is the number: 10<span class="tag">&lt;/<span class="title">number</span>&gt;</span>
	<span class="tag">&lt;/<span class="title">numbers</span>&gt;</span>
<span class="tag">&lt;/<span class="title">root</span>&gt;</span>
</pre></figure>

<p>And complex structures:</p>
<figure class="highlight csharp"><pre>XmlOutput xo = new XmlOutput()
	<span class="preprocessor">.XmlDeclaration</span>()
	<span class="preprocessor">.Node</span>(<span class="string">"root"</span>)<span class="preprocessor">.Within</span>()
		<span class="preprocessor">.Node</span>(<span class="string">"user"</span>)<span class="preprocessor">.Within</span>()
			<span class="preprocessor">.Node</span>(<span class="string">"username"</span>)<span class="preprocessor">.InnerText</span>(<span class="string">"orca"</span>)
			<span class="preprocessor">.Node</span>(<span class="string">"realname"</span>)<span class="preprocessor">.InnerText</span>(<span class="string">"Mark S. Rasmussen"</span>)
			<span class="preprocessor">.Node</span>(<span class="string">"description"</span>)<span class="preprocessor">.InnerText</span>(<span class="string">"I'll handle any escaping (like &lt; & &gt; for example) needs automagically."</span>)
			<span class="preprocessor">.Node</span>(<span class="string">"articles"</span>)<span class="preprocessor">.Within</span>()
				<span class="preprocessor">.Node</span>(<span class="string">"article"</span>)<span class="preprocessor">.Attribute</span>(<span class="string">"id"</span>, <span class="string">"25"</span>)<span class="preprocessor">.InnerText</span>(<span class="string">"Handling DBNulls"</span>)
				<span class="preprocessor">.Node</span>(<span class="string">"article"</span>)<span class="preprocessor">.Attribute</span>(<span class="string">"id"</span>, <span class="string">"26"</span>)<span class="preprocessor">.InnerText</span>(<span class="string">"Accessing my privates"</span>)
				<span class="preprocessor">.EndWithin</span>()
			<span class="preprocessor">.Node</span>(<span class="string">"hobbies"</span>)<span class="preprocessor">.Within</span>()
				<span class="preprocessor">.Node</span>(<span class="string">"hobby"</span>)<span class="preprocessor">.InnerText</span>(<span class="string">"Fishing"</span>)
				<span class="preprocessor">.Node</span>(<span class="string">"hobby"</span>)<span class="preprocessor">.InnerText</span>(<span class="string">"Photography"</span>)
				<span class="preprocessor">.Node</span>(<span class="string">"hobby"</span>)<span class="preprocessor">.InnerText</span>(<span class="string">"Work"</span>)<span class="comment">;</span>
</pre></figure>


<figure class="highlight xml"><pre><span class="pi">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="tag">&lt;<span class="title">root</span>&gt;</span>
	<span class="tag">&lt;<span class="title">user</span>&gt;</span>
		<span class="tag">&lt;<span class="title">username</span>&gt;</span>orca<span class="tag">&lt;/<span class="title">username</span>&gt;</span>
		<span class="tag">&lt;<span class="title">realname</span>&gt;</span>Mark S. Rasmussen<span class="tag">&lt;/<span class="title">realname</span>&gt;</span>
		<span class="tag">&lt;<span class="title">description</span>&gt;</span>I'll handle any escaping (like <span class="tag">&lt; & &gt;</span> for example) needs automagically.<span class="tag">&lt;/<span class="title">description</span>&gt;</span>
		<span class="tag">&lt;<span class="title">articles</span>&gt;</span>
			<span class="tag">&lt;<span class="title">article</span> <span class="attribute">id</span>=<span class="value">"25"</span>&gt;</span>Handling DBNulls<span class="tag">&lt;/<span class="title">article</span>&gt;</span>
			<span class="tag">&lt;<span class="title">article</span> <span class="attribute">id</span>=<span class="value">"26"</span>&gt;</span>Accessing my privates<span class="tag">&lt;/<span class="title">article</span>&gt;</span>
		<span class="tag">&lt;/<span class="title">articles</span>&gt;</span>
		<span class="tag">&lt;<span class="title">hobbies</span>&gt;</span>
			<span class="tag">&lt;<span class="title">hobby</span>&gt;</span>Fishing<span class="tag">&lt;/<span class="title">hobby</span>&gt;</span>
			<span class="tag">&lt;<span class="title">hobby</span>&gt;</span>Photography<span class="tag">&lt;/<span class="title">hobby</span>&gt;</span>
			<span class="tag">&lt;<span class="title">hobby</span>&gt;</span>Work<span class="tag">&lt;/<span class="title">hobby</span>&gt;</span>
		<span class="tag">&lt;/<span class="title">hobbies</span>&gt;</span>
	<span class="tag">&lt;/<span class="title">user</span>&gt;</span>
<span class="tag">&lt;/<span class="title">root</span>&gt;</span>
</pre></figure>

<p>Finally, say hello to XmlOutput:</p>
<figure class="highlight csharp"><pre><span class="keyword">using</span> System.Xml;
<span class="keyword">using</span> System.Collections.Generic;

<span class="keyword">public</span> <span class="keyword">class</span> XmlOutput
{
	<span class="comment">// The internal XmlDocument that holds the complete structure.</span>
	XmlDocument xd = <span class="keyword">new</span> XmlDocument();

	<span class="comment">// A stack representing the hierarchy of nodes added. nodeStack.Peek() will always be the current node scope.</span>
	Stack&lt;XmlNode&gt; nodeStack = <span class="keyword">new</span> Stack&lt;XmlNode&gt;();

	<span class="comment">// Whether the next node should be created in the scope of the current node.</span>
	<span class="keyword">bool</span> nextNodeWithin;

	<span class="comment">// The current node. If null, the current node is the XmlDocument itself.</span>
	XmlNode currentNode;

	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> Returns the string representation of the XmlDocument.</span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>A string representation of the XmlDocument.<span class="xmlDocTag">&lt;/returns&gt;</span></span>
	<span class="keyword">public</span> <span class="keyword">string</span> <span class="title">GetOuterXml</span>()
	{
		<span class="keyword">return</span> xd.OuterXml;
	}

	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> Returns the XmlDocument</span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span>
	<span class="keyword">public</span> XmlDocument <span class="title">GetXmlDocument</span>()
	{
		<span class="keyword">return</span> xd;
	}

	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> Changes the scope to the current node.</span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>this<span class="xmlDocTag">&lt;/returns&gt;</span></span>
	<span class="keyword">public</span> XmlOutput <span class="title">Within</span>()
	{
		nextNodeWithin = <span class="keyword">true</span>;

		<span class="keyword">return</span> <span class="keyword">this</span>;
	}

	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> Changes the scope to the parent node.</span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>this<span class="xmlDocTag">&lt;/returns&gt;</span></span>
	<span class="keyword">public</span> XmlOutput <span class="title">EndWithin</span>()
	{
		<span class="keyword">if</span> (nextNodeWithin)
			nextNodeWithin = <span class="keyword">false</span>;
		<span class="keyword">else</span>
			nodeStack.Pop();

		<span class="keyword">return</span> <span class="keyword">this</span>;
	}

	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> Adds an XML declaration with the most common values.</span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>this<span class="xmlDocTag">&lt;/returns&gt;</span></span>
	<span class="keyword">public</span> XmlOutput <span class="title">XmlDeclaration</span>() { <span class="keyword">return</span> XmlDeclaration(<span class="string">"1.0"</span>, <span class="string">"utf-8"</span>, <span class="string">""</span>); }

	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> Adds an XML declaration to the document.</span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="version"&gt;</span>The version of the XML document.<span class="xmlDocTag">&lt;/param&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="encoding"&gt;</span>The encoding of the XML document.<span class="xmlDocTag">&lt;/param&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="standalone"&gt;</span>Whether the document is standalone or not. Can be yes/no/(null || "").<span class="xmlDocTag">&lt;/param&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>this<span class="xmlDocTag">&lt;/returns&gt;</span></span>
	<span class="keyword">public</span> XmlOutput <span class="title">XmlDeclaration</span>(<span class="keyword">string</span> version, <span class="keyword">string</span> encoding, <span class="keyword">string</span> standalone)
	{
		XmlDeclaration xdec = xd.CreateXmlDeclaration(version, encoding, standalone);
		xd.AppendChild(xdec);

		<span class="keyword">return</span> <span class="keyword">this</span>;
	}

	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> Creates a node. If no nodes have been added before, it'll be the root node, otherwise it'll be appended as a child of the current node.</span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="name"&gt;</span>The name of the node to create.<span class="xmlDocTag">&lt;/param&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>this<span class="xmlDocTag">&lt;/returns&gt;</span></span>
	<span class="keyword">public</span> XmlOutput <span class="title">Node</span>(<span class="keyword">string</span> name)
	{
		XmlNode xn = xd.CreateElement(name);

		<span class="comment">// If nodeStack.Count == 0, no nodes have been added, thus the scope is the XmlDocument itself.</span>
		<span class="keyword">if</span> (nodeStack.Count == <span class="number">0</span>)
		{
			xd.AppendChild(xn);

			<span class="comment">// Automatically change scope to the root DocumentElement.</span>
			nodeStack.Push(xn);
		}
		<span class="keyword">else</span>
		{
			<span class="comment">// If this node should be created within the scope of the current node, change scope to the current node before adding the node to the scope element.</span>
			<span class="keyword">if</span> (nextNodeWithin)
			{
				nodeStack.Push(currentNode);

				nextNodeWithin = <span class="keyword">false</span>;
			}

			nodeStack.Peek().AppendChild(xn);
		}

		currentNode = xn;

		<span class="keyword">return</span> <span class="keyword">this</span>;
	}

	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> Sets the InnerText of the current node without using CData.</span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="text"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span>
	<span class="keyword">public</span> XmlOutput <span class="title">InnerText</span>(<span class="keyword">string</span> text)
	{
		<span class="keyword">return</span> InnerText(text, <span class="keyword">false</span>);
	}

	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> Sets the InnerText of the current node.</span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="text"&gt;</span>The text to set.<span class="xmlDocTag">&lt;/param&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>this<span class="xmlDocTag">&lt;/returns&gt;</span></span>
	<span class="keyword">public</span> XmlOutput <span class="title">InnerText</span>(<span class="keyword">string</span> text, <span class="keyword">bool</span> useCData)
	{
		<span class="keyword">if</span> (useCData)
			currentNode.AppendChild(xd.CreateCDataSection(text));
		<span class="keyword">else</span>
			currentNode.AppendChild(xd.CreateTextNode(text));

		<span class="keyword">return</span> <span class="keyword">this</span>;
	}

	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> Adds an attribute to the current node.</span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="name"&gt;</span>The name of the attribute.<span class="xmlDocTag">&lt;/param&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="value"&gt;</span>The value of the attribute.<span class="xmlDocTag">&lt;/param&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>this<span class="xmlDocTag">&lt;/returns&gt;</span></span>
	<span class="keyword">public</span> XmlOutput <span class="title">Attribute</span>(<span class="keyword">string</span> name, <span class="keyword">string</span> <span class="keyword">value</span>)
	{
		XmlAttribute xa = xd.CreateAttribute(name);
		xa.Value = <span class="keyword">value</span>;

		currentNode.Attributes.Append(xa);

		<span class="keyword">return</span> <span class="keyword">this</span>;
	}
}
</pre></figure>

<p>Enjoy!</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Oct</span>
			<span class="day">09</span>
		</div>
		<div class="lower">2007</div>
	</div>

	<div class="title">
		<h1><a href="/accessing-my-privates/" title="Accessing My Privates, Scope vs Encapsulation" rel="bookmark">Accessing My Privates, Scope vs Encapsulation</a></h1>
		<div class="categories">
			
				<a href="http://improve.dk/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Recently I was developing a couple of simple ORM classes that had me confused.</p>
<a id="more"></a>


<figure class="highlight csharp"><pre>[Serializable]
<span class="keyword">public</span> <span class="keyword">class</span> Domain
{
	<span class="comment">// Read</span>
	<span class="keyword">private</span> <span class="keyword">int</span> domainID;
	<span class="keyword">public</span> <span class="keyword">int</span> DomainID { <span class="keyword">get</span> { <span class="keyword">return</span> domainID; } }
	
	<span class="keyword">private</span> <span class="keyword">string</span> domainName;
	<span class="keyword">public</span> <span class="keyword">string</span> DomainName { <span class="keyword">get</span> { <span class="keyword">return</span> domainName; } }

	<span class="comment">// Read/Write</span>
	<span class="keyword">public</span> <span class="keyword">int</span>? CompanyID;
}
</pre></figure>

<p>Take this simple object as an example. It represents a website domain, it has an ID from the database aswell as a read only domain name and a belonging CompanyID.</p>
<p>Now, I want to create a Load() function that given a domain ID will instantiate a new instance of a Domain object and populate its values from the database. Now, as the DomainID and DomainName variables are private, I’ll have to make a constructor method to pass in those values, right? It seems not, if my Load method is a static method of the Domain class itself:</p>
<figure class="highlight csharp"><pre><span class="keyword">public</span> <span class="keyword">static</span> Domain <span class="title">Load</span>(<span class="keyword">int</span> domainID)
{
	SqlCommand cmd = <span class="keyword">new</span> SqlCommand(<span class="string">"SELECT Domain, CompanyID FROM tblDomains WHERE DomainID = @DomainID"</span>);
	cmd.Parameters.Add(<span class="string">"@DomainID"</span>, SqlDbType.Int).Value = domainID;

	DataRow dr = DB.GetDR(cmd);

	<span class="keyword">if</span> (dr == <span class="keyword">null</span>)
		<span class="keyword">return</span> <span class="keyword">null</span>;
	<span class="keyword">else</span>
	{
		Domain d = <span class="keyword">new</span> Domain();
		
		d.domainID = domainID;
		d.domainName = DBConvert.To&lt;<span class="keyword">string</span>&gt;(dr[<span class="string">"Domain"</span>]);
		d.CompanyID = DBConvert.To&lt;<span class="keyword">int</span>?&gt;(dr[<span class="string">"CompanyID"</span>]);

		<span class="keyword">return</span> d;
	}
}
</pre></figure>

<p>The interesting part is in the else block. I create a new Domain instance, and I’m able to set the private field values directly. This saves me a lot of work as I don’t have to create constructor methods - I’d rather not have to maintain those as well, and I think this was is a lot more readable. Anyways, I don’t understand why this is possible. Granted, my static method is part of the Domain class and as such could have access to private variables, but these private variables are not static and thus they belong to the actual Domain instance (d). Since they belong to the Domain instance and I’m setting them through the instance variable d, how am I able to access them? Ought they noe be private, even though I’m writing my code inside the Domain function?</p>
<p>Everything compiles and runs perfectly, I just don’t understand why this is possible.</p>
<p>Update:<br>    <a href="http://www.intellect.dk/" target="_blank">Jakob Andersen</a> provided me with the answer. It’s simply a matter of scope, whether the method is static or not does not matter. Also encapsulation is ignored as scope takes precedence.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Oct</span>
			<span class="day">08</span>
		</div>
		<div class="lower">2007</div>
	</div>

	<div class="title">
		<h1><a href="/handling-dbnulls/" title="Handling DBNulls" rel="bookmark">Handling DBNulls</a></h1>
		<div class="categories">
			
				<a href="http://improve.dk/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Reading and writing values to the DB has always been a bit cumbersome when you had to take care of nullable types and DBNull values. Here’s a way to make it easy.  Based on <a href="http://aspalliance.com/852" target="_blank">this post by Peter Johnson</a> and <a href="http://www.falafel.com/community/blogs/techbits/archive/2006/10/13/Casting-DBNull-Gracefully-and-Elegantly-Using-Generics.aspx" target="_blank">this post by Adam Anderson</a> I gathered a couple of ideas and combined them to make a completely generic class that will handle DBNulls for both reads and writes, as well as handling nullable types.  Let me present the code, I’ll go over it afterwards:</p>
<a id="more"></a>


<figure class="highlight csharp"><pre><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> DBConvert
{
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> Handles reading DBNull values from database in a generic fashion</span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;typeparam name="T"&gt;</span>The type of the value to read<span class="xmlDocTag">&lt;/typeparam&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="value"&gt;</span>The input value to convert<span class="xmlDocTag">&lt;/param&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>A strongly typed result, null if the input value is DBNull<span class="xmlDocTag">&lt;/returns&gt;</span></span>
	<span class="keyword">public</span> <span class="keyword">static</span> T To&lt;T&gt;(<span class="keyword">object</span> <span class="keyword">value</span>)
	{
		<span class="keyword">if</span> (<span class="keyword">value</span> <span class="keyword">is</span> DBNull)
			<span class="keyword">return</span> <span class="keyword">default</span>(T);
		<span class="keyword">else</span>
			<span class="keyword">return</span> (T)changeType(<span class="keyword">value</span>, <span class="keyword">typeof</span>(T));
	}

	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> Handles reading DBNull values from database in a generic fashion, simplifies frontend databinding</span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;typeparam name="T"&gt;</span>The type of the value to read<span class="xmlDocTag">&lt;/typeparam&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="ri"&gt;</span>The Container item in a databinding operation<span class="xmlDocTag">&lt;/param&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="column"&gt;</span>The dataitem to read<span class="xmlDocTag">&lt;/param&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>A strongly typed result, null if the input value is DBNull<span class="xmlDocTag">&lt;/returns&gt;</span></span>
	<span class="keyword">public</span> <span class="keyword">static</span> T To&lt;T&gt;(RepeaterItem ri, <span class="keyword">string</span> column)
	{
		<span class="keyword">if</span> (DataBinder.Eval(ri.DataItem, column) <span class="keyword">is</span> DBNull)
			<span class="keyword">return</span> <span class="keyword">default</span>(T);
		<span class="keyword">else</span>
			<span class="keyword">return</span> (T)changeType(DataBinder.Eval(ri.DataItem, column), <span class="keyword">typeof</span>(T));
	}

	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> Internal method that wraps Convert.ChangeType() so it handles Nullable<span class="xmlDocTag">&lt;&gt;</span> types</span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="value"&gt;</span>The value to convert<span class="xmlDocTag">&lt;/param&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="conversionType"&gt;</span>The type to convert into<span class="xmlDocTag">&lt;/param&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>The input value converted to type conversionType<span class="xmlDocTag">&lt;/returns&gt;</span></span>
	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">object</span> <span class="title">changeType</span>(<span class="keyword">object</span> <span class="keyword">value</span>, Type conversionType)
	{
		<span class="keyword">if</span> (conversionType.IsGenericType && conversionType.GetGenericTypeDefinition().Equals(<span class="keyword">typeof</span>(Nullable&lt;&gt;)))
		{
			<span class="keyword">if</span> (<span class="keyword">value</span> == <span class="keyword">null</span>)
				<span class="keyword">return</span> <span class="keyword">null</span>;

			conversionType = Nullable.GetUnderlyingType(conversionType);
		}

		<span class="keyword">return</span> Convert.ChangeType(<span class="keyword">value</span>, conversionType);
	}

	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> Simplifies setting SqlParameter values by handling null issues</span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="value"&gt;</span>The value to return<span class="xmlDocTag">&lt;/param&gt;</span></span>
	<span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>DBNull if value == null, otherwise we pass through value<span class="xmlDocTag">&lt;/returns&gt;</span></span>
	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">object</span> <span class="title">From</span>(<span class="keyword">object</span> <span class="keyword">value</span>)
	{
		<span class="keyword">if</span> (<span class="keyword">value</span> == <span class="keyword">null</span>)
			<span class="keyword">return</span> DBNull.Value;
		<span class="keyword">else</span>
			<span class="keyword">return</span> <span class="keyword">value</span>;
	}
}
</pre></figure>

<p>The first To method significantly simplifies the process of setting database values when using SqlParameters (we all do, right?).</p>
<p>This is how I used to handle possible DBNulls when reading into a nullable integer:</p>
<figure class="highlight csharp"><pre><span class="keyword">if</span>(dr[<span class="string">"CountryID"</span>] <span class="keyword">is</span> DBNull)
	c.CountryID = <span class="keyword">null</span>;
<span class="keyword">else</span>
	c.CountryID = Convert.ToInt32(dr[<span class="string">"CountryID"</span>]);
</pre></figure>

<p>And this is how it’s done using my DBConvert class:</p>
<figure class="highlight csharp"><pre>c<span class="preprocessor">.CountryID</span> = DBConvert<span class="preprocessor">.To</span>&lt;int?&gt;(dr[<span class="string">"CountryID"</span>])<span class="comment">;</span>
c<span class="preprocessor">.Recommended</span> = DBConvert<span class="preprocessor">.To</span>&lt;bool&gt;(dr[<span class="string">"Recommended"</span>])<span class="comment">;</span>
d<span class="preprocessor">.companyMessageCreated</span> = DBConvert<span class="preprocessor">.To</span>&lt;DateTime?&gt;(dr[<span class="string">"CompanyMessageCreated"</span>])<span class="comment">;</span>
d<span class="preprocessor">.Message</span> = DBConvert<span class="preprocessor">.To</span>&lt;string&gt;(dr[<span class="string">"Message"</span>])<span class="comment">;</span>
d<span class="preprocessor">.OverallScore</span> = DBConvert<span class="preprocessor">.To</span>&lt;int&gt;(dr[<span class="string">"OverallScore"</span>])<span class="comment">;</span>
</pre></figure>

<p>Notice how it works for both nullable ints, DateTimes and whatever other nullable types you wish. It also works for normal types like string, int and so forth. It’ll automatically typecast it into the type specified as a generic parameter. However, remember that the database value must match the value being converted to, you cannot use .To(“some string value”), it will fail.</p>
<p>The private changeType() method is a wrapper for the ChangeType() method that takes care of nullable types since the builtin Convert.ChangeType() method does not support casting into nullable types.</p>
<p>The second To simplifies databinding values in the frontend ASPX files. This is how I used to print a DateTime column in a ShortDateString format:</p>
<figure class="highlight csharp"><pre><span class="vbscript">&lt;%# Convert.ToDateTime(DataBinder.<span class="built_in">Eval</span>(Container.DataItem, <span class="string">"Created"</span>)).ToShortDateString() %&gt;</span>
</pre></figure>

<p>And this is how it can be done using the DBConvert class, generically:</p>
<figure class="highlight csharp"><pre><span class="vbscript">&lt;%# DBConvert.<span class="keyword">To</span>&lt;DateTime&gt;(Container, <span class="string">"Created"</span>).ToShortDateString() %&gt;</span>
</pre></figure>

<p>Nullable types, as well as null strings also have to be handled when assigning SqlParameter values. The usual way for both nullable types as well as strings might look like this:</p>
<figure class="highlight csharp"><pre>if(CountryID == null)
	cmd<span class="preprocessor">.Parameters</span><span class="preprocessor">.Add</span>(<span class="string">"@CountryID"</span>, SqlDbType<span class="preprocessor">.Int</span>)<span class="preprocessor">.Value</span> = DBNull<span class="preprocessor">.Value</span><span class="comment">;</span>
else
	cmd<span class="preprocessor">.Parameters</span><span class="preprocessor">.Add</span>(<span class="string">"@CountryID"</span>, SqlDbType<span class="preprocessor">.Int</span>)<span class="preprocessor">.Value</span> = CountryID<span class="comment">;</span>
</pre></figure>

<p>Using the DBConvert class this can be done a bit simpler:</p>
<figure class="highlight csharp"><pre>cmd<span class="preprocessor">.Parameters</span><span class="preprocessor">.Add</span>(<span class="string">"@CountryID"</span>, SqlDbType<span class="preprocessor">.Int</span>)<span class="preprocessor">.Value</span> = DBConvert<span class="preprocessor">.From</span>(CountryID)<span class="comment">;</span>
cmd<span class="preprocessor">.Parameters</span><span class="preprocessor">.Add</span>(<span class="string">"@CountryID"</span>, SqlDbType<span class="preprocessor">.NVarChar</span>, <span class="number">2048</span>)<span class="preprocessor">.Value</span> = DBConvert<span class="preprocessor">.From</span>(MyString)<span class="comment">;</span>
</pre></figure>

<p>This will automatically convert null strings as well as nulled nullable types to DBNull.</p>
<p>Enjoy :)</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Sep</span>
			<span class="day">29</span>
		</div>
		<div class="lower">2007</div>
	</div>

	<div class="title">
		<h1><a href="/compiling-java-in-visual-studio/" title="Compiling Java in Visual Studio" rel="bookmark">Compiling Java in Visual Studio</a></h1>
		<div class="categories">
			
				<a href="http://improve.dk/category/Visual Studio/">Visual Studio</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I often see my fellow comp. sci. students writing their (relatively) simple Java code in applications like Emacs, Nano or Eclipse. I’m not fond of either application. I much prefer Visual Studios text handling, solution overview, output windows and so forth. What most people don’t know is that you can actually extend Visual Studio to a great extent. One way to extend Visual Studio is to write plugins using .NET, but there’s a way that is much simpler (albeit also more limited). I will now show how you can make Visual Studio compile and run your Java applications all within Visual Studio itself.</p>
<a id="more"></a>

<p>First of all, you need to <a href="http://java.sun.com/javase/downloads/index.jsp" target="_blank">download and install the Java JDK</a>. Basically, you need to be able to call “javac” and “java” from any command prompt - which means you have to setup the environment settings so you have your JDK bin in the PATH variable.</p>
<div class="imgwrapper" style=""><div><a href="/compiling-java-in-visual-studio/javac_1_2.jpg" class="fancy"><img src="/compiling-java-in-visual-studio/javac_1_2.jpg" style="max-height: 250px"/></a></div></div>

<div class="imgwrapper" style=""><div><a href="/compiling-java-in-visual-studio/javac_2_2.jpg" class="fancy"><img src="/compiling-java-in-visual-studio/javac_2_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Create a new Visual Studio project. It really doesn’t matter much what type you choose as there is no native Java project types. Choosing J# will not give you any advantages over, say a C# project. In this example I’ll use a C# Class Library project.</p>
<div class="imgwrapper" style=""><div><a href="/compiling-java-in-visual-studio/javac_3_2.jpg" class="fancy"><img src="/compiling-java-in-visual-studio/javac_3_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Start out by deleting the automatically created Class1.cs file. Add a new text file instead, I’ll call it MyApplication.java. You can write any standard Java code in the Java files, just like you’d ordinarily do.</p>
<div class="imgwrapper" style=""><div><a href="/compiling-java-in-visual-studio/javac_4_2.jpg" class="fancy"><img src="/compiling-java-in-visual-studio/javac_4_2.jpg" style="max-height: 250px"/></a></div></div>

<p>One of the really cool features of Visual Studio is that it actually includes Intellisense for a lot of the standard Java classes, so you’re not left totally on your own.</p>
<div class="imgwrapper" style=""><div><a href="/compiling-java-in-visual-studio/javac_5_2.jpg" class="fancy"><img src="/compiling-java-in-visual-studio/javac_5_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Now comes the compilation part. Add a new text file to the project and call it Compile.bat. This will be the bat file that manages the actual compilation and execution of the application afterwards. Leave the file empty for now, we’ll enter the code in a short while.</p>
<div class="imgwrapper" style=""><div><a href="/compiling-java-in-visual-studio/javac_6_2.jpg" class="fancy"><img src="/compiling-java-in-visual-studio/javac_6_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Go to Tools -&gt; External Tools…</p>
<div class="imgwrapper" style=""><div><a href="/compiling-java-in-visual-studio/javac_7_2.jpg" class="fancy"><img src="/compiling-java-in-visual-studio/javac_7_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Add a new entry called “Javac”, set the command path to your Compile.bat file and make sure the directory is set to the ProjectDir macro path. Check the “Use Output window” checkbox, this ensures the output is output directly into the Visual Studio output window.</p>
<div class="imgwrapper" style=""><div><a href="/compiling-java-in-visual-studio/javac_8_2.jpg" class="fancy"><img src="/compiling-java-in-visual-studio/javac_8_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Now enter the following into the Compile.bat file:</p>
<figure class="highlight java"><pre>del Output /S /Q
mkdir Output
javac *.java -d Output
cd Output
start java MyApplication
</pre></figure>

<p>Modify the MyApplication.java file so it ends with a call to System.in.read(), this ensures the application will stay open after we start it.</p>
<figure class="highlight java"><pre><span class="keyword">import</span> java.io.*;

class MyApplication
{
	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(String args[]) <span class="keyword">throws</span> IOException
	{
		System.out.println(<span class="string">"Hello World!"</span>);
		System.in.read();
	}
}
</pre></figure>

<p>Now simply go to Tools -&gt; Javac and watch your Java application compile and run.</p>
<div class="imgwrapper" style=""><div><a href="/compiling-java-in-visual-studio/javac_9_2.jpg" class="fancy"><img src="/compiling-java-in-visual-studio/javac_9_2.jpg" style="max-height: 250px"/></a></div></div>

<p>You can of course modify the build script in whatever way you wish to support larger applications. You could also use ANT build scripts, unit tests and so forth. To make compiling easier, you can create a key command (Tools -&gt; Options -&gt; Keyboard -&gt; Tools.ExternalCommandX where X is the Javac commands index in the Tools menu) to the Javac command in the Visual Studio settings, I use Ctrl+Shift+J for Java compilation myself.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Sep</span>
			<span class="day">21</span>
		</div>
		<div class="lower">2007</div>
	</div>

	<div class="title">
		<h1><a href="/jaoo-2007/" title="JAOO 2007" rel="bookmark">JAOO 2007</a></h1>
		<div class="categories">
			
				<a href="http://improve.dk/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I will be attending JAOO this year, I’m looking forward to a packed calendar in excitement:</p>
<a id="more"></a>

<div class="imgwrapper" style=""><div><a href="/jaoo-2007/jaoo_logo_2.jpg" class="fancy"><img src="/jaoo-2007/jaoo_logo_2.jpg" style="max-height: 250px"/></a></div></div>

<div class="imgwrapper" style=""><div><a href="/jaoo-2007/jaoo_schedule_2.jpg" class="fancy"><img src="/jaoo-2007/jaoo_schedule_2.jpg" style="max-height: 250px"/></a></div></div>

<p>It’s a tough decision, choosing which sessions to fit into the available slots. There are several slots where I’d love to watch multiple sessions.</p>
<p>I look forward to meeting a lot of people, colleagues and friends. Conferences are superb for developing ones network.</p>
<p>I like the multitude of technologies and areas that are covered at JAOO, Java, JavaScript, .NET, virtualization, architecture and so forth. I’d love to see some more DBA related sessions though (especially MSSQL 2008).</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jun</span>
			<span class="day">23</span>
		</div>
		<div class="lower">2007</div>
	</div>

	<div class="title">
		<h1><a href="/zune-causing-license-resets/" title="Zune Causing License Resets?" rel="bookmark">Zune Causing License Resets?</a></h1>
		<div class="categories">
			
				<a href="http://improve.dk/category/Miscellaneous/">Miscellaneous</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I’ve had my Vista PC running for quite some months now without problems, as well as Adobe Acrobat Professional and Adobe Photoshop. But not anymore…</p>
<a id="more"></a>

<div class="imgwrapper" style=""><div><a href="/zune-causing-license-resets/zuneactivation_1_2.jpg" class="fancy"><img src="/zune-causing-license-resets/zuneactivation_1_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Yesterday I plugged in the Zune that I bought on a trip to the US in january. I got the installer / driver software from zune.net. During the installation the installer requested me to update my Zune firmware, which I did. Everything went smooth.</p>
<p>I then left my PC for some hours to go to work. When I got back I was shown a dialog saying that my hardware configuration had changed and that I needed to reactivate Vista, hmmm. I tried the automatic activation but it said my key was already in use. After calling the automatic activation service phone number I got Vista reactivated, weird stuff.</p>
<p>Then suddenly Adobe Acrobat said that my current license was invalid and that I had to reactivate the software. I had to do this twice as I got the exact same message the next time I started Acrobat:</p>
<div class="imgwrapper" style=""><div><a href="/zune-causing-license-resets/zuneactivation_3_2.jpg" class="fancy"><img src="/zune-causing-license-resets/zuneactivation_3_2.jpg" style="max-height: 250px"/></a></div></div>

<p>And now today I just started Photoshop, and Guess what came up:</p>
<div class="imgwrapper" style=""><div><a href="/zune-causing-license-resets/zuneactivation_2_2.jpg" class="fancy"><img src="/zune-causing-license-resets/zuneactivation_2_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Did me plugging in my Zune cause all of this? I have not made any other hardware changes for months, but how in the world would plugging in an MP3 player cause such a mess?</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jun</span>
			<span class="day">10</span>
		</div>
		<div class="lower">2007</div>
	</div>

	<div class="title">
		<h1><a href="/creating-a-dotnet-bootstrapped-installer-using-nsis/" title="Creating a .NET Bootstrapped Installer Using NSIS" rel="bookmark">Creating a .NET Bootstrapped Installer Using NSIS</a></h1>
		<div class="categories">
			
				<a href="http://improve.dk/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>If you have ever deployed .NET windows applications, you have without doubt tried the Visual Studio Install project type. The Install project will create .MSI install applications for you, they’re great for basic installations, but nothing more than that. The .NET bootstrapper is quite lacking, at times it won’t be able to find the framework download file as it’s changed it’s location, at other times it’s not able to download it. And finally, if it does determine that the user needs the framework, it’s shown in an ugly uncustomizable GUI.</p>
<a id="more"></a>

<p>I’ve looked for an alternative, I’d prefer not to pay for using some of the well established installers such as Wise, InstallShield, ActiveInstall and so forth. What I found is a remnant of WinAmp, the <a href="http://nsis.sourceforge.net/Main_Page" target="_blank">NSIS (Nullsoft Scriptable Install System) project</a>.</p>
<p>NSIS is both free and open source and it’s very much community driven. There are a plethora of plugins available for all sorts of different tasks, and of course you can write your own plugins for special needs.</p>
<p>I won’t delve too deeply into why you should choose NSIS over any of the competitors, instead I’ll show you a step by step guide of how to create an NSIS installer that bootstraps the .NET 2.0 framework as well as running custom install and uninstall actions in .NET code.</p>
<p>You will need two tools. The first (and actually the only required tool) is NSIS itself: <a href="http://nsis.sourceforge.net/Main_Page" target="_blank">Download NSIS from nsis.sourceforge.net</a>. While you can edit the install script in any text editor, using an IDE like HM NIS Edit (HMNE) makes it a whole lot easier: <a href="http://hmne.sourceforge.net/" target="_blank">Download HMNE from hmne.sourceforge.net</a>.</p>
<p>Let’s first create the simple application that we will be installing. It doesn’t really matter what it is, in this example I’ve made a single Windows Forms Application:</p>
<div class="imgwrapper" style=""><div><a href="/creating-a-dotnet-bootstrapped-installer-using-nsis/nsis_1_2.jpg" class="fancy"><img src="/creating-a-dotnet-bootstrapped-installer-using-nsis/nsis_1_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Now let’s start up HMNE. Click File -&gt; New Script From Wizard. Fill in the relevant application date on the first page.</p>
<div class="imgwrapper" style=""><div><a href="/creating-a-dotnet-bootstrapped-installer-using-nsis/nsis_2_2.jpg" class="fancy"><img src="/creating-a-dotnet-bootstrapped-installer-using-nsis/nsis_2_2.jpg" style="max-height: 250px"/></a></div></div>

<p>You may choose a custom icon for the installer, the default icon is an NSIS standard icon. You can also choose the resulting installation files name as well as it’s output location. If no location is specified, it will be outputted to the location that contains our script file. A great feature of NSIS is that it’s got localized versions for a lot of different languages built in, simply select the languages that the user should be able to select and the installer will automatically be localized. You can choose a couple of different GUIs, I personally prefer the Modern one. As for compression, in my tests the LZMA compression works the best, though compression time and CPU usage might be a factor for very large projects.</p>
<div class="imgwrapper" style=""><div><a href="/creating-a-dotnet-bootstrapped-installer-using-nsis/nsis_3_2.jpg" class="fancy"><img src="/creating-a-dotnet-bootstrapped-installer-using-nsis/nsis_3_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Now you specify where you want your application to be installed, notice the general use of variables like $PROGRAMFILES, $NSISDIR, $INSTDIR and so forth. You can also optionally choose a license file that the user must accept to continue the installation.</p>
<div class="imgwrapper" style=""><div><a href="/creating-a-dotnet-bootstrapped-installer-using-nsis/nsis_4_2.jpg" class="fancy"><img src="/creating-a-dotnet-bootstrapped-installer-using-nsis/nsis_4_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Now you can setup the actual files that will be installed as part of the project. You cannot select a whole project output as you can in the Visual Studio Install project, instead you must manually select the files that should be installed, usually from the Debug/Release directories of your project(s).</p>
<div class="imgwrapper" style=""><div><a href="/creating-a-dotnet-bootstrapped-installer-using-nsis/nsis_5_2.jpg" class="fancy"><img src="/creating-a-dotnet-bootstrapped-installer-using-nsis/nsis_5_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Optionally you can select which links you want to be placed in the application program group in the start menu, if such one should be created at all.</p>
<div class="imgwrapper" style=""><div><a href="/creating-a-dotnet-bootstrapped-installer-using-nsis/nsis_6_2.jpg" class="fancy"><img src="/creating-a-dotnet-bootstrapped-installer-using-nsis/nsis_6_2.jpg" style="max-height: 250px"/></a></div></div>

<p>When the installation is done, the user can choose to view the Readme file and/or start the application - that is, if you specify an application and/or a readme file.</p>
<div class="imgwrapper" style=""><div><a href="/creating-a-dotnet-bootstrapped-installer-using-nsis/nsis_7_2.jpg" class="fancy"><img src="/creating-a-dotnet-bootstrapped-installer-using-nsis/nsis_7_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Finally we can choose to include an uninstaller, as well as specifying our custom uninstallation confirmation and report texts. If no custom text is specified, the default texts will be used.</p>
<p>When the wizard finishes, make sure to click “Save script” and “Convert file paths to relative paths”.</p>
<p>Finally the install script is made and ready to run. Press Ctrl+9 to compile the script. If everything succeeds, you’ll see the Setup.exe file in the same directory as the one where you saved the install script. I will not be going over the various commands and settings that are being set in the script, for that I strongly recommend the excellent built in help documents, as well as the <a href="http://forums.winamp.com/forumdisplay.php?s=&amp;forumid=65" target="_blank">WinAmp NSIS forums</a>. Instead I’ll focus on how to bootstrap the .NET Framework 2.0 and how to run custom install and uninstall actions.</p>
<p>Add these three lines to the top of your nsi file, they include some functions that we will need:</p>
<figure class="highlight nsi"><pre>; Script generated <span class="keyword">by</span> <span class="operator">the</span> HM NIS Edit Script Wizard.
!<span class="built_in">include</span> WordFunc.nsh
!insertmacro VersionCompare
!<span class="built_in">include</span> LogicLib.nsh
</pre></figure>

<p>Add this line right above the .onInit function, it makes a variable (untyped) that’ll contain a Yes/No value, depending on whether we need to install the .NET Framework or not.</p>
<figure class="highlight nsi"><pre><span class="keyword">Var</span> InstallDotNET
</pre></figure>

<p>Now modify the .onInit function so it matches the below, as well as adding the GetDotNETVersion function. First we ask the user what language they want to continue in (!insertmacro MUI_LANGDLL_DISPLAY). After that we initialize the InstallDotNET variable to “No”. Depending on the result of the GetDotNETVersion we tell the user that we need to install the framework, either because the user does not have the framework at all, or because the version is less than 2.0. We won’t actually install the framework yet, we’ll just remember whether we have to or not.</p>
<figure class="highlight nsi"><pre>Function .onInit
  !insertmacro MUI_LANGDLL_DISPLAY

  ; Check .NET version
  StrCpy <span class="variable">$InstallDotNET</span> <span class="string">"No"</span>
  Call GetDotNETVersion
  Pop <span class="variable">$0</span>

  <span class="variable">${If}</span> <span class="variable">$0</span> == <span class="string">"not found"</span>
        StrCpy <span class="variable">$InstallDotNET</span> <span class="string">"Yes"</span>
  	MessageBox MB_OK|MB_ICONINFORMATION <span class="string">"<span class="subst">${PRODUCT_NAME}</span> requires that the .NET Framework 2.0 is installed. The .NET Framework will be downloaded and installed automatically during installation of <span class="subst">${PRODUCT_NAME}</span>."</span>
   	Return
  <span class="variable">${EndIf}</span>

  StrCpy <span class="variable">$0</span> <span class="variable">$0</span> <span class="string">""</span> <span class="number">1</span> <span class="comment"># skip "v"</span>

  <span class="variable">${VersionCompare}</span> <span class="variable">$0</span> <span class="string">"2.0"</span> <span class="variable">$1</span>
  <span class="variable">${If}</span> <span class="variable">$1</span> == <span class="number">2</span>
        StrCpy <span class="variable">$InstallDotNET</span> <span class="string">"Yes"</span>
  	MessageBox MB_OK|MB_ICONINFORMATION <span class="string">"<span class="subst">${PRODUCT_NAME}</span> requires that the .NET Framework 2.0 is installed. The .NET Framework will be downloaded and installed automatically during installation of <span class="subst">${PRODUCT_NAME}</span>."</span>
   	Return
  <span class="variable">${EndIf}</span>
FunctionEnd

Function GetDotNETVersion
	Push <span class="variable">$0</span>
	Push <span class="variable">$1</span>

	System::Call <span class="string">"mscoree::GetCORVersion(w .r0, i <span class="subst">${NSIS_MAX_STRLEN}</span>, <span class="variable">*i</span>) i .r1"</span>
	StrCmp <span class="variable">$1</span> <span class="string">"error"</span> <span class="number">0</span> +<span class="number">2</span>
	StrCpy <span class="variable">$0</span> <span class="string">"not found"</span>

	Pop <span class="variable">$1</span>
	Exch <span class="variable">$0</span>
FunctionEnd
</pre></figure>

<p>Before we continue, you’ll have to <a href="http://nsis.sourceforge.net/Inetc_plug-in" target="_blank">install the InetC plugin</a>.</p>
<p>Now find the “MainSection” section (depending on what you called it in the wizard).</p>
<p>Modify the section so it looks like the below. Your file names and amount may vary, the primary part of our concern is the first part. It will test whether the $InstallDotNET variable implies that we have to install the framework. If it does, it’ll hide the usual GUI elements of the installer and start the download of the .NET Framework from any URL you specify, this could be the official download URL or a location you host yourself. If the user cancels the download we’ll delete the half-finished file and abort. Otherwise we’ll execute the dotnetfx.exe file and wait for it to complete (hence we’ll now have the .NET Framework 2.0). After having installed the framework we delete the dotnetfx.exe file again. Finally we show the GUI again.</p>
<figure class="highlight nsi"><pre>Section <span class="string">"MainSection"</span> SEC01
  SetOutPath <span class="string">"<span class="variable">$INSTDIR</span>"</span>
  SetOverwrite ifnewer

  ; Get .NET <span class="keyword">if</span> required
  <span class="variable">${If}</span> <span class="variable">$InstallDotNET</span> == <span class="string">"Yes"</span>
     SetDetailsView hide
     inetc::get /caption <span class="string">"Downloading .NET Framework 2.0"</span> /canceltext <span class="string">"Cancel"</span> <span class="string">"http://www.url_of_the_dotnetfx.exe_file"</span> <span class="string">"<span class="variable">$INSTDIRdotnetfx</span>.exe"</span> /end
     Pop <span class="variable">$1</span>

     <span class="variable">${If}</span> <span class="variable">$1</span> != <span class="string">"OK"</span>
           Delete <span class="string">"<span class="variable">$INSTDIRdotnetfx</span>.exe"</span>
           Abort <span class="string">"Installation cancelled."</span>
     <span class="variable">${EndIf}</span>

     ExecWait <span class="string">"<span class="variable">$INSTDIRdotnetfx</span>.exe"</span>
     Delete <span class="string">"<span class="variable">$INSTDIRdotnetfx</span>.exe"</span>

     SetDetailsView show
  <span class="variable">${EndIf}</span> 

  File <span class="string">"InstallbinDebugInstall.exe"</span>

  File <span class="string">"InstallbinDebugUninstall.exe"</span>

  File <span class="string">"MyApplicationbinDebugMyApplication.exe"</span>
  CreateDirectory <span class="string">"<span class="variable">$SMPROGRAMSMy</span> application"</span>
  CreateShortCut <span class="string">"<span class="variable">$SMPROGRAMSMy</span> applicationMy application.lnk"</span> <span class="string">"<span class="variable">$INSTDIRMyApplication</span>.exe"</span>
  CreateShortCut <span class="string">"<span class="variable">$DESKTOPMy</span> application.lnk"</span> <span class="string">"<span class="variable">$INSTDIRMyApplication</span>.exe"</span>
SectionEnd
</pre></figure>

<p>Now comes the part where I’ll introduce our custom .NET install and uninstall actions. Create two new Console Application projects in the solution called Uninstall and Install, like the following:</p>
<div class="imgwrapper" style=""><div><a href="/creating-a-dotnet-bootstrapped-installer-using-nsis/nsis_9_2.jpg" class="fancy"><img src="/creating-a-dotnet-bootstrapped-installer-using-nsis/nsis_9_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Add the below function to your code, it’ll run the Install.exe file after the installation has successfully completed:</p>
<figure class="highlight nsi"><pre><span class="title">Function</span> .<span class="built_in">on</span>InstSuccess
         ExecWait <span class="string">"<span class="variable">$InstDirInstall</span>.exe"</span>
FunctionEnd
</pre></figure>

<p>Locate the “Section Uninstall” part and add the following line as the very first:</p>
<figure class="highlight nsi"><pre>ExecWait <span class="string">"<span class="variable">$InstDirUninstall</span>.exe"</span>
</pre></figure>

<p>Make sure to add both Install.exe and Uninstall.exe to the list of files that will be installed, in the Main Section. It will run the Uninstall.exe application before anything else, and wait for it to finish before continuing. After it’s done we’ll delete all the installed files, including the Install and Uninstall.exe applications - remember to add those to file deletions manually, following the syntax of the other file deletions.</p>
<p>Now press Ctrl+9 to build the installer, and look at it run in all of its awesomeness:</p>
<div class="imgwrapper" style=""><div><a href="/creating-a-dotnet-bootstrapped-installer-using-nsis/nsis_10_2.jpg" class="fancy"><img src="/creating-a-dotnet-bootstrapped-installer-using-nsis/nsis_10_2.jpg" style="max-height: 250px"/></a></div></div>

<div class="imgwrapper" style=""><div><a href="/creating-a-dotnet-bootstrapped-installer-using-nsis/nsis_11_2.jpg" class="fancy"><img src="/creating-a-dotnet-bootstrapped-installer-using-nsis/nsis_11_2.jpg" style="max-height: 250px"/></a></div></div>

<p>After having downloaded the .NET Framework 2.0, it’ll start the .NET installer and run it through as usual, the installation will continue as soon as the .NET installer finishes. There is currently no check for whether the user cancels the .NET installation midways or if it fails. A simple check could be made right afterwards by simple calling the GetDotNETVersion function again like we did just before, if it fails, the user hasn’t installed .NET for some unknown reason and we’ll have to abort.</p>
<p>You can see <a href="http://www.improve.dk/downloads/InstallScript.txt" target="_blank">my complete install script here</a>. Download and rename to *.nsi to compile it.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Apr</span>
			<span class="day">14</span>
		</div>
		<div class="lower">2007</div>
	</div>

	<div class="title">
		<h1><a href="/cascading-windows/" title="Cascading Windows Using PInvoke" rel="bookmark">Cascading Windows Using PInvoke</a></h1>
		<div class="categories">
			
				<a href="http://improve.dk/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>In Photoshop we often work with multiple windows open. They can be cascaded to more easily be able to view the different windows and tell them apart. There’s an API function that does the same to any windows you specify, you can even define the rectangle where they should be cascaded within.</p>
<a id="more"></a>


<figure class="highlight csharp"><pre><span class="keyword">using</span> System;
<span class="keyword">using</span> System.Runtime.InteropServices;
<span class="keyword">using</span> System.Drawing;
<span class="keyword">using</span> System.Collections;

namespace Cascading_Windows
{
	class Program
	{
		<span class="comment">// The CascadeWindows function cascades the specified child windows of the specified parent window. It can be used to</span>
		<span class="comment">// cascade all windows (as in this example) or just the child windows of a specific window by passing in a handle to that</span>
		<span class="comment">// window. You can also define the rectangle wherein they should be cascaded.</span>
		<span class="comment">// See http://msdn.microsoft.com/library/default.asp?url=/library/en-us/winui/winui/windowsuserinterface/windowing/windows/windowreference/windowfunctions/animatewindow.asp</span>
		<span class="comment">// for full documentation.</span>
		[DllImport(<span class="string">"user32.dll"</span>)]
		<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">CascadeWindows</span>(<span class="keyword">int</span> hWnd, <span class="keyword">int</span> wHow, <span class="keyword">ref</span> Rectangle lpRect, <span class="keyword">int</span> cKids, <span class="keyword">ref</span> ArrayList lpKids);

		<span class="keyword">static</span> <span class="keyword">void</span> Main(<span class="keyword">string</span>[] args)
		{
			<span class="comment">// As the function expects references to both a Rectangle and an ArrayList, we'll have to hack a couple of null values</span>
			<span class="comment">// as we can't pass null into the function.</span>
			Rectangle nilRect = Rectangle.Empty;
			ArrayList nilList = <span class="keyword">null</span>;

			<span class="comment">// Cascade all windows that are children of the Desktop (handle = 0).</span>
			CascadeWindows(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">ref</span> nilRect, <span class="number">0</span>, <span class="keyword">ref</span> nilList);

			Console.Read();
		}
	}
}
</pre></figure>

<p>And the result:</p>
<p><em>Having three monitors generates quite a large screenshot so I’ll leave this one up for you to try / your imagination :)</em></p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Apr</span>
			<span class="day">13</span>
		</div>
		<div class="lower">2007</div>
	</div>

	<div class="title">
		<h1><a href="/animating-windows/" title="Animating Windows Using PInvoke" rel="bookmark">Animating Windows Using PInvoke</a></h1>
		<div class="categories">
			
				<a href="http://improve.dk/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Let’s be a bit more graphic. This time I’ll show you how to use the Windows API to make your forms fade in/out, slide in from the side or do various other animations. For this example we’ll have to use a Windows Forms project as we have to utilize a Form object in the example.</p>
<a id="more"></a>


<figure class="highlight csharp"><pre><span class="keyword">using</span> System;
<span class="keyword">using</span> System.Collections.Generic;
<span class="keyword">using</span> System.ComponentModel;
<span class="keyword">using</span> System.Data;
<span class="keyword">using</span> System.Drawing;
<span class="keyword">using</span> System.Text;
<span class="keyword">using</span> System.Windows.Forms;
<span class="keyword">using</span> System.Runtime.InteropServices;

namespace Animating_windows
{
	<span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> Form1 : Form
	{
		<span class="comment">// The possible AW flags for use with the AnimateWindow function.</span>
		<span class="keyword">public</span> <span class="keyword">enum</span> AW : <span class="keyword">int</span>
		{
			SLIDE = <span class="number">262144</span>,
			ACTIVATE = <span class="number">131072</span>,
			BLEND = <span class="number">524288</span>,
			HIDE = <span class="number">65536</span>,
			CENTER = <span class="number">16</span>,
			HOR_POSITIVE = <span class="number">1</span>,
			HOR_NEGATIVE = <span class="number">2</span>,
			VER_POSITIVE = <span class="number">4</span>,
			VER_NEGATIVE = <span class="number">8</span>
		}

		<span class="comment">// The AnimateWindow function enables you to produce special effects when showing or hiding windows. The hWnd parameter</span>
		<span class="comment">// is the handle to the window - note that this window HAS to be in the same thread as the thread calling the AnimateWindow</span>
		<span class="comment">// function - thus the windows project so we have a Form to experiment with. The time flag is the duration of the</span>
		<span class="comment">// animation, and finally the flags parameter sets the type of animation to perform.</span>
		<span class="comment">// See http://msdn.microsoft.com/library/default.asp?url=/library/en-us/winui/winui/windowsuserinterface/windowing/windows/windowreference/windowfunctions/animatewindow.asp</span>
		<span class="comment">// for full documentation.</span>
		[DllImport(<span class="string">"user32.dll"</span>)]
		<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">bool</span> <span class="title">AnimateWindow</span>(IntPtr hWnd, <span class="keyword">int</span> time, <span class="keyword">int</span> flags);

		<span class="keyword">public</span> <span class="title">Form1</span>()
		{
			InitializeComponent();
		}

		<span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Form1_Load</span>(<span class="keyword">object</span> sender, EventArgs e)
		{
			<span class="comment">// Fade in the form over a period of 3 seconds.</span>
			AnimateWindow(<span class="keyword">this</span>.Handle, <span class="number">3000</span>, (<span class="keyword">int</span>)AW.BLEND);

			<span class="comment">// Hide the form so we can perform the next animation.</span>
			<span class="keyword">this</span>.Hide();

			<span class="comment">// Make the window expand outward.</span>
			AnimateWindow(<span class="keyword">this</span>.Handle, <span class="number">3000</span>, (<span class="keyword">int</span>)AW.CENTER);

			<span class="comment">// And collapse inward...</span>
			AnimateWindow(<span class="keyword">this</span>.Handle, <span class="number">3000</span>, (<span class="keyword">int</span>)AW.CENTER | (<span class="keyword">int</span>)AW.HIDE);

			<span class="comment">// Let's slide in the form from the left side to the right.</span>
			AnimateWindow(<span class="keyword">this</span>.Handle, <span class="number">3000</span>, (<span class="keyword">int</span>)AW.SLIDE | (<span class="keyword">int</span>)AW.HOR_POSITIVE);
		}
	}
}
</pre></figure>

<p>And the result:</p>
<div class="imgwrapper" style=""><div><a href="/animating-windows/win32_12_1_2.jpg" class="fancy"><img src="/animating-windows/win32_12_1_2.jpg" style="max-height: 250px"/></a></div></div>

<div class="imgwrapper" style=""><div><a href="/animating-windows/win32_12_2_2.jpg" class="fancy"><img src="/animating-windows/win32_12_2_2.jpg" style="max-height: 250px"/></a></div></div>

<div class="imgwrapper" style=""><div><a href="/animating-windows/win32_12_3_2.jpg" class="fancy"><img src="/animating-windows/win32_12_3_2.jpg" style="max-height: 250px"/></a></div></div>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>


<div class="paging">
	<a href="/page/19/"><div class="past">« Past</div></a>
	<a href="/page/17/"><div class="future">Future »</div></a>
	<div class="clear"></div>
</div>

				</div>
			</div>

			<div id="asides">
				<div class="categories aside">
					<span class="sectiontitle">CATEGORIES</span>
					<ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/category/.NET/">.NET</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/AS/Flex/Flash/">AS/Flex/Flash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Amazon Web Services/">Amazon Web Services</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Computer Science/">Computer Science</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Conferences and Presenting/">Conferences and Presenting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/IIS/">IIS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Life/">Life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Miscellaneous/">Miscellaneous</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Performance/">Performance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Poker/">Poker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server/">SQL Server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Community/">SQL Server - Community</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Data Types/">SQL Server - Data Types</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Internals/">SQL Server - Internals</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Optimization/">SQL Server - Optimization</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Tricks/">SQL Server - Tricks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Testing/">Testing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Tools of the Trade/">Tools of the Trade</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Umbraco/">Umbraco</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Visual Studio/">Visual Studio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Web/">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windbg/">Windbg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windows/">Windows</a></li></ul>

					
				</div>

				<div class="archive aside">
					<span class="sectiontitle">ARCHIVE</span>
					<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archive/2014">2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2013">2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2012">2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2011">2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2010">2010</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2009">2009</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2008">2008</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2007">2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2006">2006</a></li></ul>
				</div>
			</div>

			<div class="clear"></div>
		</div>
		
		<footer>
			<div class="wrapper">Copyright &copy; 2014 Mark S. Rasmussen</div>
		</footer>

		<script type="text/javascript">
			$(function () {
				// Show mobile menu
				$("li.navicon").click(function () {
					if ($("header ul.mobile a").length == 0) {
						// Pages
						$mobilePages = $("div#naviconcontent ul.pages");
						$("header nav ul.normal > li").not(".navicon").each(function (i, el) {
							$mobilePages.append($(el).clone());
						});

						// Categories
						$mobileCategories = $("div#naviconcontent ul.categories");
						$("div#asides div.categories > ul > li").each(function (i, el) {
							$mobileCategories.append($(el).clone());
						});

						// Archive
						$mobileArchive = $("div#naviconcontent ul.archive");
						$("div#asides div.archive > ul > li").each(function (i, el) {
							$mobileArchive.append($(el).clone());
						});
					};

					$("header ul.mobile").toggle();
				});

				// Fancybox setup
				$("a.fancy").fancybox({
					hideOnContentClick: true,
					overlayShow: true
				});
			});
		</script>
	</body>
</html>