<!DOCTYPE html>
<html>
	

<head>
	<title>Mark S. Rasmussen</title>
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
	<meta charset="UTF-8" />
	<meta property="og:locale" content="en_US" />
	<meta property="og:type" content="website" />
	<meta name="google-site-verification" content="alt7-wfK3ZujMQ4D0jYNd0yC5LGetGdqBlBmZsqQlVw" />
	<meta content="article" property="og:type">
<meta content="Mark S. Rasmussen" property="og:title">
<meta content="http://improve.dk/page/4/" property="og:url">
<meta property="og:image">
<meta content="Mark S. Rasmussen" property="og:site_name">
<meta property="og:description">
<meta content="summary" name="twitter:card">
	<link rel="alternative" href="http://feeds.feedburner.com/Improvedk" title="Mark S. Rasmussen" type="application/atom+xml">
	<script src="/js/combined.js"></script>
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-2479580-1', 'improve.dk');
		ga('require', 'displayfeatures');
		ga('send', 	'pageview');
	</script>
	<link rel="stylesheet" href="/css/style.css" type="text/css" />
</head>
	<body>
		<div id="headerline"></div>
	
		<header>
			<div class="wrapper">
				<div id="title">
					<a href="/">Mark S. Rasmussen</a> <span>improve.dk</span>
				</div>
				
				<nav>
					<ul class="normal">
						<li class="navicon"></li>
						<li><a href="/about-me/">About Me</a></li>
					</ul>
				</nav>
				
				<ul id="sharing">
					<li><a href="mailto:mark@improve.dk" id="shareat"></a></li>
					<li><a href="http://feeds.feedburner.com/Improvedk" id="rssfeed"></a></li>
					<li><a href="https://twitter.com/improvedk" id="sharetwitter"></a></li>
					<li><a href="https://github.com/improvedk" id="sharegithub"></a></li>
					<li><a href="https://www.linkedin.com/in/markrasmussen/" id="sharelinkedin"></a></li>
				</ul>

				<div class="clear"></div>
				
				<div id="naviconcontent">
					<ul class="mobile">
						<li>
							Pages
							<ul class="pages"></ul>
						</li>
						<li>
							Categories
							<ul class="categories"></ul>
						</li>
						<li>
							Archive
							<ul class="archive"></ul>
						</li>
					</ul>
				</div>
			</div>
		</header>

		<div id="mainwrapper">
			<div id="contentwrapper">
				<div id="content">
				
					
	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jun</span>
			<span class="day">19</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/video-from-ndc-2012-revealing-the-sql-server-magic/" title="Video From NDC 2012: Revealing the SQL Server Magic" rel="bookmark">Video From NDC 2012: Revealing the SQL Server Magic</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				, 
			
				<a href="/category/SQL Server - Internals/">SQL Server - Internals</a>
				, 
			
				<a href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I’m really lagging behind on my blogging – life is busy as the moment! Just a couple of weeks ago I presented my Revealing the Magic session at the Norwegian Developers Conference in Oslo. I was quite excited to give my SQL Server oriented session to a crowd of developers – a 500 level session, at SQL Server events that is.</p>
<a id="more"></a>

<p>I just got the feedback today – 0 reds, 3 yellows and 15 greens – very happy with that, especially when taking the audience into account. To those of you who haven’t seen my session before, here it is:</p>
<iframe src="http://player.vimeo.com/video/43659054" height="281" width="500" allowfullscreen="allowfullscreen" frameborder="0"></iframe>

<p><a href="http://vimeo.com/43659054" target="_blank">Mark S. Rasmussen - Revealing the SQL Server Magic</a> from <a href="http://vimeo.com/ndcoslo" target="_blank">NDCOslo</a> on <a href="http://vimeo.com" target="_blank">Vimeo</a>.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Jun</span>
			<span class="day">01</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/2012-nt-konferenca-slides-demos/" title="2012 NT Konferenca Slides + Demos" rel="bookmark">2012 NT Konferenca Slides + Demos</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I presented two sessions at this years <a href="http://www.ntk.si/" target="_blank">NT Konferenca</a>. It was my first NTK, and what an NTK it was! I’m really hoping I’ll be back to present again – I’ve been to Slovenia many times before on non-technical visits, and now I’ve been able to confirm that they sure know how to run their conferences and cater for the attendees and speakers :)</p>
<a id="more"></a>

<p><a href="2012-05-24-NTK-Optimizing-Storage-and-Performance-Using-Page-and-Row-Compression-60-minutes.rar">Optimizing Storage and Performance Using Page and Row Compression.rar - Slides &amp; demos</a></p>
<p><a href="2012-05-24-NTK-Storing-Character-Data-Optimally-60-minutes.rar">Storing Character Data Optimally.rar - Slides &amp; demos</a></p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">May</span>
			<span class="day">14</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/in-the-nick-of-time-band-aid-solution-for-umbraco/" title="In the Nick of Time: Band Aid Solution for Umbraco 5.1 Performance" rel="bookmark">In the Nick of Time: Band Aid Solution for Umbraco 5.1 Performance</a></h1>
		<div class="categories">
			
				<a href="/category/Umbraco/">Umbraco</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>As I write this I’m finishing the last details on a new website project I’m working on for a client. A couple of months ago I made the easy decision of going with <a href="http://umbraco.org/" target="_blank">Umbraco</a> as the underlying CMS. I’ve had excellent experiences with Umbraco previously and the <a href="http://our.umbraco.org/" target="_blank">community</a> is amazing.</p>
<a id="more"></a>

<p>Umbraco was at a split road however, version 4.7 being a widely deployed and tested version, while the brand new 5.0 rewrite had just been released as a release candidate. It was made clear that 5.0 would not be upgradable from previous versions, so I could basically go with 4.7 and be stuck, or go with a release candidate version. To my luck, 5.0 was finally released as RTM before I had to make the decision, rendering my following decision easy – 5.0 was heralded as being production ready.</p>
<h2 id="Performance,_oh_my">Performance, oh my</h2>
<p>Fast forward a month or so, development well underway. It was clear that there were performance issues. The forums were full of <a href="http://our.umbraco.org/forum/core/umbraco-5-general-discussion/28565-Umbraco-5-Performance-issues" target="_blank">posts</a> asking how to get performance equivalent to what people were used to in 4.7. Unfortunately, there wasn’t really a solution yet. Thankfully 5.1 was released, promising better performance. After spending a couple of days fighting a <a href="http://our.umbraco.org/forum/core/umbraco-5-general-discussion/31197-Failing-to-upgrade-from-501-to-51RC" target="_blank">5.0 –&gt; 5.1 upgrade bug</a>, I finally got 5.1 running. Much to my dismay, performance was still dismal.</p>
<p>This is me requesting the front page of the website:</p>
<div class="imgwrapper" style=""><div><a href="/in-the-nick-of-time-band-aid-solution-for-umbraco/image_2.png" class="fancy"><img src="/in-the-nick-of-time-band-aid-solution-for-umbraco/image_2.png" style="max-height: 250px"/></a></div></div>

<p>1780 individual requests to the database, with several interesting queries like the following:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span> this_.Id <span class="keyword">as</span> Id16_7_, this_.DateCreated <span class="keyword">as</span> DateCrea2_16_7_, this_.DefaultName <span class="keyword">as</span> DefaultN3_16_7_,
this_.AttributeSchemaDefinition_id <span class="keyword">as</span> Attribut4_16_7_, this_.NodeId <span class="keyword">as</span> NodeId16_7_, attribalia1_.NodeVersionId
<span class="keyword">as</span> NodeVers3_9_, attribalia1_.Id <span class="keyword">as</span> Id9_, attribalia1_.Id <span class="keyword">as</span> Id5_0_, attribalia1_.AttributeDefinitionId <span class="keyword">as</span>
Attribut2_5_0_, attribalia1_.NodeVersionId <span class="keyword">as</span> NodeVers3_5_0_, attributed5_.AttributeId <span class="keyword">as</span> Attribut4_10_,
attributed5_.Id <span class="keyword">as</span> Id10_, attributed5_.Id <span class="keyword">as</span> Id1_1_, attributed5_.<span class="keyword">Value</span> <span class="keyword">as</span> Value1_1_, attributed5_.ValueKey
<span class="keyword">as</span> ValueKey1_1_, attributed5_.AttributeId <span class="keyword">as</span> Attribut4_1_1_, attributed5_.LocaleId <span class="keyword">as</span> LocaleId1_1_,
attributed6_.AttributeId <span class="keyword">as</span> Attribut4_11_, attributed6_.Id <span class="keyword">as</span> Id11_, attributed6_.Id <span class="keyword">as</span> Id0_2_, attributed6_.<span class="keyword">Value</span>
<span class="keyword">as</span> Value0_2_, attributed6_.ValueKey <span class="keyword">as</span> ValueKey0_2_, attributed6_.AttributeId <span class="keyword">as</span> Attribut4_0_2_, attributed6_.LocaleId
<span class="keyword">as</span> LocaleId0_2_, attributei4_.AttributeId <span class="keyword">as</span> Attribut4_12_, attributei4_.Id <span class="keyword">as</span> Id12_, attributei4_.Id <span class="keyword">as</span>
Id3_3_, attributei4_.<span class="keyword">Value</span> <span class="keyword">as</span> Value3_3_, attributei4_.ValueKey <span class="keyword">as</span> ValueKey3_3_, attributei4_.AttributeId
<span class="keyword">as</span> Attribut4_3_3_, attributei4_.LocaleId <span class="keyword">as</span> LocaleId3_3_, attributel3_.AttributeId <span class="keyword">as</span> Attribut4_13_,
attributel3_.Id <span class="keyword">as</span> Id13_, attributel3_.Id <span class="keyword">as</span> Id4_4_, attributel3_.<span class="keyword">Value</span> <span class="keyword">as</span> Value4_4_, attributel3_.ValueKey <span class="keyword">as</span>
ValueKey4_4_, attributel3_.AttributeId <span class="keyword">as</span> Attribut4_4_4_, attributel3_.LocaleId <span class="keyword">as</span> LocaleId4_4_,
attributes2_.AttributeId <span class="keyword">as</span> Attribut4_14_, attributes2_.Id <span class="keyword">as</span> Id14_, attributes2_.Id <span class="keyword">as</span> Id6_5_, attributes2_.<span class="keyword">Value</span>
<span class="keyword">as</span> Value6_5_, attributes2_.ValueKey <span class="keyword">as</span> ValueKey6_5_, attributes2_.AttributeId <span class="keyword">as</span> Attribut4_6_5_,
attributes2_.LocaleId <span class="keyword">as</span> LocaleId6_5_, node14_.Id <span class="keyword">as</span> Id9_6_, node14_.DateCreated <span class="keyword">as</span> DateCrea2_9_6_,
node14_.IsDisabled <span class="keyword">as</span> IsDisabled9_6_, node14_1_.Alias <span class="keyword">as</span> Alias10_6_, node14_1_.Description <span class="keyword">as</span> Descript3_10_6_,
node14_1_.Name <span class="keyword">as</span> Name10_6_, node14_1_.Ordinal <span class="keyword">as</span> Ordinal10_6_, node14_1_.AttributeSchemaDefinitionId <span class="keyword">as</span>
Attribut6_10_6_, node14_2_.Alias <span class="keyword">as</span> Alias11_6_, node14_2_.Description <span class="keyword">as</span> Descript3_11_6_, node14_2_.Name <span class="keyword">as</span>
Name11_6_, node14_2_.SchemaType <span class="keyword">as</span> SchemaType11_6_, node14_2_.XmlConfiguration <span class="keyword">as</span> XmlConfi6_11_6_, <span class="keyword">case</span> <span class="keyword">when</span>
node14_1_.NodeId <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">when</span> node14_2_.NodeId <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">then</span> <span class="number">2</span> <span class="keyword">when</span> node14_.Id <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">then</span>
<span class="number">0</span> <span class="keyword">end</span> <span class="keyword">as</span> clazz_6_ <span class="keyword">FROM</span> dbo.NodeVersion this_ <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> dbo.Attribute attribalia1_ <span class="keyword">on</span> this_.Id=attribalia1_.NodeVersionId
<span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> dbo.AttributeDecimalValue attributed5_ <span class="keyword">on</span> attribalia1_.Id=attributed5_.AttributeId <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span>
dbo.AttributeDateValue attributed6_ <span class="keyword">on</span> attribalia1_.Id=attributed6_.AttributeId <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> dbo.AttributeIntegerValue
attributei4_ <span class="keyword">on</span> attribalia1_.Id=attributei4_.AttributeId <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> dbo.AttributeLongStringValue attributel3_
<span class="keyword">on</span> attribalia1_.Id=attributel3_.AttributeId <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> dbo.AttributeStringValue attributes2_ <span class="keyword">on</span>
attribalia1_.Id=attributes2_.AttributeId <span class="keyword">inner</span> <span class="keyword">join</span> dbo.Node node14_ <span class="keyword">on</span> this_.NodeId=node14_.Id <span class="keyword">left</span> <span class="keyword">outer</span>
<span class="keyword">join</span> dbo.[AttributeDefinitionGroup] node14_1_ <span class="keyword">on</span> node14_.Id=node14_1_.NodeId <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> dbo.[AttributeSchemaDefinition]
node14_2_ <span class="keyword">on</span> node14_.Id=node14_2_.NodeId <span class="keyword">WHERE</span> this_.Id <span class="keyword">in</span> (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7, @p8,
@p9, @p10, @p11, @p12, @p13, @p14, @p15, @p16, @p17, @p18, @p19, @p20, @p21, @p22, @p23, @p24, @p25, @p26, @p27,
@p28, @p29, @p30, @p31, @p32, @p33, @p34, @p35, @p36, @p37, @p38, @p39, @p40, @p41, @p42, @p43, @p44, @p45, @p46,
@p47, @p48, @p49, @p50, @p51, @p52, @p53, @p54, @p55, @p56, @p57, @p58, @p59, @p60, @p61, @p62, @p63, @p64, @p65,
@p66, @p67, @p68, @p69, @p70, @p71, @p72, @p73, @p74, @p75, @p76, @p77, @p78, @p79, @p80, @p81, @p82, @p83, @p84,
@p85, @p86, @p87, @p88, @p89, @p90, @p91, @p92, @p93, @p94, @p95, @p96, @p97, @p98, @p99, @p100, @p101, @p102, @p103,
@p104, @p105, @p106, @p107, @p108, @p109, @p110, @p111, @p112, @p113, @p114, @p115, @p116, @p117, @p118, @p119, @p120,
@p121, @p122, @p123, @p124, @p125, @p126, @p127, @p128, @p129, @p130, @p131, @p132, @p133, @p134, @p135, @p136, @p137,
... &lt;snip: <span class="keyword">some</span> <span class="number">700</span> other parameters&gt; ...
@p882, @p883, @p884, @p885, @p886, @p887, @p888, @p889, @p890, @p891, @p892, @p893, @p894, @p895, @p896, @p897, @p898,
@p899, @p900, @p901, @p902, @p903, @p904, @p905, @p906, @p907, @p908, @p909, @p910, @p911, @p912, @p913, @p914, @p915,
@p916, @p917, @p918, @p919, @p920, @p921, @p922, @p923, @p924, @p925, @p926, @p927, @p928, @p929, @p930, @p931, @p932,
@p933, @p934, @p935, @p936, @p937, @p938, @p939, @p940, @p941, @p942, @p943, @p944, @p945, @p946, @p947, @p948, @p949,
@p950, @p951, @p952, @p953, @p954, @p955, @p956) <span class="keyword">and</span> this_.Id <span class="keyword">in</span> (<span class="keyword">SELECT</span> this_0_.Id <span class="keyword">as</span> y0_ <span class="keyword">FROM</span> dbo.NodeVersion this_0_ <span class="keyword">WHERE</span> this_0_.NodeId = @p957)</span>
</pre></figure>

<p>It’s clearly obvious we’re dealing with a serious N+1 problem, made worse by a lack of set based operations as evidenced by the above query. At the same time this query is a ticking time bomb – as soon as it hits the 2100 parameter limit, problems will arise unless they’re handled. The culprit seems to be the fact that the database is queried through a LINQ provider on top of Umbracos own Hive layer, on top of NHibernate. The core team themselves have voiced that NHibernate might be exacerbating the problem as they haven’t tamed the beast completely. I <a href="http://our.umbraco.org/forum/core/umbraco-5-general-discussion/28565-Umbraco-5-Performance-issues?p=14" target="_blank">voiced my own concerns and suggestions</a> on the architecture in the main performance thread. Currently the core team seems to be working on a band aid solution; adding a Lucene based cache to the site to improve performance. In my opinion the only way to really solve the issue is to fix the underlying problem – the N+1 one.</p>
<p>Back in January the Umbraco team posted the following: <a href="http://umbraco.com/follow-us/blog-archive/2012/1/4/umbraco-5-on-performance-and-the-perils-of-premature-optimisation.aspx" target="_blank">Umbraco 5: On performance and the perils of premature optimization</a>. While I completely agree with the sentiment, avoiding N+1 issues is not premature optimization, that’s a requirement before releasing an RTM product.</p>
<p>The Umbraco team does deserve big kudos on owning up to the problem. They’re painfully aware of the issues people are dealing with, being unable to deploy due to crippling performance. I’m sure they’ll be improving on performance, I just hope it happens sooner than later. I did talk to Niels Hartvig and offered my help (regarding the database layer), should they want it. I’ve also had Alex Norcliffe look at my logs over email – a big thanks goes to the team, helping out even though they’re in a pinch themselves.</p>
<h2 id="Band_aid_solutions_while_waiting_for_5-2">Band aid solutions while waiting for 5.2</h2>
<p>As I had to get the website up and running for a trade show, I had no choice but to spin up a High-CPU Extra Large Instance on Amazon EC2. While this costs a minor fortune (compared to what hosting the site should’ve required), it gave me a temporary solution for the trade show. Startup times were still terrible but at least requesting pages went reasonably fast, even though some pages did hang for 5+ seconds, depending on the content shown.</p>
<p>Once the trade show was over, I downgraded the EC2 instance to an m1.large instance. It’s still expensive, but it’s a tad cheaper for development. However, there’s a bigger problem looming on the horizon – the site has to go live in a week or two.</p>
<p>The Umbraco team have said they expect a 5.2 performance release sometime during June, and 5.x being on par with 4.7 by the end of 2012. Unfortunately I don’t have the luxury of waiting for that.</p>
<p>What I’ve now done, to prepare for the launch, was to increase the output cache timeout to 24 hours by modifying web.config like so:</p>
<figure class="highlight xml"><pre><span class="tag">&lt;<span class="title">caching</span>&gt;</span>
  <span class="tag">&lt;<span class="title">outputCacheSettings</span>&gt;</span>
    <span class="tag">&lt;<span class="title">outputCacheProfiles</span>&gt;</span>
      <span class="tag">&lt;<span class="title">add</span> <span class="attribute">name</span>=<span class="value">"umbraco-default"</span> <span class="attribute">duration</span>=<span class="value">"86400"</span> <span class="attribute">varyByParam</span>=<span class="value">"*"</span> <span class="attribute">location</span>=<span class="value">"ServerAndClient"</span>/&gt;</span>
    <span class="tag">&lt;/<span class="title">outputCacheProfiles</span>&gt;</span>
  <span class="tag">&lt;/<span class="title">outputCacheSettings</span>&gt;</span>
<span class="tag">&lt;/<span class="title">caching</span>&gt;</span>
</pre></figure>

<p>This essentially turns the website into a statically cached copy. Doing this results in each page being cached for 24 hours after it’s been visited last. While this is great, it still means those first visitors (for each page on the website) will be suffering from long waits. To fix that, I turn to <a href="http://home.snafu.de/tilman/xenulink.html" target="_blank">Xenu’s Link Sleuth</a>. Given the hostname, Xenu will crawl each page on the website, checking for broken links. As a side effect, every page on the site will be visited and thereby cached. By default, Xenu will use 30 concurrent threads to crawl the site. On my EC2 instance, that resulted in loads of timeouts as the instance simply couldn’t handle it:</p>
<div class="imgwrapper" style=""><div><a href="/in-the-nick-of-time-band-aid-solution-for-umbraco/image_10.png" class="fancy"><img src="/in-the-nick-of-time-band-aid-solution-for-umbraco/image_10.png" style="max-height: 250px"/></a></div></div>

<p>Pressing Ctrl+R forces Xenu to retry all the failed links, eventually resulting in all the links being visited successfully:</p>
<div class="imgwrapper" style=""><div><a href="/in-the-nick-of-time-band-aid-solution-for-umbraco/image_8.png" class="fancy"><img src="/in-the-nick-of-time-band-aid-solution-for-umbraco/image_8.png" style="max-height: 250px"/></a></div></div>

<p>(Sorry for distorting the images – the site isn’t supposed to go completely public yet). For Xenu to find all the links on the site, you’ll have to make sure you’re using &lt;a href /&gt; tags. I had to replace a couple of:</p>
<figure class="highlight html"><pre><span class="tag">&lt;<span class="title">div</span> <span class="attribute">onclick</span>=<span class="value">"window.open('http://xyz.com')"</span>&gt;</span>
</pre></figure>

<p>With corresponding &lt;a href /&gt; implementations, otherwise Xenu blissfully ignored them.</p>
<p>Obviously fixing the performance issue like this comes with a severe cost – memory usage on the server as well as being unable to update the site from the back office. For now I can live with that as the main priority is getting the site live. When I update I’ll have to manually cycle the app pool as well as rerunning Xenu. Currently the site takes up about 500 megs of memory fully cached, so I’ve got some room to spare.</p>
<p>Thankfully there are no protected parts of the site so user-specific caching is not an issue – <a href="http://en.wiktionary.org/wiki/YMMV" target="_blank">YMMV</a>.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">May</span>
			<span class="day">11</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/2012-community-amp-demo-day-materials/" title="2012 Community &amp; Demo Day Materials" rel="bookmark">2012 Community &amp; Demo Day Materials</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Yesterday I presented at <a href="http://communityday2012.c1preprod01.composite.net/Community-Day" target="_blank">Community Day</a>. As promised, you can download my slide deck here:</p>
<a id="more"></a>

<p><a href="2012-05-10-CommunityDay-Using-Amazon-S3-CloudFront-for-Scalable-and-Secure-Distribution.rar">CommunityDay-Using-Amazon-S3-CloudFront-for-Scalable-and-Secure-Distribution.rar - Slides</a></p>
<p>I also did a demo of OrcaMDF for the following Demo Day happening. You can find more on OrcaMDF here:</p>
<p><a href="https://github.com/improvedk/OrcaMDF" target="_blank">Git repository</a></p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Apr</span>
			<span class="day">23</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/materials-for-my-miracle-open-world-2012-presentation/" title="Materials For My Miracle Open World 2012 Presentation" rel="bookmark">Materials For My Miracle Open World 2012 Presentation</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Last Thursday I did a full-day presentation at Miracle Open World 2012 on the SQL Server storage engine and MDF file internals.</p>
<p>As mentioned in the session, I usually don’t post my precon slidedeck and materials publicly. If you attended the session, please send me an email at <a href="mailto:mark@improve.dk">mark@improve.dk</a> and I’ll send you the slides + demos for my session :)</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Apr</span>
			<span class="day">02</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/sqlbits-x-slides-demos/" title="SQLBits X Slides + Demos" rel="bookmark">SQLBits X Slides + Demos</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>As usual, I had a wonderful time at SQLBits X in London. Unfortunately I didn’t arrive until late Friday afternoon since I was flying in at the last minute from SQLConnections. I did however make it to the fabulous party and managed to get in bed early enough so I could be ready for my presentation on Saturday.</p>
<a id="more"></a>

<div class="imgwrapper" style=""><div><a href="/sqlbits-x-slides-demos/2012-03-31-12.00.43_2.jpg" class="fancy"><img src="/sqlbits-x-slides-demos/2012-03-31-12.00.43_2.jpg" style="max-height: 250px"/></a></div></div>

<p>As promised in my session, here are the downloadable slides and demos: [</a></p>
<p><a href="sqlbits_2012_04_01_revealing_the_magic.rar">sqlbits_2012_04_01_revealing_the_magic.rar - Slides &amp; demos</a></p>
<p>All of you who showed up, or wanted to showed up but couldn’t get in, thank you! Also, a big thanks goes out to the SQLBits crew – I can’t say how impressed I am by the tightness with which it’s run. Everything was timed to perfection, the hardware was running excellently and I didn’t see a room without a helper ready to jump in if anyone needed anything.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Mar</span>
			<span class="day">29</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/sqlconnections-slides-demos/" title="SQLConnections Slides + Demos" rel="bookmark">SQLConnections Slides + Demos</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I presented my “Optimizing Storage and Performance Using Page and Row Compression” presentation today here at SQLConnections. Overall I think it went alright, even though I had to speed up a bit at the end due to lack of time – I really hope I’ll be able to get a 75 minute slot next time :)</p>
<a id="more"></a>

<p>As promised, here are the materials from my session:<br><a href="SQLConnections_2012_03_29_SQL433.rar">SQLConnections_2012_03_29_SQL433.rar - Slides &amp; demos</a></p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Mar</span>
			<span class="day">27</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/speaking-at-ndc/" title="Speaking at NDC" rel="bookmark">Speaking at NDC</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Just before departing for SQLConnections in Vegas and SQLBits in London, I got notified that I’ve been selected for two presentations at the Norwegian Developers Conference in Oslo, June 6-8th!</p>
<div class="imgwrapper" style=""><div><a href="/speaking-at-ndc/download_2.jpg" class="fancy"><img src="/speaking-at-ndc/download_2.jpg" style="max-height: 250px"/></a></div></div>

<a id="more"></a>

<p>I’ve never been to NDC before but I’ve heard lots of good stuff, as well as seen various clips from the recorded videos. I’m especially excited to participate in a developer oriented conference, given that I’ve been focusing most of my time on SQL Server dedicated events over the last year. Lots of interesting new people and sessions to see!</p>
<p>As mentioned, I’ll be presenting two sessions:</p>
<h2 id="Revealing_the_SQL_Server_Magic">Revealing the SQL Server Magic</h2>
<p><em>Think SQL Server is magical? You’re right! However, there’s some sense to the magic, and that’s what I’ll show you in this extremely deep dive session.</em></p>
<p><em>Through my work in creating OrcaMDF, an open source parser for SQL Server databases, I’ve learned a lot of internal details for the SQL Server database file format. In this session, I will walk you through the internal storage format of MDF files, how we might go about parsing a complete database ourselves, using nothing but a hex editor.</em></p>
<p><em>I will cover how SQL Server stores its own internal metadata about objects, how it knows where to find your data on disk, and once it finds it, how to read it. Using the knowledge from this session, you’ll get a solid understanding of the basics behind SQL Server storage.</em></p>
<p>This is the same session that I’ll be presenting at SQLBits next Saturday. However, given the audience I will be modifying the session to focus more on the development side of things.</p>
<h2 id="Running_SQL_Server_on_Amazon_EC2">Running SQL Server on Amazon EC2</h2>
<p><em>SQL Azure is awesome, if you’re in the Microsoft cloud. But what are your options if you’re using the Amazon cloud?</em></p>
<p><em>I’ll introduce the available database options at Amazon and segue into setting up SQL Server on EC2 using EBS for storage. While EBS is great, it needs to be handled with care to ensure not only proper performance, but also to avoid the inevitable cloud instability and varying performance metrics.</em></p>
<p><em>How far can we push it, and what are the gotchas you need to be aware of?</em></p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Feb</span>
			<span class="day">29</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/why-use-big-endian-for-compressed-integers/" title="Why Use Big Endian For Compressed Integers?" rel="bookmark">Why Use Big Endian For Compressed Integers?</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - Internals/">SQL Server - Internals</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>While implementing compression support for <a href="https://github.com/improvedk/OrcaMDF" target="_blank">OrcaMDF</a>, it stumped me when I discovered that integers (including datetime, money and all other type based on integers) were <a href="/the-anatomy-of-row-amp-page-compressed-integers">stored in big endian</a>. As all other integers are stored in little endian and I couldn’t see why they’d want to change it, I assumed it must’ve been due to using different libraries or something to that extent.</p>
<a id="more"></a>

<p>However, at that time I was only implementing row compression, and thus I didn’t consider the implications endianness would have on page compression. You see, one of the techniques page compression uses to save space is column prefixing. When page compressing a page, SQL Server will look for any common column prefix values (at the byte level, page compression is data type agnostic). The best match for a column prefix will be stored as an overall prefix for the column and all other columns will base their value off of this, only storing the diff.</p>
<p>Let’s take a look at a sample identity column and it’s values, stored in little endian:</p>
<figure class="highlight"><pre><span class="setting">2312398493 = <span class="value"><span class="number">0</span>x9D66D489</span></span>
<span class="setting">2312398494 = <span class="value"><span class="number">0</span>x9E66D489</span></span>
<span class="setting">2312398495 = <span class="value"><span class="number">0</span>x9F66D489</span></span>
<span class="setting">2312398496 = <span class="value"><span class="number">0</span>xA066D489</span></span>
</pre></figure>

<p>In this case, the very first byte (the least significant in little endian) changes for each number and thus there’s no common prefix to use for page compression. If we instead store those same values in big endian, look what we get:</p>
<figure class="highlight"><pre>2312398493 = 0x*<span class="strong">*89D466*</span><span class="strong">*9D
2312398494 = 0x*</span><span class="strong">*89D466*</span><span class="strong">*9E
2312398495 = 0x*</span><span class="strong">*89D466*</span><span class="strong">*9F
2312398496 = 0x*</span><span class="strong">*89D466*</span><span class="strong">*A0</span>
</pre></figure>

<p>Notice how the bolded bytes are all the same now – only the last, and least significant, byte is changed when the number increments. As such, we can now store the values using just two bytes instead of four:</p>
<figure class="highlight"><pre><span class="attribute">Column prefix </span>=<span class="string"> 0x89D4669D</span>
</pre></figure>


<figure class="highlight"><pre><span class="setting">2312398493 =<span class="value"></span></span>
<span class="setting">2312398494 = <span class="value"><span class="number">0</span>x039E</span></span>
<span class="setting">2312398495 = <span class="value"><span class="number">0</span>x039F</span></span>
<span class="setting">2312398496 = <span class="value"><span class="number">0</span>x03A0</span></span>
</pre></figure>

<p>The first column actually takes up zero bytes, as it matches the stored column prefix exactly – a saving of four bytes! All the others store a single byte that identifies how many bytes to use from the stored column prefix (0x03), as well as the differential bytes coming afterwards.</p>
<p>Once you realize why we need to use big endian instead of little endian, it’s so obvious. Without the change of endianness, page compression would be way less effective.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Feb</span>
			<span class="day">20</span>
		</div>
		<div class="lower">2012</div>
	</div>

	<div class="title">
		<h1><a href="/stop-worrying-about-exhausting-bigints/" title="Stop Worrying About Exhausting Bigints" rel="bookmark">Stop Worrying About Exhausting Bigints</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server/">SQL Server</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I’ve done it myself, worried about what to do when I exhausted my bigint identity value. I was worried that part of the LSN being a bigint – what would happen when it ran out? Would it perform an integer overflow? The answer? Worrying about exhausting the range of a bigint is not something you should spend time on. Allow me to elaborate.</p>
<a id="more"></a>

<h2 id="The_log_table">The log table</h2>
<p>Imagine you have a table to which you only add new rows. You never delete rows and thus you can’t reuse previous identity values. Instead of looking at how many rows you can have (9,223,372,036,854,775,807; or 18,446,744,073,709,551,616 if you use the maximum negative value as the seed), let’s take a look at the storage requirements, if you were to actually exhaust the range.</p>
<p>Imagine that each row stores nothing but the bigint – no data at all, only the bigint identity value. The fixed row size can easily be calculated as such: two bytes for the status bits, two bytes for the null bitmap pointer, eight bytes for the bigint value, two bytes for the null bitmap column count and finally a single byte for the null bitmap itself. In total – 15 bytes. On top of that we need to add two bytes for an entry into the record offset array.</p>
<p>On an 8KB page, the header takes up 96 bytes, leaving 8096 bytes for the body, including the record offset array. Weighing in at 17 bytes per record, we can store a total of 476 records per page.</p>
<p>If we theoretically were to max out the positive bigint range, storing all records on disk; storing <em>just the bigint identity column</em> would take up a whopping 9,223,372,036,854,775,807 / 476 * 8KB = 140,985 PB. And this is with a seed value of 1 – you can double that amount if you were to start at the negative max. Seeing as the SQL Server database size limit is 524TB – you should probably worry about that sometime before worrying about running out of bigint seed values.</p>
<h2 id="The_high_transaction/sec_table">The high transaction/sec table</h2>
<p>OK, ok, you don’t store all of the rows, you delete them shortly after they’ve entered the system. Let’s say you never have more than 1000 rows in the table at a time, thus avoiding the storage issue.</p>
<p>If you allocate 1,000,000 new rows every second (deleting the other 999,000 of them), how long would you last?</p>
<p>9,223,372,036,854,775,807 / 1,000,000 / 60 / 60 / 24 / 365 = 292,471 years. Even for atheists, that’s a long time.</p>
<p>OK, ok, that’s not enough. What if you allocated 100,000,000 new rows every second instead?</p>
<p>9,223,372,036,854,775,807 / 100,000,000 / 60 / 60 / 24 / 365 = 2,924 years.</p>
<p>So at 100 million new bigint seed allocations per second, you’d still last almost 3,000 years before running out. And you can double that to 6,000 years if you start from the negative max seed value.</p>
<p>If you do manage to setup a SQL Server system with this kind of tx/sec – I’d love to see it!</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>


<div class="paging">
	<a href="/page/5/"><div class="past">« Past</div></a>
	<a href="/page/3/"><div class="future">Future »</div></a>
	<div class="clear"></div>
</div>

				</div>
			</div>

			<div id="asides">
				<div class="categories aside">
					<span class="sectiontitle">CATEGORIES</span>
					<ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/category/.NET/">.NET</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/AS/Flex/Flash/">AS/Flex/Flash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Amazon Web Services/">Amazon Web Services</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Computer Science/">Computer Science</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Conferences and Presenting/">Conferences and Presenting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/IIS/">IIS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Life/">Life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Misc/">Misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Miscellaneous/">Miscellaneous</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Performance/">Performance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Poker/">Poker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server/">SQL Server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Community/">SQL Server - Community</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Data Types/">SQL Server - Data Types</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Internals/">SQL Server - Internals</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Optimization/">SQL Server - Optimization</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Tricks/">SQL Server - Tricks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Testing/">Testing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Tools of the Trade/">Tools of the Trade</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Umbraco/">Umbraco</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Visual Studio/">Visual Studio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Web/">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windbg/">Windbg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windows/">Windows</a></li></ul>

					
				</div>

				<div class="archive aside">
					<span class="sectiontitle">ARCHIVE</span>
					<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archive/2014">2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2013">2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2012">2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2011">2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2010">2010</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2009">2009</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2008">2008</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2007">2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2006">2006</a></li></ul>
				</div>
			</div>

			<div class="clear"></div>
		</div>
		
		<footer>
			<div class="wrapper">Copyright &copy; 2014 Mark S. Rasmussen</div>
		</footer>

		<script type="text/javascript">
			$(function () {
				// Show mobile menu
				$("li.navicon").click(function () {
					if ($("header ul.mobile a").length == 0) {
						// Pages
						$mobilePages = $("div#naviconcontent ul.pages");
						$("header nav ul.normal > li").not(".navicon").each(function (i, el) {
							$mobilePages.append($(el).clone());
						});

						// Categories
						$mobileCategories = $("div#naviconcontent ul.categories");
						$("div#asides div.categories > ul > li").each(function (i, el) {
							$mobileCategories.append($(el).clone());
						});

						// Archive
						$mobileArchive = $("div#naviconcontent ul.archive");
						$("div#asides div.archive > ul > li").each(function (i, el) {
							$mobileArchive.append($(el).clone());
						});
					};

					$("header ul.mobile").toggle();
				});

				// Fancybox setup
				$("a.fancy").fancybox({
					hideOnContentClick: true,
					overlayShow: true
				});
			});
		</script>
	</body>
</html>