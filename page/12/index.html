<!DOCTYPE html>
<html>
	

<head>
	<title>Mark S. Rasmussen</title>
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
	<meta charset="UTF-8" />
	<meta property="og:locale" content="en_US" />
	<meta property="og:type" content="website" />
	<meta name="google-site-verification" content="alt7-wfK3ZujMQ4D0jYNd0yC5LGetGdqBlBmZsqQlVw" />
	<link rel="alternative" href="http://feeds.feedburner.com/Improvedk" title="Mark S. Rasmussen" type="application/atom+xml">
	<script src="/js/combined.js"></script>
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-2479580-1', 'improve.dk');
		ga('require', 'displayfeatures');
		ga('send', 	'pageview');
	</script>
	<link rel="stylesheet" href="/css/style.css" type="text/css" />
	<link rel="stylesheet" href="/css/print.css" type="text/css" media="print" />
</head>
	<body>
		<div id="headerline"></div>
	
		<header>
			<div class="wrapper">
				<div id="title">
					<a href="/">Mark S. Rasmussen</a> <span>improve.dk</span>
				</div>
				
				<nav>
					<ul class="normal">
						<li class="navicon"></li>
						<li><a href="/about-me/">About Me</a></li>
					</ul>
				</nav>
				
				<ul id="sharing">
					<li><a href="mailto:mark@improve.dk" id="shareat"></a></li>
					<li><a href="http://feeds.feedburner.com/Improvedk" id="rssfeed"></a></li>
					<li><a href="https://twitter.com/improvedk" id="sharetwitter"></a></li>
					<li><a href="https://github.com/improvedk" id="sharegithub"></a></li>
					<li><a href="https://www.linkedin.com/in/markrasmussen/" id="sharelinkedin"></a></li>
				</ul>

				<div class="clear"></div>
				
				<div id="naviconcontent">
					<ul class="mobile">
						<li>
							Pages
							<ul class="pages"></ul>
						</li>
						<li>
							Categories
							<ul class="categories"></ul>
						</li>
						<li>
							Archive
							<ul class="archive"></ul>
						</li>
					</ul>
				</div>
			</div>
		</header>

		<div id="mainwrapper">
			<div id="contentwrapper">
				<div id="content">
				
					
	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Mar</span>
			<span class="day">17</span>
		</div>
		<div class="lower">2010</div>
	</div>

	<div class="title">
		<h1><a href="/speaking-at-miracle-openworld-2010/" title="Speaking at Miracle OpenWorld 2010" rel="bookmark">Speaking at Miracle OpenWorld 2010</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>I will be giving two presentations at <a href="http://mow2010.dk/" target="_blank">Miracle OpenWorld 2010</a> in April.</p>
<a id="more"></a>

<h2 id="Working_with_PDF_documents">Working with PDF documents</h2>
<p>In this session he will sharing his experiences with dissecting PDF documents for the iPaper system. We’ll look at various commercial as well as open source tools for reading, editing and rasterizing PDF documents. What are some of the common pitfalls you’ll run into when working with PDF documents and what does a PDF really consist of internally? While some of the tools and libraries can also be used to create PDFs, this session will concentrate on working with existing PDF files.</p>
<h2 id="SQL_Azure_for_DBA’s">SQL Azure for DBA’s</h2>
<p>Will be presenting together with Martin Schmidt from Miracle. Abstract is still in the works. It’s safe to say though that this will be no typical sales pitch - we’ll be looking at what limitations you’ll run into, what happens when you reach the limits of SQL Azure and generally what the sales pitch happily ignores.</p>
<p>I highly recommend going to MOW as this is one of the best DBA &amp; developer conferences with networking and fun being in the high seat! There’s a beach party - what more do you need?</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Feb</span>
			<span class="day">19</span>
		</div>
		<div class="lower">2010</div>
	</div>

	<div class="title">
		<h1><a href="/speaking-at-onug/" title="Speaking at Odense .NET User Group" rel="bookmark">Speaking at Odense .NET User Group</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>On March 10th I’ll be giving a presentation at <a href="http://www.onug.dk/" target="_blank">Odense .NET User Group</a> on Scalability &amp; Availability on the Microsoft platform.</p>
<a id="more"></a>

<p>As the session will be in Danish, I’ll be posting a danish abstract:</p>
<p>I denne session kommer vi ind på hvordan man sørger for høj tilgængelighed og skalerbarhed af ASP.NET web applikationer ved brug af flere maskiner opsat som cluster. Hvordan sørger vi for konsistent deling af sessions på tværs af maskiner indenfor et cluster? NLB vil blive demonstreret som clustering teknologi med dets styrker og svagheder. Ligeledes vil den nye IIS7 Application Request Routing extension blive demonstreret og hvordan den kan bruges i samspil med NLB.</p>
<p>If you want to join, please <a href="http://www.linkedin.com/osview/canvas?_ch_page_id=1&amp;_ch_panel_id=1&amp;_ch_app_id=7083120&amp;_applicationId=2000&amp;_ownerId=0&amp;appParams={%22go_to%22:%22events/233429%22,%22referrer%22:%22public%22}" target="_blank">sign up at LinkedIn</a>.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Dec</span>
			<span class="day">16</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/techtalk-on-scalability-and-availability-using-nlb-and-iis-arr/" title="TechTalk on Scalability &amp; Availability Using NLB and IIS ARR" rel="bookmark">TechTalk on Scalability &amp; Availability Using NLB and IIS ARR</a></h1>
		<div class="categories">
			
				<a href="/category/Conferences and Presenting/">Conferences and Presenting</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>As promised during my TechTalk today at Microsoft Denmark, here are the links to all slides and demo code. Unfortunately you’ll not be able to download the VPC’s as those total around 30GB.</p>
<a id="more"></a>

<p>Download <a href="Speech_NLB_MSDK_TechTalk.rar">Speech_NLB_MSDK_TechTalk.zip</a> - Slides &amp; code</p>
<p>I sincerely hope you enjoyed the presentation as much as I did. Either way, I’d appreciate your comments on <a href="http://speakerrate.com/talks/1900-using-network-load-balancing-for-availability-scalability-microsoft-dk-techtalk" target="_blank">SpeakerRate</a> - Thanks :)</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Dec</span>
			<span class="day">09</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/fixing-flash-bugs-by-intercepting-iis-application-request-routing-cookies/" title="Fixing Flash Bugs and Intercepting IIS Application Request Routing Cookies" rel="bookmark">Fixing Flash Bugs and Intercepting IIS Application Request Routing Cookies</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				, 
			
				<a href="/category/AS/Flex/Flash/">AS/Flex/Flash</a>
				, 
			
				<a href="/category/IIS/">IIS</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>What does Flash, upload, cookies, IIS load balancing and cookies have to do with each others? More than I’d like :(</p>
<a id="more"></a>

<p>When users need to upload files I often use the Flash based <a href="http://swfupload.org/" target="_blank">SWFUpload</a> component. It allows for multiple file selection and progress display during upload. Handling the uploaded files on the .NET side is rather easy:</p>
<figure class="highlight csharp"><pre><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; Request.Files.Count; i++)
{
    HttpPostedFile hpf = Request.Files[i];

    // <span class="keyword">...</span> Save / process the HttpPostedFile
}
</pre></figure>

<p>One of the arguments for using Flash for web designs is that it’ll look the same in all browsers. While that is literally true, there are a number of functionality differences when it comes to Flash and cross browser support.</p>
<p>There’s a bug in all current Flash players that causes the Flash player to send persistent cookies from Internet Explorer, no matter what browser you’re currently using. That is, if you’ve visited a given website in IE previously and you’re nor visiting it in Chrome/Firefox - yup, your IE cookies will be sent to the website instead of the Firefox/Chrome cookies! There’s a good <a href="http://swfupload.org/forum/generaldiscussion/383" target="_blank">description and discussion</a> at the SWFUpload site.</p>
<p>This bug poses a number of problems if you’re using SWFUpload on a password protected site that relies on <a href="http://support.microsoft.com/kb/910443" target="_blank">cookie based forms authentication</a>. Whenever the file is uploaded, the users will appear to not be logged in. This is because the forms authentication ticket is stored in a cookie (which is correctly stored by Firefox/Chrome), but whenever the request is made IE’s cookies are sent and those do not contain a valid forms authentication ticket cookie.</p>
<p>Luckily there’s a workaround for this. Basically we’ll need to tell our upload SWF the current SessionID as well as the contents of the forms authentication ticket cookie:</p>
<figure class="highlight csharp"><pre>var flashVars = {
    ASPSESSID: "<span class="vbscript">&lt;%= Session.SessionID %&gt;</span>",
    AUTHID: "<span class="vbscript">&lt;%= <span class="built_in">Request</span>.Cookies[FormsAuthentication.FormsCookieName] == <span class="literal">null</span> ? <span class="string">""</span> : <span class="built_in">Request</span>.Cookies[FormsAuthentication.FormsCookieName].Value %&gt;</span>"
}
</pre></figure>

<p>Now we need to modify our SWFUpload code so it sends the SessionID and ticket values in the query string to the upload file, so instead of calling:</p>
<figure class="highlight csharp"><pre>UploadFile_Upload<span class="preprocessor">.aspx</span>
</pre></figure>

<p>We’ll call:</p>
<figure class="highlight csharp"><pre><span class="attribute">UploadFile_Upload.aspx?ASPSESSID</span>=<span class="string">e2u35jfs0pvevfugkfnmm045&AUTHID=E7BA5BDD2D6E9FBBC7CF613352EF10E01E0E8B0AD9920F62A465BC0CA20FB9CC2BA67F95D5A82F5D30B3162D6DFB3EA7FD505456E5EA5407094D03C1D48E6EE0B80F85F1B6AFD5F52FDC14C2ED6D77A8</span>
</pre></figure>

<p>Now that we have the SessionID and ticket value we can manually restore those cookies in Global.asax (or an HttpModule, doesn’t matter). We’ll be doing the fix in Application_BeginRequest as this allows us to fix the cookies before ASP.NET will perform its validation and thereby notice the missing session and forms authentication cookies.</p>
<figure class="highlight csharp"><pre><span class="keyword">public</span> <span class="keyword">class</span> Global : HttpApplication
{
    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Application_BeginRequest</span>(<span class="keyword">object</span> sender, EventArgs e)
    {
        fixCookie(<span class="string">"ASP.NET_SessionId"</span>, <span class="string">"ASPSESSID"</span>);
        fixCookie(FormsAuthentication.FormsCookieName, <span class="string">"AUTHID"</span>);
    }

    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fixCookie</span>(<span class="keyword">string</span> cookieName, <span class="keyword">string</span> queryStringKey)
    {
        <span class="comment">// Did we get a querystring value to override the cookie value?</span>
        <span class="keyword">if</span> (HttpContext.Current.Request.QueryString[queryStringKey] != <span class="keyword">null</span>)
        {
            <span class="comment">// Try to get the current cookie value</span>
            HttpCookie cookie = HttpContext.Current.Request.Cookies.Get(cookieName);

            <span class="keyword">if</span> (cookie == <span class="keyword">null</span>)
            {
                <span class="comment">/* If there's no cookie, add a new one and add it to the Response.Cookies collection.
                   Note that it HAS to be put in the Response.Cookies collection even though Request.Cookies
                   makes more sense.
                */</span> 
                cookie = <span class="keyword">new</span> HttpCookie(cookieName, HttpContext.Current.Request.QueryString[queryStringKey]);
                Response.Cookies.Add(cookie);
            }
            <span class="keyword">else</span>
            {
                <span class="comment">/* If there's already a cookie (one from IE perhaps), overwrite its value with the querystring
                   provided value.
                */</span>
                cookie.Value = HttpContext.Current.Request.QueryString[queryStringKey];
                HttpContext.Current.Request.Cookies.Set(cookie);
            }
        }
    }
}
</pre></figure>

<p>Note that there is a security implication in doing this as it allows for session hijacking if you’re able to fake another users SessionID and forms authentication ticket! Thus, make sure you handle this or at least know the risks in not doing so.</p>
<p>OK, so that fixes the SWFUpload issue. This ran perfectly for some time. However, once i placed an <a href="http://forums.iis.net/1154.aspx" target="_blank">IIS7 Application Request Routing based load balancer</a> in front of the machine serving the upload applications, the issue from before reappeared, even though my original cookie handling code was still in place.</p>
<p>The reason for the resurrection of the cookie bug was to be found in the way ARR maintains client affinity:</p>
<div class="imgwrapper" style=""><div><a href="/fixing-flash-bugs-by-intercepting-iis-application-request-routing-cookies/arrswfupload_1_2.jpg" class="fancy"><img src="/fixing-flash-bugs-by-intercepting-iis-application-request-routing-cookies/arrswfupload_1_2.jpg" style="max-height: 250px"/></a></div></div>

<p>IIS ARR will set a cookie on the client that basically contains a hash of the content server to which the client is bound. This is a very simple and neat client affinity solution as there’s no shared state on the IIS ARR machine itself. Thus, it’s easy to combine a number of IIS ARR servers using NLB and let IIS ARR handle client affinity and thus simplify the NLB setup.</p>
<p>However, since the client affinity is handled by a cookie - that cookie was now suffering from the same bug as before. Basicaly the IIS ARR load balancer thought it received a completely new client request and thus assigned the request to a random content server, giving a 1/[num_machines] chance of succeeding in case it randomly hit the correct content server.</p>
<p>The solution is similar, though there is one major difference. The previous problem occurred on the actual content machines because those were missing a cookie value, in this case it’s the load balancer itself. Thus, deploying a fix on the content servers won’t do any good.</p>
<p>We’ll create a new HttpModule that performs the fix in Application_BeginRequest - which occurs before IIS ARR assigns the request to a content server. To ensure this fix does not in any way affect normal requests in case something goes wrong, exceptions are being silently ignored. This is generally a bad practice, but in this case I really do not want to affect the load balancer as that’ll put down the website for all users if an error occurs. Note that while the handling is very similar to the previous bit of code, this time we’re modifying the actual Cookie header directly. If we don’t do this, IIS ARR won’t pick up the overwritten cookie values and thus still send the user to a random content server.</p>
<figure class="highlight csharp"><pre><span class="keyword">using</span> System;
<span class="keyword">using</span> System.Text.RegularExpressions;
<span class="keyword">using</span> System.Web;

namespace iPaper.Web.ArrCookieRestorer
{
    <span class="keyword">public</span> <span class="keyword">class</span> ArrCookieRestorer : IHttpModule
    {
        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>()
        { }

        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Init</span>(HttpApplication context)
        {
            context.BeginRequest += context_BeginRequest;
        }

        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title">context_BeginRequest</span>(<span class="keyword">object</span> sender, EventArgs e)
        {
            <span class="keyword">try</span>
            {
                HttpContext context = HttpContext.Current;
                <span class="keyword">string</span> serverHash = context.Request.QueryString[<span class="string">"ARRIPARRAffinity"</span>];

                <span class="keyword">if</span> (serverHash != <span class="keyword">null</span>)
                {
                    <span class="keyword">string</span> cookieHeader = context.Request.Headers[<span class="string">"Cookie"</span>];

                    <span class="keyword">if</span> (cookieHeader != <span class="keyword">null</span>)
                    {
                        <span class="keyword">if</span> (cookieHeader.Contains(<span class="string">"IPARRAffinity="</span>))
                            cookieHeader = Regex.Replace(cookieHeader, <span class="string">"IPARRAffinity=[0-9a-f]+;?"</span>, <span class="string">"IPARRAffinity="</span> + serverHash + <span class="string">";"</span>);
                        <span class="keyword">else</span>
                            cookieHeader += <span class="string">"; IPARRAffinity="</span> + serverHash;

                        context.Request.Headers[<span class="string">"Cookie"</span>] = cookieHeader;
                    }
                    <span class="keyword">else</span>
                        context.Request.Headers.Add(<span class="string">"Cookie"</span>, <span class="string">"IPARRAffinity="</span> + serverHash);
                }
            }
            <span class="keyword">catch</span>
            {}
        }
    }
}
</pre></figure>

<p>Once you’ve compiled the HttpModule we need to install it on the IIS ARR machine. On a default installation of IIS ARR you’ll have your rewrite rules as global rules at the IIS-level. However, if you install the HttpModule at the IIS level you’ll get the following exception on all requests:</p>
<blockquote>
<p>The virtual path ‘null’ maps to another application, which is not allowed root</p>
</blockquote>
<p>Apparently <a href="http://forums.iis.net/t/1162754.aspx" target="_blank">it’s a bug</a> in IIS 7.0 on Windows Server 2008 which has been fixed in IIS 7.5 on Windows Server 2008 R2. As I’m still running a vanilla 2008 and IIS 7.0, I had to get around it by moving the rewrite rules into the default website - which code runs for all requests.</p>
<p>Make sure there’s a bin folder in the default website root and place your HttpModule in there. Then setup your web.config like so:</p>
<figure class="highlight xml"><pre><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
</pre></figure>

<p>This adds our HttpModule so it’ll run for all requests - fixing any missing ARR client affinity cookies. Note that your rewrite rules will likely differ from mine.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Nov</span>
			<span class="day">11</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/reading-width-height-of-flash-file/" title="Reading Width &amp; Height of Flash File" rel="bookmark">Reading Width &amp; Height of Flash File</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				, 
			
				<a href="/category/AS/Flex/Flash/">AS/Flex/Flash</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>Obtaining the movie height &amp; weidth of a Flash file is an easy task using the <a href="http://www.swftools.org/swfdump.html" target="_blank">swfdump</a> tool that comes as part of the <a href="http://www.swftools.org/" target="_blank">swftools</a> package. Here’s an example of how to invoke swfdump from C# and read out the height &amp; width of a given Flash file.</p>
<a id="more"></a>

<p>Start out by downloading on of the <a href="http://www.swftools.org/download.html" target="_blank">swftools releases</a>. I’m using the latest development snapshot. I’ll be using one of the Flash files I made in <a href="http://www.improve.dk/blog/2008/06/11/as3-numbers-get-real" target="_blank">a previous blog post</a> as a test file, but you can use any .swf file you want. The test Flash file is called <em>test.swf</em>.</p>
<p>Once you’ve extracted the swftools package and copied both the test file and the swfdump.exe file into your solution directory, we can now test it out manually:</p>
<figure class="highlight"><pre>D:<span class="subst">\</span>Webmentor Projekter<span class="subst">\</span>Blog<span class="subst">\</span>RetrievingSwfProperties<span class="subst">&gt;</span>swfdump <span class="attribute">-X</span> <span class="attribute">-Y</span> test<span class="built_in">.</span>swf
<span class="attribute">-X</span> <span class="number">500</span> <span class="attribute">-Y</span> <span class="number">375</span>
</pre></figure>

<p>By providing the -X and -Y switches swfdump only prints out the movie height &amp; width. You can see all the switches on the <a href="http://www.swftools.org/swfdump.html" target="_blank">swfdump man page</a>. At this point it’s a simple matter of spinning up a swfdump process and parsing the output:</p>
<figure class="highlight csharp"><pre><span class="keyword">static</span> <span class="keyword">void</span> Main(<span class="keyword">string</span>[] args)
{
    <span class="comment">// Set process properties</span>
    Process p = <span class="keyword">new</span> Process();
    p.StartInfo = <span class="keyword">new</span> ProcessStartInfo(<span class="string">"swfdump.exe"</span>, <span class="string">"-X -Y test.swf"</span>);
    p.StartInfo.CreateNoWindow = <span class="keyword">true</span>;
    p.StartInfo.RedirectStandardOutput = <span class="keyword">true</span>;
    p.StartInfo.UseShellExecute = <span class="keyword">false</span>;
    p.Start();

    <span class="comment">// Read all output, waiting for process to end</span>
    <span class="keyword">string</span> output = p.StandardOutput.ReadToEnd();

    <span class="comment">// Regex that'll match both the width and height output - has to take care of potential decimals</span>
    Match m = Regex.Match(output, <span class="string">@"-X (?d+(.d+)?) -Y (?d+(.d+)?)"</span>);

    <span class="comment">// Convert width & height to doubles forcing en-US culture</span>
    <span class="keyword">double</span> width = Convert.ToDouble(m.Groups[<span class="string">"width"</span>].Value, <span class="keyword">new</span> CultureInfo(<span class="string">"en-US"</span>));
    <span class="keyword">double</span> height = Convert.ToDouble(m.Groups[<span class="string">"height"</span>].Value, <span class="keyword">new</span> CultureInfo(<span class="string">"en-US"</span>));

    Console.WriteLine(<span class="string">"Width: "</span> + width);
    Console.WriteLine(<span class="string">"Height: "</span> + height);
    Console.Read();
}
</pre></figure>

<p>Result:</p>
<blockquote>
<p>Width: 500<br>Height: 375</p>
</blockquote>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Nov</span>
			<span class="day">05</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/defending-against-the-improbable/" title="Defending Against the Improbable" rel="bookmark">Defending Against the Improbable</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>As little children we’ve all been taught that it’s better to program defensively than relying on exceptions being thrown. However, sometimes it’s preferably to just hope for the best and catch exceptions if they happen.</p>
<a id="more"></a>

<h2 id="Defending_against_the_improbable">Defending against the improbable</h2>
<p>Say we have a web application that receives and ID through the query string and serves a file accordingly, usually we’d write that like:</p>
<figure class="highlight csharp"><pre><span class="function">if(File.<span class="function">Exists(path)</span>)</span>
    <span class="function">serveFile(path)</span>;
else
    <span class="function">serve404()</span>;
</pre></figure>

<p>This is what I’ve been doing in a large image serving website I run. However, it recently struck me that on average about 99.9% of all requests map to existing files, only those few .01% of all requests actually resulted in 404 errors being thrown.</p>
<p>Given the above ratio, if we dropped the File.Exists() check, out of 10,000 requests only 10 of those would result in a FileNotFoundException being thrown while the rest would just be served as usual. That means in 99.9% of all requests we waste resources on performing a trivial File.Exists() request that we know will most likely come back true anyways. What’s worse is that this will hit the harddrive and actually cost us an IO operation!</p>
<h2 id="A_local_test">A local test</h2>
<p>Observe the following two methods. serveFileUnsafely will serve a file under the assumption that it probably exists and will rely on a FileNotFoundException being throw if it doesn’t exist. serveFileSafely will ensure the file exists before actually serving it (trusting nothing happens between File.Exists() and File.ReadAllText()).</p>
<figure class="highlight csharp"><pre><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serveFileUnsafely</span>(<span class="keyword">string</span> path)
{
    <span class="keyword">try</span>
    {
        File.ReadAllText(path);
    }
    <span class="keyword">catch</span> (FileNotFoundException)
    {
        Console.WriteLine(<span class="string">"File does not exist!"</span>);
    }
}

<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serveFileSafely</span>(<span class="keyword">string</span> path)
{
    <span class="keyword">if</span> (File.Exists(path))
        File.ReadAllText(path);
    <span class="keyword">else</span>

        Console.WriteLine(<span class="string">"File does not exist!"</span>);
}
</pre></figure>

<p>The following two methods will be used to measure the time taken to serve 100 requests. I have created 100 identical files named [1-100].txt, each containing just the text “Hello world!”. I have then deleted a random file so there’s only 99 left. Thus in this example we assume that only 99% of all requests map to existing files even though the actual app has a success rate in excess of 99.9%. Note that the two methods each hit a separate folder - Test and Test2. This is to avoid any advantage of prewarming the cache before running the second test.</p>
<figure class="highlight csharp"><pre><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testLocalUnsafely</span>()
{
    <span class="keyword">for</span> (<span class="keyword">int</span> file = <span class="number">1</span>; file &lt;= <span class="number">100</span>; file++)
        serveFileUnsafely(<span class="string">@"E:\Test"</span> + file + <span class="string">".txt"</span>);
}

<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testLocalSafely</span>()
{
    <span class="keyword">for</span> (<span class="keyword">int</span> file = <span class="number">1</span>; file &lt;= <span class="number">100</span>; file++)
        serveFileSafely(<span class="string">@"E:\Test2"</span> + file + <span class="string">".txt"</span>);
}
</pre></figure>

<p>The actual profiling goes like this. I’ll be using my <a href="http://www.improve.dk/blog/2008/04/16/profiling-code-the-easy-way" target="_blank">CodeProfiler</a> class to make the measurements, running a total of 500 iterations using a single thread - as well as running an automatic warmup iteration.</p>
<figure class="highlight csharp"><pre>TimeSpan safeLocalTime = CodeProfiler.ProfileAction<span class="function"><span class="params">(() =&gt; testLocalSafely(), <span class="number">500</span>, <span class="number">1</span>)</span>;
<span class="title">TimeSpan</span> <span class="title">unsafeLocalTime</span> = <span class="title">CodeProfiler</span>.<span class="title">ProfileAction</span><span class="params">(() =&gt; testLocalUnsafely(), <span class="number">500</span>, <span class="number">1</span>)</span>;

<span class="title">Console</span>.<span class="title">WriteLine</span><span class="params">(<span class="string">"Safe: "</span> + safeLocalTime.TotalSeconds)</span>;
<span class="title">Console</span>.<span class="title">WriteLine</span><span class="params">(<span class="string">"Unsafe: "</span> + unsafeLocalTime.TotalSeconds)</span>;</span>
</pre></figure>

<p>And the results?</p>
<blockquote>
<p>Safe: 4,211061<br>Unsafe: 4,9368481  </p>
<p>Conclusion: Unsafe is 17% slower than safe.</p>
</blockquote>
<p>Interestingly the defensive method actual performs the best! It’s easy to conclude that throwing the exception is somewhat more expensive than hitting the IO layer to check for the files existance.</p>
<p>It’s no coincidence that I mention the IO layer and not the disk in the above statement. As this is run locally on a machine with 8GBs of memory all 200 files are easily cached in memory - making it a pure in-memory operation to both check for the files existance as well as reading the file contents. This can be verified as well by the CPU taking up 100% resources while the test is running.</p>
<h2 id="A_remote_test">A remote test</h2>
<p>Back to the real scenario. The web servers are not serving files off of local disks, they’re serving the files from a backend SAN exposed as CIFS shares.</p>
<p>I’ve copied the two test file directories onto two directories on a remote share.</p>
<p>Two new methods have been added. They’re identical to the last ones except that they access a remote share mapped to the local drive Z.</p>
<figure class="highlight csharp"><pre><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testShareUnsafely</span>()
{
    <span class="keyword">for</span> (<span class="keyword">int</span> file = <span class="number">1</span>; file &lt;= <span class="number">100</span>; file++)
        serveFileUnsafely(<span class="string">@"Z:\Test"</span> + file + <span class="string">".txt"</span>);
}

<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testShareSafely</span>()
{
    <span class="keyword">for</span> (<span class="keyword">int</span> file = <span class="number">1</span>; file &lt;= <span class="number">100</span>; file++)
        serveFileSafely(<span class="string">@"Z:\Test2"</span> + file + <span class="string">".txt"</span>);
}
</pre></figure>

<p>The testing is performed like this. Note that I’m only running 10 iterations + warmup here as it’d otherwise take far too long time.</p>
<figure class="highlight csharp"><pre>TimeSpan safeShareTime = CodeProfiler.ProfileAction<span class="function"><span class="params">(() =&gt; testShareSafely(), <span class="number">10</span>, <span class="number">1</span>)</span>;
<span class="title">TimeSpan</span> <span class="title">unsafeShareTime</span> = <span class="title">CodeProfiler</span>.<span class="title">ProfileAction</span><span class="params">(() =&gt; testShareUnsafely(), <span class="number">10</span>, <span class="number">1</span>)</span>;

<span class="title">Console</span>.<span class="title">WriteLine</span><span class="params">(<span class="string">"Safe: "</span> + safeShareTime.TotalSeconds)</span>;
<span class="title">Console</span>.<span class="title">WriteLine</span><span class="params">(<span class="string">"Unsafe: "</span> + unsafeShareTime.TotalSeconds)</span>;</span>
</pre></figure>

<p>The results?</p>
<blockquote>
<p>Safe: 4,1287161<br>Unsafe: 3,1327967  </p>
<p>Conclusion: Unsafe is 25% faster than safe.</p>
</blockquote>
<h2 id="As_usual_-_it_depends!">As usual - it depends!</h2>
<p>As can be seen, sometimes it’s best to defend against exceptions and sometimes it’s better to just hope for the best and catch the exception if it occurs. In my scenario throwing an exception was… Well. The exception. Make sure you always consider the cost of avoiding exceptions before you do so blindly.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Oct</span>
			<span class="day">28</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/working-with-identity-column-seed-and-increment-values/" title="Working With Identity Column Seed &amp; Increment Values" rel="bookmark">Working With Identity Column Seed &amp; Increment Values</a></h1>
		<div class="categories">
			
				<a href="/category/SQL Server - Tricks/">SQL Server - Tricks</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>All of the following samples are based on the following table:</p>
<a id="more"></a>


<figure class="highlight sql"><pre><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [dbo].[tblCars]
(
	[CarID] [<span class="keyword">int</span>] <span class="keyword">IDENTITY</span>(<span class="number">2</span>,<span class="number">5</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,
	[Name] [nvarchar](<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,
)</span>
</pre></figure>

<h2 id="Find_identity_column_seed_and_increment_values">Find identity column seed and increment values</h2>
<p>We can use the <a href="http://msdn.microsoft.com/en-us/library/ms189834.aspx" target="_blank">IDENT_SEED</a>, <a href="http://msdn.microsoft.com/en-us/library/ms189795.aspx" target="_blank">IDENT_INCR</a> and <a href="http://msdn.microsoft.com/en-us/library/ms175098.aspx" target="_blank">IDENT_CURRENT</a> functions to retrieve the identity seed and increment values, as well as the current value. Note that the next row will have IDENT_CURRENT() + IDENT_INCR() as its identity value.</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span>
	IDENT_SEED(<span class="string">'tblCars'</span>) <span class="keyword">AS</span> Seed,
	IDENT_INCR(<span class="string">'tblCars'</span>) <span class="keyword">AS</span> Increment,
	IDENT_CURRENT(<span class="string">'tblCars'</span>) <span class="keyword">AS</span> CurrentIdentity</span>
</pre></figure>

<p>Result:</p>
<figure class="highlight sql"><pre>Seed    Increment    CurrentIdentity
2       5            17
</pre></figure>

<p>An alternative way is to query the <a href="http://technet.microsoft.com/en-us/library/ms187334.aspx" target="_blank">sys.identity_columns</a> system view for the same values. Note that the sys.columns view (of which sys.identity_columns inherit) has an object_id column specifying the object ID of the table to which the column belongs. Thus we’ll have to apply a predicate filtering away any columns not belonging to the desired table, tblCars in this example.</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span>
	seed_value <span class="keyword">AS</span> Seed,
	increment_value <span class="keyword">AS</span> Increment,
	last_value <span class="keyword">AS</span> CurrentIdentity
<span class="keyword">FROM</span>
	sys.identity_columns
<span class="keyword">WHERE</span>
	object_id = OBJECT_ID(<span class="string">'tblCars'</span>)</span>
</pre></figure>

<p>Result:</p>
<figure class="highlight sql"><pre>Seed    Increment   CurrentIdentity
2       5           17
</pre></figure>

<p>A third way of finding the current identity value is to use the <a href="http://technet.microsoft.com/en-us/library/ms176057.aspx" target="_blank">DBCC CHECKIDENT</a> function:</p>
<figure class="highlight sql"><pre>DBCC CHECKIDENT(tblCars, NORESEED)
</pre></figure>

<p>Result:</p>
<figure class="highlight sql"><pre>Checking identity information: current identity value '22', current column value '22'.
DBCC execution completed. If DBCC printed error messages, contact your system administrator.
</pre></figure>

<h2 id="Changing_the_seed_value">Changing the seed value</h2>
<p>Using the DBCC CHECKIDENT command we can manually apply a new seed value to our table. Note that this will enable you to set an identity value that’ll cause the identity column to have duplicates unless you have a unique index on the column, in which case you’ll get an error instead. Thus, if you manually reseed the table, make sure you won’t run into duplicate values.</p>
<figure class="highlight sql"><pre>DBCC CHECKIDENT(tblCars, RESEED, 500)
</pre></figure>

<p>Result:</p>
<figure class="highlight sql"><pre>Checking identity information: current identity value '22', current column value '500'.
DBCC execution completed. If DBCC printed error messages, contact your system administrator.
</pre></figure>

<p>If for some reason the identity value has become out of synch with the values in the table, we can automatically reseed the table to a valid identity value. In the following case I’ve manually set the seed to 10 while the highest identity value in the table is 27. After running RESEED with no explicit value, the seed is automatically set to 27, thus the next inserted row will have an identity value of 32, provided the increment is 5.</p>
<figure class="highlight sql"><pre>DBCC CHECKIDENT(tblCars, RESEED)
</pre></figure>

<p>Result:</p>
<figure class="highlight sql"><pre>Checking identity information: current identity value '10', current column value '27'.
DBCC execution completed. If DBCC printed error messages, contact your system administrator.
</pre></figure>

<h2 id="Getting_the_maximum_and_minimum_identity_values">Getting the maximum and minimum identity values</h2>
<p>Using the IDENTITYCOL alias for any identity column in a table (of which there can be at most one), we can easily select the maximum and minimum identity values:</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">SELECT</span>
	<span class="aggregate">MAX</span>(IDENTITYCOL) <span class="keyword">AS</span> MaximumIdentity,
	<span class="aggregate">MIN</span>(IDENTITYCOL) <span class="keyword">AS</span> MinimumIdentity
<span class="keyword">FROM</span>
	tblCars</span>
</pre></figure>

<p>Result:</p>
<figure class="highlight sql"><pre>MaximumIdentity MinimumIdentity
27              22
</pre></figure>

<h2 id="Changing_the_identity_increment_value">Changing the identity increment value</h2>
<p>Unfortunately there’s no easy way to change the increment value of an identity column. The only way to do so is to drop the identity column and add a new column with the new increment value. The following code will create a new temporary table, copy the data into it, recreate the original table with the correct increment value and then finally copy the data back using <a href="http://msdn.microsoft.com/en-us/library/aa259221(SQL.80" target="_blank">SET IDENTITY_INSERT ON</a>.aspx) to insert explicit values into the identity column.</p>
<figure class="highlight sql"><pre><span class="operator"><span class="keyword">BEGIN</span> TRAN

-- <span class="keyword">Create</span> new <span class="keyword">temporary</span> <span class="keyword">table</span> <span class="keyword">to</span> hold data while restructuring tblCars
<span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tblCars_TMP
(
	CarID <span class="keyword">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,
	Name nvarchar(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>
)

-- <span class="keyword">Insert</span> tblCars data <span class="keyword">into</span> tblCars_TMP
<span class="keyword">INSERT</span> <span class="keyword">INTO</span> tblCars_TMP <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tblCars

-- <span class="keyword">Drop</span> original <span class="keyword">table</span>
<span class="keyword">DROP</span> <span class="keyword">TABLE</span> tblCars

-- <span class="keyword">Create</span> new tblCars <span class="keyword">table</span> <span class="keyword">with</span> correct <span class="keyword">identity</span> <span class="keyword">values</span> (<span class="number">1</span>,<span class="number">1</span>) <span class="keyword">in</span> this <span class="keyword">case</span>
<span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [dbo].[tblCars]
(
	[CarID] [<span class="keyword">int</span>] <span class="keyword">IDENTITY</span>(<span class="number">1</span>,<span class="number">1</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,
	[Name] [nvarchar](<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,
)

-- Reinsert data <span class="keyword">into</span> tblCars <span class="keyword">table</span>
<span class="keyword">SET</span> IDENTITY_INSERT tblCars <span class="keyword">ON</span>
<span class="keyword">INSERT</span> <span class="keyword">INTO</span> tblCars (CarID, Name) <span class="keyword">SELECT</span> CarID, Name <span class="keyword">FROM</span> tblCars_TMP
<span class="keyword">SET</span> IDENTITY_INSERT tblCars OFF

<span class="keyword">COMMIT</span></span>
</pre></figure>



				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Oct</span>
			<span class="day">21</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/solving-access-denied-errors-using-process-monitor/" title="Solving Access Denied Errors Using Process Monitor" rel="bookmark">Solving Access Denied Errors Using Process Monitor</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				, 
			
				<a href="/category/IIS/">IIS</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p><a href="http://stackoverflow.com/questions/809144/could-not-load-file-or-assembly-someproject-or-one-of-its-dependencies-access" target="_blank">Access</a> <a href="http://stackoverflow.com/questions/574411/system-error-5-access-is-denied-when-starting-a-net-service" target="_blank">denied</a> <a href="http://stackoverflow.com/questions/951259/could-not-load-file-or-assembly-or-one-of-its-dependencies-access-is-denied" target="_blank">errors</a> are not <a href="http://stackoverflow.com/questions/1166490/could-not-load-file-or-assembly-applicenses-or-one-of-its-dependencies-access" target="_blank">uncommon</a> when deploying new websites / features that interact with the filesystem. While it might work in local testing, it suddenly doesn’t anymore when deployed. Using <a href="http://technet.microsoft.com/en-us/sysinternals/bb896645.aspx" target="_blank">Process Monitor</a> I’ll show how to easily debug these issues.</p>
<a id="more"></a>

<p>I’ve made a very simple web application project with a Default.aspx file that has the following codebehind code:</p>
<figure class="highlight csharp"><pre><span class="keyword">using</span> System;
<span class="keyword">using</span> System.IO;
<span class="keyword">using</span> System.Web.UI;

namespace FileWritingWebsite
{
	<span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> _Default : Page
	{
		<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Page_Load</span>(<span class="keyword">object</span> sender, EventArgs e)
		{
			File.WriteAllText(<span class="string">@"C:\Test.txt"</span>, <span class="string">"Hello world!"</span>);

			Response.Write(<span class="string">"Done!"</span>);
		}
	}
}
</pre></figure>

<p>After deploying this to my webserver we receive the archetypical access denied error:</p>
<div class="imgwrapper" style=""><div><a href="/solving-access-denied-errors-using-process-monitor/procmon1_2.jpg" class="fancy"><img src="/solving-access-denied-errors-using-process-monitor/procmon1_2.jpg" style="max-height: 250px"/></a></div></div>

<p>In this case it’s rather obvious where the error stems from, but the cause isn’t as obvious. We’re running under IIS, but we may be impersonating a user profile, running under a non-standard user account for the application pool (that is, not NETWORK SERVICE) or explicitly writing the file on a thread that’s running on a different user account (which we are not in this case, however).</p>
<div class="imgwrapper" style=""><div><a href="/solving-access-denied-errors-using-process-monitor/procmon2_2.jpg" class="fancy"><img src="/solving-access-denied-errors-using-process-monitor/procmon2_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Looking at the user permissions for C: it’s clear that no special permissions have been granted for the web user. Thus our task is first and foremost to identify the user that’s trying to write the file.</p>
<div class="imgwrapper" style=""><div><a href="/solving-access-denied-errors-using-process-monitor/procmon3_2.jpg" class="fancy"><img src="/solving-access-denied-errors-using-process-monitor/procmon3_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Once you startup Process Monitor you’ll quickly be swamped with input data that’s irrelevant to the task at hand. The first filter we’ll apply is the overall event type filter. There’s five standard types, of which the first four are enabled by default: Registry, File, Network, Process &amp; Threads and Profiling. As we’re having an access denied issue with the file system, disable all but the File System events.</p>
<p>At this point the number of events should already be filtered down a lot - down to 32% in my case. Now click the cyan funnel icon to open up the filter editor window.</p>
<div class="imgwrapper" style=""><div><a href="/solving-access-denied-errors-using-process-monitor/procmon4_2.jpg" class="fancy"><img src="/solving-access-denied-errors-using-process-monitor/procmon4_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Since we know IIS is running under the w3wp.exe process, we can add a filter that includes all events with a process name of w3wp.exe. As soon as we add an Include filter, all event that do not match an include filter are excluded.</p>
<div class="imgwrapper" style=""><div><a href="/solving-access-denied-errors-using-process-monitor/procmon5_2.jpg" class="fancy"><img src="/solving-access-denied-errors-using-process-monitor/procmon5_2.jpg" style="max-height: 250px"/></a></div></div>

<p>At this point th event list is somewhat more manageable. The important event is clearly the one with a result of “ACCESS DENIED”. That event shows we’re trying to write (CreateFile) the C:Test.txt file and we’re receving an ACCESS DENIED error from the file system.</p>
<div class="imgwrapper" style=""><div><a href="/solving-access-denied-errors-using-process-monitor/procmon6_2.jpg" class="fancy"><img src="/solving-access-denied-errors-using-process-monitor/procmon6_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Now right click the ACCESS DENIED event and go to Properties. Once you’ve opened the properties window, switch to the Process tab. At this point you’ll be ableto see the exact user account that tried to perform the denied action. As can be seen from the screenshot, it was the NETWORK SERVICE user in this case - the default IIS user.</p>
<div class="imgwrapper" style=""><div><a href="/solving-access-denied-errors-using-process-monitor/procmon7_2.jpg" class="fancy"><img src="/solving-access-denied-errors-using-process-monitor/procmon7_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Once we’ve identified the necessary user account, it’s a simple matter of granting it NTFS write rights to the C: directory.</p>
<div class="imgwrapper" style=""><div><a href="/solving-access-denied-errors-using-process-monitor/procmon8_2.jpg" class="fancy"><img src="/solving-access-denied-errors-using-process-monitor/procmon8_2.jpg" style="max-height: 250px"/></a></div></div>

<p>And finally we can run the website again and verify that we’ve now got proper permissions for writing the Test.txt file to the C: directory.</p>
<h2 id="Not_just_for_web_applications">Not just for web applications</h2>
<p>While I gave an example of a web application security issue, Process Monitor can be used to solve any kind of permission issues. You can use it for debugging why Windows Services won’t start properly, why Outlook is suddenly complaining about access denied issues etc. Note that Process Monitor will also allow you to monitor the registry and can thus be used to solve security issues just as simple as with the file system.</p>
<p>Process Monitor is also a great tool for monitoring 3rd party applications to discover their exact usage of the file system and registry.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Oct</span>
			<span class="day">14</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/how-to-do-url-rewriting-on-iis-7-properly/" title="How To Do URL Rewriting on IIS 7 Properly" rel="bookmark">How To Do URL Rewriting on IIS 7 Properly</a></h1>
		<div class="categories">
			
				<a href="/category/.NET/">.NET</a>
				, 
			
				<a href="/category/IIS/">IIS</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>One of my earlier blog posts, and the all time most popular one, was about <a href="/making-url-rewriting-on-iis7-work-like-iis6/">how to make URL rewriting on IIS 7 work like IIS 6</a>. While my method did provide a means to the goal, it’s humiliatingly far from what I should’ve done. Since the old post is still the most visited post on my blog I feel obligated to write a followup on how to do proper url rewriting in IIS 7.</p>
<a id="more"></a>

<h2 id="The_scenario">The scenario</h2>
<p>I’ll assume a completely vanilla IIS 7 setup, contrary to the old post, there’s no IIS tampering required.</p>
<p>I’ve setup a simple web application solution structure like so:</p>
<div class="imgwrapper" style=""><div><a href="/how-to-do-url-rewriting-on-iis-7-properly/iis7urlrewritingdoneproperly_1_2.jpg" class="fancy"><img src="/how-to-do-url-rewriting-on-iis-7-properly/iis7urlrewritingdoneproperly_1_2.jpg" style="max-height: 250px"/></a></div></div>

<p>As in the original post my goal is to accept a URL like <a href="http://localhost/blog/2006/12/08/missing-windows-mobile-device-center" target="_blank">http://localhost/blog/2006/12/08/missing-windows-mobile-device-center</a> and map it to the BlogPost.aspx file in the root of my application. During the rewrite process I want to make the year, month, day and title available for the BlogPost.aspx file in an easily accessible way.</p>
<h2 id="Rewriting_using_Global-asax">Rewriting using Global.asax</h2>
<p>The easiest way of rewriting URL’s is to add a new Global.asax file to the root of your solution. Now paste in the following code:</p>
<figure class="highlight csharp"><pre>using System<span class="comment">;</span>
using System<span class="preprocessor">.Text</span><span class="preprocessor">.RegularExpressions</span><span class="comment">;</span>
using System<span class="preprocessor">.Web</span><span class="comment">;</span>

namespace IIS7UrlRewritingDoneProperly
{
	public class Global : HttpApplication
	{
		// Runs at the beginning of each request to the server
		protected void Application_BeginRequest(object sender, EventArgs e)
		{
			// Match the specific blog post URL path as well as pull <span class="keyword">out</span> variables <span class="keyword">in</span> regex groups
			Match m = Regex<span class="preprocessor">.Match</span>(Request<span class="preprocessor">.Url</span><span class="preprocessor">.LocalPath</span>, @<span class="string">"^/blog/(?&lt;year&gt;d{4})/(?&lt;month&gt;d{2})/(?&lt;day&gt;d{2})/(?&lt;title&gt;.*)/?$"</span>)<span class="comment">;</span>

			// If we match a blog posts URL, save the URL variables <span class="keyword">in</span> Context<span class="preprocessor">.Items</span> <span class="keyword">and</span> rewrite to /BlogPost<span class="preprocessor">.aspx</span>
			if (m<span class="preprocessor">.Success</span>)
			{
				Context<span class="preprocessor">.Items</span>[<span class="string">"Title"</span>] = m<span class="preprocessor">.Groups</span>[<span class="string">"title"</span>]<span class="preprocessor">.Value</span><span class="comment">;</span>
				Context<span class="preprocessor">.Items</span>[<span class="string">"Year"</span>] = m<span class="preprocessor">.Groups</span>[<span class="string">"year"</span>]<span class="preprocessor">.Value</span><span class="comment">;</span>
				Context<span class="preprocessor">.Items</span>[<span class="string">"Month"</span>] = m<span class="preprocessor">.Groups</span>[<span class="string">"month"</span>]<span class="preprocessor">.Value</span><span class="comment">;</span>
				Context<span class="preprocessor">.Items</span>[<span class="string">"Day"</span>] = m<span class="preprocessor">.Groups</span>[<span class="string">"day"</span>]<span class="preprocessor">.Value</span><span class="comment">;</span>

				HttpContext<span class="preprocessor">.Current</span><span class="preprocessor">.RewritePath</span>(<span class="string">"/BlogPost.aspx"</span>)<span class="comment">;</span>
			}
		}
	}
}
</pre></figure>

<p>Now all you need is a single change in your web.config file:</p>
<figure class="highlight xml"><pre><span class="tag">&lt;<span class="title">configuration</span>&gt;</span>
	<span class="tag">&lt;<span class="title">system.webServer</span>&gt;</span>
		<span class="tag">&lt;<span class="title">modules</span> <span class="attribute">runAllManagedModulesForAllRequests</span>=<span class="value">"true"</span>&gt;</span>
	<span class="tag">&lt;/<span class="title">system.webServer</span>&gt;</span>
<span class="tag">&lt;/<span class="title">configuration</span>&gt;</span>
</pre></figure>

<p>The web.config change basically does the same as adding the wildcard map in IIS6. It ensures ASP.NET will run our Application_BeginRequest function for all requests - both those that match .aspx files as well as those for static files.</p>
<h2 id="Rewriting_using_an_HttpModule">Rewriting using an HttpModule</h2>
<p>As an alternative to putting the rewriting logic into Global.asax, you might want to write it into a distributable HttpModule. If your URL rewriting functionality is common for multiple sites, generic or for any other reason may be usable on multiple sites, we don’t want to replicate the functionality in Global.asax.</p>
<p>If you added the Global.asax file from before, make sure you remove it again so it doesn’t conflict with the HttpModule we’re about to write. Add a new class project to the solution - I’ve called mine MyUrlRewriter. Add a reference to System.Web and add a single new class file to the project called UrlRewriter. Your solution should look like this:</p>
<div class="imgwrapper" style=""><div><a href="/how-to-do-url-rewriting-on-iis-7-properly/iis7urlrewritingdoneproperly_2_2.jpg" class="fancy"><img src="/how-to-do-url-rewriting-on-iis-7-properly/iis7urlrewritingdoneproperly_2_2.jpg" style="max-height: 250px"/></a></div></div>

<p>Now paste the following code into the UrlRewriter.cs class file:</p>
<figure class="highlight csharp"><pre><span class="keyword">using</span> System;
<span class="keyword">using</span> System.Text.RegularExpressions;
<span class="keyword">using</span> System.Web;

namespace MyUrlRewriter
{
	<span class="keyword">public</span> <span class="keyword">class</span> UrlRewriter : IHttpModule
	{
		<span class="comment">// We've got nothing to dispose in this module</span>
		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>()
		{ }

		<span class="comment">// In here we can hook up to any of the ASP.NET events we use in Global.asax</span>
		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Init</span>(HttpApplication context)
		{
			context.BeginRequest += <span class="keyword">new</span> EventHandler(context_BeginRequest);
		}

		<span class="comment">// This method does exactly the same as in Global.asax</span>
		<span class="keyword">private</span> <span class="keyword">void</span> <span class="title">context_BeginRequest</span>(<span class="keyword">object</span> sender, EventArgs e)
		{
			<span class="comment">// Match the specific blog post URL path as well as pull out variables in regex groups</span>
			Match m = Regex.Match(HttpContext.Current.Request.Url.LocalPath, <span class="string">@"^/blog/(?&lt;year&gt;d{4})/(?&lt;month&gt;d{2})/(?&lt;day&gt;d{2})/(?&lt;title&gt;.*)/?$"</span>);

			<span class="comment">// If we match a blog posts URL, save the URL variables in Context.Items and rewrite to /BlogPost.aspx</span>
			<span class="keyword">if</span> (m.Success)
			{
				HttpContext.Current.Items[<span class="string">"Title"</span>] = m.Groups[<span class="string">"title"</span>].Value;
				HttpContext.Current.Items[<span class="string">"Year"</span>] = m.Groups[<span class="string">"year"</span>].Value;
				HttpContext.Current.Items[<span class="string">"Month"</span>] = m.Groups[<span class="string">"month"</span>].Value;
				HttpContext.Current.Items[<span class="string">"Day"</span>] = m.Groups[<span class="string">"day"</span>].Value;

				HttpContext.Current.RewritePath(<span class="string">"/BlogPost.aspx"</span>);
			}
		}
	}
}
</pre></figure>

<p>Notice that the context_BeginRequest function is identical to the one we had in Global.asax, except we have to reference HttpContext.Current explicitly since it’s not implicitly available as in Global.asax.</p>
<p>Now add a reference from the original web application project to the MyUrlRewriter class project. Once this is done we just need to ensure our HttpModule is included in our web application by modifying the web.config:</p>
<figure class="highlight xml"><pre><span class="tag">&lt;<span class="title">configuration</span>&gt;</span>
    <span class="tag">&lt;<span class="title">system.webServer</span>&gt;</span>
        <span class="tag">&lt;<span class="title">modules</span> <span class="attribute">runAllManagedModulesForAllRequests</span>=<span class="value">"true"</span>&gt;</span>
            <span class="tag">&lt;<span class="title">add</span> <span class="attribute">name</span>=<span class="value">"UrlRewriter"</span> <span class="attribute">type</span>=<span class="value">"MyUrlRewriter.UrlRewriter, MyUrlRewriter"</span>/&gt;</span>
        <span class="tag">&lt;/<span class="title">modules</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">system.webServer</span>&gt;</span>
<span class="tag">&lt;/<span class="title">configuration</span>&gt;</span>
</pre></figure>

<p>At this point you should be able to run the website with the exact same URL rewriting functionality as we had before - though this time in a redistributable assembly called MyUrlRewriter.dll which can easily be included into any website by adding a single line to the section of the web.config file.</p>
<h2 id="Not_Invented_Here_Syndrome">Not Invented Here Syndrome</h2>
<p>If you have basic requirements to your URL rewriting solution you may often be able to settle with one of the many readymade HttpModules that you can simply plug into your application. IIS 7 also has a <a href="http://learn.iis.net/page.aspx/461/creating-rewrite-rules-for-the-url-rewrite-module/" target="_blank">URL Rewrite Module</a> that you can install and easily configure through the IIS manager.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>

	<article>
	<div class="datebox">
		<div class="upper">
			<span class="month">Oct</span>
			<span class="day">07</span>
		</div>
		<div class="lower">2009</div>
	</div>

	<div class="title">
		<h1><a href="/simple-file-synchronization-using-robocopy/" title="Simple File Synchronization Using Robocopy" rel="bookmark">Simple File Synchronization Using Robocopy</a></h1>
		<div class="categories">
			
				<a href="/category/Windows/">Windows</a>
				
			
		</div>
		
		<div class="clear"></div>
	</div>

	<div id="bodywrapper" >

		
		
			<div class="body">
			
				<p>On numerous occations I’ve had a need for synchronizing directories of files &amp; subdirectories. I’ve used it for synchronizing work files from my stationary PC to my laptop in the pre-always-on era (today I use SVN for almost all files that needs to be in synch). Recently I needed to implement a very KISS backup solution that simply synchronized two directories once a week for offsite storing of the backup data.</p>
<a id="more"></a>

<p>While seemingly simple the only hitch was that there would be several thousands of files in binary format, so compression was out of the question. All changes would be additions and deletions - that is, no incremental updates. Finally I’d only have access to the files through a share so it wouldn’t be possible to deploy a local backup solution that monitored for changes and only sent diffs.</p>
<p>I started out using <a href="http://www.tgrmn.com/web/file_synchronization.htm" target="_blank">ViceVersa PRO</a> with the <a href="http://www.tgrmn.com/web/vvengine/vvengine.htm" target="_blank">VVEngine</a> addon for scheduling. It worked great for some time although it wasn’t the most speedy solution given my scenario. Some time later ViceVersa stopped working. Apparently it was simply unable to handle more than a million files (give or take a bit). Their forums are filled with people asking for solutions, though the only suggestion they have is to split the backup job into several smaller jobs. Hence I started taking backups of MyShare/A<em>, MyShare/B</em>, etc. This quickly grew out of hand as the number of files increased.</p>
<p>Sometime later I was introduced to <a href="http://technet.microsoft.com/en-us/library/cc733145(WS.10" target="_blank">Robocopy</a>.aspx). Robocopy ships with Vista, Win7 and Server 2008. For server 2003 and XP it can be downloaded as part of the<a href="http://www.microsoft.com/Downloads/details.aspx?FamilyID=9d467a69-57ff-4ae7-96ee-b18c4790cffd&amp;displaylang=en" target="_blank">Windows Server 2003 Resource Kit Tools</a>.</p>
<p>Robocopy (Robust File Copy) does one job extremely well - it copies files. It’s run from the command line, though there has been made a <a href="http://technet.microsoft.com/en-us/magazine/2006.11.utilityspotlight.aspx" target="_blank">wrapper GUI</a> for it. The basic syntax for calling robocopy is:</p>
<figure class="highlight"><pre>robocopy &lt;Source&gt; &lt;Destination&gt; [&lt;File&gt;[ <span class="keyword">...</span>]] [&lt;Options&gt;]
</pre></figure>

<p>You give it a source and a destination address and it’ll make sure all files &amp; directories from the source are copied to the destination. If an error occurs it’ll wait for 30 seconds (configurable) before retrying, and it’ll continue doing this a million times (configurable). That means robocopy will survive a network error and just resume the copying process once the network is back up again.</p>
<p>What makes robocopy really shine is not it’s ability to copy files, but it’s ability to mirror one directory into another. That means it’ll not just copy files, it’ll also delete any extra files in the destination directory. In comparison to ViceVersa, robocopy goes through the directory structure in a linear fashion and in doing so doesn’t have any major requirements of memory. ViceVersa would initially scan the source and destination and then perform the comparison. As source and destination became larger and larger, more memory was required to perform the initial comparison - until a certain point where it’d just give up.</p>
<p>I ended up with the following command for mirroring the directories using robocopy:</p>
<figure class="highlight"><pre>robocopy <span class="command">\\</span>SourceServer<span class="command">\Share</span> <span class="command">\\</span>DestinationServer<span class="command">\Share</span> /MIR /FFT /Z /XA:H /W:5
</pre></figure>

<ul>
<li>/MIR specifies that robocopy should mirror the source directory and the destination directory. Beware that this may delete files at the destination.</li>
<li>/FFT uses fat file timing instead of NTFS. This means the granularity is a bit less precise. For across-network share operations this seems to be much more reliable - just don’t rely on the file timings to be completely precise to the second.</li>
<li>/Z ensures robocopy can resume the transfer of a large file in mid-file instead of restarting.</li>
<li>/XA:H makes robocopy ignore hidden files, usually these will be system files that we’re not interested in.</li>
<li>/W:5 reduces the wait time between failures to 5 seconds instead of the 30 second default.</li>
</ul>
<p>The robocopy script can be setup as a simply Scheduled Task that runs daily, hourly, weekly etc. Note that robocopy also contains a switch that’ll make robocopy monitor the source for changes and invoke the synchronization script each time a configurable number of changes has been made. This may work in your scenario, but be aware that robocopy will not just copy the changes, it will scan the complete directory structure just like a normal mirroring procedure. If there’s a lot of files &amp; directories, this may hamper performance.</p>


				<div style="clear: both"></div>

				

			</div>

		

		

	</div>
</article>


<div class="paging">
	<a href="/page/13/"><div class="past">« Past</div></a>
	<a href="/page/11/"><div class="future">Future »</div></a>
	<div class="clear"></div>
</div>

				</div>
			</div>

			<div id="asides">
				<div class="categories aside">
					<span class="sectiontitle">CATEGORIES</span>
					<ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/category/.NET/">.NET</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/AS/Flex/Flash/">AS/Flex/Flash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Amazon Web Services/">Amazon Web Services</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Computer Science/">Computer Science</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Conferences and Presenting/">Conferences and Presenting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/IIS/">IIS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Life/">Life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Miscellaneous/">Miscellaneous</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Performance/">Performance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Poker/">Poker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server/">SQL Server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Community/">SQL Server - Community</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Data Types/">SQL Server - Data Types</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Internals/">SQL Server - Internals</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Optimization/">SQL Server - Optimization</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - OrcaMDF/">SQL Server - OrcaMDF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/SQL Server - Tricks/">SQL Server - Tricks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Testing/">Testing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Tools of the Trade/">Tools of the Trade</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Umbraco/">Umbraco</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Visual Studio/">Visual Studio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Web/">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windbg/">Windbg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/category/Windows/">Windows</a></li></ul>

					
				</div>

				<div class="archive aside">
					<span class="sectiontitle">ARCHIVE</span>
					<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archive/2014">2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2013">2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2012">2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2011">2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2010">2010</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2009">2009</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2008">2008</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2007">2007</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archive/2006">2006</a></li></ul>
				</div>
			</div>

			<div class="clear"></div>
		</div>
		
		<footer>
			<div class="wrapper">Copyright &copy; 2014 Mark S. Rasmussen</div>
		</footer>

		<script type="text/javascript">
			$(function () {
				// Show mobile menu
				$("li.navicon").click(function () {
					if ($("header ul.mobile a").length == 0) {
						// Pages
						$mobilePages = $("div#naviconcontent ul.pages");
						$("header nav ul.normal > li").not(".navicon").each(function (i, el) {
							$mobilePages.append($(el).clone());
						});

						// Categories
						$mobileCategories = $("div#naviconcontent ul.categories");
						$("div#asides div.categories > ul > li").each(function (i, el) {
							$mobileCategories.append($(el).clone());
						});

						// Archive
						$mobileArchive = $("div#naviconcontent ul.archive");
						$("div#asides div.archive > ul > li").each(function (i, el) {
							$mobileArchive.append($(el).clone());
						});
					};

					$("header ul.mobile").toggle();
				});

				// Fancybox setup
				$("a.fancy").fancybox({
					hideOnContentClick: true,
					overlayShow: true
				});
			});
		</script>
	</body>
</html>